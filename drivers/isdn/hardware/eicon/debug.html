<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › eicon › debug.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>debug.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;platform.h&quot;</span>
<span class="cp">#include &quot;pc.h&quot;</span>
<span class="cp">#include &quot;di_defs.h&quot;</span>
<span class="cp">#include &quot;debug_if.h&quot;</span>
<span class="cp">#include &quot;divasync.h&quot;</span>
<span class="cp">#include &quot;kst_ifc.h&quot;</span>
<span class="cp">#include &quot;maintidi.h&quot;</span>
<span class="cp">#include &quot;man_defs.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">  LOCALS</span>
<span class="cm">*/</span>
<span class="cp">#define DBG_MAGIC (0x47114711L)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">DI_register</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DI_deregister</span><span class="p">(</span><span class="n">pDbgHandle</span> <span class="n">hDbg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DI_format</span><span class="p">(</span><span class="kt">int</span> <span class="n">do_lock</span><span class="p">,</span> <span class="n">word</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">argument_list</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">DI_format_locked</span><span class="p">(</span><span class="n">word</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">argument_list</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DI_format_old</span><span class="p">(</span><span class="n">word</span> <span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">DiProcessEventLog</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msgID</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">single_p</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="n">word</span> <span class="o">*</span><span class="n">PLength</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_maint_xdi_cb</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span><span class="p">);</span>
<span class="k">static</span> <span class="n">word</span> <span class="n">SuperTraceCreateReadReq</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">diva_mnt_cmp_nmbr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nmbr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">IDI_CALL</span> <span class="n">request</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">diva_get_dma_descriptor</span><span class="p">(</span><span class="n">IDI_CALL</span> <span class="n">request</span><span class="p">,</span> <span class="n">dword</span> <span class="o">*</span><span class="n">dma_magic</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">dword</span> <span class="n">drv_id</span><span class="p">,</span> <span class="n">dword</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="p">...);</span>

<span class="k">static</span> <span class="n">dword</span> <span class="n">MaxDumpSize</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
<span class="k">static</span> <span class="n">dword</span> <span class="n">MaxXlogSize</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">128</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span>  <span class="n">TraceFilter</span><span class="p">[</span><span class="n">DIVA_MAX_SELECTIVE_FILTER_LENGTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TraceFilterIdent</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TraceFilterChannel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_diva_maint_client</span> <span class="p">{</span>
	<span class="n">dword</span>       <span class="n">sec</span><span class="p">;</span>
	<span class="n">dword</span>       <span class="n">usec</span><span class="p">;</span>
	<span class="n">pDbgHandle</span>  <span class="n">hDbg</span><span class="p">;</span>
	<span class="kt">char</span>        <span class="n">drvName</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">dword</span>       <span class="n">dbgMask</span><span class="p">;</span>
	<span class="n">dword</span>       <span class="n">last_dbgMask</span><span class="p">;</span>
	<span class="n">IDI_CALL</span>    <span class="n">request</span><span class="p">;</span>
	<span class="n">_DbgHandle_</span> <span class="n">Dbg</span><span class="p">;</span>
	<span class="kt">int</span>         <span class="n">logical</span><span class="p">;</span>
	<span class="kt">int</span>         <span class="n">channels</span><span class="p">;</span>
	<span class="n">diva_strace_library_interface_t</span> <span class="o">*</span><span class="n">pIdiLib</span><span class="p">;</span>
	<span class="n">BUFFERS</span>     <span class="n">XData</span><span class="p">;</span>
	<span class="kt">char</span>        <span class="n">xbuffer</span><span class="p">[</span><span class="mi">2048</span> <span class="o">+</span> <span class="mi">512</span><span class="p">];</span>
	<span class="n">byte</span>        <span class="o">*</span><span class="n">pmem</span><span class="p">;</span>
	<span class="kt">int</span>         <span class="n">request_pending</span><span class="p">;</span>
	<span class="kt">int</span>         <span class="n">dma_handle</span><span class="p">;</span>
<span class="p">}</span> <span class="n">diva_maint_client_t</span><span class="p">;</span>
<span class="k">static</span> <span class="n">diva_maint_client_t</span> <span class="n">clients</span><span class="p">[</span><span class="n">MAX_DESCRIPTORS</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_change_management_debug_mask</span><span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span><span class="p">,</span> <span class="n">dword</span> <span class="n">old_mask</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_maint_error</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_context</span><span class="p">,</span>
			     <span class="n">diva_strace_library_interface_t</span> <span class="o">*</span><span class="n">hLib</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">Adapter</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">error</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">line</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_maint_state_change_notify</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_context</span><span class="p">,</span>
					   <span class="n">diva_strace_library_interface_t</span> <span class="o">*</span><span class="n">hLib</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">Adapter</span><span class="p">,</span>
					   <span class="n">diva_trace_line_state_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">notify_subject</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">diva_maint_trace_notify</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_context</span><span class="p">,</span>
				    <span class="n">diva_strace_library_interface_t</span> <span class="o">*</span><span class="n">hLib</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">Adapter</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="o">*</span><span class="n">xlog_buffer</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>



<span class="k">typedef</span> <span class="k">struct</span> <span class="n">MSG_QUEUE</span> <span class="p">{</span>
	<span class="n">dword</span>	<span class="n">Size</span><span class="p">;</span>		<span class="cm">/* total size of queue (constant)	*/</span>
	<span class="n">byte</span>	<span class="o">*</span><span class="n">Base</span><span class="p">;</span>		<span class="cm">/* lowest address (constant)		*/</span>
	<span class="n">byte</span>	<span class="o">*</span><span class="n">High</span><span class="p">;</span>		<span class="cm">/* Base + Size (constant)		*/</span>
	<span class="n">byte</span>	<span class="o">*</span><span class="n">Head</span><span class="p">;</span>		<span class="cm">/* first message in queue (if any)	*/</span>
	<span class="n">byte</span>	<span class="o">*</span><span class="n">Tail</span><span class="p">;</span>		<span class="cm">/* first free position			*/</span>
	<span class="n">byte</span>	<span class="o">*</span><span class="n">Wrap</span><span class="p">;</span>		<span class="cm">/* current wraparound position		*/</span>
	<span class="n">dword</span>	<span class="n">Count</span><span class="p">;</span>		<span class="cm">/* current no of bytes in queue		*/</span>
<span class="p">}</span> <span class="n">MSG_QUEUE</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">MSG_HEAD</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="n">dword</span>	<span class="n">Size</span><span class="p">;</span>		<span class="cm">/* size of data following MSG_HEAD	*/</span>
<span class="cp">#define	MSG_INCOMPLETE	0x8000	</span><span class="cm">/* ored to Size until queueCompleteMsg	*/</span><span class="cp"></span>
<span class="p">}</span> <span class="n">MSG_HEAD</span><span class="p">;</span>

<span class="cp">#define queueCompleteMsg(p) do { ((MSG_HEAD *)p - 1)-&gt;Size &amp;= ~MSG_INCOMPLETE; } while (0)</span>
<span class="cp">#define queueCount(q)	((q)-&gt;Count)</span>
<span class="cp">#define MSG_NEED(size)							\</span>
<span class="cp">	((sizeof(MSG_HEAD) + size + sizeof(dword) - 1) &amp; ~(sizeof(dword) - 1))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queueInit</span><span class="p">(</span><span class="n">MSG_QUEUE</span> <span class="o">*</span><span class="n">Q</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">Buffer</span><span class="p">,</span> <span class="n">dword</span> <span class="n">sizeBuffer</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="n">sizeBuffer</span><span class="p">;</span>
	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Base</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">;</span>
	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">High</span> <span class="o">=</span> <span class="n">Buffer</span> <span class="o">+</span> <span class="n">sizeBuffer</span><span class="p">;</span>
	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Wrap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="o">*</span><span class="nf">queueAllocMsg</span><span class="p">(</span><span class="n">MSG_QUEUE</span> <span class="o">*</span><span class="n">Q</span><span class="p">,</span> <span class="n">word</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Allocate &#39;size&#39; bytes at tail of queue which will be filled later</span>
<span class="cm">	 * directly with callers own message header info and/or message.</span>
<span class="cm">	 * An &#39;alloced&#39; message is marked incomplete by oring the &#39;Size&#39; field</span>
<span class="cm">	 * with MSG_INCOMPLETE.</span>
<span class="cm">	 * This must be reset via queueCompleteMsg() after the message is filled.</span>
<span class="cm">	 * As long as a message is marked incomplete queuePeekMsg() will return</span>
<span class="cm">	 * a &#39;queue empty&#39; condition when it reaches such a message.  */</span>

	<span class="n">MSG_HEAD</span> <span class="o">*</span><span class="n">Msg</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">need</span> <span class="o">=</span> <span class="n">MSG_NEED</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">==</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Wrap</span> <span class="o">||</span> <span class="n">need</span> <span class="o">&gt;</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* full */</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">alloc</span><span class="p">;</span> <span class="cm">/* empty */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">&gt;</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">+</span> <span class="n">need</span> <span class="o">&lt;=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">High</span><span class="p">)</span> <span class="k">goto</span> <span class="n">alloc</span><span class="p">;</span> <span class="cm">/* append */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Base</span> <span class="o">+</span> <span class="n">need</span> <span class="o">&gt;</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* too much */</span>
		<span class="p">}</span>
		<span class="cm">/* wraparound the queue (but not the message) */</span>
		<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Wrap</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span><span class="p">;</span>
		<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">+</span> <span class="n">need</span> <span class="o">&gt;</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* too much */</span>
	<span class="p">}</span>

<span class="nl">alloc:</span>
	<span class="n">Msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSG_HEAD</span> <span class="o">*</span><span class="p">)</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span><span class="p">;</span>

	<span class="n">Msg</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">|</span> <span class="n">MSG_INCOMPLETE</span><span class="p">;</span>

	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span>	 <span class="o">+=</span> <span class="n">need</span><span class="p">;</span>
	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Count</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>



	<span class="k">return</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">Msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queueFreeMsg</span><span class="p">(</span><span class="n">MSG_QUEUE</span> <span class="o">*</span><span class="n">Q</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* Free the message at head of queue */</span>

	<span class="n">word</span> <span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">MSG_HEAD</span> <span class="o">*</span><span class="p">)</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MSG_INCOMPLETE</span><span class="p">;</span>

	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span>  <span class="o">+=</span> <span class="n">MSG_NEED</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Count</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Wrap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span> <span class="o">&gt;=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Wrap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">;</span>
			<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Wrap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span> <span class="o">&gt;=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">=</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Base</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">byte</span> <span class="o">*</span><span class="nf">queuePeekMsg</span><span class="p">(</span><span class="n">MSG_QUEUE</span> <span class="o">*</span><span class="n">Q</span><span class="p">,</span> <span class="n">word</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Show the first valid message in queue BUT DON&#39;T free the message.</span>
<span class="cm">	 * After looking on the message contents it can be freed queueFreeMsg()</span>
<span class="cm">	 * or simply remain in message queue.  */</span>

	<span class="n">MSG_HEAD</span> <span class="o">*</span><span class="n">Msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSG_HEAD</span> <span class="o">*</span><span class="p">)</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Head</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">Msg</span> <span class="o">==</span> <span class="n">Q</span><span class="o">-&gt;</span><span class="n">Tail</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Q</span><span class="o">-&gt;</span><span class="n">Wrap</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">Msg</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">&amp;</span> <span class="n">MSG_INCOMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">Msg</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)(</span><span class="n">Msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Message queue header</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">MSG_QUEUE</span> <span class="o">*</span><span class="n">dbg_queue</span><span class="p">;</span>
<span class="k">static</span> <span class="n">byte</span> <span class="o">*</span><span class="n">dbg_base</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>                 <span class="n">external_dbg_queue</span><span class="p">;</span>
<span class="k">static</span> <span class="n">diva_os_spin_lock_t</span> <span class="n">dbg_q_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">diva_os_spin_lock_t</span> <span class="n">dbg_adapter_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>                 <span class="n">dbg_q_busy</span><span class="p">;</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="n">dword</span>      <span class="n">dbg_sequence</span><span class="p">;</span>
<span class="k">static</span> <span class="n">dword</span>               <span class="n">start_sec</span><span class="p">;</span>
<span class="k">static</span> <span class="n">dword</span>               <span class="n">start_usec</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">  INTERFACE:</span>
<span class="cm">  Initialize run time queue structures.</span>
<span class="cm">  base:    base of the message queue</span>
<span class="cm">  length:  length of the message queue</span>
<span class="cm">  do_init: perfor queue reset</span>

<span class="cm">  return:  zero on success, -1 on error</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">diva_maint_init</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">do_init</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_queue</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>     <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="n">TraceFilterIdent</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">TraceFilterChannel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dbg_base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>

	<span class="n">diva_os_get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">start_usec</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="n">dword</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dword</span><span class="p">)</span><span class="n">DBG_MAGIC</span><span class="p">;</span> <span class="cm">/* Store Magic */</span>
	<span class="n">base</span>   <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="n">dword</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span> <span class="cm">/* Extension Field Length */</span>
	<span class="n">base</span>   <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s">&quot;KERNEL MODE BUFFER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">base</span>   <span class="o">+=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="mi">2048</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">dword</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Terminate extension */</span>
	<span class="n">base</span>   <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dword</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="n">base</span>  <span class="o">=</span>  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">base</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">));</span> <span class="cm">/* Store Base  */</span>
	<span class="n">base</span>   <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

	<span class="n">dbg_queue</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSG_QUEUE</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">;</span>
	<span class="n">queueInit</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MSG_QUEUE</span><span class="p">),</span> <span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MSG_QUEUE</span><span class="p">)</span> <span class="o">-</span> <span class="mi">512</span><span class="p">);</span>
	<span class="n">external_dbg_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">external_dbg_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* memory was located on the external device */</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">diva_os_initialize_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="s">&quot;dbg_init&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbg_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dbg_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">external_dbg_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diva_os_initialize_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="s">&quot;dbg_init&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">diva_os_destroy_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="s">&quot;dbg_init&quot;</span><span class="p">);</span>
		<span class="n">dbg_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dbg_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">external_dbg_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  INTERFACE:</span>
<span class="cm">  Finit at unload time</span>
<span class="cm">  return address of internal queue or zero if queue</span>
<span class="cm">  was external</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">diva_maint_finit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dbg_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dbg_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dbg_base</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_destroy_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="s">&quot;dbg_finit&quot;</span><span class="p">);</span>
		<span class="n">diva_os_destroy_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="s">&quot;dbg_finit&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">external_dbg_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">external_dbg_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  INTERFACE:</span>
<span class="cm">  Return amount of messages in debug queue</span>
<span class="cm">*/</span>
<span class="n">dword</span> <span class="nf">diva_dbg_q_length</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dbg_queue</span> <span class="o">?</span> <span class="n">queueCount</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">)</span>	<span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  INTERFACE:</span>
<span class="cm">  Lock message queue and return the pointer to the first</span>
<span class="cm">  entry.</span>
<span class="cm">*/</span>
<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="nf">diva_maint_get_message</span><span class="p">(</span><span class="n">word</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span>
					      <span class="n">diva_os_spin_lock_magic_t</span> <span class="o">*</span><span class="n">old_irql</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="n">pmsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_q_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read_busy&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbg_q_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dbg_q_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read_empty&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  INTERFACE:</span>
<span class="cm">  acknowledge last message and unlock queue</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">diva_maint_ack_message</span><span class="p">(</span><span class="kt">int</span> <span class="n">do_release</span><span class="p">,</span>
			    <span class="n">diva_os_spin_lock_magic_t</span> <span class="o">*</span><span class="n">old_irql</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbg_q_busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_release</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbg_q_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read_ack&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  INTERFACE:</span>
<span class="cm">  PRT COMP function used to register</span>
<span class="cm">  with MAINT adapter or log in compatibility</span>
<span class="cm">  mode in case older driver version is connected too</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">diva_maint_prtComp</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
	<span class="kt">void</span>    <span class="o">*</span><span class="n">hDbg</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">format</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	  register to new log driver functions</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">format</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hDbg</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span> <span class="cm">/* ptr to DbgHandle */</span>
		<span class="n">DI_register</span><span class="p">(</span><span class="n">hDbg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DI_register</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span><span class="p">;</span>
	<span class="n">pDbgHandle</span>	<span class="n">hDbg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">free_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">best_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">diva_os_get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usec</span><span class="p">);</span>

	<span class="n">hDbg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pDbgHandle</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	  Check for bad args, specially for the old obsolete debug handle</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hDbg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">_OldDbgHandle_</span> <span class="o">*</span><span class="p">)</span><span class="n">hDbg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">Registered</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">==</span> <span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  driver already registered</span>
<span class="cm">			*/</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* slot is busy */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">free_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">drvName</span><span class="p">,</span> <span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">drvName</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  This driver was already registered with this name</span>
<span class="cm">			  and slot is still free - reuse it</span>
<span class="cm">			*/</span>
			<span class="n">best_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* slot is busy */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="n">pmsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
		<span class="n">word</span> <span class="n">size</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		  Register new driver with id == free_id</span>
<span class="cm">		*/</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">=</span> <span class="n">hDbg</span><span class="p">;</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">sec</span>  <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">usec</span> <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">drvName</span><span class="p">,</span> <span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">drvName</span><span class="p">);</span>

		<span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">dbgMask</span> <span class="o">=</span> <span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">best_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">|=</span> <span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">last_dbgMask</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">last_dbgMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">Registered</span> <span class="o">=</span> <span class="n">DBG_HANDLE_REG_NEW</span><span class="p">;</span>
		<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span>         <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">free_id</span><span class="p">;</span>
		<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_end</span>    <span class="o">=</span> <span class="n">DI_deregister</span><span class="p">;</span>
		<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_prt</span>    <span class="o">=</span> <span class="n">DI_format_locked</span><span class="p">;</span>
		<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_ev</span>     <span class="o">=</span> <span class="n">DiProcessEventLog</span><span class="p">;</span>
		<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_irq</span>    <span class="o">=</span> <span class="n">DI_format_locked</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">Version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_old</span>  <span class="o">=</span> <span class="n">DI_format_old</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">next</span>       <span class="o">=</span> <span class="p">(</span><span class="n">pDbgHandle</span><span class="p">)</span><span class="n">DBG_MAGIC</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		  Log driver register, MAINT driver ID is &#39;0&#39;</span>
<span class="cm">		*/</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;DIMAINT - drv # %d = &#39;%s&#39; registered&quot;</span><span class="p">,</span>
			      <span class="n">free_id</span><span class="p">,</span> <span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">drvName</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
								       <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">)))))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_STRING</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">DLI_REG</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* id 0 - DIMAINT */</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
			<span class="n">diva_maint_wakeup_read</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DI_deregister</span><span class="p">(</span><span class="n">pDbgHandle</span> <span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">,</span> <span class="n">old_irql1</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">pmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">diva_os_get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usec</span><span class="p">);</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">==</span> <span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span>       <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_end</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_prt</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_irq</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">Version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbg_old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">Registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">next</span>     <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceLibraryFinit</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="n">pmem</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span><span class="p">;</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			  Log driver register, MAINT driver ID is &#39;0&#39;</span>
<span class="cm">			*/</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;DIMAINT - drv # %d = &#39;%s&#39; de-registered&quot;</span><span class="p">,</span>
				      <span class="n">i</span><span class="p">,</span> <span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">drvName</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
									      <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">)))))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_STRING</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">DLI_REG</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* id 0 - DIMAINT */</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
				<span class="n">diva_maint_wakeup_read</span><span class="p">();</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read_ack&quot;</span><span class="p">);</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;read_ack&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pmem</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DI_format_locked</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">id</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span>
			     <span class="kt">va_list</span> <span class="n">argument_list</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DI_format</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">argument_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DI_format</span><span class="p">(</span><span class="kt">int</span> <span class="n">do_lock</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">id</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
		      <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span>
		      <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span><span class="p">;</span>
	<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="n">pmsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">fmtBuf</span><span class="p">[</span><span class="n">MSG_FRAME_MAX_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span>          <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diva_os_in_irq</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">format</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">TraceFilterIdent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">TraceFilterChannel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>



	<span class="n">diva_os_get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;format&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DLI_MXLOG</span>:
	<span class="k">case</span> <span class="n">DLI_BLK</span>:
	<span class="k">case</span> <span class="n">DLI_SEND</span>:
	<span class="k">case</span> <span class="n">DLI_RECV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">length</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MaxDumpSize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">MaxDumpSize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
								       <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">format</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_BINARY</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* DLI_XXX */</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="n">id</span><span class="p">;</span>   <span class="cm">/* driver MAINT id */</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DLI_XLOG</span>: <span class="p">{</span>
		<span class="n">byte</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">data</span>    <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
		<span class="n">code</span>    <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
		<span class="n">length</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MaxXlogSize</span><span class="p">)</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">MaxXlogSize</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
								      <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">code</span><span class="p">);</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">code</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">length</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">length</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_BINARY</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* DLI_XXX */</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="n">id</span><span class="p">;</span>   <span class="cm">/* driver MAINT id */</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
			<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DLI_LOG</span>:
	<span class="k">case</span> <span class="n">DLI_FTL</span>:
	<span class="k">case</span> <span class="n">DLI_ERR</span>:
	<span class="k">case</span> <span class="n">DLI_TRC</span>:
	<span class="k">case</span> <span class="n">DLI_REG</span>:
	<span class="k">case</span> <span class="n">DLI_MEM</span>:
	<span class="k">case</span> <span class="n">DLI_SPL</span>:
	<span class="k">case</span> <span class="n">DLI_IRP</span>:
	<span class="k">case</span> <span class="n">DLI_TIM</span>:
	<span class="k">case</span> <span class="n">DLI_TAPI</span>:
	<span class="k">case</span> <span class="n">DLI_NDIS</span>:
	<span class="k">case</span> <span class="n">DLI_CONN</span>:
	<span class="k">case</span> <span class="n">DLI_STAT</span>:
	<span class="k">case</span> <span class="n">DLI_PRV0</span>:
	<span class="k">case</span> <span class="n">DLI_PRV1</span>:
	<span class="k">case</span> <span class="n">DLI_PRV2</span>:
	<span class="k">case</span> <span class="n">DLI_PRV3</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vsprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmtBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">format</span><span class="p">,</span> <span class="n">ap</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
									       <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">length</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_STRING</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">type</span><span class="p">;</span> <span class="cm">/* DLI_XXX */</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="n">id</span><span class="p">;</span>   <span class="cm">/* driver MAINT id */</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">);</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fmtBuf</span><span class="p">,</span> <span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span><span class="p">);</span>
			<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="cm">/* switch type */</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">queueCount</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">diva_maint_wakeup_read</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;format&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Write driver ID and driver revision to callers buffer</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">diva_get_driver_info</span><span class="p">(</span><span class="n">dword</span> <span class="n">id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_length</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_copy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">id</span> <span class="o">||</span> <span class="p">(</span><span class="n">data_length</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;driver info&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">sec</span><span class="p">;</span> <span class="cm">/* save seconds */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">sec</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">sec</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">sec</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span> <span class="cm">/* save mseconds */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)((</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="n">data_length</span> <span class="o">-=</span> <span class="mi">9</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">to_copy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">drvName</span><span class="p">),</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">data_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">drvName</span><span class="p">,</span> <span class="n">to_copy</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">to_copy</span><span class="p">;</span>
			<span class="n">data_length</span> <span class="o">-=</span> <span class="n">to_copy</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">data_length</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">drvTag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;(&#39;</span><span class="p">;</span>
				<span class="n">data_length</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">to_copy</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">drvTag</span><span class="p">),</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">data_length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))))</span> <span class="p">{</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">drvTag</span><span class="p">,</span> <span class="n">to_copy</span><span class="p">);</span>
					<span class="n">p</span> <span class="o">+=</span> <span class="n">to_copy</span><span class="p">;</span>
					<span class="n">data_length</span> <span class="o">-=</span> <span class="n">to_copy</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">data_length</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;)&#39;</span><span class="p">;</span>
						<span class="n">data_length</span><span class="o">--</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;driver info&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">diva_get_driver_dbg_mask</span><span class="p">(</span><span class="n">dword</span> <span class="n">id</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span> <span class="o">||</span> <span class="o">!</span><span class="n">id</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;driver info&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;driver info&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">diva_set_driver_dbg_mask</span><span class="p">(</span><span class="n">dword</span> <span class="n">id</span><span class="p">,</span> <span class="n">dword</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">,</span> <span class="n">old_irql1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span> <span class="o">||</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;dbg mask&quot;</span><span class="p">);</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;dbg mask&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dword</span> <span class="n">old_mask</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">last_dbgMask</span> <span class="o">=</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">|</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dbgMask</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">diva_change_management_debug_mask</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="n">old_mask</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;dbg mask&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span><span class="p">))((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;dbg mask&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">diva_get_idi_adapter_info</span><span class="p">(</span><span class="n">IDI_CALL</span> <span class="n">request</span><span class="p">,</span> <span class="n">dword</span> <span class="o">*</span><span class="n">serial</span><span class="p">,</span> <span class="n">dword</span> <span class="o">*</span><span class="n">logical</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="n">sync_req</span><span class="p">;</span>

	<span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_logical_adapter_number</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_logical_adapter_number</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_XDI_GET_LOGICAL_ADAPTER_NUMBER</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sync_req</span><span class="p">);</span>
	<span class="o">*</span><span class="n">logical</span> <span class="o">=</span> <span class="n">sync_req</span><span class="p">.</span><span class="n">xdi_logical_adapter_number</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">logical_adapter_number</span><span class="p">;</span>

	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_GET_SERIAL</span><span class="p">;</span>
	<span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sync_req</span><span class="p">);</span>
	<span class="o">*</span><span class="n">serial</span> <span class="o">=</span> <span class="n">sync_req</span><span class="p">.</span><span class="n">GetSerial</span><span class="p">.</span><span class="n">serial</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Register XDI adapter as MAINT compatible driver</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">diva_mnt_add_xdi_adapter</span><span class="p">(</span><span class="k">const</span> <span class="n">DESCRIPTOR</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">,</span> <span class="n">old_irql1</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span><span class="p">,</span> <span class="n">logical</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="n">org_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">free_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
	<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="n">pmsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">pmem</span><span class="p">;</span>

	<span class="n">diva_os_get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usec</span><span class="p">);</span>
	<span class="n">diva_get_idi_adapter_info</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serial</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">logical</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serial</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;ADAPTER:%d SN:%u-%d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">logical</span><span class="p">,</span>
			<span class="n">serial</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">,</span>
			<span class="p">(</span><span class="n">byte</span><span class="p">)(((</span><span class="n">serial</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;ADAPTER:%d SN:%u&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">logical</span><span class="p">,</span> <span class="n">serial</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmem</span> <span class="o">=</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DivaSTraceGetMemotyRequirement</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pmem</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">DivaSTraceGetMemotyRequirement</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">));</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pmem</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* slot is busy */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">free_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">drvName</span><span class="p">,</span> <span class="n">tmp</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  This driver was already registered with this name</span>
<span class="cm">			  and slot is still free - reuse it</span>
<span class="cm">			*/</span>
			<span class="n">free_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pmem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">free_id</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span>  <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span>     <span class="o">=</span> <span class="o">&amp;</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">sec</span>      <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">usec</span>     <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">drvName</span><span class="p">,</span>     <span class="n">tmp</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">drvName</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">drvTag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">logical</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">logical</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">channels</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbgMask</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dbgMask</span>        <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbgMask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">|=</span> <span class="n">clients</span><span class="p">[</span><span class="n">free_id</span><span class="p">].</span><span class="n">last_dbgMask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">last_dbgMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">Registered</span> <span class="o">=</span> <span class="n">DBG_HANDLE_REG_NEW</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">id</span>         <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">id</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbg_end</span>    <span class="o">=</span> <span class="n">DI_deregister</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbg_prt</span>    <span class="o">=</span> <span class="n">DI_format_locked</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbg_ev</span>     <span class="o">=</span> <span class="n">DiProcessEventLog</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbg_irq</span>    <span class="o">=</span> <span class="n">DI_format_locked</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">next</span>       <span class="o">=</span> <span class="p">(</span><span class="n">pDbgHandle</span><span class="p">)</span><span class="n">DBG_MAGIC</span><span class="p">;</span>

	<span class="p">{</span>
		<span class="n">diva_trace_library_user_interface_t</span> <span class="n">diva_maint_user_ifc</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">],</span>
									    <span class="n">diva_maint_state_change_notify</span><span class="p">,</span>
									    <span class="n">diva_maint_trace_notify</span><span class="p">,</span>
									    <span class="n">diva_maint_error</span> <span class="p">};</span>

		<span class="cm">/*</span>
<span class="cm">		  Attach to adapter management interface</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">=</span>
		     <span class="n">DivaSTraceLibraryCreateInstance</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">logical</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diva_maint_user_ifc</span><span class="p">,</span> <span class="n">pmem</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceLibraryStart</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DLI_ERR</span><span class="p">,</span> <span class="s">&quot;Adapter(%d) Start failed&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">logical</span><span class="p">);</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceLibraryFinit</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DLI_ERR</span><span class="p">,</span> <span class="s">&quot;A(%d) management init failed&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">logical</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hDbg</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pmem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	  Log driver register, MAINT driver ID is &#39;0&#39;</span>
<span class="cm">	*/</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;DIMAINT - drv # %d = &#39;%s&#39; registered&quot;</span><span class="p">,</span>
		      <span class="n">id</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">drvName</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
							       <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">)))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_STRING</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">DLI_REG</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* id 0 - DIMAINT */</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
		<span class="n">diva_maint_wakeup_read</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">org_mask</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbgMask</span><span class="p">;</span>
	<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">dbgMask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">request</span><span class="p">))((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;register&quot;</span><span class="p">);</span>

	<span class="n">diva_set_driver_dbg_mask</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">org_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  De-Register XDI adapter</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">diva_mnt_remove_xdi_adapter</span><span class="p">(</span><span class="k">const</span> <span class="n">DESCRIPTOR</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">,</span> <span class="n">old_irql1</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">pmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">diva_os_get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usec</span><span class="p">);</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceLibraryFinit</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

				<span class="n">pmem</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span><span class="p">;</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				  Free DMA handle</span>
<span class="cm">				*/</span>
				<span class="n">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span><span class="p">);</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			  Log driver register, MAINT driver ID is &#39;0&#39;</span>
<span class="cm">			*/</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;DIMAINT - drv # %d = &#39;%s&#39; de-registered&quot;</span><span class="p">,</span>
				      <span class="n">i</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">drvName</span><span class="p">);</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Dbg</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Dbg</span><span class="p">));</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
									       <span class="p">(</span><span class="n">word</span><span class="p">)(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">)))))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_STRING</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">DLI_REG</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* id 0 - DIMAINT */</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
				<span class="n">diva_maint_wakeup_read</span><span class="p">();</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read_ack&quot;</span><span class="p">);</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;read_ack&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pmem</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------</span>
<span class="cm">   Low level interface for management interface client</span>
<span class="cm">   ---------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm">  Return handle to client structure</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">SuperTraceOpenAdapter</span><span class="p">(</span><span class="kt">int</span> <span class="n">AdapterNumber</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">logical</span> <span class="o">==</span> <span class="n">AdapterNumber</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceCloseAdapter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">AdapterHandle</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceReadRequest</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">AdapterHandle</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">AdapterHandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
		<span class="n">byte</span> <span class="o">*</span><span class="n">xdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">word</span> <span class="n">length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Read ROOT */</span>
			<span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">SuperTraceCreateReadReq</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">single_p</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* End Of Message */</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span>        <span class="o">=</span> <span class="n">MAN_READ</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">P</span>	<span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">xdata</span><span class="p">;</span>

		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceGetNumberOfChannels</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">AdapterHandle</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AdapterHandle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">AdapterHandle</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceASSIGN</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">AdapterHandle</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">AdapterHandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
		<span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="n">preq</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">buffer</span><span class="p">[((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ENTITY</span><span class="p">))</span> <span class="o">?</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ENTITY</span><span class="p">)];</span>
		<span class="kt">char</span> <span class="n">features</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">word</span> <span class="n">assign_data_length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">preq</span> <span class="o">=</span> <span class="p">(</span><span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">Rc</span>  <span class="o">=</span> <span class="n">IDI_SYNC_REQ_XDI_GET_EXTENDED_FEATURES</span><span class="p">;</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">buffer_length_in_bytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">features</span><span class="p">);</span>
		<span class="n">preq</span><span class="o">-&gt;</span><span class="n">xdi_extended_features</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="n">preq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_EXTENDED_FEATURES_VALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DIVA_XDI_EXTENDED_FEATURE_MANAGEMENT_DMA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dword</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">rx_dma_magic</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="n">diva_get_dma_descriptor</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_dma_magic</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LLI</span><span class="p">;</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">;</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">rx_dma_magic</span><span class="p">;</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">rx_dma_magic</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">DIVA_MAX_MANAGEMENT_TRANSFER_SIZE</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">DIVA_MAX_MANAGEMENT_TRANSFER_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">assign_data_length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pC</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Id</span>          <span class="o">=</span> <span class="n">MAN_ID</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">callback</span>    <span class="o">=</span> <span class="n">diva_maint_xdi_cb</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">XNum</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">XData</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span>         <span class="o">=</span> <span class="n">ASSIGN</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span>  <span class="o">=</span> <span class="n">assign_data_length</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">P</span>        <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceREMOVE</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">AdapterHandle</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">AdapterHandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">XNum</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span>           <span class="o">=</span> <span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">XData</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span>         <span class="o">=</span> <span class="n">REMOVE</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">P</span>        <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceTraceOnRequest</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hAdapter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">byte</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">hAdapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
		<span class="n">byte</span> <span class="o">*</span><span class="n">xdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">word</span> <span class="n">length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Read ROOT */</span>
			<span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">SuperTraceCreateReadReq</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">single_p</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* End Of Message */</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span>          <span class="o">=</span> <span class="n">MAN_EVENT_ON</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span>   <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">xdata</span><span class="p">;</span>

		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceWriteVar</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">AdapterHandle</span><span class="p">,</span>
		       <span class="n">byte</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		       <span class="kt">void</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span>
		       <span class="n">byte</span> <span class="n">type</span><span class="p">,</span>
		       <span class="n">byte</span> <span class="n">var_length</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">AdapterHandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
		<span class="n">diva_man_var_header_t</span> <span class="o">*</span><span class="n">pVar</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_man_var_header_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">word</span> <span class="n">length</span> <span class="o">=</span> <span class="n">SuperTraceCreateReadReq</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">pVar</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="n">length</span><span class="p">],</span> <span class="n">var</span><span class="p">,</span> <span class="n">var_length</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">+=</span> <span class="n">var_length</span><span class="p">;</span>
		<span class="n">pVar</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+=</span> <span class="n">var_length</span><span class="p">;</span>
		<span class="n">pVar</span><span class="o">-&gt;</span><span class="n">value_length</span> <span class="o">=</span> <span class="n">var_length</span><span class="p">;</span>
		<span class="n">pVar</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="n">single_p</span><span class="p">((</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">pVar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* End Of Message */</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span> <span class="o">=</span> <span class="n">MAN_WRITE</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span>   <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">pVar</span><span class="p">;</span>

		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">SuperTraceExecuteRequest</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">AdapterHandle</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			     <span class="n">byte</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">AdapterHandle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
		<span class="n">byte</span> <span class="o">*</span><span class="n">xdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">xbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">word</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">length</span> <span class="o">=</span> <span class="n">SuperTraceCreateReadReq</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">single_p</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* End Of Message */</span>

		<span class="n">e</span><span class="o">-&gt;</span><span class="n">Req</span> <span class="o">=</span> <span class="n">MAN_EXECUTE</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">ReqCh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">PLength</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">X</span><span class="o">-&gt;</span><span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span><span class="n">xdata</span><span class="p">;</span>

		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">word</span> <span class="nf">SuperTraceCreateReadReq</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">byte</span> <span class="n">var_length</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">plen</span><span class="p">;</span>

	<span class="n">var_length</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>

	<span class="o">*</span><span class="n">P</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC</span><span class="p">;</span>
	<span class="n">plen</span> <span class="o">=</span> <span class="n">P</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">P</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* MAN_IE */</span>
	<span class="o">*</span><span class="n">P</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Type */</span>
	<span class="o">*</span><span class="n">P</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Attribute */</span>
	<span class="o">*</span><span class="n">P</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Status */</span>
	<span class="o">*</span><span class="n">P</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Variable Length */</span>
	<span class="o">*</span><span class="n">P</span><span class="o">++</span> <span class="o">=</span> <span class="n">var_length</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">var_length</span><span class="p">);</span>
	<span class="n">P</span> <span class="o">+=</span> <span class="n">var_length</span><span class="p">;</span>
	<span class="o">*</span><span class="n">plen</span> <span class="o">=</span> <span class="n">var_length</span> <span class="o">+</span> <span class="mh">0x06</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">word</span><span class="p">)(</span><span class="n">var_length</span> <span class="o">+</span> <span class="mh">0x08</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">single_p</span><span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="n">word</span> <span class="o">*</span><span class="n">PLength</span><span class="p">,</span> <span class="n">byte</span> <span class="n">Id</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">P</span><span class="p">[(</span><span class="o">*</span><span class="n">PLength</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">Id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_maint_xdi_cb</span><span class="p">(</span><span class="n">ENTITY</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_strace_context_t</span> <span class="o">*</span><span class="n">pLib</span> <span class="o">=</span> <span class="n">DIVAS_CONTAINING_RECORD</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">diva_strace_context_t</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span><span class="p">;</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">,</span> <span class="n">old_irql1</span><span class="p">;</span>


	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;xdi_cb&quot;</span><span class="p">);</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;xdi_cb&quot;</span><span class="p">);</span>

	<span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">pLib</span><span class="o">-&gt;</span><span class="n">hAdapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pLib</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">.</span><span class="n">DivaSTraceMessageInput</span><span class="p">))(</span><span class="o">&amp;</span><span class="n">pLib</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DLI_ERR</span><span class="p">,</span> <span class="s">&quot;Trace internal library error&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		  Process combined management interface indication</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">pLib</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">.</span><span class="n">DivaSTraceMessageInput</span><span class="p">))(</span><span class="o">&amp;</span><span class="n">pLib</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DLI_ERR</span><span class="p">,</span> <span class="s">&quot;Trace internal library error (DMA mode)&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;xdi_cb&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pC</span><span class="o">-&gt;</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))(</span><span class="n">e</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;xdi_cb&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_maint_error</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_context</span><span class="p">,</span>
			     <span class="n">diva_strace_library_interface_t</span> <span class="o">*</span><span class="n">hLib</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">Adapter</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">error</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">line</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DLI_ERR</span><span class="p">,</span>
				  <span class="s">&quot;Trace library error(%d) A(%d) %s %d&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">Adapter</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_ie</span><span class="p">(</span><span class="n">diva_trace_ie_t</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">buffer</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ie</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
				<span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
				<span class="n">length</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_maint_state_change_notify</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_context</span><span class="p">,</span>
					   <span class="n">diva_strace_library_interface_t</span> <span class="o">*</span><span class="n">hLib</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">Adapter</span><span class="p">,</span>
					   <span class="n">diva_trace_line_state_t</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">notify_subject</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">user_context</span><span class="p">;</span>
	<span class="n">diva_trace_fax_state_t</span> <span class="o">*</span><span class="n">fax</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">;</span>
	<span class="n">diva_trace_modem_state_t</span> <span class="o">*</span><span class="n">modem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">notify_subject</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DIVA_SUPER_TRACE_NOTIFY_LINE_CHANGE</span>: <span class="p">{</span>
		<span class="kt">int</span> <span class="n">view</span> <span class="o">=</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		  Process selective Trace</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">Line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;I&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">Line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;d&#39;</span> <span class="o">&amp;&amp;</span>
		    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">Line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">Line</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;e&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">TraceFilterIdent</span> <span class="o">==</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">TraceFilterChannel</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">))</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">hLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetBChannel</span><span class="p">))(</span><span class="n">hLib</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">hLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetAudioTap</span><span class="p">))(</span><span class="n">hLib</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span> <span class="s">&quot;Selective Trace OFF for Ch=%d&quot;</span><span class="p">,</span>
							  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">);</span>
				<span class="n">TraceFilterIdent</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">TraceFilterChannel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">view</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">TraceFilterIdent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">diva_mnt_cmp_nmbr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">RemoteAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
									 <span class="n">diva_mnt_cmp_nmbr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">LocalAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_BCHANNEL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Activate B-channel trace */</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">hLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetBChannel</span><span class="p">))(</span><span class="n">hLib</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_AUDIO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Activate AudioTap Trace */</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">hLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetAudioTap</span><span class="p">))(</span><span class="n">hLib</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">TraceFilterIdent</span>   <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="n">TraceFilterChannel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">TraceFilterIdent</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span> <span class="s">&quot;Selective Trace ON for Ch=%d&quot;</span><span class="p">,</span>
							  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">);</span>
				<span class="n">view</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">view</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_LINE_EVENTS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L Ch     = %d&quot;</span><span class="p">,</span>
						  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L Status = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">Line</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L Layer1 = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">Framing</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L Layer2 = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">Layer2</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L Layer3 = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">Layer3</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L RAddr  = &lt;%s&gt;&quot;</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">RemoteAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L RSAddr = &lt;%s&gt;&quot;</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">RemoteSubAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L LAddr  = &lt;%s&gt;&quot;</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">LocalAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L LSAddr = &lt;%s&gt;&quot;</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">LocalSubAddress</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">print_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">call_BC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L BC     = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">print_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">call_HLC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L HLC    = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">print_ie</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">call_LLC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L LLC    = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L CR     = 0x%x&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">CallReference</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L Disc   = 0x%x&quot;</span><span class="p">,</span>
						  <span class="n">channel</span><span class="o">-&gt;</span><span class="n">LastDisconnecCause</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;L Owner  = &lt;%s&gt;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">UserID</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIVA_SUPER_TRACE_NOTIFY_MODEM_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_MDM_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">TraceFilterChannel</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">TraceFilterIdent</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">==</span> <span class="n">hLib</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">modem</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>


			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Ch    = %lu&quot;</span><span class="p">,</span>
						  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">modem</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Event = %lu&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Norm  = %lu&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">Norm</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Opts. = 0x%08x&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">Options</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Tx    = %lu Bps&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">TxSpeed</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Rx    = %lu Bps&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">RxSpeed</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM RT    = %lu mSec&quot;</span><span class="p">,</span>
						  <span class="n">modem</span><span class="o">-&gt;</span><span class="n">RoundtripMsec</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Sr    = %lu&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">SymbolRate</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Rxl   = %d dBm&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">RxLeveldBm</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM El    = %d dBm&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">EchoLeveldBm</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM SNR   = %lu dB&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">SNRdb</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM MAE   = %lu&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">MAE</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM LRet  = %lu&quot;</span><span class="p">,</span>
						  <span class="n">modem</span><span class="o">-&gt;</span><span class="n">LocalRetrains</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM RRet  = %lu&quot;</span><span class="p">,</span>
						  <span class="n">modem</span><span class="o">-&gt;</span><span class="n">RemoteRetrains</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM LRes  = %lu&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">LocalResyncs</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM RRes  = %lu&quot;</span><span class="p">,</span>
						  <span class="n">modem</span><span class="o">-&gt;</span><span class="n">RemoteResyncs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">modem</span><span class="o">-&gt;</span><span class="n">Event</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;MDM Disc  =  %lu&quot;</span><span class="p">,</span> <span class="n">modem</span><span class="o">-&gt;</span><span class="n">DiscReason</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">modem</span><span class="o">-&gt;</span><span class="n">Event</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_MDM_STATISTICS</span><span class="p">))</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetModemStatistics</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIVA_SUPER_TRACE_NOTIFY_FAX_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_FAX_PROGRESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">TraceFilterChannel</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">TraceFilterIdent</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">==</span> <span class="n">hLib</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Ch    = %lu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">ChannelNumber</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Event = %lu&quot;</span><span class="p">,</span>     <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Pages = %lu&quot;</span><span class="p">,</span>     <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Page_Counter</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Feat. = 0x%08x&quot;</span><span class="p">,</span>  <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Features</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX ID    = &lt;%s&gt;&quot;</span><span class="p">,</span>    <span class="o">&amp;</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">Station_ID</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Saddr = &lt;%s&gt;&quot;</span><span class="p">,</span>    <span class="o">&amp;</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">Subaddress</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Pwd   = &lt;%s&gt;&quot;</span><span class="p">,</span>    <span class="o">&amp;</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">Password</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Speed = %lu&quot;</span><span class="p">,</span>     <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Speed</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Res.  = 0x%08x&quot;</span><span class="p">,</span>  <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Resolution</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Width = %lu&quot;</span><span class="p">,</span>     <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Paper_Width</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Length= %lu&quot;</span><span class="p">,</span>     <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Paper_Length</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX SLT   = %lu&quot;</span><span class="p">,</span>     <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Scanline_Time</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">Event</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span> <span class="s">&quot;FAX Disc  = %lu&quot;</span><span class="p">,</span>     <span class="n">fax</span><span class="o">-&gt;</span><span class="n">Disc_Reason</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">Event</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_FAX_STATISTICS</span><span class="p">))</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetFaxStatistics</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIVA_SUPER_TRACE_INTERFACE_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_EVENTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span>
						  <span class="s">&quot;Layer 1 -&gt; [%s]&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterface</span><span class="o">-&gt;</span><span class="n">Layer1</span><span class="p">);</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_STAT</span><span class="p">,</span>
						  <span class="s">&quot;Layer 2 -&gt; [%s]&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterface</span><span class="o">-&gt;</span><span class="n">Layer2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIVA_SUPER_TRACE_NOTIFY_STAT_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_STATISTICS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			  Incoming Statistics</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Calls</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Calls                     =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Calls</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Connected</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Connected                 =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Connected</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">User_Busy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Busy                      =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">User_Busy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Call_Rejected</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Rejected                  =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Call_Rejected</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Wrong_Number</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Wrong Nr                  =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Wrong_Number</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Incompatible_Dst</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Incomp. Dest              =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Incompatible_Dst</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Out_of_Order</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Out of Order              =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Out_of_Order</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Ignored</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Inc Ignored                   =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">inc</span><span class="p">.</span><span class="n">Ignored</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			  Outgoing Statistics</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Calls</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Outg Calls                    =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Calls</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Connected</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Outg Connected                =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Connected</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">User_Busy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Outg Busy                     =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">User_Busy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">No_Answer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Outg No Answer                =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">No_Answer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Wrong_Number</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Outg Wrong Nr                 =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Wrong_Number</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Call_Rejected</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Outg Rejected                 =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Call_Rejected</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Other_Failures</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
							  <span class="s">&quot;Outg Other Failures           =%lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">outg</span><span class="p">.</span><span class="n">Other_Failures</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIVA_SUPER_TRACE_NOTIFY_MDM_STAT_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Normal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Normal        = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Normal</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Unspecified</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Unsp.         = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Unspecified</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Busy_Tone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Busy Tone     = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Busy_Tone</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Congestion</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Congestion    = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Congestion</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Carr_Wait</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Carrier Wait  = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Carr_Wait</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Trn_Timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Trn. T.o.     = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Trn_Timeout</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Incompat</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Incompatible  = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Incompat</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Frame_Rej</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc Frame Reject  = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_Frame_Rej</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_V42bis</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;MDM Disc V.42bis       = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">Disc_V42bis</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DIVA_SUPER_TRACE_NOTIFY_FAX_STAT_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Normal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Normal        = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Normal</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Not_Ident</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Not Ident.    = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Not_Ident</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_No_Response</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc No Response   = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_No_Response</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Retries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Max Retries   = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Retries</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Unexp_Msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Unexp. Msg.        = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Unexp_Msg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_No_Polling</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc No Polling    = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_No_Polling</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Training</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Training      = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Training</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Unexpected</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Unexpected    = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Unexpected</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Application</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Application   = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Application</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Incompat</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Incompatible  = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Incompat</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_No_Command</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc No Command    = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_No_Command</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Long_Msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Long Msg.     = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Long_Msg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Supervisor</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Supervisor    = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Supervisor</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_SUB_SEP_PWD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc SUP SEP PWD   = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_SUB_SEP_PWD</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Invalid_Msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Invalid Msg.  = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Invalid_Msg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Page_Coding</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Page Coding   = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Page_Coding</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_App_Timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Appl. T.o.    = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_App_Timeout</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Unspecified</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">DLI_LOG</span><span class="p">,</span>
						  <span class="s">&quot;FAX Disc Unspec.       = %lu&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">pInterfaceStat</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">.</span><span class="n">Disc_Unspecified</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Receive trace information from the Management Interface and store it in the</span>
<span class="cm">  internal trace buffer with MSG_TYPE_MLOG as is, without any filtering.</span>
<span class="cm">  Event Filtering and formatting is done in  Management Interface self.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_maint_trace_notify</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_context</span><span class="p">,</span>
				    <span class="n">diva_strace_library_interface_t</span> <span class="o">*</span><span class="n">hLib</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">Adapter</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="o">*</span><span class="n">xlog_buffer</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="p">)</span><span class="n">user_context</span><span class="p">;</span>
	<span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="n">word</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">sec</span><span class="p">,</span> <span class="n">usec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">TraceFilterChannel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">TraceFilterIdent</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	  Selective trace</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">Dbg</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">==</span> <span class="n">hLib</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ch_value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">MI_XLOG_HDR</span> <span class="o">*</span><span class="n">TrcData</span> <span class="o">=</span> <span class="p">(</span><span class="n">MI_XLOG_HDR</span> <span class="o">*</span><span class="p">)</span><span class="n">xlog_buffer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">Adapter</span> <span class="o">!=</span> <span class="n">clients</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">logical</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* Ignore all trace messages from other adapters */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">TrcData</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">TrcData</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		  All L1 messages start as [dsp,ch], so we can filter this information</span>
<span class="cm">		  and filter out all messages that use different channel</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">ch_value</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">ch_value</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ch_value</span> <span class="o">=</span> <span class="n">ch_value</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ch_value</span> <span class="o">!=</span> <span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span><span class="p">;</span> <span class="cm">/* Ignore other channels */</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* Ignore trace if trace filter is activated, but idle */</span>
	<span class="p">}</span>

	<span class="n">diva_os_get_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usec</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queueAllocMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span>
							       <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">length</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmsg</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pmsg</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_dbg_entry_head_t</span> <span class="o">*</span><span class="p">)</span><span class="n">queuePeekMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">queueFreeMsg</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmsg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmsg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">xlog_buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">sequence</span>    <span class="o">=</span> <span class="n">dbg_sequence</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_sec</span>    <span class="o">=</span> <span class="n">sec</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">time_usec</span>   <span class="o">=</span> <span class="n">usec</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">facility</span>    <span class="o">=</span> <span class="n">MSG_TYPE_MLOG</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">dli</span>         <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">logical</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">drv_id</span>      <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">di_cpu</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pmsg</span><span class="o">-&gt;</span><span class="n">data_length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">queueCompleteMsg</span><span class="p">(</span><span class="n">pmsg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queueCount</span><span class="p">(</span><span class="n">dbg_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">diva_maint_wakeup_read</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  Convert MAINT trace mask to management interface trace mask/work/facility and</span>
<span class="cm">  issue command to management interface</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_change_management_debug_mask</span><span class="p">(</span><span class="n">diva_maint_client_t</span> <span class="o">*</span><span class="n">pC</span><span class="p">,</span> <span class="n">dword</span> <span class="n">old_mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dword</span> <span class="n">changed</span> <span class="o">=</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">^</span> <span class="n">old_mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_TRACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetInfo</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="p">,</span>
							    <span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_TRACE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_DCHAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetDChannel</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="p">,</span>
								<span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_DCHAN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_BCHANNEL</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="p">((</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_BCHANNEL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetBChannel</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_AUDIO</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="p">((</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_AUDIO</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pC</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetAudioTap</span><span class="p">))(</span><span class="n">pC</span><span class="o">-&gt;</span><span class="n">pIdiLib</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">diva_mnt_internal_dprintf</span><span class="p">(</span><span class="n">dword</span> <span class="n">drv_id</span><span class="p">,</span> <span class="n">dword</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">DI_format</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span><span class="p">)</span><span class="n">drv_id</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">type</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Shutdown all adapters before driver removal</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">diva_mnt_shutdown_xdi_adapters</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">,</span> <span class="n">old_irql1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">*</span><span class="n">pmem</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;unload&quot;</span><span class="p">);</span>
		<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;unload&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceLibraryStop</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				  Adapter removal complete</span>
<span class="cm">				*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="p">)</span> <span class="p">{</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceLibraryFinit</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">);</span>
					<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

					<span class="n">pmem</span> <span class="o">=</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span><span class="p">;</span>
					<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					  Free DMA handle</span>
<span class="cm">					*/</span>
					<span class="n">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span><span class="p">);</span>
					<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;unload&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">))((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">,</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span><span class="p">);</span>
				<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;unload&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pmem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pmem</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">fret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Set/Read the trace filter used for selective tracing.</span>
<span class="cm">  Affects B- and Audio Tap trace mask at run time</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">diva_set_trace_filter</span><span class="p">(</span><span class="kt">int</span> <span class="n">filter_length</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">,</span> <span class="n">old_irql1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="n">client_b_on</span><span class="p">,</span> <span class="n">client_atap_on</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;dbg mask&quot;</span><span class="p">);</span>
	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write_filter&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter_length</span> <span class="o">&lt;=</span> <span class="n">DIVA_MAX_SELECTIVE_FILTER_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">filter</span><span class="p">,</span> <span class="n">filter_length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="n">filter_length</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">TraceFilter</span><span class="p">[</span><span class="n">filter_length</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">filter_length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TraceFilterIdent</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">TraceFilterChannel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">on</span> <span class="o">=</span> <span class="p">(</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">client_b_on</span>    <span class="o">=</span> <span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_BCHANNEL</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">client_atap_on</span> <span class="o">=</span> <span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span><span class="o">-&gt;</span><span class="n">dbgMask</span> <span class="o">&amp;</span> <span class="n">DIVA_MGT_DBG_IFC_AUDIO</span><span class="p">)</span>    <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channels</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetBChannel</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">client_b_on</span><span class="p">);</span>
				<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceSetAudioTap</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">client_atap_on</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">clients</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hDbg</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span> <span class="o">&amp;&amp;</span> <span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write_filter&quot;</span><span class="p">);</span>
			<span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">request</span><span class="p">))((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">DivaSTraceGetHandle</span><span class="p">))(</span><span class="n">clients</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pIdiLib</span><span class="o">-&gt;</span><span class="n">hLib</span><span class="p">));</span>
			<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write_filter&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;write_filter&quot;</span><span class="p">);</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_adapter_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql1</span><span class="p">,</span> <span class="s">&quot;dbg mask&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">filter_length</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">diva_get_trace_filter</span><span class="p">(</span><span class="kt">int</span> <span class="n">max_length</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">diva_os_spin_lock_magic_t</span> <span class="n">old_irql</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">diva_os_enter_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read_filter&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_length</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">diva_os_leave_spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbg_q_lock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irql</span><span class="p">,</span> <span class="s">&quot;read_filter&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">diva_dbg_cmp_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">ref</span><span class="o">++</span> <span class="o">==</span> <span class="o">*</span><span class="n">key</span><span class="o">++</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!*</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">ref</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  In case trace filter starts with &quot;C&quot; character then</span>
<span class="cm">  all following characters are interpreted as command.</span>
<span class="cm">  Followings commands are available:</span>
<span class="cm">  - single, trace single call at time, independent from CPN/CiPN</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">diva_mnt_cmp_nmbr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nmbr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ref_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TraceFilter</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">nmbr_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">nmbr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">diva_dbg_cmp_key</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;single&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref_len</span> <span class="o">||</span> <span class="p">(</span><span class="n">ref_len</span> <span class="o">&gt;</span> <span class="n">nmbr_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">nmbr</span> <span class="o">=</span> <span class="n">nmbr</span> <span class="o">+</span> <span class="n">nmbr_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ref</span>  <span class="o">=</span> <span class="n">ref</span>  <span class="o">+</span> <span class="n">ref_len</span>  <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ref_len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nmbr</span><span class="o">--</span> <span class="o">!=</span> <span class="o">*</span><span class="n">ref</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">diva_get_dma_descriptor</span><span class="p">(</span><span class="n">IDI_CALL</span> <span class="n">request</span><span class="p">,</span> <span class="n">dword</span> <span class="o">*</span><span class="n">dma_magic</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ENTITY</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_OPERATION</span><span class="p">;</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span>     <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_ALLOC</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="n">pReq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">operation</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dma_magic</span> <span class="o">=</span> <span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_free_dma_descriptor</span><span class="p">(</span><span class="n">IDI_CALL</span> <span class="n">request</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ENTITY</span> <span class="n">e</span><span class="p">;</span>
	<span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="n">pReq</span> <span class="o">=</span> <span class="p">(</span><span class="n">IDI_SYNC_REQ</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span> <span class="o">||</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">Rc</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_OPERATION</span><span class="p">;</span>

	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">IDI_SYNC_REQ_DMA_DESCRIPTOR_FREE</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_number</span>  <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_address</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pReq</span><span class="o">-&gt;</span><span class="n">xdi_dma_descriptor_operation</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">descriptor_magic</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)((</span><span class="n">ENTITY</span> <span class="o">*</span><span class="p">)</span><span class="n">pReq</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
