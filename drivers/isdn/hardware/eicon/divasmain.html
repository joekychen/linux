<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › hardware › eicon › divasmain.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>divasmain.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: divasmain.c,v 1.55.4.6 2005/02/09 19:28:20 armin Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Low level driver for Eicon DIVA Server ISDN cards.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2000-2003 by Armin Schindler (mac@melware.de)</span>
<span class="cm"> * Copyright 2000-2003 Cytronics &amp; Melware (info@melware.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &quot;platform.h&quot;</span>
<span class="cp">#undef ID_MASK</span>
<span class="cp">#undef N_DATA</span>
<span class="cp">#include &quot;pc.h&quot;</span>
<span class="cp">#include &quot;di_defs.h&quot;</span>
<span class="cp">#include &quot;divasync.h&quot;</span>
<span class="cp">#include &quot;diva.h&quot;</span>
<span class="cp">#include &quot;di.h&quot;</span>
<span class="cp">#include &quot;io.h&quot;</span>
<span class="cp">#include &quot;xdi_msg.h&quot;</span>
<span class="cp">#include &quot;xdi_adapter.h&quot;</span>
<span class="cp">#include &quot;xdi_vers.h&quot;</span>
<span class="cp">#include &quot;diva_dma.h&quot;</span>
<span class="cp">#include &quot;diva_pci.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">main_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.55.4.6 $&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">major</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dbgmask</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Kernel driver for Eicon DIVA Server cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Cytronics &amp; Melware, Eicon Networks&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dbgmask</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbgmask</span><span class="p">,</span> <span class="s">&quot;initial debug mask&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">DRIVERNAME</span> <span class="o">=</span>
	<span class="s">&quot;Eicon DIVA Server driver (http://www.melware.net)&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">DRIVERLNAME</span> <span class="o">=</span> <span class="s">&quot;divas&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">DEVNAME</span> <span class="o">=</span> <span class="s">&quot;Divas&quot;</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">DRIVERRELEASE_DIVAS</span> <span class="o">=</span> <span class="s">&quot;2.0&quot;</span><span class="p">;</span>

<span class="k">extern</span> <span class="n">irqreturn_t</span> <span class="n">diva_os_irq_wrapper</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">create_divas_proc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">remove_divas_proc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">diva_get_vserial_number</span><span class="p">(</span><span class="n">PISDN_ADAPTER</span> <span class="n">IoAdapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">divasfunc_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">dbgmask</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">divasfunc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_diva_os_thread_dpc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">divas_task</span><span class="p">;</span>
	<span class="n">diva_os_soft_isr_t</span> <span class="o">*</span><span class="n">psoft_isr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">diva_os_thread_dpc_t</span><span class="p">;</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   PCI driver interface section</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm">  vendor, device	Vendor and device ID to match (or PCI_ANY_ID)</span>
<span class="cm">  subvendor,	Subsystem vendor and device ID to match (or PCI_ANY_ID)</span>
<span class="cm">  subdevice</span>
<span class="cm">  class,		Device class to match. The class_mask tells which bits</span>
<span class="cm">  class_mask	of the class are honored during the comparison.</span>
<span class="cm">  driver_data	Data private to the driver.</span>
<span class="cm">*/</span>

<span class="cp">#if !defined(PCI_DEVICE_ID_EICON_MAESTRAP_2)</span>
<span class="cp">#define PCI_DEVICE_ID_EICON_MAESTRAP_2       0xE015</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(PCI_DEVICE_ID_EICON_4BRI_VOIP)</span>
<span class="cp">#define PCI_DEVICE_ID_EICON_4BRI_VOIP        0xE016</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(PCI_DEVICE_ID_EICON_4BRI_2_VOIP)</span>
<span class="cp">#define PCI_DEVICE_ID_EICON_4BRI_2_VOIP      0xE017</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(PCI_DEVICE_ID_EICON_BRI2M_2)</span>
<span class="cp">#define PCI_DEVICE_ID_EICON_BRI2M_2          0xE018</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(PCI_DEVICE_ID_EICON_MAESTRAP_2_VOIP)</span>
<span class="cp">#define PCI_DEVICE_ID_EICON_MAESTRAP_2_VOIP  0xE019</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(PCI_DEVICE_ID_EICON_2F)</span>
<span class="cp">#define PCI_DEVICE_ID_EICON_2F               0xE01A</span>
<span class="cp">#endif</span>

<span class="cp">#if !defined(PCI_DEVICE_ID_EICON_BRI2M_2_VOIP)</span>
<span class="cp">#define PCI_DEVICE_ID_EICON_BRI2M_2_VOIP     0xE01B</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">  This table should be sorted by PCI device ID</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">divas_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Diva Server BRI-2M PCI 0xE010 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_MAESTRA</span><span class="p">),</span>
	  <span class="n">CARDTYPE_MAESTRA_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server 4BRI-8M PCI 0xE012 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_MAESTRAQ</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_Q_8M_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server 4BRI-8M 2.0 PCI 0xE013 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_MAESTRAQ_U</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_Q_8M_V2_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server PRI-30M PCI 0xE014 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_MAESTRAP</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_P_30M_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server PRI 2.0 adapter 0xE015 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_MAESTRAP_2</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_P_30M_V2_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server Voice 4BRI-8M PCI 0xE016 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_4BRI_VOIP</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_VOICE_Q_8M_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server Voice 4BRI-8M 2.0 PCI 0xE017 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_4BRI_2_VOIP</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_VOICE_Q_8M_V2_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server BRI-2M 2.0 PCI 0xE018 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_BRI2M_2</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_B_2M_V2_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server Voice PRI 2.0 PCI 0xE019 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_MAESTRAP_2_VOIP</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_VOICE_P_30M_V2_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server 2FX 0xE01A */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_2F</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_B_2F_PCI</span> <span class="p">},</span>
	<span class="cm">/* Diva Server Voice BRI-2M 2.0 PCI 0xE01B */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EICON</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EICON_BRI2M_2_VOIP</span><span class="p">),</span>
	  <span class="n">CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>			<span class="cm">/* 0 terminated list. */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">divas_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">divas_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">divas_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">diva_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;divas&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">divas_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">divas_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">divas_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*********************************************************</span>
<span class="cm"> ** little helper functions</span>
<span class="cm"> *********************************************************/</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getrev</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">revision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>
		<span class="o">*--</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">diva_log_info</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">line</span><span class="p">[</span><span class="mi">160</span><span class="p">];</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="n">vsnprintf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">line</span><span class="p">),</span> <span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">divas_get_version</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmprev</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmprev</span><span class="p">,</span> <span class="n">main_revision</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s: %s(%s) %s(%s) major=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">DRIVERRELEASE_DIVAS</span><span class="p">,</span>
		<span class="n">getrev</span><span class="p">(</span><span class="n">tmprev</span><span class="p">),</span> <span class="n">diva_xdi_common_code_build</span><span class="p">,</span> <span class="n">DIVA_BUILD</span><span class="p">,</span> <span class="n">major</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   PCI Bus services</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="n">byte</span> <span class="nf">diva_os_get_pci_bus</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pci_dev_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_dev_handle</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">byte</span><span class="p">)</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">byte</span> <span class="nf">diva_os_get_pci_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pci_dev_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_dev_handle</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">byte</span><span class="p">)</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">divasa_get_pci_irq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">func</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">pci_dev_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_dev_handle</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">divasa_get_pci_bar</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bus</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">func</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">bar</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pci_dev_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_dev_handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bar</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">bar</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;GOT BAR[%d]=%08x&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">PCI_BASE_ADDRESS_SPACE_IO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;  I/O&quot;</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_IO_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;  memory&quot;</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">PCI_BASE_ADDRESS_MEM_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;  final=%08x&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">PCIwrite</span><span class="p">(</span><span class="n">byte</span> <span class="n">bus</span><span class="p">,</span> <span class="n">byte</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
	      <span class="kt">void</span> <span class="o">*</span><span class="n">pci_dev_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_dev_handle</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* byte */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* word */</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:		<span class="cm">/* dword */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				       <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>		<span class="cm">/* buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Copy as dword */</span>
			<span class="n">dword</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dword</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						       <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span>
						       <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* copy as byte stream */</span>
			<span class="n">byte</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						      <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
						      <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">PCIread</span><span class="p">(</span><span class="n">byte</span> <span class="n">bus</span><span class="p">,</span> <span class="n">byte</span> <span class="n">func</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
	     <span class="kt">void</span> <span class="o">*</span><span class="n">pci_dev_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_dev_handle</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* byte */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* word */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:		<span class="cm">/* dword */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>		<span class="cm">/* buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">length</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* Copy as dword */</span>
			<span class="n">dword</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dword</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span>
						      <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* copy as byte stream */</span>
			<span class="n">byte</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
						     <span class="n">p</span><span class="o">++</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Init map with DMA pages. It is not problem if some allocations fail -</span>
<span class="cm">  the channels that will not get one DMA page will use standard PIO</span>
<span class="cm">  interface</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">diva_pci_alloc_consistent</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">hwdev</span><span class="p">,</span>
				       <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
				       <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">dma_handle</span><span class="p">,</span>
				       <span class="kt">void</span> <span class="o">**</span><span class="n">addr_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">hwdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dma_handle</span><span class="p">);</span>

	<span class="o">*</span><span class="n">addr_handle</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">diva_init_dma_map</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">_diva_dma_map_entry</span> <span class="o">**</span><span class="n">ppmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nentries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_diva_dma_map_entry</span> <span class="o">*</span><span class="n">pmap</span> <span class="o">=</span>
		<span class="n">diva_alloc_dma_map</span><span class="p">(</span><span class="n">hdev</span><span class="p">,</span> <span class="n">nentries</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">addr_handle</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nentries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cpu_addr</span> <span class="o">=</span> <span class="n">diva_pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
								   <span class="n">PAGE_SIZE</span><span class="p">,</span>
								   <span class="o">&amp;</span><span class="n">dma_handle</span><span class="p">,</span>
								   <span class="o">&amp;</span><span class="n">addr_handle</span><span class="p">)))</span>
			<span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">diva_init_dma_map_entry</span><span class="p">(</span><span class="n">pmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cpu_addr</span><span class="p">,</span>
						<span class="p">(</span><span class="n">dword</span><span class="p">)</span> <span class="n">dma_handle</span><span class="p">,</span>
						<span class="n">addr_handle</span><span class="p">);</span>
			<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;dma map alloc [%d]=(%08lx:%08x:%08lx)&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cpu_addr</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">dword</span><span class="p">)</span> <span class="n">dma_handle</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr_handle</span><span class="p">))}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ppmap</span> <span class="o">=</span> <span class="n">pmap</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Free all contained in the map entries and memory used by the map</span>
<span class="cm">  Should be always called after adapter removal from DIDD array</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">diva_free_dma_map</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">_diva_dma_map_entry</span> <span class="o">*</span><span class="n">pmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dword</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cpu_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_handle</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr_handle</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">pmap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_get_dma_map_entry</span><span class="p">(</span><span class="n">pmap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpu_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phys_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">addr_handle</span> <span class="o">=</span> <span class="n">diva_get_entry_handle</span><span class="p">(</span><span class="n">pmap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">dma_handle</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="n">phys_addr</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">addr_handle</span><span class="p">,</span>
				    <span class="n">dma_handle</span><span class="p">);</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;dma map free [%d]=(%08lx:%08x:%08lx)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cpu_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">dword</span><span class="p">)</span> <span class="n">dma_handle</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr_handle</span><span class="p">))</span>
			<span class="p">}</span>

	<span class="n">diva_free_dma_mapping</span><span class="p">(</span><span class="n">pmap</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*********************************************************</span>
<span class="cm"> ** I/O port utilities</span>
<span class="cm"> *********************************************************/</span>

<span class="kt">int</span>
<span class="nf">diva_os_register_io_port</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DBG_ERR</span><span class="p">((</span><span class="s">&quot;A: I/O: can&#39;t register port=%08x&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
				<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">divasa_remap_pci_bar</span><span class="p">(</span><span class="n">diva_os_xdi_adapter_t</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">area_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="n">area_length</span><span class="p">);</span>
	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;remap(%08x)-&gt;%p&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">divasa_unmap_pci_bar</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">bar</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*********************************************************</span>
<span class="cm"> ** I/O port access</span>
<span class="cm"> *********************************************************/</span>
<span class="n">byte</span> <span class="n">__inline__</span> <span class="nf">inpp</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">word</span> <span class="n">__inline__</span> <span class="nf">inppw</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__inline__</span> <span class="nf">inppw_buffer</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">insw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span> <span class="o">*</span><span class="p">)</span> <span class="n">P</span><span class="p">,</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__inline__</span> <span class="nf">outppw_buffer</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">P</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outsw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span> <span class="o">*</span><span class="p">)</span> <span class="n">P</span><span class="p">,</span> <span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__inline__</span> <span class="nf">outppw</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">word</span> <span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__inline__</span> <span class="nf">outpp</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">word</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   IRQ request / remove</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="kt">int</span> <span class="nf">diva_os_register_irq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">byte</span> <span class="n">irq</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">diva_os_irq_wrapper</span><span class="p">,</span>
				 <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">diva_os_remove_irq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">byte</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   DPC framework implementation</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">diva_os_dpc_proc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="n">psoft_isr</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">diva_os_soft_isr_t</span> <span class="o">*</span><span class="n">pisr</span> <span class="o">=</span> <span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">psoft_isr</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pisr</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">))</span> <span class="p">(</span><span class="n">pisr</span><span class="p">,</span> <span class="n">pisr</span><span class="o">-&gt;</span><span class="n">callback_context</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">diva_os_initialize_soft_isr</span><span class="p">(</span><span class="n">diva_os_soft_isr_t</span> <span class="o">*</span><span class="n">psoft_isr</span><span class="p">,</span>
				<span class="n">diva_os_soft_isr_callback_t</span> <span class="n">callback</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">callback_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="n">pdpc</span><span class="p">;</span>

	<span class="n">pdpc</span> <span class="o">=</span> <span class="p">(</span><span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">diva_os_malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdpc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">=</span> <span class="n">pdpc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pdpc</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pdpc</span><span class="p">));</span>
	<span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">callback_context</span> <span class="o">=</span> <span class="n">callback_context</span><span class="p">;</span>
	<span class="n">pdpc</span><span class="o">-&gt;</span><span class="n">psoft_isr</span> <span class="o">=</span> <span class="n">psoft_isr</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpc</span><span class="o">-&gt;</span><span class="n">divas_task</span><span class="p">,</span> <span class="n">diva_os_dpc_proc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pdpc</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">diva_os_schedule_soft_isr</span><span class="p">(</span><span class="n">diva_os_soft_isr_t</span> <span class="o">*</span><span class="n">psoft_isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psoft_isr</span> <span class="o">&amp;&amp;</span> <span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="n">pdpc</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>

		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpc</span><span class="o">-&gt;</span><span class="n">divas_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">diva_os_cancel_soft_isr</span><span class="p">(</span><span class="n">diva_os_soft_isr_t</span> <span class="o">*</span><span class="n">psoft_isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">diva_os_remove_soft_isr</span><span class="p">(</span><span class="n">diva_os_soft_isr_t</span> <span class="o">*</span><span class="n">psoft_isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psoft_isr</span> <span class="o">&amp;&amp;</span> <span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="n">pdpc</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">diva_os_thread_dpc_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdpc</span><span class="o">-&gt;</span><span class="n">divas_task</span><span class="p">);</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">object</span><span class="p">;</span>
		<span class="n">psoft_isr</span><span class="o">-&gt;</span><span class="n">object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">diva_os_free</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mem</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kernel/user space copy functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xdi_copy_to_user</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">os_handle</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xdi_copy_from_user</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">os_handle</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EFAULT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * device node operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">divas_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">divas_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_xdi_close_adapter</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">divas_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">diva_xdi_open_adapter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
							   <span class="n">count</span><span class="p">,</span>
							   <span class="n">xdi_copy_from_user</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">diva_xdi_write</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
			     <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">xdi_copy_from_user</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:		<span class="cm">/* Message should be removed from rx mailbox first */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:		<span class="cm">/* invalid adapter was specified in this call */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">3</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;write: ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">divas_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">diva_xdi_open_adapter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
							   <span class="n">count</span><span class="p">,</span>
							   <span class="n">xdi_copy_from_user</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ENODEV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">diva_xdi_read</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
			    <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">xdi_copy_to_user</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:		<span class="cm">/* RX mailbox is empty */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">2</span>:		<span class="cm">/* no memory, mailbox was cleared, last command is failed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">3</span>:		<span class="cm">/* can&#39;t copy to user, retry */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;read: ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">divas_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">POLLERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">divas_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">divas_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>   <span class="o">=</span> <span class="n">divas_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>    <span class="o">=</span> <span class="n">divas_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">divas_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">divas_release</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">divas_unregister_chrdev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_chrdev</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">DEVNAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">divas_register_chrdev</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">major</span> <span class="o">=</span> <span class="n">register_chrdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DEVNAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">divas_fops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to create /dev entry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVERLNAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   PCI driver section</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">divas_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pdiva</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_latency</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_latency</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;%s bus: %08x fn: %08x insertion.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">CardProperties</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">Name</span><span class="p">,</span>
		 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s bus: %08x fn: %08x insertion.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">CardProperties</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">Name</span><span class="p">,</span>
		       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;%s: %s bus: %08x fn: %08x device init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">DRIVERLNAME</span><span class="p">,</span>
			 <span class="n">CardProperties</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">Name</span><span class="p">,</span>
			 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: %s bus: %08x fn: %08x device init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">DRIVERLNAME</span><span class="p">,</span>
			       <span class="n">CardProperties</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span>
			       <span class="n">Name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_latency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_latency</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;%s: bus: %08x fn: %08x fix latency.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;%s: bus: %08x fn: %08x fix latency.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">new_latency</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pdiva</span> <span class="o">=</span> <span class="n">diva_driver_add_card</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;%s: %s bus: %08x fn: %08x card init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">DRIVERLNAME</span><span class="p">,</span>
			 <span class="n">CardProperties</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">Name</span><span class="p">,</span>
			 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: %s bus: %08x fn: %08x card init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">DRIVERLNAME</span><span class="p">,</span>
			       <span class="n">CardProperties</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span>
			       <span class="n">Name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pdiva</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">divas_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pdiva</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">DBG_TRC</span><span class="p">((</span><span class="s">&quot;bus: %08x fn: %08x removal.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: bus: %08x fn: %08x removal.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdiva</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">diva_driver_remove_card</span><span class="p">(</span><span class="n">pdiva</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Driver Load / Startup</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">divas_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmprev</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVERNAME</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Rel:%s  Rev:&quot;</span><span class="p">,</span> <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">DRIVERRELEASE_DIVAS</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">tmprev</span><span class="p">,</span> <span class="n">main_revision</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s  Build: %s(%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">getrev</span><span class="p">(</span><span class="n">tmprev</span><span class="p">),</span>
	       <span class="n">diva_xdi_common_code_build</span><span class="p">,</span> <span class="n">DIVA_BUILD</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: support for: &quot;</span><span class="p">,</span> <span class="n">DRIVERLNAME</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_DIVAS_BRIPCI</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BRI/PCI &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ISDN_DIVAS_PRIPCI</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;PRI/PCI &quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;adapters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">divasfunc_init</span><span class="p">(</span><span class="n">dbgmask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to connect to DIDD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVERLNAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">divas_register_chrdev</span><span class="p">())</span> <span class="p">{</span>
<span class="cp">#ifdef MODULE</span>
		<span class="n">divasfunc_exit</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">create_divas_proc</span><span class="p">())</span> <span class="p">{</span>
<span class="cp">#ifdef MODULE</span>
		<span class="n">divas_unregister_chrdev</span><span class="p">();</span>
		<span class="n">divasfunc_exit</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to create proc entry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVERLNAME</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diva_pci_driver</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef MODULE</span>
		<span class="n">remove_divas_proc</span><span class="p">();</span>
		<span class="n">divas_unregister_chrdev</span><span class="p">();</span>
		<span class="n">divasfunc_exit</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: failed to init pci driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">DRIVERLNAME</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: started with major %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVERLNAME</span><span class="p">,</span> <span class="n">major</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm">   Driver Unload</span>
<span class="cm">   -------------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">divas_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diva_pci_driver</span><span class="p">);</span>
	<span class="n">remove_divas_proc</span><span class="p">();</span>
	<span class="n">divas_unregister_chrdev</span><span class="p">();</span>
	<span class="n">divasfunc_exit</span><span class="p">();</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: module unloaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVERLNAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">divas_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">divas_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
