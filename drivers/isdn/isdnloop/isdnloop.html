<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › isdnloop › isdnloop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isdnloop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: isdnloop.c,v 1.11.6.7 2001/11/11 19:54:31 kai Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * ISDN low-level module implementing a dummy loop driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1997 by Fritz Elfert (fritz@isdn4linux.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &quot;isdnloop.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.11.6.7 $&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isdnloop_id</span> <span class="o">=</span> <span class="s">&quot;loop0&quot;</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ISDN4Linux: Pseudo Driver that simulates an ISDN card&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Fritz Elfert&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">isdnloop_id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">isdnloop_id</span><span class="p">,</span> <span class="s">&quot;ID-String of first card&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">isdnloop_addcard</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Free queue completely.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card    = pointer to card struct</span>
<span class="cm"> *   channel = channel number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_free_queue</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send B-Channel data to another virtual card.</span>
<span class="cm"> * This routine is called via timer-callback from isdnloop_pollbchan().</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> *   ch   = channel number (0-based)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_bchan_send</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">rcard</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rch</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span><span class="p">],</span> <span class="n">len</span><span class="p">,</span> <span class="n">ack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bqueue</span><span class="p">[</span><span class="n">ch</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">ack</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span> <span class="cm">/* used as scratch area */</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rcard</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rcard</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">rcvcallb_skb</span><span class="p">(</span><span class="n">rcard</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="n">rch</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdnloop: no rcard, skb dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="p">};</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BSENT</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send/Receive Data to/from the B-Channel.</span>
<span class="cm"> * This routine is called via timer-callback.</span>
<span class="cm"> * It schedules itself while any B-Channel is open.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   data = pointer to card struct, set by kernel timer.data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_pollbchan</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_B1ACTIVE</span><span class="p">)</span>
		<span class="n">isdnloop_bchan_send</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_B2ACTIVE</span><span class="p">)</span>
		<span class="n">isdnloop_bchan_send</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISDNLOOP_FLAGS_B1ACTIVE</span> <span class="o">|</span> <span class="n">ISDNLOOP_FLAGS_B2ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* schedule b-channel polling again */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISDNLOOP_TIMER_BCREAD</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDNLOOP_FLAGS_RBTIMER</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDNLOOP_FLAGS_RBTIMER</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse ICN-type setup string and fill fields of setup-struct</span>
<span class="cm"> * with parsed data.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   setup = setup string, format: [caller-id],si1,si2,[called-id]</span>
<span class="cm"> *   cmd   = pointer to struct to be filled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_parse_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">setup</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">setup</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">));</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
	<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span>
			<span class="n">simple_strtoul</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">isdnloop_stat</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">statstr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span> <span class="n">isdnloop_stat</span><span class="p">;</span>
<span class="cm">/* *INDENT-OFF* */</span>
<span class="k">static</span> <span class="n">isdnloop_stat</span> <span class="n">isdnloop_stat_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;BCON_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_BCONN</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="cm">/* B-Channel connected        */</span>
	<span class="p">{</span><span class="s">&quot;BDIS_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span> <span class="cm">/* B-Channel disconnected     */</span>
	<span class="p">{</span><span class="s">&quot;DCON_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_DCONN</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="cm">/* D-Channel connected        */</span>
	<span class="p">{</span><span class="s">&quot;DDIS_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_DHUP</span><span class="p">,</span>  <span class="mi">0</span><span class="p">},</span> <span class="cm">/* D-Channel disconnected     */</span>
	<span class="p">{</span><span class="s">&quot;DCAL_I&quot;</span><span class="p">,</span>         <span class="n">ISDN_STAT_ICALL</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="cm">/* Incoming call dialup-line  */</span>
	<span class="p">{</span><span class="s">&quot;DSCA_I&quot;</span><span class="p">,</span>         <span class="n">ISDN_STAT_ICALL</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="cm">/* Incoming call 1TR6-SPV     */</span>
	<span class="p">{</span><span class="s">&quot;FCALL&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_ICALL</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span> <span class="cm">/* Leased line connection up  */</span>
	<span class="p">{</span><span class="s">&quot;CIF&quot;</span><span class="p">,</span>            <span class="n">ISDN_STAT_CINF</span><span class="p">,</span>  <span class="mi">5</span><span class="p">},</span> <span class="cm">/* Charge-info, 1TR6-type     */</span>
	<span class="p">{</span><span class="s">&quot;AOC&quot;</span><span class="p">,</span>            <span class="n">ISDN_STAT_CINF</span><span class="p">,</span>  <span class="mi">6</span><span class="p">},</span> <span class="cm">/* Charge-info, DSS1-type     */</span>
	<span class="p">{</span><span class="s">&quot;CAU&quot;</span><span class="p">,</span>            <span class="n">ISDN_STAT_CAUSE</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span> <span class="cm">/* Cause code                 */</span>
	<span class="p">{</span><span class="s">&quot;TEI OK&quot;</span><span class="p">,</span>         <span class="n">ISDN_STAT_RUN</span><span class="p">,</span>   <span class="mi">0</span><span class="p">},</span> <span class="cm">/* Card connected to wallplug */</span>
	<span class="p">{</span><span class="s">&quot;E_L1: ACT FAIL&quot;</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span> <span class="cm">/* Layer-1 activation failed  */</span>
	<span class="p">{</span><span class="s">&quot;E_L2: DATA LIN&quot;</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span> <span class="cm">/* Layer-2 data link lost     */</span>
	<span class="p">{</span><span class="s">&quot;E_L1: ACTIVATION FAILED&quot;</span><span class="p">,</span>
	 <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>         <span class="cm">/* Layer-1 activation failed  */</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>
<span class="cm">/* *INDENT-ON* */</span>


<span class="cm">/*</span>
<span class="cm"> * Parse Status message-strings from virtual card.</span>
<span class="cm"> * Depending on status, call statcallb for sending messages to upper</span>
<span class="cm"> * levels. Also set/reset B-Channel active-flags.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   status  = status string to parse.</span>
<span class="cm"> *   channel = channel where message comes from.</span>
<span class="cm"> *   card    = card where message comes from.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_parse_status</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_stat</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">isdnloop_stat_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
			<span class="n">action</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* BCON_x */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">ISDNLOOP_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ISDNLOOP_FLAGS_B1ACTIVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* BDIS_x */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">ISDNLOOP_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ISDNLOOP_FLAGS_B1ACTIVE</span><span class="p">);</span>
		<span class="n">isdnloop_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* DCAL_I and DSCA_I */</span>
		<span class="n">isdnloop_parse_setup</span><span class="p">(</span><span class="n">status</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* FCALL */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="s">&quot;LEASED%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* CIF */</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">status</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="cm">/* AOC */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">),</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">status</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="cm">/* CAU */</span>
		<span class="n">status</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">),</span> <span class="s">&quot;%s%c%c&quot;</span><span class="p">,</span>
				 <span class="n">status</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">status</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">status</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="cm">/* Misc Errors on L1 and L2 */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDNLOOP_FLAGS_B1ACTIVE</span><span class="p">;</span>
		<span class="n">isdnloop_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDNLOOP_FLAGS_B2ACTIVE</span><span class="p">;</span>
		<span class="n">isdnloop_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Store a cwcharacter into ringbuffer for reading from /dev/isdnctrl</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> *   c    = char to store.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_putmsg</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;\n&#39;</span> <span class="o">:</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Poll a virtual cards message queue.</span>
<span class="cm"> * If there are new status-replies from the card, copy them to</span>
<span class="cm"> * ringbuffer for reading on /dev/isdnctrl and call</span>
<span class="cm"> * isdnloop_parse_status() for processing them. Watch for special</span>
<span class="cm"> * Firmware bootmessage and parse it, to get the D-Channel protocol.</span>
<span class="cm"> * If there are B-Channels open, initiate a timer-callback to</span>
<span class="cm"> * isdnloop_pollbchan().</span>
<span class="cm"> * This routine is called periodically via timer interrupt.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   data = pointer to card struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_polldchan</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">avail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dqueue</span><span class="p">)))</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="n">avail</span><span class="p">;</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">isdnloop_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span> <span class="o">&lt;</span> <span class="mi">59</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">avail</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdnloop_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;2&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
				<span class="n">isdnloop_parse_status</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;DRV1.&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdnloop: (%s) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CID</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;TC&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ISDN_PTYPE_1TR6</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ISDN_FEATURE_P_1TR6</span><span class="p">;</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
						       <span class="s">&quot;isdnloop: (%s) 1TR6-Protocol loaded and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CID</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;EC&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ISDN_FEATURE_P_EURO</span><span class="p">;</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
						       <span class="s">&quot;isdnloop: (%s) Euro-Protocol loaded and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CID</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STAVAIL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">avail</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISDNLOOP_FLAGS_B1ACTIVE</span> <span class="o">|</span> <span class="n">ISDNLOOP_FLAGS_B2ACTIVE</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RBTIMER</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* schedule b-channel polling */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDNLOOP_FLAGS_RBTIMER</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">isdnloop_pollbchan</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISDNLOOP_TIMER_BCREAD</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="cm">/* schedule again */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISDNLOOP_TIMER_DCREAD</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Append a packet to the transmit buffer-queue.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   channel = Number of B-channel</span>
<span class="cm"> *   skb     = packet to send.</span>
<span class="cm"> *   card    = pointer to card-struct</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   Number of bytes transferred, -E??? on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_sendbuf</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;isdnloop: Send packet too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span> <span class="n">ISDNLOOP_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ISDNLOOP_FLAGS_B1ACTIVE</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ISDNLOOP_MAX_SQUEUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						  <span class="n">skb_put</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">nskb</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the messages from the card&#39;s ringbuffer</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   buf  = pointer to buffer.</span>
<span class="cm"> *   len  = number of bytes to read.</span>
<span class="cm"> *   user = flag, 1: called from userlevel 0: called from kernel.</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   number of bytes actually transferred.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_readstatus</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Simulate a card&#39;s response by appending it to the cards</span>
<span class="cm"> * message queue.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> *   s    = pointer to message-string.</span>
<span class="cm"> *   ch   = channel: 0 = generic messages, 1 and 2 = D-channel messages.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   0 on success, 1 on memory squeeze.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_fake</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdnloop: Out of memory in isdnloop_fake</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s">&quot;%02d;&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span> <span class="n">s</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* *INDENT-OFF* */</span>
<span class="k">static</span> <span class="n">isdnloop_stat</span> <span class="n">isdnloop_cmd_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;BCON_R&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* B-Channel connect        */</span>
	<span class="p">{</span><span class="s">&quot;BCON_I&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span> <span class="mi">17</span><span class="p">},</span>	<span class="cm">/* B-Channel connect ind    */</span>
	<span class="p">{</span><span class="s">&quot;BDIS_R&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span>	<span class="cm">/* B-Channel disconnect     */</span>
	<span class="p">{</span><span class="s">&quot;DDIS_R&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">},</span>	<span class="cm">/* D-Channel disconnect     */</span>
	<span class="p">{</span><span class="s">&quot;DCON_R&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span>	<span class="cm">/* D-Channel connect        */</span>
	<span class="p">{</span><span class="s">&quot;DSCA_R&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>  <span class="mi">4</span><span class="p">},</span>	<span class="cm">/* Dial 1TR6-SPV     */</span>
	<span class="p">{</span><span class="s">&quot;DCAL_R&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>  <span class="mi">5</span><span class="p">},</span>	<span class="cm">/* Dial */</span>
	<span class="p">{</span><span class="s">&quot;EAZC&quot;</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span>  <span class="mi">6</span><span class="p">},</span>	<span class="cm">/* Clear EAZ listener */</span>
	<span class="p">{</span><span class="s">&quot;EAZ&quot;</span><span class="p">,</span>            <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span><span class="p">},</span>	<span class="cm">/* Set EAZ listener */</span>
	<span class="p">{</span><span class="s">&quot;SEEAZ&quot;</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>	<span class="cm">/* Get EAZ listener */</span>
	<span class="p">{</span><span class="s">&quot;MSN&quot;</span><span class="p">,</span>            <span class="mi">0</span><span class="p">,</span>  <span class="mi">9</span><span class="p">},</span>	<span class="cm">/* Set/Clear MSN listener */</span>
	<span class="p">{</span><span class="s">&quot;MSALL&quot;</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>	<span class="cm">/* Set multi MSN listeners */</span>
	<span class="p">{</span><span class="s">&quot;SETSIL&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span>	<span class="cm">/* Set SI list     */</span>
	<span class="p">{</span><span class="s">&quot;SEESIL&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">},</span>	<span class="cm">/* Get SI list     */</span>
	<span class="p">{</span><span class="s">&quot;SILC&quot;</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">},</span>	<span class="cm">/* Clear SI list     */</span>
	<span class="p">{</span><span class="s">&quot;LOCK&quot;</span><span class="p">,</span>           <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* LOCK channel     */</span>
	<span class="p">{</span><span class="s">&quot;UNLOCK&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>	<span class="cm">/* UNLOCK channel     */</span>
	<span class="p">{</span><span class="s">&quot;FV2ON&quot;</span><span class="p">,</span>          <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">},</span>	<span class="cm">/* Leased mode on               */</span>
	<span class="p">{</span><span class="s">&quot;FV2OFF&quot;</span><span class="p">,</span>         <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">},</span>	<span class="cm">/* Leased mode off              */</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>
<span class="cm">/* *INDENT-ON* */</span>


<span class="cm">/*</span>
<span class="cm"> * Simulate an error-response from a card.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_fake_err</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;E%s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">omsg</span><span class="p">);</span>
	<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;NAK&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">ctable_eu</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">};</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">ctable_1t</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Assemble a simplified cause message depending on the</span>
<span class="cm"> * D-channel protocol used.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> *   loc  = location: 0 = local, 1 = remote.</span>
<span class="cm"> *   cau  = cause: 1 = busy, 2 = nonexistent callerid, 3 = no user responding.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   Pointer to buffer containing the assembled message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">isdnloop_unicause</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cau</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_PTYPE_EURO</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;E%02X%02X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ctable_eu</span><span class="p">[</span><span class="n">cau</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PTYPE_1TR6</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%02X44&quot;</span><span class="p">,</span> <span class="n">ctable_1t</span><span class="p">[</span><span class="n">cau</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="p">(</span><span class="s">&quot;0000&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release a virtual connection. Called from timer interrupt, when</span>
<span class="cm"> * called party did not respond.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> *   ch   = channel (0-based)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_atimeout</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span><span class="p">],</span> <span class="s">&quot;DDIS_I&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;DDIS_I&quot;</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* No user responding */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;CAU%s&quot;</span><span class="p">,</span> <span class="n">isdnloop_unicause</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrapper for isdnloop_atimeout().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_atimeout0</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">isdnloop_atimeout</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrapper for isdnloop_atimeout().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_atimeout1</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">isdnloop_atimeout</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Install a watchdog for a user, not responding.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> *   ch   = channel to watch for.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_start_ctimer</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISDNLOOP_TIMER_ALERTWAIT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="n">isdnloop_atimeout1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">function</span> <span class="o">=</span> <span class="n">isdnloop_atimeout0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Kill a pending channel watchdog.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> *   ch   = channel (0-based).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_kill_ctimer</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="n">ch</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">si2bit</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">bit2si</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Try finding a listener for an outgoing call.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to calling card.</span>
<span class="cm"> *   p    = pointer to ICN-type setup-string.</span>
<span class="cm"> *   lch  = channel of calling card.</span>
<span class="cm"> *   cmd  = pointer to struct to be filled when parsing setup.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   0 = found match, alerting should happen.</span>
<span class="cm"> *   1 = found matching number but it is busy.</span>
<span class="cm"> *   2 = no matching listener.</span>
<span class="cm"> *   3 = found matching number but SI does not match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_try_call</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lch</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">cc</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_match</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">isdnloop_parse_setup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Exclude ourself */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cc</span> <span class="o">==</span> <span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">lch</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">num_match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ISDN_PTYPE_EURO</span>:
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">)))</span>
						<span class="n">num_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ISDN_PTYPE_1TR6</span>:
				<span class="n">e</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">eazlist</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">nbuf</span><span class="p">,</span> <span class="s">&quot;%s%c&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">*</span><span class="n">e</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">nbuf</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">)))</span>
						<span class="n">num_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">e</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">num_match</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="cm">/* channel idle? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span><span class="p">]))</span> <span class="p">{</span>
					<span class="cm">/* Check SI */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">si2bit</span><span class="p">[</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="n">ch</span><span class="p">]))</span> <span class="p">{</span>
						<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* ch is idle, si and number matches */</span>
					<span class="n">cc</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
					<span class="n">cc</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">lch</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">lch</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">lch</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="cm">/* num matches, but busy */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Depending on D-channel protocol and caller/called, modify</span>
<span class="cm"> * phone number.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card   = pointer to card struct.</span>
<span class="cm"> *   phone  = pointer phone number.</span>
<span class="cm"> *   caller = flag: 1 = caller, 0 = called.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   pointer to new phone number.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">isdnloop_vstphone</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phone</span><span class="p">,</span> <span class="kt">int</span> <span class="n">caller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">nphone</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUG!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_PTYPE_EURO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">caller</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">phone</span><span class="p">)))</span>
					<span class="k">return</span> <span class="p">(</span><span class="n">phone</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">phone</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PTYPE_1TR6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">caller</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">nphone</span><span class="p">,</span> <span class="s">&quot;%s%c&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phone</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">nphone</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">phone</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse an ICN-type command string sent to the &#39;card&#39;.</span>
<span class="cm"> * Perform misc. actions depending on the command.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_parse_cmd</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">omsg</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="n">isdnloop_stat</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">isdnloop_cmd_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">omsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">omsg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;;&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">isdnloop_fake_err</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">omsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">isdnloop_fake_err</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">action</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isdnloop_fake_err</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* 0x;BCON_R */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s">&quot;BCON_I&quot;</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;BCON_C&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">17</span>:
		<span class="cm">/* 0x;BCON_I */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s">&quot;BCON_C&quot;</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* 0x;BDIS_R */</span>
		<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;BDIS_C&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s">&quot;BDIS_I&quot;</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="cm">/* 0x;DCON_R */</span>
		<span class="n">isdnloop_kill_ctimer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">isdnloop_kill_ctimer</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s">&quot;DCON_C&quot;</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;DCON_C&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* 0x;DDIS_R */</span>
		<span class="n">isdnloop_kill_ctimer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">isdnloop_kill_ctimer</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="s">&quot;DDIS_I&quot;</span><span class="p">,</span>
				      <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;DDIS_C&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* 0x;DSCA_Rdd,yy,zz,oo */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">!=</span> <span class="n">ISDN_PTYPE_1TR6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdnloop_fake_err</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* 0x;DCAL_Rdd,yy,zz,oo */</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isdnloop_try_call</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* Alerting */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;D%s_I%s,%02d,%02d,%s&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SCA&quot;</span> <span class="o">:</span> <span class="s">&quot;CAL&quot;</span><span class="p">,</span>
				<span class="n">isdnloop_vstphone</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span><span class="p">,</span>
				<span class="n">isdnloop_vstphone</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
						  <span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcard</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rch</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="cm">/* si1 does not match, don&#39;t alert but start timer */</span>
			<span class="n">isdnloop_start_ctimer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* Remote busy */</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;DDIS_I&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;CAU%s&quot;</span><span class="p">,</span> <span class="n">isdnloop_unicause</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* No such user */</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;DDIS_I&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;CAU%s&quot;</span><span class="p">,</span> <span class="n">isdnloop_unicause</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="cm">/* 0x;EAZC */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">eazlist</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="cm">/* 0x;EAZ */</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">eazlist</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="cm">/* 0x;SEEAZ */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;EAZ-LIST: %s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">eazlist</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="cm">/* 0x;MSN */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="cm">/* 0x;MSNALL */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="cm">/* 0x;SETSIL */</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="s">&quot;0157&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">si2bit</span><span class="p">[</span><span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">];</span>
			<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
			<span class="n">isdnloop_fake_err</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="cm">/* 0x;SEESIL */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;SIN-LIST: &quot;</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%02d&quot;</span><span class="p">,</span> <span class="n">bit2si</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="cm">/* 0x;SILC */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="n">ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="cm">/* 00;FV2ON */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="cm">/* 00;FV2OFF */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Put command-strings into the of the &#39;card&#39;. In reality, execute them</span>
<span class="cm"> * right in place by calling isdnloop_parse_cmd(). Also copy every</span>
<span class="cm"> * command to the read message ringbuffer, preceding it with a &#39;&gt;&#39;.</span>
<span class="cm"> * These mesagges can be read at /dev/isdnctrl.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   buf  = pointer to command buffer.</span>
<span class="cm"> *   len  = length of buffer data.</span>
<span class="cm"> *   user = flag: 1 = called form userlevel, 0 called from kernel.</span>
<span class="cm"> *   card = pointer to card struct.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   number of bytes transferred (currently always equals len).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_writecmd</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">,</span> <span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ocount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">u_char</span> <span class="n">msg</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">isdnloop_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="n">xcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdnloop_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">omsg</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">optr</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">omsg</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">optr</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">optr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">isdnloop_parse_cmd</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">isdnloop_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
					<span class="n">ocount</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">optr</span> <span class="o">&lt;</span> <span class="mi">59</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">optr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ocount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STAVAIL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">ocount</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xcount</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delete card&#39;s pending timers, send STOP to linklevel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_stopcard</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">c_timer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STOP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop all cards before unload.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdnloop_stopallcards</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdnloop_stopcard</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start a &#39;card&#39;. Simulate card&#39;s boot message and set the phone</span>
<span class="cm"> * number(s) of the virtual &#39;S0-Interface&#39;. Install D-channel</span>
<span class="cm"> * poll timer.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card  = pointer to card struct.</span>
<span class="cm"> *   sdefp = pointer to struct holding ioctl parameters.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   0 on success, -E??? otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_start</span><span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">isdnloop_sdef</span> <span class="o">*</span><span class="n">sdefp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">isdnloop_sdef</span> <span class="n">sdef</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sdef</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sdefp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sdef</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sdef</span><span class="p">.</span><span class="n">ptype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_PTYPE_EURO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;DRV1.23EC-Q.931-CAPI-CNS-BASIS-20.02.96&quot;</span><span class="p">,</span>
				  <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;TEI OK&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sdef</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PTYPE_1TR6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;DRV1.04TC-1TR6-CAPI-CNS-BASIS-29.11.95&quot;</span><span class="p">,</span>
				  <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sil</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdnloop_fake</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;TEI OK&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sdef</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">s0num</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdnloop: Illegal D-channel protocol %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sdef</span><span class="p">.</span><span class="n">ptype</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISDNLOOP_TIMER_DCREAD</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">isdnloop_polldchan</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Main handler for commands sent by linklevel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_command</span><span class="p">(</span><span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cbuf</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">isdnloop_cdef</span> <span class="n">cdef</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_IOCTL</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ulong</span><span class="p">));</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDNLOOP_IOCTL_DEBUGVAR</span>:
			<span class="k">return</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDNLOOP_IOCTL_STARTUP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">isdnloop_sdef</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_start</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="n">isdnloop_sdef</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDNLOOP_IOCTL_ADDCARD</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cdef</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">cdef</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_addcard</span><span class="p">(</span><span class="n">cdef</span><span class="p">.</span><span class="n">id1</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDNLOOP_IOCTL_LEASEDCFG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_UNKNOWN</span><span class="p">)</span>
						<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;00;FV2ON</span><span class="se">\n</span><span class="s">01;EAZ1</span><span class="se">\n</span><span class="s">02;EAZ2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;isdnloop: (%s) Leased-line mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">CID</span><span class="p">);</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_RUN</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;00;FV2OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;isdnloop: (%s) Leased-line mode disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">CID</span><span class="p">);</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_RUN</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_DIAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">dial</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
			<span class="kt">char</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Dial for SPV */</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">dcode</span><span class="p">,</span> <span class="s">&quot;SCA&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="cm">/* Normal Dial */</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">dcode</span><span class="p">,</span> <span class="s">&quot;CAL&quot;</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">dial</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;D%s_R%s,%02d,%02d,%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">dcode</span><span class="p">,</span> <span class="n">dial</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_ACCEPTD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX75</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X25DTE</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX2T</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X25DCE</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX2C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BTRA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">))</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;DCON_R</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_ACCEPTB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R,BX75</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X25DTE</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R,BX2T</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X25DCE</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R,BX2C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R,BTRA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdnloop writecmd &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cbuf</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CMD_HANGUP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BDIS_R</span><span class="se">\n</span><span class="s">%02d;DDIS_R</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CMD_SETEAZ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;MS%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span>
						<span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;N&quot;</span> <span class="o">:</span> <span class="s">&quot;ALL&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;EAZ%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span>
						<span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span> <span class="o">:</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="s">&quot;0123456789&quot;</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CMD_CLREAZ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;MSNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;EAZC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CMD_SETL2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX75</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X25DTE</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX2T</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X25DCE</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX2C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BTRA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_TRANS</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BTRA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_CMD_SETL3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find card with given driverId</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">isdnloop_card</span> <span class="o">*</span>
<span class="nf">isdnloop_findcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">driverid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">myid</span> <span class="o">==</span> <span class="n">driverid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrapper functions for interface to linklevel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_command</span><span class="p">(</span><span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">isdnloop_findcard</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_command</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;isdnloop: if_command called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_writecmd</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">isdnloop_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_writecmd</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;isdnloop: if_writecmd called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_readstatus</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">isdnloop_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_readstatus</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;isdnloop: if_readstatus called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_sendbuf</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ack</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">isdnloop_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDNLOOP_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="cm">/* ack request stored in skb scratch area */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="o">=</span> <span class="n">ack</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_sendbuf</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;isdnloop: if_sendbuf called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a new card-struct, initialize it</span>
<span class="cm"> * link it into cards-list and register it at linklevel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">isdnloop_card</span> <span class="o">*</span>
<span class="nf">isdnloop_initcard</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">isdnloop_card</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;isdnloop: (%s) Could not allocate card-struct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ISDNLOOP_BCH</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">hl_hdrlen</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* scratch area for storing ack flag*/</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">maxbufsize</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">if_command</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">writebuf_skb</span> <span class="o">=</span> <span class="n">if_sendbuf</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">writecmd</span> <span class="o">=</span> <span class="n">if_writecmd</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">readstat</span> <span class="o">=</span> <span class="n">if_readstatus</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">ISDN_FEATURE_L2_X75I</span> <span class="o">|</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
		<span class="n">ISDN_FEATURE_L2_X25DTE</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L2_X25DCE</span> <span class="o">|</span>
<span class="cp">#endif</span>
		<span class="n">ISDN_FEATURE_L2_HDLC</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L3_TRANS</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_P_UNKNOWN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ISDN_PTYPE_UNKNOWN</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bqueue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dqueue</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">isdnloop_lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>
	<span class="n">cards</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_isdn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cards</span> <span class="o">=</span> <span class="n">cards</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;isdnloop: Unable to register %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_card</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">card</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdnloop_addcard</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">id1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="n">isdnloop_initcard</span><span class="p">(</span><span class="n">id1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;isdnloop: (%s) virtual card added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">isdnloop_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rev</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="s">&quot; ??? &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;isdnloop-ISDN-driver Rev%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdnloop_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdnloop_addcard</span><span class="p">(</span><span class="n">isdnloop_id</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">isdnloop_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>
	<span class="n">isdnloop_card</span> <span class="o">*</span><span class="n">last</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">isdnloop_stopallcards</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_UNLOAD</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDNLOOP_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">isdnloop_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dqueue</span><span class="p">);</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;isdnloop-ISDN-driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">isdnloop_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">isdnloop_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
