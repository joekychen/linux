<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › icn › icn.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>icn.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: icn.c,v 1.65.6.8 2001/09/23 22:24:55 kai Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * ISDN low-level module for the ICN active ISDN-Card.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1994,95,96 by Fritz Elfert (fritz@isdn4linux.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;icn.h&quot;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">portbase</span> <span class="o">=</span> <span class="n">ICN_BASEADDR</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">membase</span> <span class="o">=</span> <span class="n">ICN_MEMADDR</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">icn_id</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">icn_id2</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ISDN4Linux: Driver for ICN active ISDN card&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Fritz Elfert&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">portbase</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">portbase</span><span class="p">,</span> <span class="s">&quot;Port address of first card&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">membase</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">membase</span><span class="p">,</span> <span class="s">&quot;Shared memory address of all cards&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">icn_id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">icn_id</span><span class="p">,</span> <span class="s">&quot;ID-String of first card&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">icn_id2</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">icn_id2</span><span class="p">,</span> <span class="s">&quot;ID-String of first card, second S0 (4B only)&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Verbose bootcode- and protocol-downloading.</span>
<span class="cm"> */</span>
<span class="cp">#undef BOOT_DEBUG</span>

<span class="cm">/*</span>
<span class="cm"> * Verbose Shmem-Mapping.</span>
<span class="cm"> */</span>
<span class="cp">#undef MAP_DEBUG</span>

<span class="k">static</span> <span class="kt">char</span>
<span class="o">*</span><span class="n">revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.65.6.8 $&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">icn_addcard</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Free send-queue completely.</span>
<span class="cm"> * Parameter:</span>
<span class="cm"> *   card   = pointer to card struct</span>
<span class="cm"> *   channel = channel number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_free_queue</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">spqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">xlen</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Put a value into a shift-register, highest bit first.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *            port     = port for output (bit 0 is significant)</span>
<span class="cm"> *            val      = value to be output</span>
<span class="cm"> *            firstbit = Bit-Number of highest bit</span>
<span class="cm"> *            bitcount = Number of bits to output</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">icn_shiftout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">port</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">firstbit</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">bitcount</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">register</span> <span class="n">u_char</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">firstbit</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">bitcount</span><span class="p">;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">s</span><span class="o">--</span><span class="p">,</span> <span class="n">c</span><span class="o">--</span><span class="p">)</span>
		<span class="n">OUTB_P</span><span class="p">((</span><span class="n">u_char</span><span class="p">)</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xff</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * disable a cards shared memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">icn_disable_ram</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTB_P</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICN_MAPRAM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * enable a cards shared memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">icn_enable_ram</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OUTB_P</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ICN_MAPRAM</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map a cards channel0 (Bank0/Bank8) or channel1 (Bank4/Bank12)</span>
<span class="cm"> *</span>
<span class="cm"> * must called with holding the devlock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">icn_map_channel</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MAP_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_map_channel %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">==</span> <span class="n">dev</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">dev</span><span class="p">.</span><span class="n">mcard</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">mcard</span><span class="p">)</span>
		<span class="n">icn_disable_ram</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">mcard</span><span class="p">);</span>
	<span class="n">icn_shiftout</span><span class="p">(</span><span class="n">ICN_BANK</span><span class="p">,</span> <span class="n">chan2bank</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* Select Bank          */</span>
	<span class="n">icn_enable_ram</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="p">.</span><span class="n">mcard</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">dev</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
<span class="cp">#ifdef MAP_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_map_channel done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lock a cards channel.</span>
<span class="cm"> * Return 0 if requested card/channel is unmapped (failure).</span>
<span class="cm"> * Return 1 on success.</span>
<span class="cm"> *</span>
<span class="cm"> * must called with holding the devlock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">icn_lock_channel</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

<span class="cp">#ifdef MAP_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_lock_channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">dev</span><span class="p">.</span><span class="n">mcard</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef MAP_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_lock_channel %d OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef MAP_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_lock_channel %d FAILED, dc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release current card/channel lock</span>
<span class="cm"> *</span>
<span class="cm"> * must called with holding the devlock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">__icn_release_channel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MAP_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_release_channel l=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release current card/channel lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">icn_release_channel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__icn_release_channel</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to map and lock a cards channel.</span>
<span class="cm"> * Return 1 on success, 0 on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">icn_trymaplock_channel</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef MAP_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;trymaplock c=%d dc=%d l=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
	       <span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">dev</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">mcard</span> <span class="o">==</span> <span class="n">card</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="o">++</span><span class="p">;</span>
		<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef MAP_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;trymaplock %d OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef MAP_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;trymaplock %d FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release current card/channel lock,</span>
<span class="cm"> * then map same or other channel without locking.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">icn_maprelease_channel</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef MAP_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;map_release c=%d l=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">.</span><span class="n">chanlock</span><span class="p">)</span>
		<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get Data from the B-Channel, assemble fragmented packets and put them</span>
<span class="cm"> * into receive-queue. Wake up any B-Channel-reading processes.</span>
<span class="cm"> * This routine is called via timer-callback from icn_pollbchan().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_pollbchan_receive</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mch</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">+</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">eflag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icn_trymaplock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rbavl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbuf_l</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;icn: (%s) bogus packet on ch%d, dropping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">CID</span><span class="p">,</span>
				       <span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">eflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">[</span><span class="n">channel</span><span class="p">][</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]],</span>
					      <span class="o">&amp;</span><span class="n">rbuf_d</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
				<span class="n">eflag</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rbuf_f</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rbnext</span><span class="p">;</span>
			<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eflag</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">cnt</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;icn: receive out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">cnt</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">rcvcallb_skb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icn_trymaplock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Send data-packet to B-Channel, split it up into fragments of</span>
<span class="cm"> * ICN_FRAGSIZE length. If last fragment is sent out, signal</span>
<span class="cm"> * success to upper layers via statcallb with ISDN_STAT_BSENT argument.</span>
<span class="cm"> * This routine is called via timer-callback from icn_pollbchan() or</span>
<span class="cm"> * directly from icn_sendbuf().</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_pollbchan_send</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mch</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">+</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">||</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">||</span>
	      <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">spqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">])))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icn_trymaplock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">sbfree</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">spqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span> <span class="o">||</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">spqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Pop ACK-flag off skb.</span>
<span class="cm">					 * Store length to xlen.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">xlen</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">xlen</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ICN_FRAGSIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf_f</span><span class="p">);</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">ICN_FRAGSIZE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">writeb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf_f</span><span class="p">);</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">cnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf_l</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbuf_d</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
			<span class="n">sbnext</span><span class="p">;</span> <span class="cm">/* switch to next buffer        */</span>
			<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">xlen</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BSENT</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">xlen</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">xskb</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icn_trymaplock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Send/Receive Data to/from the B-Channel.</span>
<span class="cm"> * This routine is called via timer-callback.</span>
<span class="cm"> * It schedules itself while any B-Channel is open.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_pollbchan</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_B1ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icn_pollbchan_receive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="n">icn_pollbchan_send</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_B2ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icn_pollbchan_receive</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="n">icn_pollbchan_send</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ICN_FLAGS_B1ACTIVE</span> <span class="o">|</span> <span class="n">ICN_FLAGS_B2ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* schedule b-channel polling again */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ICN_TIMER_BCREAD</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ICN_FLAGS_RBTIMER</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICN_FLAGS_RBTIMER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">icn_stat</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">statstr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span> <span class="n">icn_stat</span><span class="p">;</span>
<span class="cm">/* *INDENT-OFF* */</span>
<span class="k">static</span> <span class="n">icn_stat</span> <span class="n">icn_stat_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;BCON_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_BCONN</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>	<span class="cm">/* B-Channel connected        */</span>
	<span class="p">{</span><span class="s">&quot;BDIS_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">2</span><span class="p">},</span>	<span class="cm">/* B-Channel disconnected     */</span>
	<span class="cm">/*</span>
<span class="cm">	** add d-channel connect and disconnect support to link-level</span>
<span class="cm">	*/</span>
	<span class="p">{</span><span class="s">&quot;DCON_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_DCONN</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>	<span class="cm">/* D-Channel connected        */</span>
	<span class="p">{</span><span class="s">&quot;DDIS_&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_DHUP</span><span class="p">,</span>  <span class="mi">11</span><span class="p">},</span>	<span class="cm">/* D-Channel disconnected     */</span>
	<span class="p">{</span><span class="s">&quot;DCAL_I&quot;</span><span class="p">,</span>         <span class="n">ISDN_STAT_ICALL</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>	<span class="cm">/* Incoming call dialup-line  */</span>
	<span class="p">{</span><span class="s">&quot;DSCA_I&quot;</span><span class="p">,</span>         <span class="n">ISDN_STAT_ICALL</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>	<span class="cm">/* Incoming call 1TR6-SPV     */</span>
	<span class="p">{</span><span class="s">&quot;FCALL&quot;</span><span class="p">,</span>          <span class="n">ISDN_STAT_ICALL</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>	<span class="cm">/* Leased line connection up  */</span>
	<span class="p">{</span><span class="s">&quot;CIF&quot;</span><span class="p">,</span>            <span class="n">ISDN_STAT_CINF</span><span class="p">,</span>  <span class="mi">5</span><span class="p">},</span>	<span class="cm">/* Charge-info, 1TR6-type     */</span>
	<span class="p">{</span><span class="s">&quot;AOC&quot;</span><span class="p">,</span>            <span class="n">ISDN_STAT_CINF</span><span class="p">,</span>  <span class="mi">6</span><span class="p">},</span>	<span class="cm">/* Charge-info, DSS1-type     */</span>
	<span class="p">{</span><span class="s">&quot;CAU&quot;</span><span class="p">,</span>            <span class="n">ISDN_STAT_CAUSE</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>	<span class="cm">/* Cause code                 */</span>
	<span class="p">{</span><span class="s">&quot;TEI OK&quot;</span><span class="p">,</span>         <span class="n">ISDN_STAT_RUN</span><span class="p">,</span>   <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* Card connected to wallplug */</span>
	<span class="p">{</span><span class="s">&quot;E_L1: ACT FAIL&quot;</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>	<span class="cm">/* Layer-1 activation failed  */</span>
	<span class="p">{</span><span class="s">&quot;E_L2: DATA LIN&quot;</span><span class="p">,</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>	<span class="cm">/* Layer-2 data link lost     */</span>
	<span class="p">{</span><span class="s">&quot;E_L1: ACTIVATION FAILED&quot;</span><span class="p">,</span>
	 <span class="n">ISDN_STAT_BHUP</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>	<span class="cm">/* Layer-1 activation failed  */</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
<span class="p">};</span>
<span class="cm">/* *INDENT-ON* */</span>


<span class="cm">/*</span>
<span class="cm"> * Check Statusqueue-Pointer from isdn-cards.</span>
<span class="cm"> * If there are new status-replies from the interface, check</span>
<span class="cm"> * them against B-Channel-connects/disconnects and set flags accordingly.</span>
<span class="cm"> * Wake-Up any processes, who are reading the status-device.</span>
<span class="cm"> * If there are B-Channels open, initiate a timer-callback to</span>
<span class="cm"> * icn_pollbchan().</span>
<span class="cm"> * This routine is called periodically via timer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_parse_status</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_stat</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">icn_stat_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">statstr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>
			<span class="n">action</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">icn_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
		    <span class="p">((</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span> <span class="n">ICN_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ICN_FLAGS_B1ACTIVE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">isdn_ctrl</span> <span class="n">ncmd</span><span class="p">;</span>

			<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span>
					 <span class="n">ICN_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ICN_FLAGS_B1ACTIVE</span><span class="p">);</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ncmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ncmd</span><span class="p">));</span>

			<span class="n">ncmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
			<span class="n">ncmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
			<span class="n">ncmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">icn_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">ICN_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ICN_FLAGS_B1ACTIVE</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">ICN_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ICN_FLAGS_B1ACTIVE</span><span class="p">);</span>
		<span class="n">icn_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">status</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>

		<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">));</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span>
				<span class="n">simple_strtoul</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span>
				<span class="n">simple_strtoul</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="s">&quot;LEASED%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">status</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">),</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">status</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">16</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">status</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">),</span> <span class="s">&quot;%s%c%c&quot;</span><span class="p">,</span>
				 <span class="n">status</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">status</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">status</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICN_FLAGS_B1ACTIVE</span><span class="p">;</span>
		<span class="n">icn_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICN_FLAGS_B2ACTIVE</span><span class="p">;</span>
		<span class="n">icn_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvidx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_putmsg</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;\n&#39;</span> <span class="o">:</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_polldchan</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mch</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icn_trymaplock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">avail</span> <span class="o">=</span> <span class="n">msg_avail</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="n">avail</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_o</span><span class="p">);</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="o">-&gt;</span><span class="n">comm_buffers</span><span class="p">.</span><span class="n">iopc_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]);</span>
			<span class="n">icn_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span>
				    <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;2&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
					<span class="n">icn_parse_status</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">p</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;DRV1.&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">u_char</span> <span class="n">vstr</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
						<span class="n">u_char</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">vstr</span><span class="p">;</span>

						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;icn: (%s) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CID</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;TC&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ISDN_PTYPE_1TR6</span><span class="p">;</span>
							<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ISDN_FEATURE_P_1TR6</span><span class="p">;</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
							       <span class="s">&quot;icn: (%s) 1TR6-Protocol loaded and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CID</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;EC&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">;</span>
							<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">ISDN_FEATURE_P_EURO</span><span class="p">;</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
							       <span class="s">&quot;icn: (%s) Euro-Protocol loaded and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CID</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">p</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">,</span> <span class="s">&quot;BRV&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
						<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
								<span class="o">*</span><span class="n">q</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
							<span class="n">p</span><span class="o">++</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
						<span class="n">strcat</span><span class="p">(</span><span class="n">vstr</span><span class="p">,</span> <span class="s">&quot;000&quot;</span><span class="p">);</span>
						<span class="n">vstr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">vstr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">imsg</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span> <span class="o">&lt;</span> <span class="mi">59</span><span class="p">)</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">iptr</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">writeb</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_o</span><span class="p">)</span> <span class="o">+</span> <span class="n">avail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_o</span><span class="p">);</span>
		<span class="n">icn_release_channel</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STAVAIL</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">avail</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ICN_FLAGS_B1ACTIVE</span> <span class="o">|</span> <span class="n">ICN_FLAGS_B2ACTIVE</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RBTIMER</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* schedule b-channel polling */</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ICN_FLAGS_RBTIMER</span><span class="p">;</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">icn_pollbchan</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ICN_TIMER_BCREAD</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="cm">/* schedule again */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ICN_TIMER_DCREAD</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Append a packet to the transmit buffer-queue.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *   channel = Number of B-channel</span>
<span class="cm"> *   skb     = pointer to sk_buff</span>
<span class="cm"> *   card    = pointer to card-struct</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   Number of bytes transferred, -E??? on error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_sendbuf</span><span class="p">(</span><span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ack</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;icn: Send packet too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">?</span> <span class="n">ICN_FLAGS_B2ACTIVE</span> <span class="o">:</span> <span class="n">ICN_FLAGS_B1ACTIVE</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ICN_MAX_SQUEUE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#warning TODO test headroom or use skb-&gt;nb to flag ACK</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Push ACK flag as one</span>
<span class="cm">			 * byte in front of data.</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="n">ack</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">spqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">nskb</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sndcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check card&#39;s status after starting the bootstrap loader.</span>
<span class="cm"> * On entry, the card&#39;s shared memory has already to be mapped.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   0 on success (Boot loader ready)</span>
<span class="cm"> *   -EIO on failure (timeout)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_check_loader</span><span class="p">(</span><span class="kt">int</span> <span class="n">cardnumber</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Loader %d ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cardnumber</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="o">-&gt;</span><span class="n">data_control</span><span class="p">.</span><span class="n">scns</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="o">-&gt;</span><span class="n">data_control</span><span class="p">.</span><span class="n">scnr</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;icn: Boot-Loader %d timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">cardnumber</span><span class="p">);</span>
				<span class="n">icn_release_channel</span><span class="p">();</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Loader %d TO?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cardnumber</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">ICN_BOOT_TIMEOUT1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Loader %d OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cardnumber</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">icn_release_channel</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Load the boot-code into the interface-card&#39;s memory and start it.</span>
<span class="cm"> * Always called from user-process.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *            buffer = pointer to packet</span>
<span class="cm"> * Return:</span>
<span class="cm"> *        0 if successfully loaded</span>
<span class="cm"> */</span>

<span class="cp">#ifdef BOOT_DEBUG</span>
<span class="cp">#define SLEEP(sec) {						\</span>
<span class="cp">		int slsec = sec;				\</span>
<span class="cp">		printk(KERN_DEBUG &quot;SLEEP(%d)\n&quot;, slsec);	\</span>
<span class="cp">		while (slsec) {					\</span>
<span class="cp">			msleep_interruptible(1000);		\</span>
<span class="cp">			slsec--;				\</span>
<span class="cp">		}						\</span>
<span class="cp">	}</span>
<span class="cp">#else</span>
<span class="cp">#define SLEEP(sec)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_loadboot</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">codebuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef BOOT_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_loadboot called, buffaddr=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">buffer</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">codebuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ICN_CODE_STAGE1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;icn: Could not allocate code buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">codebuf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ICN_CODE_STAGE1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ICN_PORTLEN</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">regname</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;icn: (%s) ports 0x%03x-0x%03x in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">CID</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">ICN_PORTLEN</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rvalid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">rvalid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">.</span><span class="n">mvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="s">&quot;icn-isdn (all cards)&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;icn: memory at 0x%08lx in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="p">.</span><span class="n">shmem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
		<span class="n">dev</span><span class="p">.</span><span class="n">mvalid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">OUTB_P</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICN_RUN</span><span class="p">);</span>     <span class="cm">/* Reset Controller */</span>
	<span class="n">OUTB_P</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICN_MAPRAM</span><span class="p">);</span>  <span class="cm">/* Disable RAM      */</span>
	<span class="n">icn_shiftout</span><span class="p">(</span><span class="n">ICN_CFG</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* Windowsize= 16k  */</span>
	<span class="n">icn_shiftout</span><span class="p">(</span><span class="n">ICN_CFG</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* Set RAM-Addr.    */</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;shmem=%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">SLEEP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Map Bank 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Select Bank 0    */</span>
	<span class="n">icn_lock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Lock Bank 0      */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">SLEEP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="p">,</span> <span class="n">codebuf</span><span class="p">,</span> <span class="n">ICN_CODE_STAGE1</span><span class="p">);</span>	<span class="cm">/* Copy code        */</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Bootloader transferred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SLEEP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Map Bank 8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">__icn_release_channel</span><span class="p">();</span>
		<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Select Bank 8   */</span>
		<span class="n">icn_lock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Lock Bank 8     */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">SLEEP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="p">,</span> <span class="n">codebuf</span><span class="p">,</span> <span class="n">ICN_CODE_STAGE1</span><span class="p">);</span>	<span class="cm">/* Copy code        */</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Bootloader transferred</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">SLEEP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">OUTB_P</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ICN_RUN</span><span class="p">);</span>  <span class="cm">/* Start Boot-Code */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">icn_check_loader</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_kfree</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* reached only, if we have a Double-S0-Card */</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Map Bank 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Select Bank 0   */</span>
	<span class="n">icn_lock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Lock Bank 0     */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">SLEEP</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">icn_check_loader</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

<span class="nl">out_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">codebuf</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_loadproto</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">codebuf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">uint</span> <span class="n">left</span> <span class="o">=</span> <span class="n">ICN_CODE_STAGE2</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef BOOT_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;icn_loadproto called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ICN_CODE_STAGE2</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">icn_lock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">icn_lock_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sbfree</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* If there is a free buffer...  */</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">codebuf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sbuf_l</span><span class="p">,</span> <span class="n">codebuf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>	<span class="cm">/* copy data                     */</span>
			<span class="n">sbnext</span><span class="p">;</span> <span class="cm">/* switch to next buffer         */</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;boot 2 !sbfree</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sbuf_n</span><span class="p">);</span>
	<span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_o</span><span class="p">)</span> <span class="o">||</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_i</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Proto?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;icn: (%s) Protocol timed out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">CID</span><span class="p">);</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Proto TO!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Proto TO?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">ICN_BOOT_TIMEOUT1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef BOOT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Proto loaded, install poll-timer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ICN_TIMER_DCREAD</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">icn_polldchan</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ICN_TIMER_DCREAD</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">icn_polldchan</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">;</span>
					<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">icn_maprelease_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Read the Status-replies from the Interface */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_readstatus</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="o">*</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put command-strings into the command-queue of the Interface */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_writecmd</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">user</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mch</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xcount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ocount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lastmap_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">lastmap_card</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">msg</span><span class="p">[</span><span class="mh">0x100</span><span class="p">];</span>

	<span class="n">ocount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xcount</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">cmd_free</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">lastmap_card</span> <span class="o">=</span> <span class="n">dev</span><span class="p">.</span><span class="n">mcard</span><span class="p">;</span>
		<span class="n">lastmap_channel</span> <span class="o">=</span> <span class="n">dev</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mch</span><span class="p">);</span>

		<span class="n">icn_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="p">,</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_i</span><span class="p">),</span> <span class="n">i</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">pp</span>
			     <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xff</span> <span class="o">:</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="o">-&gt;</span><span class="n">comm_buffers</span><span class="p">.</span><span class="n">pcio_buf</span><span class="p">[</span><span class="n">pp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">]);</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="n">xcount</span><span class="o">++</span><span class="p">;</span>
			<span class="n">icn_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">icn_putmsg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
				<span class="n">ocount</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ocount</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writeb</span><span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lastmap_card</span><span class="p">)</span>
			<span class="n">icn_map_channel</span><span class="p">(</span><span class="n">lastmap_card</span><span class="p">,</span> <span class="n">lastmap_channel</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">loop</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">user</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;icn: writemsg incomplete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STAVAIL</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">ocount</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xcount</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delete card&#39;s pending timers, send STOP to linklevel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_stopcard</span><span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICN_FLAGS_RUNNING</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">st_timer</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rb_timer</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_STOP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">)</span>
			<span class="n">icn_stopcard</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_stopallcards</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">icn_stopcard</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unmap all cards, because some of them may be mapped accidetly during</span>
<span class="cm"> * autoprobing of some network drivers (SMC-driver?)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">icn_disable_cards</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ICN_PORTLEN</span><span class="p">,</span> <span class="s">&quot;icn-isdn&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;icn: (%s) ports 0x%03x-0x%03x in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">CID</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">ICN_PORTLEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">OUTB_P</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICN_RUN</span><span class="p">);</span>	<span class="cm">/* Reset Controller     */</span>
			<span class="n">OUTB_P</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICN_MAPRAM</span><span class="p">);</span>	<span class="cm">/* Disable RAM          */</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ICN_PORTLEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_command</span><span class="p">(</span><span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cbuf</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">icn_cdef</span> <span class="n">cdef</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_IOCTL</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ulong</span><span class="p">));</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_SETMMIO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span> <span class="o">!=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0ffc000</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0ffc000</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="s">&quot;icn-isdn (all cards)&quot;</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					       <span class="s">&quot;icn: memory at 0x%08lx in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0ffc000</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">release_mem_region</span><span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0ffc000</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
				<span class="n">icn_stopallcards</span><span class="p">();</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">mvalid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="p">);</span>
					<span class="n">release_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">dev</span><span class="p">.</span><span class="n">mvalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0ffc000</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				       <span class="s">&quot;icn: (%s) mmio set to 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">CID</span><span class="p">,</span>
				       <span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_GETMMIO</span>:
			<span class="k">return</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_SETPORT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mh">0x300</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x310</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x320</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x330</span>
			    <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x340</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x350</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x360</span> <span class="o">||</span>
			    <span class="n">a</span> <span class="o">==</span> <span class="mh">0x308</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x318</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x328</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x338</span>
			    <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x348</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x358</span> <span class="o">||</span> <span class="n">a</span> <span class="o">==</span> <span class="mh">0x368</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="n">ICN_PORTLEN</span><span class="p">,</span> <span class="s">&quot;icn-isdn&quot;</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
						       <span class="s">&quot;icn: (%s) ports 0x%03x-0x%03x in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">CID</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span> <span class="o">+</span> <span class="n">ICN_PORTLEN</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">release_region</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="n">ICN_PORTLEN</span><span class="p">);</span>
					<span class="n">icn_stopcard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rvalid</span><span class="p">)</span>
						<span class="n">release_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ICN_PORTLEN</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">rvalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">rvalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;icn: (%s) port set to 0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">CID</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_GETPORT</span>:
			<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_GETDOUBLE</span>:
			<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_DEBUGVAR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">card</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">ulong</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">a</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ulong</span><span class="p">);</span>
			<span class="p">{</span>
				<span class="n">ulong</span> <span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">ulong</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_LOADBOOT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">firstload</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">icn_disable_cards</span><span class="p">();</span>
				<span class="n">dev</span><span class="p">.</span><span class="n">firstload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">icn_stopcard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">icn_loadboot</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_LOADPROTO</span>:
			<span class="n">icn_stopcard</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">icn_loadproto</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">card</span><span class="p">))))</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">)</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">icn_loadproto</span><span class="p">(</span><span class="n">arg</span> <span class="o">+</span> <span class="n">ICN_CODE_STAGE2</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_ADDCARD</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">.</span><span class="n">firstload</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cdef</span><span class="p">,</span>
					   <span class="n">arg</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">cdef</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">icn_addcard</span><span class="p">(</span><span class="n">cdef</span><span class="p">.</span><span class="n">port</span><span class="p">,</span> <span class="n">cdef</span><span class="p">.</span><span class="n">id1</span><span class="p">,</span> <span class="n">cdef</span><span class="p">.</span><span class="n">id2</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ICN_IOCTL_LEASEDCFG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">ICN_BOOT_TIMEOUT1</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">ICN_BOOT_TIMEOUT1</span><span class="p">);</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;00;FV2ON</span><span class="se">\n</span><span class="s">01;EAZ%c</span><span class="se">\n</span><span class="s">02;EAZ%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;2&#39;</span> <span class="o">:</span> <span class="sc">&#39;C&#39;</span><span class="p">);</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;icn: (%s) Leased-line mode enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">CID</span><span class="p">);</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_RUN</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;00;FV2OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;icn: (%s) Leased-line mode disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">CID</span><span class="p">);</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_RUN</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_DIAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="kt">char</span> <span class="n">dial</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
			<span class="kt">char</span> <span class="n">dcode</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Dial for SPV */</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">dcode</span><span class="p">,</span> <span class="s">&quot;SCA&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="cm">/* Normal Dial */</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">dcode</span><span class="p">,</span> <span class="s">&quot;CAL&quot;</span><span class="p">);</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">dial</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;D%s_R%s,%02d,%02d,%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">dcode</span><span class="p">,</span> <span class="n">dial</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span><span class="p">,</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_ACCEPTD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">&gt;=</span> <span class="mi">300</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX75</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BTRA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;DCON_R</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_ACCEPTB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">&gt;=</span> <span class="mi">300</span><span class="p">)</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R,BX75</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
					<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R,BTRA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BCON_R</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_HANGUP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BDIS_R</span><span class="se">\n</span><span class="s">%02d;DDIS_R</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_SETEAZ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;MS%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="s">&quot;N&quot;</span> <span class="o">:</span> <span class="s">&quot;ALL&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;EAZ%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">,</span>
					<span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;0123456789&quot;</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_CLREAZ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">leased</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;MSNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;EAZC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">a</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_SETL2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BX75</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="s">&quot;%02d;BTRA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">icn_writecmd</span><span class="p">(</span><span class="n">cbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cbuf</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_CMD_SETL3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find card with given driverId</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">icn_card</span> <span class="o">*</span>
<span class="nf">icn_findcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">driverid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">myid</span> <span class="o">==</span> <span class="n">driverid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wrapper functions for interface to linklevel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_command</span><span class="p">(</span><span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">icn_findcard</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">icn_command</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;icn: if_command %d called with invalid driverId %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">c</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_writecmd</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">icn_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">icn_writecmd</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;icn: if_writecmd called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_readstatus</span><span class="p">(</span><span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">icn_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">icn_readstatus</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;icn: if_readstatus called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">if_sendbuf</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ack</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">icn_findcard</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ICN_FLAGS_RUNNING</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">icn_sendbuf</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
	       <span class="s">&quot;icn: if_sendbuf called with invalid driverId!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a new card-struct, initialize it</span>
<span class="cm"> * link it into cards-list and register it at linklevel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">icn_card</span> <span class="o">*</span>
<span class="nf">icn_initcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">icn_card</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;icn: (%s) Could not allocate card-struct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">hl_hdrlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ICN_BCH</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">maxbufsize</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">if_command</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">writebuf_skb</span> <span class="o">=</span> <span class="n">if_sendbuf</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">writecmd</span> <span class="o">=</span> <span class="n">if_writecmd</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">readstat</span> <span class="o">=</span> <span class="n">if_readstatus</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">ISDN_FEATURE_L2_X75I</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L2_HDLC</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_L3_TRANS</span> <span class="o">|</span>
		<span class="n">ISDN_FEATURE_P_UNKNOWN</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">=</span> <span class="n">ISDN_PTYPE_UNKNOWN</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_write</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_read</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf_end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">msg_buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">spqueue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>
	<span class="n">cards</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_isdn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cards</span> <span class="o">=</span> <span class="n">cards</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;icn: Unable to register %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">icn_card</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">regname</span><span class="p">,</span> <span class="s">&quot;icn-isdn (%s)&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">card</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">icn_addcard</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id1</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card</span> <span class="o">=</span> <span class="n">icn_initcard</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">id1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">id2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;icn: (%s) ICN-2B, port 0x%x added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">card2</span> <span class="o">=</span> <span class="n">icn_initcard</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">id2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;icn: (%s) half ICN-4B, port 0x%x added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card2</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">other</span> <span class="o">=</span> <span class="n">card2</span><span class="p">;</span>
	<span class="n">card2</span><span class="o">-&gt;</span><span class="n">doubleS0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">card2</span><span class="o">-&gt;</span><span class="n">secondhalf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">card2</span><span class="o">-&gt;</span><span class="n">other</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;icn: (%s and %s) ICN-4B, port 0x%x added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">card2</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">icn_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">sid</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">sid2</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">portbase</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">membase</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
		<span class="n">icn_id</span> <span class="o">=</span> <span class="n">sid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">sid2</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="n">icn_id2</span> <span class="o">=</span> <span class="n">sid2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;icn=&quot;</span><span class="p">,</span> <span class="n">icn_setup</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">icn_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rev</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">icn_dev</span><span class="p">));</span>
	<span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span> <span class="o">=</span> <span class="p">(</span><span class="n">membase</span> <span class="o">&amp;</span> <span class="mh">0x0ffc000</span><span class="p">);</span>
	<span class="n">dev</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="p">.</span><span class="n">mcard</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="p">.</span><span class="n">firstload</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="p">.</span><span class="n">devlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
		<span class="n">rev</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="s">&quot; ??? &quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ICN-ISDN-driver Rev%smem=0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">,</span>
	       <span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">icn_addcard</span><span class="p">(</span><span class="n">portbase</span><span class="p">,</span> <span class="n">icn_id</span><span class="p">,</span> <span class="n">icn_id2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">icn_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>
	<span class="n">icn_card</span> <span class="o">*</span><span class="n">last</span><span class="p">,</span> <span class="o">*</span><span class="n">tmpcard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">icn_stopallcards</span><span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_UNLOAD</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rvalid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OUTB_P</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICN_RUN</span><span class="p">);</span>	<span class="cm">/* Reset Controller     */</span>
			<span class="n">OUTB_P</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICN_MAPRAM</span><span class="p">);</span>	<span class="cm">/* Disable RAM          */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">secondhalf</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">doubleS0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ICN_PORTLEN</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rvalid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ICN_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">icn_free_queue</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tmpcard</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">tmpcard</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">cards</span><span class="p">;</span>
	<span class="n">cards</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">last</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">mvalid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">shmem</span><span class="p">);</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">memaddr</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ICN-ISDN-driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">icn_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">icn_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
