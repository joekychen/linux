<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › capi › capiutil.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>capiutil.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: capiutil.c,v 1.13.6.4 2001/09/23 22:24:33 kai Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * CAPI 2.0 convert capi message to capi message struct</span>
<span class="cm"> *</span>
<span class="cm"> * From CAPI 2.0 Development Kit AVM 1995 (msg.c)</span>
<span class="cm"> * Rewritten for Linux 1996 by Carsten Paeth &lt;calle@calle.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/isdn/capiutil.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cm">/* from CAPI2.0 DDK AVM Berlin GmbH */</span>

<span class="cp">#ifndef CONFIG_ISDN_DRV_AVMB1_VERBOSE_REASON</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">capi_info2str</span><span class="p">(</span><span class="n">u16</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;..&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">capi_info2str</span><span class="p">(</span><span class="n">u16</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>

<span class="cm">/*-- informative values (corresponding message was processed) -----*/</span>
	<span class="k">case</span> <span class="mh">0x0001</span>:
		<span class="k">return</span> <span class="s">&quot;NCPI not supported by current protocol, NCPI ignored&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0002</span>:
		<span class="k">return</span> <span class="s">&quot;Flags not supported by current protocol, flags ignored&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0003</span>:
		<span class="k">return</span> <span class="s">&quot;Alert already sent by another application&quot;</span><span class="p">;</span>

<span class="cm">/*-- error information concerning CAPI_REGISTER -----*/</span>
	<span class="k">case</span> <span class="mh">0x1001</span>:
		<span class="k">return</span> <span class="s">&quot;Too many applications&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1002</span>:
		<span class="k">return</span> <span class="s">&quot;Logical block size too small, must be at least 128 Bytes&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1003</span>:
		<span class="k">return</span> <span class="s">&quot;Buffer exceeds 64 kByte&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1004</span>:
		<span class="k">return</span> <span class="s">&quot;Message buffer size too small, must be at least 1024 Bytes&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1005</span>:
		<span class="k">return</span> <span class="s">&quot;Max. number of logical connections not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1006</span>:
		<span class="k">return</span> <span class="s">&quot;Reserved&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1007</span>:
		<span class="k">return</span> <span class="s">&quot;The message could not be accepted because of an internal busy condition&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1008</span>:
		<span class="k">return</span> <span class="s">&quot;OS resource error (no memory ?)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1009</span>:
		<span class="k">return</span> <span class="s">&quot;CAPI not installed&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x100A</span>:
		<span class="k">return</span> <span class="s">&quot;Controller does not support external equipment&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x100B</span>:
		<span class="k">return</span> <span class="s">&quot;Controller does only support external equipment&quot;</span><span class="p">;</span>

<span class="cm">/*-- error information concerning message exchange functions -----*/</span>
	<span class="k">case</span> <span class="mh">0x1101</span>:
		<span class="k">return</span> <span class="s">&quot;Illegal application number&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1102</span>:
		<span class="k">return</span> <span class="s">&quot;Illegal command or subcommand or message length less than 12 bytes&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1103</span>:
		<span class="k">return</span> <span class="s">&quot;The message could not be accepted because of a queue full condition !! The error code does not imply that CAPI cannot receive messages directed to another controller, PLCI or NCCI&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1104</span>:
		<span class="k">return</span> <span class="s">&quot;Queue is empty&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1105</span>:
		<span class="k">return</span> <span class="s">&quot;Queue overflow, a message was lost !! This indicates a configuration error. The only recovery from this error is to perform a CAPI_RELEASE&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1106</span>:
		<span class="k">return</span> <span class="s">&quot;Unknown notification parameter&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1107</span>:
		<span class="k">return</span> <span class="s">&quot;The Message could not be accepted because of an internal busy condition&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1108</span>:
		<span class="k">return</span> <span class="s">&quot;OS Resource error (no memory ?)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x1109</span>:
		<span class="k">return</span> <span class="s">&quot;CAPI not installed&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x110A</span>:
		<span class="k">return</span> <span class="s">&quot;Controller does not support external equipment&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x110B</span>:
		<span class="k">return</span> <span class="s">&quot;Controller does only support external equipment&quot;</span><span class="p">;</span>

<span class="cm">/*-- error information concerning resource / coding problems -----*/</span>
	<span class="k">case</span> <span class="mh">0x2001</span>:
		<span class="k">return</span> <span class="s">&quot;Message not supported in current state&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2002</span>:
		<span class="k">return</span> <span class="s">&quot;Illegal Controller / PLCI / NCCI&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2003</span>:
		<span class="k">return</span> <span class="s">&quot;Out of PLCI&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2004</span>:
		<span class="k">return</span> <span class="s">&quot;Out of NCCI&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2005</span>:
		<span class="k">return</span> <span class="s">&quot;Out of LISTEN&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2006</span>:
		<span class="k">return</span> <span class="s">&quot;Out of FAX resources (protocol T.30)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2007</span>:
		<span class="k">return</span> <span class="s">&quot;Illegal message parameter coding&quot;</span><span class="p">;</span>

<span class="cm">/*-- error information concerning requested services  -----*/</span>
	<span class="k">case</span> <span class="mh">0x3001</span>:
		<span class="k">return</span> <span class="s">&quot;B1 protocol not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3002</span>:
		<span class="k">return</span> <span class="s">&quot;B2 protocol not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3003</span>:
		<span class="k">return</span> <span class="s">&quot;B3 protocol not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3004</span>:
		<span class="k">return</span> <span class="s">&quot;B1 protocol parameter not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3005</span>:
		<span class="k">return</span> <span class="s">&quot;B2 protocol parameter not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3006</span>:
		<span class="k">return</span> <span class="s">&quot;B3 protocol parameter not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3007</span>:
		<span class="k">return</span> <span class="s">&quot;B protocol combination not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3008</span>:
		<span class="k">return</span> <span class="s">&quot;NCPI not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3009</span>:
		<span class="k">return</span> <span class="s">&quot;CIP Value unknown&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x300A</span>:
		<span class="k">return</span> <span class="s">&quot;Flags not supported (reserved bits)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x300B</span>:
		<span class="k">return</span> <span class="s">&quot;Facility not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x300C</span>:
		<span class="k">return</span> <span class="s">&quot;Data length not supported by current protocol&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x300D</span>:
		<span class="k">return</span> <span class="s">&quot;Reset procedure not supported by current protocol&quot;</span><span class="p">;</span>

<span class="cm">/*-- informations about the clearing of a physical connection -----*/</span>
	<span class="k">case</span> <span class="mh">0x3301</span>:
		<span class="k">return</span> <span class="s">&quot;Protocol error layer 1 (broken line or B-channel removed by signalling protocol)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3302</span>:
		<span class="k">return</span> <span class="s">&quot;Protocol error layer 2&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3303</span>:
		<span class="k">return</span> <span class="s">&quot;Protocol error layer 3&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3304</span>:
		<span class="k">return</span> <span class="s">&quot;Another application got that call&quot;</span><span class="p">;</span>
<span class="cm">/*-- T.30 specific reasons -----*/</span>
	<span class="k">case</span> <span class="mh">0x3311</span>:
		<span class="k">return</span> <span class="s">&quot;Connecting not successful (remote station is no FAX G3 machine)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3312</span>:
		<span class="k">return</span> <span class="s">&quot;Connecting not successful (training error)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3313</span>:
		<span class="k">return</span> <span class="s">&quot;Disconnected before transfer (remote station does not support transfer mode, e.g. resolution)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3314</span>:
		<span class="k">return</span> <span class="s">&quot;Disconnected during transfer (remote abort)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3315</span>:
		<span class="k">return</span> <span class="s">&quot;Disconnected during transfer (remote procedure error, e.g. unsuccessful repetition of T.30 commands)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3316</span>:
		<span class="k">return</span> <span class="s">&quot;Disconnected during transfer (local tx data underrun)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3317</span>:
		<span class="k">return</span> <span class="s">&quot;Disconnected during transfer (local rx data overflow)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3318</span>:
		<span class="k">return</span> <span class="s">&quot;Disconnected during transfer (local abort)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3319</span>:
		<span class="k">return</span> <span class="s">&quot;Illegal parameter coding (e.g. SFF coding error)&quot;</span><span class="p">;</span>

<span class="cm">/*-- disconnect causes from the network according to ETS 300 102-1/Q.931 -----*/</span>
	<span class="k">case</span> <span class="mh">0x3481</span>: <span class="k">return</span> <span class="s">&quot;Unallocated (unassigned) number&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3482</span>: <span class="k">return</span> <span class="s">&quot;No route to specified transit network&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3483</span>: <span class="k">return</span> <span class="s">&quot;No route to destination&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3486</span>: <span class="k">return</span> <span class="s">&quot;Channel unacceptable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3487</span>:
		<span class="k">return</span> <span class="s">&quot;Call awarded and being delivered in an established channel&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3490</span>: <span class="k">return</span> <span class="s">&quot;Normal call clearing&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3491</span>: <span class="k">return</span> <span class="s">&quot;User busy&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3492</span>: <span class="k">return</span> <span class="s">&quot;No user responding&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3493</span>: <span class="k">return</span> <span class="s">&quot;No answer from user (user alerted)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3495</span>: <span class="k">return</span> <span class="s">&quot;Call rejected&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x3496</span>: <span class="k">return</span> <span class="s">&quot;Number changed&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x349A</span>: <span class="k">return</span> <span class="s">&quot;Non-selected user clearing&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x349B</span>: <span class="k">return</span> <span class="s">&quot;Destination out of order&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x349C</span>: <span class="k">return</span> <span class="s">&quot;Invalid number format&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x349D</span>: <span class="k">return</span> <span class="s">&quot;Facility rejected&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x349E</span>: <span class="k">return</span> <span class="s">&quot;Response to STATUS ENQUIRY&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x349F</span>: <span class="k">return</span> <span class="s">&quot;Normal, unspecified&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34A2</span>: <span class="k">return</span> <span class="s">&quot;No circuit / channel available&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34A6</span>: <span class="k">return</span> <span class="s">&quot;Network out of order&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34A9</span>: <span class="k">return</span> <span class="s">&quot;Temporary failure&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34AA</span>: <span class="k">return</span> <span class="s">&quot;Switching equipment congestion&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34AB</span>: <span class="k">return</span> <span class="s">&quot;Access information discarded&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34AC</span>: <span class="k">return</span> <span class="s">&quot;Requested circuit / channel not available&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34AF</span>: <span class="k">return</span> <span class="s">&quot;Resources unavailable, unspecified&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34B1</span>: <span class="k">return</span> <span class="s">&quot;Quality of service unavailable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34B2</span>: <span class="k">return</span> <span class="s">&quot;Requested facility not subscribed&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34B9</span>: <span class="k">return</span> <span class="s">&quot;Bearer capability not authorized&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34BA</span>: <span class="k">return</span> <span class="s">&quot;Bearer capability not presently available&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34BF</span>: <span class="k">return</span> <span class="s">&quot;Service or option not available, unspecified&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34C1</span>: <span class="k">return</span> <span class="s">&quot;Bearer capability not implemented&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34C2</span>: <span class="k">return</span> <span class="s">&quot;Channel type not implemented&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34C5</span>: <span class="k">return</span> <span class="s">&quot;Requested facility not implemented&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34C6</span>: <span class="k">return</span> <span class="s">&quot;Only restricted digital information bearer capability is available&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34CF</span>: <span class="k">return</span> <span class="s">&quot;Service or option not implemented, unspecified&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34D1</span>: <span class="k">return</span> <span class="s">&quot;Invalid call reference value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34D2</span>: <span class="k">return</span> <span class="s">&quot;Identified channel does not exist&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34D3</span>: <span class="k">return</span> <span class="s">&quot;A suspended call exists, but this call identity does not&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34D4</span>: <span class="k">return</span> <span class="s">&quot;Call identity in use&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34D5</span>: <span class="k">return</span> <span class="s">&quot;No call suspended&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34D6</span>: <span class="k">return</span> <span class="s">&quot;Call having the requested call identity has been cleared&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34D8</span>: <span class="k">return</span> <span class="s">&quot;Incompatible destination&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34DB</span>: <span class="k">return</span> <span class="s">&quot;Invalid transit network selection&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34DF</span>: <span class="k">return</span> <span class="s">&quot;Invalid message, unspecified&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34E0</span>: <span class="k">return</span> <span class="s">&quot;Mandatory information element is missing&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34E1</span>: <span class="k">return</span> <span class="s">&quot;Message type non-existent or not implemented&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34E2</span>: <span class="k">return</span> <span class="s">&quot;Message not compatible with call state or message type non-existent or not implemented&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34E3</span>: <span class="k">return</span> <span class="s">&quot;Information element non-existent or not implemented&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34E4</span>: <span class="k">return</span> <span class="s">&quot;Invalid information element contents&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34E5</span>: <span class="k">return</span> <span class="s">&quot;Message not compatible with call state&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34E6</span>: <span class="k">return</span> <span class="s">&quot;Recovery on timer expiry&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34EF</span>: <span class="k">return</span> <span class="s">&quot;Protocol error, unspecified&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x34FF</span>: <span class="k">return</span> <span class="s">&quot;Interworking, unspecified&quot;</span><span class="p">;</span>

	<span class="nl">default:</span> <span class="k">return</span> <span class="s">&quot;No additional information&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">typ</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">off</span><span class="p">;</span>
<span class="p">}</span> <span class="n">_cdef</span><span class="p">;</span>

<span class="cp">#define _CBYTE	       1</span>
<span class="cp">#define _CWORD	       2</span>
<span class="cp">#define _CDWORD        3</span>
<span class="cp">#define _CSTRUCT       4</span>
<span class="cp">#define _CMSTRUCT      5</span>
<span class="cp">#define _CEND	       6</span>

<span class="k">static</span> <span class="n">_cdef</span> <span class="n">cdef</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/*00 */</span>
	<span class="p">{</span><span class="n">_CEND</span><span class="p">},</span>
	<span class="cm">/*01 */</span>
	<span class="p">{</span><span class="n">_CEND</span><span class="p">},</span>
	<span class="cm">/*02 */</span>
	<span class="p">{</span><span class="n">_CEND</span><span class="p">},</span>
	<span class="cm">/*03 */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">adr</span><span class="p">.</span><span class="n">adrController</span><span class="p">)},</span>
	<span class="cm">/*04 */</span>
	<span class="p">{</span><span class="n">_CMSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">AdditionalInfo</span><span class="p">)},</span>
	<span class="cm">/*05 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">B1configuration</span><span class="p">)},</span>
	<span class="cm">/*06 */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">B1protocol</span><span class="p">)},</span>
	<span class="cm">/*07 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">B2configuration</span><span class="p">)},</span>
	<span class="cm">/*08 */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">B2protocol</span><span class="p">)},</span>
	<span class="cm">/*09 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">B3configuration</span><span class="p">)},</span>
	<span class="cm">/*0a */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">B3protocol</span><span class="p">)},</span>
	<span class="cm">/*0b */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">BC</span><span class="p">)},</span>
	<span class="cm">/*0c */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">BChannelinformation</span><span class="p">)},</span>
	<span class="cm">/*0d */</span>
	<span class="p">{</span><span class="n">_CMSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">BProtocol</span><span class="p">)},</span>
	<span class="cm">/*0e */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">CalledPartyNumber</span><span class="p">)},</span>
	<span class="cm">/*0f */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">CalledPartySubaddress</span><span class="p">)},</span>
	<span class="cm">/*10 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">CallingPartyNumber</span><span class="p">)},</span>
	<span class="cm">/*11 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">CallingPartySubaddress</span><span class="p">)},</span>
	<span class="cm">/*12 */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">CIPmask</span><span class="p">)},</span>
	<span class="cm">/*13 */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">CIPmask2</span><span class="p">)},</span>
	<span class="cm">/*14 */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">CIPValue</span><span class="p">)},</span>
	<span class="cm">/*15 */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Class</span><span class="p">)},</span>
	<span class="cm">/*16 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">ConnectedNumber</span><span class="p">)},</span>
	<span class="cm">/*17 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">ConnectedSubaddress</span><span class="p">)},</span>
	<span class="cm">/*18 */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Data</span><span class="p">)},</span>
	<span class="cm">/*19 */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">DataHandle</span><span class="p">)},</span>
	<span class="cm">/*1a */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">DataLength</span><span class="p">)},</span>
	<span class="cm">/*1b */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">FacilityConfirmationParameter</span><span class="p">)},</span>
	<span class="cm">/*1c */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Facilitydataarray</span><span class="p">)},</span>
	<span class="cm">/*1d */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">FacilityIndicationParameter</span><span class="p">)},</span>
	<span class="cm">/*1e */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">FacilityRequestParameter</span><span class="p">)},</span>
	<span class="cm">/*1f */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">FacilitySelector</span><span class="p">)},</span>
	<span class="cm">/*20 */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Flags</span><span class="p">)},</span>
	<span class="cm">/*21 */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Function</span><span class="p">)},</span>
	<span class="cm">/*22 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">HLC</span><span class="p">)},</span>
	<span class="cm">/*23 */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Info</span><span class="p">)},</span>
	<span class="cm">/*24 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">InfoElement</span><span class="p">)},</span>
	<span class="cm">/*25 */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">InfoMask</span><span class="p">)},</span>
	<span class="cm">/*26 */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">InfoNumber</span><span class="p">)},</span>
	<span class="cm">/*27 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Keypadfacility</span><span class="p">)},</span>
	<span class="cm">/*28 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">LLC</span><span class="p">)},</span>
	<span class="cm">/*29 */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">ManuData</span><span class="p">)},</span>
	<span class="cm">/*2a */</span>
	<span class="p">{</span><span class="n">_CDWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">ManuID</span><span class="p">)},</span>
	<span class="cm">/*2b */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">NCPI</span><span class="p">)},</span>
	<span class="cm">/*2c */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Reason</span><span class="p">)},</span>
	<span class="cm">/*2d */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Reason_B3</span><span class="p">)},</span>
	<span class="cm">/*2e */</span>
	<span class="p">{</span><span class="n">_CWORD</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Reject</span><span class="p">)},</span>
	<span class="cm">/*2f */</span>
	<span class="p">{</span><span class="n">_CSTRUCT</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">,</span> <span class="n">Useruserdata</span><span class="p">)}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cpars</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* ALERT_REQ */</span> <span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x04\x0c\x27\x2f\x1c\x01\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_REQ */</span> <span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x14\x0e\x10\x0f\x11\x0d\x06\x08\x0a\x05\x07\x09\x01\x0b\x28\x22\x04\x0c\x27\x2f\x1c\x01\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_REQ */</span> <span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x04\x0c\x27\x2f\x1c\x01\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* LISTEN_REQ */</span> <span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x25\x12\x13\x10\x11\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* INFO_REQ */</span> <span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x0e\x04\x0c\x27\x2f\x1c\x01\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* FACILITY_REQ */</span> <span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x1f\x1e\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* SELECT_B_PROTOCOL_REQ */</span> <span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x0d\x06\x08\x0a\x05\x07\x09\x01\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_REQ */</span> <span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_B3_REQ */</span> <span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DATA_B3_REQ */</span> <span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x18\x1a\x19\x20\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* RESET_B3_REQ */</span> <span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* ALERT_CONF */</span> <span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_CONF */</span> <span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_CONF */</span> <span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* LISTEN_CONF */</span> <span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* MANUFACTURER_REQ */</span> <span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2a\x15\x21\x29\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* INFO_CONF */</span> <span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* FACILITY_CONF */</span> <span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x1f\x1b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* SELECT_B_PROTOCOL_CONF */</span> <span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_CONF */</span> <span class="p">[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_B3_CONF */</span> <span class="p">[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DATA_B3_CONF */</span> <span class="p">[</span><span class="mh">0x21</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x19\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* RESET_B3_CONF */</span> <span class="p">[</span><span class="mh">0x22</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x23\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_IND */</span> <span class="p">[</span><span class="mh">0x26</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x14\x0e\x10\x0f\x11\x0b\x28\x22\x04\x0c\x27\x2f\x1c\x01\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_ACTIVE_IND */</span> <span class="p">[</span><span class="mh">0x27</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x16\x17\x28\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_IND */</span> <span class="p">[</span><span class="mh">0x28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2c\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* MANUFACTURER_CONF */</span> <span class="p">[</span><span class="mh">0x2a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2a\x15\x21\x29\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* INFO_IND */</span> <span class="p">[</span><span class="mh">0x2c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x26\x24\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* FACILITY_IND */</span> <span class="p">[</span><span class="mh">0x2d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x1f\x1d\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_IND */</span> <span class="p">[</span><span class="mh">0x2f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_ACTIVE_IND */</span> <span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_B3_IND */</span> <span class="p">[</span><span class="mh">0x31</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2d\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DATA_B3_IND */</span> <span class="p">[</span><span class="mh">0x33</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x18\x1a\x19\x20\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* RESET_B3_IND */</span> <span class="p">[</span><span class="mh">0x34</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_T90_ACTIVE_IND */</span> <span class="p">[</span><span class="mh">0x35</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_RESP */</span> <span class="p">[</span><span class="mh">0x38</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2e\x0d\x06\x08\x0a\x05\x07\x09\x01\x16\x17\x28\x04\x0c\x27\x2f\x1c\x01\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_ACTIVE_RESP */</span> <span class="p">[</span><span class="mh">0x39</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_RESP */</span> <span class="p">[</span><span class="mh">0x3a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* MANUFACTURER_IND */</span> <span class="p">[</span><span class="mh">0x3c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2a\x15\x21\x29\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* INFO_RESP */</span> <span class="p">[</span><span class="mh">0x3e</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* FACILITY_RESP */</span> <span class="p">[</span><span class="mh">0x3f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x1f\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_RESP */</span> <span class="p">[</span><span class="mh">0x41</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2e\x2b\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_ACTIVE_RESP */</span> <span class="p">[</span><span class="mh">0x42</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DISCONNECT_B3_RESP */</span> <span class="p">[</span><span class="mh">0x43</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* DATA_B3_RESP */</span> <span class="p">[</span><span class="mh">0x45</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x19\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* RESET_B3_RESP */</span> <span class="p">[</span><span class="mh">0x46</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* CONNECT_B3_T90_ACTIVE_RESP */</span> <span class="p">[</span><span class="mh">0x47</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x01</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="cm">/* MANUFACTURER_RESP */</span> <span class="p">[</span><span class="mh">0x4e</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x03\x2a\x15\x21\x29\x01</span><span class="s">&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------*/</span>

<span class="cp">#define byteTLcpy(x, y)         *(u8 *)(x) = *(u8 *)(y);</span>
<span class="cp">#define wordTLcpy(x, y)         *(u16 *)(x) = *(u16 *)(y);</span>
<span class="cp">#define dwordTLcpy(x, y)        memcpy(x, y, 4);</span>
<span class="cp">#define structTLcpy(x, y, l)    memcpy(x, y, l)</span>
<span class="cp">#define structTLcpyovl(x, y, l) memmove(x, y, l)</span>

<span class="cp">#define byteTRcpy(x, y)         *(u8 *)(y) = *(u8 *)(x);</span>
<span class="cp">#define wordTRcpy(x, y)         *(u16 *)(y) = *(u16 *)(x);</span>
<span class="cp">#define dwordTRcpy(x, y)        memcpy(y, x, 4);</span>
<span class="cp">#define structTRcpy(x, y, l)    memcpy(y, x, l)</span>
<span class="cp">#define structTRcpyovl(x, y, l) memmove(y, x, l)</span>

<span class="cm">/*-------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">command_2_index</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="mh">0x9</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="mh">0x9</span> <span class="o">+</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x9</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------*/</span>
<span class="cp">#define TYP (cdef[cmsg-&gt;par[cmsg-&gt;p]].typ)</span>
<span class="cp">#define OFF (((u8 *)cmsg) + cdef[cmsg-&gt;par[cmsg-&gt;p]].off)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">jumpcstruct</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">layer</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">layer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">layer</span><span class="p">;)</span> <span class="p">{</span>
		<span class="cm">/* $$$$$ assert (cmsg-&gt;p); */</span>
		<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">TYP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">_CMSTRUCT</span>:
			<span class="n">layer</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CEND</span>:
			<span class="n">layer</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*-------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pars_2_message</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">TYP</span> <span class="o">!=</span> <span class="n">_CEND</span><span class="p">;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">TYP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">_CBYTE</span>:
			<span class="n">byteTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CWORD</span>:
			<span class="n">wordTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CDWORD</span>:
			<span class="n">dwordTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CSTRUCT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">**</span><span class="p">)</span> <span class="n">OFF</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">_cstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">structTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">_cstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">**</span><span class="p">(</span><span class="n">_cstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span><span class="p">);</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">**</span><span class="p">(</span><span class="n">_cstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">_cstruct</span> <span class="n">s</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_cstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span><span class="p">;</span>
				<span class="n">structTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CMSTRUCT</span>:
<span class="cm">/*----- Metastruktur 0 -----*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_cmstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span> <span class="o">==</span> <span class="n">CAPI_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
				<span class="n">jumpcstruct</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cm">/*----- Metastruktur wird composed -----*/</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">_l</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="n">_ls</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">pars_2_message</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
				<span class="n">_ls</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">-</span> <span class="n">_l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_ls</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span>
					<span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">_l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">_ls</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">structTLcpyovl</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">_l</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">_l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_ls</span><span class="p">);</span>
					<span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">_l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
					<span class="n">wordTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">_l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_ls</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * capi_cmsg2message() - assemble CAPI 2.0 message from _cmsg structure</span>
<span class="cm"> * @cmsg:	_cmsg structure</span>
<span class="cm"> * @msg:	buffer for assembled message</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: 0 for success</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="nf">capi_cmsg2message</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">cpars</span><span class="p">[</span><span class="n">command_2_index</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">)];</span>

	<span class="n">pars_2_message</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>

	<span class="n">wordTLcpy</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">);</span>
	<span class="n">byteTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">byteTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">);</span>
	<span class="n">wordTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">ApplId</span><span class="p">);</span>
	<span class="n">wordTLcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Messagenumber</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">message_2_pars</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">TYP</span> <span class="o">!=</span> <span class="n">_CEND</span><span class="p">;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">TYP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">_CBYTE</span>:
			<span class="n">byteTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CWORD</span>:
			<span class="n">wordTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CDWORD</span>:
			<span class="n">dwordTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CSTRUCT</span>:
			<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">**</span><span class="p">)</span> <span class="n">OFF</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CMSTRUCT</span>:
<span class="cm">/*----- Metastruktur 0 -----*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">_cmstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span> <span class="o">=</span> <span class="n">CAPI_DEFAULT</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
				<span class="n">jumpcstruct</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="n">_l</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">_cmstruct</span> <span class="o">*</span><span class="p">)</span> <span class="n">OFF</span> <span class="o">=</span> <span class="n">CAPI_COMPOSE</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">_l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">?</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">:</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">message_2_pars</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * capi_message2cmsg() - disassemble CAPI 2.0 message into _cmsg structure</span>
<span class="cm"> * @cmsg:	_cmsg structure</span>
<span class="cm"> * @msg:	buffer for assembled message</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: 0 for success</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="nf">capi_message2cmsg</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">));</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byteTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">byteTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">);</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">cpars</span><span class="p">[</span><span class="n">command_2_index</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">)];</span>

	<span class="n">message_2_pars</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>

	<span class="n">wordTRcpy</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">);</span>
	<span class="n">wordTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">ApplId</span><span class="p">);</span>
	<span class="n">wordTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Messagenumber</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * capi_cmsg_header() - initialize header part of _cmsg structure</span>
<span class="cm"> * @cmsg:	_cmsg structure</span>
<span class="cm"> * @_ApplId:	ApplID field value</span>
<span class="cm"> * @_Command:	Command field value</span>
<span class="cm"> * @_Subcommand:	Subcommand field value</span>
<span class="cm"> * @_Messagenumber:	Message Number field value</span>
<span class="cm"> * @_Controller:	Controller/PLCI/NCCI field value</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: 0 for success</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="nf">capi_cmsg_header</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">_ApplId</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">_Command</span><span class="p">,</span> <span class="n">u8</span> <span class="n">_Subcommand</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">_Messagenumber</span><span class="p">,</span> <span class="n">u32</span> <span class="n">_Controller</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">));</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">ApplId</span> <span class="o">=</span> <span class="n">_ApplId</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span> <span class="o">=</span> <span class="n">_Command</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span> <span class="o">=</span> <span class="n">_Subcommand</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Messagenumber</span> <span class="o">=</span> <span class="n">_Messagenumber</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrController</span> <span class="o">=</span> <span class="n">_Controller</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mnames</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ALERT_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;LISTEN_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;INFO_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FACILITY_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;SELECT_B_PROTOCOL_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_B3_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DATA_B3_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RESET_B3_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ALERT_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;LISTEN_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MANUFACTURER_REQ&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;INFO_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1b</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FACILITY_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;SELECT_B_PROTOCOL_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_B3_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x21</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DATA_B3_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x22</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RESET_B3_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x26</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x27</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_ACTIVE_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x28</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x2a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MANUFACTURER_CONF&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x2c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;INFO_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x2d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FACILITY_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x2f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_ACTIVE_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x31</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_B3_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x33</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DATA_B3_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x34</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RESET_B3_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x35</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_T90_ACTIVE_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x38</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x39</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_ACTIVE_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x3a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x3c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MANUFACTURER_IND&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x3e</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;INFO_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x3f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FACILITY_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x41</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x42</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_ACTIVE_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x43</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DISCONNECT_B3_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x45</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;DATA_B3_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x46</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;RESET_B3_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x47</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;CONNECT_B3_T90_ACTIVE_RESP&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x4e</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;MANUFACTURER_RESP&quot;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * capi_cmd2str() - convert CAPI 2.0 command/subcommand number to name</span>
<span class="cm"> * @cmd:	command number</span>
<span class="cm"> * @subcmd:	subcommand number</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: static string, NULL if command/subcommand unknown</span>
<span class="cm"> */</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">capi_cmd2str</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">subcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mnames</span><span class="p">[</span><span class="n">command_2_index</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">subcmd</span><span class="p">)];</span>
<span class="p">}</span>


<span class="cm">/*-------------------------------------------------------*/</span>

<span class="cp">#ifdef CONFIG_CAPI_TRACE</span>

<span class="cm">/*-------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pnames</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/*00 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/*01 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/*02 */</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="cm">/*03 */</span> <span class="s">&quot;Controller/PLCI/NCCI&quot;</span><span class="p">,</span>
	<span class="cm">/*04 */</span> <span class="s">&quot;AdditionalInfo&quot;</span><span class="p">,</span>
	<span class="cm">/*05 */</span> <span class="s">&quot;B1configuration&quot;</span><span class="p">,</span>
	<span class="cm">/*06 */</span> <span class="s">&quot;B1protocol&quot;</span><span class="p">,</span>
	<span class="cm">/*07 */</span> <span class="s">&quot;B2configuration&quot;</span><span class="p">,</span>
	<span class="cm">/*08 */</span> <span class="s">&quot;B2protocol&quot;</span><span class="p">,</span>
	<span class="cm">/*09 */</span> <span class="s">&quot;B3configuration&quot;</span><span class="p">,</span>
	<span class="cm">/*0a */</span> <span class="s">&quot;B3protocol&quot;</span><span class="p">,</span>
	<span class="cm">/*0b */</span> <span class="s">&quot;BC&quot;</span><span class="p">,</span>
	<span class="cm">/*0c */</span> <span class="s">&quot;BChannelinformation&quot;</span><span class="p">,</span>
	<span class="cm">/*0d */</span> <span class="s">&quot;BProtocol&quot;</span><span class="p">,</span>
	<span class="cm">/*0e */</span> <span class="s">&quot;CalledPartyNumber&quot;</span><span class="p">,</span>
	<span class="cm">/*0f */</span> <span class="s">&quot;CalledPartySubaddress&quot;</span><span class="p">,</span>
	<span class="cm">/*10 */</span> <span class="s">&quot;CallingPartyNumber&quot;</span><span class="p">,</span>
	<span class="cm">/*11 */</span> <span class="s">&quot;CallingPartySubaddress&quot;</span><span class="p">,</span>
	<span class="cm">/*12 */</span> <span class="s">&quot;CIPmask&quot;</span><span class="p">,</span>
	<span class="cm">/*13 */</span> <span class="s">&quot;CIPmask2&quot;</span><span class="p">,</span>
	<span class="cm">/*14 */</span> <span class="s">&quot;CIPValue&quot;</span><span class="p">,</span>
	<span class="cm">/*15 */</span> <span class="s">&quot;Class&quot;</span><span class="p">,</span>
	<span class="cm">/*16 */</span> <span class="s">&quot;ConnectedNumber&quot;</span><span class="p">,</span>
	<span class="cm">/*17 */</span> <span class="s">&quot;ConnectedSubaddress&quot;</span><span class="p">,</span>
	<span class="cm">/*18 */</span> <span class="s">&quot;Data32&quot;</span><span class="p">,</span>
	<span class="cm">/*19 */</span> <span class="s">&quot;DataHandle&quot;</span><span class="p">,</span>
	<span class="cm">/*1a */</span> <span class="s">&quot;DataLength&quot;</span><span class="p">,</span>
	<span class="cm">/*1b */</span> <span class="s">&quot;FacilityConfirmationParameter&quot;</span><span class="p">,</span>
	<span class="cm">/*1c */</span> <span class="s">&quot;Facilitydataarray&quot;</span><span class="p">,</span>
	<span class="cm">/*1d */</span> <span class="s">&quot;FacilityIndicationParameter&quot;</span><span class="p">,</span>
	<span class="cm">/*1e */</span> <span class="s">&quot;FacilityRequestParameter&quot;</span><span class="p">,</span>
	<span class="cm">/*1f */</span> <span class="s">&quot;FacilitySelector&quot;</span><span class="p">,</span>
	<span class="cm">/*20 */</span> <span class="s">&quot;Flags&quot;</span><span class="p">,</span>
	<span class="cm">/*21 */</span> <span class="s">&quot;Function&quot;</span><span class="p">,</span>
	<span class="cm">/*22 */</span> <span class="s">&quot;HLC&quot;</span><span class="p">,</span>
	<span class="cm">/*23 */</span> <span class="s">&quot;Info&quot;</span><span class="p">,</span>
	<span class="cm">/*24 */</span> <span class="s">&quot;InfoElement&quot;</span><span class="p">,</span>
	<span class="cm">/*25 */</span> <span class="s">&quot;InfoMask&quot;</span><span class="p">,</span>
	<span class="cm">/*26 */</span> <span class="s">&quot;InfoNumber&quot;</span><span class="p">,</span>
	<span class="cm">/*27 */</span> <span class="s">&quot;Keypadfacility&quot;</span><span class="p">,</span>
	<span class="cm">/*28 */</span> <span class="s">&quot;LLC&quot;</span><span class="p">,</span>
	<span class="cm">/*29 */</span> <span class="s">&quot;ManuData&quot;</span><span class="p">,</span>
	<span class="cm">/*2a */</span> <span class="s">&quot;ManuID&quot;</span><span class="p">,</span>
	<span class="cm">/*2b */</span> <span class="s">&quot;NCPI&quot;</span><span class="p">,</span>
	<span class="cm">/*2c */</span> <span class="s">&quot;Reason&quot;</span><span class="p">,</span>
	<span class="cm">/*2d */</span> <span class="s">&quot;Reason_B3&quot;</span><span class="p">,</span>
	<span class="cm">/*2e */</span> <span class="s">&quot;Reject&quot;</span><span class="p">,</span>
	<span class="cm">/*2f */</span> <span class="s">&quot;Useruserdata&quot;</span>
<span class="p">};</span>



<span class="cp">#include &lt;stdarg.h&gt;</span>

<span class="cm">/*-------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">bufprint</span><span class="p">(</span><span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">f</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* truncated, need bigger buffer */</span>
		<span class="kt">size_t</span> <span class="n">ns</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">nb</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">ns</span> <span class="o">-</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">)</span>
			<span class="n">ns</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">nb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cdebbuf_free</span><span class="p">(</span><span class="n">cdb</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">nb</span><span class="p">,</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">nb</span><span class="p">[</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">nb</span><span class="p">;</span>
		<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
		<span class="n">va_start</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">vsnprintf</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
		<span class="n">va_end</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">printstructlen</span><span class="p">(</span><span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">hex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">,</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="n">m</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hex</span><span class="p">)</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">);</span>
			<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">m</span><span class="p">);</span>
			<span class="n">hex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hex</span><span class="p">)</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;&lt;%02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">m</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">m</span><span class="p">);</span>
			<span class="n">hex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hex</span><span class="p">)</span>
		<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">printstruct</span><span class="p">(</span><span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">m</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdb</span> <span class="o">=</span> <span class="n">printstructlen</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------------------------------------*/</span>
<span class="cp">#define NAME (pnames[cmsg-&gt;par[cmsg-&gt;p]])</span>

<span class="k">static</span> <span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">protocol_message_2_pars</span><span class="p">(</span><span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">,</span> <span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">TYP</span> <span class="o">!=</span> <span class="n">_CEND</span><span class="p">;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slen</span> <span class="o">=</span> <span class="mi">29</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">level</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;  &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">TYP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">_CBYTE</span>:
			<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%-*s = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">));</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CWORD</span>:
			<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%-*s = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">));</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CDWORD</span>:
			<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%-*s = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">NAME</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">));</span>
			<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">_CSTRUCT</span>:
			<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%-*s = &quot;</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">NAME</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;default&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">printstruct</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">);</span>
			<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+=</span> <span class="mi">3</span> <span class="o">+</span> <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">_CMSTRUCT</span>:
<span class="cm">/*----- Metastruktur 0 -----*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%-*s = default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">NAME</span><span class="p">);</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="o">++</span><span class="p">;</span>
				<span class="n">jumpcstruct</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">NAME</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="n">_l</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span><span class="p">;</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%-*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slen</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="n">_l</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span> <span class="o">?</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">:</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">cdb</span> <span class="o">=</span> <span class="n">protocol_message_2_pars</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cdb</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*-------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">g_debbuf</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="n">g_debbuf_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">_cmsg</span> <span class="o">*</span><span class="n">g_cmsg</span><span class="p">;</span>

<span class="k">static</span> <span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">cdebbuf_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_debbuf_lock</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">cdb</span> <span class="o">=</span> <span class="n">g_debbuf</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cdb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">_cdebbuf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">CDEBUG_SIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cdb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CDEBUG_SIZE</span><span class="p">;</span>
<span class="nl">init:</span>
	<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">cdb</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cdb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cdebbuf_free() - free CAPI debug buffer</span>
<span class="cm"> * @cdb:	buffer to free</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">cdebbuf_free</span><span class="p">(</span><span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cdb</span> <span class="o">==</span> <span class="n">g_debbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">g_debbuf_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cdb</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cdb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * capi_message2str() - format CAPI 2.0 message for printing</span>
<span class="cm"> * @msg:	CAPI 2.0 message</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a CAPI debug buffer and fills it with a printable representation</span>
<span class="cm"> * of the CAPI 2.0 message in @msg.</span>
<span class="cm"> * Return value: allocated debug buffer, NULL on error</span>
<span class="cm"> * The returned buffer should be freed by a call to cdebbuf_free() after use.</span>
<span class="cm"> */</span>

<span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">capi_message2str</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">;</span>
	<span class="n">_cmsg</span>	<span class="o">*</span><span class="n">cmsg</span><span class="p">;</span>

	<span class="n">cdb</span> <span class="o">=</span> <span class="n">cdebbuf_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cdb</span> <span class="o">==</span> <span class="n">g_debbuf</span><span class="p">))</span>
		<span class="n">cmsg</span> <span class="o">=</span> <span class="n">g_cmsg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmsg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">cmsg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdebbuf_free</span><span class="p">(</span><span class="n">cdb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byteTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">);</span>
	<span class="n">byteTRcpy</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">);</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">par</span> <span class="o">=</span> <span class="n">cpars</span><span class="p">[</span><span class="n">command_2_index</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">)];</span>

	<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%-26s ID=%03d #0x%04x LEN=%04d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mnames</span><span class="p">[</span><span class="n">command_2_index</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">)],</span>
		       <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
		       <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span>
		       <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">cdb</span> <span class="o">=</span> <span class="n">protocol_message_2_pars</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmsg</span> <span class="o">!=</span> <span class="n">g_cmsg</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * capi_cmsg2str() - format _cmsg structure for printing</span>
<span class="cm"> * @cmsg:	_cmsg structure</span>
<span class="cm"> *</span>
<span class="cm"> * Allocates a CAPI debug buffer and fills it with a printable representation</span>
<span class="cm"> * of the CAPI 2.0 message stored in @cmsg by a previous call to</span>
<span class="cm"> * capi_cmsg2message() or capi_message2cmsg().</span>
<span class="cm"> * Return value: allocated debug buffer, NULL on error</span>
<span class="cm"> * The returned buffer should be freed by a call to cdebbuf_free() after use.</span>
<span class="cm"> */</span>

<span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">capi_cmsg2str</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* no message */</span>
	<span class="n">cdb</span> <span class="o">=</span> <span class="n">cdebbuf_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cdb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">l</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cdb</span> <span class="o">=</span> <span class="n">bufprint</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="s">&quot;%s ID=%03d #0x%04x LEN=%04d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mnames</span><span class="p">[</span><span class="n">command_2_index</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">)],</span>
		       <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
		       <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span>
		       <span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">cdb</span> <span class="o">=</span> <span class="n">protocol_message_2_pars</span><span class="p">(</span><span class="n">cdb</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cdb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">cdebug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">g_cmsg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">_cmsg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_cmsg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">g_debbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">_cdebbuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_debbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">g_cmsg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">CDEBUG_GSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">g_cmsg</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">g_debbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">CDEBUG_GSIZE</span><span class="p">;</span>
	<span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cdebug_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">g_debbuf</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">g_debbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">g_debbuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">g_cmsg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_CAPI_TRACE */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">_cdebbuf</span> <span class="n">g_debbuf</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;CONFIG_CAPI_TRACE not enabled&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">capi_message2str</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">g_debbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">_cdebbuf</span> <span class="o">*</span><span class="nf">capi_cmsg2str</span><span class="p">(</span><span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">g_debbuf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cdebbuf_free</span><span class="p">(</span><span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">cdebug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cdebug_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">cdebbuf_free</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">capi_cmsg2message</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">capi_message2cmsg</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">capi_cmsg_header</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">capi_cmd2str</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">capi_cmsg2str</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">capi_message2str</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">capi_info2str</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
