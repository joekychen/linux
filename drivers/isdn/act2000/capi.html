<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › act2000 › capi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>capi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: capi.c,v 1.9.6.2 2001/09/23 22:24:32 kai Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * ISDN lowlevel-module for the IBM ISDN-S0 Active 2000.</span>
<span class="cm"> * CAPI encoder/decoder</span>
<span class="cm"> *</span>
<span class="cm"> * Author       Fritz Elfert</span>
<span class="cm"> * Copyright    by Fritz Elfert      &lt;fritz@isdn4linux.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Friedemann Baitinger and IBM Germany</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;act2000.h&quot;</span>
<span class="cp">#include &quot;capi.h&quot;</span>

<span class="k">static</span> <span class="n">actcapi_msgdsc</span> <span class="n">valid_msg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{{</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;DATA_B3_IND&quot;</span><span class="p">},</span>       <span class="cm">/* DATA_B3_IND/CONF must be first because of speed!!! */</span>
	<span class="p">{{</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;DATA_B3_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;CONNECT_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;CONNECT_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;CONNECT_INFO_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;CONNECT_ACTIVE_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;LISTEN_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;GET_PARAMS_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;INFO_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;INFO_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;DATA_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;DATA_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;SELECT_B2_PROTOCOL_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;SELECT_B3_PROTOCOL_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;LISTEN_B3_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;CONNECT_B3_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;CONNECT_B3_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;CONNECT_B3_ACTIVE_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_B3_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_B3_IND&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;GET_B3_PARAMS_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;RESET_B3_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;RESET_B3_IND&quot;</span><span class="p">},</span>
	<span class="cm">/* {{ 0x87, 0x02, &quot;HANDSET_IND&quot;}, not implemented */</span>
	<span class="p">{{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span> <span class="s">&quot;MANUFACTURER_CONF&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span> <span class="s">&quot;MANUFACTURER_IND&quot;</span><span class="p">},</span>
<span class="cp">#ifdef DEBUG_MSG</span>
	<span class="cm">/* Requests */</span>
	<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;RESET_B3_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;LISTEN_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;GET_PARAMS_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;INFO_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;DATA_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;CONNECT_INFO_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;SELECT_B2_PROTOCOL_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;SELECT_B3_PROTOCOL_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;LISTEN_B3_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;CONNECT_B3_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_B3_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;GET_B3_PARAMS_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;DATA_B3_REQ&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="s">&quot;MANUFACTURER_REQ&quot;</span><span class="p">},</span>
	<span class="cm">/* Responses */</span>
	<span class="p">{{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;RESET_B3_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;CONNECT_ACTIVE_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;INFO_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;DATA_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;CONNECT_B3_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;CONNECT_B3_ACTIVE_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;DISCONNECT_B3_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;DATA_B3_RESP&quot;</span><span class="p">},</span>
	<span class="p">{{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span> <span class="s">&quot;MANUFACTURER_RESP&quot;</span><span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">},</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>
<span class="cp">#define num_valid_imsg 27 </span><span class="cm">/* MANUFACTURER_IND */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Check for a valid incoming CAPI message.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *   0 = Invalid message</span>
<span class="cm"> *   1 = Valid message, no B-Channel-data</span>
<span class="cm"> *   2 = Valid message, B-Channel-data</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">actcapi_chkhdr</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">actcapi_msghdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">applicationID</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_valid_imsg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">valid_msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="n">valid_msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ACTCAPI_MKHDR(l, c, s) {				\</span>
<span class="cp">		skb = alloc_skb(l + 8, GFP_ATOMIC);		\</span>
<span class="cp">		if (skb) {					\</span>
<span class="cp">			m = (actcapi_msg *)skb_put(skb, l + 8); \</span>
<span class="cp">			m-&gt;hdr.len = l + 8;			\</span>
<span class="cp">			m-&gt;hdr.applicationID = 1;		\</span>
<span class="cp">			m-&gt;hdr.cmd.cmd = c;			\</span>
<span class="cp">			m-&gt;hdr.cmd.subcmd = s;			\</span>
<span class="cp">			m-&gt;hdr.msgnum = actcapi_nextsmsg(card); \</span>
<span class="cp">		} else m = NULL;				\</span>
<span class="cp">	}</span>

<span class="cp">#define ACTCAPI_CHKSKB if (!skb) {					\</span>
<span class="cp">		printk(KERN_WARNING &quot;actcapi: alloc_skb failed\n&quot;);	\</span>
<span class="cp">		return;							\</span>
<span class="cp">	}</span>

<span class="cp">#define ACTCAPI_QUEUE_TX {				\</span>
<span class="cp">		actcapi_debug_msg(skb, 1);		\</span>
<span class="cp">		skb_queue_tail(&amp;card-&gt;sndq, skb);	\</span>
<span class="cp">		act2000_schedule_tx(card);		\</span>
<span class="cp">	}</span>

<span class="kt">int</span>
<span class="nf">actcapi_listen_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">eazmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACT2000_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">eazmask</span> <span class="o">|=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">eazmask</span><span class="p">;</span>
	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;actcapi: alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_req</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_req</span><span class="p">.</span><span class="n">infomask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span> <span class="cm">/* All information */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_req</span><span class="p">.</span><span class="n">eazmask</span> <span class="o">=</span> <span class="n">eazmask</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_req</span><span class="p">.</span><span class="n">simask</span> <span class="o">=</span> <span class="p">(</span><span class="n">eazmask</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x86</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* All SI&#39;s  */</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">actcapi_connect_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phone</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="n">eaz</span><span class="p">,</span> <span class="kt">int</span> <span class="n">si1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">si2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">((</span><span class="mi">11</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">phone</span><span class="p">)),</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;actcapi: alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">bchan</span> <span class="o">=</span> <span class="mh">0x83</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">infomask</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="n">si1</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="n">si2</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">eaz</span> <span class="o">=</span> <span class="n">eaz</span> <span class="o">?</span> <span class="n">eaz</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">tnp</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_req</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">phone</span><span class="p">));</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">callref</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msgnum</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_connect_b3_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_req</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">.</span><span class="n">modulo</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set net type (1TR6) or (EDSS1)</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">actcapi_manufacturer_req_net</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;actcapi: alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_net</span><span class="p">.</span><span class="n">manuf_msg</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_net</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_net</span><span class="p">.</span><span class="n">nettype</span> <span class="o">=</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;act2000 %s: D-channel protocol now %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;euro&quot;</span> <span class="o">:</span> <span class="s">&quot;1tr6&quot;</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">&amp;=</span>
		<span class="o">~</span><span class="p">(</span><span class="n">ISDN_FEATURE_P_UNKNOWN</span> <span class="o">|</span> <span class="n">ISDN_FEATURE_P_EURO</span> <span class="o">|</span> <span class="n">ISDN_FEATURE_P_1TR6</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span>
		<span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span> <span class="o">?</span> <span class="n">ISDN_FEATURE_P_EURO</span> <span class="o">:</span> <span class="n">ISDN_FEATURE_P_1TR6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch V.42 on or off</span>
<span class="cm"> */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">int</span>
<span class="c">actcapi_manufacturer_req_v42(act2000_card *card, ulong arg)</span>
<span class="c">{</span>
<span class="c">	actcapi_msg *m;</span>
<span class="c">	struct sk_buff *skb;</span>

<span class="c">	ACTCAPI_MKHDR(8, 0xff, 0x00);</span>
<span class="c">	if (!skb) {</span>

<span class="c">		printk(KERN_WARNING &quot;actcapi: alloc_skb failed\n&quot;);</span>
<span class="c">		return -ENOMEM;</span>
<span class="c">	}</span>
<span class="c">	m-&gt;msg.manufacturer_req_v42.manuf_msg = 0x10;</span>
<span class="c">	m-&gt;msg.manufacturer_req_v42.controller = 0;</span>
<span class="c">	m-&gt;msg.manufacturer_req_v42.v42control = (arg ? 1 : 0);</span>
<span class="c">	ACTCAPI_QUEUE_TX;</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif  /*  0  */</span>

<span class="cm">/*</span>
<span class="cm"> * Set error-handler</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">actcapi_manufacturer_req_errh</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;actcapi: alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_err</span><span class="p">.</span><span class="n">manuf_msg</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_err</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set MSN-Mapping.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">actcapi_manufacturer_req_msn</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msn_entry</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">msn_list</span><span class="p">;</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;actcapi: alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_msn</span><span class="p">.</span><span class="n">manuf_msg</span> <span class="o">=</span> <span class="mh">0x13</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_msn</span><span class="p">.</span><span class="n">controller</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_msn</span><span class="p">.</span><span class="n">msnmap</span><span class="p">.</span><span class="n">eaz</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">eaz</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_msn</span><span class="p">.</span><span class="n">msnmap</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_req_msn</span><span class="p">.</span><span class="n">msnmap</span><span class="p">.</span><span class="n">msn</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">actcapi_select_b2_protocol_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">l2prot</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_TRANS</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">dlen</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">dlen</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75UI</span>:
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75BUI</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">dlen</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">laa</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">lab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">win</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">.</span><span class="n">modulo</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_select_b3_protocol_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_req</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_req</span><span class="p">.</span><span class="n">ncpd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_req</span><span class="p">.</span><span class="n">ncpd</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">l3prot</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L3_TRANS</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_req</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_req</span><span class="p">.</span><span class="n">ncpd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_req</span><span class="p">.</span><span class="n">ncpd</span><span class="p">.</span><span class="n">modulo</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_listen_b3_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_b3_req</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_disconnect_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_req</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_req</span><span class="p">.</span><span class="n">cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">actcapi_disconnect_b3_req</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_req</span><span class="p">.</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">));</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_req</span><span class="p">.</span><span class="n">ncpi</span><span class="p">.</span><span class="n">modulo</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_BHWAIT</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">actcapi_connect_resp</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">cause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_resp</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_resp</span><span class="p">.</span><span class="n">rejectcause</span> <span class="o">=</span> <span class="n">cause</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_IWAIT</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_connect_active_resp</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_resp</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">==</span> <span class="n">ACT2000_STATE_IWAIT</span><span class="p">)</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_IBWAIT</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_connect_b3_resp</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">rejectcause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">((</span><span class="n">rejectcause</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">17</span><span class="p">),</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_resp</span><span class="p">.</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_resp</span><span class="p">.</span><span class="n">rejectcause</span> <span class="o">=</span> <span class="n">rejectcause</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rejectcause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_resp</span><span class="p">.</span><span class="n">ncpi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_resp</span><span class="p">.</span><span class="n">ncpi</span><span class="p">));</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_resp</span><span class="p">.</span><span class="n">ncpi</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_resp</span><span class="p">.</span><span class="n">ncpi</span><span class="p">.</span><span class="n">modulo</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_BWAIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_connect_b3_active_resp</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_active_resp</span><span class="p">.</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_ACTIVE</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_info_resp</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">info_resp</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_disconnect_b3_resp</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_resp</span><span class="p">.</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ncci</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_disconnect_resp</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ACTCAPI_MKHDR</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">ACTCAPI_CHKSKB</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_resp</span><span class="p">.</span><span class="n">plci</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">plci</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">new_plci</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACT2000_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span> <span class="o">==</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">plci</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_plci</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">plci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACT2000_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plci</span> <span class="o">==</span> <span class="n">plci</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_ncci</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">ncci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACT2000_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ncci</span> <span class="o">==</span> <span class="n">ncci</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">find_dialing</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">callref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ACT2000_BCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">callref</span> <span class="o">==</span> <span class="n">callref</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">==</span> <span class="n">ACT2000_STATE_OCALL</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">actcapi_data_b3_ind</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">__u16</span> <span class="n">plci</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">controller</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">blocknr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">actcapi_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">EVAL_NCCI</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_ind</span><span class="p">.</span><span class="n">fakencci</span><span class="p">,</span> <span class="n">plci</span><span class="p">,</span> <span class="n">controller</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">find_ncci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ncci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">!=</span> <span class="n">ACT2000_STATE_ACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">plci</span> <span class="o">!=</span> <span class="n">plci</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">blocknr</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_ind</span><span class="p">.</span><span class="n">blocknr</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">19</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">rcvcallb_skb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;actcapi: alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">actcapi_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">applicationID</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msgnum</span> <span class="o">=</span> <span class="n">actcapi_nextsmsg</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_resp</span><span class="p">.</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">ncci</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_resp</span><span class="p">.</span><span class="n">blocknr</span> <span class="o">=</span> <span class="n">blocknr</span><span class="p">;</span>
	<span class="n">ACTCAPI_QUEUE_TX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Walk over ackq, unlink DATA_B3_REQ from it, if</span>
<span class="cm"> * ncci and blocknr are matching.</span>
<span class="cm"> * Decrement queued-bytes counter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">handle_ack</span><span class="p">(</span><span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">act2000_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">blocknr</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ackq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;act2000: handle_ack nothing found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">actcapi_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">fakencci</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">ncci</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">blocknr</span> <span class="o">==</span> <span class="n">blocknr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* found corresponding DATA_B3_REQ */</span>
			<span class="n">skb_unlink</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ackq</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">queued</span> <span class="o">-=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">datalen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_req</span><span class="p">.</span><span class="n">datalen</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">queued</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">((</span><span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">skb</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* reached end of queue */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;act2000: handle_ack nothing found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">actcapi_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">act2000_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">act2000_card</span><span class="p">,</span> <span class="n">rcv_tq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">ccmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">act2000_chan</span> <span class="o">*</span><span class="n">ctmp</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">170</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcvq</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">actcapi_debug_msg</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">actcapi_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">ccmd</span> <span class="o">=</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcmd</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ccmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x8602</span>:
			<span class="cm">/* DATA_B3_IND */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">actcapi_data_b3_ind</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8601</span>:
			<span class="cm">/* DATA_B3_CONF */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_ncci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_conf</span><span class="p">.</span><span class="n">ncci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">==</span> <span class="n">ACT2000_STATE_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_conf</span><span class="p">.</span><span class="n">info</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;act2000: DATA_B3_CONF: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_conf</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
				<span class="n">len</span> <span class="o">=</span> <span class="n">handle_ack</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span>
						 <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_conf</span><span class="p">.</span><span class="n">blocknr</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BSENT</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0201</span>:
			<span class="cm">/* CONNECT_CONF */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_dialing</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msgnum</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_conf</span><span class="p">.</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_OWAIT</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">plci</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0202</span>:
			<span class="cm">/* CONNECT_IND */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">new_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ctmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">act2000_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
				<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">plci</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">;</span>
				<span class="n">actcapi_connect_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span> <span class="cm">/* All Card-Cannels busy */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_ICALL</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_ICALL</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">si1</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">si2</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">ISDN_PTYPE_EURO</span><span class="p">)</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span>
					       <span class="n">act2000_find_eaz</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">eaz</span><span class="p">));</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">eaz</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">));</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">num</span><span class="p">,</span>
				       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">plan</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">tnp</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">screen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">actcapi_connect_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="mh">0x15</span><span class="p">);</span> <span class="cm">/* Reject Call */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0302</span>:
			<span class="cm">/* CONNECT_ACTIVE_IND */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_active_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_IWAIT</span>:
					<span class="n">actcapi_connect_active_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">]);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_OWAIT</span>:
					<span class="n">actcapi_connect_active_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">]);</span>
					<span class="n">actcapi_select_b2_protocol_req</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">]);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8202</span>:
			<span class="cm">/* CONNECT_B3_IND */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">==</span> <span class="n">ACT2000_STATE_IBWAIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_ind</span><span class="p">.</span><span class="n">ncci</span><span class="p">;</span>
				<span class="n">actcapi_connect_b3_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ctmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">act2000_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
				<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_ind</span><span class="p">.</span><span class="n">ncci</span><span class="p">;</span>
				<span class="n">actcapi_connect_b3_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span> <span class="cm">/* All Card-Cannels busy */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8302</span>:
			<span class="cm">/* CONNECT_B3_ACTIVE_IND */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_ncci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_active_ind</span><span class="p">.</span><span class="n">ncci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">==</span> <span class="n">ACT2000_STATE_BWAIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">actcapi_connect_b3_active_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">]);</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BCONN</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8402</span>:
			<span class="cm">/* DISCONNECT_B3_IND */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_ncci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_ind</span><span class="p">.</span><span class="n">ncci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ctmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
				<span class="n">actcapi_disconnect_b3_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_ACTIVE</span>:
					<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_DHWAIT2</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_BHWAIT2</span>:
					<span class="n">actcapi_disconnect_req</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">);</span>
					<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_DHWAIT</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_BHUP</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0402</span>:
			<span class="cm">/* DISCONNECT_IND */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ctmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
				<span class="n">actcapi_disconnect_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">);</span>
				<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ctmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">act2000_chan</span> <span class="o">*</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
				<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">plci</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">;</span>
				<span class="n">actcapi_disconnect_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4001</span>:
			<span class="cm">/* SELECT_B2_PROTOCOL_CONF */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_ICALL</span>:
				<span class="k">case</span> <span class="n">ACT2000_STATE_OWAIT</span>:
					<span class="n">ctmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_conf</span><span class="p">.</span><span class="n">info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">actcapi_select_b3_protocol_req</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">);</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8001</span>:
			<span class="cm">/* SELECT_B3_PROTOCOL_CONF */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_ICALL</span>:
				<span class="k">case</span> <span class="n">ACT2000_STATE_OWAIT</span>:
					<span class="n">ctmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_conf</span><span class="p">.</span><span class="n">info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">actcapi_listen_b3_req</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">);</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8101</span>:
			<span class="cm">/* LISTEN_B3_CONF */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_b3_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_ICALL</span>:
					<span class="n">ctmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_b3_conf</span><span class="p">.</span><span class="n">info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">actcapi_connect_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ACT2000_STATE_OWAIT</span>:
					<span class="n">ctmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_b3_conf</span><span class="p">.</span><span class="n">info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">actcapi_connect_b3_req</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctmp</span><span class="p">);</span>
						<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_OBWAIT</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DCONN</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8201</span>:
			<span class="cm">/* CONNECT_B3_CONF */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">==</span> <span class="n">ACT2000_STATE_OBWAIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ctmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_conf</span><span class="p">.</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_NULL</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_DHUP</span><span class="p">;</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">ncci</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_conf</span><span class="p">.</span><span class="n">ncci</span><span class="p">;</span>
					<span class="n">ctmp</span><span class="o">-&gt;</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_BWAIT</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x8401</span>:
			<span class="cm">/* DISCONNECT_B3_CONF */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_ncci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">disconnect_b3_conf</span><span class="p">.</span><span class="n">ncci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">==</span> <span class="n">ACT2000_STATE_BHWAIT</span><span class="p">))</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">fsm_state</span> <span class="o">=</span> <span class="n">ACT2000_STATE_BHWAIT2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0702</span>:
			<span class="cm">/* INFO_IND */</span>
			<span class="n">chan</span> <span class="o">=</span> <span class="n">find_plci</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">info_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* TODO: Eval Charging info / cause */</span>
				<span class="n">actcapi_info_resp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">bch</span><span class="p">[</span><span class="n">chan</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0401</span>:
			<span class="cm">/* LISTEN_CONF */</span>
		<span class="k">case</span> <span class="mh">0x0501</span>:
			<span class="cm">/* LISTEN_CONF */</span>
		<span class="k">case</span> <span class="mh">0xff01</span>:
			<span class="cm">/* MANUFACTURER_CONF */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xff02</span>:
			<span class="cm">/* MANUFACTURER_IND */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manuf_msg</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_ind_err</span><span class="p">.</span><span class="n">errstring</span><span class="p">,</span>
					<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_ind_err</span><span class="p">.</span><span class="n">errcode</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;act2000: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;act2000: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;INFO: Trace buffer con&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span> <span class="o">||</span>
					    <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">&quot;INFO: Compile Date/Tim&quot;</span><span class="p">,</span> <span class="mi">22</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ACT2000_FLAGS_RUNNING</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_STAT_RUN</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">;</span>
						<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">actcapi_manufacturer_req_net</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
						<span class="n">actcapi_manufacturer_req_msn</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
						<span class="n">actcapi_listen_req</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">.</span><span class="n">statcallb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;act2000: UNHANDLED Message %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ccmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG_MSG</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_debug_caddr</span><span class="p">(</span><span class="n">actcapi_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Alen  = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Atnp  = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">tnp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Anum  = &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_debug_ncpi</span><span class="p">(</span><span class="n">actcapi_ncpi</span> <span class="o">*</span><span class="n">ncpi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.lic = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">lic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.hic = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">hic</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.ltc = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">ltc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.htc = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.loc = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">loc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.hoc = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">hoc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ncpi.mod = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ncpi</span><span class="o">-&gt;</span><span class="n">modulo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">actcapi_debug_dlpd</span><span class="p">(</span><span class="n">actcapi_dlpd</span> <span class="o">*</span><span class="n">dlpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; dlpd.len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; dlpd.dlen   = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; dlpd.laa    = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">laa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; dlpd.lab    = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">lab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; dlpd.modulo = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">modulo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; dlpd.win    = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dlpd</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG_DUMP_SKB</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dump: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dump: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span>
<span class="nf">actcapi_debug_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">actcapi_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">actcapi_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">170</span><span class="p">];</span>

<span class="cp">#ifndef DEBUG_DATA_MSG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mh">0x86</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="s">&quot;INVALID&quot;</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_DUMP_SKB</span>
	<span class="n">dump_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">valid_msg</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">valid_msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="n">valid_msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcmd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">descr</span> <span class="o">=</span> <span class="n">valid_msg</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">description</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s %s msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">?</span> <span class="s">&quot;Outgoing&quot;</span> <span class="o">:</span> <span class="s">&quot;Incoming&quot;</span><span class="p">,</span> <span class="n">descr</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; ApplID = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">applicationID</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Len    = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; MsgNum = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msgnum</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Cmd    = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SubCmd = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">.</span><span class="n">subcmd</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* DATA B3 IND */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; BLOCK = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">data_b3_ind</span><span class="p">.</span><span class="n">blocknr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* CONNECT CONF */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Info = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_conf</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* CONNECT IND */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Contr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">controller</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SI1   = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">si1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SI2   = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">si2</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; EAZ   = &#39;%c&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">eaz</span><span class="p">);</span>
		<span class="n">actcapi_debug_caddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_ind</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* CONNECT ACTIVE IND */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_active_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">actcapi_debug_caddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_active_ind</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="cm">/* LISTEN CONF */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Contr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_conf</span><span class="p">.</span><span class="n">controller</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Info = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_conf</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="cm">/* INFO IND */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">info_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Imsk = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">info_ind</span><span class="p">.</span><span class="n">nr</span><span class="p">.</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">info_ind</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">display</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; D = &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">14</span>:
		<span class="cm">/* SELECT B2 PROTOCOL CONF */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Info = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_conf</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="cm">/* SELECT B3 PROTOCOL CONF */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Info = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b3_protocol_conf</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="cm">/* LISTEN B3 CONF */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_b3_conf</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Info = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_b3_conf</span><span class="p">.</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">18</span>:
		<span class="cm">/* CONNECT B3 IND */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; NCCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_ind</span><span class="p">.</span><span class="n">ncci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_ind</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">actcapi_debug_ncpi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_ind</span><span class="p">.</span><span class="n">ncpi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">19</span>:
		<span class="cm">/* CONNECT B3 ACTIVE IND */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; NCCI = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_active_ind</span><span class="p">.</span><span class="n">ncci</span><span class="p">);</span>
		<span class="n">actcapi_debug_ncpi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_b3_active_ind</span><span class="p">.</span><span class="n">ncpi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">26</span>:
		<span class="cm">/* MANUFACTURER IND */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Mmsg = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_ind_err</span><span class="p">.</span><span class="n">manuf_msg</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_ind_err</span><span class="p">.</span><span class="n">manuf_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Contr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_ind_err</span><span class="p">.</span><span class="n">controller</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Code = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_ind_err</span><span class="p">.</span><span class="n">errcode</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">manufacturer_ind_err</span><span class="p">.</span><span class="n">errstring</span><span class="p">,</span>
				<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Emsg = &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">30</span>:
		<span class="cm">/* LISTEN REQ */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Imsk = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_req</span><span class="p">.</span><span class="n">infomask</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Emsk = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_req</span><span class="p">.</span><span class="n">eazmask</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; Smsk = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">listen_req</span><span class="p">.</span><span class="n">simask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">35</span>:
		<span class="cm">/* SELECT_B2_PROTOCOL_REQ */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI  = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; prot  = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;No dlpd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">actcapi_debug_dlpd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">select_b2_protocol_req</span><span class="p">.</span><span class="n">dlpd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44</span>:
		<span class="cm">/* CONNECT RESP */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI  = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_resp</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; CAUSE = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_resp</span><span class="p">.</span><span class="n">rejectcause</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">45</span>:
		<span class="cm">/* CONNECT ACTIVE RESP */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; PLCI  = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">connect_active_resp</span><span class="p">.</span><span class="n">plci</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
