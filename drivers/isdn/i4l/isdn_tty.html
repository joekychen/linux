<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › i4l › isdn_tty.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isdn_tty.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux ISDN subsystem, tty functions and AT-command emulator (linklevel).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1994-1999  by Fritz Elfert (fritz@isdn4linux.de)</span>
<span class="cm"> * Copyright 1995,96    by Thinking Objects Software GmbH Wuerzburg</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#undef ISDN_TTY_STAT_DEBUG</span>

<span class="cp">#include &lt;linux/isdn.h&gt;</span>
<span class="cp">#include &lt;linux/serial.h&gt; </span><span class="cm">/* ASYNC_* flags */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &quot;isdn_common.h&quot;</span>
<span class="cp">#include &quot;isdn_tty.h&quot;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
<span class="cp">#include &quot;isdn_audio.h&quot;</span>
<span class="cp">#define VBUF 0x3e0</span>
<span class="cp">#define VBUFX (VBUF/16)</span>
<span class="cp">#endif</span>

<span class="cp">#define FIX_FILE_TRANSFER</span>
<span class="cp">#define	DUMMY_HAYES_AT</span>

<span class="cm">/* Prototypes */</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">modem_info_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_tty_edit_at</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_tty_check_esc</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="p">,</span> <span class="n">u_char</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="p">,</span> <span class="n">u_long</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_tty_cmd_ATA</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_tty_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_tty_countDLE</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Leave this unchanged unless you know what you do! */</span>
<span class="cp">#define MODEM_PARANOIA_CHECK</span>
<span class="cp">#define MODEM_DO_RESTART</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bit2si</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">si2bit</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>

<span class="cm">/* isdn_tty_try_read() is called from within isdn_tty_rcv_skb()</span>
<span class="cm"> * to stuff incoming data directly into a tty&#39;s flip-buffer. This</span>
<span class="cm"> * is done to speed up tty-receiving if the receive-queue is empty.</span>
<span class="cm"> * This routine MUST be called with interrupts off.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *  1 = Success</span>
<span class="cm"> *  0 = Failure, data has to be buffered and later processed by</span>
<span class="cm"> *      isdn_tty_readmodem().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_try_read</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">last</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">UART_MCR_RTS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="o">+</span> <span class="n">ISDN_AUDIO_SKB_DLECOUNT</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ISDN_AUDIO_SKB_DLECOUNT</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dp</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span>
				<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">DLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="o">*</span><span class="n">dp</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">dp</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span>
			<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">DLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">last</span> <span class="o">=</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tty_insert_flip_string</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">last</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CPPP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CPPP</span><span class="p">)</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="n">TTY_NORMAL</span><span class="p">);</span>
	<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* isdn_tty_readmodem() is called periodically from within timer-interrupt.</span>
<span class="cm"> * It tries getting received data from the receive queue an stuff it into</span>
<span class="cm"> * the tty&#39;s flip-buffer.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_tty_readmodem</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">resched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">midx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">midx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">midx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">midx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="n">isdn_audio_eval_dtmf</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="n">isdn_audio_eval_silence</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;</span> <span class="n">UART_MCR_RTS</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* CISCO AsyncPPP Hack */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CPPP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CPPP</span><span class="p">))</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">isdn_readbchan_tty</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">isdn_readbchan_tty</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
					<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rcvsched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">resched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rcvsched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resched</span><span class="p">)</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMREAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">isdn_tty_rcv_skb</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">midx</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="kt">int</span> <span class="n">ifmt</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">midx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if midx is invalid, packet is not for tty */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">midx</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="n">ifmt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
		<span class="n">isdn_audio_calc_dtmf</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ifmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
		<span class="n">isdn_audio_calc_silence</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ifmt</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
<span class="cp">#endif</span>
		<span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If Modem not listening, drop data */</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70_EXT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* T.70 decoding: throw away the T.70 header (2 or 4 bytes)   */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="cm">/* pure data packet -&gt; 4 byte headers  */</span>
				<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* keepalive packet -&gt; 2 byte hdr  */</span>
					<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* T.70 decoding: Simply throw away the T.70 header (4 bytes) */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)))</span>
				<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="n">ISDN_AUDIO_SKB_DLECOUNT</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ISDN_AUDIO_SKB_LOCK</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* voice conversion/compression */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="cm">/* adpcm</span>
<span class="cm">			 * Since compressed data takes less</span>
<span class="cm">			 * space, we can overwrite the buffer.</span>
<span class="cm">			 */</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">isdn_audio_xlaw2adpcm</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcmr</span><span class="p">,</span>
							    <span class="n">ifmt</span><span class="p">,</span>
							    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="cm">/* a-law */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifmt</span><span class="p">)</span>
				<span class="n">isdn_audio_ulaw2alaw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="cm">/* u-law */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifmt</span><span class="p">)</span>
				<span class="n">isdn_audio_alaw2ulaw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ISDN_AUDIO_SKB_DLECOUNT</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span>
			<span class="n">isdn_tty_countDLE</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_tty_fax_bitorder</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">ISDN_AUDIO_SKB_DLECOUNT</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span>
				<span class="n">isdn_tty_countDLE</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="cm">/* Try to deliver directly via tty-buf if queue is empty */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">di</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rpqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">]))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_try_read</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cm">/* Direct deliver failed or queue wasn&#39;t empty.</span>
<span class="cm">	 * Queue up for later dequeueing via timer-irq.</span>
<span class="cm">	 */</span>
	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">di</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rpqueue</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">di</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rcvcount</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">+=</span>
		<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		 <span class="o">+</span> <span class="n">ISDN_AUDIO_SKB_DLECOUNT</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* Schedule dequeuing */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">modempoll</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rcvsched</span><span class="p">))</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMREAD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_cleanup_xmit</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_queue</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_queue</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_tint</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_queue</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">slen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slen</span> <span class="o">=</span> <span class="n">isdn_writebuf_skb_stub</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">,</span>
					   <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="o">==</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">send_outstanding</span><span class="o">++</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MSR_CTS</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LSR_TEMT</span><span class="p">;</span>
		<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Error: no channel, already shutdown, or wrong parameter */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_countDLE</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine is called from within isdn_tty_write() to perform</span>
<span class="cm"> * DLE-decoding when sending audio-data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_handleDLEdown</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lastDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">lastDLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DLE</span>:
				<span class="cm">/* Escape code */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">memmove</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">p</span><span class="o">--</span><span class="p">;</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ETX</span>:
				<span class="cm">/* End of data */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DC4</span>:
				<span class="cm">/* Abort RX */</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;DLEdown: got DLE-DC4, send DLE-ETX on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\020\003</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;DLEdown: send VCON on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">VCON</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* Fall through */</span>
			<span class="k">case</span> <span class="sc">&#39;q&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
				<span class="cm">/* Silence */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">memmove</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">p</span><span class="o">--</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="n">DLE</span><span class="p">)</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">lastDLE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: len&lt;0 in DLEdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This routine is called from within isdn_tty_write() when receiving</span>
<span class="cm"> * audio-data. It interrupts receiving, if an character other than</span>
<span class="cm"> * ^S or ^Q is sent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_end_vrx</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">!=</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="mh">0x13</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">voice_cf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="cp">#endif                          </span><span class="cm">/* CONFIG_ISDN_AUDIO */</span><span class="cp"></span>

<span class="cm">/* isdn_tty_senddown() is called either directly from within isdn_tty_write()</span>
<span class="cm"> * or via timer-interrupt from within isdn_tty_modem_xmit(). It pulls</span>
<span class="cm"> * outgoing data from the tty&#39;s xmit-buffer, handles voice-decompression or</span>
<span class="cm"> * T.70 if necessary, and finally queues it up for sending via isdn_tty_tint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_senddown</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skb_res</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="kt">int</span> <span class="n">audio_len</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;senddown: send VCON on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">VCON</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buflen</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CTS</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CTS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MSR_CTS</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_LSR_TEMT</span><span class="p">;</span>
	<span class="cm">/* info-&gt;xmit_count is modified here and in isdn_tty_write().</span>
<span class="cm">	 * So we return here if isdn_tty_write() is in the</span>
<span class="cm">	 * critical section.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_res</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">audio_len</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">*</span> <span class="n">voice_cf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">]];</span>
	<span class="k">else</span>
		<span class="n">audio_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">skb_res</span> <span class="o">+</span> <span class="n">buflen</span> <span class="o">+</span> <span class="n">audio_len</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">skb_res</span> <span class="o">+</span> <span class="n">buflen</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;isdn_tty: Out of memory in ttyI%d senddown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_res</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">buflen</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For now, ifmt is fixed to 1 (alaw), since this</span>
<span class="cm">		 * is used with ISDN everywhere in the world, except</span>
<span class="cm">		 * US, Canada and Japan.</span>
<span class="cm">		 * Later, when US-ISDN protocols are implemented,</span>
<span class="cm">		 * this setting will depend on the D-channel protocol.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">ifmt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* voice conversion/decompression */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="cm">/* adpcm, compatible to ZyXel 1496 modem</span>
<span class="cm">			 * with ROM revision 6.01</span>
<span class="cm">			 */</span>
			<span class="n">audio_len</span> <span class="o">=</span> <span class="n">isdn_audio_adpcm2xlaw</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcms</span><span class="p">,</span>
							  <span class="n">ifmt</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">audio_len</span><span class="p">),</span>
							  <span class="n">buflen</span><span class="p">);</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">audio_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="cm">/* a-law */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ifmt</span><span class="p">)</span>
				<span class="n">isdn_audio_alaw2ulaw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">buflen</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="cm">/* u-law */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ifmt</span><span class="p">)</span>
				<span class="n">isdn_audio_ulaw2alaw</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						     <span class="n">buflen</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif                          </span><span class="cm">/* CONFIG_ISDN_AUDIO */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add T.70 simplified header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70_EXT</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\1\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\1\0\1\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Modem-functions</span>
<span class="cm"> *</span>
<span class="cm"> * mostly &quot;stolen&quot; from original Linux-serial.c and friends.</span>
<span class="cm"> *</span>
<span class="cm"> ************************************************************/</span>

<span class="cm">/* The next routine is called once from within timer-interrupt</span>
<span class="cm"> * triggered within isdn_tty_modem_ncarrier(). It calls</span>
<span class="cm"> * isdn_tty_modem_result() to stuff a &quot;NO CARRIER&quot; Message</span>
<span class="cm"> * into the tty&#39;s buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_modem_do_ncarrier</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_CARRIER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Next routine is called, whenever the DTR-signal is raised.</span>
<span class="cm"> * It checks the ncarrier-flag, and triggers the above routine</span>
<span class="cm"> * when necessary. The ncarrier-flag is set, whenever DTR goes</span>
<span class="cm"> * low.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_modem_ncarrier</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ncarrier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nc_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nc_timer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return the usage calculated by si and layer 2 protocol</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_calc_usage</span><span class="p">(</span><span class="kt">int</span> <span class="n">si</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_MODEM</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">si</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">l2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_MODEM</span>:
			<span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_MODEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_FAX</span>:
			<span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_FAX</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_TRANS</span>:
		<span class="nl">default:</span>
			<span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_VOICE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">usg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* isdn_tty_dial() performs dialing of a tty an the necessary</span>
<span class="cm"> * setup of the lower levels before that.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_dial</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_MODEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">];</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">si</span> <span class="o">=</span> <span class="n">bit2si</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">usg</span> <span class="o">=</span> <span class="n">isdn_calc_usage</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">l2</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">si</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="p">)</span> <span class="p">{</span>
		<span class="n">l2</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_TRANS</span><span class="p">;</span>
		<span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_VOICE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1I</span><span class="p">]</span> <span class="o">=</span> <span class="n">si2bit</span><span class="p">[</span><span class="n">si</span><span class="p">];</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_get_free_channel</span><span class="p">(</span><span class="n">usg</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_DIALTONE</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drvmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chanmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ISDN_USAGE_OUTGOING</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_num</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">isdn_info_update</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_CLREAZ</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETEAZ</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL2</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_l2</span> <span class="o">=</span> <span class="n">l2</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">l2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l2</span> <span class="o">==</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">fax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">ISDN_TTY_FAX_CONN_OUT</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			<span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">];</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_DIAL</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">carrierwait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">isdn_info_update</span><span class="p">();</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_CARRIER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* isdn_tty_hangup() disassociates a tty from the real</span>
<span class="cm"> * ISDN-line (hangup). The usage-status is cleared</span>
<span class="cm"> * and some cleanup is done also.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">di</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">di</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rcvsched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isdn_tty_flush_buffer</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_lhup</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_CARRIER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_IDLE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">vpar</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">silence_state</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">silence_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcms</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcms</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcmr</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcmr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RUNG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_RUNG</span><span class="p">))</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_RUNG</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_MSR_DCD</span> <span class="o">|</span> <span class="n">UART_MSR_RI</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">|=</span> <span class="n">UART_LSR_TEMT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_HANGUP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">isdn_all_eaz</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isdn_free_channel</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Begin of a CAPI like interface, currently used only for</span>
<span class="cm"> * supplementary service (CAPI 2.0 part III)</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/isdn/capicmd.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="kt">int</span>
<span class="nf">isdn_tty_capi_facility</span><span class="p">(</span><span class="n">capi_msg</span> <span class="o">*</span><span class="n">cm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* dummy */</span>
<span class="p">}</span>

<span class="cm">/* isdn_tty_suspend() tries to suspend the current tty connection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_suspend</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef ISDN_DEBUG_MODEM_SERVICES</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Msusp ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">l</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">18</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Command</span> <span class="o">=</span> <span class="n">CAPI_FACILITY</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Subcommand</span> <span class="o">=</span> <span class="n">CAPI_REQ</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">adr</span><span class="p">.</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* 16 bit 0x0003 suplementary service */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* 16 bit 0x0004 Suspend */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">id</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CAPI_PUT_MESSAGE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* isdn_tty_resume() tries to resume a suspended call</span>
<span class="cm"> * setup of the lower levels before that. unfortunately here is no</span>
<span class="cm"> * checking for compatibility of used protocols implemented by Q931</span>
<span class="cm"> * It does the same things like isdn_tty_dial, the last command</span>
<span class="cm"> * is different, may be we can merge it.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_resume</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_MODEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">];</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">si</span> <span class="o">=</span> <span class="n">bit2si</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">usg</span> <span class="o">=</span> <span class="n">isdn_calc_usage</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">l2</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">si</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="p">)</span> <span class="p">{</span>
		<span class="n">l2</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_TRANS</span><span class="p">;</span>
		<span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_VOICE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1I</span><span class="p">]</span> <span class="o">=</span> <span class="n">si2bit</span><span class="p">[</span><span class="n">si</span><span class="p">];</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_get_free_channel</span><span class="p">(</span><span class="n">usg</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_DIALTONE</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drvmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chanmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ISDN_USAGE_OUTGOING</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>strcpy(info-&gt;last_num, n);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">isdn_info_update</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_CLREAZ</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETEAZ</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL2</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_l2</span> <span class="o">=</span> <span class="n">l2</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">l2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">18</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Command</span> <span class="o">=</span> <span class="n">CAPI_FACILITY</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Subcommand</span> <span class="o">=</span> <span class="n">CAPI_REQ</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">adr</span><span class="p">.</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* 16 bit 0x0003 suplementary service */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* 16 bit 0x0005 Resume */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">id</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CAPI_PUT_MESSAGE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><pre><code>strcpy(dev-&gt;num[i], n);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="n">isdn_info_update</span><span class="p">();</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_CARRIER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* isdn_tty_send_msg() sends a message to a HL driver</span>
<span class="cm"> * This is used for hybrid modem cards to send AT commands to it</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_send_msg</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_MODEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">si</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">];</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_ERROR</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">si</span> <span class="o">=</span> <span class="n">bit2si</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">usg</span> <span class="o">=</span> <span class="n">isdn_calc_usage</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="n">l2</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">si</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="p">)</span> <span class="p">{</span>
		<span class="n">l2</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_TRANS</span><span class="p">;</span>
		<span class="n">usg</span> <span class="o">=</span> <span class="n">ISDN_USAGE_VOICE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1I</span><span class="p">]</span> <span class="o">=</span> <span class="n">si2bit</span><span class="p">[</span><span class="n">si</span><span class="p">];</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_get_free_channel</span><span class="p">(</span><span class="n">usg</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_DIALTONE</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drvmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chanmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ISDN_USAGE_OUTGOING</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">isdn_info_update</span><span class="p">();</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_CLREAZ</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETEAZ</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL2</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_l2</span> <span class="o">=</span> <span class="n">l2</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">l2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Command</span> <span class="o">=</span> <span class="n">CAPI_MANUFACTURER</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">Subcommand</span> <span class="o">=</span> <span class="n">CAPI_REQ</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">adr</span><span class="p">.</span><span class="n">Controller</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">cmsg</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="n">l</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xd</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">CAPI_PUT_MESSAGE</span><span class="p">;</span>
<span class="cm">/*		info-&gt;dialing = 1;</span>
<span class="cm">		strcpy(dev-&gt;num[i], n);</span>
<span class="cm">		isdn_info_update();</span>
<span class="cm">*/</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">routine</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MODEM_PARANOIA_CHECK</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: null info_struct for %s in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">ISDN_ASYNC_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: bad magic for modem struct %s in %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called to set the UART divisor registers to match</span>
<span class="cm"> * the specified baud rate for a serial port.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_change_speed</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">cflag</span><span class="p">,</span>
		<span class="n">cval</span><span class="p">,</span>
		<span class="n">quot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cflag</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span><span class="p">;</span>

	<span class="n">quot</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CBAUD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">CBAUDEX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CBAUDEX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
		<span class="n">isdn_tty_modem_ncarrier</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_DTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRHUP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DTRHUP</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup in changespeed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ncarrier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* byte size and parity */</span>
	<span class="n">cval</span> <span class="o">=</span> <span class="n">cflag</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSIZE</span> <span class="o">|</span> <span class="n">CSTOPB</span><span class="p">);</span>
	<span class="n">cval</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_PARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">))</span>
		<span class="n">cval</span> <span class="o">|=</span> <span class="n">UART_LCR_EPAR</span><span class="p">;</span>

	<span class="cm">/* CTS flow control flag and modem status interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CTS_FLOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CLOCAL</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_startup</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isdn_lock_drivers</span><span class="p">();</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;starting up ttyi%d ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now, initialize the UART</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">=</span> <span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span> <span class="o">|</span> <span class="n">UART_MCR_OUT2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * and set the speed of the serial port</span>
<span class="cm">	 */</span>
	<span class="n">isdn_tty_change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">UART_MSR_DSR</span> <span class="o">|</span> <span class="n">UART_MSR_CTS</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">send_outstanding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine will shutdown a serial port; interrupts are disabled, and</span>
<span class="cm"> * DTR is dropped if the hangup on close termio flag is on.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_shutdown</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Shutting down isdnmodem port %d ....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">isdn_unlock_drivers</span><span class="p">();</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MSR_RI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span> <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">HUPCL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRHUP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DTRHUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup in isdn_tty_shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_IO_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_INITIALIZED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* isdn_tty_write() is the main send-routine. It is called from the upper</span>
<span class="cm"> * levels within the kernel to perform sending data. Depending on the</span>
<span class="cm"> * online-flag it either directs output to the at-command-interpreter or</span>
<span class="cm"> * to the lower level. Additional tasks done here:</span>
<span class="cm"> *  - If online, check for escape-sequence (+++)</span>
<span class="cm"> *  - If sending audio-data, call isdn_tty_DLEdown() to parse DLE-codes.</span>
<span class="cm"> *  - If receiving audio-data, call isdn_tty_end_vrx() to abort if needed.</span>
<span class="cm"> *  - If dialing, abort dial.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_write&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* See isdn_tty_senddown() */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxbufsize</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">maxbufsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span><span class="p">)</span>
<span class="cp">#endif</span>
				<span class="n">isdn_tty_check_esc</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_ESC</span><span class="p">],</span> <span class="n">c</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pluscount</span><span class="p">),</span>
						   <span class="o">&amp;</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lastplus</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">],</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">isdn_tty_handleDLEdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* If DLE decoding results in zero-transmit, but</span>
<span class="cm">						 * c originally was non-zero, do a wakeup.</span>
<span class="cm">						 */</span>
						<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">UART_MSR_CTS</span><span class="p">;</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">|=</span> <span class="n">UART_LSR_TEMT</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">+=</span> <span class="n">cc</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Do NOT handle Ctrl-Q or Ctrl-S</span>
<span class="cm">					 * when in full-duplex audio mode.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_end_vrx</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
						       <span class="s">&quot;got !^Q/^S, send DLE-ETX,VCON on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
						<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\020\003\r\n</span><span class="s">VCON</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_FCLASS1</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">isdn_tty_handleDLEdown</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ETX seen */</span>
						<span class="n">isdn_ctrl</span> <span class="n">c</span><span class="p">;</span>

						<span class="n">c</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_FAXCMD</span><span class="p">;</span>
						<span class="n">c</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
						<span class="n">c</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
						<span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ISDN_FAX_CLASS1_CTRL</span><span class="p">;</span>
						<span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">ETX</span><span class="p">;</span>
						<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;fax dle cc/c %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">+=</span> <span class="n">cc</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">UART_MSR_CTS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">|=</span> <span class="n">UART_LSR_TEMT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup in isdn_tty_write</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_CARRIER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">isdn_tty_edit_at</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DXMT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DXMT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_tty_senddown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_tint</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMXMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_write_room&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">-</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_chars_in_buffer&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_flush_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_flush_buffer&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isdn_tty_cleanup_xmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tty_wakeup</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_flush_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_flush_chars&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_count</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_queue</span><span class="p">))</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMXMIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * isdn_tty_throttle()</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called by the upper-layer tty layer to signal that</span>
<span class="cm"> * incoming characters should be throttled.</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_throttle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_throttle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">STOP_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_RTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_unthrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_unthrottle&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">I_IXOFF</span><span class="p">(</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="n">START_CHAR</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * isdn_tty_ioctl() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * isdn_tty_get_lsr_info - get line status register info</span>
<span class="cm"> *</span>
<span class="cm"> * Purpose: Let user call ioctl() to get info when the UART physically</span>
<span class="cm"> *          is emptied.  On bus types like RS485, the transmitter must</span>
<span class="cm"> *          release the bus after transmitting. This must be done when</span>
<span class="cm"> *          the transmit shift register is empty, not be done when the</span>
<span class="cm"> *          transmit holding register is empty.  This functionality</span>
<span class="cm"> *          allows RS485 driver to be written in user space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_get_lsr_info</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">uint</span> <span class="n">__user</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCSER_TEMT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_tiocmget</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">control</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modem_info_mutex</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_IOCTL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ttyI%d ioctl TIOCMGET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modem_info_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">UART_MCR_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">UART_MCR_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CAR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_RNG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_DSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UART_MSR_CTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TIOCM_CTS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_tiocmset</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="cp">#ifdef ISDN_DEBUG_MODEM_IOCTL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ttyI%d ioctl TIOCMxxx: %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modem_info_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">|=</span> <span class="n">UART_MCR_DTR</span><span class="p">;</span>
		<span class="n">isdn_tty_modem_ncarrier</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_RTS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MCR_DTR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRHUP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DTRHUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup in TIOCMSET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">ncarrier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">modem_info_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="n">uint</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ulong</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_ioctl&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TTY_IO_ERROR</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCSBRK</span>:   <span class="cm">/* SVID version: non-zero arg --&gt; no break */</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_IOCTL</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ttyI%d ioctl TCSBRK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TCSBRKP</span>:  <span class="cm">/* support for POSIX tcsendbreak() */</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_IOCTL</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ttyI%d ioctl TCSBRKP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_check_change</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">tty_wait_until_sent</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TIOCSERGETLSR</span>:	<span class="cm">/* Get line status register */</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_IOCTL</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ttyI%d ioctl TIOCSERGETLSR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">isdn_tty_get_lsr_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="p">(</span><span class="n">uint</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_IOCTL</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;UNKNOWN ioctl 0x%08x on ttyi%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_set_termios</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ktermios</span> <span class="o">*</span><span class="n">old_termios</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_termios</span><span class="p">)</span>
		<span class="n">isdn_tty_change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">==</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">==</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_ispeed</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span> <span class="o">==</span> <span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_ospeed</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">isdn_tty_change_speed</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">old_termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">termios</span><span class="o">-&gt;</span><span class="n">c_cflag</span> <span class="o">&amp;</span> <span class="n">CRTSCTS</span><span class="p">))</span>
			<span class="n">tty</span><span class="o">-&gt;</span><span class="n">hw_stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> * isdn_tty_open() and friends</span>
<span class="cm"> * ------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called whenever a serial port is opened.  It</span>
<span class="cm"> * enables interrupts for a serial port, linking in its async structure into</span>
<span class="cm"> * the IRQ chain.   It also performs the serial-specific</span>
<span class="cm"> * initialization for the tty structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_open&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_open %s, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Start up serial port</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">isdn_tty_startup</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_open return after startup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_port_block_til_ready</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">,</span> <span class="n">filp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_open return after isdn_tty_block_til_ready </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_open ttyi%d successful...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">modempoll</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_open normal exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_close&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty_hung_up_p</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_close return after tty_hung_up_p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Uh, oh.  tty-&gt;count is 1, which means that the tty</span>
<span class="cm">		 * structure will be freed.  Info-&gt;count should always</span>
<span class="cm">		 * be one in these conditions.  If it&#39;s greater than</span>
<span class="cm">		 * one, we&#39;ve got real problems, since it means the</span>
<span class="cm">		 * serial port won&#39;t be shutdown.</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_tty_close: bad port count; tty-&gt;count is 1, &quot;</span>
		       <span class="s">&quot;info-&gt;count is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_tty_close: bad port count for ttyi%d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_close after info-&gt;count != 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ASYNC_CLOSING</span><span class="p">;</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * At this point we stop accepting input.  To do this, we</span>
<span class="cm">	 * disable the receive line status interrupts, and tell the</span>
<span class="cm">	 * interrupt driver to stop checking the data ready bit in the</span>
<span class="cm">	 * line status register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tty_wait_until_sent_from_close</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>	<span class="cm">/* 30 seconds timeout */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Before we drop DTR, make sure the UART transmitter</span>
<span class="cm">		 * has completely drained; this is especially</span>
<span class="cm">		 * important if there is a transmit FIFO!</span>
<span class="cm">		 */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">modempoll</span><span class="o">--</span><span class="p">;</span>
	<span class="n">isdn_tty_shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">isdn_tty_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ncarrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tty_port_close_end</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">tty</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_OPEN</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_close normal exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isdn_tty_hangup() --- called by tty_hangup() when a hangup is signaled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_paranoia_check</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;isdn_tty_hangup&quot;</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">isdn_tty_shutdown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This routine initializes all emulator-data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_reset_profile</span><span class="p">(</span><span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">43</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L3_TRANS</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_SERIAL_XMIT_SIZE</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_MODEM_WINSIZE</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">pmsn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">plmsn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_modem_reset_vpar</span><span class="p">(</span><span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>         <span class="cm">/* Voice-device            (2 = phone line) */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>         <span class="cm">/* Silence detection level (0 = none      ) */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span>        <span class="cm">/* Silence interval        (7 sec.        ) */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>         <span class="cm">/* Compression type        (1 = ADPCM-2   ) */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>         <span class="cm">/* DTMF detection level    (0 = softcode  ) */</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>         <span class="cm">/* DTMF interval           (8 * 5 ms.     ) */</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_modem_reset_faxpar</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">T30_s</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_IDLE</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* fine */</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>		<span class="cm">/* 14400 bit/s */</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">compression</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">ecm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">binary</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">scantime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">badlin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">badmul</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">bor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">nbc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">cq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">ctcrty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">minsp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">phcto</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">rel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pollid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">pollid</span><span class="p">[</span><span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DTRR</span><span class="p">)</span> <span class="o">||</span> <span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">,</span> <span class="n">ISDN_MODEM_NUMREG</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">pmsn</span><span class="p">,</span> <span class="n">ISDN_MSNLEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">plmsn</span><span class="p">,</span> <span class="n">ISDN_LMSNLEN</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="n">isdn_tty_modem_reset_vpar</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
	<span class="n">isdn_tty_modem_reset_faxpar</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">modem_write_profile</span><span class="p">(</span><span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">,</span> <span class="n">ISDN_MODEM_NUMREG</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">pmsn</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">ISDN_MSNLEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">plmsn</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">,</span> <span class="n">ISDN_LMSNLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">profd</span><span class="p">)</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGIO</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">profd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_operations</span> <span class="n">modem_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">isdn_tty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">isdn_tty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">isdn_tty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_chars</span> <span class="o">=</span> <span class="n">isdn_tty_flush_chars</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_room</span> <span class="o">=</span> <span class="n">isdn_tty_write_room</span><span class="p">,</span>
	<span class="p">.</span><span class="n">chars_in_buffer</span> <span class="o">=</span> <span class="n">isdn_tty_chars_in_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_buffer</span> <span class="o">=</span> <span class="n">isdn_tty_flush_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">isdn_tty_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">throttle</span> <span class="o">=</span> <span class="n">isdn_tty_throttle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unthrottle</span> <span class="o">=</span> <span class="n">isdn_tty_unthrottle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_termios</span> <span class="o">=</span> <span class="n">isdn_tty_set_termios</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span> <span class="o">=</span> <span class="n">isdn_tty_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmget</span> <span class="o">=</span> <span class="n">isdn_tty_tiocmget</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tiocmset</span> <span class="o">=</span> <span class="n">isdn_tty_tiocmset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_tty_carrier_raised</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">modem_info</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tty_port_operations</span> <span class="n">isdn_tty_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">carrier_raised</span> <span class="o">=</span> <span class="n">isdn_tty_carrier_raised</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">isdn_tty_modem_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_modem_t</span>	<span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">modem_info</span>	<span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span> <span class="o">=</span> <span class="n">alloc_tty_driver</span><span class="p">(</span><span class="n">ISDN_MAX_CHANNELS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ttyI&quot;</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">ISDN_TTY_MAJOR</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">minor_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">TTY_DRIVER_TYPE_SERIAL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">SERIAL_TYPE_NORMAL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">init_termios</span> <span class="o">=</span> <span class="n">tty_std_termios</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">init_termios</span><span class="p">.</span><span class="n">c_cflag</span> <span class="o">=</span> <span class="n">B9600</span> <span class="o">|</span> <span class="n">CS8</span> <span class="o">|</span> <span class="n">CREAD</span> <span class="o">|</span> <span class="n">HUPCL</span> <span class="o">|</span> <span class="n">CLOCAL</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">TTY_DRIVER_REAL_RAW</span> <span class="o">|</span> <span class="n">TTY_DRIVER_DYNAMIC_DEV</span><span class="p">;</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;isdn_tty&quot;</span><span class="p">;</span>
	<span class="n">tty_set_operations</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">modem_ops</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">tty_register_driver</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Couldn&#39;t register modem-device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T30_s</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not allocate fax t30-buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">tty_port_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isdn_tty_port_ops</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_cause</span><span class="p">,</span> <span class="s">&quot;0000&quot;</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_num</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_lhup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_l2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">isdn_tty_reset_profile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">);</span>
		<span class="n">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">ISDN_ASYNC_MAGIC</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">x_char</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">ISDN_SERIAL_XMIT_SIZE</span><span class="p">;</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nc_timer</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nc_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">isdn_tty_modem_do_ncarrier</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">nc_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_queue</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_queue</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ISDN_SERIAL_XMIT_MAX</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Could not allocate modem xmit-buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Make room for T.70 header */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_unregister:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span><span class="p">);</span>
	<span class="n">m</span><span class="o">-&gt;</span><span class="n">tty_modem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">isdn_tty_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">isdn_tty_cleanup_xmit</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">xmit_buf</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tty_unregister_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">tty_modem</span><span class="p">);</span>
	<span class="n">put_tty_driver</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">tty_modem</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">tty_modem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * isdn_tty_match_icall(char *MSN, atemu *tty_emulator, int dev_idx)</span>
<span class="cm"> *      match the MSN against the MSNs (glob patterns) defined for tty_emulator,</span>
<span class="cm"> *      and return 0 for match, 1 for no match, 2 if MSN could match if longer.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_match_icall</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">cid</span><span class="p">,</span> <span class="n">atemu</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">di</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_ICALL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;m_fi: msn=%s lmsn=%s mmsn=%s mreg[SI1]=%d mreg[SI2]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">emu</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">di</span><span class="p">),</span>
	       <span class="n">emu</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">],</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
		<span class="kt">int</span>  <span class="n">tmp</span><span class="p">;</span>
		<span class="kt">int</span>  <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">q</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sc">&#39;;&#39;</span><span class="p">)))</span>
				<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">isdn_msncmp</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">di</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_ICALL</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;m_fi: lmsnX=%s mmsn=%s -&gt; tmp=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">p</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">di</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="sc">&#39;;&#39;</span><span class="p">;</span>
				<span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">isdn_msncmp</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">di</span><span class="p">));</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_ICALL</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;m_fi: mmsn=%s -&gt; tmp=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">di</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * An incoming call-request has arrived.</span>
<span class="cm"> * Search the tty-devices for an appropriate device and bind</span>
<span class="cm"> * it to the ISDN-Channel.</span>
<span class="cm"> * Return:</span>
<span class="cm"> *</span>
<span class="cm"> *  0 = No matching device found.</span>
<span class="cm"> *  1 = A matching device found.</span>
<span class="cm"> *  3 = No match found, but eventually would match, if</span>
<span class="cm"> *      CID is longer.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_tty_find_icall</span><span class="p">(</span><span class="kt">int</span> <span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">setup_parm</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">eaz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">si1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">si2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">nr</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_tty: Incoming call without OAD, assuming &#39;0&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">;</span>
	<span class="n">si1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">si1</span><span class="p">;</span>
	<span class="n">si2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">si2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">eazmsn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Incoming call without CPN, assuming &#39;0&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">eaz</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">eaz</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">eazmsn</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_ICALL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;m_fi: eaz=%s si1=%d si2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eaz</span><span class="p">,</span> <span class="n">si1</span><span class="p">,</span> <span class="n">si2</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">wret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">si2bit</span><span class="p">[</span><span class="n">si1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>  <span class="cm">/* SI1 is matching */</span>
		    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]</span> <span class="o">==</span> <span class="n">si2</span><span class="p">))</span>	<span class="p">{</span>         <span class="cm">/* SI2 is matching */</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">isdn_dc2minor</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_ICALL</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;m_fi: match1 wret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wret</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;m_fi: idx=%d flags=%08lx drv=%d ch=%d usg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span>
<span class="cp">#ifndef FIX_FILE_TRANSFER</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_NORMAL_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<span class="cp">#endif</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">USG_NONE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">])))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">matchret</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">matchret</span> <span class="o">=</span> <span class="n">isdn_tty_match_icall</span><span class="p">(</span><span class="n">eaz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">,</span> <span class="n">di</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">wret</span><span class="p">)</span>
					<span class="n">wret</span> <span class="o">=</span> <span class="n">matchret</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">matchret</span><span class="p">)</span> <span class="p">{</span>                  <span class="cm">/* EAZ is matching */</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">isdn_calc_usage</span><span class="p">(</span><span class="n">si1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]);</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">nr</span><span class="p">);</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">cpn</span><span class="p">,</span> <span class="n">eaz</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1I</span><span class="p">]</span> <span class="o">=</span> <span class="n">si2bit</span><span class="p">[</span><span class="n">si1</span><span class="p">];</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PLAN</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">plan</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SCREEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">;</span>
					<span class="n">isdn_info_update</span><span class="p">();</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_tty: call from %s, -&gt; RING on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
					       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">UART_MSR_RI</span><span class="p">;</span>
					<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_RING</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMRING</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_tty: call from %s -&gt; %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">eaz</span><span class="p">,</span>
	       <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">di</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRV_FLAG_REJBUS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wret</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;rejected&quot;</span> <span class="o">:</span> <span class="s">&quot;ignored&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">wret</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TTY_IS_ACTIVE(info)	(info-&gt;port.flags &amp; ASYNC_NORMAL_ACTIVE)</span>

<span class="kt">int</span>
<span class="nf">isdn_tty_stat_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mi</span><span class="p">;</span>
	<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mi</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">mi</span><span class="p">];</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_CINF</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;CHARGEINFO on ttyI%d: %ld %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">charge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_BSENT</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_BSENT ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">UART_MSR_CTS</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">send_outstanding</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">send_outstanding</span><span class="p">))</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">lsr</span> <span class="o">|=</span> <span class="n">UART_LSR_TEMT</span><span class="p">;</span>
				<span class="n">isdn_tty_tint</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_CAUSE</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_CAUSE ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* Signal cause to tty-device */</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_cause</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_DISPLAY</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_DISPLAY ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* Signal display to tty-device */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DISPLAY</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DISPLAY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESPNUM</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_RESPNUM</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;DISPLAY: &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">display</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_DCONN</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_DCONN ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_ACTIVE</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_DHUP</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_DHUP ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_ACTIVE</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_BUSY</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_CARRIER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup in ISDN_STAT_DHUP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_BCONN</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_BCONN ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* Wake up any processes waiting</span>
<span class="cm">			 * for incoming call of this device when</span>
<span class="cm">			 * DCD follow the state of incoming carrier</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">blocked_open</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DCD</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DCD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">open_wait</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Schedule CONNECT-Message to any tty</span>
<span class="cm">			 * waiting for it and</span>
<span class="cm">			 * set DCD-bit of its modem-status.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_ACTIVE</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">blocked_open</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DCD</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_DCD</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">|=</span> <span class="n">UART_MSR_DCD</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rcvsched</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">USG_MODEM</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">connmsg</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">);</span>
						<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_CONNECT</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_CONNECT64000</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">USG_VOICE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
					<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_VCON</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_BHUP</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_BHUP ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_ACTIVE</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup in ISDN_STAT_BHUP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_NODCH</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_NODCH ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_ACTIVE</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_l2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_si</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_cause</span><span class="p">,</span> <span class="s">&quot;0000&quot;</span><span class="p">);</span>
					<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_DIALTONE</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_UNLOAD</span>:
<span class="cp">#ifdef ISDN_TTY_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;tty_STAT_UNLOAD ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">==</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
						<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_FAXIND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_ACTIVE</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isdn_tty_fax_command</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_AUDIO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_ACTIVE</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ISDN_AUDIO_DTMF</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">isdn_audio_put_dle_code</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
									<span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*********************************************************************</span>
<span class="cm"> Modem-Emulator-Routines</span>
<span class="cm">*********************************************************************/</span>

<span class="cp">#define cmdchar(c) ((c &gt;= &#39; &#39;) &amp;&amp; (c &lt;= 0x7f))</span>

<span class="cm">/*</span>
<span class="cm"> * Put a message from the AT-emulator into receive-buffer of tty,</span>
<span class="cm"> * convert CR, LF, and BS to values in modem-registers 3, 4 and 5.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_tty_at_cout</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Null-Message in isdn_tty_at_cout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* use queue instead of direct, if online and */</span>
	<span class="cm">/* data is in queue or buffer is full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">tty_buffer_request_room</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">)</span> <span class="o">||</span>
			     <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rpqueue</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">])))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="n">ISDN_AUDIO_SKB_DLECOUNT</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ISDN_AUDIO_SKB_LOCK</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;\r&#39;</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CR</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;\n&#39;</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_LF</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;\b&#39;</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_BS</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">sp</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tty_insert_flip_char</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">TTY_NORMAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rpqueue</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rcvcount</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">]</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* Schedule dequeuing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">modempoll</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rcvsched</span><span class="p">)</span>
			<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMREAD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">readlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tty_flip_buffer_push</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform ATH Hangup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_on_hook</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Mhup in isdn_tty_on_hook</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_off_hook</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_off_hook</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PLUSWAIT1 (HZ / 2)      </span><span class="cm">/* 0.5 sec. */</span><span class="cp"></span>
<span class="cp">#define PLUSWAIT2 (HZ * 3 / 2)  </span><span class="cm">/* 1.5 sec */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Check Buffer for Modem-escape-sequence, activate timer-callback to</span>
<span class="cm"> * isdn_tty_modem_escape() if sequence found.</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *   p          pointer to databuffer</span>
<span class="cm"> *   plus       escape-character</span>
<span class="cm"> *   count      length of buffer</span>
<span class="cm"> *   pluscount  count of valid escape-characters so far</span>
<span class="cm"> *   lastplus   timestamp of last character</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_check_esc</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">plus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pluscount</span><span class="p">,</span>
		   <span class="n">u_long</span> <span class="o">*</span><span class="n">lastplus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plus</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pluscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="o">==</span> <span class="n">plus</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pluscount</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Time since last &#39;+&#39; &gt; 0.5 sec. ? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="o">*</span><span class="n">lastplus</span> <span class="o">+</span> <span class="n">PLUSWAIT1</span><span class="p">))</span>
					<span class="o">*</span><span class="n">pluscount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Time since last non-&#39;+&#39; &lt; 1.5 sec. ? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="o">*</span><span class="n">lastplus</span> <span class="o">+</span> <span class="n">PLUSWAIT2</span><span class="p">))</span>
					<span class="o">*</span><span class="n">pluscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">pluscount</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMPLUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pluscount</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="o">*</span><span class="n">pluscount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">pluscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">lastplus</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return result of AT-emulator to tty-receive-buffer, depending on</span>
<span class="cm"> * modem-register 12, bit 0 and 1.</span>
<span class="cm"> * For CONNECT-messages also switch to online-mode.</span>
<span class="cm"> * For RING-message handle auto-ATA if register 0 != 0</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_modem_result</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">,</span> <span class="s">&quot;RING&quot;</span><span class="p">,</span> <span class="s">&quot;NO CARRIER&quot;</span><span class="p">,</span> <span class="s">&quot;ERROR&quot;</span><span class="p">,</span>
		 <span class="s">&quot;CONNECT 64000&quot;</span><span class="p">,</span> <span class="s">&quot;NO DIALTONE&quot;</span><span class="p">,</span> <span class="s">&quot;BUSY&quot;</span><span class="p">,</span> <span class="s">&quot;NO ANSWER&quot;</span><span class="p">,</span>
		 <span class="s">&quot;RINGING&quot;</span><span class="p">,</span> <span class="s">&quot;NO MSN/EAZ&quot;</span><span class="p">,</span> <span class="s">&quot;VCON&quot;</span><span class="p">,</span> <span class="s">&quot;RUNG&quot;</span><span class="p">};</span>
	<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="n">ISDN_MSNLEN</span> <span class="o">+</span> <span class="mi">10</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RESULT_RING</span>:
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGATA</span><span class="p">])</span>
			<span class="cm">/* Automatically accept incoming call */</span>
			<span class="n">isdn_tty_cmd_ATA</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESULT_NO_CARRIER</span>:
<span class="cp">#ifdef ISDN_DEBUG_MODEM_HUP</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;modem_result: NO CARRIER %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">),</span>
		       <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">nc_timer</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ncarrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;res3: send DLE-ETX on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* voice-recording, add DLE-ETX */</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\020\003</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;res3: send DLE-DC4 on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="cm">/* voice-playing, add DLE-DC4 */</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\020\024</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESULT_CONNECT</span>:
	<span class="k">case</span> <span class="n">RESULT_CONNECT64000</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_cause</span><span class="p">,</span> <span class="s">&quot;0000&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESULT_VCON</span>:
<span class="cp">#ifdef ISDN_DEBUG_MODEM_VOICE</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;res3: send VCON on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_cause</span><span class="p">,</span> <span class="s">&quot;0000&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* switch (code) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESP</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_RESP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Show results */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESPNUM</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_RESPNUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Show numeric results only */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">RESULT_RING</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* return if &quot;show RUNG&quot; and ringcounter&gt;1 */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RUNG</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_RUNG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="cm">/* print CID, _before_ _every_ ring */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CIDONCE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CIDONCE</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">CALLER NUMBER: &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span><span class="p">],</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CDN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CDN</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">CALLED NUMBER: &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
						<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">cpn</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">code</span><span class="p">],</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">RESULT_CONNECT</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_MODEM</span>:
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">connmsg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">RESULT_RING</span>:
				<span class="cm">/* Append CPN, if enabled */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CPN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CPN</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">cpn</span><span class="p">);</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* Print CID only once, _after_ 1st RING */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CIDONCE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CIDONCE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;CALLER NUMBER: &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span><span class="p">],</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CDN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CDN</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">CALLED NUMBER: &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
						<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">cpn</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">RESULT_NO_CARRIER</span>:
			<span class="k">case</span> <span class="n">RESULT_NO_DIALTONE</span>:
			<span class="k">case</span> <span class="n">RESULT_BUSY</span>:
			<span class="k">case</span> <span class="n">RESULT_NO_ANSWER</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* Append Cause-Message if enabled */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESPXT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_RESPXT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_cause</span><span class="p">);</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">RESULT_CONNECT64000</span>:
				<span class="cm">/* Append Protocol to CONNECT message */</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">])</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75UI</span>:
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75BUI</span>:
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;/X.75&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;/HDLC&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11096</span>:
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;/V110/9600&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11019</span>:
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;/V110/19200&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11038</span>:
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;/V110/38400&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;/T.70&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70_EXT</span><span class="p">)</span>
						<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">RESULT_NO_CARRIER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CLOSING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ASYNC_CHECK_CD</span><span class="p">)</span>
			<span class="n">tty_hangup</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Display a modem-register-value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_show_profile</span><span class="p">(</span><span class="kt">int</span> <span class="n">ridx</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">v</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">ridx</span><span class="p">]);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get MSN-string from char-pointer, set pointer to end of number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_get_msnstr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">ISDN_MSNLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="o">||</span>
		<span class="cm">/* Why a comma ??? */</span>
		<span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">limit</span><span class="o">--</span><span class="p">))</span>
		<span class="o">*</span><span class="n">n</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get phone-number from modem-commandbuffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_getdial</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">ISDN_MSNLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* MUST match the size of interface var to avoid</span>
<span class="cm">					   buffer overflow */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="s">&quot; 0123456789,#.*WPTSR-&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;S&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">first</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">first</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">q</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
			<span class="n">limit</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">limit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PARSE_ERROR { isdn_tty_modem_result(RESULT_ERROR, info); return; }</span>
<span class="cp">#define PARSE_ERROR1 { isdn_tty_modem_result(RESULT_ERROR, info); return 1; }</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_report</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">s</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">Statistics of last connection:</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;    Remote Number:    %s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_num</span><span class="p">);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;    Direction:        %s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">?</span> <span class="s">&quot;outgoing&quot;</span> <span class="o">:</span> <span class="s">&quot;incoming&quot;</span><span class="p">);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;    Layer-2 Protocol: &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_l2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75I</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;X.75i&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75UI</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;X.75ui&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_X75BUI</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;X.75bui&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_HDLC</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;HDLC&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11096</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;V.110 9600 Baud&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11019</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;V.110 19200 Baud&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11038</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;V.110 38400 Baud&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_TRANS</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;transparent&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_MODEM</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;modem&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_PROTO_L2_FAX</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;fax&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;/T.70&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_T70_EXT</span><span class="p">)</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;    Service:          &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_si</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;audio</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;btx</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;data</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_si</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;    Hangup location:  %s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_lhup</span> <span class="o">?</span> <span class="s">&quot;local&quot;</span> <span class="o">:</span> <span class="s">&quot;remote&quot;</span><span class="p">);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;    Last cause:       %s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">last_cause</span><span class="p">);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse AT&amp;.. commands.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_cmd_ATand</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rb</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

<span class="cp">#define MAXRB (sizeof(rb) - 1)</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;B&#39;</span>:
		<span class="cm">/* &amp;B - Set Buffersize */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">ISDN_SERIAL_XMIT_MAX</span><span class="p">))</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">VBUF</span><span class="p">))</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11096</span>:
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11019</span>:
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11038</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;C&#39;</span>:
		<span class="cm">/* &amp;C - DCD Status */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DCD</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_DCD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DCD</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_DCD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span>
				<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
		<span class="cm">/* &amp;D - Set DTR-Low-behavior */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRHUP</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_DTRHUP</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_DTRR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRHUP</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_DTRHUP</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_DTRR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRHUP</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_DTRHUP</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_DTRR</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_DTRR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span>
				<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
		<span class="cm">/* &amp;E -Set EAZ/MSN */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">isdn_tty_get_msnstr</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
		<span class="cm">/* &amp;F -Set Factory-Defaults */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="n">isdn_tty_reset_profile</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="n">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef DUMMY_HAYES_AT</span>
	<span class="k">case</span> <span class="sc">&#39;K&#39;</span>:
		<span class="cm">/* only for be compilant with common scripts */</span>
		<span class="cm">/* &amp;K Flowcontrol - no function */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
		<span class="cm">/* &amp;L -Set Numbers to listen on */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="s">&quot;0123456789,-*[]?;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_LMSNLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;R&#39;</span>:
		<span class="cm">/* &amp;R - Set V.110 bitrate adaption */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* Switch off V.110, back to X.75 */</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9600</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_V11096</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">197</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">19200</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_V11019</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">199</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">38400</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_V11038</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">198</span><span class="p">;</span> <span class="cm">/* no existing standard for this */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Switch off T.70 */</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_T70</span> <span class="o">|</span> <span class="n">BIT_T70_EXT</span><span class="p">);</span>
		<span class="cm">/* Set Service 7 */</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
		<span class="cm">/* &amp;S - Set Windowsize */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">))</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_WSIZE</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;V&#39;</span>:
		<span class="cm">/* &amp;V - Show registers */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MODEM_NUMREG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="s">&quot;S%02d=%03d%s&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">EAZ/MSN: %.50s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">)</span> <span class="o">?</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span> <span class="o">:</span> <span class="s">&quot;None&quot;</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rb</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">Listen: &quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">lmsn</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;W&#39;</span>:
		<span class="cm">/* &amp;W - Write Profile */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">modem_write_profile</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;X&#39;</span>:
		<span class="cm">/* &amp;X - Switch to BTX-Mode and T.70 */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT_T70</span> <span class="o">|</span> <span class="n">BIT_T70_EXT</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_T70</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_T70_EXT</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="mi">112</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_T70</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">BIT_T70</span> <span class="o">|</span> <span class="n">BIT_T70_EXT</span><span class="p">);</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="mi">112</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PARSE_ERROR1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_check_ats</span><span class="p">(</span><span class="kt">int</span> <span class="n">mreg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mval</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">atemu</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Some plausibility checks */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mreg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">REG_L2PROT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mval</span> <span class="o">&gt;</span> <span class="n">ISDN_PROTO_L2_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_PSIZE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">mval</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ISDN_SERIAL_XMIT_MAX</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mval</span> <span class="o">&gt;</span> <span class="n">VBUFX</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">mval</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11096</span>:
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11019</span>:
		<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11038</span>:
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REG_SI1I</span>:
	<span class="k">case</span> <span class="n">REG_PLAN</span>:
	<span class="k">case</span> <span class="n">REG_SCREEN</span>:
		<span class="cm">/* readonly registers */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform ATS command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_cmd_ATS</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bitpos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mreg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bval</span><span class="p">;</span>

	<span class="n">mreg</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mreg</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mreg</span> <span class="o">&gt;=</span> <span class="n">ISDN_MODEM_NUMREG</span><span class="p">)</span>
		<span class="n">PARSE_ERROR1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">mval</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mval</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_check_ats</span><span class="p">(</span><span class="n">mreg</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">mreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">mval</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;.&#39;</span>:
		<span class="cm">/* Set/Clear a single bit */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bitpos</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">bitpos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bitpos</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bval</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bval</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bval</span><span class="p">)</span>
				<span class="n">mval</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">mreg</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitpos</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mval</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">mreg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitpos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_check_ats</span><span class="p">(</span><span class="n">mreg</span><span class="p">,</span> <span class="n">mval</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">mreg</span><span class="p">]</span> <span class="o">=</span> <span class="n">mval</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">mreg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitpos</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">,</span>
					 <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">isdn_tty_show_profile</span><span class="p">(</span><span class="n">mreg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform ATA command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_cmd_ATA</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Accept incoming call */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">last_num</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span><span class="p">]);</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RINGCNT</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">UART_MSR_RI</span><span class="p">;</span>
		<span class="n">l2</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">];</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
		<span class="cm">/* If more than one bit set in reg18, autoselect Layer2 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1I</span><span class="p">])</span> <span class="o">!=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1I</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">l2</span> <span class="o">!=</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">))</span>
					<span class="n">l2</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_TRANS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">l2</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL2</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">l2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">last_l2</span> <span class="o">=</span> <span class="n">l2</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL3</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l2</span> <span class="o">==</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">fax</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">=</span> <span class="n">ISDN_TTY_FAX_CONN_IN</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_ACCEPTD</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">carrierwait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_CARRIER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_ANSWER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
<span class="cm">/*</span>
<span class="cm"> * Parse AT+F.. commands</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_cmd_PLUSF</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rs</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;CLASS&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_FCLASS2</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">2&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_FCLASS1</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">1&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L3_TRANS</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
			<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">global_features</span> <span class="o">&amp;</span>
				      <span class="n">ISDN_FEATURE_L3_FCLASS1</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L3_FCLASS1</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">global_features</span> <span class="o">&amp;</span>
				      <span class="n">ISDN_FEATURE_L3_FCLASS2</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L3_FCLASS2</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">case</span> <span class="sc">&#39;8&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* L2 will change on dialout with si=1 */</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L3PROT</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L3_TRANS</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">xmit_size</span> <span class="o">=</span> <span class="n">VBUF</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">global_features</span> <span class="o">&amp;</span>
				    <span class="n">ISDN_FEATURE_L3_FCLASS1</span><span class="p">)</span>
					<span class="n">strcat</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;1,&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">global_features</span> <span class="o">&amp;</span>
				    <span class="n">ISDN_FEATURE_L3_FCLASS2</span><span class="p">)</span>
					<span class="n">strcat</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;2,&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;8&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_TTY_FAX</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">isdn_tty_cmd_PLUSF_FAX</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">PARSE_ERROR1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse AT+V.. commands</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_cmd_PLUSV</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vcmd</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;NH&quot;</span><span class="p">,</span> <span class="s">&quot;IP&quot;</span><span class="p">,</span> <span class="s">&quot;LS&quot;</span><span class="p">,</span> <span class="s">&quot;RX&quot;</span><span class="p">,</span> <span class="s">&quot;SD&quot;</span><span class="p">,</span> <span class="s">&quot;SM&quot;</span><span class="p">,</span> <span class="s">&quot;TX&quot;</span><span class="p">,</span> <span class="s">&quot;DD&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">par1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">par2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rs</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">vcmd</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">vcmd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* AT+VNH - Auto hangup feature */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">1&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">1&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* AT+VIP - Reset all voice parameters */</span>
		<span class="n">isdn_tty_modem_reset_vpar</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* AT+VLS - Select device, accept incoming call */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,2&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* AT+VRX - Start recording */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_ANSWER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span> <span class="o">=</span> <span class="n">isdn_audio_dtmf_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Couldn&#39;t malloc dtmf state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">silence_state</span> <span class="o">=</span> <span class="n">isdn_audio_silence_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">silence_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">silence_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Couldn&#39;t malloc silence state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcmr</span> <span class="o">=</span> <span class="n">isdn_audio_adpcm_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcmr</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcmr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Couldn&#39;t malloc adpcm state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef ISDN_DEBUG_AT</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;AT: +VRX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_CONNECT</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="cm">/* AT+VSD - Silence detection */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&lt;%d&gt;,&lt;%d&gt;&quot;</span><span class="p">,</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">par1</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par1</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">par2</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par2</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">par1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">par2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&lt;0-31&gt;,&lt;0-255&gt;&quot;</span><span class="p">,</span>
							 <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* AT+VSM - Select compression */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&lt;%d&gt;,&lt;%d&gt;&lt;8000&gt;&quot;</span><span class="p">,</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;4&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;5&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;6&#39;</span>:
				<span class="n">par1</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par1</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par1</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">par1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">2;ADPCM;2;0;(8000)</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;3;ADPCM;3;0;(8000)</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;4;ADPCM;4;0;(8000)</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;5;ALAW;8;0;(8000)</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">info</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;6;ULAW;8;0;(8000)</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="cm">/* AT+VTX - Start sending */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_ANSWER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span> <span class="o">=</span> <span class="n">isdn_audio_dtmf_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dtmf_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Couldn&#39;t malloc dtmf state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcms</span> <span class="o">=</span> <span class="n">isdn_audio_adpcm_init</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcms</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">adpcms</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tty: Couldn&#39;t malloc adpcm state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef ISDN_DEBUG_AT</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;AT: +VTX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">lastDLE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_CONNECT</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="cm">/* AT+VDD - DTMF detection */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&lt;%d&gt;,&lt;%d&gt;&quot;</span><span class="p">,</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">par1</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par1</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">par2</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par2</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">par1</span><span class="p">;</span>
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">vpar</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">par2</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_AUDIO</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">ISDN_AUDIO_SETDD</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">par1</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">par2</span><span class="p">;</span>
				<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&lt;0-15&gt;,&lt;0-255&gt;&quot;</span><span class="p">,</span>
							 <span class="n">info</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PARSE_ERROR1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif                          </span><span class="cm">/* CONFIG_ISDN_AUDIO */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Parse and perform an AT-command-line.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_parse_at</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ds</span><span class="p">[</span><span class="n">ISDN_MSNLEN</span><span class="p">];</span>

<span class="cp">#ifdef ISDN_DEBUG_AT</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;AT: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="o">*</span><span class="n">p</span><span class="p">;)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39; &#39;</span>:
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;A&#39;</span>:
			<span class="cm">/* A - Accept incoming call */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdn_tty_cmd_ATA</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span>:
			<span class="cm">/* D - Dial */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
				<span class="n">PARSE_ERROR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_CARRIER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">isdn_tty_getdial</span><span class="p">(</span><span class="o">++</span><span class="n">p</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ds</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">))</span>
				<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_MSN_EAZ</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>
				<span class="n">isdn_tty_dial</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">PARSE_ERROR</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;E&#39;</span>:
			<span class="cm">/* E - Turn Echo on/off */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">isdn_getnum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_ECHO</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_ECHO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_ECHO</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_ECHO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;H&#39;</span>:
			<span class="cm">/* H - On/Off-hook */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_on_hook</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_off_hook</span><span class="p">();</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">isdn_tty_on_hook</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;I&#39;</span>:
			<span class="cm">/* I - Information */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">Linux ISDN&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;2&#39;</span>:
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_report</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ds</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">charge</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef DUMMY_HAYES_AT</span>
		<span class="k">case</span> <span class="sc">&#39;L&#39;</span>:
		<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:
			<span class="cm">/* only for be compilant with common scripts */</span>
			<span class="cm">/* no function */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdn_getnum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="sc">&#39;O&#39;</span>:
			<span class="cm">/* O - Go online */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span>
				<span class="cm">/* if B-Channel is up */</span>
				<span class="n">isdn_tty_modem_result</span><span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">)</span> <span class="o">?</span> <span class="n">RESULT_CONNECT</span> <span class="o">:</span> <span class="n">RESULT_CONNECT64000</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_CARRIER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;Q&#39;</span>:
			<span class="cm">/* Q - Turn Emulator messages on/off */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">isdn_getnum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESP</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_RESP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESP</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_RESP</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:
			<span class="cm">/* S - Set/Get Register */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_cmd_ATS</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;V&#39;</span>:
			<span class="cm">/* V - Numeric or ASCII Emulator-messages */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">isdn_getnum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESP</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BIT_RESPNUM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_RESP</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT_RESPNUM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;Z&#39;</span>:
			<span class="cm">/* Z - Load Registers from Profile */</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_DCD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">isdn_tty_on_hook</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">isdn_tty_modem_reset_regs</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
			<span class="k">case</span> <span class="sc">&#39;F&#39;</span>:
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_cmd_PLUSF</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;V&#39;</span>:
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_SI1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_L2PROT</span><span class="p">]</span> <span class="o">==</span> <span class="n">ISDN_PROTO_L2_MODEM</span><span class="p">))</span>
					<span class="n">PARSE_ERROR</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_cmd_PLUSV</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif                          </span><span class="cm">/* CONFIG_ISDN_AUDIO */</span><span class="cp"></span>
			<span class="k">case</span> <span class="sc">&#39;S&#39;</span>:	<span class="cm">/* SUSPEND */</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_get_msnstr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
				<span class="n">isdn_tty_suspend</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;R&#39;</span>:	<span class="cm">/* RESUME */</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_get_msnstr</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
				<span class="n">isdn_tty_resume</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;M&#39;</span>:	<span class="cm">/* MESSAGE */</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
				<span class="n">isdn_tty_send_msg</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">PARSE_ERROR</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;&amp;&#39;</span>:
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isdn_tty_cmd_ATand</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_AUDIO</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vonline</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_OK</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Need own toupper() because standard-toupper is not available</span>
<span class="cm"> * within modules.</span>
<span class="cm"> */</span>
<span class="cp">#define my_toupper(c) (((c &gt;= &#39;a&#39;) &amp;&amp; (c &lt;= &#39;z&#39;)) ? (c &amp; 0xdf) : c)</span>

<span class="cm">/*</span>
<span class="cm"> * Perform line-editing of AT-commands</span>
<span class="cm"> *</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *   p        inputbuffer</span>
<span class="cm"> *   count    length of buffer</span>
<span class="cm"> *   channel  index to line (minor-device)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_edit_at</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">eb</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">cnt</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="n">total</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CR</span><span class="p">]</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_LF</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* Separator (CR or LF) */</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_ECHO</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_ECHO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">eb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="n">eb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">,</span> <span class="s">&quot;AT&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))))</span>
				<span class="n">isdn_tty_parse_at</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_BS</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_BS</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Backspace-Function */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">)</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_ECHO</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_ECHO</span><span class="p">)</span>
					<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\b</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdchar</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_ECHO</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_ECHO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">eb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
				<span class="n">eb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">eb</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span> <span class="o">=</span> <span class="n">my_toupper</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
						<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="o">++</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="cm">/* Fall through, check for &#39;A&#39; */</span>
				<span class="k">case</span> <span class="mi">0</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;A&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
						<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="o">++</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmd</span><span class="p">[</span><span class="o">++</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmcmdl</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Switch all modem-channels who are online and got a valid</span>
<span class="cm"> * escape-sequence 1.5 seconds ago, to command-mode.</span>
<span class="cm"> * This function is called every second via timer-interrupt from within</span>
<span class="cm"> * timer-dispatcher isdn_timer_function()</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_tty_modem_escape</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ton</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">midx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">USG_MODEM</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">midx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">midx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ton</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">pluscount</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
					    <span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">lastplus</span> <span class="o">+</span> <span class="n">PLUSWAIT2</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">pluscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_OK</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMPLUS</span><span class="p">,</span> <span class="n">ton</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Put a RING-message to all modem-channels who have the RI-bit set.</span>
<span class="cm"> * This function is called every second via timer-interrupt from within</span>
<span class="cm"> * timer-dispatcher isdn_timer_function()</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_tty_modem_ring</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ton</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">UART_MSR_RI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ton</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_RING</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMRING</span><span class="p">,</span> <span class="n">ton</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For all online tty&#39;s, try sending data to</span>
<span class="cm"> * the lower levels.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_tty_modem_xmit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ton</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ton</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">isdn_tty_senddown</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_tint</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_MODEMXMIT</span><span class="p">,</span> <span class="n">ton</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check all channels if we have a &#39;no carrier&#39; timeout.</span>
<span class="cm"> * Timeout value is set by Register S7.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_tty_carrier_timeout</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ton</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdm</span><span class="p">.</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">carrierwait</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">.</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_WAITC</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">dialing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">isdn_tty_modem_result</span><span class="p">(</span><span class="n">RESULT_NO_CARRIER</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ton</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_CARRIER</span><span class="p">,</span> <span class="n">ton</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
