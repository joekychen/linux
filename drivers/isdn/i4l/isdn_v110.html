<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › i4l › isdn_v110.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isdn_v110.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: isdn_v110.c,v 1.1.2.2 2004/01/12 22:37:19 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Linux ISDN subsystem, V.110 related functions (linklevel).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright by Thomas Pfeiffer (pfeiffer@pds.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/isdn.h&gt;</span>
<span class="cp">#include &quot;isdn_v110.h&quot;</span>

<span class="cp">#undef ISDN_V110_DEBUG</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">isdn_v110_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.1.2.2 $&quot;</span><span class="p">;</span>

<span class="cp">#define V110_38400 255</span>
<span class="cp">#define V110_19200  15</span>
<span class="cp">#define V110_9600    3</span>

<span class="cm">/*</span>
<span class="cm"> * The following data are precoded matrices, online and offline matrix</span>
<span class="cm"> * for 9600, 19200 und 38400, respectively</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">V110_OnMatrix_9600</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span>
 <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">V110_OffMatrix_9600</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">V110_OnMatrix_19200</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span>
 <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">V110_OffMatrix_19200</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
 <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">V110_OnMatrix_38400</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">V110_OffMatrix_38400</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * FlipBits reorders sequences of keylen bits in one byte.</span>
<span class="cm"> * E.g. source order 7654321 will be converted to 45670123 when keylen = 4,</span>
<span class="cm"> * and to 67452301 when keylen = 2. This is necessary because ordering on</span>
<span class="cm"> * the isdn line is the other way.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">FlipBits</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hunks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">/</span> <span class="n">keylen</span><span class="p">);</span>

	<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hunks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">keylen</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">))</span>
				<span class="n">c</span> <span class="o">|=</span> <span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">keylen</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bit</span> <span class="o">&gt;&gt;=</span> <span class="n">keylen</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* isdn_v110_open allocates and initializes private V.110 data</span>
<span class="cm"> * structures and returns a pointer to these.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">isdn_v110_stream</span> <span class="o">*</span>
<span class="nf">isdn_v110_open</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">isdn_v110_stream</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">key</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="o">++</span><span class="p">;</span>

	<span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">/</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V110_38400</span>:
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">OnlineFrame</span> <span class="o">=</span> <span class="n">V110_OnMatrix_38400</span><span class="p">;</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">OfflineFrame</span> <span class="o">=</span> <span class="n">V110_OffMatrix_38400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V110_19200</span>:
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">OnlineFrame</span> <span class="o">=</span> <span class="n">V110_OnMatrix_19200</span><span class="p">;</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">OfflineFrame</span> <span class="o">=</span> <span class="n">V110_OffMatrix_19200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">OnlineFrame</span> <span class="o">=</span> <span class="n">V110_OnMatrix_9600</span><span class="p">;</span>
		<span class="n">v</span><span class="o">-&gt;</span><span class="n">OfflineFrame</span> <span class="o">=</span> <span class="n">V110_OffMatrix_9600</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">SyncInit</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">introducer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">dbit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">skbres</span> <span class="o">=</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">maxsize</span> <span class="o">=</span> <span class="n">maxsize</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">encodebuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">maxsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* isdn_v110_close frees private V.110 data structures */</span>
<span class="kt">void</span>
<span class="nf">isdn_v110_close</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_V110_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;v110 close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">encodebuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ValidHeaderBytes return the number of valid bytes in v-&gt;decodebuf</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ValidHeaderBytes</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodebuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SyncHeader moves the decodebuf ptr to the next valid header</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">SyncHeader</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rbuf</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">decodebuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rbuf</span><span class="o">++</span><span class="p">,</span> <span class="n">len</span><span class="o">--</span><span class="p">;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">,</span> <span class="n">rbuf</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* such den SyncHeader in buf ! */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">rbuf</span> <span class="o">&amp;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* erstes byte gefunden ?       */</span>
			<span class="k">break</span><span class="p">;</span>  <span class="cm">/* jupp!                        */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodebuf</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_V110_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_v110: Header resync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* DecodeMatrix takes n (n&gt;=1) matrices (v110 frames, 10 bytes) where</span>
<span class="cm">   len is the number of matrix-lines. len must be a multiple of 10, i.e.</span>
<span class="cm">   only complete matices must be given.</span>
<span class="cm">   From these, netto data is extracted and returned in buf. The return-value</span>
<span class="cm">   is the bytecount of the decoded data.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">DecodeMatrix</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbit</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">introducer</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">introducer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dbit</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">dbit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>    <span class="cm">/* Are we done with all lines of the matrix? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">line</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* the 0. line of the matrix is always 0 ! */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* not 0 ? -&gt; error! */</span>
<span class="cp">#ifdef ISDN_V110_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_v110: DecodeMatrix, V110 Bad Header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/* returning now is not the right thing, though :-( */</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="n">line</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* next line of matrix */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">line</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* in line 5 there&#39;s only e-bits ! */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* 011 has to be at the beginning! */</span>
<span class="cp">#ifdef ISDN_V110_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_v110: DecodeMatrix, V110 Bad 5th line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="cm">/* returning now is not the right thing, though :-( */</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="n">line</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* next line */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">introducer</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* every byte starts with 10 (stopbit, startbit) */</span>
			<span class="n">introducer</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mbit</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* current bit of the matrix */</span>
		<span class="nl">next_byte:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mbit</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* was it the last bit in this line ? */</span>
				<span class="n">mbit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no -&gt; take next */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>       <span class="cm">/* otherwise start with leftmost bit in the next line */</span>
			<span class="n">mbit</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
			<span class="n">line</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>        <span class="cm">/* otherwise we need to set a data bit */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mbit</span><span class="p">)</span>	<span class="cm">/* was that bit set in the matrix ? */</span>
				<span class="n">b</span> <span class="o">|=</span> <span class="n">dbit</span><span class="p">;</span>	<span class="cm">/* yes -&gt; set it in the data byte */</span>
			<span class="k">else</span>
				<span class="n">b</span> <span class="o">&amp;=</span> <span class="n">dbit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no -&gt; clear it in the data byte */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dbit</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>	<span class="cm">/* is that data byte done ? */</span>
				<span class="n">dbit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no, got the next bit */</span>
			<span class="k">else</span> <span class="p">{</span>  <span class="cm">/* data byte is done */</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">buflen</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>	<span class="cm">/* copy byte into the output buffer */</span>
				<span class="n">introducer</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* init of the intro sequence and of the data byte */</span>
				<span class="n">dbit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* next we look for the 0th bit */</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">next_byte</span><span class="p">;</span>	<span class="cm">/* look for next bit in the matrix */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">introducer</span> <span class="o">=</span> <span class="n">introducer</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">dbit</span> <span class="o">=</span> <span class="n">dbit</span><span class="p">;</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>          <span class="cm">/* return number of bytes in the output buffer */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DecodeStream receives V.110 coded data from the input stream. It recovers the</span>
<span class="cm"> * original frames.</span>
<span class="cm"> * The input stream doesn&#39;t need to be framed</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">isdn_v110_decode</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v110_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_decode called with NULL skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rbuf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* invalid handle, no chance to proceed */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_decode called with NULL stream!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* cache empty?               */</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">,</span> <span class="n">rbuf</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* scan for SyncHeader in buf */</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">rbuf</span> <span class="o">&amp;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* found first byte           */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* copy new data to decode-buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodebuf</span><span class="p">[</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span><span class="p">]),</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="nl">ReSync:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* got a new header ? */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>    <span class="cm">/* no, try later      */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ValidHeaderBytes</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* is that a valid header? */</span>
		<span class="n">SyncHeader</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>  <span class="cm">/* no -&gt; look for header */</span>
		<span class="k">goto</span> <span class="n">ReSync</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">-</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">)))</span> <span class="o">/</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">v110_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_decode: Couldn&#39;t allocate v110_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v110_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">v110_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodebuf</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">)</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="p">((</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">));</span>
		<span class="n">v110_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FlipBits</span><span class="p">(</span><span class="n">v110_buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodebuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">decodebuf</span><span class="p">[</span><span class="n">len</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">]),</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">decodelen</span><span class="p">);</span>

	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">DecodeMatrix</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v110_buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">v110_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* EncodeMatrix takes input data in buf, len is the bytecount.</span>
<span class="cm">   Data is encoded into v110 frames in m. Return value is the number of</span>
<span class="cm">   matrix-lines generated.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">EncodeMatrix</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mbit</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dbit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">introducer</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ibit</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="n">mlen</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* while we still have input data */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">line</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* in which line of the matrix are we? */</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* line 0 is always 0 */</span>
			<span class="n">mbit</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>	<span class="cm">/* go on with the 7th bit */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xbf</span><span class="p">;</span>	<span class="cm">/* line 5 is always 10111111 */</span>
			<span class="n">mbit</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>	<span class="cm">/* go on with the 7th bit */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="n">mlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110 (EncodeMatrix): buffer full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">line</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">next_bit:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mbit</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* leftmost or rightmost bit ? */</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">line</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* rightmost -&gt; go to next line */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="n">mlen</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110 (EncodeMatrix): buffer full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">line</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="mi">128</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>	<span class="cm">/* leftmost -&gt; set byte to 1000000 */</span>
			<span class="n">mbit</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>	<span class="cm">/* current bit in the matrix line */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">introducer</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* set 110 sequence ? */</span>
			<span class="n">introducer</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* set on digit less */</span>
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ibit</span><span class="p">[</span><span class="n">introducer</span><span class="p">]</span> <span class="o">?</span> <span class="n">mbit</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* set corresponding bit */</span>
			<span class="n">mbit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* bit of matrix line  &gt;&gt; 1 */</span>
			<span class="k">goto</span> <span class="n">next_bit</span><span class="p">;</span>	<span class="cm">/* and go on there */</span>
		<span class="p">}</span>               <span class="cm">/* else push data bits into the matrix! */</span>
		<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">dbit</span><span class="p">)</span> <span class="o">?</span> <span class="n">mbit</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* set data bit in matrix */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbit</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* was it the last one? */</span>
			<span class="n">dbit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* then go on with first bit of  */</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>            <span class="cm">/* next byte in input buffer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>	<span class="cm">/* input buffer done ? */</span>
				<span class="n">introducer</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* no, write introducer 110 */</span>
			<span class="k">else</span> <span class="p">{</span>  <span class="cm">/* input buffer done ! */</span>
				<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mbit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">;</span>	<span class="cm">/* set remaining bits in line to 1 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>          <span class="cm">/* not the last data bit */</span>
			<span class="n">dbit</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* then go to next data bit */</span>
		<span class="n">mbit</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>     <span class="cm">/* go to next bit of matrix */</span>
		<span class="k">goto</span> <span class="n">next_bit</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* if necessary, generate remaining lines of the matrix... */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">line</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">line</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mlen</span><span class="p">))</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">++</span><span class="n">line</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xbf</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:
			<span class="n">m</span><span class="p">[</span><span class="n">line</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">line</span><span class="p">;</span>            <span class="cm">/* that&#39;s how many lines we have */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build a sync frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">isdn_v110_sync</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* invalid handle, no chance to proceed */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_sync called with NULL stream!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">+</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbres</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbres</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">),</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">OfflineFrame</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Build an idle frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">isdn_v110_idle</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* invalid handle, no chance to proceed */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_sync called with NULL stream!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">+</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbres</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbres</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">),</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">OnlineFrame</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">isdn_v110_encode</span><span class="p">(</span><span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">olen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sval1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sval2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">v110buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* invalid handle, no chance to proceed */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_encode called with NULL stream!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* invalid skb, no chance to proceed */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_encode called with NULL skb!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">nframes</span> <span class="o">=</span> <span class="p">(</span><span class="n">rlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">v110buf</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">encodebuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">nframes</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">maxsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">maxsize</span><span class="p">;</span>
		<span class="n">rlen</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">maxsize</span> <span class="o">/</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">nframes</span> <span class="o">*</span> <span class="mi">40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbres</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_encode: Couldn&#39;t alloc skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbres</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">),</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">OnlineFrame</span><span class="p">,</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">);</span>
		<span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">nskb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mlen</span> <span class="o">=</span> <span class="n">EncodeMatrix</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rlen</span><span class="p">,</span> <span class="n">v110buf</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="cm">/* now distribute 2 or 4 bits each to the output stream! */</span>
	<span class="n">rbuf</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">olen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sval1</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">;</span>
	<span class="n">sval2</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&lt;&lt;</span> <span class="n">sval1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v110buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">FlipBits</span><span class="p">(</span><span class="n">v110buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">rbuf</span><span class="o">++</span> <span class="o">=</span> <span class="o">~</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">|</span> <span class="p">(((</span><span class="n">v110buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">sval2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">sval1</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110_encode: buffers full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">buffer_full</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">olen</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">buffer_full:</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">olen</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span> <span class="o">=</span> <span class="n">rlen</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nskb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">isdn_v110_stat_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_v110_stream</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_STAT_BSENT</span>:
		<span class="cm">/* Keep the send-queue of the driver filled</span>
<span class="cm">		 * with frames:</span>
<span class="cm">		 * If number of outstanding frames &lt; 3,</span>
<span class="cm">		 * send down an Idle-Frame (or an Sync-Frame, if</span>
<span class="cm">		 * v-&gt;SyncInit != 0).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110use</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">*</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">skbidle</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">v</span><span class="o">-&gt;</span><span class="n">skbidle</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">skbuser</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">v</span><span class="o">-&gt;</span><span class="n">skbuser</span><span class="o">--</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbuser</span> <span class="o">+</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">skbidle</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">SyncInit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_v110_sync</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_v110_idle</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">writebuf_skb</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">SyncInit</span><span class="p">)</span>
						<span class="n">v</span><span class="o">-&gt;</span><span class="n">SyncInit</span><span class="o">--</span><span class="p">;</span>
					<span class="n">v</span><span class="o">-&gt;</span><span class="n">skbidle</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110use</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_STAT_DHUP</span>:
	<span class="k">case</span> <span class="n">ISDN_STAT_BHUP</span>:
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110use</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110use</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">isdn_v110_close</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_STAT_BCONN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110emu</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">hdrlen</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">maxsize</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">maxbufsize</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110use</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110emu</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11096</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">isdn_v110_open</span><span class="p">(</span><span class="n">V110_9600</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11019</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">isdn_v110_open</span><span class="p">(</span><span class="n">V110_19200</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ISDN_PROTO_L2_V11038</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">isdn_v110_open</span><span class="p">(</span><span class="n">V110_38400</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">SyncInit</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_v110_sync</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">writebuf_skb</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="cm">/* Unable to send, try later */</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">v</span><span class="o">-&gt;</span><span class="n">SyncInit</span><span class="o">--</span><span class="p">;</span>
					<span class="n">v</span><span class="o">-&gt;</span><span class="n">skbidle</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_v110: Couldn&#39;t open stream for chan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v110use</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
