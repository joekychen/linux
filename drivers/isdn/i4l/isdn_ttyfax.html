<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › i4l › isdn_ttyfax.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isdn_ttyfax.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: isdn_ttyfax.c,v 1.1.2.2 2004/01/12 22:37:19 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Linux ISDN subsystem, tty_fax AT-command emulator (linklevel).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1999    by Armin Schindler (mac@melware.de)</span>
<span class="cm"> * Copyright 1999    by Ralf Spachmann (mel@melware.de)</span>
<span class="cm"> * Copyright 1999    by Cytronics &amp; Melware</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#undef ISDN_TTY_FAX_STAT_DEBUG</span>
<span class="cp">#undef ISDN_TTY_FAX_CMD_DEBUG</span>

<span class="cp">#include &lt;linux/isdn.h&gt;</span>
<span class="cp">#include &quot;isdn_common.h&quot;</span>
<span class="cp">#include &quot;isdn_tty.h&quot;</span>
<span class="cp">#include &quot;isdn_ttyfax.h&quot;</span>


<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isdn_tty_fax_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.1.2.2 $&quot;</span><span class="p">;</span>

<span class="cp">#define PARSE_ERROR1 { isdn_tty_fax_modem_result(1, info); return 1; }</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">isdn_getrev</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">revision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">revision</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">rev</span><span class="p">,</span> <span class="sc">&#39;$&#39;</span><span class="p">);</span>
		<span class="o">*--</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rev</span> <span class="o">=</span> <span class="s">&quot;???&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fax Class 2 Modem results</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="n">T30_s</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rs</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">rss</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="s">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s">&quot;+FCON&quot;</span><span class="p">,</span> <span class="s">&quot;+FCSI:&quot;</span><span class="p">,</span> <span class="s">&quot;+FDIS:&quot;</span><span class="p">,</span>
		 <span class="s">&quot;+FHNG:&quot;</span><span class="p">,</span> <span class="s">&quot;+FDCS:&quot;</span><span class="p">,</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">,</span> <span class="s">&quot;+FTSI:&quot;</span><span class="p">,</span>
		 <span class="s">&quot;+FCFR&quot;</span><span class="p">,</span> <span class="s">&quot;+FPTS:&quot;</span><span class="p">,</span> <span class="s">&quot;+FET:&quot;</span><span class="p">};</span>


	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">code</span><span class="p">],</span> <span class="n">info</span><span class="p">);</span>

<span class="cp">#ifdef ISDN_TTY_FAX_CMD_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax send %s on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">msg</span><span class="p">[</span><span class="n">code</span><span class="p">],</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* OK */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* ERROR */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* +FCON */</span>
		<span class="cm">/* Append CPN, if enabled */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_CPNFCON</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT_CPNFCON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ISDN_USAGE_OUTGOING</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;/%s&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">cpn</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_A</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* +FCSI */</span>
	<span class="k">case</span> <span class="mi">8</span>:	<span class="cm">/* +FTSI */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">r_id</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* +FDIS */</span>
		<span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">r_resolution</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="s">&quot;%c%s&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_TTY_FAX_CMD_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax DIS=%s on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:	<span class="cm">/* +FHNG */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:	<span class="cm">/* +FDCS */</span>
		<span class="n">rs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">r_resolution</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="s">&quot;%c%s&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span>
				<span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_TTY_FAX_CMD_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax DCS=%s on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:	<span class="cm">/* CONNECT */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:	<span class="cm">/* FCFR */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:	<span class="cm">/* FPTS */</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:	<span class="cm">/* FET */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fet</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">7</span>:	<span class="cm">/* CONNECT */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">XON</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_fax_command1</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">,</span> <span class="s">&quot;NO CARRIER&quot;</span><span class="p">,</span> <span class="s">&quot;ERROR&quot;</span><span class="p">,</span> <span class="s">&quot;FCERROR&quot;</span><span class="p">};</span>

<span class="cp">#ifdef ISDN_TTY_FAX_CMD_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: FCLASS1 cmd(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&lt;</span> <span class="n">ISDN_FAX_CLASS1_QUERY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span><span class="p">],</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_FAX_CLASS1_CONNECT</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_FAX_CLASS1_OK</span>:
	<span class="k">case</span> <span class="n">ISDN_FAX_CLASS1_FCERROR</span>:
	<span class="k">case</span> <span class="n">ISDN_FAX_CLASS1_ERROR</span>:
	<span class="k">case</span> <span class="n">ISDN_FAX_CLASS1_NOCARR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_FAX_CLASS1_QUERY</span>:
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="n">ISDN_FAX_CLASS1_ERROR</span><span class="p">],</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">para</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">OK</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">isdn_tty_fax_command</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">T30_s</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_FCLASS1</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdn_tty_fax_command1</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">c</span><span class="p">));</span>

<span class="cp">#ifdef ISDN_TTY_FAX_CMD_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax cmd %d on ttyI%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">f</span><span class="o">-&gt;</span><span class="n">r_code</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">r_code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_FCON</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FCON */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_FCON_I</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FCON */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_RID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FCSI */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FTSI */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_DIS</span>:
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FDIS */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_HNG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_C</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">ISDN_TTY_FAX_CONN_IN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;%c%c&quot;</span><span class="p">,</span> <span class="n">DLE</span><span class="p">,</span> <span class="n">ETX</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* leave data mode */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_E</span><span class="p">;</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FHNG */</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* OK */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_DCS</span>:
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FDCS */</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* CONNECT */</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_C</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_TRAIN_OK</span>:
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FDCS */</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* OK */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_SENT</span>:
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* OK */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_CFR</span>:
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FCFR */</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_ET</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;%c%c&quot;</span><span class="p">,</span> <span class="n">DLE</span><span class="p">,</span> <span class="n">ETX</span><span class="p">);</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FPTS */</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FET */</span>
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* OK */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* leave data mode */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_D</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_PTS</span>:
		<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* +FPTS */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">direction</span> <span class="o">==</span> <span class="n">ISDN_TTY_FAX_CONN_OUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fet</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_B</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fet</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* OK */</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ISDN_TTY_FAX_EOP</span>:
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* leave data mode */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">online</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_D</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="nf">isdn_tty_fax_bitorder</span><span class="p">(</span><span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">LeftMask</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">RightMask</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">fBit</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">Data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="o">-&gt;</span><span class="n">bor</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">Data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span>
				<span class="n">LeftMask</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">RightMask</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">LeftMask</span> <span class="o">&gt;</span> <span class="n">RightMask</span><span class="p">;</span>
				<span class="n">LeftMask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">RightMask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span>
				<span class="p">)</span> <span class="p">{</span>
				<span class="n">fBit</span> <span class="o">=</span> <span class="p">(</span><span class="n">Data</span> <span class="o">&amp;</span> <span class="n">LeftMask</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">Data</span> <span class="o">&amp;</span> <span class="n">RightMask</span><span class="p">)</span>
					<span class="n">Data</span> <span class="o">|=</span> <span class="n">LeftMask</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">Data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LeftMask</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fBit</span><span class="p">)</span>
					<span class="n">Data</span> <span class="o">|=</span> <span class="n">RightMask</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">Data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RightMask</span><span class="p">;</span>

			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse AT+F.. FAX class 1 commands</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_cmd_FCLASS1</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="s">&quot;AE&quot;</span><span class="p">,</span> <span class="s">&quot;TS&quot;</span><span class="p">,</span> <span class="s">&quot;RS&quot;</span><span class="p">,</span> <span class="s">&quot;TM&quot;</span><span class="p">,</span> <span class="s">&quot;RM&quot;</span><span class="p">,</span> <span class="s">&quot;TH&quot;</span><span class="p">,</span> <span class="s">&quot;RH&quot;</span><span class="p">};</span>
	<span class="n">isdn_ctrl</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">par</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">[</span><span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef ISDN_TTY_FAX_CMD_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_cmd_FCLASS1 (%s,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">PARSE_ERROR1</span><span class="p">;</span>

	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">AT_QUERY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">AT_EQ_QUERY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">AT_EQ_VALUE</span><span class="p">;</span>
			<span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">=</span> <span class="n">AT_COMMAND</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PARSE_ERROR1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">c</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_FAXCMD</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_CMD_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty_cmd_FCLASS1 %d/%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span><span class="p">,</span> <span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="n">AT_EQ_VALUE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">aux</span><span class="p">.</span><span class="n">subcmd</span> <span class="o">==</span> <span class="n">AT_COMMAND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* get a temporary connection to the first free fax driver */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_get_free_channel</span><span class="p">(</span><span class="n">ISDN_USAGE_FAX</span><span class="p">,</span> <span class="n">ISDN_PROTO_L2_FAX</span><span class="p">,</span>
					  <span class="n">ISDN_PROTO_L3_FCLASS1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;00&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drvmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chanmap</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">line</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">c</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">isdn_free_channel</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span>
				  <span class="n">ISDN_USAGE_FAX</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_idx</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">drv_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
		<span class="n">c</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Parse AT+F.. FAX class 2 commands</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_tty_cmd_FCLASS2</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atemu</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">emu</span><span class="p">;</span>
	<span class="n">T30_s</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fax</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">par</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rs</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">rss</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">maxdccval</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">};</span>

	<span class="cm">/* FAA still unchanged */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;AA&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* TODO */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* BADLIN=value - dummy 0=disable errorchk disabled, 1-255 nr. of lines for making page bad */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;BADLIN&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">badlin</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0-255&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">badlin</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FBADLIN=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* BADMUL=value - dummy 0=disable errorchk disabled (threshold multiplier) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;BADMUL&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">badmul</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0-255&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">badmul</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FBADMUL=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* BOR=n - Phase C bit order, 0=direct, 1=reverse */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;BOR&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">bor</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,1&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">bor</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FBOR=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* NBC=n - No Best Capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;NBC&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">nbc</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,1&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">nbc</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FNBC=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* BUF? - Readonly buffersize readout  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;BUF?&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FBUF? (%d) </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]));</span>
<span class="cp">#endif</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s"> %d &quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">mdmreg</span><span class="p">[</span><span class="n">REG_PSIZE</span><span class="p">]));</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* CIG=string - local fax station id string for polling rx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;CIG&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">pollid</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n\&quot;</span><span class="s">STRING</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
					<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">pollid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
					<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">FAXIDLEN</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">pollid</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">pollid</span><span class="p">[</span><span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax local poll ID rx </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">pollid</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* CQ=n - copy qlty chk, 0= no chk, 1=only 1D chk, 2=1D+2D chk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;CQ&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,1,2&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">cq</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FCQ=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* CR=n - can receive? 0= no data rx or poll remote dev, 1=do receive data or poll remote dev */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;CR&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">);</span>	<span class="cm">/* read actual value from struct and print */</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,1&quot;</span><span class="p">);</span>		<span class="cm">/* display online help */</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">cr</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FCR=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* CTCRTY=value - ECM retry count */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;CTCRTY&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">ctcrty</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0-255&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">ctcrty</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FCTCRTY=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* DCC=vr,br,wd,ln,df,ec,bf,st - DCE capabilities parms */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;DCC&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">resolution</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="s">&quot;%c%s&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span>
					<span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">(0,1),(0-5),(0-2),(0-2),(0-3),(0-2),(0),(0-7)&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxdccval</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
							<span class="n">PARSE_ERROR1</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">48</span><span class="p">;</span>
						<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
							<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FDCC capabilities DCE=%d,%d,%d,%d,%d,%d,%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* DIS=vr,br,wd,ln,df,ec,bf,st - current session parms */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;DIS&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">resolution</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="s">&quot;%c%s&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">48</span><span class="p">,</span>
					<span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="n">strcat</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">rss</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">(0,1),(0-5),(0-2),(0-2),(0-3),(0-2),(0),(0-7)&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxdccval</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
							<span class="n">PARSE_ERROR1</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="n">rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">48</span><span class="p">;</span>
						<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
							<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FDIS session parms=%d,%d,%d,%d,%d,%d,%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* DR - Receive Phase C data command, initiates document reception */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;DR&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* incoming connection */</span>
		    <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_B</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_D</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FDR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">ISDN_TTY_FAX_DR</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_FAXCMD</span><span class="p">;</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_B</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_C</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_D</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fet</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">0</span>:	<span class="cm">/* next page will be received */</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_C</span><span class="p">;</span>
					<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* CONNECT */</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:	<span class="cm">/* next doc will be received */</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_B</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:	<span class="cm">/* fax session is terminating */</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_E</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* DT=df,vr,wd,ln - TX phase C data command (release DCE to proceed with negotiation) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;DT&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">[]</span> <span class="o">=</span>
			<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">resolution</span><span class="p">;</span>

		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>	<span class="cm">/* not outgoing connection */</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">48</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxdccval</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="p">{</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rp</span><span class="p">[</span><span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">48</span><span class="p">;</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span><span class="p">)</span>
					<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FDT tx data command parms=%d,%d,%d,%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rp</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_B</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_D</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">ISDN_TTY_FAX_DT</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_FAXCMD</span><span class="p">;</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_D</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">=</span> <span class="n">ISDN_FAX_PHASE_C</span><span class="p">;</span>
				<span class="n">isdn_tty_fax_modem_result</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>	<span class="cm">/* CONNECT */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* ECM=n - Error mode control 0=disabled, 2=enabled, handled by DCE alone incl. buff of partial pages */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;ECM&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">ecm</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,2&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">par</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">ecm</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FECM=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* ET=n - End of page or document */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;ET=&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0-2&quot;</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">!=</span> <span class="n">ISDN_FAX_PHASE_D</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">faxonline</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
				<span class="n">PARSE_ERROR1</span><span class="p">;</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fet</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">ISDN_TTY_FAX_ET</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_driver</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_FAXCMD</span><span class="p">;</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FET=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* K - terminate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;K&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_IDLE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">phase</span> <span class="o">==</span> <span class="n">ISDN_FAX_PHASE_E</span><span class="p">))</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="n">isdn_tty_modem_hup</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* LID=string - local fax ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;LID&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n\&quot;</span><span class="s">STRING</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
					<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;&quot;&#39;</span><span class="p">)</span>
					<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">FAXIDLEN</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">FAXIDLEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax local ID </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MDL? - DCE Model       */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;MDL?&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: FMDL?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">isdn4linux&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* MFR? - DCE Manufacturer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;MFR?&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: FMFR?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">isdn4linux&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* MINSP=n - Minimum Speed for Phase C */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;MINSP&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">minsp</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0-5&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">minsp</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FMINSP=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* PHCTO=value - DTE phase C timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;PHCTO&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">phcto</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0-255&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">phcto</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FPHCTO=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* REL=n - Phase C received EOL alignment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;REL&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">rel</span><span class="p">);</span>
			<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">0,1&quot;</span><span class="p">);</span>
				<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">par</span> <span class="o">=</span> <span class="n">isdn_getnum</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">par</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">par</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">PARSE_ERROR1</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">rel</span> <span class="o">=</span> <span class="n">par</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FREL=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">par</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* REV? - DCE Revision */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;REV?&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: FREV?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="n">isdn_tty_fax_revision</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">Rev: %s&quot;</span><span class="p">,</span> <span class="n">isdn_getrev</span><span class="p">(</span><span class="n">rss</span><span class="p">));</span>
		<span class="n">isdn_tty_at_cout</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Phase C Transmit Data Block Size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;TBC=&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* dummy, not used */</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_TTY_FAX_STAT_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: Fax FTBC=%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#endif</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
			<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">PARSE_ERROR1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_tty: unknown token=&gt;AT+F%s&lt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">PARSE_ERROR1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">isdn_tty_cmd_PLUSF_FAX</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="n">modem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_FCLASS2</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdn_tty_cmd_FCLASS2</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">TTY_IS_FCLASS1</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdn_tty_cmd_FCLASS1</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">info</span><span class="p">));</span>
	<span class="n">PARSE_ERROR1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
