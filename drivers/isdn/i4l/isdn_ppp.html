<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › i4l › isdn_ppp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isdn_ppp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: isdn_ppp.c,v 1.1.2.3 2004/02/10 01:07:13 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Linux ISDN subsystem, functions for synchronous PPP (linklevel).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1995,96 by Michael Hipp (Michael.Hipp@student.uni-tuebingen.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/isdn.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/ppp-comp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
<span class="cp">#include &lt;linux/filter.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;isdn_common.h&quot;</span>
<span class="cp">#include &quot;isdn_ppp.h&quot;</span>
<span class="cp">#include &quot;isdn_net.h&quot;</span>

<span class="cp">#ifndef PPP_IPX</span>
<span class="cp">#define PPP_IPX 0x002b</span>
<span class="cp">#endif</span>

<span class="cm">/* Prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_ppp_fill_rq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_ppp_closewait</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_push_higher</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_ppp_if_get_unit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">namebuf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_ppp_set_compressor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isdn_ppp_comp_data</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">isdn_ppp_decompress</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">proto</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_receive_ccp</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">isdn_ppp_compress</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_in</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">proto</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_send_ccp</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="cm">/* New CCP stuff */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_ccp_kickup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_ccp_xmit_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ippp_ccp_reset</span> <span class="o">*</span><span class="n">isdn_ppp_ccp_reset_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_ccp_reset_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_ccp_reset_free_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_ccp_timer_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">closure</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="n">isdn_ppp_ccp_reset_alloc_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
								   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_ccp_reset_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">isdn_ppp_resetparams</span> <span class="o">*</span><span class="n">rp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_ccp_reset_ack_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">);</span>



<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
<span class="k">static</span> <span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">isdn_ppp_bundle_arr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_ppp_mp_bundle_array_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_ppp_mp_init</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">add_to</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_mp_receive</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_mp_cleanup</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_ppp_bundle</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">);</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_ISDN_MPP */</span><span class="cp"></span>

<span class="kt">char</span> <span class="o">*</span><span class="n">isdn_ppp_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.1.2.3 $&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">ISDN_MAX_CHANNELS</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isdn_ppp_compressor</span> <span class="o">*</span><span class="n">ipc_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * frame log (debug)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_ppp_frame_log</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span>
		<span class="n">j</span><span class="p">,</span>
		<span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">)</span>
		<span class="n">maxlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="n">cnt</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;[%d/%d].%s[%d]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * unbind isdn_net_local &lt;=&gt; ippp-device</span>
<span class="cm"> * note: it can happen, that we hangup/free the master before the slaves</span>
<span class="cm"> *       in this case we bind another lp to the master device</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_ppp_free</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">isdn_net_rm_from_bundle</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">ref_ct</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* last link in queue? */</span>
		<span class="n">isdn_ppp_mp_cleanup</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">ref_ct</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_MPP */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ppp_slot(%d) now invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_CONNECT</span><span class="p">))</span>
		<span class="n">isdn_ppp_closewait</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>	<span class="cm">/* force wakeup on ippp device */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_ASSIGNED</span><span class="p">)</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPPP_OPEN</span><span class="p">;</span>	<span class="cm">/* fallback to &#39;OPEN but not ASSIGNED&#39; state */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp_free %d %lx %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">lp</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>          <span class="cm">/* link is down .. set lp to NULL */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>      <span class="cm">/* is this OK ?? */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bind isdn_net_local &lt;=&gt; ippp-device</span>
<span class="cm"> *</span>
<span class="cm"> * This function is allways called with holding dev-&gt;lock so</span>
<span class="cm"> * no additional lock is needed</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_ppp_bind</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pppbind</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* device bounded to ippp device ? */</span>
		<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">exclusive</span><span class="p">[</span><span class="n">ISDN_MAX_CHANNELS</span><span class="p">];</span>	<span class="cm">/* exclusive flags */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">exclusive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">net_dev</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* step through net devices to find exclusive minors */</span>
			<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pppbind</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">exclusive</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pppbind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">net_dev</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * search a free device / slot</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IPPP_OPEN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">exclusive</span><span class="p">[</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">])</span> <span class="p">{</span>	<span class="cm">/* OPEN, but not connected! */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pppbind</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_OPEN</span><span class="p">)</span> <span class="o">==</span> <span class="n">IPPP_OPEN</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_ppp_bind: Can&#39;t find a (free) connection to the ipppd daemon.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* get unit number from interface name .. ugly! */</span>
	<span class="n">unit</span> <span class="o">=</span> <span class="n">isdn_ppp_if_get_unit</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_bind: illegal interface name %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPPP_OPEN</span> <span class="o">|</span> <span class="n">IPPP_ASSIGNED</span><span class="p">;</span>	<span class="cm">/* assigned to a netdevice but not connected */</span>
<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">isdn_ppp_mp_init</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_MPP */</span><span class="cp"></span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kick the ipppd on the device</span>
<span class="cm"> * (wakes up daemon after B-channel connect)</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">isdn_ppp_wakeup_daemon</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPPP_OPEN</span> <span class="o">|</span> <span class="n">IPPP_CONNECT</span> <span class="o">|</span> <span class="n">IPPP_NOBLOCK</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * there was a hangup on the netdevice</span>
<span class="cm"> * force wakeup of the ippp device</span>
<span class="cm"> * go into &#39;device waits for release&#39; state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_ppp_closewait</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPPP_CLOSEWAIT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isdn_ppp_find_slot / isdn_ppp_free_slot</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_ppp_get_slot</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isdn_ppp_open</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">isdn_ppp_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">min</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">isdn_ppp_get_slot</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp, open, slot: %d, minor: %d, state: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">slot</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="cm">/* compression stuff */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span>   <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">decompressor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span>    <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span>  <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">decomp_stat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">isdn_ppp_ccp_reset_alloc</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>

	<span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">mp_seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>       <span class="cm">/* MP sequence number */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>         <span class="cm">/* ppp configuration */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="cm">/* mppp configuration */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">last_link_seqno</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* MP: maybe set to Bundle-MIN, when joining a bundle ?? */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>          <span class="cm">/* set, when we have our interface */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">=</span> <span class="mi">1524</span><span class="p">;</span>         <span class="cm">/* MRU, default 1524 */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">maxcid</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>        <span class="cm">/* VJ: maxcid */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">tk</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">+</span> <span class="n">NUM_RCV_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* receive queue */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP_VJ</span>
	<span class="cm">/*</span>
<span class="cm">	 * VJ header compression init</span>
<span class="cm">	 */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">slcomp</span> <span class="o">=</span> <span class="n">slhc_init</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* not necessary for 2. link in bundle */</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IPPP_OPEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release ippp device</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_ppp_release</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">min</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no file-&gt;private_data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp: release, minor: %d %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>           <span class="cm">/* a lp address says: this link is still up */</span>
		<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no lp-&gt;netdev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPPP_CONNECT</span><span class="p">;</span>	<span class="cm">/* -&gt; effect: no call of wakeup */</span>
		<span class="cm">/*</span>
<span class="cm">		 * isdn_net_hangup() calls isdn_ppp_free()</span>
<span class="cm">		 * isdn_ppp_free() sets is-&gt;lp to NULL and lp-&gt;ppp_slot to -1</span>
<span class="cm">		 * removing the IPPP_CONNECT flag omits calling of isdn_ppp_wakeup_daemon()</span>
<span class="cm">		 */</span>
		<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RCV_BUFFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">+</span> <span class="n">NUM_RCV_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* receive queue */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISDN_PPP_VJ</span>
<span class="cm">/* TODO: if this was the previous master: link the slcomp to the new master */</span>
	<span class="n">slhc_free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">slcomp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/* TODO: if this was the previous master: link the stuff to the new master */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">)</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">)</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span><span class="p">)</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">decomp_stat</span><span class="p">)</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">decompressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">decomp_stat</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span>   <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">decompressor</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span>    <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">decomp_stat</span>  <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Clean up if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">isdn_ppp_ccp_reset_free</span><span class="p">(</span><span class="n">is</span><span class="p">);</span>

	<span class="cm">/* this slot is ready for new connections */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get_arg .. ioctl helper</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_arg</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set arg .. ioctl helper</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_arg</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_filter</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock_filter</span> <span class="o">**</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sock_fprog</span> <span class="n">uprog</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock_filter</span> <span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uprog</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uprog</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uprog</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* uprog.len is unsigned short, so no overflow here */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">uprog</span><span class="p">.</span><span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock_filter</span><span class="p">);</span>
	<span class="n">code</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">uprog</span><span class="p">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sk_chk_filter</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">uprog</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">uprog</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IPPP_FILTER */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * ippp device ioctl</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_ppp_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isdn_ppp_comp_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">is</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp_ioctl: minor: %d cmd: %x state: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_OPEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPPIOCBUNDLE</span>:
<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_CONNECT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;iPPP-bundle: minor: %d, slave unit: %d, master unit: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">min</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">isdn_ppp_bundle</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCGUNIT</span>:	<span class="cm">/* get ppp/isdn unit number */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCGIFNAME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				 <span class="n">strlen</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCGMPFLAGS</span>:	<span class="cm">/* get configuration flags */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">mpppcfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">mpppcfg</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSMPFLAGS</span>:	<span class="cm">/* set configuration flags */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCGFLAGS</span>:	<span class="cm">/* get configuration flags */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSFLAGS</span>:	<span class="cm">/* set configuration flags */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SC_ENABLE_IP</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_ENABLE_IP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_CONNECT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* OK .. we are ready to send buffers */</span>
				<span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span> <span class="cm">/* isdn_ppp_xmit test for SC_ENABLE_IP !!! */</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCGIDLE</span>:	<span class="cm">/* get idle time information */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ppp_idle</span> <span class="n">pidle</span><span class="p">;</span>
			<span class="n">pidle</span><span class="p">.</span><span class="n">xmit_idle</span> <span class="o">=</span> <span class="n">pidle</span><span class="p">.</span><span class="n">recv_idle</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pidle</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_idle</span><span class="p">))))</span>
				<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSMRU</span>:	<span class="cm">/* set receive unit size for PPP */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSMPMRU</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSMPMTU</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSMAXCID</span>:	<span class="cm">/* set the maximum compression slot id */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">val</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">maxcid</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP_VJ</span>
			<span class="k">struct</span> <span class="n">slcompress</span> <span class="o">*</span><span class="n">sltmp</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp, ioctl: changed MAXCID to %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">maxcid</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP_VJ</span>
			<span class="n">sltmp</span> <span class="o">=</span> <span class="n">slhc_init</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sltmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp, can&#39;t realloc slhc struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">)</span>
				<span class="n">slhc_free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">);</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">slcomp</span> <span class="o">=</span> <span class="n">sltmp</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCGDEBUG</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSDEBUG</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCGCOMPRESSORS</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">protos</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,};</span>
		<span class="k">struct</span> <span class="n">isdn_ppp_compressor</span> <span class="o">*</span><span class="n">ipc</span> <span class="o">=</span> <span class="n">ipc_head</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ipc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">/</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">%</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">protos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ipc</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">protos</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPPIOCSCOMPRESSOR</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">r</span> <span class="o">=</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdn_ppp_comp_data</span><span class="p">))))</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">isdn_ppp_set_compressor</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PPPIOCGCALLINFO</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">pppcallinfo</span> <span class="n">pci</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pppcallinfo</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">pci</span><span class="p">.</span><span class="n">local_num</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="mi">63</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">pci</span><span class="p">.</span><span class="n">remote_num</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="mi">63</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pci</span><span class="p">.</span><span class="n">charge_units</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">charge</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">)</span>
				<span class="n">pci</span><span class="p">.</span><span class="n">calltype</span> <span class="o">=</span> <span class="n">CALLTYPE_OUTGOING</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pci</span><span class="p">.</span><span class="n">calltype</span> <span class="o">=</span> <span class="n">CALLTYPE_INCOMING</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CALLBACK</span><span class="p">)</span>
				<span class="n">pci</span><span class="p">.</span><span class="n">calltype</span> <span class="o">|=</span> <span class="n">CALLTYPE_CALLBACK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">set_arg</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pppcallinfo</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
	<span class="k">case</span> <span class="n">PPPIOCSPASS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock_filter</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">get_filter</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span><span class="p">);</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">PPPIOCSACTIVE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sock_filter</span> <span class="o">*</span><span class="n">code</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">get_filter</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span><span class="p">);</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">active_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IPPP_FILTER */</span><span class="cp"></span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">isdn_ppp_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_buf_queue</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">bl</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>

	<span class="n">is</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp_poll: minor: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">));</span>

	<span class="cm">/* just registers wait_queue hook. This doesn&#39;t really wait. */</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_OPEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IPPP_CLOSEWAIT</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">POLLHUP</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp: device not open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">POLLERR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we&#39;re always ready to send .. */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bl</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * if IPPP_NOBLOCK is set we return even if we have nothing to read</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">bl</span> <span class="o">||</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_NOBLOCK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IPPP_NOBLOCK</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  fill up isdn_ppp_read() queue ..</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_ppp_fill_rq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_buf_queue</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">bl</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">nbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp: illegal slot(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_CONNECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp: device not activated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp: Can&#39;t alloc buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PPP_ALLSTATIONS</span><span class="p">;</span>
	<span class="n">nbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">PPP_UI</span><span class="p">;</span>
	<span class="n">nbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">proto</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">nbuf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">proto</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nbuf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
	<span class="n">bl</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bf</span> <span class="o">==</span> <span class="n">bl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp: Queue is full; discarding first buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bl</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">nbuf</span><span class="p">;</span>
	<span class="n">bl</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">is</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">bl</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * read() .. non-blocking: ipppd calls it only after select()</span>
<span class="cm"> *           reports, that there is data</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">isdn_ppp_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_buf_queue</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">save_buf</span><span class="p">;</span>

	<span class="n">is</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_OPEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">save_buf</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">save_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">save_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">save_buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ipppd wanna write a packet to the card .. non-blocking</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">isdn_ppp_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">protobuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="n">is</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">IPPP_CONNECT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>

	<span class="cm">/* -&gt; push it directly to the lowlevel interface */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp_write: lp == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t reset huptimer for</span>
<span class="cm">		 * LCP packets. (Echo requests).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">protobuf</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_PROTOCOL</span><span class="p">(</span><span class="n">protobuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">PPP_LCP</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DRV_FLAG_RUNNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hl</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * we need to reserve enough space in front of</span>
<span class="cm">			 * sk_buff. old call to dev_alloc_skb only reserved</span>
<span class="cm">			 * 16 bytes, now we are looking what the driver want</span>
<span class="cm">			 */</span>
			<span class="n">hl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">hl</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_ppp_write: out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ppp xmit: len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;xmit&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">isdn_ppp_send_ccp</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span> <span class="cm">/* keeps CCP/compression states in sync */</span>

			<span class="n">isdn_net_write_super</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init memory, structures etc.</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">isdn_ppp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span>
		<span class="n">j</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_mp_bundle_array_init</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_MPP */</span><span class="cp"></span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_ppp_init: Could not alloc ippp_table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
		<span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">+</span> <span class="n">NUM_RCV_BUFFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_RCV_BUFFS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">last</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">NUM_RCV_BUFFS</span> <span class="o">+</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RCV_BUFFS</span><span class="p">;</span>
			<span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rq</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rq</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RCV_BUFFS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">isdn_ppp_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isdn_ppp_bundle_arr</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_MPP */</span><span class="cp"></span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * check for address/control field and skip if allowed</span>
<span class="cm"> * retval != 0 -&gt; discard packet silently</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_ppp_skip_ac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>skip address/control (AC) field</p></td><td class="code"><div class="highlight"><pre>		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_REJ_COMP_AC</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>if AC compression was not negotiated, but used, discard packet</p></td><td class="code"><div class="highlight"><pre>			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the PPP protocol header and pull skb</span>
<span class="cm"> * retval &lt; 0 -&gt; discard packet silently</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_ppp_strip_proto</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>protocol field is compressed</p></td><td class="code"><div class="highlight"><pre>		<span class="n">proto</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">proto</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * handler for incoming packets on a syncPPP interface</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">isdn_ppp_receive</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span> <span class="c1">// we&#39;re called with the master device always</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_receive: lp-&gt;ppp_slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_receive: is:%08lx lp:%08lx slot:%d unit:%d len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">is</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">lp</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;receive&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_skip_ac</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">proto</span> <span class="o">=</span> <span class="n">isdn_ppp_strip_proto</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;</span> <span class="n">SC_LINK_DECOMP_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_ppp_decompress</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">is</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proto</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="c1">// decompression error</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">&amp;</span> <span class="n">SC_REJ_MP_PROT</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// we agreed to receive MPPP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_MP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_ppp_mp_receive</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">isdn_ppp_push_higher</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * we receive a reassembled frame, MPPP has been taken care of before.</span>
<span class="cm"> * address/control and protocol have been stripped from the skb</span>
<span class="cm"> * note: net_dev has to be master net_dev</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_ppp_push_higher</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="o">*</span><span class="n">mis</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">mlp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_push_higher: lp-&gt;ppp_slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// FIXME?</span>
		<span class="n">mlp</span> <span class="o">=</span> <span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_push_higher: master-&gt;ppp_slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mis</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;push, skb %d %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>
		<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;rpush&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mis</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;</span> <span class="n">SC_DECOMP_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_ppp_decompress</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">is</span><span class="p">,</span> <span class="n">mis</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proto</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="c1">// decompression error</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PPP_IPX</span>:  <span class="cm">/* untested */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp: IPX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPX</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPP_IP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp: IP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPP_COMP</span>:
	<span class="k">case</span> <span class="n">PPP_COMPFRAG</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_ppp: unexpected compressed frame dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP_VJ</span>
	<span class="k">case</span> <span class="n">PPP_VJC_UNCOMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp: VJC_UNCOMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: net_dev-&gt;local-&gt;ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slhc_remember</span><span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_ppp: received illegal VJC_UNCOMP frame!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PPP_VJC_COMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp: VJC_COMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_old</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">skb_old</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_old</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_old</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">128</span><span class="p">);</span>
			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb_old</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						  <span class="n">skb_old</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: net_dev-&gt;local-&gt;ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">slhc_uncompress</span><span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">,</span>
						  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb_old</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb_old</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>

			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">PPP_CCP</span>:
	<span class="k">case</span> <span class="n">PPP_CCPFRAG</span>:
		<span class="n">isdn_ppp_receive_ccp</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>
		<span class="cm">/* Dont pop up ResetReq/Ack stuff to the daemon any</span>
<span class="cm">		   longer - the job is done already */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CCP_RESETREQ</span> <span class="o">||</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CCP_RESETACK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">isdn_ppp_fill_rq</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>	<span class="cm">/* push data to pppd device */</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
	<span class="cm">/* check if the packet passes the pass and active filters</span>
<span class="cm">	 * the filter instructions are constructed assuming</span>
<span class="cm">	 * a four-byte PPP header on each packet (which is still present) */</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="n">u_int16_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_int16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* indicate inbound */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span>
	    <span class="o">&amp;&amp;</span> <span class="n">sk_run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IPPP: inbound frame filtered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span>
	      <span class="o">&amp;&amp;</span> <span class="n">sk_run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IPPP: link-active filter: resetting huptimer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlp</span><span class="p">)</span>
			<span class="n">mlp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_IPPP_FILTER */</span><span class="cp"></span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlp</span><span class="p">)</span>
		<span class="n">mlp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IPPP_FILTER */</span><span class="cp"></span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="cm">/* net_dev-&gt;local-&gt;stats.rx_packets++; done in isdn_net.c */</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">drop_packet:</span>
	<span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isdn_ppp_skb_push ..</span>
<span class="cm"> * checks whether we have enough space at the beginning of the skb</span>
<span class="cm"> * and allocs a new SKB if necessary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">isdn_ppp_skb_push</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb_p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="o">*</span><span class="n">skb_p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_realloc_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_skb_push: can&#39;t realloc headroom!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp_skb_push:under %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="o">*</span><span class="n">skb_p</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send ppp frame .. we expect a PIDCOMPressable proto --</span>
<span class="cm"> *  (here: currently always PPP_IP,PPP_VJC_COMP,PPP_VJC_UNCOMP)</span>
<span class="cm"> *</span>
<span class="cm"> * VJ compression may change skb pointer!!! .. requeue with old</span>
<span class="cm"> * skb isn&#39;t allowed!!</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">isdn_ppp_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="o">*</span><span class="n">mlp</span><span class="p">;</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_IP</span><span class="p">;</span>     <span class="cm">/* 0x21 */</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">ipt</span><span class="p">,</span> <span class="o">*</span><span class="n">ipts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="n">mlp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">nd</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>       <span class="cm">/* get master lp */</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_xmit: lp-&gt;ppp_slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipts</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_ENABLE_IP</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* PPP connected ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: IP frame delayed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_P_IP</span>:
		<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_IP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_IPX</span>:
		<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_IPX</span><span class="p">;</span>	<span class="cm">/* untested */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp: skipped unsupported protocol: %#x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">isdn_net_get_locked_lp</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: all channels busy - requeuing!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we have our lp locked from now on */</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_xmit: lp-&gt;ppp_slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipt</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * after this line .. requeueing in the device queue is no longer allowed!!!</span>
<span class="cm">	 */</span>

	<span class="cm">/* Pull off the fake header we stuck on earlier to keep</span>
<span class="cm">	 * the fragmentation code happy.</span>
<span class="cm">	 */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IPPP_MAX_HEADER</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
	<span class="cm">/* check if we should pass this packet</span>
<span class="cm">	 * the filter instructions are constructed assuming</span>
<span class="cm">	 * a four-byte PPP header on each packet */</span>
	<span class="o">*</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* indicate outbound */</span>

	<span class="p">{</span>
		<span class="n">__be16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">pass_filter</span>
	    <span class="o">&amp;&amp;</span> <span class="n">sk_run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ipt</span><span class="o">-&gt;</span><span class="n">pass_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IPPP: outbound frame filtered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">active_filter</span>
	      <span class="o">&amp;&amp;</span> <span class="n">sk_run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ipt</span><span class="o">-&gt;</span><span class="n">active_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;IPPP: link-active filter: resetting huptimer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_IPPP_FILTER */</span><span class="cp"></span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IPPP_FILTER */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;xmit skb, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;xmit0&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">ipts</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ISDN_PPP_VJ</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_IP</span> <span class="o">&amp;&amp;</span> <span class="n">ipts</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_COMP_TCP</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* ipts here? probably yes, but check this again */</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hl</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * we need to reserve enough space in front of</span>
<span class="cm">		 * sk_buff. old call to dev_alloc_skb only reserved</span>
<span class="cm">		 * 16 bytes, now we are looking what the driver want.</span>
<span class="cm">		 */</span>
		<span class="n">hl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span> <span class="o">+</span> <span class="n">IPPP_MAX_HEADER</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Note: hl might still be insufficient because the method</span>
<span class="cm">		 * above does not account for a possibible MPPP slave channel</span>
<span class="cm">		 * which had larger HL header space requirements than the</span>
<span class="cm">		 * master.</span>
<span class="cm">		 */</span>
		<span class="n">new_skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">hl</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">pktlen</span><span class="p">;</span>

			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">hl</span><span class="p">);</span>
			<span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="n">pktlen</span> <span class="o">=</span> <span class="n">slhc_compress</span><span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_NO_TCP_CCID</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp: FATAL error after slhc_compress!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">new_skb</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SL_TYPE_COMPRESSED_TCP</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* cslip? style -&gt; PPP */</span>
				<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_VJC_COMP</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^=</span> <span class="n">SL_TYPE_COMPRESSED_TCP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">SL_TYPE_UNCOMPRESSED_TCP</span><span class="p">)</span>
					<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_VJC_UNCOMP</span><span class="p">;</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * normal (single link) or bundle compression</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;</span> <span class="n">SC_COMP_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We send compressed only if both down- und upstream</span>
<span class="cm">		   compression is negotiated, that means, CCP is up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;</span> <span class="n">SC_DECOMP_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_ppp_compress</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proto</span><span class="p">,</span> <span class="n">ipt</span><span class="p">,</span> <span class="n">ipts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp: CCP not yet up - sending as-is</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x24</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;xmit2 skb, len %d, proto %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">&amp;</span> <span class="n">SC_MP_PROT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we get mp_seqno from static isdn_net_local */</span>
		<span class="kt">long</span> <span class="n">mp_seqno</span> <span class="o">=</span> <span class="n">ipts</span><span class="o">-&gt;</span><span class="n">mp_seqno</span><span class="p">;</span>
		<span class="n">ipts</span><span class="o">-&gt;</span><span class="n">mp_seqno</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">&amp;</span> <span class="n">SC_OUT_SHORT_SEQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">isdn_ppp_skb_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="n">mp_seqno</span> <span class="o">&amp;=</span> <span class="mh">0xfff</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MP_BEGIN_FRAG</span> <span class="o">|</span> <span class="n">MP_END_FRAG</span> <span class="o">|</span> <span class="p">((</span><span class="n">mp_seqno</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>	<span class="cm">/* (B)egin &amp; (E)ndbit .. */</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp_seqno</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>	<span class="cm">/* PID compression */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">isdn_ppp_skb_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">MP_BEGIN_FRAG</span> <span class="o">|</span> <span class="n">MP_END_FRAG</span><span class="p">;</span>	<span class="cm">/* (B)egin &amp; (E)ndbit .. */</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mp_seqno</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>	<span class="cm">/* sequence number: 24bit */</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mp_seqno</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mp_seqno</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>	<span class="cm">/* PID compression */</span>
		<span class="p">}</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_MP</span><span class="p">;</span> <span class="cm">/* MP Protocol, 0x003d */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * &#39;link in bundle&#39; compression  ...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;</span> <span class="n">SC_LINK_COMP_ON</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_ppp_compress</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proto</span><span class="p">,</span> <span class="n">ipt</span><span class="p">,</span> <span class="n">ipts</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_COMP_PROT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">proto</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">isdn_ppp_skb_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">proto</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">isdn_ppp_skb_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">proto</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">proto</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ipt</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_COMP_AC</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">isdn_ppp_skb_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>    <span class="cm">/* All Stations */</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>    <span class="cm">/* Unnumbered information */</span>
	<span class="p">}</span>

	<span class="cm">/* tx-stats are now updated via BSENT-callback */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipts</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;skb xmit: len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;xmit&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">ipt</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">isdn_net_writebuf_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
<span class="cm">/*</span>
<span class="cm"> * check if this packet may trigger auto-dial.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">isdn_ppp_autodial_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">];</span>
	<span class="n">u_int16_t</span> <span class="n">proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_P_IP</span>:
		<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_IP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_IPX</span>:
		<span class="n">proto</span> <span class="o">=</span> <span class="n">PPP_IPX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp_autodial_filter: unsupported protocol 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the filter instructions are constructed assuming</span>
<span class="cm">	 * a four-byte PPP header on each packet. we have to</span>
<span class="cm">	 * temporarily remove part of the fake header stuck on</span>
<span class="cm">	 * earlier.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IPPP_MAX_HEADER</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* indicate outbound */</span>

	<span class="p">{</span>
		<span class="n">__be16</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">drop</span> <span class="o">|=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span>
		<span class="o">&amp;&amp;</span> <span class="n">sk_run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">pass_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">drop</span> <span class="o">|=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span>
		<span class="o">&amp;&amp;</span> <span class="n">sk_run_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">active_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">IPPP_MAX_HEADER</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">drop</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ISDN_MPP</span>

<span class="cm">/* this is _not_ rfc1990 header, but something we convert both short and long</span>
<span class="cm"> * headers to for convinience&#39;s sake:</span>
<span class="cm"> *	byte 0 is flags as in rfc1990</span>
<span class="cm"> *	bytes 1...4 is 24-bit seqence number converted to host byte order</span>
<span class="cm"> */</span>
<span class="cp">#define MP_HEADER_LEN	5</span>

<span class="cp">#define MP_LONGSEQ_MASK		0x00ffffff</span>
<span class="cp">#define MP_SHORTSEQ_MASK	0x00000fff</span>
<span class="cp">#define MP_LONGSEQ_MAX		MP_LONGSEQ_MASK</span>
<span class="cp">#define MP_SHORTSEQ_MAX		MP_SHORTSEQ_MASK</span>
<span class="cp">#define MP_LONGSEQ_MAXBIT	((MP_LONGSEQ_MASK + 1) &gt;&gt; 1)</span>
<span class="cp">#define MP_SHORTSEQ_MAXBIT	((MP_SHORTSEQ_MASK + 1) &gt;&gt; 1)</span>

<span class="cm">/* sequence-wrap safe comparisons (for long sequence)*/</span>
<span class="cp">#define MP_LT(a, b)	((a - b) &amp; MP_LONGSEQ_MAXBIT)</span>
<span class="cp">#define MP_LE(a, b)	!((b - a) &amp; MP_LONGSEQ_MAXBIT)</span>
<span class="cp">#define MP_GT(a, b)	((b - a) &amp; MP_LONGSEQ_MAXBIT)</span>
<span class="cp">#define MP_GE(a, b)	!((a - b) &amp; MP_LONGSEQ_MAXBIT)</span>

<span class="cp">#define MP_SEQ(f)	((*(u32 *)(f-&gt;data + 1)))</span>
<span class="cp">#define MP_FLAGS(f)	(f-&gt;data[0])</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_ppp_mp_bundle_array_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">ISDN_MAX_CHANNELS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ippp_bundle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isdn_ppp_bundle_arr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isdn_ppp_bundle_arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">ippp_bundle</span> <span class="o">*</span><span class="nf">isdn_ppp_mp_bundle_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_bundle_arr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ref_ct</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">isdn_ppp_bundle_arr</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_ppp_mp_init</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">add_to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: lp-&gt;ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add_to</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">ref_ct</span><span class="o">--</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span> <span class="o">=</span> <span class="n">add_to</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* first link in a bundle */</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">mp_seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span> <span class="o">=</span> <span class="n">isdn_ppp_mp_bundle_alloc</span><span class="p">())</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>	<span class="cm">/* nobody else in a queue */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">ref_ct</span><span class="o">++</span><span class="p">;</span>

	<span class="n">is</span><span class="o">-&gt;</span><span class="n">last_link_seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">isdn_ppp_mp_get_seq</span><span class="p">(</span><span class="kt">int</span> <span class="n">short_seq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">last_seq</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">isdn_ppp_mp_discard</span><span class="p">(</span><span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">to</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_mp_reassembly</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">to</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_ppp_mp_print_recv_pkt</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_mp_receive</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lpq</span><span class="p">;</span>
	<span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">mp</span><span class="p">;</span>
	<span class="n">isdn_mppp_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">newfrag</span><span class="p">,</span> <span class="o">*</span><span class="n">frag</span><span class="p">,</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">nextf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">newseq</span><span class="p">,</span> <span class="n">minseq</span><span class="p">,</span> <span class="n">thisseq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mp</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">;</span>
	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: lp-&gt;ppp_slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">frame_drops</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">max_queue_len</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">max_queue_len</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">frames</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span>
		<span class="n">isdn_ppp_mp_print_recv_pkt</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">newseq</span> <span class="o">=</span> <span class="n">isdn_ppp_mp_get_seq</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">&amp;</span> <span class="n">SC_IN_SHORT_SEQ</span><span class="p">,</span>
				     <span class="n">skb</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">last_link_seqno</span><span class="p">);</span>


	<span class="cm">/* if this packet seq # is less than last already processed one,</span>
<span class="cm">	 * toss it right away, but check for sequence start case first</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&gt;</span> <span class="n">MP_LONGSEQ_MAX</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">newseq</span> <span class="o">&amp;</span> <span class="n">MP_LONGSEQ_MAXBIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">newseq</span><span class="p">;</span>	<span class="cm">/* the first packet: required for</span>
<span class="cm">					 * rfc1990 non-compliant clients --</span>
<span class="cm">					 * prevents constant packet toss */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MP_LT</span><span class="p">(</span><span class="n">newseq</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">frame_drops</span><span class="o">++</span><span class="p">;</span>
		<span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find the minimum received sequence number over all links */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">last_link_seqno</span> <span class="o">=</span> <span class="n">minseq</span> <span class="o">=</span> <span class="n">newseq</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">lpq</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;;)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">lpq</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: lpq-&gt;ppp_slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">lpq</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">lls</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">last_link_seqno</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MP_LT</span><span class="p">(</span><span class="n">lls</span><span class="p">,</span> <span class="n">minseq</span><span class="p">))</span>
				<span class="n">minseq</span> <span class="o">=</span> <span class="n">lls</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lpq</span> <span class="o">=</span> <span class="n">lpq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="o">==</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MP_LT</span><span class="p">(</span><span class="n">minseq</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">))</span>
		<span class="n">minseq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">;</span>	<span class="cm">/* can&#39;t go beyond already processed</span>
<span class="cm">					 * packets */</span>
	<span class="n">newfrag</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* if this new fragment is before the first one, then enqueue it now. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">frag</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">MP_LT</span><span class="p">(</span><span class="n">newseq</span><span class="p">,</span> <span class="n">MP_SEQ</span><span class="p">(</span><span class="n">frag</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">newfrag</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">newfrag</span><span class="p">;</span>
		<span class="n">newfrag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">MP_FLAGS</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_BEGIN_FRAG</span> <span class="o">&amp;&amp;</span>
		<span class="n">MP_SEQ</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">==</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">?</span> <span class="n">frag</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * main fragment traversing loop</span>
<span class="cm">	 *</span>
<span class="cm">	 * try to accomplish several tasks:</span>
<span class="cm">	 * - insert new fragment into the proper sequence slot (once that&#39;s done</span>
<span class="cm">	 *   newfrag will be set to NULL)</span>
<span class="cm">	 * - reassemble any complete fragment sequence (non-null &#39;start&#39;</span>
<span class="cm">	 *   indicates there is a contiguous sequence present)</span>
<span class="cm">	 * - discard any incomplete sequences that are below minseq -- due</span>
<span class="cm">	 *   to the fact that sender always increment sequence number, if there</span>
<span class="cm">	 *   is an incomplete sequence below minseq, no new fragments would</span>
<span class="cm">	 *   come to complete such sequence and it should be discarded</span>
<span class="cm">	 *</span>
<span class="cm">	 * loop completes when we accomplished the following tasks:</span>
<span class="cm">	 * - new fragment is inserted in the proper sequence (&#39;newfrag&#39; is</span>
<span class="cm">	 *   set to NULL)</span>
<span class="cm">	 * - we hit a gap in the sequence, so no reassembly/processing is</span>
<span class="cm">	 *   possible (&#39;start&#39; would be set to NULL)</span>
<span class="cm">	 *</span>
<span class="cm">	 * algorithm for this code is derived from code in the book</span>
<span class="cm">	 * &#39;PPP Design And Debugging&#39; by James Carlson (Addison-Wesley)</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">newfrag</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">thisseq</span> <span class="o">=</span> <span class="n">MP_SEQ</span><span class="p">(</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">nextf</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="cm">/* drop any duplicate fragments */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newfrag</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">thisseq</span> <span class="o">==</span> <span class="n">newseq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">newfrag</span><span class="p">);</span>
			<span class="n">newfrag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* insert new fragment before next element if possible. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newfrag</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nextf</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
					<span class="n">MP_LT</span><span class="p">(</span><span class="n">newseq</span><span class="p">,</span> <span class="n">MP_SEQ</span><span class="p">(</span><span class="n">nextf</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">newfrag</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">nextf</span><span class="p">;</span>
			<span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">nextf</span> <span class="o">=</span> <span class="n">newfrag</span><span class="p">;</span>
			<span class="n">newfrag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* check for misplaced start */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="n">frag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MP_FLAGS</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_BEGIN_FRAG</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;isdn_mppp(seq %d): new &quot;</span>
				       <span class="s">&quot;BEGIN flag with no prior END&quot;</span><span class="p">,</span> <span class="n">thisseq</span><span class="p">);</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">seqerrs</span><span class="o">++</span><span class="p">;</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">frame_drops</span><span class="o">++</span><span class="p">;</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">isdn_ppp_mp_discard</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>
				<span class="n">nextf</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MP_LE</span><span class="p">(</span><span class="n">thisseq</span><span class="p">,</span> <span class="n">minseq</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">MP_FLAGS</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_BEGIN_FRAG</span><span class="p">)</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">MP_FLAGS</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_END_FRAG</span><span class="p">)</span>
					<span class="n">stats</span><span class="o">-&gt;</span><span class="n">frame_drops</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">==</span> <span class="n">frag</span><span class="p">)</span>
					<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">nextf</span><span class="p">;</span>
				<span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>
				<span class="n">frag</span> <span class="o">=</span> <span class="n">nextf</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* if start is non-null and we have end fragment, then</span>
<span class="cm">		 * we have full reassembly sequence -- reassemble</span>
<span class="cm">		 * and process packet now</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MP_FLAGS</span><span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_END_FRAG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">minseq</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">thisseq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_LONGSEQ_MASK</span><span class="p">;</span>
			<span class="cm">/* Reassemble the packet then dispatch it */</span>
			<span class="n">isdn_ppp_mp_reassembly</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">nextf</span><span class="p">);</span>

			<span class="n">start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">nextf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check if need to update start pointer: if we just</span>
<span class="cm">		 * reassembled the packet and sequence is contiguous</span>
<span class="cm">		 * then next fragment should be the start of new reassembly</span>
<span class="cm">		 * if sequence is contiguous, but we haven&#39;t reassembled yet,</span>
<span class="cm">		 * keep going.</span>
<span class="cm">		 * if sequence is not contiguous, either clear everything</span>
<span class="cm">		 * below low watermark and set start to the next frag or</span>
<span class="cm">		 * clear start ptr.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nextf</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">thisseq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_LONGSEQ_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MP_SEQ</span><span class="p">(</span><span class="n">nextf</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* if we just reassembled and the next one is here,</span>
<span class="cm">			 * then start another reassembly. */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">MP_FLAGS</span><span class="p">(</span><span class="n">nextf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_BEGIN_FRAG</span><span class="p">)</span>
					<span class="n">start</span> <span class="o">=</span> <span class="n">nextf</span><span class="p">;</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span><span class="s">&quot;isdn_mppp(seq %d):&quot;</span>
					       <span class="s">&quot; END flag with no following &quot;</span>
					       <span class="s">&quot;BEGIN&quot;</span><span class="p">,</span> <span class="n">thisseq</span><span class="p">);</span>
					<span class="n">stats</span><span class="o">-&gt;</span><span class="n">seqerrs</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nextf</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">frag</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">MP_LT</span><span class="p">(</span><span class="n">thisseq</span><span class="p">,</span> <span class="n">minseq</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* we&#39;ve got a break in the sequence</span>
<span class="cm">				 * and we not at the end yet</span>
<span class="cm">				 * and we did not just reassembled</span>
<span class="cm">				 *(if we did, there wouldn&#39;t be anything before)</span>
<span class="cm">				 * and we below the low watermark</span>
<span class="cm">				 * discard all the frames below low watermark</span>
<span class="cm">				 * and start over */</span>
				<span class="n">stats</span><span class="o">-&gt;</span><span class="n">frame_drops</span><span class="o">++</span><span class="p">;</span>
				<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">isdn_ppp_mp_discard</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">nextf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* break in the sequence, no reassembly */</span>
			<span class="n">start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">frag</span> <span class="o">=</span> <span class="n">nextf</span><span class="p">;</span>
	<span class="p">}</span>	<span class="cm">/* while -- main loop */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>

	<span class="cm">/* rather straighforward way to deal with (not very) possible</span>
<span class="cm">	 * queue overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">&gt;</span> <span class="n">MP_MAX_QUEUE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">overflows</span><span class="o">++</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">frames</span> <span class="o">&gt;</span> <span class="n">MP_MAX_QUEUE_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frag</span> <span class="o">=</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">);</span>
			<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_mp_cleanup</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nextfrag</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">frag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextfrag</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>
		<span class="n">frag</span> <span class="o">=</span> <span class="n">nextfrag</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">isdn_ppp_mp_get_seq</span><span class="p">(</span><span class="kt">int</span> <span class="n">short_seq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">last_seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MP_BEGIN_FRAG</span> <span class="o">|</span> <span class="n">MP_END_FRAG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">short_seq</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_LONGSEQ_MASK</span><span class="p">;</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="cm">/* convert 12-bit short seq number to 24-bit long one</span>
<span class="cm">		 */</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_SHORTSEQ_MASK</span><span class="p">;</span>

		<span class="cm">/* check for seqence wrap */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">seq</span> <span class="o">&amp;</span>  <span class="n">MP_SHORTSEQ_MAXBIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">last_seq</span> <span class="o">&amp;</span>  <span class="n">MP_SHORTSEQ_MAXBIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">last_seq</span> <span class="o">&lt;=</span> <span class="n">MP_LONGSEQ_MAX</span><span class="p">)</span>
			<span class="n">seq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">last_seq</span> <span class="o">+</span> <span class="n">MP_SHORTSEQ_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="o">~</span><span class="n">MP_SHORTSEQ_MASK</span> <span class="o">&amp;</span> <span class="n">MP_LONGSEQ_MASK</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq</span> <span class="o">|=</span> <span class="n">last_seq</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">MP_SHORTSEQ_MASK</span> <span class="o">&amp;</span> <span class="n">MP_LONGSEQ_MASK</span><span class="p">);</span>

		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>	<span class="cm">/* put converted seqence back in skb */</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>	<span class="cm">/* put seqence back in _host_ byte</span>
<span class="cm">					 * order */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>	        <span class="cm">/* restore flags */</span>
	<span class="k">return</span> <span class="n">seq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">isdn_ppp_mp_discard</span><span class="p">(</span><span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">)</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">from</span> <span class="o">!=</span> <span class="n">to</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
			<span class="n">from</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">from</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">isdn_ppp_mp_reassembly</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">mp</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tot_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: lp-&gt;ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MP_FLAGS</span><span class="p">(</span><span class="n">from</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">MP_BEGIN_FRAG</span> <span class="o">|</span> <span class="n">MP_END_FRAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_mppp: reassembly: frame %d, &quot;</span>
			       <span class="s">&quot;len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MP_SEQ</span><span class="p">(</span><span class="n">from</span><span class="p">),</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">MP_HEADER_LEN</span><span class="p">);</span>
		<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frames</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">tot_len</span> <span class="o">=</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">from</span><span class="p">;</span> <span class="n">frag</span> <span class="o">!=</span> <span class="n">to</span><span class="p">;</span> <span class="n">frag</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tot_len</span> <span class="o">+=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">MP_HEADER_LEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="s">&quot;isdn_mppp: reassembling frames %d &quot;</span>
			       <span class="s">&quot;to %d, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MP_SEQ</span><span class="p">(</span><span class="n">from</span><span class="p">),</span>
			       <span class="p">(</span><span class="n">MP_SEQ</span><span class="p">(</span><span class="n">from</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MP_LONGSEQ_MASK</span><span class="p">,</span> <span class="n">tot_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">tot_len</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_mppp: cannot allocate sk buff &quot;</span>
			       <span class="s">&quot;of size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tot_len</span><span class="p">);</span>
			<span class="n">isdn_ppp_mp_discard</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">from</span> <span class="o">!=</span> <span class="n">to</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">MP_HEADER_LEN</span><span class="p">;</span>

			<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">MP_HEADER_LEN</span><span class="p">,</span>
							 <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
							 <span class="n">len</span><span class="p">);</span>
			<span class="n">frag</span> <span class="o">=</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">mp</span><span class="p">,</span> <span class="n">from</span><span class="p">);</span>
			<span class="n">from</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">proto</span> <span class="o">=</span> <span class="n">isdn_ppp_strip_proto</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">isdn_ppp_push_higher</span><span class="p">(</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_mp_free_skb</span><span class="p">(</span><span class="n">ippp_bundle</span> <span class="o">*</span><span class="n">mp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">mp</span><span class="o">-&gt;</span><span class="n">frames</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_mp_print_recv_pkt</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;mp_recv: %d/%d -&gt; %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">slot</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_ppp_bundle</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ifn</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="o">*</span><span class="n">nlp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">ifn</span><span class="p">,</span> <span class="s">&quot;ippp%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">ifn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_bundle: cannot find %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifn</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">nlp</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span> <span class="o">||</span>
	    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_bundle: binding to invalid slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span> <span class="o">?</span>
		       <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">:</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isdn_net_add_to_bundle</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">nlp</span><span class="p">);</span>

	<span class="n">ippp_table</span><span class="p">[</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">unit</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">;</span>

	<span class="cm">/* maybe also SC_CCP stuff */</span>
	<span class="n">ippp_table</span><span class="p">[</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">|=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SC_ENABLE_IP</span> <span class="o">|</span> <span class="n">SC_NO_TCP_CCID</span> <span class="o">|</span> <span class="n">SC_REJ_COMP_TCP</span><span class="p">);</span>
	<span class="n">ippp_table</span><span class="p">[</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">|=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mpppcfg</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">SC_MP_PROT</span> <span class="o">|</span> <span class="n">SC_REJ_MP_PROT</span> <span class="o">|</span> <span class="n">SC_OUT_SHORT_SEQ</span> <span class="o">|</span> <span class="n">SC_IN_SHORT_SEQ</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">isdn_ppp_mp_init</span><span class="p">(</span><span class="n">nlp</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pb</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pb</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_MPP */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * network device ioctl handlers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_ppp_dev_ioctl_stats</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ppp_stats</span> <span class="n">__user</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ppp_stats</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_stats</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* build a temporary stat struct and copy it to user space */</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_stats</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">ppp_ipackets</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
		<span class="n">t</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">ppp_ibytes</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">;</span>
		<span class="n">t</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">ppp_ierrors</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
		<span class="n">t</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">ppp_opackets</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
		<span class="n">t</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">ppp_obytes</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">;</span>
		<span class="n">t</span><span class="p">.</span><span class="n">p</span><span class="p">.</span><span class="n">ppp_oerrors</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP_VJ</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">slcompress</span> <span class="o">*</span><span class="n">slcomp</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">slcomp</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_packets</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_o_compressed</span> <span class="o">+</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_o_uncompressed</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_compressed</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_o_compressed</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_searches</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_o_searches</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_misses</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_o_misses</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_errorin</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_i_error</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_tossed</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_i_tossed</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_uncompressedin</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_i_uncompressed</span><span class="p">;</span>
			<span class="n">t</span><span class="p">.</span><span class="n">vj</span><span class="p">.</span><span class="n">vjs_compressedin</span> <span class="o">=</span> <span class="n">slcomp</span><span class="o">-&gt;</span><span class="n">sls_i_compressed</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ppp_stats</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">isdn_ppp_dev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">!=</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define PPP_VERSION &quot;2.3.7&quot;</span>
	<span class="k">case</span> <span class="n">SIOCGPPPVER</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">PPP_VERSION</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">PPP_VERSION</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGPPPSTATS</span>:
		<span class="n">error</span> <span class="o">=</span> <span class="n">isdn_ppp_dev_ioctl_stats</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_ppp_if_get_unit</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">i</span><span class="p">,</span>
		<span class="n">unit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">deci</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;ippp&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deci</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">deci</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">a</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
			<span class="n">unit</span> <span class="o">+=</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">deci</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span> <span class="o">||</span> <span class="n">len</span> <span class="o">-</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">unit</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span>
<span class="nf">isdn_ppp_dial_slave</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sdev</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">isdn_net_dial_req</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">sdev</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">isdn_ppp_hangup_slave</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_MPP</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">sdev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mlp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* find last connected link in chain */</span>
			<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">nlp</span> <span class="o">=</span> <span class="n">ISDN_SLAVE_PRIV</span><span class="p">(</span><span class="n">mlp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">nlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">sdev</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PPP compression stuff</span>
<span class="cm"> */</span>


<span class="cm">/* Push an empty CCP Data Frame up to the daemon to wake it up and let it</span>
<span class="cm">   generate a CCP Reset-Request or tear down CCP altogether */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_ccp_kickup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_ppp_fill_rq</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PPP_COMP</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* In-kernel handling of CCP Reset-Request and Reset-Ack is necessary,</span>
<span class="cm">   but absolutely nontrivial. The most abstruse problem we are facing is</span>
<span class="cm">   that the generation, reception and all the handling of timeouts and</span>
<span class="cm">   resends including proper request id management should be entirely left</span>
<span class="cm">   to the (de)compressor, but indeed is not covered by the current API to</span>
<span class="cm">   the (de)compressor. The API is a prototype version from PPP where only</span>
<span class="cm">   some (de)compressors have yet been implemented and all of them are</span>
<span class="cm">   rather simple in their reset handling. Especially, their is only one</span>
<span class="cm">   outstanding ResetAck at a time with all of them and ResetReq/-Acks do</span>
<span class="cm">   not have parameters. For this very special case it was sufficient to</span>
<span class="cm">   just return an error code from the decompressor and have a single</span>
<span class="cm">   reset() entry to communicate all the necessary information between</span>
<span class="cm">   the framework and the (de)compressor. Bad enough, LZS is different</span>
<span class="cm">   (and any other compressor may be different, too). It has multiple</span>
<span class="cm">   histories (eventually) and needs to Reset each of them independently</span>
<span class="cm">   and thus uses multiple outstanding Acks and history numbers as an</span>
<span class="cm">   additional parameter to Reqs/Acks.</span>
<span class="cm">   All that makes it harder to port the reset state engine into the</span>
<span class="cm">   kernel because it is not just the same simple one as in (i)pppd but</span>
<span class="cm">   it must be able to pass additional parameters and have multiple out-</span>
<span class="cm">   standing Acks. We are trying to achieve the impossible by handling</span>
<span class="cm">   reset transactions independent by their id. The id MUST change when</span>
<span class="cm">   the data portion changes, thus any (de)compressor who uses more than</span>
<span class="cm">   one resettable state must provide and recognize individual ids for</span>
<span class="cm">   each individual reset transaction. The framework itself does _only_</span>
<span class="cm">   differentiate them by id, because it has no other semantics like the</span>
<span class="cm">   (de)compressor might.</span>
<span class="cm">   This looks like a major redesign of the interface would be nice,</span>
<span class="cm">   but I don&#39;t have an idea how to do it better. */</span>

<span class="cm">/* Send a CCP Reset-Request or Reset-Ack directly from the kernel. This is</span>
<span class="cm">   getting that lengthy because there is no simple &quot;send-this-frame-out&quot;</span>
<span class="cm">   function above but every wrapper does a bit different. Hope I guess</span>
<span class="cm">   correct in this hack... */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_ccp_xmit_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">lp</span><span class="p">;</span>

	<span class="cm">/* Alloc large enough skb */</span>
	<span class="n">hl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">hl</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;ippp: CCP cannot send reset - out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hl</span><span class="p">);</span>

	<span class="cm">/* We may need to stuff an address and control field first */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_COMP_AC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stuff proto, code, id and length */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">proto</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">proto</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* Now stuff remaining bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* skb is now ready for xmit */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Sending CCP Frame:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;ccp-xmit&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>

	<span class="n">isdn_net_write_super</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Allocate the reset state vector */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ippp_ccp_reset</span> <span class="o">*</span><span class="nf">isdn_ppp_ccp_reset_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_ccp_reset</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_ccp_reset</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_ccp: failed to allocate reset data&quot;</span>
		       <span class="s">&quot; structure - no mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: allocated reset data structure %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Destroy the reset state vector. Kill all pending timers first. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_ccp_reset_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: freeing reset data structure %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">isdn_ppp_ccp_reset_free_state</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">);</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Free a given state and clear everything up for later reallocation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_ccp_reset_free_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: freeing state for id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
		<span class="cm">/* Make sure the kernel will not call back later */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">)</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp_ccp: id %d is not allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The timer callback function which is called when a ResetReq has timed out,</span>
<span class="cm">   aka has never been answered by a ResetAck */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_ccp_timer_callback</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">closure</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="p">)</span><span class="n">closure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_ccp: timer cb with zero closure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCPResetSentReq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are correct here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">expra</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Hmm, there is no Ack really expected. We can clean</span>
<span class="cm">			   up the state now, it will be reallocated if the</span>
<span class="cm">			   decompressor insists on another reset */</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">isdn_ppp_ccp_reset_free_state</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">is</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: CCP Reset timed out for id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rs</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="cm">/* Push it again */</span>
		<span class="n">isdn_ppp_ccp_xmit_reset</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">is</span><span class="p">,</span> <span class="n">PPP_CCP</span><span class="p">,</span> <span class="n">CCP_RESETREQ</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">rs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>
		<span class="cm">/* Restart timer */</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp_ccp: timer cb in wrong state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Allocate a new reset transaction state */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="nf">isdn_ppp_ccp_reset_alloc_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
								   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp_ccp: old state exists for id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CCPResetIdle</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">is</span> <span class="o">=</span> <span class="n">is</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rs</span><span class="p">;</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">isdn_ppp_ccp_timer_callback</span><span class="p">;</span>
		<span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rs</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* A decompressor wants a reset with a set of parameters - do what is</span>
<span class="cm">   necessary to fulfill it */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_ccp_reset_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">isdn_ppp_resetparams</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="n">rs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The decompressor defines parameters by itself */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">rsend</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* And he wants us to send a request */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">idval</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_ccp: decompressor must&quot;</span>
				       <span class="s">&quot; specify reset id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
				<span class="cm">/* There is already a transaction in existence</span>
<span class="cm">				   for this id. May be still waiting for a</span>
<span class="cm">				   Ack or may be wrong. */</span>
				<span class="n">rs</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCPResetSentReq</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: reset&quot;</span>
					       <span class="s">&quot; trans still in progress&quot;</span>
					       <span class="s">&quot; for id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp_ccp: reset&quot;</span>
					       <span class="s">&quot; trans in wrong state %d for&quot;</span>
					       <span class="s">&quot; id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Ok, this is a new transaction */</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: new trans for id&quot;</span>
				       <span class="s">&quot; %d to be started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">rs</span> <span class="o">=</span> <span class="n">isdn_ppp_ccp_reset_alloc_state</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_ccp: out of mem&quot;</span>
					       <span class="s">&quot; allocing ccp trans</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CCPResetSentReq</span><span class="p">;</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">expra</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">expra</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">dtval</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dlen</span> <span class="o">=</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">;</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="cm">/* HACK TODO - add link comp here */</span>
				<span class="n">isdn_ppp_ccp_xmit_reset</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">PPP_CCP</span><span class="p">,</span>
							<span class="n">CCP_RESETREQ</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
							<span class="n">rs</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">dlen</span><span class="p">);</span>
				<span class="cm">/* Start the timer */</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: no reset sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The reset params are invalid. The decompressor does not</span>
<span class="cm">		   care about them, so we just send the minimal requests</span>
<span class="cm">		   and increase ids only when an Ack is received for a</span>
<span class="cm">		   given id */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">lastid</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* There is already a transaction in existence</span>
<span class="cm">			   for this id. May be still waiting for a</span>
<span class="cm">			   Ack or may be wrong. */</span>
			<span class="n">rs</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">lastid</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCPResetSentReq</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: reset&quot;</span>
				       <span class="s">&quot; trans still in progress&quot;</span>
				       <span class="s">&quot; for id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ippp_ccp: reset&quot;</span>
				       <span class="s">&quot; trans in wrong state %d for&quot;</span>
				       <span class="s">&quot; id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: new trans for id&quot;</span>
			       <span class="s">&quot; %d to be started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">lastid</span><span class="p">);</span>
			<span class="n">rs</span> <span class="o">=</span> <span class="n">isdn_ppp_ccp_reset_alloc_state</span><span class="p">(</span><span class="n">is</span><span class="p">,</span>
							    <span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">lastid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_ccp: out of mem&quot;</span>
				       <span class="s">&quot; allocing ccp trans</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CCPResetSentReq</span><span class="p">;</span>
			<span class="cm">/* We always expect an Ack if the decompressor doesn&#39;t</span>
<span class="cm">			   know	better */</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">expra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">dlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* HACK TODO - add link comp here */</span>
			<span class="n">isdn_ppp_ccp_xmit_reset</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">PPP_CCP</span><span class="p">,</span> <span class="n">CCP_RESETREQ</span><span class="p">,</span>
						<span class="n">rs</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* Start the timer */</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* An Ack was received for this id. This means we stop the timer and clean</span>
<span class="cm">   up the state prior to calling the decompressors reset routine. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_ccp_reset_ack_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_ccp_reset_state</span> <span class="o">*</span><span class="n">rs</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">rs</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CCPResetSentReq</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Great, we are correct */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">expra</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp_ccp: ResetAck received&quot;</span>
				       <span class="s">&quot; for id %d but not expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ippp_ccp: ResetAck received out of&quot;</span>
			       <span class="s">&quot;sync for id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">ta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">isdn_ppp_ccp_reset_free_state</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ippp_ccp: ResetAck received for unknown id&quot;</span>
		       <span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Make sure the simple reset stuff uses a new id next time */</span>
	<span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="o">-&gt;</span><span class="n">lastid</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * decompress packet</span>
<span class="cm"> *</span>
<span class="cm"> * if master = 0, we&#39;re trying to uncompress an per-link compressed packet,</span>
<span class="cm"> * as opposed to an compressed reconstructed-from-MPPP packet.</span>
<span class="cm"> * proto is updated to protocol field of uncompressed packet.</span>
<span class="cm"> *</span>
<span class="cm"> * retval: decompressed packet,</span>
<span class="cm"> *         same packet if uncompressed,</span>
<span class="cm"> *	   NULL if decompression error</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">isdn_ppp_decompress</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="o">*</span><span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isdn_ppp_compressor</span> <span class="o">*</span><span class="n">ipc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">ri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isdn_ppp_resetparams</span> <span class="n">rsparm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rsdata</span><span class="p">[</span><span class="n">IPPP_RESET_MAXDATABYTES</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>per-link decompression</p></td><td class="code"><div class="highlight"><pre>		<span class="n">stat</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span><span class="p">;</span>
		<span class="n">ipc</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span><span class="p">;</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="n">is</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">decomp_stat</span><span class="p">;</span>
		<span class="n">ipc</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">decompressor</span><span class="p">;</span>
		<span class="n">ri</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipc</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>no decompressor -> we can't decompress.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ippp: no decompressor defined!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">);</span> <span class="c1">// if we have a compressor, stat has been set as well</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">master</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_COMP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_COMPFRAG</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>compressed packets are compressed by their protocol type</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Set up reset params for the decompressor</p></td><td class="code"><div class="highlight"><pre>		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsparm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsparm</span><span class="p">));</span>
		<span class="n">rsparm</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">rsdata</span><span class="p">;</span>
		<span class="n">rsparm</span><span class="p">.</span><span class="n">maxdlen</span> <span class="o">=</span> <span class="n">IPPP_RESET_MAXDATABYTES</span><span class="p">;</span>

		<span class="n">skb_out</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">mru</span> <span class="o">+</span> <span class="n">PPP_HDRLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp: decomp memory allocation failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">decompress</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsparm</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DECOMP_ERROR</span>:
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ippp: decomp wants reset %s params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">rsparm</span><span class="p">.</span><span class="n">valid</span> <span class="o">?</span> <span class="s">&quot;with&quot;</span> <span class="o">:</span> <span class="s">&quot;without&quot;</span><span class="p">);</span>

				<span class="n">isdn_ppp_ccp_reset_trans</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsparm</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DECOMP_FATALERROR</span>:
				<span class="n">ri</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">|=</span> <span class="n">SC_DC_FERROR</span><span class="p">;</span>
				<span class="cm">/* Kick ipppd to recognize the error */</span>
				<span class="n">isdn_ppp_ccp_kickup</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb_out</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">proto</span> <span class="o">=</span> <span class="n">isdn_ppp_strip_proto</span><span class="p">(</span><span class="n">skb_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">proto</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb_out</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">skb_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>uncompressed packets are fed through the decompressor to
update the decompressor state</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ipc</span><span class="o">-&gt;</span><span class="n">incomp</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">proto</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * compress a frame</span>
<span class="cm"> *   type=0: normal/bundle compression</span>
<span class="cm"> *       =1: link compression</span>
<span class="cm"> * returns original skb if we haven&#39;t compressed the frame</span>
<span class="cm"> * and a new skb pointer if we&#39;ve done it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">isdn_ppp_compress</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_in</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">proto</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_proto</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isdn_ppp_compressor</span> <span class="o">*</span><span class="n">compressor</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">stat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_out</span><span class="p">;</span>

	<span class="cm">/* we do not compress control protocols */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">proto</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">proto</span> <span class="o">&gt;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">skb_in</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* type=1 =&gt; Link compression */</span>
		<span class="k">return</span> <span class="n">skb_in</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">compressor</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="p">;</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">compressor</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="p">;</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">new_proto</span> <span class="o">=</span> <span class="n">PPP_COMP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compressor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp: No compressor set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb_in</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;isdn_ppp: Compressor not initialized?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb_in</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allow for at least 150 % expansion (for now) */</span>
	<span class="n">skb_out</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">+</span>
			    <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb_in</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_out</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">skb_in</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb_out</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb_in</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">compressor</span><span class="o">-&gt;</span><span class="n">compress</span><span class="p">)(</span><span class="n">stat</span><span class="p">,</span> <span class="n">skb_in</span><span class="p">,</span> <span class="n">skb_out</span><span class="p">,</span> <span class="o">*</span><span class="n">proto</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb_out</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb_in</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb_in</span><span class="p">);</span>
	<span class="o">*</span><span class="n">proto</span> <span class="o">=</span> <span class="n">new_proto</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb_out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * we received a CCP frame ..</span>
<span class="cm"> * not a clean solution, but we MUST handle a few cases in the kernel</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_receive_ccp</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">mis</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isdn_ppp_resetparams</span> <span class="n">rsparm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rsdata</span><span class="p">[</span><span class="n">IPPP_RESET_MAXDATABYTES</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Received CCP frame from peer slot(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: lp-&gt;ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">];</span>
	<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;ccp-rcv&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mis</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mis</span> <span class="o">=</span> <span class="n">is</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCP_CONFREQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Disable compression here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span>
			<span class="n">mis</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_COMP_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_LINK_COMP_ON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CCP_TERMREQ</span>:
	<span class="k">case</span> <span class="n">CCP_TERMACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Disable (de)compression here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span>
			<span class="n">mis</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SC_DECOMP_ON</span> <span class="o">|</span> <span class="n">SC_COMP_ON</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SC_LINK_DECOMP_ON</span> <span class="o">|</span> <span class="n">SC_LINK_COMP_ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CCP_CONFACK</span>:
		<span class="cm">/* if we RECEIVE an ackowledge we enable the decompressor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Enable decompression here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mis</span><span class="o">-&gt;</span><span class="n">decompressor</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">mis</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">|=</span> <span class="n">SC_DECOMP_ON</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">decompressor</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">|=</span> <span class="n">SC_LINK_DECOMP_ON</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCP_RESETACK</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Received ResetAck from peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If a reset Ack was outstanding for this id, then</span>
<span class="cm">			   clean up the state engine */</span>
			<span class="n">isdn_ppp_ccp_reset_ack_rcvd</span><span class="p">(</span><span class="n">mis</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mis</span><span class="o">-&gt;</span><span class="n">decompressor</span> <span class="o">&amp;&amp;</span> <span class="n">mis</span><span class="o">-&gt;</span><span class="n">decomp_stat</span><span class="p">)</span>
				<span class="n">mis</span><span class="o">-&gt;</span><span class="n">decompressor</span><span class="o">-&gt;</span>
					<span class="n">reset</span><span class="p">(</span><span class="n">mis</span><span class="o">-&gt;</span><span class="n">decomp_stat</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="n">len</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="cm">/* TODO: This is not easy to decide here */</span>
			<span class="n">mis</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_DECOMP_DISCARD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">isdn_ppp_ccp_reset_ack_rcvd</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span> <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span><span class="p">)</span>
				<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span><span class="o">-&gt;</span>
					<span class="n">reset</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="n">len</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="cm">/* TODO: neither here */</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_LINK_DECOMP_DISCARD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCP_RESETREQ</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Received ResetReq from peer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Receiving a ResetReq means we must reset our compressor */</span>
		<span class="cm">/* Set up reset params for the reset entry */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsparm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsparm</span><span class="p">));</span>
		<span class="n">rsparm</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">rsdata</span><span class="p">;</span>
		<span class="n">rsparm</span><span class="p">.</span><span class="n">maxdlen</span> <span class="o">=</span> <span class="n">IPPP_RESET_MAXDATABYTES</span><span class="p">;</span>
		<span class="cm">/* Isolate data length */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mis</span><span class="o">-&gt;</span><span class="n">compressor</span> <span class="o">&amp;&amp;</span> <span class="n">mis</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">)</span>
				<span class="n">mis</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="o">-&gt;</span>
					<span class="n">reset</span><span class="p">(</span><span class="n">mis</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="n">len</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsparm</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span> <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">)</span>
				<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span><span class="o">-&gt;</span>
					<span class="n">reset</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					      <span class="n">len</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsparm</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Ack the Req as specified by rsparm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsparm</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Compressor reset handler decided how to answer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rsparm</span><span class="p">.</span><span class="n">rsend</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We should send a Frame */</span>
				<span class="n">isdn_ppp_ccp_xmit_reset</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">CCP_RESETACK</span><span class="p">,</span>
							<span class="n">rsparm</span><span class="p">.</span><span class="n">idval</span> <span class="o">?</span> <span class="n">rsparm</span><span class="p">.</span><span class="n">id</span>
							<span class="o">:</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
							<span class="n">rsparm</span><span class="p">.</span><span class="n">dtval</span> <span class="o">?</span>
							<span class="n">rsparm</span><span class="p">.</span><span class="n">data</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
							<span class="n">rsparm</span><span class="p">.</span><span class="n">dtval</span> <span class="o">?</span>
							<span class="n">rsparm</span><span class="p">.</span><span class="n">dlen</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ResetAck suppressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* We answer with a straight reflected Ack */</span>
			<span class="n">isdn_ppp_ccp_xmit_reset</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">CCP_RESETACK</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						<span class="n">len</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
						<span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Daemon sends a CCP frame ...</span>
<span class="cm"> */</span>

<span class="cm">/* TODO: Clean this up with new Reset semantics */</span>

<span class="cm">/* I believe the CCP handling as-is is done wrong. Compressed frames</span>
<span class="cm"> * should only be sent/received after CCP reaches UP state, which means</span>
<span class="cm"> * both sides have sent CONF_ACK. Currently, we handle both directions</span>
<span class="cm"> * independently, which means we may accept compressed frames too early</span>
<span class="cm"> * (supposedly not a problem), but may also mean we send compressed frames</span>
<span class="cm"> * too early, which may turn out to be a problem.</span>
<span class="cm"> * This part of state machine should actually be handled by (i)pppd, but</span>
<span class="cm"> * that&#39;s too big of a change now. --kai</span>
<span class="cm"> */</span>

<span class="cm">/* Actually, we might turn this into an advantage: deal with the RFC in</span>
<span class="cm"> * the old tradition of beeing generous on what we accept, but beeing</span>
<span class="cm"> * strict on what we send. Thus we should just</span>
<span class="cm"> * - accept compressed frames as soon as decompression is negotiated</span>
<span class="cm"> * - send compressed frames only when decomp *and* comp are negotiated</span>
<span class="cm"> * - drop rx compressed frames if we cannot decomp (instead of pushing them</span>
<span class="cm"> *   up to ipppd)</span>
<span class="cm"> * and I tried to modify this file according to that. --abp</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_ppp_send_ccp</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">net_dev</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">mis</span><span class="p">,</span> <span class="o">*</span><span class="n">is</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">proto</span><span class="p">,</span> <span class="n">slot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: lp-&gt;ppp_slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">is</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="cm">/* Daemon may send with or without address and control field comp */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">pppcfg</span> <span class="o">&amp;</span> <span class="n">SC_COMP_AC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">proto</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">PPP_CCP</span> <span class="o">&amp;&amp;</span> <span class="n">proto</span> <span class="o">!=</span> <span class="n">PPP_CCPFRAG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Received CCP frame from daemon:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">isdn_ppp_frame_log</span><span class="p">(</span><span class="s">&quot;ccp-xmit&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ppp_slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">ISDN_MAX_CHANNELS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: slot(%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mis</span> <span class="o">=</span> <span class="n">ippp_table</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mis</span> <span class="o">=</span> <span class="n">is</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mis</span> <span class="o">!=</span> <span class="n">is</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_ppp: Ouch! Master CCP sends on slave slot!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCP_CONFREQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Disable decompression here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_DECOMP_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_LINK_DECOMP_ON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CCP_TERMREQ</span>:
	<span class="k">case</span> <span class="n">CCP_TERMACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Disable (de)compression here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SC_DECOMP_ON</span> <span class="o">|</span> <span class="n">SC_COMP_ON</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SC_LINK_DECOMP_ON</span> <span class="o">|</span> <span class="n">SC_LINK_COMP_ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CCP_CONFACK</span>:
		<span class="cm">/* if we SEND an ackowledge we can/must enable the compressor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Enable compression here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">|=</span> <span class="n">SC_COMP_ON</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">|=</span> <span class="n">SC_LINK_COMP_ON</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CCP_RESETACK</span>:
		<span class="cm">/* If we send a ACK we should reset our compressor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Reset decompression state here!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ResetAck from daemon passed by</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">PPP_CCP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* link to master? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span> <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">)</span>
				<span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_COMP_DISCARD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span> <span class="o">&amp;&amp;</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">)</span>
				<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">,</span>
							   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">is</span><span class="o">-&gt;</span><span class="n">compflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_LINK_COMP_DISCARD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CCP_RESETREQ</span>:
		<span class="cm">/* Just let it pass by */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ResetReq from daemon passed by</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">isdn_ppp_register_compressor</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdn_ppp_compressor</span> <span class="o">*</span><span class="n">ipc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ipc_head</span><span class="p">;</span>
	<span class="n">ipc</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipc_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ipc_head</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ipc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ipc_head</span> <span class="o">=</span> <span class="n">ipc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">isdn_ppp_unregister_compressor</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdn_ppp_compressor</span> <span class="o">*</span><span class="n">ipc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipc</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span>
		<span class="n">ipc</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ipc_head</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
	<span class="n">ipc</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_ppp_set_compressor</span><span class="p">(</span><span class="k">struct</span> <span class="n">ippp_struct</span> <span class="o">*</span><span class="n">is</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isdn_ppp_comp_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isdn_ppp_compressor</span> <span class="o">*</span><span class="n">ipc</span> <span class="o">=</span> <span class="n">ipc_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;[%d] Set %s type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPPP_COMP_FLAG_XMIT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;compressor&quot;</span> <span class="o">:</span> <span class="s">&quot;decompressor&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>

	<span class="cm">/* If is has no valid reset state vector, we cannot allocate a</span>
<span class="cm">	   decompressor. The decompressor would cause reset transactions</span>
<span class="cm">	   sooner or later, and they need that vector. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPPP_COMP_FLAG_XMIT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ippp_ccp: no reset data structure - can&#39;t&quot;</span>
		       <span class="s">&quot; allow decompression.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ipc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ipc</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stat</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">is</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t init (de)compression!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">ipc</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
					<span class="n">stat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t alloc (de)compression!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPPP_COMP_FLAG_XMIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPPP_COMP_FLAG_LINK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">)</span>
						<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span><span class="p">);</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_comp_stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_compressor</span> <span class="o">=</span> <span class="n">ipc</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">)</span>
						<span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span><span class="p">);</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">comp_stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">compressor</span> <span class="o">=</span> <span class="n">ipc</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPPP_COMP_FLAG_LINK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span><span class="p">)</span>
						<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span><span class="p">);</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decomp_stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">link_decompressor</span> <span class="o">=</span> <span class="n">ipc</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">decomp_stat</span><span class="p">)</span>
						<span class="n">is</span><span class="o">-&gt;</span><span class="n">decompressor</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">is</span><span class="o">-&gt;</span><span class="n">decomp_stat</span><span class="p">);</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">decomp_stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
					<span class="n">is</span><span class="o">-&gt;</span><span class="n">decompressor</span> <span class="o">=</span> <span class="n">ipc</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ipc</span> <span class="o">=</span> <span class="n">ipc</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
