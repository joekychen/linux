<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › i4l › isdn_net.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isdn_net.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* $Id: isdn_net.c,v 1.1.2.2 2004/01/12 22:37:19 keil Exp $</span>
<span class="cm"> *</span>
<span class="cm"> * Linux ISDN subsystem, network interfaces and related functions (linklevel).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 1994-1998  by Fritz Elfert (fritz@isdn4linux.de)</span>
<span class="cm"> * Copyright 1995,96    by Thinking Objects Software GmbH Wuerzburg</span>
<span class="cm"> * Copyright 1995,96    by Michael Hipp (Michael.Hipp@student.uni-tuebingen.de)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * Data Over Voice (DOV) support added - Guy Ellis 23-Mar-02</span>
<span class="cm"> *                                       guy@traverse.com.au</span>
<span class="cm"> * Outgoing calls - looks for a &#39;V&#39; in first char of dialed number</span>
<span class="cm"> * Incoming calls - checks first character of eaz as follows:</span>
<span class="cm"> *   Numeric - accept DATA only - original functionality</span>
<span class="cm"> *   &#39;V&#39;     - accept VOICE (DOV) only</span>
<span class="cm"> *   &#39;B&#39;     - accept BOTH DATA and DOV types</span>
<span class="cm"> *</span>
<span class="cm"> * Jan 2001: fix CISCO HDLC      Bjoern A. Zeeb &lt;i4l@zabbadoz.net&gt;</span>
<span class="cm"> *           for info on the protocol, see</span>
<span class="cm"> *           http://i4l.zabbadoz.net/i4l/cisco-hdlc.txt</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/isdn.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;net/pkt_sched.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &quot;isdn_common.h&quot;</span>
<span class="cp">#include &quot;isdn_net.h&quot;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
<span class="cp">#include &quot;isdn_ppp.h&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
<span class="cp">#include &lt;linux/concap.h&gt;</span>
<span class="cp">#include &quot;isdn_concap.h&quot;</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Outline of new tbusy handling:</span>
<span class="cm"> *</span>
<span class="cm"> * Old method, roughly spoken, consisted of setting tbusy when entering</span>
<span class="cm"> * isdn_net_start_xmit() and at several other locations and clearing</span>
<span class="cm"> * it from isdn_net_start_xmit() thread when sending was successful.</span>
<span class="cm"> *</span>
<span class="cm"> * With 2.3.x multithreaded network core, to prevent problems, tbusy should</span>
<span class="cm"> * only be set by the isdn_net_start_xmit() thread and only when a tx-busy</span>
<span class="cm"> * condition is detected. Other threads (in particular isdn_net_stat_callb())</span>
<span class="cm"> * are only allowed to clear tbusy.</span>
<span class="cm"> *</span>
<span class="cm"> * -HE</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * About SOFTNET:</span>
<span class="cm"> * Most of the changes were pretty obvious and basically done by HE already.</span>
<span class="cm"> *</span>
<span class="cm"> * One problem of the isdn net device code is that is uses struct net_device</span>
<span class="cm"> * for masters and slaves. However, only master interface are registered to</span>
<span class="cm"> * the network layer, and therefore, it only makes sense to call netif_*</span>
<span class="cm"> * functions on them.</span>
<span class="cm"> *</span>
<span class="cm"> * --KG</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Find out if the netdevice has been ifup-ed yet.</span>
<span class="cm"> * For slaves, look at the corresponding master.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">isdn_net_device_started</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * wake up the network -&gt; net_device queue.</span>
<span class="cm"> * For slaves, wake the corresponding master interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">isdn_net_device_wake_queue</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * stop the network -&gt; net_device queue.</span>
<span class="cm"> * For slaves, stop the corresponding master interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">isdn_net_device_stop_queue</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * find out if the net_device which this lp belongs to (lp can be</span>
<span class="cm"> * master or slave) is busy. It&#39;s busy iff all (master and slave)</span>
<span class="cm"> * queues are busy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span> <span class="nf">isdn_net_device_busy</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">nlp</span><span class="p">;</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdn_net_lp_busy</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">nd</span> <span class="o">=</span> <span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nd</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nlp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nlp</span> <span class="o">!=</span> <span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdn_net_lp_busy</span><span class="p">(</span><span class="n">nlp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">nlp</span> <span class="o">=</span> <span class="n">nlp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nd</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">isdn_net_inc_frame_cnt</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">frame_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_net_device_busy</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span>
		<span class="n">isdn_net_device_stop_queue</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">isdn_net_dec_frame_cnt</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">frame_cnt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isdn_net_device_busy</span><span class="p">(</span><span class="n">lp</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">super_tx_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">isdn_net_device_wake_queue</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">isdn_net_zero_frame_cnt</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">frame_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* For 2.2.x we leave the transmitter busy timeout at 2 secs, just</span>
<span class="cm"> * to be safe.</span>
<span class="cm"> * For 2.3.x we push it up to 20 secs, because call establishment</span>
<span class="cm"> * (in particular callback) may take such a long time, and we</span>
<span class="cm"> * don&#39;t want confusing messages in the log. However, there is a slight</span>
<span class="cm"> * possibility that this large timeout will break other things like MPPP,</span>
<span class="cm"> * which might rely on the tx timeout. If so, we&#39;ll find out this way...</span>
<span class="cm"> */</span>

<span class="cp">#define ISDN_NET_TX_TIMEOUT (20 * HZ)</span>

<span class="cm">/* Prototypes */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">isdn_net_force_dial_lp</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">isdn_net_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_net_ciscohdlck_connected</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">isdn_net_ciscohdlck_disconnected</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">);</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">isdn_net_revision</span> <span class="o">=</span> <span class="s">&quot;$Revision: 1.1.2.2 $&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Code for raw-networking over ISDN</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_unreachable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">u_short</span> <span class="n">proto</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_net: %s: %s, signalling dst_link_failure %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">reason</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">proto</span> <span class="o">!=</span> <span class="n">ETH_P_IP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Protocol != ETH_P_IP&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="n">dst_link_failure</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>  <span class="cm">/* dial not triggered by rawIP packet */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_net: %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="n">reason</span> <span class="o">:</span> <span class="s">&quot;reason unknown&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">struct</span> <span class="n">concap_device_ops</span> <span class="o">*</span><span class="n">dops</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">dops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">concap_proto</span> <span class="o">*</span><span class="n">cprot</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cprot</span> <span class="o">&amp;&amp;</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span> <span class="o">&amp;&amp;</span> <span class="n">dops</span><span class="p">)</span>
		<span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">(</span><span class="n">cprot</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dops</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Open/initialize the board. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span><span class="p">;</span>

	<span class="cm">/* moved here from isdn_net_reset, because only the master has an</span>
<span class="cm">	   interface associated which is supposed to be started. BTW:</span>
<span class="cm">	   we need to call netif_start_queue, not netif_wake_queue here */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">isdn_net_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Fill in the MAC-level header (not needed, but for compatibility... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xfc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *      Any address will do - we take the first</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If this interface has slaves, start them also */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_net_reset</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">isdn_lock_drivers</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Assign an ISDN-channel to a net-interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_bind_channel</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drvmap</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chanmap</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_netdev</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">st_netdev</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * unbind a net-interface (resets interface after an error)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">super_tx_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* reset only master device */</span>
		<span class="cm">/* Moral equivalent of dev_purge_queues():</span>
<span class="cm">		   BEWARE! This chunk of code cannot be called from hardware</span>
<span class="cm">		   interrupt handler. I hope it is true. --ANK</span>
<span class="cm">		*/</span>
		<span class="n">qdisc_reset_all_tx</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_netdev</span><span class="p">[</span><span class="n">isdn_dc2minor</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">st_netdev</span><span class="p">[</span><span class="n">isdn_dc2minor</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">isdn_free_channel</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span>
				  <span class="n">ISDN_USAGE_NET</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_NET_CONNECTED</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform auto-hangup and cps-calculation for net-interfaces.</span>
<span class="cm"> *</span>
<span class="cm"> * auto-hangup:</span>
<span class="cm"> * Increment idle-counter (this counter is reset on any incoming or</span>
<span class="cm"> * outgoing packet), if counter exceeds configured limit either do a</span>
<span class="cm"> * hangup immediately or - if configured - wait until just before the next</span>
<span class="cm"> * charge-info.</span>
<span class="cm"> *</span>
<span class="cm"> * cps-calculation (needed for dynamic channel-bundling):</span>
<span class="cm"> * Since this function is called every second, simply reset the</span>
<span class="cm"> * byte-counter of the interface after copying it to the cps-variable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_jiffies</span> <span class="o">=</span> <span class="o">-</span><span class="n">HZ</span><span class="p">;</span>

<span class="kt">void</span>
<span class="nf">isdn_net_autohup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">anymore</span><span class="p">;</span>

	<span class="n">anymore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">l</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">==</span> <span class="n">last_jiffies</span><span class="p">)</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">transcount</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">transcount</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">last_jiffies</span><span class="p">);</span>
		<span class="n">l</span><span class="o">-&gt;</span><span class="n">transcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_verbose</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %d bogocps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">cps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">l</span><span class="o">-&gt;</span><span class="n">huptimer</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * if there is some dialmode where timeout-hangup</span>
<span class="cm">			 * should _not_ be done, check for that here</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">onhtime</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">&gt;</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">onhtime</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_MANCHARGE</span> <span class="o">&amp;&amp;</span>
				    <span class="n">l</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_CHARGEHUP</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargetime</span> <span class="o">+</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargeint</span><span class="p">))</span>
						<span class="n">l</span><span class="o">-&gt;</span><span class="n">chargetime</span> <span class="o">+=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargeint</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargetime</span> <span class="o">+</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargeint</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">||</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_INHUP</span><span class="p">)</span>
							<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_CHARGEHUP</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_WAITCHARGE</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_net: Hupflags of %s are %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">hupflags</span><span class="p">);</span>
							<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargetime</span> <span class="o">+</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargeint</span><span class="p">))</span> <span class="p">{</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
							       <span class="s">&quot;isdn_net: %s: chtime = %lu, chint = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargetime</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">chargeint</span><span class="p">);</span>
							<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_INHUP</span><span class="p">)</span>
					<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">global_flags</span> <span class="o">&amp;</span> <span class="n">ISDN_GLOBAL_STOPPED</span> <span class="o">||</span> <span class="p">(</span><span class="n">ISDN_NET_DIALMODE</span><span class="p">(</span><span class="o">*</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISDN_NET_DM_OFF</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">last_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_NETHANGUP</span><span class="p">,</span> <span class="n">anymore</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_net_lp_disconnected</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_rm_from_bundle</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle status-messages from ISDN-interfacecard.</span>
<span class="cm"> * This function is called from within the main-status-dispatcher</span>
<span class="cm"> * isdn_status_callback, which itself is called from the low-level driver.</span>
<span class="cm"> * Return: 1 = Event handled, 0 = not for us or unknown Event.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_stat_callback</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">isdn_ctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">st_netdev</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
		<span class="k">struct</span> <span class="n">concap_proto</span> <span class="o">*</span><span class="n">cprot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">concap_proto_ops</span> <span class="o">*</span><span class="n">pops</span> <span class="o">=</span> <span class="n">cprot</span> <span class="o">?</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_BSENT</span>:
			<span class="cm">/* A packet has successfully been sent out */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isdn_net_dec_frame_cnt</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_DCONN</span>:
			<span class="cm">/* D-Channel is up */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">case</span> <span class="mi">7</span>:
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="o">++</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_DHUP</span>:
			<span class="cm">/* Either D-Channel-hangup or error during dialout */</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
			<span class="cm">/* If we are not connencted then dialing had</span>
<span class="cm">			   failed. If there are generic encap protocol</span>
<span class="cm">			   receiver routines signal the closure of</span>
<span class="cm">			   the link*/</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">pops</span> <span class="o">&amp;&amp;</span> <span class="n">pops</span><span class="o">-&gt;</span><span class="n">disconn_ind</span><span class="p">)</span>
				<span class="n">pops</span><span class="o">-&gt;</span><span class="n">disconn_ind</span><span class="p">(</span><span class="n">cprot</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_X25 */</span><span class="cp"></span>
			<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLCK</span><span class="p">)</span>
					<span class="n">isdn_net_ciscohdlck_disconnected</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
					<span class="n">isdn_ppp_free</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">isdn_net_lp_disconnected</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="n">isdn_all_eaz</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: remote hangup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Chargesum is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">charge</span><span class="p">);</span>
				<span class="n">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_BHUP</span>:
			<span class="cm">/* B-Channel-hangup */</span>
			<span class="cm">/* try if there are generic encap protocol</span>
<span class="cm">			   receiver routines and signal the closure of</span>
<span class="cm">			   the link */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pops</span> <span class="o">&amp;&amp;</span> <span class="n">pops</span><span class="o">-&gt;</span><span class="n">disconn_ind</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pops</span><span class="o">-&gt;</span><span class="n">disconn_ind</span><span class="p">(</span><span class="n">cprot</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_X25 */</span><span class="cp"></span>
		<span class="k">case</span> <span class="n">ISDN_STAT_BCONN</span>:
			<span class="cm">/* B-Channel is up */</span>
			<span class="n">isdn_net_zero_frame_cnt</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">5</span>:
			<span class="k">case</span> <span class="mi">6</span>:
			<span class="k">case</span> <span class="mi">7</span>:
			<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">case</span> <span class="mi">9</span>:
			<span class="k">case</span> <span class="mi">10</span>:
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ISDN_USAGE_OUTGOING</span><span class="p">;</span>
					<span class="n">isdn_info_update</span><span class="p">();</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_netdev</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_NETHANGUP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLCK</span><span class="p">)</span>
					<span class="n">isdn_net_ciscohdlck_connected</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">!=</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* is lp a slave? */</span>
						<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">nd</span> <span class="o">=</span> <span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
						<span class="n">isdn_net_add_to_bundle</span><span class="p">(</span><span class="n">nd</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_net: %s connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* If first Chargeinfo comes before B-Channel connect,</span>
<span class="cm">				 * we correct the timestamp here.</span>
<span class="cm">				 */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargetime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

				<span class="cm">/* reset dial-timeout */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
					<span class="n">isdn_ppp_wakeup_daemon</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
				<span class="cm">/* try if there are generic concap receiver routines */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pops</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">connect_ind</span><span class="p">)</span>
						<span class="n">pops</span><span class="o">-&gt;</span><span class="n">connect_ind</span><span class="p">(</span><span class="n">cprot</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_X25 */</span><span class="cp"></span>
				<span class="cm">/* ppp needs to do negotiations first */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">!=</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
					<span class="n">isdn_net_device_wake_queue</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_NODCH</span>:
			<span class="cm">/* No D-Channel avail. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="o">--</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_STAT_CINF</span>:
			<span class="cm">/* Charge-info from TelCo. Calculate interval between</span>
<span class="cm">			 * charge-infos and set timestamp for last info for</span>
<span class="cm">			 * usage by isdn_net_autohup()</span>
<span class="cm">			 */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">charge</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_HAVECHARGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_WAITCHARGE</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargeint</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargetime</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_WAITCHARGE</span><span class="p">)</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">|=</span> <span class="n">ISDN_HAVECHARGE</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargetime</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_net: Got CINF chargetime of %s now %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargetime</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform dialout for net-interfaces and timeout-handling for</span>
<span class="cm"> * D-Channel-up and B-Channel-up Messages.</span>
<span class="cm"> * This function is initially called from within isdn_net_start_xmit() or</span>
<span class="cm"> * or isdn_net_find_icall() after initializing the dialstate for an</span>
<span class="cm"> * interface. If further calls are needed, the function schedules itself</span>
<span class="cm"> * for a timer-callback via isdn_timer_function().</span>
<span class="cm"> * The dialstate is also affected by incoming status-messages from</span>
<span class="cm"> * the ISDN-Channel which are handled in isdn_net_stat_callback() above.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_net_dial</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">anymore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">phone_number</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

<span class="cp">#ifdef ISDN_DEBUG_NET_DIAL</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dialstate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* Nothing to do for this interface */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* Initiate dialout. Set phone-number-pointer to first number</span>
<span class="cm">			 * of interface.</span>
<span class="cm">			 */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: phone number deleted?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* Prepare dialing. Clear EAZ, then set EAZ. */</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_CLREAZ</span><span class="p">;</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">driver</span><span class="p">));</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETEAZ</span><span class="p">;</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialretry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="cm">/* Setup interface, dial current phone-number, switch to next number.</span>
<span class="cm">			 * If list of phone-numbers is exhausted, increment</span>
<span class="cm">			 * retry-counter.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">global_flags</span> <span class="o">&amp;</span> <span class="n">ISDN_GLOBAL_STOPPED</span> <span class="o">||</span> <span class="p">(</span><span class="n">ISDN_NET_DIALMODE</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISDN_NET_DM_OFF</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">global_flags</span> <span class="o">&amp;</span> <span class="n">ISDN_GLOBAL_STOPPED</span><span class="p">)</span>
					<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;dial suppressed: isdn system stopped&quot;</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;dial suppressed: dialmode `off&#39;&quot;</span><span class="p">;</span>
				<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
				<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL2</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL3</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: phone number deleted?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="s">&quot;LEASED&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;LEASED&quot;</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Open leased line ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span><span class="p">;</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;dial: timed out&quot;</span><span class="p">);</span>
						<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

				<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_DIAL</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* check for DOV */</span>
				<span class="n">phone_number</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">phone_number</span> <span class="o">==</span> <span class="sc">&#39;v&#39;</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="o">*</span><span class="n">phone_number</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* DOV call */</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* DATA call */</span>
					<span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">strcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Switch to next number or back to start if at end of list.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_phone</span> <span class="o">*</span><span class="p">)</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dial</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialretry</span><span class="o">++</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialretry</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialmax</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span><span class="p">;</span>
							<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
							<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;dial: tried all numbers dialmax times&quot;</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">eazmsn</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
					<span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">driver</span><span class="p">));</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">isdn_dc2minor</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ISDN_USAGE_OUTGOING</span><span class="p">;</span>
					<span class="n">isdn_info_update</span><span class="p">();</span>
				<span class="p">}</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: dialing %d %s... %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialretry</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">phone</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">setup</span><span class="p">.</span><span class="n">si1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DOV&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_DIAL</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dial: d=%d c=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargeint</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">|=</span> <span class="n">ISDN_HAVECHARGE</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_WAITCHARGE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">|=</span> <span class="n">ISDN_WAITCHARGE</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_HAVECHARGE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cbdelay</span> <span class="o">&amp;&amp;</span>
				 <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CBOUT</span><span class="p">))</span> <span class="o">?</span> <span class="mi">12</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="cm">/* Wait for D-Channel-connect.</span>
<span class="cm">			 * If timeout, switch back to state 3.</span>
<span class="cm">			 * Dialmax-handling moved to state 3.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">ISDN_TIMER_DTIMEOUT10</span><span class="p">)</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="cm">/* Got D-Channel-Connect, send B-Channel-request */</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_ACCEPTB</span><span class="p">;</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="o">++</span><span class="p">;</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="cm">/* Wait for B- or D-Channel-connect. If timeout,</span>
<span class="cm">			 * switch back to state 3.</span>
<span class="cm">			 */</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_DIAL</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dialtimer2: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">ISDN_TIMER_DTIMEOUT10</span><span class="p">)</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="cm">/* Got incoming Call, setup L2 and L3 protocols,</span>
<span class="cm">			 * then wait for D-Channel-connect</span>
<span class="cm">			 */</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_DIAL</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dialtimer4: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL2</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_SETL3</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">+</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">ISDN_TIMER_DTIMEOUT15</span><span class="p">)</span>
				<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:
			<span class="cm">/* Got incoming D-Channel-Connect, send B-Channel-request */</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_ACCEPTB</span><span class="p">;</span>
			<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="cm">/*  Wait for B- or D-channel-connect */</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_DIAL</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;dialtimer4: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">ISDN_TIMER_DTIMEOUT10</span><span class="p">)</span>
				<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">11</span>:
			<span class="cm">/* Callback Delay */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cbdelay</span><span class="p">)</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">12</span>:
			<span class="cm">/* Remote does callback. Hangup after cbdelay, then wait for incoming</span>
<span class="cm">			 * call (in state 4).</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cbdelay</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: hangup waiting for callback ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_HANGUP</span><span class="p">;</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
				<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
				<span class="n">isdn_all_eaz</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">anymore</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: Illegal dialstate %d for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_NETDIAL</span><span class="p">,</span> <span class="n">anymore</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform hangup for a net-interface.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">isdn_net_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">isdn_ctrl</span> <span class="n">cmd</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">struct</span> <span class="n">concap_proto</span> <span class="o">*</span><span class="n">cprot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">concap_proto_ops</span> <span class="o">*</span><span class="n">pops</span> <span class="o">=</span> <span class="n">cprot</span> <span class="o">?</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">slp</span> <span class="o">=</span> <span class="n">ISDN_SLAVE_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				       <span class="s">&quot;isdn_net: hang up slave %s before %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_net: local hangup %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
			<span class="n">isdn_ppp_free</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">isdn_net_lp_disconnected</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
		<span class="cm">/* try if there are generic encap protocol</span>
<span class="cm">		   receiver routines and signal the closure of</span>
<span class="cm">		   the link */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pops</span> <span class="o">&amp;&amp;</span> <span class="n">pops</span><span class="o">-&gt;</span><span class="n">disconn_ind</span><span class="p">)</span>
			<span class="n">pops</span><span class="o">-&gt;</span><span class="n">disconn_ind</span><span class="p">(</span><span class="n">cprot</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_X25 */</span><span class="cp"></span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ISDN_CMD_HANGUP</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
		<span class="n">isdn_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Chargesum is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">charge</span><span class="p">);</span>
		<span class="n">isdn_all_eaz</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">source</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">dest</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ip_ports</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_log_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* hopefully, this was set correctly */</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">skb_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">proto</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">data_ofs</span><span class="p">;</span>
	<span class="n">ip_ports</span> <span class="o">*</span><span class="n">ipp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">addinfo</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>

	<span class="n">addinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="cm">/* This check stolen from 2.1.72 dev_queue_xmit_nit() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">&gt;=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* fall back to old isdn_net_log_packet method() */</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_net: protocol %04x is buggy, dev %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">ETH_P_IP</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_IPTYP</span>:
			<span class="n">proto</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_ETHER</span>:
			<span class="n">proto</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLC</span>:
			<span class="n">proto</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
		<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span>:
			<span class="n">proto</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">IPPP_MAX_HEADER</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">data_ofs</span> <span class="o">=</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ETH_P_IP</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; ICMP&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; IGMP&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; IPIP&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">ipp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_ports</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">data_ofs</span><span class="p">]);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; TCP, port: %d -&gt; %d&quot;</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ipp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">),</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">ipp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; EGP&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">12</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; PUP&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">17</span>:
			<span class="n">ipp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip_ports</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">data_ofs</span><span class="p">]);</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; UDP, port: %d -&gt; %d&quot;</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">ipp</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">),</span>
				<span class="n">ntohs</span><span class="p">(</span><span class="n">ipp</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">22</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">addinfo</span><span class="p">,</span> <span class="s">&quot; IDP&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OPEN: %pI4 -&gt; %pI4%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">p</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">addinfo</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ETH_P_ARP</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;OPEN: ARP %pI4 -&gt; *.*.*.* ?%pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">p</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this function is used to send supervisory data, i.e. data which was</span>
<span class="cm"> * not received from the network layer, but e.g. frames from ipppd, CCP</span>
<span class="cm"> * reset frames etc.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">isdn_net_write_super</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_irq</span><span class="p">())</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>we can't grab the lock from irq context,
so we just queue the packet</p></td><td class="code"><div class="highlight"><pre>		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">super_tx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdn_net_lp_busy</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">isdn_net_writebuf_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">super_tx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called from tq_immediate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_net_softint</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">isdn_net_local</span><span class="p">,</span> <span class="n">tqueue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">isdn_net_lp_busy</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">super_tx_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">isdn_net_writebuf_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * all frames sent from the (net) LL to a HL driver should go via this function</span>
<span class="cm"> * it&#39;s serialized by the caller holding the lp-&gt;xmit_lock spinlock</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">isdn_net_writebuf_skb</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>     <span class="cm">/* save len */</span>

	<span class="cm">/* before obtaining the lock the caller should have checked that</span>
<span class="cm">	   the lp isn&#39;t busy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_net_lp_busy</span><span class="p">(</span><span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;isdn BUG at %s:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;isdn BUG at %s:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">isdn_writebuf_skb_stub</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we should never get here */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: HL driver queue full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">transcount</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">isdn_net_inc_frame_cnt</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Helper function for isdn_net_start_xmit.</span>
<span class="cm"> *  When called, the connection is already established.</span>
<span class="cm"> *  Based on cps-calculation, check if device is overloaded.</span>
<span class="cm"> *  If so, and if a slave exists, trigger dialing for it.</span>
<span class="cm"> *  If any slave is online, deliver packets using a simple round robin</span>
<span class="cm"> *  scheme.</span>
<span class="cm"> *</span>
<span class="cm"> *  Return: 0 on success, !0 on failure.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">nd</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">slp</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retv</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;isdn BUG at %s:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For the other encaps the header has already been built */</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">isdn_ppp_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">nd</span> <span class="o">=</span> <span class="p">((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">lp</span> <span class="o">=</span> <span class="n">isdn_net_get_locked_lp</span><span class="p">(</span><span class="n">nd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: all channels busy - requeuing!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* we have our lp locked from now on */</span>

	<span class="cm">/* Reset hangup-timeout */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// FIXME?</span>
	<span class="n">isdn_net_writebuf_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>

	<span class="cm">/* the following stuff is here for backwards compatibility.</span>
<span class="cm">	 * in future, start-up and hangup of slaves (based on current load)</span>
<span class="cm">	 * should move to userspace and get based on an overall cps</span>
<span class="cm">	 * calculation</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">&gt;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">triggercps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sqfull</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* First time overload: set timestamp only */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">sqfull</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">sqfull_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* subsequent overload: if slavedelay exceeded, start dialing */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sqfull_stamp</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">slavedelay</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">slp</span> <span class="o">=</span> <span class="n">ISDN_SLAVE_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">slp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">isdn_net_force_dial_lp</span><span class="p">(</span><span class="n">ISDN_SLAVE_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">sqfull</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">sqfull_stamp</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">slavedelay</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">sqfull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* this is a hack to allow auto-hangup for slaves on moderate loads */</span>
		<span class="n">nd</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">nd</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retv</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_adjust_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_ETHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">int</span> <span class="n">pullsize</span> <span class="o">=</span> <span class="n">skb_network_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pullsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;isdn_net: Pull junk %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pullsize</span><span class="p">);</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pullsize</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_net_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_tx_timeout dev %s dialstate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * There is a certain probability that this currently</span>
<span class="cm">		 * works at all because if we always wake up the interface,</span>
<span class="cm">		 * then upper layer will try to send the next packet</span>
<span class="cm">		 * immediately. And then, the old clean_up logic in the</span>
<span class="cm">		 * driver will hopefully continue to work as it used to do.</span>
<span class="cm">		 *</span>
<span class="cm">		 * This is rather primitive right know, we better should</span>
<span class="cm">		 * clean internal queues here, in particular for multilink and</span>
<span class="cm">		 * ppp, and reset HL driver&#39;s channel, too.   --HE</span>
<span class="cm">		 *</span>
<span class="cm">		 * actually, this may not matter at all, because ISDN hardware</span>
<span class="cm">		 * should not see transmitter hangs at all IMO</span>
<span class="cm">		 * changed KERN_DEBUG to KERN_WARNING to find out if this is</span>
<span class="cm">		 * ever called   --KG</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try sending a packet.</span>
<span class="cm"> * If this interface isn&#39;t connected to a ISDN-Channel, find a free channel,</span>
<span class="cm"> * and start dialing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">isdn_net_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">struct</span> <span class="n">concap_proto</span> <span class="o">*</span><span class="n">cprot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
<span class="cm">/* At this point hard_start_xmit() passes control to the encapsulation</span>
<span class="cm">   protocol (if present).</span>
<span class="cm">   For X.25 auto-dialing is completly bypassed because:</span>
<span class="cm">   - It does not conform with the semantics of a reliable datalink</span>
<span class="cm">   service as needed by X.25 PLP.</span>
<span class="cm">   - I don&#39;t want that the interface starts dialing when the network layer</span>
<span class="cm">   sends a message which requests to disconnect the lapb link (or if it</span>
<span class="cm">   sends any other message not resulting in data transmission).</span>
<span class="cm">   Instead, dialing will be initiated by the encapsulation protocol entity</span>
<span class="cm">   when a dl_establish request is received from the upper layer.</span>
<span class="cm">*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cprot</span> <span class="o">&amp;&amp;</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">encap_and_xmit</span><span class="p">(</span><span class="n">cprot</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
		<span class="cm">/* auto-dialing xmit function */</span>
	<span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_DUMP</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">isdn_net_adjust_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_DUMP</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">isdn_dumppkt</span><span class="p">(</span><span class="s">&quot;S:&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">chi</span><span class="p">;</span>
			<span class="cm">/* only do autodial if allowed by config */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ISDN_NET_DIALMODE</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISDN_NET_DM_AUTO</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;dial rejected: interface not in dialmode `auto&#39;&quot;</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span><span class="p">))</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;dial rejected: retry-time not reached&quot;</span><span class="p">);</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Grab a free ISDN-Channel */</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">chi</span> <span class="o">=</span>
				      <span class="n">isdn_get_free_channel</span><span class="p">(</span>
					      <span class="n">ISDN_USAGE_NET</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">)</span>
					     <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">((</span><span class="n">chi</span> <span class="o">=</span>
				      <span class="n">isdn_get_free_channel</span><span class="p">(</span>
					      <span class="n">ISDN_USAGE_NET</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="o">^</span><span class="mi">1</span><span class="p">,</span>
					      <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">)</span>
					    <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
							     <span class="s">&quot;No channel&quot;</span><span class="p">);</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Log packet, which triggered dialing */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_verbose</span><span class="p">)</span>
					<span class="n">isdn_net_log_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">lp</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="cm">/* Connect interface with channel */</span>
				<span class="n">isdn_net_bind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">chi</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* no &#39;first_skb&#39; handling for syncPPP */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_bind</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="n">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
						<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>	<span class="cm">/* STN (skb to nirvana) ;) */</span>
					<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IPPP_FILTER</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_autodial_filter</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">lp</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">isdn_ppp_free</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
						<span class="n">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
						<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;dial rejected: packet filtered&quot;</span><span class="p">);</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
					<span class="p">}</span>
<span class="cp">#endif</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">isdn_net_dial</span><span class="p">();</span>	<span class="cm">/* Initiate dialing */</span>
					<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>	<span class="cm">/* let upper layer requeue skb packet */</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="cm">/* Initiate dialing */</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">isdn_net_dial</span><span class="p">();</span>
				<span class="n">isdn_net_device_stop_queue</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">isdn_net_unreachable</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
						     <span class="s">&quot;No phone number&quot;</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Device is connected to an ISDN channel */</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* ISDN connection is established, try sending */</span>
				<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_xmit</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">skb</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Shutdown a net-interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">struct</span> <span class="n">concap_proto</span> <span class="o">*</span><span class="n">cprot</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
	<span class="cm">/* printk(KERN_DEBUG &quot;isdn_net_close %s\n&quot; , dev-&gt; name); */</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cprot</span> <span class="o">&amp;&amp;</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="p">)</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">cprot</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If this interface has slaves, stop them also */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
			<span class="n">cprot</span> <span class="o">=</span> <span class="p">((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
				<span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cprot</span> <span class="o">&amp;&amp;</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="p">)</span>
				<span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">cprot</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">isdn_unlock_drivers</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get statistics</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">isdn_net_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*      This is simply a copy from std. eth.c EXCEPT we pull ETH_HLEN</span>
<span class="cm"> *      instead of dev-&gt;hard_header_len off. This is done because the</span>
<span class="cm"> *      lowlevel-driver has already pulled off its stuff when we get</span>
<span class="cm"> *      here and this routine only gets called with p_encap == ETHER.</span>
<span class="cm"> *      Determine the packet&#39;s protocol ID. The rule here is that we</span>
<span class="cm"> *      assume 802.3 if the type field is short enough to be a length.</span>
<span class="cm"> *      This is normal practice and works for any &#39;now in use&#39; protocol.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">__be16</span>
<span class="nf">isdn_net_type_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rawp</span><span class="p">;</span>

	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
	<span class="n">eth</span> <span class="o">=</span> <span class="n">eth_hdr</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_BROADCAST</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_MULTICAST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *      This ALLMULTI check should be redundant by 1.4</span>
<span class="cm">	 *      so don&#39;t forget to remove it.</span>
<span class="cm">	 */</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_PROMISC</span> <span class="cm">/*| IFF_ALLMULTI*/</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1536</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>

	<span class="n">rawp</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *      This is a magic hack to spot IPX packets. Older Novell breaks</span>
<span class="cm">	 *      the protocol design and runs IPX over 802.3 without an 802.2 LLC</span>
<span class="cm">	 *      layer. We look for FFFF which isn&#39;t a used 802.2 SSAP/DSAP. This</span>
<span class="cm">	 *      won&#39;t work for fault tolerant netware but does for the rest.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">rawp</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_3</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 *      Real 802.2 LLC</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * CISCO HDLC keepalive specific stuff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span>
<span class="nf">isdn_net_ciscohdlck_alloc_skb</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">hl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">hl</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;isdn out of mem at %s:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cisco hdlck device private ioctls */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_ciscohdlck_dev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">period</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">debserint</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">!=</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLCK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get/set keepalive period */</span>
	<span class="k">case</span> <span class="n">SIOCGKEEPPERIOD</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSKEEPPERIOD</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">period</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">period</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">period</span> <span class="o">&lt;=</span> <span class="mi">32767</span><span class="p">))</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">jiffies</span> <span class="o">+</span>
						  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">,</span> <span class="n">expires</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Keepalive period set &quot;</span>
			       <span class="s">&quot;to %d seconds.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* get/set debugging */</span>
	<span class="k">case</span> <span class="n">SIOCGDEBSERINT</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSDEBSERINT</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">debserint</span><span class="p">,</span>
				   <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">debserint</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">debserint</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">))</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span> <span class="o">=</span> <span class="n">debserint</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span>:
		<span class="k">return</span> <span class="n">isdn_ppp_dev_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLCK</span>:
		<span class="k">return</span> <span class="n">isdn_ciscohdlck_dev_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* called via cisco_timer.function */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_ciscohdlck_slarp_send_keepalive</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_cisco_myseq</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_myseq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">myseq_diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;isdn BUG at %s:%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_myseq</span><span class="o">++</span><span class="p">;</span>

	<span class="n">myseq_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_myseq</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_mineseen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_line_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">myseq_diff</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">myseq_diff</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* line up -&gt; down */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_line_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;UPDOWN: Line protocol on Interface %s,&quot;</span>
		       <span class="s">&quot; changed state to down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* should stop routing higher-level data across */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_line_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">myseq_diff</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">myseq_diff</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* line down -&gt; up */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_line_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;UPDOWN: Line protocol on Interface %s,&quot;</span>
		       <span class="s">&quot; changed state to up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* restart routing higher-level data across */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HDLC &quot;</span>
		       <span class="s">&quot;myseq %lu, mineseen %lu%c, yourseen %lu, %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">last_cisco_myseq</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_mineseen</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">last_cisco_myseq</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_mineseen</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;*&#39;</span> <span class="o">:</span> <span class="mo">040</span><span class="p">),</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_yourseq</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_line_state</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;line up&quot;</span> <span class="o">:</span> <span class="s">&quot;line down&quot;</span><span class="p">));</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_net_ciscohdlck_alloc_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>

	<span class="cm">/* cisco header */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_ADDR_UNICAST</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_CTRL</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">CISCO_TYPE_SLARP</span><span class="p">);</span>

	<span class="cm">/* slarp keepalive */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">CISCO_SLARP_KEEPALIVE</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_myseq</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_yourseq</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span> <span class="c1">// reliability, always 0xffff</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="n">isdn_net_write_super</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_ciscohdlck_slarp_send_request</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_net_ciscohdlck_alloc_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>

	<span class="cm">/* cisco header */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_ADDR_UNICAST</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_CTRL</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">CISCO_TYPE_SLARP</span><span class="p">);</span>

	<span class="cm">/* slarp request */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">CISCO_SLARP_REQUEST</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// address</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// netmask</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// unused</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="n">isdn_net_write_super</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_ciscohdlck_connected</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_myseq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_mineseen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_yourseq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span> <span class="o">=</span> <span class="n">ISDN_TIMER_KEEPINT</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_last_slarp_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_line_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* send slarp request because interface/seq.no.s reset */</span>
	<span class="n">isdn_net_ciscohdlck_slarp_send_request</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lp</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">isdn_net_ciscohdlck_slarp_send_keepalive</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_ciscohdlck_disconnected</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_ciscohdlck_slarp_send_reply</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_device</span> <span class="o">*</span><span class="n">in_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* local ipv4 address */</span>
	<span class="n">__be32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* local netmask */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">in_dev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ip_ptr</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* take primary(first) address of interface */</span>
		<span class="k">struct</span> <span class="n">in_ifaddr</span> <span class="o">*</span><span class="n">ifa</span> <span class="o">=</span> <span class="n">in_dev</span><span class="o">-&gt;</span><span class="n">ifa_list</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifa</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_local</span><span class="p">;</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">ifa</span><span class="o">-&gt;</span><span class="n">ifa_mask</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">isdn_net_ciscohdlck_alloc_skb</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">14</span><span class="p">);</span>

	<span class="cm">/* cisco header */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_ADDR_UNICAST</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_CTRL</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">CISCO_TYPE_SLARP</span><span class="p">);</span>

	<span class="cm">/* slarp reply, send own ip/netmask; if values are nonsense remote</span>
<span class="cm">	 * should think we are unable to provide it with an address via SLARP */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">CISCO_SLARP_REPLY</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span> <span class="c1">// address</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span> <span class="c1">// netmask</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// unused</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="n">isdn_net_write_super</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_ciscohdlck_slarp_in</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">my_seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">your_seq</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">code</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CISCO_SLARP_REQUEST</span>:
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_yourseq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">isdn_net_ciscohdlck_slarp_send_reply</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CISCO_SLARP_REPLY</span>:
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0xfffffffc</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">slarp_reply_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">==</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">slarp_reply_out</span><span class="p">;</span>
		<span class="n">local</span> <span class="o">=</span> <span class="o">*</span><span class="n">addr</span> <span class="o">^</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: got slarp reply: remote ip: %pI4, local ip: %pI4 mask: %pI4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">slarp_reply_out:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: got invalid slarp reply (%pI4/%pI4) - ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CISCO_SLARP_KEEPALIVE</span>:
		<span class="n">period</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_last_slarp_in</span>
				<span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">period</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_last_slarp_in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Keepalive period mismatch - &quot;</span>
			       <span class="s">&quot;is %d but should be %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_keepalive_period</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_last_slarp_in</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">my_seq</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">your_seq</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_yourseq</span> <span class="o">=</span> <span class="n">my_seq</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_mineseen</span> <span class="o">=</span> <span class="n">your_seq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_ciscohdlck_receive</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">be16_to_cpup</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">CISCO_ADDR_UNICAST</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">!=</span> <span class="n">CISCO_ADDR_BROADCAST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unknown Cisco addr 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">!=</span> <span class="n">CISCO_CTRL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unknown Cisco ctrl 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CISCO_TYPE_SLARP</span>:
		<span class="n">isdn_net_ciscohdlck_slarp_in</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CISCO_TYPE_CDP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cisco_debserint</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Received CDP packet. use &quot;</span>
			       <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">no cdp enable</span><span class="se">\&quot;</span><span class="s"> on cisco.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* no special cisco protocol */</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Got a packet from ISDN-Channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">olp</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>	<span class="cm">/* original &#39;lp&#39; */</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">struct</span> <span class="n">concap_proto</span> <span class="o">*</span><span class="n">cprot</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">transcount</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bundling: If device is a slave-device, deliver to master, also</span>
<span class="cm">		 * handle master&#39;s statistics and hangup-timeout</span>
<span class="cm">		 */</span>
		<span class="n">ndev</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
		<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_DUMP</span>
	<span class="n">isdn_dumppkt</span><span class="p">(</span><span class="s">&quot;R:&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_ETHER</span>:
		<span class="cm">/* Ethernet over ISDN */</span>
		<span class="n">olp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">isdn_net_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_UIHDLC</span>:
		<span class="cm">/* HDLC with UI-frame (for ispa with -h1 option) */</span>
		<span class="n">olp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_RAWIP</span>:
		<span class="cm">/* RAW-IP without MAC-Header */</span>
		<span class="n">olp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLCK</span>:
		<span class="n">isdn_net_ciscohdlck_receive</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLC</span>:
		<span class="cm">/* CISCO-HDLC IP with type field and  fake I-frame-header */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_IPTYP</span>:
		<span class="cm">/* IP with type field */</span>
		<span class="n">olp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span>:
		<span class="cm">/* huptimer is done in isdn_ppp_push_higher */</span>
		<span class="n">isdn_ppp_receive</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">olp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
		<span class="cm">/* try if there are generic sync_device receiver routines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cprot</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="p">)</span>
				   <span class="k">if</span> <span class="p">(</span><span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">data_ind</span><span class="p">)</span> <span class="p">{</span>
					   <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">data_ind</span><span class="p">(</span><span class="n">cprot</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
					   <span class="k">return</span><span class="p">;</span>
				   <span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_X25 */</span><span class="cp"></span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown encapsulation, dropping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A packet arrived via ISDN. Search interface-chain for a corresponding</span>
<span class="cm"> * interface. If found, deliver packet to receiver-function and return 1,</span>
<span class="cm"> * else return 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_rcv_skb</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_netdev</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">isdn_net_receive</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  build an header</span>
<span class="cm"> *  depends on encaps that is being used.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_net_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">plen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_ETHER</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">eth_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span>:
		<span class="cm">/* stick on a fake header to keep fragmentation code happy. */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">IPPP_MAX_HEADER</span><span class="p">;</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_RAWIP</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net_header called with RAW_IP!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_IPTYP</span>:
		<span class="cm">/* ethernet type field */</span>
		<span class="o">*</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_UIHDLC</span>:
		<span class="cm">/* HDLC with UI-Frames (for ispa with -h1 option) */</span>
		<span class="o">*</span><span class="p">((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0x0103</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLC</span>:
	<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLCK</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_ADDR_UNICAST</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">CISCO_CTRL</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="nl">default:</span>
		<span class="cm">/* try if there are generic concap protocol routines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net_header called with concap_proto!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ISDN_X25 */</span><span class="cp"></span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We don&#39;t need to send arp, because we have point-to-point connections. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_rebuild_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_ETHER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">eth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 *      Only ARP/IP is currently supported</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">!=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;isdn_net: %s don&#39;t know how to resolve type %d addresses?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 *      Try to get ARP to resolve the header.</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef CONFIG_INET</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">arp_find</span><span class="p">(</span><span class="n">eth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isdn_header_cache</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">neighbour</span> <span class="o">*</span><span class="n">neigh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hh_cache</span> <span class="o">*</span><span class="n">hh</span><span class="p">,</span>
			     <span class="n">__be16</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eth_header_cache</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isdn_header_cache_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">hh_cache</span> <span class="o">*</span><span class="n">hh</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">haddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_ETHER</span><span class="p">)</span>
		<span class="n">eth_header_cache_update</span><span class="p">(</span><span class="n">hh</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">haddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">header_ops</span> <span class="n">isdn_header_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">isdn_net_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rebuild</span> <span class="o">=</span> <span class="n">isdn_net_rebuild_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">isdn_header_cache</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cache_update</span> <span class="o">=</span> <span class="n">isdn_header_cache_update</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Interface-setup. (just after registering a new interface)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ushort</span> <span class="n">max_hlhdr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drvidx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  up till binding we ask the protocol layer to reserve as much</span>
<span class="cm">	 *  as we might need for HL layer</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">drvidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">drvidx</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_DRIVERS</span><span class="p">;</span> <span class="n">drvidx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drvidx</span><span class="p">])</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_hlhdr_len</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drvidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span><span class="p">)</span>
				<span class="n">max_hlhdr_len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">drvidx</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">hl_hdrlen</span><span class="p">;</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">max_hlhdr_len</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_swapbind</span><span class="p">(</span><span class="kt">int</span> <span class="n">drvidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: swapping ch of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drvidx</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">==</span> <span class="n">drvidx</span><span class="p">)</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pre_channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pre_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isdn_net_swap_usage</span><span class="p">(</span><span class="kt">int</span> <span class="n">i1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">u1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">u2</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">;</span>

<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: usage of %d and %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">u2</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">u1</span><span class="p">;</span>
	<span class="n">isdn_info_update</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * An incoming call-request has arrived.</span>
<span class="cm"> * Search the interface-chain for an appropriate interface.</span>
<span class="cm"> * If found, connect the interface to the ISDN-channel and initiate</span>
<span class="cm"> * D- and B-Channel-setup. If secure-flag is set, accept only</span>
<span class="cm"> * configured phone-numbers. If callback-flag is set, initiate</span>
<span class="cm"> * callback-dialing.</span>
<span class="cm"> *</span>
<span class="cm"> * Return-Value: 0 = No appropriate interface for this call.</span>
<span class="cm"> *               1 = Call accepted</span>
<span class="cm"> *               2 = Reject call, wait cbdelay, then call back</span>
<span class="cm"> *               3 = Reject call</span>
<span class="cm"> *               4 = Wait cbdelay, then call back</span>
<span class="cm"> *               5 = No appropriate interface for this call,</span>
<span class="cm"> *                   would eventually match if CID was longer.</span>
<span class="cm"> */</span>

<span class="kt">int</span>
<span class="nf">isdn_net_find_icall</span><span class="p">(</span><span class="kt">int</span> <span class="n">di</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">setup_parm</span> <span class="o">*</span><span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">eaz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">si1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">si2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ematch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">swapped</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">isdn_net_phone</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">nr</span><span class="p">[</span><span class="n">ISDN_MSNLEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">my_eaz</span><span class="p">;</span>

	<span class="cm">/* Search name in netdev-chain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">nr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="n">nr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_net: Incoming call without OAD, assuming &#39;0&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">,</span> <span class="n">ISDN_MSNLEN</span><span class="p">);</span>
	<span class="n">si1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">si1</span><span class="p">;</span>
	<span class="n">si2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">si2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">eazmsn</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: Incoming call without CPN, assuming &#39;0&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">eaz</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">eaz</span> <span class="o">=</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">eazmsn</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_net: call from %s,%d,%d -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">si1</span><span class="p">,</span> <span class="n">si2</span><span class="p">,</span> <span class="n">eaz</span><span class="p">);</span>
	<span class="cm">/* Accept DATA and VOICE calls at this stage</span>
<span class="cm">	 * local eaz is checked later for allowed call types</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">si1</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">si1</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_net: Service-Indicator not 1 or 7, ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_phone</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">ematch</span> <span class="o">=</span> <span class="n">wret</span> <span class="o">=</span> <span class="n">swapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: di=%d ch=%d idx=%d usg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="cp">#endif</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">matchret</span><span class="p">;</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

		<span class="cm">/* If last check has triggered as binding-swap, revert it */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">swapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">isdn_net_swap_usage</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sidx</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">isdn_net_swapbind</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">swapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* check acceptable call types for DOV */</span>
		<span class="n">my_eaz</span> <span class="o">=</span> <span class="n">isdn_map_eaz2msn</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">di</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">si1</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* it&#39;s a DOV call, check if we allow it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">my_eaz</span> <span class="o">==</span> <span class="sc">&#39;v&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">my_eaz</span> <span class="o">==</span> <span class="sc">&#39;V&#39;</span> <span class="o">||</span>
			    <span class="o">*</span><span class="n">my_eaz</span> <span class="o">==</span> <span class="sc">&#39;b&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">my_eaz</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
				<span class="n">my_eaz</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* skip to allow a match */</span>
			<span class="k">else</span>
				<span class="n">my_eaz</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* force non match */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* it&#39;s a DATA call, check if we allow it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">my_eaz</span> <span class="o">==</span> <span class="sc">&#39;b&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">my_eaz</span> <span class="o">==</span> <span class="sc">&#39;B&#39;</span><span class="p">)</span>
				<span class="n">my_eaz</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* skip to allow a match */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">my_eaz</span><span class="p">)</span>
			<span class="n">matchret</span> <span class="o">=</span> <span class="n">isdn_msncmp</span><span class="p">(</span><span class="n">eaz</span><span class="p">,</span> <span class="n">my_eaz</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">matchret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">matchret</span><span class="p">)</span>
			<span class="n">ematch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Remember if more numbers eventually can match */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">matchret</span> <span class="o">&gt;</span> <span class="n">wret</span><span class="p">)</span>
			<span class="n">wret</span> <span class="o">=</span> <span class="n">matchret</span><span class="p">;</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: if=&#39;%s&#39;, l.msn=%s, l.flags=%d, l.dstate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">matchret</span><span class="p">)</span> <span class="o">&amp;&amp;</span>                                        <span class="cm">/* EAZ is matching   */</span>
		    <span class="p">(((</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="o">&amp;&amp;</span>              <span class="cm">/* but not connected */</span>
		      <span class="p">(</span><span class="n">USG_NONE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">])))</span> <span class="o">||</span>                     <span class="cm">/* and ch. unused or */</span>
		     <span class="p">((((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">==</span> <span class="mi">12</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="cm">/* if dialing        */</span>
		       <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CALLBACK</span><span class="p">)))</span>                <span class="cm">/* but no callback   */</span>
			     <span class="p">)))</span>
		<span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: match1, pdev=%d pch=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span> <span class="o">!=</span> <span class="n">ch</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">!=</span> <span class="n">di</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Here we got a problem:</span>
<span class="cm">					 * If using an ICN-Card, an incoming call is always signaled on</span>
<span class="cm">					 * on the first channel of the card, if both channels are</span>
<span class="cm">					 * down. However this channel may be bound exclusive. If the</span>
<span class="cm">					 * second channel is free, this call should be accepted.</span>
<span class="cm">					 * The solution is horribly but it runs, so what:</span>
<span class="cm">					 * We exchange the exclusive bindings of the two channels, the</span>
<span class="cm">					 * corresponding variables in the interface-structs.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">sidx</span> <span class="o">=</span> <span class="n">isdn_dc2minor</span><span class="p">(</span><span class="n">di</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: ch is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">USG_NONE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">sidx</span><span class="p">]))</span> <span class="p">{</span>
							<span class="cm">/* Second Channel is free, now see if it is bound</span>
<span class="cm">							 * exclusive too. */</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
								<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: 2nd channel is down and bound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
								<span class="cm">/* Yes, swap bindings only, if the original</span>
<span class="cm">								 * binding is bound to channel 1 of this driver */</span>
								<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">==</span> <span class="n">di</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
								    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
									<span class="n">isdn_net_swapbind</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
									<span class="n">swapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
								<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
									<span class="cm">/* ... else iterate next device */</span>
									<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
									<span class="k">continue</span><span class="p">;</span>
								<span class="p">}</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
								<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: 2nd channel is down and unbound</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
								<span class="cm">/* No, swap always and swap excl-usage also */</span>
								<span class="n">isdn_net_swap_usage</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">sidx</span><span class="p">);</span>
								<span class="n">isdn_net_swapbind</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
								<span class="n">swapped</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
							<span class="p">}</span>
							<span class="cm">/* Now check for exclusive binding again */</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: final check</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
							<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
							    <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span> <span class="o">!=</span> <span class="n">ch</span><span class="p">)</span> <span class="o">||</span>
							     <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">!=</span> <span class="n">di</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
								<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: final check failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
								<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
								<span class="k">continue</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* We are already on the second channel, so nothing to do */</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: already on 2nd channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: match2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_SECURE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdn_msncmp</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">))</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_phone</span> <span class="o">*</span><span class="p">)</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_SECURE</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#ifdef ISDN_DEBUG_NET_ICALL</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;n_fi: match3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="cm">/* matching interface found */</span>

				<span class="cm">/*</span>
<span class="cm">				 * Is the state STOPPED?</span>
<span class="cm">				 * If so, no dialin is allowed,</span>
<span class="cm">				 * so reject actively.</span>
<span class="cm">				 * */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ISDN_NET_DIALMODE</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISDN_NET_DM_OFF</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;incoming call, interface %s `stopped&#39; -&gt; rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * Is the interface up?</span>
<span class="cm">				 * If not, reject the call actively.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isdn_net_device_started</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: incoming call, interface down -&gt; rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* Interface is up, now see if it&#39;s a slave. If so, see if</span>
<span class="cm">				 * it&#39;s master and parent slave is online. If not, reject the call.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;ICALLslv: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;master=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;master online</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="cm">/* Master is online, find parent-slave (master if first slave) */</span>
						<span class="k">while</span> <span class="p">(</span><span class="n">mlp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ISDN_SLAVE_PRIV</span><span class="p">(</span><span class="n">mlp</span><span class="p">)</span> <span class="o">==</span> <span class="n">lp</span><span class="p">)</span>
								<span class="k">break</span><span class="p">;</span>
							<span class="n">mlp</span> <span class="o">=</span> <span class="n">ISDN_SLAVE_PRIV</span><span class="p">(</span><span class="n">mlp</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;master offline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="cm">/* Found parent, if it&#39;s offline iterate next device */</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;mlpf: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mlp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CALLBACK</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">chi</span><span class="p">;</span>
					<span class="cm">/*</span>
<span class="cm">					 * Is the state MANUAL?</span>
<span class="cm">					 * If so, no callback can be made,</span>
<span class="cm">					 * so reject actively.</span>
<span class="cm">					 * */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ISDN_NET_DIALMODE</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISDN_NET_DM_OFF</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;incoming call for callback, interface %s `off&#39; -&gt; rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
						<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: call from %s -&gt; %s, start callback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">eaz</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
						<span class="cm">/* Grab a free ISDN-Channel */</span>
						<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">chi</span> <span class="o">=</span>
						     <span class="n">isdn_get_free_channel</span><span class="p">(</span>
							     <span class="n">ISDN_USAGE_NET</span><span class="p">,</span>
							     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">,</span>
							     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">,</span>
							     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span>
							     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">,</span>
							     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">)</span>
							    <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

							<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net_find_icall: No channel for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
							<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="cm">/* Setup dialstate. */</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
						<span class="cm">/* Connect interface with channel */</span>
						<span class="n">isdn_net_bind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">chi</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_bind</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
								<span class="n">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
								<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
							<span class="p">}</span>
<span class="cp">#endif</span>
						<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
						<span class="cm">/* Initiate dialing by returning 2 or 4 */</span>
						<span class="k">return</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CBHUP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: %s: No phone number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: call from %s -&gt; %s accepted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">eaz</span><span class="p">);</span>
					<span class="cm">/* if this interface is dialing, it does it probably on a different</span>
<span class="cm">					   device, so free this device */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">==</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
							<span class="n">isdn_ppp_free</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="cp">#endif</span>
						<span class="n">isdn_net_lp_disconnected</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
						<span class="n">isdn_free_channel</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">,</span>
								  <span class="n">ISDN_USAGE_NET</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">ISDN_USAGE_NET</span><span class="p">;</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">nr</span><span class="p">);</span>
					<span class="n">isdn_info_update</span><span class="p">();</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">st_netdev</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span> <span class="o">=</span> <span class="n">di</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dtimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">huptimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">|=</span> <span class="n">ISDN_WAITCHARGE</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_HAVECHARGE</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_bind</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
							<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
							<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
<span class="cp">#endif</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If none of configured EAZ/MSN matched and not verbose, be silent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ematch</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_verbose</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;isdn_net: call from %s -&gt; %d %s ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">eaz</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">wret</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Search list of net-interfaces for an interface with given name.</span>
<span class="cm"> */</span>
<span class="n">isdn_net_dev</span> <span class="o">*</span>
<span class="nf">isdn_net_findif</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force a net-interface to dial out.</span>
<span class="cm"> * This is called from the userlevel-routine below or</span>
<span class="cm"> * from isdn_net_start_xmit().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_force_dial_lp</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CONNECTED</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chi</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ulong</span> <span class="n">flags</span><span class="p">;</span>

			<span class="cm">/* Grab a free ISDN-Channel */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">chi</span> <span class="o">=</span> <span class="n">isdn_get_free_channel</span><span class="p">(</span>
				     <span class="n">ISDN_USAGE_NET</span><span class="p">,</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">,</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">,</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">,</span>
				     <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net_force_dial: No channel for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Connect interface with channel */</span>
			<span class="n">isdn_net_bind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">,</span> <span class="n">chi</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ISDN_PPP</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isdn_ppp_bind</span><span class="p">(</span><span class="n">lp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">isdn_net_unbind_channel</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="cm">/* Initiate dialing */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">isdn_net_dial</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is called from certain upper protocol layers (multilink ppp</span>
<span class="cm"> * and x25iface encapsulation module) that want to initiate dialing</span>
<span class="cm"> * themselves.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_dial_req</span><span class="p">(</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* is there a better error code? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ISDN_NET_DIALMODE</span><span class="p">(</span><span class="o">*</span><span class="n">lp</span><span class="p">)</span> <span class="o">==</span> <span class="n">ISDN_NET_DM_AUTO</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">isdn_net_force_dial_lp</span><span class="p">(</span><span class="n">lp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force a net-interface to dial out.</span>
<span class="cm"> * This is always called from within userspace (ISDN_IOCTL_NET_DIAL).</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_force_dial</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">isdn_net_force_dial_lp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* The ISDN-specific entries in the device structure. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">isdn_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_init</span>	      <span class="o">=</span> <span class="n">isdn_net_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_open</span>	      <span class="o">=</span> <span class="n">isdn_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	      <span class="o">=</span> <span class="n">isdn_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>	      <span class="o">=</span> <span class="n">isdn_net_ioctl</span><span class="p">,</span>

	<span class="p">.</span><span class="n">ndo_start_xmit</span>	      <span class="o">=</span> <span class="n">isdn_net_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>	      <span class="o">=</span> <span class="n">isdn_net_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>	      <span class="o">=</span> <span class="n">isdn_net_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Helper for alloc_netdev()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_isdn_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ether_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Setup the generic properties */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_NOARP</span> <span class="o">|</span> <span class="n">IFF_POINTOPOINT</span><span class="p">;</span>

	<span class="cm">/* isdn prepends a header in the tx path, can&#39;t share skbs */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_TX_SKB_SHARING</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isdn_netdev_ops</span><span class="p">;</span>

	<span class="cm">/* for clients with MPPP maybe higher values better */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">=</span> <span class="n">ISDN_NET_ENCAP_RAWIP</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">ISDN_NET_MAGIC</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">lp</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">isdn_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">ppp_slot</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pppbind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">super_tx_queue</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L2_X75I</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span> <span class="o">=</span> <span class="n">ISDN_PROTO_L3_TRANS</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">triggercps</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">slavedelay</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">=</span> <span class="n">ISDN_INHUP</span><span class="p">;</span>	<span class="cm">/* Do hangup even on incoming calls */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">onhtime</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* Default hangup-time for saving costs */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialmax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Hangup before Callback, manual dial */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ISDN_NET_CBHUP</span> <span class="o">|</span> <span class="n">ISDN_NET_DM_MANUAL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cbdelay</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>	<span class="cm">/* Wait 5 secs before Callback */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Infinite Dial-Timeout */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span> <span class="cm">/* Wait 5 sec. after failed dial */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialstarted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* Jiffies of last dial-start */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Jiffies of earliest next dial-start */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a new network-interface and initialize its data structures.</span>
<span class="cm"> */</span>
<span class="kt">char</span> <span class="o">*</span>
<span class="nf">isdn_net_new</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>

	<span class="cm">/* Avoid creating an existing interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: interface %s already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">isdn_net_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: Could not allocate net-device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">isdn_net_local</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">_isdn_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: Could not allocate network device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Device shall be a slave */</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>

		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
		<span class="cm">/* Put device at end of slave-chain */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Device shall be a master */</span>
		<span class="cm">/*</span>
<span class="cm">		 * Watchdog timer (currently) for master only.</span>
<span class="cm">		 */</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">ISDN_NET_TX_TIMEOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: Could not register net-device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">queue</span> <span class="o">=</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">,</span> <span class="n">isdn_net_softint</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">xmit_lock</span><span class="p">);</span>

	<span class="cm">/* Put into to netdev-chain */</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span>
<span class="nf">isdn_net_newslave</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">newname</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Slave-Name MUST not be empty */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Master must already exist */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">parm</span><span class="p">)))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* Master must be a real interface, not a slave */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* Master must not be started yet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isdn_net_device_started</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">isdn_net_new</span><span class="p">(</span><span class="n">newname</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set interface-parameters.</span>
<span class="cm"> * Always set all parameters, so the user-level application is responsible</span>
<span class="cm"> * for not overwriting existing setups. It has to get the current</span>
<span class="cm"> * setup first, if only selected parameters are to be changed.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_setcfg</span><span class="p">(</span><span class="n">isdn_net_ioctl_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ulong</span> <span class="n">features</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">drvidx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chidx</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">drvid</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

		<span class="cm">/* See if any registered driver supports the features we want */</span>
		<span class="n">features</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_FEATURE_L2_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_FEATURE_L3_SHIFT</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_DRIVERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">features</span><span class="p">)</span> <span class="o">==</span> <span class="n">features</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ISDN_MAX_DRIVERS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;isdn_net: No driver with selected features</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">!=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
			<span class="k">struct</span> <span class="n">concap_proto</span> <span class="o">*</span><span class="n">cprot</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isdn_net_device_started</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: cannot change encap when if is up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cprot</span> <span class="o">&amp;&amp;</span> <span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="p">)</span>
				<span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">proto_del</span><span class="p">(</span><span class="n">cprot</span><span class="p">);</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">cprot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="cm">/* ... ,  prepare for configuration of new one ... */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_X25IFACE</span>:
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isdn_concap_reliable_dl_dops</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* ... and allocate new one ... */</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">cprot</span> <span class="o">=</span> <span class="n">isdn_concap_new</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">);</span>
			<span class="cm">/* p -&gt; cprot == NULL now if p_encap is not supported</span>
<span class="cm">			   by means of the concap_proto mechanism */</span>
			<span class="cm">/* the protocol is not configured yet; this will</span>
<span class="cm">			   happen later when isdn_net_reset() is called */</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_SYNCPPP</span>:
<span class="cp">#ifndef CONFIG_ISDN_PPP</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: SyncPPP support not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_PPP</span><span class="p">;</span>	<span class="cm">/* change ARP type */</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_X25IFACE</span>:
<span class="cp">#ifndef CONFIG_ISDN_X25</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: isdn-x25 support not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_X25</span><span class="p">;</span>	<span class="cm">/* change ARP type */</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_NET_ENCAP_CISCOHDLCK</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">&lt;=</span> <span class="n">ISDN_NET_ENCAP_MAX_ENCAP</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;%s: encapsulation protocol %d not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* A bind has been requested ... */</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				<span class="o">*</span><span class="n">e</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strnlen</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">))</span> <span class="o">==</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">drvidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">chidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">drvid</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">drvid</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* The channel-number is appended to the driver-Id with a comma */</span>
				<span class="n">chidx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">c</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="n">c</span><span class="p">)</span>
					<span class="n">chidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ISDN_MAX_DRIVERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="cm">/* Lookup driver-Id in array */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">drvid</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">drvidx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">drvidx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chidx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="cm">/* Either driver-Id or channel-number invalid */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Parameters are valid, so get them */</span>
			<span class="n">drvidx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">;</span>
			<span class="n">chidx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

			<span class="cm">/* If binding is exclusive, try to grab the channel */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">isdn_get_free_channel</span><span class="p">(</span><span class="n">ISDN_USAGE_NET</span><span class="p">,</span>
						       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">,</span> <span class="n">drvidx</span><span class="p">,</span>
						       <span class="n">chidx</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Grab failed, because desired channel is in use */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* All went ok, so update isdninfo */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ISDN_USAGE_EXCLUSIVE</span><span class="p">;</span>
			<span class="n">isdn_info_update</span><span class="p">();</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Non-exclusive binding or unbind. */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isdn_unexclusive_channel</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">);</span>
				<span class="n">isdn_free_channel</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">,</span> <span class="n">ISDN_USAGE_NET</span><span class="p">);</span>
				<span class="n">drvidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">chidx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">eaz</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">=</span> <span class="n">drvidx</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span> <span class="o">=</span> <span class="n">chidx</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">onhtime</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">onhtime</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">charge</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">charge</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cbdelay</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cbdelay</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialmax</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialmax</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">triggercps</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">triggercps</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">slavedelay</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">slavedelay</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pppbind</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pppbind</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialwait</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">secure</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDN_NET_SECURE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_NET_SECURE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cbhup</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDN_NET_CBHUP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_NET_CBHUP</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISDN_NET_CALLBACK</span> <span class="o">|</span> <span class="n">ISDN_NET_CBOUT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDN_NET_CALLBACK</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_NET_CBOUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDN_NET_CBOUT</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_NET_CALLBACK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_NET_DIALMODE_MASK</span><span class="p">;</span>	<span class="cm">/* first all bits off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialmode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialmode</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_DIALMODE_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* old isdnctrl version, where only 0 or 1 is given */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;Old isdnctrl version detected! Please update.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ISDN_NET_DM_OFF</span><span class="p">;</span> <span class="cm">/* turn on `off&#39; bit */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialmode</span><span class="p">;</span>  <span class="cm">/* turn on selected bits */</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">chargehup</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">|=</span> <span class="n">ISDN_CHARGEHUP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_CHARGEHUP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ihup</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">|=</span> <span class="n">ISDN_INHUP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISDN_INHUP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">chargeint</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">|=</span> <span class="n">ISDN_CHARGEHUP</span> <span class="o">|</span> <span class="n">ISDN_HAVECHARGE</span> <span class="o">|</span> <span class="n">ISDN_MANCHARGE</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargeint</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">chargeint</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_RAWIP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_NOARP</span> <span class="o">|</span> <span class="n">IFF_POINTOPOINT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isdn_header_ops</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">==</span> <span class="n">ISDN_NET_ENCAP_ETHER</span><span class="p">)</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_BROADCAST</span> <span class="o">|</span> <span class="n">IFF_MULTICAST</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_NOARP</span> <span class="o">|</span> <span class="n">IFF_POINTOPOINT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform get-interface-parameters.ioctl</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_getcfg</span><span class="p">(</span><span class="n">isdn_net_ioctl_cfg</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isdn_net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

		<span class="n">strcpy</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">eaz</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">msn</span><span class="p">);</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">exclusive</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">,</span> <span class="s">&quot;%s,%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">],</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">drvid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">onhtime</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">onhtime</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">charge</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">charge</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">l2_proto</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l2_proto</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">l3_proto</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">l3_proto</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">p_encap</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">p_encap</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">secure</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_SECURE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CALLBACK</span><span class="p">)</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CBOUT</span><span class="p">)</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cbhup</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_CBHUP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialmode</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ISDN_NET_DIALMODE_MASK</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">chargehup</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ihup</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">cbdelay</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cbdelay</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialmax</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialmax</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">triggercps</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">triggercps</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">slavedelay</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">slavedelay</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">chargeint</span> <span class="o">=</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hupflags</span> <span class="o">&amp;</span> <span class="n">ISDN_CHARGEHUP</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">chargeint</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">pppbind</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pppbind</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialtimeout</span> <span class="o">/</span> <span class="n">HZ</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">dialwait</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">dialwait</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">,</span> <span class="s">&quot;too-long&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="s">&quot;too-long&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add a phone-number to an interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_addphone</span><span class="p">(</span><span class="n">isdn_net_ioctl_phone</span> <span class="o">*</span><span class="n">phone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">phone</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">isdn_net_phone</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">isdn_net_phone</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">phone</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">));</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="n">phone</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="n">phone</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy a string of all phone-numbers of an interface to user space.</span>
<span class="cm"> * This might sleep and must be called with the isdn semaphore down.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_getphones</span><span class="p">(</span><span class="n">isdn_net_ioctl_phone</span> <span class="o">*</span><span class="n">phone</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">phones</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">phone</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">inout</span> <span class="o">=</span> <span class="n">phone</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">more</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isdn_net_phone</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">inout</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="n">inout</span><span class="p">];</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">more</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">put_user</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">phones</span><span class="o">++</span><span class="p">);</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">phones</span><span class="p">,</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phones</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
		<span class="n">more</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">phones</span><span class="p">);</span>
	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy a string containing the peer&#39;s phone number of a connected interface</span>
<span class="cm"> * to user space.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_getpeer</span><span class="p">(</span><span class="n">isdn_net_ioctl_phone</span> <span class="o">*</span><span class="n">phone</span><span class="p">,</span> <span class="n">isdn_net_ioctl_phone</span> <span class="n">__user</span> <span class="o">*</span><span class="n">peer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">phone</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Theoretical race: while this executes, the remote number might</span>
<span class="cm">	 * become invalid (hang up) or change (new connection), resulting</span>
<span class="cm">	 * in (partially) wrong number copied to user. This race</span>
<span class="cm">	 * currently ignored.</span>
<span class="cm">	 */</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">isdn_channel</span><span class="p">;</span>
	<span class="n">dv</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">isdn_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">isdn_dc2minor</span><span class="p">(</span><span class="n">dv</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="cm">/* for pre-bound channels, we need this extra check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s">&quot;???&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTCONN</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">phone</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ISDN_MSNLEN</span><span class="p">);</span>
	<span class="n">phone</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">=</span> <span class="n">USG_OUTGOING</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">usage</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">peer</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Delete a phone-number from an interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_delphone</span><span class="p">(</span><span class="n">isdn_net_ioctl_phone</span> <span class="o">*</span><span class="n">phone</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">phone</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">inout</span> <span class="o">=</span> <span class="n">phone</span><span class="o">-&gt;</span><span class="n">outgoing</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">isdn_net_phone</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">isdn_net_phone</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="n">inout</span><span class="p">];</span>
		<span class="n">m</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">phone</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dial</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dial</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span>
					<span class="n">m</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="n">inout</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_phone</span> <span class="o">*</span><span class="p">)</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Delete all phone-numbers of an interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_rmallphone</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_phone</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="n">isdn_net_phone</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">m</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">phone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dial</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Force a hangup of a network-interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_force_hangup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">isdn_net_findif</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">isdn_device</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
		<span class="cm">/* If this interface has slaves, do a hangup for them also. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="n">q</span> <span class="o">=</span> <span class="n">MASTER_TO_SLAVE</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">isdn_net_hangup</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Helper-function for isdn_net_rm: Do the real work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">isdn_net_realrm</span><span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isdn_net_device_started</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ISDN_X25</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cprot</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="o">-&gt;</span><span class="n">pops</span><span class="o">-&gt;</span><span class="n">proto_del</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">cprot</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Free all phone-entries */</span>
	<span class="n">isdn_net_rmallphone</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="cm">/* If interface is bound exclusive, free channel-usage */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">isdn_unexclusive_channel</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pre_device</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pre_channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It&#39;s a slave-device, so update master&#39;s slave-pointer if necessary */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span> <span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">==</span>
		    <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="p">((</span><span class="n">isdn_net_local</span> <span class="o">*</span><span class="p">)</span><span class="n">ISDN_MASTER_PRIV</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">slave</span> <span class="o">=</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Unregister only if it&#39;s a master-device */</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Unlink device from chain */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">)</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If this interface has a slave, remove it also */</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">slavename</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
		<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">slavename</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">isdn_net_realrm</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">q</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* If no more net-devices remain, disable auto-hangup timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_NETHANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove a single network-interface.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_rm</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">isdn_net_dev</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="cm">/* Search name in netdev-chain */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">isdn_net_realrm</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">q</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">isdn_net_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* If no more net-devices remain, disable auto-hangup timer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">isdn_timer_ctrl</span><span class="p">(</span><span class="n">ISDN_TIMER_NETHANGUP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove all network-interfaces</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">isdn_net_rmall</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Walk through netdev-chain */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Remove master-devices only, slaves get removed with their master */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">isdn_net_realrm</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
