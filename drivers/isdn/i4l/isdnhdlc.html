<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › i4l › isdnhdlc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isdnhdlc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * isdnhdlc.c  --  General purpose ISDN HDLC decoder.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C)</span>
<span class="cm"> *	2009	Karsten Keil		&lt;keil@b1-systems.de&gt;</span>
<span class="cm"> *	2002	Wolfgang Mües		&lt;wolfgang@iksw-muees.de&gt;</span>
<span class="cm"> *	2001	Frode Isaksen		&lt;fisaksen@bewan.com&gt;</span>
<span class="cm"> *      2001	Kai Germaschewski	&lt;kai.germaschewski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/crc-ccitt.h&gt;</span>
<span class="cp">#include &lt;linux/isdn/hdlc.h&gt;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>

<span class="cm">/*-------------------------------------------------------------------*/</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Wolfgang Mües &lt;wolfgang@iksw-muees.de&gt;, &quot;</span>
	      <span class="s">&quot;Frode Isaksen &lt;fisaksen@bewan.com&gt;, &quot;</span>
	      <span class="s">&quot;Kai Germaschewski &lt;kai.germaschewski@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;General purpose ISDN HDLC decoder&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*-------------------------------------------------------------------*/</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HDLC_FAST_IDLE</span><span class="p">,</span> <span class="n">HDLC_GET_FLAG_B0</span><span class="p">,</span> <span class="n">HDLC_GETFLAG_B1A6</span><span class="p">,</span> <span class="n">HDLC_GETFLAG_B7</span><span class="p">,</span>
	<span class="n">HDLC_GET_DATA</span><span class="p">,</span> <span class="n">HDLC_FAST_FLAG</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">HDLC_SEND_DATA</span><span class="p">,</span> <span class="n">HDLC_SEND_CRC1</span><span class="p">,</span> <span class="n">HDLC_SEND_FAST_FLAG</span><span class="p">,</span>
	<span class="n">HDLC_SEND_FIRST_FLAG</span><span class="p">,</span> <span class="n">HDLC_SEND_CRC2</span><span class="p">,</span> <span class="n">HDLC_SEND_CLOSING_FLAG</span><span class="p">,</span>
	<span class="n">HDLC_SEND_IDLE1</span><span class="p">,</span> <span class="n">HDLC_SEND_FAST_IDLE</span><span class="p">,</span> <span class="n">HDLC_SENDFLAG_B0</span><span class="p">,</span>
	<span class="n">HDLC_SENDFLAG_B1A6</span><span class="p">,</span> <span class="n">HDLC_SENDFLAG_B7</span><span class="p">,</span> <span class="n">STOPPED</span><span class="p">,</span> <span class="n">HDLC_SENDFLAG_ONE</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">isdnhdlc_rcv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdnhdlc_vars</span><span class="p">));</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GET_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HDLC_56KBIT</span><span class="p">)</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HDLC_BITREVERSE</span><span class="p">)</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_bitreverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">isdnhdlc_out_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">isdnhdlc_out_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdnhdlc_vars</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HDLC_DCHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dchannel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_FIRST_FLAG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dchannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_FAST_FLAG</span><span class="p">;</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffvalue</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HDLC_56KBIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SENDFLAG_B0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">HDLC_BITREVERSE</span><span class="p">)</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_bitreverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">isdnhdlc_rcv_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dstpos</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* too small - framing error */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">HDLC_FRAMING_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">!=</span> <span class="mh">0xf0b8</span><span class="p">)</span>	<span class="cm">/* crc error */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">HDLC_CRC_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* remove CRC */</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dstpos</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* good frame */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dstpos</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  isdnhdlc_decode - decodes HDLC frames from a transparent bit stream.</span>

<span class="cm">  The source buffer is scanned for valid HDLC frames looking for</span>
<span class="cm">  flags (01111110) to indicate the start of a frame. If the start of</span>
<span class="cm">  the frame is found, the bit stuffing is removed (0 after 5 1&#39;s).</span>
<span class="cm">  When a new flag is found, the complete frame has been received</span>
<span class="cm">  and the CRC is checked.</span>
<span class="cm">  If a valid frame is found, the function returns the frame length</span>
<span class="cm">  excluding the CRC with the bit HDLC_END_OF_FRAME set.</span>
<span class="cm">  If the beginning of a valid frame is found, the function returns</span>
<span class="cm">  the length.</span>
<span class="cm">  If a framing error is found (too many 1s and not a flag) the function</span>
<span class="cm">  returns the length with the bit HDLC_FRAMING_ERROR set.</span>
<span class="cm">  If a CRC error is found the function returns the length with the</span>
<span class="cm">  bit HDLC_CRC_ERROR set.</span>
<span class="cm">  If the frame length exceeds the destination buffer size, the function</span>
<span class="cm">  returns the length with the bit HDLC_LENGTH_ERROR set.</span>

<span class="cm">  src - source buffer</span>
<span class="cm">  slen - source buffer length</span>
<span class="cm">  count - number of bytes removed (decoded) from the source buffer</span>
<span class="cm">  dst _ destination buffer</span>
<span class="cm">  dsize - destination buffer size</span>
<span class="cm">  returns - number of decoded bytes in the destination buffer and status</span>
<span class="cm">  flag.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">isdnhdlc_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slen</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fast_flag</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x3f</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fast_flag_value</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x3f</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fast_abort</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xff</span>
	<span class="p">};</span>

<span class="cp">#define handle_fast_flag(h)						\</span>
<span class="cp">	do {								\</span>
<span class="cp">		if (h-&gt;cbin == fast_flag[h-&gt;bit_shift]) {		\</span>
<span class="cp">			h-&gt;ffvalue = fast_flag_value[h-&gt;bit_shift];	\</span>
<span class="cp">			h-&gt;state = HDLC_FAST_FLAG;			\</span>
<span class="cp">			h-&gt;ffbit_shift = h-&gt;bit_shift;			\</span>
<span class="cp">			h-&gt;bit_shift = 1;				\</span>
<span class="cp">		} else {						\</span>
<span class="cp">			h-&gt;state = HDLC_GET_DATA;			\</span>
<span class="cp">			h-&gt;data_received = 0;				\</span>
<span class="cp">		}							\</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define handle_abort(h)						\</span>
<span class="cp">	do {							\</span>
<span class="cp">		h-&gt;shift_reg = fast_abort[h-&gt;ffbit_shift - 1];	\</span>
<span class="cp">		h-&gt;hdlc_bits1 = h-&gt;ffbit_shift - 2;		\</span>
<span class="cp">		if (h-&gt;hdlc_bits1 &lt; 0)				\</span>
<span class="cp">			h-&gt;hdlc_bits1 = 0;			\</span>
<span class="cp">		h-&gt;data_bits = h-&gt;ffbit_shift - 1;		\</span>
<span class="cp">		h-&gt;state = HDLC_GET_DATA;			\</span>
<span class="cp">		h-&gt;data_received = 0;				\</span>
<span class="cp">	} while (0)</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">slen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the code is for bitreverse streams */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_bitreverse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
			<span class="n">slen</span><span class="o">--</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span><span class="p">)</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STOPPED</span>:
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_FAST_IDLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GET_FLAG_B0</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_GET_FLAG_B0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GETFLAG_B1A6</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="o">++</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_FAST_IDLE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_GETFLAG_B1A6</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GETFLAG_B7</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_GETFLAG_B7</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GET_FLAG_B0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GET_DATA</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_GET_DATA</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span><span class="o">++</span><span class="p">;</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">6</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">7</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span><span class="p">)</span>
						<span class="cm">/* bad frame */</span>
						<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">HDLC_FRAMING_ERROR</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">==</span> <span class="n">fast_abort</span>
						    <span class="p">[</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
							<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span>
								<span class="n">HDLC_FAST_IDLE</span><span class="p">;</span>
							<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GET_FLAG_B0</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">5</span>:
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">6</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span><span class="p">)</span>
						<span class="n">status</span> <span class="o">=</span> <span class="n">check_frame</span><span class="p">(</span><span class="n">hdlc</span><span class="p">);</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span><span class="p">)</span>
						<span class="n">handle_fast_flag</span><span class="p">(</span><span class="n">hdlc</span><span class="p">);</span>
					<span class="k">else</span> <span class="p">{</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GET_DATA</span><span class="p">;</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dstpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">count</span> <span class="o">-=</span> <span class="n">slen</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="n">crc_ccitt_byte</span><span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">,</span>
							   <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span><span class="p">);</span>

				<span class="cm">/* good byte received */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dstpos</span> <span class="o">&lt;</span> <span class="n">dsize</span><span class="p">)</span>
					<span class="n">dst</span><span class="p">[</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dstpos</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* frame too long */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">HDLC_LENGTH_ERROR</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dstpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_FAST_FLAG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">==</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffvalue</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_FAST_IDLE</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffbit_shift</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_GETFLAG_B7</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">handle_abort</span><span class="p">(</span><span class="n">hdlc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">count</span> <span class="o">-=</span> <span class="n">slen</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">isdnhdlc_decode</span><span class="p">);</span>
<span class="cm">/*</span>
<span class="cm">  isdnhdlc_encode - encodes HDLC frames to a transparent bit stream.</span>

<span class="cm">  The bit stream starts with a beginning flag (01111110). After</span>
<span class="cm">  that each byte is added to the bit stream with bit stuffing added</span>
<span class="cm">  (0 after 5 1&#39;s).</span>
<span class="cm">  When the last byte has been removed from the source buffer, the</span>
<span class="cm">  CRC (2 bytes is added) and the frame terminates with the ending flag.</span>
<span class="cm">  For the dchannel, the idle character (all 1&#39;s) is also added at the end.</span>
<span class="cm">  If this function is called with empty source buffer (slen=0), flags or</span>
<span class="cm">  idle character will be generated.</span>

<span class="cm">  src - source buffer</span>
<span class="cm">  slen - source buffer length</span>
<span class="cm">  count - number of bytes removed (encoded) from source buffer</span>
<span class="cm">  dst _ destination buffer</span>
<span class="cm">  dsize - destination buffer size</span>
<span class="cm">  returns - number of encoded bytes in the destination buffer</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">isdnhdlc_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">isdnhdlc_vars</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u16</span> <span class="n">slen</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xfast_flag_value</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x7e</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">slen</span><span class="p">;</span>

	<span class="cm">/* special handling for one byte frames */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HDLC_SEND_FAST_FLAG</span><span class="p">))</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SENDFLAG_ONE</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_closing</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
				<span class="n">slen</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="cm">/* closing sequence, CRC + flag(s) */</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">HDLC_SEND_DATA</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_CRC1</span><span class="p">;</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">^=</span> <span class="mh">0xffff</span><span class="p">;</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">=</span>
							<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span><span class="p">)</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span>
							<span class="n">HDLC_SEND_FAST_FLAG</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span>
							<span class="n">HDLC_SENDFLAG_B0</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STOPPED</span>:
			<span class="k">while</span> <span class="p">(</span><span class="n">dsize</span><span class="o">--</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">dsize</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_FAST_FLAG</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* the code is for bitreverse streams */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_bitreverse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffvalue</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffvalue</span><span class="p">;</span>
				<span class="n">len</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dsize</span><span class="o">--</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">HDLC_SENDFLAG_ONE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">=</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffvalue</span> <span class="o">&gt;&gt;</span>
					<span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="p">);</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_DATA</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SENDFLAG_B0</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SENDFLAG_B1A6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SENDFLAG_B1A6</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SENDFLAG_B7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SENDFLAG_B7</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SENDFLAG_B0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_DATA</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_FIRST_FLAG</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_DATA</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_DATA</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_DATA</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="n">crc_ccitt_byte</span><span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">,</span>
							   <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_CRC1</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_CRC2</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_CRC2</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_CLOSING_FLAG</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_CLOSING_FLAG</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">hdlc_bits1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffvalue</span> <span class="o">=</span>
					<span class="n">xfast_flag_value</span><span class="p">[</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">dchannel</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">ffvalue</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_IDLE1</span><span class="p">;</span>
					<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">8</span><span class="o">-</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span>
							<span class="n">HDLC_SEND_FAST_IDLE</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span>
							<span class="n">HDLC_SEND_FAST_FLAG</span><span class="p">;</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SENDFLAG_B0</span><span class="p">;</span>
						<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* Finished this frame, send flags */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsize</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">dsize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_IDLE1</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_FAST_IDLE</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDLC_SEND_FAST_IDLE</span>:
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">HDLC_SEND_FIRST_FLAG</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* the code is for bitreverse streams */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_bitreverse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">bit_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">len</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_adapt56</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the code is for bitreverse streams */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">do_bitreverse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">cbin</span><span class="p">;</span>
			<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">data_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dsize</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">count</span> <span class="o">-=</span> <span class="n">slen</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">isdnhdlc_encode</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
