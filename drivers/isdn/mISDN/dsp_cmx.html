<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › mISDN › dsp_cmx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dsp_cmx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Audio crossconnecting/conferrencing (hardware level).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2002 by Andreas Eversberg (jolly@eversberg.eu)</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms</span>
<span class="cm"> * of the GNU General Public License, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The process of adding and removing parties to/from a conference:</span>
<span class="cm"> *</span>
<span class="cm"> * There is a chain of struct dsp_conf which has one or more members in a chain</span>
<span class="cm"> * of struct dsp_conf_member.</span>
<span class="cm"> *</span>
<span class="cm"> * After a party is added, the conference is checked for hardware capability.</span>
<span class="cm"> * Also if a party is removed, the conference is checked again.</span>
<span class="cm"> *</span>
<span class="cm"> * There are 3 different solutions: -1 = software, 0 = hardware-crossconnect</span>
<span class="cm"> * 1-n = hardware-conference. The n will give the conference number.</span>
<span class="cm"> *</span>
<span class="cm"> * Depending on the change after removal or insertion of a party, hardware</span>
<span class="cm"> * commands are given.</span>
<span class="cm"> *</span>
<span class="cm"> * The current solution is stored within the struct dsp_conf entry.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * HOW THE CMX WORKS:</span>
<span class="cm"> *</span>
<span class="cm"> * There are 3 types of interaction: One member is alone, in this case only</span>
<span class="cm"> * data flow from upper to lower layer is done.</span>
<span class="cm"> * Two members will also exchange their data so they are crossconnected.</span>
<span class="cm"> * Three or more members will be added in a conference and will hear each</span>
<span class="cm"> * other but will not receive their own speech (echo) if not enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * Features of CMX are:</span>
<span class="cm"> *  - Crossconnecting or even conference, if more than two members are together.</span>
<span class="cm"> *  - Force mixing of transmit data with other crossconnect/conference members.</span>
<span class="cm"> *  - Echo generation to benchmark the delay of audio processing.</span>
<span class="cm"> *  - Use hardware to minimize cpu load, disable FIFO load and minimize delay.</span>
<span class="cm"> *  - Dejittering and clock generation.</span>
<span class="cm"> *</span>
<span class="cm"> * There are 2 buffers:</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * RX-Buffer</span>
<span class="cm"> *                 R             W</span>
<span class="cm"> *                 |             |</span>
<span class="cm"> * ----------------+-------------+-------------------</span>
<span class="cm"> *</span>
<span class="cm"> * The rx-buffer is a ring buffer used to store the received data for each</span>
<span class="cm"> * individual member. This is only the case if data needs to be dejittered</span>
<span class="cm"> * or in case of a conference where different clocks require reclocking.</span>
<span class="cm"> * The transmit-clock (R) will read the buffer.</span>
<span class="cm"> * If the clock overruns the write-pointer, we will have a buffer underrun.</span>
<span class="cm"> * If the write pointer always has a certain distance from the transmit-</span>
<span class="cm"> * clock, we will have a delay. The delay will dynamically be increased and</span>
<span class="cm"> * reduced.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * TX-Buffer</span>
<span class="cm"> *                  R        W</span>
<span class="cm"> *                  |        |</span>
<span class="cm"> * -----------------+--------+-----------------------</span>
<span class="cm"> *</span>
<span class="cm"> * The tx-buffer is a ring buffer to queue the transmit data from user space</span>
<span class="cm"> * until it will be mixed or sent. There are two pointers, R and W. If the write</span>
<span class="cm"> * pointer W would reach or overrun R, the buffer would overrun. In this case</span>
<span class="cm"> * (some) data is dropped so that it will not overrun.</span>
<span class="cm"> * Additionally a dynamic dejittering can be enabled. this allows data from</span>
<span class="cm"> * user space that have jitter and different clock source.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Clock:</span>
<span class="cm"> *</span>
<span class="cm"> * A Clock is not required, if the data source has exactly one clock. In this</span>
<span class="cm"> * case the data source is forwarded to the destination.</span>
<span class="cm"> *</span>
<span class="cm"> * A Clock is required, because the data source</span>
<span class="cm"> *  - has multiple clocks.</span>
<span class="cm"> *  - has no usable clock due to jitter or packet loss (VoIP).</span>
<span class="cm"> * In this case the system&#39;s clock is used. The clock resolution depends on</span>
<span class="cm"> * the jiffie resolution.</span>
<span class="cm"> *</span>
<span class="cm"> * If a member joins a conference:</span>
<span class="cm"> *</span>
<span class="cm"> * - If a member joins, its rx_buff is set to silence and change read pointer</span>
<span class="cm"> *   to transmit clock.</span>
<span class="cm"> *</span>
<span class="cm"> * The procedure of received data from card is explained in cmx_receive.</span>
<span class="cm"> * The procedure of received data from user space is explained in cmx_transmit.</span>
<span class="cm"> * The procedure of transmit data to card is cmx_send.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Interaction with other features:</span>
<span class="cm"> *</span>
<span class="cm"> * DTMF:</span>
<span class="cm"> * DTMF decoding is done before the data is crossconnected.</span>
<span class="cm"> *</span>
<span class="cm"> * Volume change:</span>
<span class="cm"> * Changing rx-volume is done before the data is crossconnected. The tx-volume</span>
<span class="cm"> * must be changed whenever data is transmitted to the card by the cmx.</span>
<span class="cm"> *</span>
<span class="cm"> * Tones:</span>
<span class="cm"> * If a tone is enabled, it will be processed whenever data is transmitted to</span>
<span class="cm"> * the card. It will replace the tx-data from the user space.</span>
<span class="cm"> * If tones are generated by hardware, this conference member is removed for</span>
<span class="cm"> * this time.</span>
<span class="cm"> *</span>
<span class="cm"> * Disable rx-data:</span>
<span class="cm"> * If cmx is realized in hardware, rx data will be disabled if requested by</span>
<span class="cm"> * the upper layer. If dtmf decoding is done by software and enabled, rx data</span>
<span class="cm"> * will not be disabled but blocked to the upper layer.</span>
<span class="cm"> *</span>
<span class="cm"> * HFC conference engine:</span>
<span class="cm"> * If it is possible to realize all features using hardware, hardware will be</span>
<span class="cm"> * used if not forbidden by control command. Disabling rx-data provides</span>
<span class="cm"> * absolutely traffic free audio processing. (except for the quick 1-frame</span>
<span class="cm"> * upload of a tone loop, only once for a new tone)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* delay.h is required for hw_lock.h */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNif.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNdsp.h&gt;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;dsp.h&quot;</span>
<span class="cm">/*</span>
<span class="cm"> * debugging of multi party conference,</span>
<span class="cm"> * by using conference even with two members</span>
<span class="cm"> */</span>

<span class="cm">/* #define CMX_CONF_DEBUG */</span>

<span class="cm">/*#define CMX_DEBUG * massive read/write pointer output */</span>
<span class="cm">/*#define CMX_DELAY_DEBUG * gives rx-buffer delay overview */</span>
<span class="cm">/*#define CMX_TX_DEBUG * massive read/write on tx-buffer with content */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">count_list_member</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="o">*</span><span class="n">m</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debug cmx memory structure</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">dsp_cmx_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf</span>	<span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_conf_member</span>	<span class="o">*</span><span class="n">member</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp</span>		<span class="o">*</span><span class="n">odsp</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;-----Current DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">odsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;* %s hardecho=%d softecho=%d txmix=%d&quot;</span><span class="p">,</span>
		       <span class="n">odsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">odsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span><span class="p">,</span> <span class="n">odsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span><span class="p">,</span>
		       <span class="n">odsp</span><span class="o">-&gt;</span><span class="n">tx_mix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">odsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (Conf %d)&quot;</span><span class="p">,</span> <span class="n">odsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span> <span class="o">==</span> <span class="n">odsp</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; *this*&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;-----Current Conf:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;* Conf %d (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;  - member = %s (slot_tx %d, bank_tx %d, &quot;</span>
			       <span class="s">&quot;slot_rx %d, bank_rx %d hfc_conf %d &quot;</span>
			       <span class="s">&quot;tx_data %d rx_is_off %d)%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span>
			       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">,</span>
			       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span><span class="p">,</span>
			       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_is_off</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">==</span> <span class="n">dsp</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; *this*&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;-----end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * search conference</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span>
<span class="nf">dsp_cmx_search_conf</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: conference ID is 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* search conference */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">conf</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * add member to conference</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dsp_cmx_add_conf_member</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf_member</span> <span class="o">*</span><span class="n">member</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span> <span class="o">||</span> <span class="o">!</span><span class="n">dsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: conf or dsp is 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">member</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dsp is already member in a conf.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dsp is already in a conf.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">member</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">member</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;kzalloc struct dsp_conf_member failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">dsp</span><span class="p">;</span>
	<span class="cm">/* clear rx buffer */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span> <span class="n">dsp_silence</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">));</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* rx_W and rx_R will be adjusted on first frame */</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">);</span>

	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">member</span> <span class="o">=</span> <span class="n">member</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * del member from conference</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">dsp_cmx_del_conf_member</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf_member</span> <span class="o">*</span><span class="n">member</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dsp is 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dsp is not in a conf.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dsp has linked an empty conf.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find us in conf */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">==</span> <span class="n">dsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">member</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">member</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
	       <span class="s">&quot;%s: dsp is not present in its own conf_meber list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * new conference</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dsp_conf</span>
<span class="o">*</span><span class="nf">dsp_cmx_new_conf</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: id is 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_conf</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;kzalloc struct dsp_conf failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">);</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_ilist</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">conf</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * del conference</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">dsp_cmx_del_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: conf is null.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: conf not empty.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * send HW message to hfc card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dsp_cmx_hw_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">message</span><span class="p">,</span> <span class="n">u32</span> <span class="n">param1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">param2</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">param3</span><span class="p">,</span> <span class="n">u32</span> <span class="n">param4</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="n">cq</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cq</span><span class="p">));</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">param1</span> <span class="o">|</span> <span class="p">(</span><span class="n">param2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">param3</span> <span class="o">|</span> <span class="p">(</span><span class="n">param4</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">)</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">CONTROL_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * do hardware update and set the software/hardware flag</span>
<span class="cm"> *</span>
<span class="cm"> * either a conference or a dsp instance can be given</span>
<span class="cm"> * if only dsp instance is given, the instance is not associated with a conf</span>
<span class="cm"> * and therefore removed. if a conference is given, the dsp is expected to</span>
<span class="cm"> * be member of that conference.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">dsp_cmx_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf_member</span>	<span class="o">*</span><span class="n">member</span><span class="p">,</span> <span class="o">*</span><span class="n">nextm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp</span>		<span class="o">*</span><span class="n">finddsp</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">memb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">freeunits</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u_char</span>		<span class="n">freeslots</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">int</span>		<span class="n">same_hfc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">same_pcm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">current_conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="n">all_conf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tx_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* dsp gets updated (no conf) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s checking dsp %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="nl">one_member:</span>
		<span class="cm">/* remove HFC conference if enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s removing %s from HFC conf %d &quot;</span>
				       <span class="s">&quot;because dsp is split</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_CONF_SPLIT</span><span class="p">,</span>
					   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* process hw echo */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_banks</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* NO ECHO: remove PCM slot if assigned */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s removing %s from&quot;</span>
					       <span class="s">&quot; PCM slot %d (TX) %d (RX) because&quot;</span>
					       <span class="s">&quot; dsp is split (no echo)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">);</span>
				<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_DISC</span><span class="p">,</span>
						   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* echo is enabled, find out if we use soft or hardware */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* ECHO: already echo */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* ECHO: if slot already assigned */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">;</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 2 means loop */</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s refresh %s for echo using slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span><span class="p">,</span>
					   <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* ECHO: find slot */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">freeslots</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">));</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">finddsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">finddsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span> <span class="o">==</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">finddsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">finddsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
					<span class="n">freeslots</span><span class="p">[</span><span class="n">finddsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">finddsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">finddsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
					<span class="n">freeslots</span><span class="p">[</span><span class="n">finddsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ii</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_slots</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">freeslots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s no slot available for echo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* no more slots available */</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* assign free slot */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* loop */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s assign echo for %s using slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">);</span>
		<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span><span class="p">,</span>
				   <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* conf gets updated (all members) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s checking conference %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: conference whithout members</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">member</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">same_hfc</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">hfc_id</span><span class="p">;</span>
	<span class="n">same_pcm</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span><span class="p">;</span>
	<span class="cm">/* check all members in our conference */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check if member uses mixing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_mix</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;tx_mix is turned on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="nl">conf_software:</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dsp</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">;</span>
				<span class="cm">/* remove HFC conference if enabled */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
						       <span class="s">&quot;%s removing %s from HFC &quot;</span>
						       <span class="s">&quot;conf %d because not &quot;</span>
						       <span class="s">&quot;possible with hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">,</span>
						       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span><span class="p">);</span>
					<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span>
							   <span class="n">MISDN_CTRL_HFC_CONF_SPLIT</span><span class="p">,</span>
							   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* remove PCM slot if assigned */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span>
				    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s removing &quot;</span>
						       <span class="s">&quot;%s from PCM slot %d (TX)&quot;</span>
						       <span class="s">&quot; slot %d (RX) because not&quot;</span>
						       <span class="s">&quot; possible with hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">,</span>
						       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span>
						       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">);</span>
					<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span>
							   <span class="n">MISDN_CTRL_HFC_PCM_DISC</span><span class="p">,</span>
							   <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if member has echo turned on */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span> <span class="o">||</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;echo is turned on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if member has tx_mix turned on */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_mix</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;tx_mix is turned on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if member changes volume at an not suppoted level */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;tx_volume is changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_volume</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;rx_volume is changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if tx-data turned on */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s tx_data is turned on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">tx_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if pipeline exists */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">.</span><span class="n">inuse</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;pipeline exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if encryption is enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">bf_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s dsp %s cannot form a &quot;</span>
				       <span class="s">&quot;conf, because encryption is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if member is on a card with PCM support */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;dsp has no PCM bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check if relations are on the same PCM bus */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span> <span class="o">!=</span> <span class="n">same_pcm</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s dsp %s cannot form a conf, because &quot;</span>
				       <span class="s">&quot;dsp is on a different PCM bus than the &quot;</span>
				       <span class="s">&quot;first dsp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* determine if members are on the same hfc chip */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">same_hfc</span> <span class="o">!=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">hfc_id</span><span class="p">)</span>
			<span class="n">same_hfc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* if there are members already in a conference */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_conf</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">current_conf</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span><span class="p">;</span>
		<span class="cm">/* if any member is not in a conference */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">all_conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memb</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if no member, this is an error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memb</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* one member */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s conf %d cannot form a HW conference, &quot;</span>
			       <span class="s">&quot;because dsp is alone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">member</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span>
				    <span class="n">list</span><span class="p">);</span>
		<span class="n">dsp</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">one_member</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ok, now we are sure that all members are on the same pcm.</span>
<span class="cm">	 * now we will see if we have only two members, so we can do</span>
<span class="cm">	 * crossconnections, which don&#39;t have any limitations.</span>
<span class="cm">	 */</span>

	<span class="cm">/* if we have only two members */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memb</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">member</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span>
				    <span class="n">list</span><span class="p">);</span>
		<span class="n">nextm</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span>
				   <span class="n">list</span><span class="p">);</span>
		<span class="cm">/* remove HFC conference if enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s removing %s from HFC conf %d because &quot;</span>
				       <span class="s">&quot;two parties require only a PCM slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span>
					   <span class="n">MISDN_CTRL_HFC_CONF_SPLIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s removing %s from HFC conf %d because &quot;</span>
				       <span class="s">&quot;two parties require only a PCM slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span>
					   <span class="n">MISDN_CTRL_HFC_CONF_SPLIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* if members have two banks (and not on the same chip) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_banks</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_banks</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">hfc_id</span> <span class="o">!=</span>
		    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">hfc_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if both members have same slots with crossed banks */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">==</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">==</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">==</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">!=</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">!=</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* all members have same slot */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s dsp %s &amp; %s stay joined on &quot;</span>
					       <span class="s">&quot;PCM slot %d bank %d (TX) bank %d &quot;</span>
					       <span class="s">&quot;(RX) (on different chips)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span><span class="p">);</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* find a new slot */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">freeslots</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">));</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span> <span class="o">!=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dsp</span> <span class="o">!=</span> <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">&amp;&amp;</span>
				    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span> <span class="o">==</span>
				    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&lt;</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
						<span class="n">freeslots</span><span class="p">[</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&lt;</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
						<span class="n">freeslots</span><span class="p">[</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ii</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_slots</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">freeslots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s no slot available for &quot;</span>
					       <span class="s">&quot;%s &amp; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* no more slots available */</span>
				<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* assign free slot */</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s adding %s &amp; %s to new PCM slot %d &quot;</span>
				       <span class="s">&quot;(TX and RX on different chips) because &quot;</span>
				       <span class="s">&quot;both members have not same slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span><span class="p">,</span>
					   <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span><span class="p">,</span>
					   <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span><span class="p">,</span>
					   <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span> <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span><span class="p">,</span>
					   <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">,</span> <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
			<span class="cm">/* if members have one bank (or on the same chip) */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* if both members have different crossed slots */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">==</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">==</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">!=</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* all members have same slot */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s dsp %s &amp; %s stay joined on PCM &quot;</span>
					       <span class="s">&quot;slot %d (TX) %d (RX) on same chip &quot;</span>
					       <span class="s">&quot;or one bank PCM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">);</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* find two new slot */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">freeslots</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">));</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span> <span class="o">!=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dsp</span> <span class="o">!=</span> <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">&amp;&amp;</span>
				    <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span> <span class="o">==</span>
				    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&lt;</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
						<span class="n">freeslots</span><span class="p">[</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&lt;</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
						<span class="n">freeslots</span><span class="p">[</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">i1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ii</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_slots</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i1</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">freeslots</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">i1</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i1</span> <span class="o">==</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s no slot available &quot;</span>
					       <span class="s">&quot;for %s &amp; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* no more slots available */</span>
				<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">i2</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i2</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">freeslots</span><span class="p">[</span><span class="n">i2</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">i2</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2</span> <span class="o">==</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s no slot available &quot;</span>
					       <span class="s">&quot;for %s &amp; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span>
					       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="cm">/* no more slots available */</span>
				<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* assign free slots */</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="n">i1</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="n">i2</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="n">i2</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="n">i1</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s adding %s &amp; %s to new PCM slot %d &quot;</span>
				       <span class="s">&quot;(TX) %d (RX) on same chip or one bank &quot;</span>
				       <span class="s">&quot;PCM, because both members have not &quot;</span>
				       <span class="s">&quot;crossed slots</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span><span class="p">,</span>
					   <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span><span class="p">,</span>
					   <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">,</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span><span class="p">,</span>
					   <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">,</span> <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span><span class="p">,</span>
					   <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">,</span> <span class="n">nextm</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we have more than two, we may check if we have a conference</span>
<span class="cm">	 * unit available on the chip. also all members must be on the same</span>
<span class="cm">	 */</span>

	<span class="cm">/* if not the same HFC chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">same_hfc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s conference %d cannot be formed, because &quot;</span>
			       <span class="s">&quot;members are on different chips or not &quot;</span>
			       <span class="s">&quot;on HFC chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* for more than two members.. */</span>

	<span class="cm">/* if all members already have the same conference */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">all_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * if there is an existing conference, but not all members have joined</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_conf</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">join_members:</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if no conference engine on our chip, change to</span>
<span class="cm">			 * software */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">hfc_conf</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
			<span class="cm">/* in case of hdlc, change to software */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
			<span class="cm">/* join to current conference */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">==</span> <span class="n">current_conf</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* get a free timeslot first */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">freeslots</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">));</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * not checking current member, because</span>
<span class="cm">				 * slot will be overwritten.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span>
					<span class="n">dsp</span> <span class="o">!=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">&amp;&amp;</span>
					<span class="cm">/* dsp must be on the same PCM */</span>
					<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span> <span class="o">==</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* dsp must be on a slot */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">&lt;</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
						<span class="n">freeslots</span><span class="p">[</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">&lt;</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">freeslots</span><span class="p">))</span>
						<span class="n">freeslots</span><span class="p">[</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ii</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_slots</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">freeslots</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* no more slots available */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s conference %d cannot be formed,&quot;</span>
					       <span class="s">&quot; because no slot free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;%s changing dsp %s to HW conference &quot;</span>
				       <span class="s">&quot;%d slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				       <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">current_conf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="cm">/* assign free slot &amp; set PCM &amp; join conf */</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* loop */</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">=</span> <span class="n">current_conf</span><span class="p">;</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span> <span class="n">MISDN_CTRL_HFC_PCM_CONN</span><span class="p">,</span>
					   <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">dsp_cmx_hw_message</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span>
					   <span class="n">MISDN_CTRL_HFC_CONF_JOIN</span><span class="p">,</span> <span class="n">current_conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">=</span> <span class="n">tx_data</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * no member is in a conference yet, so we find a free one</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">freeunits</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freeunits</span><span class="p">));</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* dsp must be on the same chip */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">hfc_id</span> <span class="o">==</span> <span class="n">same_hfc</span> <span class="o">&amp;&amp;</span>
		    <span class="cm">/* dsp must have joined a HW conference */</span>
		    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="cm">/* slot must be within range */</span>
		    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">freeunits</span><span class="p">[</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freeunits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no more conferences available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;%s conference %d cannot be formed, because &quot;</span>
			       <span class="s">&quot;no conference number free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">conf_software</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* join all members */</span>
	<span class="n">current_conf</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">join_members</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * conf_id != 0: join or change conference</span>
<span class="cm"> * conf_id == 0: split from conference if not already</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">dsp_cmx_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">conf_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_conf_member</span>	<span class="o">*</span><span class="n">member</span><span class="p">;</span>

	<span class="cm">/* if conference doesn&#39;t change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf_id</span> <span class="o">==</span> <span class="n">conf_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first remove us from current conf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;removing us from conference %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="cm">/* remove us from conf */</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_cmx_del_conf_member</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* update hardware */</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>

		<span class="cm">/* conf now empty? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;conference is empty, so we remove it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_cmx_del_conf</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* update members left on conf */</span>
			<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if split */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf_id</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* now add us to conf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;searching conference %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">conf_id</span><span class="p">);</span>
	<span class="n">conf</span> <span class="o">=</span> <span class="n">dsp_cmx_search_conf</span><span class="p">(</span><span class="n">conf_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;conference doesn&#39;t exist yet, creating.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* the conference doesn&#39;t exist, so we create */</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">dsp_cmx_new_conf</span><span class="p">(</span><span class="n">conf_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">member</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span>
				    <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;cannot join transparent conference.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span> <span class="o">&amp;&amp;</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;cannot join hdlc conference.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* add conference member */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_cmx_add_conf_member</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf_id</span> <span class="o">=</span> <span class="n">conf_id</span><span class="p">;</span>

	<span class="cm">/* if we are alone, we do nothing! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;we are alone in this conference, so exit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* update hardware */</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update members on conf */</span>
	<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CMX_DELAY_DEBUG</span>
<span class="kt">int</span> <span class="n">delaycount</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">showdelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">samples</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">bar</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;--------------------------------------------------|&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sdelay</span><span class="p">;</span>

	<span class="n">delaycount</span> <span class="o">+=</span> <span class="n">samples</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delaycount</span> <span class="o">&lt;</span> <span class="mi">8000</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">delaycount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdelay</span> <span class="o">=</span> <span class="n">delay</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">/</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;DELAY (%s) %3d &gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span>
	       <span class="n">sdelay</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="o">?</span> <span class="s">&quot;...&quot;</span> <span class="o">:</span> <span class="n">bar</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">sdelay</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * audio data is received from card</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">dsp_cmx_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span> <span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ii</span><span class="p">;</span>

	<span class="cm">/* check if we have sompen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* half of the buffer should be larger than maximum packet size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">CMX_BUFF_HALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;%s line %d: packet from card is too large (%d bytes). &quot;</span>
		       <span class="s">&quot;please make card send smaller packets OR increase &quot;</span>
		       <span class="s">&quot;CMX_BUFF_SIZE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize pointers if not already -</span>
<span class="cm">	 * also add delay if requested by PH_SIGNAL</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">unordered</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">+</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">+</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span>
					<span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="n">dsp_poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* if frame contains time code, write directly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">unordered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">);</span>
		<span class="cm">/* printk(KERN_DEBUG &quot;%s %08x\n&quot;, dsp-&gt;name, hh-&gt;id); */</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * if we underrun (or maybe overrun),</span>
<span class="cm">	 * we set our new read pointer, and write silence to buffer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span><span class="o">-</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CMX_BUFF_HALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CLOCK</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;cmx_receive(dsp=%lx): UNDERRUN (or overrun the &quot;</span>
			       <span class="s">&quot;maximum delay), adjusting read pointer! &quot;</span>
			       <span class="s">&quot;(inst %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* flush rx buffer and set delay to dsp_poll / 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">unordered</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">+</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">+</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span>
					<span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="n">dsp_poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span> <span class="n">dsp_silence</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* if we have reached double delay, jump back to middle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">-</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">)</span> <span class="o">&gt;=</span>
		    <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CLOCK</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
				       <span class="s">&quot;cmx_receive(dsp=%lx): OVERRUN (because &quot;</span>
				       <span class="s">&quot;twice the delay is reached), adjusting &quot;</span>
				       <span class="s">&quot;read pointer! (inst %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* flush buffer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">unordered</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">);</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">+</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span> <span class="n">dsp_silence</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">));</span>
		<span class="p">}</span>

	<span class="cm">/* show where to write */</span>
<span class="cp">#ifdef CMX_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;cmx_receive(dsp=%lx): rx_R(dsp)=%05x rx_W(dsp)=%05x len=%d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dsp</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* write data into rx_buffer */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ii</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ii</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span><span class="p">[</span><span class="n">w</span><span class="o">++</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* increase write-pointer */</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="p">((</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">);</span>
<span class="cp">#ifdef CMX_DELAY_DEBUG</span>
	<span class="n">showdelay</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span><span class="o">-</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * send (mixed) audio data to card and control jitter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dsp_cmx_send_member</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">members</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">member</span><span class="p">,</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="k">register</span> <span class="n">s32</span> <span class="n">sample</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="o">*</span><span class="n">o_q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">,</span> <span class="o">*</span><span class="n">txskb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">o_r</span><span class="p">,</span> <span class="n">o_rr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">preload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span> <span class="o">*</span><span class="n">hh</span><span class="p">,</span> <span class="o">*</span><span class="n">thh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_data_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* don&#39;t process if: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* if not active */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span><span class="p">)</span> <span class="o">||</span> <span class="cm">/* hardware conf */</span>
	     <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="cm">/* OR hardware echo */</span>
	    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span> <span class="o">==</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_W</span> <span class="o">&amp;&amp;</span> <span class="cm">/* AND no tx-data */</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tone</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">software</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* AND not soft tones */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* no tx_data for user space required */</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span><span class="p">)</span>
			<span class="n">tx_data_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span><span class="p">)</span>
			<span class="n">tx_data_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CMX_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;SEND members=%d dsp=%s, conf=%p, rx_R=%05x rx_W=%05x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">members</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* preload if we have delay set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">preload</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">preload</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
			<span class="n">preload</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PREPARE RESULT */</span>
	<span class="n">nskb</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">preload</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;FATAL ERROR in mISDN_dsp.o: cannot alloc %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">len</span> <span class="o">+</span> <span class="n">preload</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
	<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">PH_DATA_REQ</span><span class="p">;</span>
	<span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set pointers, indexes and stuff */</span>
	<span class="n">member</span> <span class="o">=</span> <span class="n">dsp</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">;</span> <span class="cm">/* transmit data */</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span> <span class="cm">/* received data */</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">preload</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span> <span class="cm">/* result */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span><span class="p">;</span> <span class="cm">/* tx-pointers */</span>
	<span class="n">tt</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_W</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">;</span> <span class="cm">/* rx-pointers */</span>
	<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>

	<span class="cm">/* preload with silence, if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">preload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dsp_silence</span><span class="p">,</span> <span class="n">preload</span><span class="p">);</span>
		<span class="n">d</span> <span class="o">+=</span> <span class="n">preload</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PROCESS TONES/TX-DATA ONLY */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tone</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* -&gt; copy tone */</span>
		<span class="n">dsp_tone_copy</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* clear tx buffer */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_W</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_packet</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if we have tx-data but do not use mixing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_mix</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* -&gt; send tx-data and continue when not enough */</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">debugbuf</span><span class="p">,</span> <span class="s">&quot;TX sending (%04x-%04x)%p: &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tt</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">debugbuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">)</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">debugbuf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">debugbuf</span><span class="p">),</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span>
					<span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]);</span>
<span class="cp">#endif</span>
			<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">];</span> <span class="cm">/* write tx_buff */</span>
			<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">debugbuf</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">goto</span> <span class="n">send_packet</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">debugbuf</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* PROCESS DATA (one member / no conf) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span> <span class="o">||</span> <span class="n">members</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* -&gt; if echo is NOT enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* -&gt; send tx-data if available or use 0-volume */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">];</span> <span class="cm">/* write tx_buff */</span>
				<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CLOCK</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">);</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">dsp_silence</span><span class="p">,</span> <span class="p">(</span><span class="n">rr</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* -&gt; if echo is enabled */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * -&gt; mix tx-data with echo if available,</span>
<span class="cm">			 * or use echo only</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_mix_law</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">]];</span>
				<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">];</span> <span class="cm">/* echo */</span>
				<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">send_packet</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* PROCESS DATA (two members) */</span>
<span class="cp">#ifdef CMX_CONF_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">members</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
			<span class="cm">/* &quot;other&quot; becomes other party */</span>
			<span class="n">other</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span> <span class="n">list</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">member</span><span class="p">)</span>
				<span class="n">other</span> <span class="o">=</span> <span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span> <span class="n">list</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">;</span>
			<span class="n">o_q</span> <span class="o">=</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span> <span class="cm">/* received data */</span>
			<span class="n">o_rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">other</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="cm">/* end of rx-pointer */</span>
			<span class="n">o_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">o_rr</span> <span class="o">-</span> <span class="n">rr</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="cm">/* start rx-pointer at current read position*/</span>
			<span class="cm">/* -&gt; if echo is NOT enabled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * -&gt; copy other member&#39;s rx-data,</span>
<span class="cm">				 * if tx-data is available, mix</span>
<span class="cm">				 */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">o_r</span> <span class="o">!=</span> <span class="n">o_rr</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_mix_law</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">o_q</span><span class="p">[</span><span class="n">o_r</span><span class="p">]];</span>
					<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="n">o_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">o_r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">o_r</span> <span class="o">!=</span> <span class="n">o_rr</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">o_q</span><span class="p">[</span><span class="n">o_r</span><span class="p">];</span>
					<span class="n">o_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">o_r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* -&gt; if echo is enabled */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * -&gt; mix other member&#39;s rx-data with echo,</span>
<span class="cm">				 * if tx-data is available, mix</span>
<span class="cm">				 */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sample</span> <span class="o">=</span> <span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">+</span>
						<span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">]]</span> <span class="o">+</span>
						<span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">o_q</span><span class="p">[</span><span class="n">o_r</span><span class="p">]];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span>
						<span class="n">sample</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
						<span class="n">sample</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
					<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_s16_to_law</span><span class="p">[</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
					<span class="cm">/* tx-data + rx_data + echo */</span>
					<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="n">o_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">o_r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_mix_law</span><span class="p">[(</span><span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">o_q</span><span class="p">[</span><span class="n">o_r</span><span class="p">]];</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="n">o_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">o_r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">send_packet</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef DSP_NEVER_DEFINED</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* PROCESS DATA (three or more members) */</span>
	<span class="cm">/* -&gt; if echo is NOT enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * -&gt; subtract rx-data from conf-data,</span>
<span class="cm">		 * if tx-data is available, mix</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sample</span> <span class="o">=</span> <span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">+</span> <span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">-</span>
				<span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">]];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
			<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_s16_to_law</span><span class="p">[</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
			<span class="cm">/* conf-rx+tx */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sample</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">-</span> <span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">]];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
			<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_s16_to_law</span><span class="p">[</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
			<span class="cm">/* conf-rx */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* -&gt; if echo is enabled */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * -&gt; encode conf-data, if tx-data</span>
<span class="cm">		 * is available, mix</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">tt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sample</span> <span class="o">=</span> <span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span> <span class="o">+</span> <span class="o">*</span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
			<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_s16_to_law</span><span class="p">[</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
			<span class="cm">/* conf(echo)+tx */</span>
			<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sample</span> <span class="o">=</span> <span class="o">*</span><span class="n">c</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">32768</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32768</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
				<span class="n">sample</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
			<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">dsp_audio_s16_to_law</span><span class="p">[</span><span class="n">sample</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>
			<span class="cm">/* conf(echo) */</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">send_packet</span><span class="p">;</span>

<span class="nl">send_packet:</span>
	<span class="cm">/*</span>
<span class="cm">	 * send tx-data if enabled - don&#39;t filter,</span>
<span class="cm">	 * because we want what we send, not what we filtered</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_data_only</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">DL_DATA_REQ</span><span class="p">;</span>
			<span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* queue and trigger */</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
			<span class="cm">/* exit because only tx_data is used */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">txskb</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txskb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;FATAL ERROR in mISDN_dsp.o: &quot;</span>
				       <span class="s">&quot;cannot alloc %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">thh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">txskb</span><span class="p">);</span>
				<span class="n">thh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">DL_DATA_REQ</span><span class="p">;</span>
				<span class="n">thh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">txskb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">preload</span><span class="p">,</span>
				       <span class="n">len</span><span class="p">);</span>
				<span class="cm">/* queue (trigger later) */</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">txskb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* send data only to card, if we don&#39;t just calculated tx_data */</span>
	<span class="cm">/* adjust volume */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span><span class="p">)</span>
		<span class="n">dsp_change_volume</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span><span class="p">);</span>
	<span class="cm">/* pipeline */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">.</span><span class="n">inuse</span><span class="p">)</span>
		<span class="n">dsp_pipeline_process_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">nskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="cm">/* crypt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">bf_enable</span><span class="p">)</span>
		<span class="n">dsp_bf_encrypt</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="cm">/* queue and trigger */</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>	<span class="n">jittercount</span><span class="p">;</span> <span class="cm">/* counter for jitter check */</span>
<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">dsp_spl_tl</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">dsp_spl_jiffies</span><span class="p">;</span> <span class="cm">/* calculate the next time to fire */</span>
<span class="k">static</span> <span class="n">u16</span>	<span class="n">dsp_count</span><span class="p">;</span> <span class="cm">/* last sample count */</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">dsp_count_valid</span><span class="p">;</span> <span class="cm">/* if we have last sample count */</span>

<span class="kt">void</span>
<span class="nf">dsp_cmx_send</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_conf_member</span> <span class="o">*</span><span class="n">member</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mustmix</span><span class="p">,</span> <span class="n">members</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">s32</span> <span class="n">mixbuffer</span><span class="p">[</span><span class="n">MAX_POLL</span> <span class="o">+</span> <span class="mi">100</span><span class="p">];</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">rr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">jittercheck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">length</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* lock */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp_count_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsp_count</span> <span class="o">=</span> <span class="n">mISDN_clock_get</span><span class="p">();</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">dsp_poll</span><span class="p">;</span>
		<span class="n">dsp_count_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">mISDN_clock_get</span><span class="p">();</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">dsp_count</span><span class="p">;</span>
		<span class="n">dsp_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_POLL</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">MAX_POLL</span> <span class="o">+</span> <span class="mi">100</span><span class="p">;</span>
	<span class="cm">/* printk(KERN_DEBUG &quot;len=%d dsp_count=0x%x\n&quot;, length, dsp_count); */</span>

	<span class="cm">/*</span>
<span class="cm">	 * check if jitter needs to be checked (this is every second)</span>
<span class="cm">	 */</span>
	<span class="n">jittercount</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jittercount</span> <span class="o">&gt;=</span> <span class="mi">8000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">jittercount</span> <span class="o">-=</span> <span class="mi">8000</span><span class="p">;</span>
		<span class="n">jittercheck</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* loop all members that do not require conference mixing */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">conf</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
		<span class="n">mustmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">members</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">members</span> <span class="o">=</span> <span class="n">count_list_member</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">);</span>
<span class="cp">#ifdef CMX_CONF_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">&amp;&amp;</span> <span class="n">members</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="cp">#else</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">&amp;&amp;</span> <span class="n">members</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
<span class="cp">#endif</span>
					<span class="n">mustmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* transmission required */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mustmix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp_cmx_send_member</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">mixbuffer</span><span class="p">,</span> <span class="n">members</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * unused mixbuffer is given to prevent a</span>
<span class="cm">			 * potential null-pointer-bug</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* loop all members that require conference mixing */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* count members and check hardware */</span>
		<span class="n">members</span> <span class="o">=</span> <span class="n">count_list_member</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">);</span>
<span class="cp">#ifdef CMX_CONF_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">&amp;&amp;</span> <span class="n">members</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span> <span class="o">&amp;&amp;</span> <span class="n">members</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
				<span class="cm">/* check for hdlc conf */</span>
				<span class="n">member</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">dsp_conf_member</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="cm">/* mix all data */</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">mixbuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">));</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dsp</span> <span class="o">=</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">;</span>
					<span class="cm">/* get range of data to mix */</span>
					<span class="n">c</span> <span class="o">=</span> <span class="n">mixbuffer</span><span class="p">;</span>
					<span class="n">q</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">;</span>
					<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="cm">/* add member&#39;s data */</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">*</span><span class="n">c</span><span class="o">++</span> <span class="o">+=</span> <span class="n">dsp_audio_law_to_s32</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">]];</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="cm">/* process each member */</span>
				<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* transmission */</span>
					<span class="n">dsp_cmx_send_member</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span>
							    <span class="n">mixbuffer</span><span class="p">,</span> <span class="n">members</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* delete rx-data, increment buffers, change pointers */</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span>
			<span class="n">q</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">;</span>
			<span class="cm">/* move receive pointer when receiving */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_is_off</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="cm">/* delete rx-data */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">p</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsp_silence</span><span class="p">;</span>
					<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/* increment rx-buffer pointer */</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span> <span class="cm">/* write incremented read pointer */</span>
			<span class="p">}</span>

			<span class="cm">/* check current rx_delay */</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span><span class="o">-</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="n">CMX_BUFF_HALF</span><span class="p">)</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* will be the delay before next write */</span>
			<span class="cm">/* check for lower delay */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
			<span class="cm">/* check current tx_delay */</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_W</span><span class="o">-</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;=</span> <span class="n">CMX_BUFF_HALF</span><span class="p">)</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* will be the delay before next write */</span>
			<span class="cm">/* check for lower delay */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">jittercheck</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* find the lowest of all rx_delays */</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SECONDS_JITTER_CHECK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="n">delay</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * remove rx_delay only if we have delay AND we</span>
<span class="cm">				 * have not preset cmx_delay AND</span>
<span class="cm">				 * the delay is greater dsp_poll</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">dsp_poll</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CLOCK</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
						       <span class="s">&quot;%s lowest rx_delay of %d bytes for&quot;</span>
						       <span class="s">&quot; dsp %s are now removed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span>
						       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span><span class="p">;</span>
					<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">-</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span>
						<span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="cm">/* delete rx-data */</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">p</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsp_silence</span><span class="p">;</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* increment rx-buffer pointer */</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
					<span class="cm">/* write incremented read pointer */</span>
				<span class="p">}</span>
				<span class="cm">/* find the lowest of all tx_delays */</span>
				<span class="n">delay</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_SECONDS_JITTER_CHECK</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
						<span class="n">delay</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * remove delay only if we have delay AND we</span>
<span class="cm">				 * have enabled tx_dejitter</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="n">dsp_poll</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_dejitter</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CLOCK</span><span class="p">)</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
						       <span class="s">&quot;%s lowest tx_delay of %d bytes for&quot;</span>
						       <span class="s">&quot; dsp %s are now removed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">__func__</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span>
						       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span><span class="p">;</span>
					<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">delay</span> <span class="o">-</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span>
						<span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="cm">/* delete tx-data */</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">rr</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">q</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsp_silence</span><span class="p">;</span>
						<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* increment rx-buffer pointer */</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
					<span class="cm">/* write incremented read pointer */</span>
				<span class="p">}</span>
				<span class="cm">/* scroll up delays */</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">MAX_SECONDS_JITTER_CHECK</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
					<span class="n">i</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMX_BUFF_HALF</span><span class="p">;</span> <span class="cm">/* (infinite) delay */</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_delay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMX_BUFF_HALF</span><span class="p">;</span> <span class="cm">/* (infinite) delay */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* if next event would be in the past ... */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s32</span><span class="p">)(</span><span class="n">dsp_spl_jiffies</span> <span class="o">+</span> <span class="n">dsp_tics</span><span class="o">-</span><span class="n">jiffies</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dsp_spl_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dsp_spl_jiffies</span> <span class="o">+=</span> <span class="n">dsp_tics</span><span class="p">;</span>

		<span class="n">dsp_spl_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">dsp_spl_jiffies</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_spl_tl</span><span class="p">);</span>

		<span class="cm">/* unlock */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * audio data is transmitted from upper layer to the dsp</span>
<span class="cm"> */</span>
	<span class="kt">void</span>
		<span class="n">dsp_cmx_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">u_int</span> <span class="n">w</span><span class="p">,</span> <span class="n">ww</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">space</span><span class="p">;</span> <span class="cm">/* todo: , l = skb-&gt;len; */</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
		<span class="kt">char</span> <span class="n">debugbuf</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* check if there is enough space, and then copy */</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_W</span><span class="p">;</span>
		<span class="n">ww</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_R</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">space</span> <span class="o">=</span> <span class="p">(</span><span class="n">ww</span> <span class="o">-</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="cm">/* write-pointer should not overrun nor reach read pointer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* write to the space we have left */</span>
			<span class="n">ww</span> <span class="o">=</span> <span class="p">(</span><span class="n">ww</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span> <span class="cm">/* end one byte prior tx_R */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CLOCK</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TX overflow space=%d skb-&gt;len=&quot;</span>
				       <span class="s">&quot;%d, w=0x%04x, ww=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span>
				       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ww</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* write until all byte are copied */</span>
			<span class="n">ww</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_W</span> <span class="o">=</span> <span class="n">ww</span><span class="p">;</span>

		<span class="cm">/* show current buffer */</span>
<span class="cp">#ifdef CMX_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;cmx_transmit(dsp=%lx) %d bytes to 0x%x-0x%x. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">dsp</span><span class="p">,</span> <span class="p">(</span><span class="n">ww</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ww</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="cm">/* copy transmit data to tx-buffer */</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">debugbuf</span><span class="p">,</span> <span class="s">&quot;TX getting (%04x-%04x)%p: &quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ww</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">w</span> <span class="o">!=</span> <span class="n">ww</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">debugbuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">)</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">debugbuf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">debugbuf</span><span class="p">),</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">d</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">p</span><span class="p">[</span><span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">d</span><span class="o">++</span><span class="p">;</span>
			<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMX_BUFF_MASK</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CMX_TX_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">debugbuf</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * hdlc data is received from card and sent to all members.</span>
<span class="cm"> */</span>
	<span class="kt">void</span>
		<span class="n">dsp_cmx_hdlc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">dsp_conf_member</span> <span class="o">*</span><span class="n">member</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mISDNhead</span> <span class="o">*</span><span class="n">hh</span><span class="p">;</span>

		<span class="cm">/* not if not active */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* check if we have sompen */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* no conf */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* in case of software echo */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
					<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">PH_DATA_REQ</span><span class="p">;</span>
					<span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* in case of hardware conference */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">hardware</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span> <span class="o">||</span> <span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span> <span class="o">!=</span> <span class="n">dsp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
					<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">PH_DATA_REQ</span><span class="p">;</span>
					<span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
