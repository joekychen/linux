<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › mISDN › dsp_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dsp_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Author       Andreas Eversberg (jolly@eversberg.eu)</span>
<span class="cm"> * Based on source code structure by</span>
<span class="cm"> *		Karsten Keil (keil@isdn4linux.de)</span>
<span class="cm"> *</span>
<span class="cm"> *		This file is (c) under GNU PUBLIC LICENSE</span>
<span class="cm"> *		For changes and modifications please read</span>
<span class="cm"> *		../../../Documentation/isdn/mISDN.cert</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to    Karsten Keil (great drivers)</span>
<span class="cm"> *              Cologne Chip (great chips)</span>
<span class="cm"> *</span>
<span class="cm"> * This module does:</span>
<span class="cm"> *		Real-time tone generation</span>
<span class="cm"> *		DTMF detection</span>
<span class="cm"> *		Real-time cross-connection and conferrence</span>
<span class="cm"> *		Compensate jitter due to system load and hardware fault.</span>
<span class="cm"> *		All features are done in kernel space and will be realized</span>
<span class="cm"> *		using hardware, if available and supported by chip set.</span>
<span class="cm"> *		Blowfish encryption/decryption</span>
<span class="cm"> */</span>

<span class="cm">/* STRUCTURE:</span>
<span class="cm"> *</span>
<span class="cm"> * The dsp module provides layer 2 for b-channels (64kbit). It provides</span>
<span class="cm"> * transparent audio forwarding with special digital signal processing:</span>
<span class="cm"> *</span>
<span class="cm"> * - (1) generation of tones</span>
<span class="cm"> * - (2) detection of dtmf tones</span>
<span class="cm"> * - (3) crossconnecting and conferences (clocking)</span>
<span class="cm"> * - (4) echo generation for delay test</span>
<span class="cm"> * - (5) volume control</span>
<span class="cm"> * - (6) disable receive data</span>
<span class="cm"> * - (7) pipeline</span>
<span class="cm"> * - (8) encryption/decryption</span>
<span class="cm"> *</span>
<span class="cm"> * Look:</span>
<span class="cm"> *             TX            RX</span>
<span class="cm"> *         ------upper layer------</span>
<span class="cm"> *             |             ^</span>
<span class="cm"> *             |             |(6)</span>
<span class="cm"> *             v             |</span>
<span class="cm"> *       +-----+-------------+-----+</span>
<span class="cm"> *       |(3)(4)                   |</span>
<span class="cm"> *       |           CMX           |</span>
<span class="cm"> *       |                         |</span>
<span class="cm"> *       |           +-------------+</span>
<span class="cm"> *       |           |       ^</span>
<span class="cm"> *       |           |       |</span>
<span class="cm"> *       |+---------+|  +----+----+</span>
<span class="cm"> *       ||(1)      ||  |(2)      |</span>
<span class="cm"> *       ||         ||  |         |</span>
<span class="cm"> *       ||  Tones  ||  |  DTMF   |</span>
<span class="cm"> *       ||         ||  |         |</span>
<span class="cm"> *       ||         ||  |         |</span>
<span class="cm"> *       |+----+----+|  +----+----+</span>
<span class="cm"> *       +-----+-----+       ^</span>
<span class="cm"> *             |             |</span>
<span class="cm"> *             v             |</span>
<span class="cm"> *        +----+----+   +----+----+</span>
<span class="cm"> *        |(5)      |   |(5)      |</span>
<span class="cm"> *        |         |   |         |</span>
<span class="cm"> *        |TX Volume|   |RX Volume|</span>
<span class="cm"> *        |         |   |         |</span>
<span class="cm"> *        |         |   |         |</span>
<span class="cm"> *        +----+----+   +----+----+</span>
<span class="cm"> *             |             ^</span>
<span class="cm"> *             |             |</span>
<span class="cm"> *             v             |</span>
<span class="cm"> *        +----+-------------+----+</span>
<span class="cm"> *        |(7)                    |</span>
<span class="cm"> *        |                       |</span>
<span class="cm"> *        |  Pipeline Processing  |</span>
<span class="cm"> *        |                       |</span>
<span class="cm"> *        |                       |</span>
<span class="cm"> *        +----+-------------+----+</span>
<span class="cm"> *             |             ^</span>
<span class="cm"> *             |             |</span>
<span class="cm"> *             v             |</span>
<span class="cm"> *        +----+----+   +----+----+</span>
<span class="cm"> *        |(8)      |   |(8)      |</span>
<span class="cm"> *        |         |   |         |</span>
<span class="cm"> *        | Encrypt |   | Decrypt |</span>
<span class="cm"> *        |         |   |         |</span>
<span class="cm"> *        |         |   |         |</span>
<span class="cm"> *        +----+----+   +----+----+</span>
<span class="cm"> *             |             ^</span>
<span class="cm"> *             |             |</span>
<span class="cm"> *             v             |</span>
<span class="cm"> *         ------card  layer------</span>
<span class="cm"> *             TX            RX</span>
<span class="cm"> *</span>
<span class="cm"> * Above you can see the logical data flow. If software is used to do the</span>
<span class="cm"> * process, it is actually the real data flow. If hardware is used, data</span>
<span class="cm"> * may not flow, but hardware commands to the card, to provide the data flow</span>
<span class="cm"> * as shown.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: The channel must be activated in order to make dsp work, even if</span>
<span class="cm"> * no data flow to the upper layer is intended. Activation can be done</span>
<span class="cm"> * after and before controlling the setting using PH_CONTROL requests.</span>
<span class="cm"> *</span>
<span class="cm"> * DTMF: Will be detected by hardware if possible. It is done before CMX</span>
<span class="cm"> * processing.</span>
<span class="cm"> *</span>
<span class="cm"> * Tones: Will be generated via software if endless looped audio fifos are</span>
<span class="cm"> * not supported by hardware. Tones will override all data from CMX.</span>
<span class="cm"> * It is not required to join a conference to use tones at any time.</span>
<span class="cm"> *</span>
<span class="cm"> * CMX: Is transparent when not used. When it is used, it will do</span>
<span class="cm"> * crossconnections and conferences via software if not possible through</span>
<span class="cm"> * hardware. If hardware capability is available, hardware is used.</span>
<span class="cm"> *</span>
<span class="cm"> * Echo: Is generated by CMX and is used to check performance of hard and</span>
<span class="cm"> * software CMX.</span>
<span class="cm"> *</span>
<span class="cm"> * The CMX has special functions for conferences with one, two and more</span>
<span class="cm"> * members. It will allow different types of data flow. Receive and transmit</span>
<span class="cm"> * data to/form upper layer may be swithed on/off individually without losing</span>
<span class="cm"> * features of CMX, Tones and DTMF.</span>
<span class="cm"> *</span>
<span class="cm"> * Echo Cancellation: Sometimes we like to cancel echo from the interface.</span>
<span class="cm"> * Note that a VoIP call may not have echo caused by the IP phone. The echo</span>
<span class="cm"> * is generated by the telephone line connected to it. Because the delay</span>
<span class="cm"> * is high, it becomes an echo. RESULT: Echo Cachelation is required if</span>
<span class="cm"> * both echo AND delay is applied to an interface.</span>
<span class="cm"> * Remember that software CMX always generates a more or less delay.</span>
<span class="cm"> *</span>
<span class="cm"> * If all used features can be realized in hardware, and if transmit and/or</span>
<span class="cm"> * receive data ist disabled, the card may not send/receive any data at all.</span>
<span class="cm"> * Not receiving is useful if only announcements are played. Not sending is</span>
<span class="cm"> * useful if an answering machine records audio. Not sending and receiving is</span>
<span class="cm"> * useful during most states of the call. If supported by hardware, tones</span>
<span class="cm"> * will be played without cpu load. Small PBXs and NT-Mode applications will</span>
<span class="cm"> * not need expensive hardware when processing calls.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> *</span>
<span class="cm"> * When data is received from upper or lower layer (card), the complete dsp</span>
<span class="cm"> * module is locked by a global lock.  This lock MUST lock irq, because it</span>
<span class="cm"> * must lock timer events by DSP poll timer.</span>
<span class="cm"> * When data is ready to be transmitted down, the data is queued and sent</span>
<span class="cm"> * outside lock and timer event.</span>
<span class="cm"> * PH_CONTROL must not change any settings, join or split conference members</span>
<span class="cm"> * during process of data.</span>
<span class="cm"> *</span>
<span class="cm"> * HDLC:</span>
<span class="cm"> *</span>
<span class="cm"> * It works quite the same as transparent, except that HDLC data is forwarded</span>
<span class="cm"> * to all other conference members if no hardware bridging is possible.</span>
<span class="cm"> * Send data will be writte to sendq. Sendq will be sent if confirm is received.</span>
<span class="cm"> * Conference cannot join, if one member is not hdlc.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNif.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNdsp.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;dsp.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mISDN_dsp_revision</span> <span class="o">=</span> <span class="s">&quot;2.0&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">options</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">poll</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dtmfthreshold</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andreas Eversberg&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dtmfthreshold</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*int spinnest = 0;*/</span>

<span class="n">spinlock_t</span> <span class="n">dsp_lock</span><span class="p">;</span> <span class="cm">/* global dsp lock */</span>
<span class="k">struct</span> <span class="n">list_head</span> <span class="n">dsp_ilist</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">list_head</span> <span class="n">conf_ilist</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">dsp_debug</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">dsp_options</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">dsp_poll</span><span class="p">,</span> <span class="n">dsp_tics</span><span class="p">;</span>

<span class="cm">/* check if rx may be turned off or must be turned on */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dsp_rx_off_member</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDN_ctrl_req</span>	<span class="n">cq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cq</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features_rx_off</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* not disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_disabled</span><span class="p">)</span>
		<span class="n">rx_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* software dtmf */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">software</span><span class="p">)</span>
		<span class="n">rx_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* echo in software */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span><span class="p">)</span>
		<span class="n">rx_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* bridge in software */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span><span class="p">)</span>
		<span class="n">rx_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* data is not required by user space and not required</span>
<span class="cm">	 * for echo dtmf detection, soft-echo, soft-bridging */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_off</span> <span class="o">==</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_is_off</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: no peer, no rx_off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_RX_OFF</span><span class="p">;</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">rx_off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">CONTROL_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: 2nd CONTROL_CHANNEL failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_is_off</span> <span class="o">=</span> <span class="n">rx_off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s set rx_off = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_off</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dsp_rx_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp_conf_member</span>	<span class="o">*</span><span class="n">member</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_options</span> <span class="o">&amp;</span> <span class="n">DSP_OPT_NOHARDWARE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* no conf */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsp_rx_off_member</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check all members in conf */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dsp_rx_off_member</span><span class="p">(</span><span class="n">member</span><span class="o">-&gt;</span><span class="n">dsp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* enable &quot;fill empty&quot; feature */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dsp_fill_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDN_ctrl_req</span>	<span class="n">cq</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cq</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: no peer, no fill_empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_FILL_EMPTY</span><span class="p">;</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">p1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">p2</span> <span class="o">=</span> <span class="n">dsp_silence</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">CONTROL_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: CONTROL_CHANNEL failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s set fill_empty = 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dsp_control_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNhead</span> <span class="o">*</span><span class="n">hh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cont</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: PH_CONTROL message too short</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">cont</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cont</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DTMF_TONE_START</span>: <span class="cm">/* turn on DTMF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: start dtmf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;changing DTMF Threshold &quot;</span>
				       <span class="s">&quot;to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">));</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">treshold</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* init goertzel */</span>
		<span class="n">dsp_dtmf_goertzel_init</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>

		<span class="cm">/* check dtmf hardware */</span>
		<span class="n">dsp_dtmf_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DTMF_TONE_STOP</span>: <span class="cm">/* turn off DTMF */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: stop dtmf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">software</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_CONF_JOIN</span>: <span class="cm">/* join / update conference */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">conf_split</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: join conference %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dsp_cmx_conf</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">));</span>
		<span class="cm">/* dsp_cmx_hardware will also be called here */</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_CONF_SPLIT</span>: <span class="cm">/* remove from conference */</span>
	<span class="nl">conf_split:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: release conference</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dsp_cmx_conf</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* dsp_cmx_hardware will also be called here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_TONE_PATT_ON</span>: <span class="cm">/* play tone */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: turn tone 0x%x on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dsp_tone</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
			<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tone</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">tone_off</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_TONE_PATT_OFF</span>: <span class="cm">/* stop tone */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: turn tone off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp_tone</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="cm">/* reset tx buffers (user space data) */</span>
	<span class="nl">tone_off:</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_VOL_CHANGE_TX</span>: <span class="cm">/* change volume */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: change tx vol to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_dtmf_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_VOL_CHANGE_RX</span>: <span class="cm">/* change volume */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_volume</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: change rx vol to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_dtmf_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_ECHO_ON</span>: <span class="cm">/* enable echo */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* soft echo */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: enable cmx-echo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_ECHO_OFF</span>: <span class="cm">/* disable echo */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">software</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">echo</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: disable cmx-echo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_RECEIVE_ON</span>: <span class="cm">/* enable receive to user space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: enable receive to user &quot;</span>
			       <span class="s">&quot;space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_RECEIVE_OFF</span>: <span class="cm">/* disable receive to user space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: disable receive to &quot;</span>
			       <span class="s">&quot;user space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_MIX_ON</span>: <span class="cm">/* enable mixing of tx data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: enable mixing of &quot;</span>
			       <span class="s">&quot;tx-data with conf mebers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_mix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_MIX_OFF</span>: <span class="cm">/* disable mixing of tx data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: disable mixing of &quot;</span>
			       <span class="s">&quot;tx-data with conf mebers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_mix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_TXDATA_ON</span>: <span class="cm">/* enable txdata */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_data</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: enable tx-data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_TXDATA_OFF</span>: <span class="cm">/* disable txdata */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: disable tx-data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CMX</span><span class="p">)</span>
			<span class="n">dsp_cmx_debug</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_DELAY</span>: <span class="cm">/* use delay algorithm instead of dynamic</span>
<span class="cm">			   jitter algorithm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="cm">/* milliseconds to samples */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">CMX_BUFF_HALF</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="cm">/* clip to half of maximum usable buffer</span>
<span class="cm">			   (half of half buffer) */</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">CMX_BUFF_HALF</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: use delay algorithm to &quot;</span>
			       <span class="s">&quot;compensate jitter (%d samples)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_JITTER</span>: <span class="cm">/* use dynamic jitter algorithm instead of</span>
<span class="cm">			    delay algorithm */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">cmx_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: use jitter algorithm to &quot;</span>
			       <span class="s">&quot;compensate jitter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_TX_DEJITTER</span>: <span class="cm">/* use dynamic jitter algorithm for tx-buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_dejitter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: use dejitter on TX &quot;</span>
			       <span class="s">&quot;buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_TX_DEJ_OFF</span>: <span class="cm">/* use tx-buffer without dejittering*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_dejitter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: use TX buffer without &quot;</span>
			       <span class="s">&quot;dejittering</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_PIPELINE_CFG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: pipeline config string &quot;</span>
			       <span class="s">&quot;is not NULL terminated!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">.</span><span class="n">inuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dsp_pipeline_build</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span>
						 <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">data</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
			<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_BF_ENABLE_KEY</span>: <span class="cm">/* turn blowfish on */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">56</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: turn blowfish on (key &quot;</span>
			       <span class="s">&quot;not shown)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dsp_bf_init</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="cm">/* set new cont */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">cont</span> <span class="o">=</span> <span class="n">DSP_BF_ACCEPT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cont</span> <span class="o">=</span> <span class="n">DSP_BF_REJECT</span><span class="p">;</span>
		<span class="cm">/* send indication if it worked to set it */</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">_alloc_mISDN_skb</span><span class="p">(</span><span class="n">PH_CONTROL_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cont</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">nskb</span><span class="p">))</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
			<span class="n">dsp_dtmf_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
			<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DSP_BF_DISABLE</span>: <span class="cm">/* turn blowfish off */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: turn blowfish off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dsp_bf_cleanup</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_dtmf_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ctrl req %x unhandled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">cont</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">get_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp</span>		<span class="o">*</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mISDN_ctrl_req</span>	<span class="n">cq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: no peer, no features</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cq</span><span class="p">));</span>
	<span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_GETOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="n">CONTROL_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: CONTROL_CHANNEL failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">MISDN_CTRL_RX_OFF</span><span class="p">)</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features_rx_off</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">MISDN_CTRL_FILL_EMPTY</span><span class="p">)</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features_fill_empty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_options</span> <span class="o">&amp;</span> <span class="n">DSP_OPT_NOHARDWARE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">&amp;</span> <span class="n">MISDN_CTRL_HW_FEATURES_OP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cq</span><span class="p">.</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_HW_FEATURES</span><span class="p">;</span>
		<span class="o">*</span><span class="p">((</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cq</span><span class="p">.</span><span class="n">p1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="n">CONTROL_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: 2nd CONTROL_CHANNEL failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: features not supported for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dsp_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp</span>		<span class="o">*</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="o">*</span><span class="n">digits</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">flags</span><span class="p">;</span>

	<span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FROM DOWN */</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA_CNF</span><span class="p">)</span>:
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* trigger next hdlc frame, if any */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span><span class="p">)</span>
				<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA_IND</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_DATA_IND</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_is_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: rx-data during rx_off&quot;</span>
				       <span class="s">&quot; for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hdlc */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dsp_cmx_hdlc</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_disabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* if receive is not allowed */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">DL_DATA_IND</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* decrypt if enabled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">bf_enable</span><span class="p">)</span>
			<span class="n">dsp_bf_decrypt</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="cm">/* pipeline */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">.</span><span class="n">inuse</span><span class="p">)</span>
			<span class="n">dsp_pipeline_process_rx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="cm">/* change volume if requested */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_volume</span><span class="p">)</span>
			<span class="n">dsp_change_volume</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_volume</span><span class="p">);</span>
		<span class="cm">/* check if dtmf soft decoding is turned on */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">digits</span> <span class="o">=</span> <span class="n">dsp_dtmf_goertzel_decode</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">dsp_options</span> <span class="o">&amp;</span> <span class="n">DSP_OPT_ULAW</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* we need to process receive data if software */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">software</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* process data from card at cmx */</span>
			<span class="n">dsp_cmx_receive</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* send dtmf result, if any */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">digits</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">digits</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_DTMF</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: digit&quot;</span>
					       <span class="s">&quot;(%c) to layer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">digits</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">k</span> <span class="o">=</span> <span class="o">*</span><span class="n">digits</span> <span class="o">|</span> <span class="n">DTMF_TONE_VAL</span><span class="p">;</span>
				<span class="n">nskb</span> <span class="o">=</span> <span class="n">_alloc_mISDN_skb</span><span class="p">(</span><span class="n">PH_CONTROL_IND</span><span class="p">,</span>
							<span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">,</span>
							<span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span>
							    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">nskb</span><span class="p">))</span>
							<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">digits</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_disabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if receive is not allowed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">DL_DATA_IND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_CONTROL_IND</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_DTMFCOEFF</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PH_CONTROL INDICATION &quot;</span>
			       <span class="s">&quot;received: %x (len %d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">DTMF_HFC_COEF</span><span class="p">)</span>: <span class="cm">/* getting coefficients */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">hardware</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_DTMFCOEFF</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ignoring DTMF &quot;</span>
					       <span class="s">&quot;coefficients from HFC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">digits</span> <span class="o">=</span> <span class="n">dsp_dtmf_goertzel_decode</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">digits</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_DTMF</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: digit&quot;</span>
					       <span class="s">&quot;(%c) to layer %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">digits</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">k</span> <span class="o">=</span> <span class="o">*</span><span class="n">digits</span> <span class="o">|</span> <span class="n">DTMF_TONE_VAL</span><span class="p">;</span>
				<span class="n">nskb</span> <span class="o">=</span> <span class="n">_alloc_mISDN_skb</span><span class="p">(</span><span class="n">PH_CONTROL_IND</span><span class="p">,</span>
							<span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">,</span>
							<span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span>
							    <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">nskb</span><span class="p">))</span>
							<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span>
						<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">nskb</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">digits</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">HFC_VOL_CHANGE_TX</span><span class="p">)</span>: <span class="cm">/* change volume */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: change tx volume to &quot;</span>
				       <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tx_volume</span><span class="p">);</span>
			<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
			<span class="n">dsp_dtmf_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
			<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ctrl ind %x unhandled &quot;</span>
				       <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE_IND</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE_CNF</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: b_channel is now active %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* bchannel now active */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* rx_W and rx_R will be adjusted on first frame */</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_W</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">));</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_dtmf_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: done with activation, sending &quot;</span>
			       <span class="s">&quot;confirm to user space. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* send activation to upper layer */</span>
		<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">DL_ESTABLISH_CNF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE_IND</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE_CNF</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: b_channel is now inactive %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* bchannel now inactive */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp_cmx_hardware</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span> <span class="n">dsp</span><span class="p">);</span>
		<span class="n">dsp_rx_off</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">DL_RELEASE_CNF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* FROM UP */</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_DATA_REQ</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DATA_REQ</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hdlc */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">PH_DATA_REQ</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* send data to tx-buffer (if no tone is played) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tone</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dsp_cmx_transmit</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_CONTROL_REQ</span><span class="p">)</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dsp_control_req</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_ESTABLISH_REQ</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_ACTIVATE_REQ</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: activating b_channel %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">hardware</span> <span class="o">||</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">software</span><span class="p">)</span>
			<span class="n">dsp_dtmf_goertzel_init</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">get_features</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="cm">/* enable fill_empty feature */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">features_fill_empty</span><span class="p">)</span>
			<span class="n">dsp_fill_empty</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="cm">/* send ph_activate */</span>
		<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">PH_ACTIVATE_REQ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="p">(</span><span class="n">DL_RELEASE_REQ</span><span class="p">)</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">PH_DEACTIVATE_REQ</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: releasing b_channel %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tone</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">hardware</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">software</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tl</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span>
			<span class="n">dsp_cmx_conf</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* dsp_cmx_hardware will also be</span>
<span class="cm">						 called here */</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">=</span> <span class="n">PH_DEACTIVATE_REQ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: msg %x unhandled %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dsp_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp</span>		<span class="o">*</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CTRL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s:(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPEN_CHANNEL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">)</span>
			<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">CLOSE_CHANNEL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* wait until workqueue has finished,</span>
<span class="cm">		 * must lock here, or we may hit send-process currently</span>
<span class="cm">		 * queueing. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* MUST not be locked, because it waits until queue is done. */</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tl</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>
		<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CTRL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: releasing member %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">b_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dsp_cmx_conf</span><span class="p">(</span><span class="n">dsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* dsp_cmx_hardware will also be called</span>
<span class="cm">					 here */</span>
		<span class="n">dsp_pipeline_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CTRL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: remove &amp; destroy object %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CTRL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dsp instance released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">dsp</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dsp_send_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp</span> <span class="o">*</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp</span><span class="p">,</span> <span class="n">workq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">hdlc</span> <span class="o">&amp;&amp;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* wait until data has been acknowledged */</span>

	<span class="cm">/* send queued data */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* in locked date, we must have still data in queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CORE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: fifo full %s, this is &quot;</span>
				       <span class="s">&quot;no bug!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* flush transparent data, if not acked */</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span> <span class="o">==</span> <span class="n">DL_DATA_REQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send packet up */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* send packet down */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">peer</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dspcreate</span><span class="p">(</span><span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">crq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dsp</span>		<span class="o">*</span><span class="n">ndsp</span><span class="p">;</span>
	<span class="n">u_long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_B_L2DSP</span>
	    <span class="o">&amp;&amp;</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_B_L2DSPHDLC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="n">ndsp</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: vmalloc struct dsp failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_DSP_CTRL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: creating new dsp instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* default enabled */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dsp_send_bh</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">sendq</span><span class="p">);</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">dsp_function</span><span class="p">;</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">dsp_ctrl</span><span class="p">;</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">up</span> <span class="o">=</span> <span class="n">crq</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="n">crq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_B_L2DSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ISDN_P_B_RAW</span><span class="p">;</span>
		<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">hdlc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">crq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ISDN_P_B_HDLC</span><span class="p">;</span>
		<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">hdlc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;DSP_C%x(0x%p)&quot;</span><span class="p">,</span>
		<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ndsp</span><span class="p">);</span>
	<span class="cm">/* set frame size to start */</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">hfc_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* current PCM id */</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">.</span><span class="n">pcm_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* current PCM id */</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* current CPM slot */</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">pcm_slot_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">pcm_bank_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">hfc_conf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* current conference number */</span>
	<span class="cm">/* set tone timer */</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tl</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dsp_tone_timeout</span><span class="p">;</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tl</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">ndsp</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">tone</span><span class="p">.</span><span class="n">tl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dtmfthreshold</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="n">dtmfthreshold</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span>
		<span class="n">dtmfthreshold</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">dtmf</span><span class="p">.</span><span class="n">treshold</span> <span class="o">=</span> <span class="n">dtmfthreshold</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="cm">/* init pipeline append to list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dsp_pipeline_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndsp</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">Bprotocol</span> <span class="n">DSP</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">Bprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_L2DSP</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">))</span>
	<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_L2DSPHDLC</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">)),</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dsp&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">dspcreate</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dsp_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tics</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DSP module %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mISDN_dsp_revision</span><span class="p">);</span>

	<span class="n">dsp_options</span> <span class="o">=</span> <span class="n">options</span><span class="p">;</span>
	<span class="n">dsp_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="cm">/* set packet size */</span>
	<span class="n">dsp_poll</span> <span class="o">=</span> <span class="n">poll</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_poll</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">&gt;</span> <span class="n">MAX_POLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Wrong poll value (%d), use %d &quot;</span>
			       <span class="s">&quot;maximum.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">poll</span><span class="p">,</span> <span class="n">MAX_POLL</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Wrong poll value (%d), use 8 &quot;</span>
			       <span class="s">&quot;minimum.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dsp_poll</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dsp_tics</span> <span class="o">=</span> <span class="n">poll</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">8000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_tics</span> <span class="o">*</span> <span class="mi">8000</span> <span class="o">!=</span> <span class="n">poll</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mISDN_dsp: Cannot clock every %d &quot;</span>
			       <span class="s">&quot;samples (0,125 ms). It is not a multiple of &quot;</span>
			       <span class="s">&quot;%d HZ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">poll</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">poll</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">poll</span> <span class="o">&lt;=</span> <span class="n">MAX_POLL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tics</span> <span class="o">=</span> <span class="p">(</span><span class="n">poll</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tics</span> <span class="o">*</span> <span class="mi">8000</span> <span class="o">==</span> <span class="n">poll</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dsp_tics</span> <span class="o">=</span> <span class="n">tics</span><span class="p">;</span>
				<span class="n">dsp_poll</span> <span class="o">=</span> <span class="n">poll</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">poll</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">poll</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_poll</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mISDN_dsp: There is no multiple of kernel &quot;</span>
		       <span class="s">&quot;clock that equals exactly the duration of 8-256 &quot;</span>
		       <span class="s">&quot;samples. (Choose kernel clock speed like 100, 250, &quot;</span>
		       <span class="s">&quot;300, 1000)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mISDN_dsp: DSP clocks every %d samples. This equals &quot;</span>
	       <span class="s">&quot;%d jiffies.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsp_poll</span><span class="p">,</span> <span class="n">dsp_tics</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_ilist</span><span class="p">);</span>

	<span class="cm">/* init conversion tables */</span>
	<span class="n">dsp_audio_generate_law_tables</span><span class="p">();</span>
	<span class="n">dsp_silence</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_options</span> <span class="o">&amp;</span> <span class="n">DSP_OPT_ULAW</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xff</span> <span class="o">:</span> <span class="mh">0x2a</span><span class="p">;</span>
	<span class="n">dsp_audio_law_to_s32</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsp_options</span> <span class="o">&amp;</span> <span class="n">DSP_OPT_ULAW</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">dsp_audio_ulaw_to_s32</span> <span class="o">:</span> <span class="n">dsp_audio_alaw_to_s32</span><span class="p">;</span>
	<span class="n">dsp_audio_generate_s2law_table</span><span class="p">();</span>
	<span class="n">dsp_audio_generate_seven</span><span class="p">();</span>
	<span class="n">dsp_audio_generate_mix_table</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dsp_options</span> <span class="o">&amp;</span> <span class="n">DSP_OPT_ULAW</span><span class="p">)</span>
		<span class="n">dsp_audio_generate_ulaw_samples</span><span class="p">();</span>
	<span class="n">dsp_audio_generate_volume_changes</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_pipeline_module_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mISDN_dsp: Can&#39;t initialize pipeline, &quot;</span>
		       <span class="s">&quot;error(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">mISDN_register_Bprotocol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DSP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Can&#39;t register %s error(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DSP</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set sample timer */</span>
	<span class="n">dsp_spl_tl</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dsp_cmx_send</span><span class="p">;</span>
	<span class="n">dsp_spl_tl</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_spl_tl</span><span class="p">);</span>
	<span class="n">dsp_spl_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">dsp_tics</span><span class="p">;</span>
	<span class="n">dsp_spl_jiffies</span> <span class="o">=</span> <span class="n">dsp_spl_tl</span><span class="p">.</span><span class="n">expires</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_spl_tl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dsp_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mISDN_unregister_Bprotocol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DSP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_spl_tl</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_spl_tl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_ilist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mISDN_dsp: Audio DSP object inst list not &quot;</span>
		       <span class="s">&quot;empty.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conf_ilist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mISDN_dsp: Conference list not empty. Not &quot;</span>
		       <span class="s">&quot;all memory freed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dsp_pipeline_module_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dsp_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dsp_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
