<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › mISDN › l1oip_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>l1oip_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm"> * l1oip.c  low level driver for tunneling layer 1 over IP</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: It is not compatible with TDMoIP nor &quot;ISDN over IP&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author	Andreas Eversberg (jolly@eversberg.eu)</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> * any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* module parameters:</span>
<span class="cm"> * type:</span>
<span class="cm"> Value 1	= BRI</span>
<span class="cm"> Value 2	= PRI</span>
<span class="cm"> Value 3 = BRI (multi channel frame, not supported yet)</span>
<span class="cm"> Value 4 = PRI (multi channel frame, not supported yet)</span>
<span class="cm"> A multi channel frame reduces overhead to a single frame for all</span>
<span class="cm"> b-channels, but increases delay.</span>
<span class="cm"> (NOTE: Multi channel frames are not implemented yet.)</span>

<span class="cm"> * codec:</span>
<span class="cm"> Value 0 = transparent (default)</span>
<span class="cm"> Value 1 = transfer ALAW</span>
<span class="cm"> Value 2 = transfer ULAW</span>
<span class="cm"> Value 3 = transfer generic 4 bit compression.</span>

<span class="cm"> * ulaw:</span>
<span class="cm"> 0 = we use a-Law (default)</span>
<span class="cm"> 1 = we use u-Law</span>

<span class="cm"> * limit:</span>
<span class="cm"> limitation of B-channels to control bandwidth (1...126)</span>
<span class="cm"> BRI: 1 or 2</span>
<span class="cm"> PRI: 1-30, 31-126 (126, because dchannel ist not counted here)</span>
<span class="cm"> Also limited ressources are used for stack, resulting in less channels.</span>
<span class="cm"> It is possible to have more channels than 30 in PRI mode, this must</span>
<span class="cm"> be supported by the application.</span>

<span class="cm"> * ip:</span>
<span class="cm"> byte representation of remote ip address (127.0.0.1 -&gt; 127,0,0,1)</span>
<span class="cm"> If not given or four 0, no remote address is set.</span>
<span class="cm"> For multiple interfaces, concat ip addresses. (127,0,0,1,127,0,0,1)</span>

<span class="cm"> * port:</span>
<span class="cm"> port number (local interface)</span>
<span class="cm"> If not given or 0, port 931 is used for fist instance, 932 for next...</span>
<span class="cm"> For multiple interfaces, different ports must be given.</span>

<span class="cm"> * remoteport:</span>
<span class="cm"> port number (remote interface)</span>
<span class="cm"> If not given or 0, remote port equals local port</span>
<span class="cm"> For multiple interfaces on equal sites, different ports must be given.</span>

<span class="cm"> * ondemand:</span>
<span class="cm"> 0 = fixed (always transmit packets, even when remote side timed out)</span>
<span class="cm"> 1 = on demand (only transmit packets, when remote side is detected)</span>
<span class="cm"> the default is 0</span>
<span class="cm"> NOTE: ID must also be set for on demand.</span>

<span class="cm"> * id:</span>
<span class="cm"> optional value to identify frames. This value must be equal on both</span>
<span class="cm"> peers and should be random. If omitted or 0, no ID is transmitted.</span>

<span class="cm"> * debug:</span>
<span class="cm"> NOTE: only one debug value must be given for all cards</span>
<span class="cm"> enable debugging (see l1oip.h for debug options)</span>


<span class="cm"> Special mISDN controls:</span>

<span class="cm"> op = MISDN_CTRL_SETPEER*</span>
<span class="cm"> p1 = bytes 0-3 : remote IP address in network order (left element first)</span>
<span class="cm"> p2 = bytes 1-2 : remote port in network order (high byte first)</span>
<span class="cm"> optional:</span>
<span class="cm"> p2 = bytes 3-4 : local port in network order (high byte first)</span>

<span class="cm"> op = MISDN_CTRL_UNSETPEER*</span>

<span class="cm"> * Use l1oipctrl for comfortable setting or removing ip address.</span>
<span class="cm"> (Layer 1 Over IP CTRL)</span>


<span class="cm"> L1oIP-Protocol</span>
<span class="cm"> --------------</span>

<span class="cm"> Frame Header:</span>

<span class="cm"> 7 6 5 4 3 2 1 0</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |Ver|T|I|Coding |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |  ID byte 3 *  |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |  ID byte 2 *  |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |  ID byte 1 *  |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |  ID byte 0 *  |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |M|   Channel   |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |    Length *   |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> | Time Base MSB |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> | Time Base LSB |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> | Data....	|</span>

<span class="cm"> ...</span>

<span class="cm"> |               |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |M|   Channel   |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> |    Length *   |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> | Time Base MSB |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> | Time Base LSB |</span>
<span class="cm"> +---------------+</span>
<span class="cm"> | Data....	|</span>

<span class="cm"> ...</span>


<span class="cm"> * Only included in some cases.</span>

<span class="cm"> - Ver = Version</span>
<span class="cm"> If version is missmatch, the frame must be ignored.</span>

<span class="cm"> - T = Type of interface</span>
<span class="cm"> Must be 0 for S0 or 1 for E1.</span>

<span class="cm"> - I = Id present</span>
<span class="cm"> If bit is set, four ID bytes are included in frame.</span>

<span class="cm"> - ID = Connection ID</span>
<span class="cm"> Additional ID to prevent Denial of Service attacs. Also it prevents hijacking</span>
<span class="cm"> connections with dynamic IP. The ID should be random and must not be 0.</span>

<span class="cm"> - Coding = Type of codec</span>
<span class="cm"> Must be 0 for no transcoding. Also for D-channel and other HDLC frames.</span>
<span class="cm"> 1 and 2 are reserved for explicitly use of a-LAW or u-LAW codec.</span>
<span class="cm"> 3 is used for generic table compressor.</span>

<span class="cm"> - M = More channels to come. If this flag is 1, the following byte contains</span>
<span class="cm"> the length of the channel data. After the data block, the next channel will</span>
<span class="cm"> be defined. The flag for the last channel block (or if only one channel is</span>
<span class="cm"> transmitted), must be 0 and no length is given.</span>

<span class="cm"> - Channel = Channel number</span>
<span class="cm"> 0 reserved</span>
<span class="cm"> 1-3 channel data for S0 (3 is D-channel)</span>
<span class="cm"> 1-31 channel data for E1 (16 is D-channel)</span>
<span class="cm"> 32-127 channel data for extended E1 (16 is D-channel)</span>

<span class="cm"> - The length is used if the M-flag is 1. It is used to find the next channel</span>
<span class="cm"> inside frame.</span>
<span class="cm"> NOTE: A value of 0 equals 256 bytes of data.</span>
<span class="cm"> -&gt; For larger data blocks, a single frame must be used.</span>
<span class="cm"> -&gt; For larger streams, a single frame or multiple blocks with same channel ID</span>
<span class="cm"> must be used.</span>

<span class="cm"> - Time Base = Timestamp of first sample in frame</span>
<span class="cm"> The &quot;Time Base&quot; is used to rearange packets and to detect packet loss.</span>
<span class="cm"> The 16 bits are sent in network order (MSB first) and count 1/8000 th of a</span>
<span class="cm"> second. This causes a wrap around each 8,192 seconds. There is no requirement</span>
<span class="cm"> for the initial &quot;Time Base&quot;, but 0 should be used for the first packet.</span>
<span class="cm"> In case of HDLC data, this timestamp counts the packet or byte number.</span>


<span class="cm"> Two Timers:</span>

<span class="cm"> After initialisation, a timer of 15 seconds is started. Whenever a packet is</span>
<span class="cm"> transmitted, the timer is reset to 15 seconds again. If the timer expires, an</span>
<span class="cm"> empty packet is transmitted. This keep the connection alive.</span>

<span class="cm"> When a valid packet is received, a timer 65 seconds is started. The interface</span>
<span class="cm"> become ACTIVE. If the timer expires, the interface becomes INACTIVE.</span>


<span class="cm"> Dynamic IP handling:</span>

<span class="cm"> To allow dynamic IP, the ID must be non 0. In this case, any packet with the</span>
<span class="cm"> correct port number and ID will be accepted. If the remote side changes its IP</span>
<span class="cm"> the new IP is used for all transmitted packets until it changes again.</span>


<span class="cm"> On Demand:</span>

<span class="cm"> If the ondemand parameter is given, the remote IP is set to 0 on timeout.</span>
<span class="cm"> This will stop keepalive traffic to remote. If the remote is online again,</span>
<span class="cm"> traffic will continue to the remote address. This is useful for road warriors.</span>
<span class="cm"> This feature only works with ID set, otherwhise it is highly unsecure.</span>


<span class="cm"> Socket and Thread</span>
<span class="cm"> -----------------</span>

<span class="cm"> The complete socket opening and closing is done by a thread.</span>
<span class="cm"> When the thread opened a socket, the hc-&gt;socket descriptor is set. Whenever a</span>
<span class="cm"> packet shall be sent to the socket, the hc-&gt;socket must be checked wheter not</span>
<span class="cm"> NULL. To prevent change in socket descriptor, the hc-&gt;socket_lock must be used.</span>
<span class="cm"> To change the socket, a recall of l1oip_socket_open() will safely kill the</span>
<span class="cm"> socket process and create a new one.</span>

<span class="cm">*/</span>

<span class="cp">#define L1OIP_VERSION	0	</span><span class="cm">/* 0...3 */</span><span class="cp"></span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNif.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNhw.h&gt;</span>
<span class="cp">#include &lt;linux/mISDNdsp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>
<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;l1oip.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">l1oip_revision</span> <span class="o">=</span> <span class="s">&quot;2.00&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">l1oip_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">l1oip_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">l1oip_ilist</span><span class="p">;</span>

<span class="cp">#define MAX_CARDS	16</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">type</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">codec</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">ip</span><span class="p">[</span><span class="n">MAX_CARDS</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">port</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">remoteport</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">ondemand</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">limit</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">id</span><span class="p">[</span><span class="n">MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ulaw</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andreas Eversberg&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">codec</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">remoteport</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">ondemand</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ulaw</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * send a frame via socket, if open and restart timer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l1oip_socket_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">localcodec</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u32</span> <span class="n">chanmask</span><span class="p">,</span>
		  <span class="n">u16</span> <span class="n">timebase</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">multi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frame</span><span class="p">[</span><span class="n">len</span> <span class="o">+</span> <span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: sending data to socket (len = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

	<span class="cm">/* restart timer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">.</span><span class="n">expires</span><span class="o">-</span><span class="n">jiffies</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">L1OIP_KEEPALIVE</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">L1OIP_KEEPALIVE</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: resetting timer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* drop if we have no remote ip or port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dropping frame, because remote &quot;</span>
			       <span class="s">&quot;IP is not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* assemble frame */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">L1OIP_VERSION</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="cm">/* version and coding */</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pri</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">)</span> <span class="cm">/* type */</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">)</span> <span class="cm">/* id */</span>
		<span class="o">|</span> <span class="n">localcodec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">;</span> <span class="cm">/* id */</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">multi</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span> <span class="cm">/* m-flag, channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">multi</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* length */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">timebase</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* time base */</span>
	<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">timebase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* add data to frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">localcodec</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ulaw</span><span class="p">)</span>
			<span class="n">l1oip_ulaw_to_alaw</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">localcodec</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ulaw</span><span class="p">)</span>
			<span class="n">l1oip_alaw_to_ulaw</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">localcodec</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">l1oip_law_to_4bit</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">codecstate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">frame</span><span class="p">;</span>

	<span class="cm">/* check for socket in safe condition */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* seize socket */</span>
	<span class="n">socket</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
	<span class="cm">/* send packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: sending packet to socket (len &quot;</span>
		       <span class="s">&quot;= %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendiov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendiov</span><span class="p">.</span><span class="n">iov_len</span>  <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">kernel_sendmsg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendiov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="cm">/* give socket back */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">;</span> <span class="cm">/* no locking required */</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * receive channel data from socket</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l1oip_socket_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">remotecodec</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u16</span> <span class="n">timebase</span><span class="p">,</span>
		  <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_counter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: received empty keepalive data, &quot;</span>
			       <span class="s">&quot;ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: received data, sending to mISDN (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - channel %d out of &quot;</span>
		       <span class="s">&quot;range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>
	<span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - channel %d not in &quot;</span>
		       <span class="s">&quot;stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare message */</span>
	<span class="n">nskb</span> <span class="o">=</span> <span class="n">mI_alloc_skb</span><span class="p">((</span><span class="n">remotecodec</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: No mem for skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="p">(</span><span class="n">remotecodec</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remotecodec</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ulaw</span><span class="p">)</span>
		<span class="n">l1oip_alaw_to_ulaw</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">remotecodec</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ulaw</span><span class="p">)</span>
		<span class="n">l1oip_ulaw_to_alaw</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">remotecodec</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">l1oip_4bit_to_law</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* send message up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
		<span class="n">recv_Dchannel</span><span class="p">(</span><span class="n">dch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* expand 16 bit sequence number to 32 bit sequence number */</span>
		<span class="n">rx_counter</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">rx_counter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">s16</span><span class="p">)(</span><span class="n">timebase</span> <span class="o">-</span> <span class="n">rx_counter</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* time has changed forward */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timebase</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">rx_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">))</span>
				<span class="n">rx_counter</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">rx_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="n">timebase</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rx_counter</span> <span class="o">=</span> <span class="p">((</span><span class="n">rx_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x10000</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">timebase</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* time has changed backwards */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timebase</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rx_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">))</span>
				<span class="n">rx_counter</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">rx_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">|</span> <span class="n">timebase</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rx_counter</span> <span class="o">=</span> <span class="p">((</span><span class="n">rx_counter</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10000</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">timebase</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">rx_counter</span> <span class="o">=</span> <span class="n">rx_counter</span><span class="p">;</span>

<span class="cp">#ifdef REORDER_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">disorder_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">disorder_skb</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">disorder_skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
			<span class="n">nskb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">disorder_cnt</span><span class="p">;</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">disorder_cnt</span> <span class="o">=</span> <span class="n">rx_counter</span><span class="p">;</span>
			<span class="n">rx_counter</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">disorder_flag</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nskb</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_IND</span><span class="p">,</span> <span class="n">rx_counter</span><span class="p">,</span> <span class="n">nskb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * parse frame and extract channel data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l1oip_socket_parse</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="n">sin</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>			<span class="n">packet_id</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">channel</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">remotecodec</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">timebase</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">m</span><span class="p">,</span> <span class="n">mlen</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">len_start</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* initial frame length */</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: received frame, parsing... (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* check length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - length %d below &quot;</span>
		       <span class="s">&quot;4 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check version */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="n">L1OIP_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - unknown version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check type */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - received E1 packet &quot;</span>
		       <span class="s">&quot;on S0 interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - received S0 packet &quot;</span>
		       <span class="s">&quot;on E1 interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get id flag */</span>
	<span class="n">packet_id</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* check coding */</span>
	<span class="n">remotecodec</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remotecodec</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - remotecodec %d &quot;</span>
		       <span class="s">&quot;unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">remotecodec</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
	<span class="n">len</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* check packet_id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - packet has id &quot;</span>
			       <span class="s">&quot;0x%x, but we have not</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">packet_id</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - packet too &quot;</span>
			       <span class="s">&quot;short for ID value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">packet_id</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">packet_id</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">packet_id</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">packet_id</span> <span class="o">+=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">packet_id</span> <span class="o">!=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - ID mismatch, &quot;</span>
			       <span class="s">&quot;got 0x%x, we 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">packet_id</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - packet has no &quot;</span>
			       <span class="s">&quot;ID, but we have</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">multiframe:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - packet too short, &quot;</span>
		       <span class="s">&quot;channel expected at position %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="n">len_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get channel and multiframe flag */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
	<span class="n">len</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* check length on multiframe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - packet too &quot;</span>
			       <span class="s">&quot;short, length expected at position %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">len_start</span> <span class="o">-</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mlen</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">mlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - length %d at &quot;</span>
			       <span class="s">&quot;position %d exceeds total length %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">mlen</span><span class="p">,</span> <span class="n">len_start</span><span class="o">-</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">len_start</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">mlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - length %d at &quot;</span>
			       <span class="s">&quot;position %d will not allow additional &quot;</span>
			       <span class="s">&quot;packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">mlen</span><span class="p">,</span> <span class="n">len_start</span><span class="o">-</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* single frame, subtract timebase */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: packet error - packet too short, time &quot;</span>
		       <span class="s">&quot;base expected at position %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="n">len_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get time base */</span>
	<span class="n">timebase</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">timebase</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="o">++</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* if inactive, we send up a PH_ACTIVATE and activate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: interface become active due to &quot;</span>
			       <span class="s">&quot;received packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* distribute packet */</span>
	<span class="n">l1oip_socket_recv</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">remotecodec</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">timebase</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">mlen</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">mlen</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">mlen</span><span class="p">;</span>

	<span class="cm">/* multiframe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">multiframe</span><span class="p">;</span>

	<span class="cm">/* restart timer */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">.</span><span class="n">expires</span><span class="o">-</span><span class="n">jiffies</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">||</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">L1OIP_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* only adjust timer */</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">L1OIP_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="cm">/* if ip or source port changes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">!=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">!=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: remote address changes from &quot;</span>
			       <span class="s">&quot;0x%08x to 0x%08x (port %d to %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">ntohl</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
			       <span class="n">ntohl</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">),</span>
			       <span class="n">ntohs</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_port</span><span class="p">),</span>
			       <span class="n">ntohs</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">));</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * socket stuff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l1oip_socket_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">sin_rx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">recvbuf</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">recvbuf_size</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recvlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* allocate buffer memory */</span>
	<span class="n">recvbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">recvbuf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">recvbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to alloc recvbuf.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make daemon */</span>
	<span class="n">allow_signal</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">);</span>

	<span class="cm">/* create socket */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock_create</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">IPPROTO_UDP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to create socket.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set incoming address */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_local</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_local</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_local</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span><span class="p">);</span>

	<span class="cm">/* set outgoing address */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span><span class="p">);</span>

	<span class="cm">/* bind to incomming port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bind</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_local</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_local</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed to bind socket to port %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check sk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: socket-&gt;sk == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* build receive message */</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sin_rx</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sin_rx</span><span class="p">);</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* build send message */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">.</span><span class="n">msg_name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">.</span><span class="n">msg_namelen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sendmsg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* give away socket */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>

	<span class="cm">/* read loop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: socket created and open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">kvec</span> <span class="n">iov</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">recvbuf</span><span class="p">,</span>
			<span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">recvbuf_size</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="n">recvlen</span> <span class="o">=</span> <span class="n">kernel_recvmsg</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					 <span class="n">recvbuf_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recvlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l1oip_socket_parse</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin_rx</span><span class="p">,</span> <span class="n">recvbuf</span><span class="p">,</span> <span class="n">recvlen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				       <span class="s">&quot;%s: broken pipe on socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* get socket back, check first if in use, maybe by send function */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
	<span class="cm">/* if hc-&gt;socket is NULL, it is in use until it is given back */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: socket thread terminating</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>

<span class="nl">fail:</span>
	<span class="cm">/* free recvbuf */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">recvbuf</span><span class="p">);</span>

	<span class="cm">/* close socket */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">)</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

	<span class="cm">/* if we got killed, signal completion */</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_complete</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* show termination of thread */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: socket thread terminated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l1oip_socket_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>

	<span class="cm">/* kill thread */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: socket thread exists, &quot;</span>
			       <span class="s">&quot;killing...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">send_sig</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_complete</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if active, we send up a PH_DEACTIVATE and deactivate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: interface become deactivated &quot;</span>
			       <span class="s">&quot;due to timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l1oip_socket_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* in case of reopen, we need to close first */</span>
	<span class="n">l1oip_socket_close</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_complete</span><span class="p">);</span>

	<span class="cm">/* create receive process */</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">l1oip_socket_thread</span><span class="p">,</span> <span class="n">hc</span><span class="p">,</span> <span class="s">&quot;l1oip_%s&quot;</span><span class="p">,</span>
					<span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Failed (%d) to create socket process.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">sock_release</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: socket thread created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l1oip_send_bh</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">l1oip</span><span class="p">,</span> <span class="n">workq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: keepalive timer expired, sending empty &quot;</span>
		       <span class="s">&quot;frame on dchannel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* send an empty l1oip frame at D-channel */</span>
	<span class="n">l1oip_socket_send</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * timer stuff</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l1oip_keepalive</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l1oip_timeout</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l1oip</span>			<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">].</span><span class="n">dch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: timeout timer expired, turn layer one &quot;</span>
		       <span class="s">&quot;down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* state that timer must be initialized next time */</span>

	<span class="cm">/* if timeout, we send up a PH_DEACTIVATE and deactivate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: interface become deactivated &quot;</span>
			       <span class="s">&quot;due to timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* if we have ondemand set, we remove ip address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ondemand</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: on demand causes ip address to &quot;</span>
			       <span class="s">&quot;be removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">sin_remote</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * message handling</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">handle_dmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">l1oip</span>			<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">l</span><span class="p">,</span> <span class="n">ll</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_DFRAME_LEN_L1</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">L1OIP_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* send frame */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ll</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">L1OIP_MAX_PERFRAME</span><span class="p">)</span> <span class="o">?</span> <span class="n">l</span> <span class="o">:</span> <span class="n">L1OIP_MAX_PERFRAME</span><span class="p">;</span>
			<span class="n">l1oip_socket_send</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">tx_counter</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ll</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">ll</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">-=</span> <span class="n">ll</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_CNF</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PH_ACTIVATE channel %d (1..%d)</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PH_DEACTIVATE channel %d &quot;</span>
			       <span class="s">&quot;(1..%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span>
			       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_dctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l1oip</span>	<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_GETOP</span>:
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_SETPEER</span> <span class="o">|</span> <span class="n">MISDN_CTRL_UNSETPEER</span>
			<span class="o">|</span> <span class="n">MISDN_CTRL_GETPEER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_SETPEER</span>:
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span><span class="p">)</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: got new ip address from user &quot;</span>
			       <span class="s">&quot;space.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">l1oip_socket_open</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_UNSETPEER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: removing ip address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">l1oip_socket_open</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_GETPEER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: getting ip address.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span><span class="p">;</span>
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span> <span class="o">|</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown Op %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_dchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dev(%d) open from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: change protocol %x to %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">_queue_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">MISDN_ID_ANY</span><span class="p">,</span>
			    <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span> <span class="o">*</span><span class="n">dch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">channel_req</span> <span class="o">*</span><span class="n">rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_channelmap</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">channelmap</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ISDN_P_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span> <span class="cm">/* BRI: 1=B1 2=B2  PRI: 1..15,17.. */</span>
	<span class="n">bch</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:internal error ch %d has no bch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* b-channel can be only open once */</span>
	<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
	<span class="n">rq</span><span class="o">-&gt;</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s:cannot get module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l1oip_dctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mISDNdevice</span>	<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDNdevice</span><span class="p">,</span> <span class="n">D</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dchannel</span>		<span class="o">*</span><span class="n">dch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dchannel</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">l1oip</span>			<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_req</span>	<span class="o">*</span><span class="n">rq</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPEN_CHANNEL</span>:
		<span class="n">rq</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISDN_P_TE_S0</span>:
		<span class="k">case</span> <span class="n">ISDN_P_NT_S0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_dchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISDN_P_TE_E1</span>:
		<span class="k">case</span> <span class="n">ISDN_P_NT_E1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_dchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">open_bchannel</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">dch</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW_OPEN</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dev(%d) close from %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
			       <span class="n">__builtin_return_address</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">channel_dctrl</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown command %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">handle_bmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>		<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">l1oip</span>			<span class="o">*</span><span class="n">hc</span> <span class="o">=</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mISDNhead</span>	<span class="o">*</span><span class="n">hh</span> <span class="o">=</span> <span class="n">mISDN_HEAD_P</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">l</span><span class="p">,</span> <span class="n">ll</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hh</span><span class="o">-&gt;</span><span class="n">prim</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PH_DATA_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_DFRAME_LEN_L1</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">L1OIP_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: skb too large</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check for AIS / ulaw-silence */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memchr_inv</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: got AIS, not sending, &quot;</span>
				       <span class="s">&quot;but counting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">tx_counter</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_CNF</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* check for silence */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memchr_inv</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: got silence, not sending&quot;</span>
				       <span class="s">&quot;, but counting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">tx_counter</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_CNF</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* send frame */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ll</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="n">L1OIP_MAX_PERFRAME</span><span class="p">)</span> <span class="o">?</span> <span class="n">l</span> <span class="o">:</span> <span class="n">L1OIP_MAX_PERFRAME</span><span class="p">;</span>
			<span class="n">l1oip_socket_send</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">tx_counter</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ll</span><span class="p">);</span>
			<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">tx_counter</span> <span class="o">+=</span> <span class="n">ll</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">ll</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">-=</span> <span class="n">ll</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DATA_CNF</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_ACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PH_ACTIVATE channel %d (1..%d)</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">].</span><span class="n">codecstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_ACTIVATE_IND</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PH_DEACTIVATE_REQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DEBUG_L1OIP_MSG</span> <span class="o">|</span> <span class="n">DEBUG_L1OIP_SOCKET</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: PH_DEACTIVATE channel %d &quot;</span>
			       <span class="s">&quot;(1..%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span>
			       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">queue_ch_frame</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">PH_DEACTIVATE_IND</span><span class="p">,</span> <span class="n">hh</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">channel_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span> <span class="o">*</span><span class="n">bch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mISDN_ctrl_req</span> <span class="o">*</span><span class="n">cq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_features</span>	<span class="o">*</span><span class="n">features</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">dsp_features</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_GETOP</span>:
		<span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">MISDN_CTRL_HW_FEATURES_OP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MISDN_CTRL_HW_FEATURES</span>: <span class="cm">/* fill features structure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_MSG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HW_FEATURE request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* create confirm */</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">unclocked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">features</span><span class="o">-&gt;</span><span class="n">unordered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown Op %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">l1oip_bctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mISDNchannel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bchannel</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_HW</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd:%x %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOSE_CHANNEL</span>:
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_OPEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">FLG_ACTIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">Flags</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ISDN_P_NONE</span><span class="p">;</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">peer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CONTROL_CHANNEL</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">channel_bctrl</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: unknown prim(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * cleanup module and stack</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">release_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ch</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_thread</span><span class="p">)</span>
		<span class="n">l1oip_socket_close</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">].</span><span class="n">dch</span><span class="p">)</span>
		<span class="n">mISDN_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">].</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mISDN_freedchannel</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">dch</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mISDN_freebchannel</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">bch</span><span class="p">);</span>
<span class="cp">#ifdef REORDER_DEBUG</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">disorder_skb</span><span class="p">)</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="n">disorder_skb</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l1oip_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l1oip_lock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">l1oip_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l1oip_ilist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">release_card</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>

	<span class="n">l1oip_4bit_free</span><span class="p">();</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * module and stack init</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span> <span class="o">*</span><span class="n">hc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bundle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dchannel</span>	<span class="o">*</span><span class="n">dch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bchannel</span>	<span class="o">*</span><span class="n">bch</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">socket_lock</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">l1oip_cnt</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">pri</span> <span class="o">=</span> <span class="n">pri</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span> <span class="o">=</span> <span class="n">pri</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">=</span> <span class="n">pri</span> <span class="o">?</span> <span class="mi">30</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">bundle</span> <span class="o">=</span> <span class="n">bundle</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">pri</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;l1oip-e1.%d&quot;</span><span class="p">,</span> <span class="n">l1oip_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;l1oip-s0.%d&quot;</span><span class="p">,</span> <span class="n">l1oip_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">codec</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* as is */</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* alaw */</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* ulaw */</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* 4bit */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Codec(%d) not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">codec</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">codec</span> <span class="o">=</span> <span class="n">codec</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: using codec %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">codec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning: No &#39;id&#39; value given or &quot;</span>
		       <span class="s">&quot;0, this is highly unsecure. Please use 32 &quot;</span>
		       <span class="s">&quot;bit randmom number 0x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: using id 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">ondemand</span> <span class="o">=</span> <span class="n">ondemand</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">ondemand</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ondemand option only allowed in &quot;</span>
		       <span class="s">&quot;conjunction with non 0 ID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">])</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">=</span> <span class="n">limit</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pri</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Maximum limit for BRI interface is 2 &quot;</span>
		       <span class="s">&quot;channels.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pri</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">&gt;</span> <span class="mi">126</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Maximum limit for PRI interface is 126 &quot;</span>
		       <span class="s">&quot;channels.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pri</span> <span class="o">&amp;&amp;</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Maximum limit for BRI interface is 30 &quot;</span>
		       <span class="s">&quot;channels.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Your selection of %d channels must be &quot;</span>
		       <span class="s">&quot;supported by application.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span> <span class="o">=</span> <span class="n">ip</span><span class="p">[</span><span class="n">l1oip_cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span>
		<span class="o">|</span> <span class="n">ip</span><span class="p">[(</span><span class="n">l1oip_cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
		<span class="o">|</span> <span class="n">ip</span><span class="p">[(</span><span class="n">l1oip_cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
		<span class="o">|</span> <span class="n">ip</span><span class="p">[(</span><span class="n">l1oip_cnt</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">]</span><span class="o">?:</span><span class="p">(</span><span class="n">L1OIP_DEFAULTPORT</span> <span class="o">+</span> <span class="n">l1oip_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remoteport</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">])</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span> <span class="o">=</span> <span class="n">remoteport</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: using local port %d remote ip &quot;</span>
		       <span class="s">&quot;%d.%d.%d.%d port %d ondemand %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">localport</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteip</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		       <span class="n">hc</span><span class="o">-&gt;</span><span class="n">remoteport</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">ondemand</span><span class="p">);</span>

	<span class="n">dch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dchannel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dch</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
	<span class="n">mISDN_initdchannel</span><span class="p">(</span><span class="n">dch</span><span class="p">,</span> <span class="n">MAX_DFRAME_LEN_L1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pri</span><span class="p">)</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">Dprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_TE_E1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_NT_E1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">Dprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_TE_S0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ISDN_P_NT_S0</span><span class="p">);</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">Bprotocols</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_RAW</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ISDN_P_B_HDLC</span> <span class="o">&amp;</span> <span class="n">ISDN_P_B_MASK</span><span class="p">));</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">handle_dmsg</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">D</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">l1oip_dctrl</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">b_num</span><span class="p">;</span>
	<span class="n">dch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">d_idx</span><span class="p">].</span><span class="n">dch</span> <span class="o">=</span> <span class="n">dch</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">nrbchan</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bch</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bchannel</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bch</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no memory for bchannel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>
		<span class="n">mISDN_initbchannel</span><span class="p">(</span><span class="n">bch</span><span class="p">,</span> <span class="n">MAX_DATA_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hc</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">handle_bmsg</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">l1oip_bctrl</span><span class="p">;</span>
		<span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">nr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bchannels</span><span class="p">);</span>
		<span class="n">hc</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ch</span><span class="p">].</span><span class="n">bch</span> <span class="o">=</span> <span class="n">bch</span><span class="p">;</span>
		<span class="n">set_channelmap</span><span class="p">(</span><span class="n">bch</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">channelmap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* TODO: create a parent device for this driver */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mISDN_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dch</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_INIT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Setting up network card(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">l1oip_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">l1oip_socket_open</span><span class="p">(</span><span class="n">hc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">l1oip_keepalive</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">hc</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span> <span class="cm">/* two seconds first time */</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">keep_tl</span><span class="p">);</span>

	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">l1oip_timeout</span><span class="p">;</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span><span class="n">hc</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_tl</span><span class="p">);</span>
	<span class="n">hc</span><span class="o">-&gt;</span><span class="n">timeout_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* state that we have timer off */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">l1oip_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">pri</span><span class="p">,</span> <span class="n">bundle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">l1oip</span>		<span class="o">*</span><span class="n">hc</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mISDN: Layer-1-over-IP driver Rev. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">l1oip_revision</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l1oip_ilist</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l1oip_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">l1oip_4bit_alloc</span><span class="p">(</span><span class="n">ulaw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">l1oip_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">l1oip_cnt</span> <span class="o">&lt;</span> <span class="n">MAX_CARDS</span> <span class="o">&amp;&amp;</span> <span class="n">type</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bundle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">pri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bundle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bundle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">pri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bundle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Card type(%d) not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">type</span><span class="p">[</span><span class="n">l1oip_cnt</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">l1oip_cleanup</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DEBUG_L1OIP_INIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: interface %d is %s with %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">l1oip_cnt</span><span class="p">,</span> <span class="n">pri</span> <span class="o">?</span> <span class="s">&quot;PRI&quot;</span> <span class="o">:</span> <span class="s">&quot;BRI&quot;</span><span class="p">,</span>
			       <span class="n">bundle</span> <span class="o">?</span> <span class="s">&quot;bundled IP packet for all B-channels&quot;</span> <span class="o">:</span>
			       <span class="s">&quot;separate IP packets for every B-channel&quot;</span><span class="p">);</span>

		<span class="n">hc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">l1oip</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No kmem for L1-over-IP driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">l1oip_cleanup</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">workq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">l1oip_send_bh</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l1oip_lock</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hc</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l1oip_ilist</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l1oip_lock</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">init_card</span><span class="p">(</span><span class="n">hc</span><span class="p">,</span> <span class="n">pri</span><span class="p">,</span> <span class="n">bundle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l1oip_cleanup</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">l1oip_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%d virtual devices registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l1oip_cnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">l1oip_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">l1oip_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
