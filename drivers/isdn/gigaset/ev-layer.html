<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › gigaset › ev-layer.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ev-layer.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Stuff used by all variants of the driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 by Stefan Eilers,</span>
<span class="cm"> *                       Hansjoerg Lipp &lt;hjlipp@web.de&gt;,</span>
<span class="cm"> *                       Tilman Schmidt &lt;tilman@imap.cc&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *	the License, or (at your option) any later version.</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;gigaset.h&quot;</span>

<span class="cm">/* ========================================================== */</span>
<span class="cm">/* bit masks for pending commands */</span>
<span class="cp">#define PC_DIAL		0x001</span>
<span class="cp">#define PC_HUP		0x002</span>
<span class="cp">#define PC_INIT		0x004</span>
<span class="cp">#define PC_DLE0		0x008</span>
<span class="cp">#define PC_DLE1		0x010</span>
<span class="cp">#define PC_SHUTDOWN	0x020</span>
<span class="cp">#define PC_ACCEPT	0x040</span>
<span class="cp">#define PC_CID		0x080</span>
<span class="cp">#define PC_NOCID	0x100</span>
<span class="cp">#define PC_CIDMODE	0x200</span>
<span class="cp">#define PC_UMMODE	0x400</span>

<span class="cm">/* types of modem responses */</span>
<span class="cp">#define RT_NOTHING	0</span>
<span class="cp">#define RT_ZSAU		1</span>
<span class="cp">#define RT_RING		2</span>
<span class="cp">#define RT_NUMBER	3</span>
<span class="cp">#define RT_STRING	4</span>
<span class="cp">#define RT_ZCAU		6</span>

<span class="cm">/* Possible ASCII responses */</span>
<span class="cp">#define RSP_OK		0</span>
<span class="cp">#define RSP_ERROR	1</span>
<span class="cp">#define RSP_ZGCI	3</span>
<span class="cp">#define RSP_RING	4</span>
<span class="cp">#define RSP_ZVLS	5</span>
<span class="cp">#define RSP_ZCAU	6</span>

<span class="cm">/* responses with values to store in at_state */</span>
<span class="cm">/* - numeric */</span>
<span class="cp">#define RSP_VAR		100</span>
<span class="cp">#define RSP_ZSAU	(RSP_VAR + VAR_ZSAU)</span>
<span class="cp">#define RSP_ZDLE	(RSP_VAR + VAR_ZDLE)</span>
<span class="cp">#define RSP_ZCTP	(RSP_VAR + VAR_ZCTP)</span>
<span class="cm">/* - string */</span>
<span class="cp">#define RSP_STR		(RSP_VAR + VAR_NUM)</span>
<span class="cp">#define RSP_NMBR	(RSP_STR + STR_NMBR)</span>
<span class="cp">#define RSP_ZCPN	(RSP_STR + STR_ZCPN)</span>
<span class="cp">#define RSP_ZCON	(RSP_STR + STR_ZCON)</span>
<span class="cp">#define RSP_ZBC		(RSP_STR + STR_ZBC)</span>
<span class="cp">#define RSP_ZHLC	(RSP_STR + STR_ZHLC)</span>

<span class="cp">#define RSP_WRONG_CID	-2	</span><span class="cm">/* unknown cid in cmd */</span><span class="cp"></span>
<span class="cp">#define RSP_INVAL	-6	</span><span class="cm">/* invalid response   */</span><span class="cp"></span>
<span class="cp">#define RSP_NODEV	-9	</span><span class="cm">/* device not connected */</span><span class="cp"></span>

<span class="cp">#define RSP_NONE	-19</span>
<span class="cp">#define RSP_STRING	-20</span>
<span class="cp">#define RSP_NULL	-21</span>
<span class="cp">#define RSP_INIT	-27</span>
<span class="cp">#define RSP_ANY		-26</span>
<span class="cp">#define RSP_LAST	-28</span>

<span class="cm">/* actions for process_response */</span>
<span class="cp">#define ACT_NOTHING		0</span>
<span class="cp">#define ACT_SETDLE1		1</span>
<span class="cp">#define ACT_SETDLE0		2</span>
<span class="cp">#define ACT_FAILINIT		3</span>
<span class="cp">#define ACT_HUPMODEM		4</span>
<span class="cp">#define ACT_CONFIGMODE		5</span>
<span class="cp">#define ACT_INIT		6</span>
<span class="cp">#define ACT_DLE0		7</span>
<span class="cp">#define ACT_DLE1		8</span>
<span class="cp">#define ACT_FAILDLE0		9</span>
<span class="cp">#define ACT_FAILDLE1		10</span>
<span class="cp">#define ACT_RING		11</span>
<span class="cp">#define ACT_CID			12</span>
<span class="cp">#define ACT_FAILCID		13</span>
<span class="cp">#define ACT_SDOWN		14</span>
<span class="cp">#define ACT_FAILSDOWN		15</span>
<span class="cp">#define ACT_DEBUG		16</span>
<span class="cp">#define ACT_WARN		17</span>
<span class="cp">#define ACT_DIALING		18</span>
<span class="cp">#define ACT_ABORTDIAL		19</span>
<span class="cp">#define ACT_DISCONNECT		20</span>
<span class="cp">#define ACT_CONNECT		21</span>
<span class="cp">#define ACT_REMOTEREJECT	22</span>
<span class="cp">#define ACT_CONNTIMEOUT		23</span>
<span class="cp">#define ACT_REMOTEHUP		24</span>
<span class="cp">#define ACT_ABORTHUP		25</span>
<span class="cp">#define ACT_ICALL		26</span>
<span class="cp">#define ACT_ACCEPTED		27</span>
<span class="cp">#define ACT_ABORTACCEPT		28</span>
<span class="cp">#define ACT_TIMEOUT		29</span>
<span class="cp">#define ACT_GETSTRING		30</span>
<span class="cp">#define ACT_SETVER		31</span>
<span class="cp">#define ACT_FAILVER		32</span>
<span class="cp">#define ACT_GOTVER		33</span>
<span class="cp">#define ACT_TEST		34</span>
<span class="cp">#define ACT_ERROR		35</span>
<span class="cp">#define ACT_ABORTCID		36</span>
<span class="cp">#define ACT_ZCAU		37</span>
<span class="cp">#define ACT_NOTIFY_BC_DOWN	38</span>
<span class="cp">#define ACT_NOTIFY_BC_UP	39</span>
<span class="cp">#define ACT_DIAL		40</span>
<span class="cp">#define ACT_ACCEPT		41</span>
<span class="cp">#define ACT_HUP			43</span>
<span class="cp">#define ACT_IF_LOCK		44</span>
<span class="cp">#define ACT_START		45</span>
<span class="cp">#define ACT_STOP		46</span>
<span class="cp">#define ACT_FAKEDLE0		47</span>
<span class="cp">#define ACT_FAKEHUP		48</span>
<span class="cp">#define ACT_FAKESDOWN		49</span>
<span class="cp">#define ACT_SHUTDOWN		50</span>
<span class="cp">#define ACT_PROC_CIDMODE	51</span>
<span class="cp">#define ACT_UMODESET		52</span>
<span class="cp">#define ACT_FAILUMODE		53</span>
<span class="cp">#define ACT_CMODESET		54</span>
<span class="cp">#define ACT_FAILCMODE		55</span>
<span class="cp">#define ACT_IF_VER		56</span>
<span class="cp">#define ACT_CMD			100</span>

<span class="cm">/* at command sequences */</span>
<span class="cp">#define SEQ_NONE	0</span>
<span class="cp">#define SEQ_INIT	100</span>
<span class="cp">#define SEQ_DLE0	200</span>
<span class="cp">#define SEQ_DLE1	250</span>
<span class="cp">#define SEQ_CID		300</span>
<span class="cp">#define SEQ_NOCID	350</span>
<span class="cp">#define SEQ_HUP		400</span>
<span class="cp">#define SEQ_DIAL	600</span>
<span class="cp">#define SEQ_ACCEPT	720</span>
<span class="cp">#define SEQ_SHUTDOWN	500</span>
<span class="cp">#define SEQ_CIDMODE	10</span>
<span class="cp">#define SEQ_UMMODE	11</span>


<span class="cm">/* 100: init, 200: dle0, 250:dle1, 300: get cid (dial), 350: &quot;hup&quot; (no cid),</span>
<span class="cm"> * 400: hup, 500: reset, 600: dial, 700: ring */</span>
<span class="k">struct</span> <span class="n">reply_t</span> <span class="n">gigaset_tab_nocid</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cm">/* resp_code, min_ConState, max_ConState, parameter, new_ConState, timeout,</span>
<span class="cm"> * action, command */</span>

<span class="cm">/* initialize device, set cid mode if possible */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SEQ_INIT</span><span class="p">,</span>	<span class="mi">100</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_TIMEOUT</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">101</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;Z</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">101</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">120</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_GETSTRING</span><span class="p">},</span>
								<span class="s">&quot;+GMR</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">101</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">102</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;Z</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">101</span><span class="p">,</span> <span class="mi">101</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">102</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;Z</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">102</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">108</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_SETDLE1</span><span class="p">},</span>
								<span class="s">&quot;^SDLE=0</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">108</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">104</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZDLE</span><span class="p">,</span>	<span class="mi">104</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>		<span class="mi">103</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;Z</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">104</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILINIT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">108</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILINIT</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">108</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">105</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_SETDLE0</span><span class="p">,</span>
							  <span class="n">ACT_HUPMODEM</span><span class="p">,</span>
							  <span class="n">ACT_TIMEOUT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">105</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">103</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;Z</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>

	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">102</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">107</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;^GETPRE</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">107</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CONFIGMODE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">107</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILINIT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">107</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILINIT</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">103</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILINIT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">103</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILINIT</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">RSP_STRING</span><span class="p">,</span>	<span class="mi">120</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">121</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_SETVER</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">120</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILVER</span><span class="p">,</span>
							  <span class="n">ACT_INIT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">120</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILVER</span><span class="p">,</span>
							  <span class="n">ACT_INIT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">121</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_GOTVER</span><span class="p">,</span>
							  <span class="n">ACT_INIT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NONE</span><span class="p">,</span>	<span class="mi">121</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">120</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_GETSTRING</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* leave dle mode */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_DLE0</span><span class="p">,</span>	<span class="mi">201</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;^SDLE=0</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">201</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">202</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZDLE</span><span class="p">,</span>	<span class="mi">202</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DLE0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NODEV</span><span class="p">,</span>	<span class="mi">200</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAKEDLE0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">200</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILDLE0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">200</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILDLE0</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* enter dle mode */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_DLE1</span><span class="p">,</span>	<span class="mi">251</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;^SDLE=1</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">251</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">252</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZDLE</span><span class="p">,</span>	<span class="mi">252</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DLE1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">250</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILDLE1</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">250</span><span class="p">,</span> <span class="mi">299</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILDLE1</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* incoming call */</span>
	<span class="p">{</span><span class="n">RSP_RING</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_RING</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* get cid */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_CID</span><span class="p">,</span>	<span class="mi">301</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;^SGCI?</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">301</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">302</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZGCI</span><span class="p">,</span>	<span class="mi">302</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CID</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">301</span><span class="p">,</span> <span class="mi">349</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILCID</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">301</span><span class="p">,</span> <span class="mi">349</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILCID</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* enter cid mode */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_CIDMODE</span><span class="p">,</span>	<span class="mi">150</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;^SGCI=1</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMODESET</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILCMODE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILCMODE</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* leave cid mode */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_UMMODE</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;Z</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_UMODESET</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILUMODE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">160</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILUMODE</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* abort getting cid */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_NOCID</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTCID</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* reset */</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_SHUTDOWN</span><span class="p">,</span>	<span class="mi">504</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;Z</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">504</span><span class="p">,</span> <span class="mi">504</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_SDOWN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">501</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILSDOWN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">501</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAILSDOWN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NODEV</span><span class="p">,</span>	<span class="mi">501</span><span class="p">,</span> <span class="mi">599</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAKESDOWN</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">EV_PROC_CIDMODE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_PROC_CIDMODE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_IF_LOCK</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_IF_LOCK</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_IF_VER</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_IF_VER</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_START</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_START</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_STOP</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_STOP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_SHUTDOWN</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_SHUTDOWN</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* misc. */</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ERROR</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZCAU</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ZCAU</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NONE</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ANY</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_WARN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_LAST</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* 600: start dialing, 650: dial in progress, 800: connection is up, 700: ring,</span>
<span class="cm"> * 400: hup, 750: accepted icall */</span>
<span class="k">struct</span> <span class="n">reply_t</span> <span class="n">gigaset_tab_cid</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cm">/* resp_code, min_ConState, max_ConState, parameter, new_ConState, timeout,</span>
<span class="cm"> * action, command */</span>

<span class="cm">/* dial */</span>
	<span class="p">{</span><span class="n">EV_DIAL</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DIAL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="n">SEQ_DIAL</span><span class="p">,</span>	<span class="mi">601</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_BC</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">601</span><span class="p">,</span> <span class="mi">601</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">603</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_PROTO</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">603</span><span class="p">,</span> <span class="mi">603</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">604</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_TYPE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">604</span><span class="p">,</span> <span class="mi">604</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">605</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_MSN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NULL</span><span class="p">,</span>	<span class="mi">605</span><span class="p">,</span> <span class="mi">605</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">606</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_CLIP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">605</span><span class="p">,</span> <span class="mi">605</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">606</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_CLIP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NULL</span><span class="p">,</span>	<span class="mi">606</span><span class="p">,</span> <span class="mi">606</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">607</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_ISO</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">606</span><span class="p">,</span> <span class="mi">606</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">607</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_ISO</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">607</span><span class="p">,</span> <span class="mi">607</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">608</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;+VLS=17</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">608</span><span class="p">,</span> <span class="mi">608</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">609</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">609</span><span class="p">,</span> <span class="mi">609</span><span class="p">,</span> <span class="n">ZSAU_PROCEEDING</span><span class="p">,</span> <span class="mi">610</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_DIAL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">610</span><span class="p">,</span> <span class="mi">610</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">650</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DIALING</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">601</span><span class="p">,</span> <span class="mi">610</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTDIAL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">601</span><span class="p">,</span> <span class="mi">610</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTDIAL</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* optional dialing responses */</span>
	<span class="p">{</span><span class="n">EV_BC_OPEN</span><span class="p">,</span>	<span class="mi">650</span><span class="p">,</span> <span class="mi">650</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">651</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZVLS</span><span class="p">,</span>	<span class="mi">609</span><span class="p">,</span> <span class="mi">651</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZCTP</span><span class="p">,</span>	<span class="mi">610</span><span class="p">,</span> <span class="mi">651</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZCPN</span><span class="p">,</span>	<span class="mi">610</span><span class="p">,</span> <span class="mi">651</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">650</span><span class="p">,</span> <span class="mi">651</span><span class="p">,</span> <span class="n">ZSAU_CALL_DELIVERED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* connect */</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">650</span><span class="p">,</span> <span class="mi">650</span><span class="p">,</span> <span class="n">ZSAU_ACTIVE</span><span class="p">,</span>	<span class="mi">800</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CONNECT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">651</span><span class="p">,</span> <span class="mi">651</span><span class="p">,</span> <span class="n">ZSAU_ACTIVE</span><span class="p">,</span>	<span class="mi">800</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CONNECT</span><span class="p">,</span>
							  <span class="n">ACT_NOTIFY_BC_UP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">750</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="n">ZSAU_ACTIVE</span><span class="p">,</span>	<span class="mi">800</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CONNECT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">751</span><span class="p">,</span> <span class="mi">751</span><span class="p">,</span> <span class="n">ZSAU_ACTIVE</span><span class="p">,</span>	<span class="mi">800</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CONNECT</span><span class="p">,</span>
							  <span class="n">ACT_NOTIFY_BC_UP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_BC_OPEN</span><span class="p">,</span>	<span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">800</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_NOTIFY_BC_UP</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* remote hangup */</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">650</span><span class="p">,</span> <span class="mi">651</span><span class="p">,</span> <span class="n">ZSAU_DISCONNECT_IND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_REMOTEREJECT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">750</span><span class="p">,</span> <span class="mi">751</span><span class="p">,</span> <span class="n">ZSAU_DISCONNECT_IND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_REMOTEHUP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">800</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="n">ZSAU_DISCONNECT_IND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_REMOTEHUP</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* hangup */</span>
	<span class="p">{</span><span class="n">EV_HUP</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_HUP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">SEQ_HUP</span><span class="p">,</span>	<span class="mi">401</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;+VLS=0</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">401</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">402</span><span class="p">,</span>  <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZVLS</span><span class="p">,</span>	<span class="mi">402</span><span class="p">,</span> <span class="mi">402</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>		<span class="mi">403</span><span class="p">,</span>  <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">403</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="n">ZSAU_DISCONNECT_REQ</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">403</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="n">ZSAU_NULL</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DISCONNECT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NODEV</span><span class="p">,</span>	<span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_FAKEHUP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">401</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTHUP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">401</span><span class="p">,</span> <span class="mi">403</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTHUP</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">EV_BC_CLOSED</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_NOTIFY_BC_DOWN</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* ring */</span>
	<span class="p">{</span><span class="n">RSP_ZBC</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZHLC</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NMBR</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZCPN</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZCTP</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">720</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ICALL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_BC_CLOSED</span><span class="p">,</span>	<span class="mi">720</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_NOTIFY_BC_DOWN</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/*accept icall*/</span>
	<span class="p">{</span><span class="n">EV_ACCEPT</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ACCEPT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_INIT</span><span class="p">,</span>	<span class="mi">720</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="n">SEQ_ACCEPT</span><span class="p">,</span>	<span class="mi">721</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_PROTO</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">721</span><span class="p">,</span> <span class="mi">721</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">722</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_ISO</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">722</span><span class="p">,</span> <span class="mi">722</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">723</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span>	<span class="s">&quot;+VLS=17</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_OK</span><span class="p">,</span>	<span class="mi">723</span><span class="p">,</span> <span class="mi">723</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">724</span><span class="p">,</span>  <span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZVLS</span><span class="p">,</span>	<span class="mi">724</span><span class="p">,</span> <span class="mi">724</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>		<span class="mi">750</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ACCEPTED</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="mi">721</span><span class="p">,</span> <span class="mi">729</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTACCEPT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">721</span><span class="p">,</span> <span class="mi">729</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTACCEPT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">729</span><span class="p">,</span> <span class="n">ZSAU_NULL</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTACCEPT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">729</span><span class="p">,</span> <span class="n">ZSAU_ACTIVE</span><span class="p">,</span>	  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTACCEPT</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="mi">700</span><span class="p">,</span> <span class="mi">729</span><span class="p">,</span> <span class="n">ZSAU_DISCONNECT_IND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ABORTACCEPT</span><span class="p">}</span> <span class="p">},</span>

	<span class="p">{</span><span class="n">EV_BC_OPEN</span><span class="p">,</span>	<span class="mi">750</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		<span class="mi">751</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">EV_TIMEOUT</span><span class="p">,</span>	<span class="mi">750</span><span class="p">,</span> <span class="mi">751</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_CONNTIMEOUT</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* B channel closed (general case) */</span>
	<span class="p">{</span><span class="n">EV_BC_CLOSED</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_NOTIFY_BC_DOWN</span><span class="p">}</span> <span class="p">},</span>

<span class="cm">/* misc. */</span>
	<span class="p">{</span><span class="n">RSP_ZCON</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ZCAU</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_ZCAU</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_NONE</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_DEBUG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_ANY</span><span class="p">,</span>	 <span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>		 <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="n">ACT_WARN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">RSP_LAST</span><span class="p">}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">resp_type_t</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">response</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">resp_code</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">type</span><span class="p">;</span>
<span class="p">}</span> <span class="n">resp_type</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;OK&quot;</span><span class="p">,</span>		<span class="n">RSP_OK</span><span class="p">,</span>		<span class="n">RT_NOTHING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ERROR&quot;</span><span class="p">,</span>	<span class="n">RSP_ERROR</span><span class="p">,</span>	<span class="n">RT_NOTHING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZSAU&quot;</span><span class="p">,</span>	<span class="n">RSP_ZSAU</span><span class="p">,</span>	<span class="n">RT_ZSAU</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZCAU&quot;</span><span class="p">,</span>	<span class="n">RSP_ZCAU</span><span class="p">,</span>	<span class="n">RT_ZCAU</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;RING&quot;</span><span class="p">,</span>	<span class="n">RSP_RING</span><span class="p">,</span>	<span class="n">RT_RING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZGCI&quot;</span><span class="p">,</span>	<span class="n">RSP_ZGCI</span><span class="p">,</span>	<span class="n">RT_NUMBER</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZVLS&quot;</span><span class="p">,</span>	<span class="n">RSP_ZVLS</span><span class="p">,</span>	<span class="n">RT_NUMBER</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZCTP&quot;</span><span class="p">,</span>	<span class="n">RSP_ZCTP</span><span class="p">,</span>	<span class="n">RT_NUMBER</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZDLE&quot;</span><span class="p">,</span>	<span class="n">RSP_ZDLE</span><span class="p">,</span>	<span class="n">RT_NUMBER</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZHLC&quot;</span><span class="p">,</span>	<span class="n">RSP_ZHLC</span><span class="p">,</span>	<span class="n">RT_STRING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZBC&quot;</span><span class="p">,</span>		<span class="n">RSP_ZBC</span><span class="p">,</span>	<span class="n">RT_STRING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NMBR&quot;</span><span class="p">,</span>	<span class="n">RSP_NMBR</span><span class="p">,</span>	<span class="n">RT_STRING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZCPN&quot;</span><span class="p">,</span>	<span class="n">RSP_ZCPN</span><span class="p">,</span>	<span class="n">RT_STRING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ZCON&quot;</span><span class="p">,</span>	<span class="n">RSP_ZCON</span><span class="p">,</span>	<span class="n">RT_STRING</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span>		<span class="mi">0</span><span class="p">,</span>		<span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zsau_resp_t</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">code</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zsau_resp</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;OUTGOING_CALL_PROCEEDING&quot;</span><span class="p">,</span>	<span class="n">ZSAU_OUTGOING_CALL_PROCEEDING</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;CALL_DELIVERED&quot;</span><span class="p">,</span>		<span class="n">ZSAU_CALL_DELIVERED</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ACTIVE&quot;</span><span class="p">,</span>			<span class="n">ZSAU_ACTIVE</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DISCONNECT_IND&quot;</span><span class="p">,</span>		<span class="n">ZSAU_DISCONNECT_IND</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;NULL&quot;</span><span class="p">,</span>			<span class="n">ZSAU_NULL</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">,</span>		<span class="n">ZSAU_DISCONNECT_REQ</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span>				<span class="n">ZSAU_UNKNOWN</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* retrieve CID from parsed response</span>
<span class="cm"> * returns 0 if no CID, -1 if invalid CID, or CID value 1..65535</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cid_of_response</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;;&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no CID separator */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">kstrtoint</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* CID not numeric */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">cid</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* CID out of range */</span>
	<span class="k">return</span> <span class="n">cid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_handle_modem_response() - process received modem response</span>
<span class="cm"> * @cs:		device descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by asyncdata/isocdata if a block of data received from the</span>
<span class="cm"> * device must be processed as a modem command response. The data is</span>
<span class="cm"> * already in the cs structure.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_handle_modem_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="n">MAX_REC_PARAMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">params</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">resp_type_t</span> <span class="o">*</span><span class="n">rt</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">zsau_resp_t</span> <span class="o">*</span><span class="n">zr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curarg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">next</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_t</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resp_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">param_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">abort</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rawstring</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cbytes</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ignore additional LFs/CRs (M10x config mode or cx100) */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="s">&quot;skipped EOL [%02X]&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">[</span><span class="n">len</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">;</span>
	<span class="n">params</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">getstring</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* getstring only allowed without cid at the moment */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">getstring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rawstring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* parse line */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;;&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;,&#39;</span>:
			<span class="k">case</span> <span class="sc">&#39;=&#39;</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">params</span> <span class="o">&gt;</span> <span class="n">MAX_REC_PARAMS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="s">&quot;too many parameters in response</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="cm">/* need last parameter (might be CID) */</span>
					<span class="n">params</span><span class="o">--</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">argv</span><span class="p">[</span><span class="n">params</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="n">rawstring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cid</span> <span class="o">=</span> <span class="n">params</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">cid_of_response</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">params</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">RSP_INVAL</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
			<span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;CMD received: %s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">--</span><span class="n">params</span><span class="p">;</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;CID: %s&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">params</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;available params: %d&quot;</span><span class="p">,</span> <span class="n">params</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;param %d: %s&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_head</span><span class="p">;</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_tail</span><span class="p">;</span>

	<span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">curarg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">curarg</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_EVENTS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">next</span> <span class="o">==</span> <span class="n">head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event queue full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">event</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">+</span> <span class="n">tail</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">at_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">event</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rawstring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resp_code</span> <span class="o">=</span> <span class="n">RSP_STRING</span><span class="p">;</span>
			<span class="n">param_type</span> <span class="o">=</span> <span class="n">RT_STRING</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">rt</span> <span class="o">=</span> <span class="n">resp_type</span><span class="p">;</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span> <span class="o">++</span><span class="n">rt</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="p">],</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">RSP_NONE</span><span class="p">;</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span>
					<span class="s">&quot;unknown modem response: &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">resp_code</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">resp_code</span><span class="p">;</span>
			<span class="n">param_type</span> <span class="o">=</span> <span class="n">rt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
			<span class="o">++</span><span class="n">curarg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">resp_code</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">param_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RT_NOTHING</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RT_RING</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;received RING without CID!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">RSP_INVAL</span><span class="p">;</span>
				<span class="n">abort</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
				<span class="n">abort</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RT_ZSAU</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">curarg</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">=</span> <span class="n">ZSAU_NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">zr</span> <span class="o">=</span> <span class="n">zsau_resp</span><span class="p">;</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">;</span> <span class="o">++</span><span class="n">zr</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="p">],</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">=</span> <span class="n">zr</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zr</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;%s: unknown parameter %s after ZSAU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="p">]);</span>
			<span class="o">++</span><span class="n">curarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RT_STRING</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">curarg</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="o">++</span><span class="n">curarg</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;string==%s&quot;</span><span class="p">,</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">?</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">:</span> <span class="s">&quot;NULL&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RT_ZCAU</span>:
			<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curarg</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

				<span class="n">i</span> <span class="o">=</span> <span class="n">kstrtou8</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="o">++</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">kstrtou8</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="o">++</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">curarg</span> <span class="o">=</span> <span class="n">params</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RT_NUMBER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">curarg</span> <span class="o">&gt;=</span> <span class="n">params</span> <span class="o">||</span>
			    <span class="n">kstrtoint</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">curarg</span><span class="o">++</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">))</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;parameter==%d&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">resp_code</span> <span class="o">==</span> <span class="n">RSP_ZDLE</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">abort</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curarg</span> <span class="o">!=</span> <span class="n">params</span><span class="p">)</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span>
			<span class="s">&quot;invalid number of processed parameters: %d/%d&quot;</span><span class="p">,</span>
			<span class="n">curarg</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gigaset_handle_modem_response</span><span class="p">);</span>

<span class="cm">/* disconnect</span>
<span class="cm"> * process closing of connection associated with given AT state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">**</span><span class="n">at_state_p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">at_state_p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">at_state_p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">++</span><span class="p">(</span><span class="o">*</span><span class="n">at_state_p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">seq_index</span><span class="p">;</span>

	<span class="cm">/* revert to selected idle mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cidmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_UMMODE</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_UMMODE&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* B channel assigned: invoke hardware specific handler */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">close_bchannel</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="cm">/* notify LL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHS_D_UP</span> <span class="o">|</span> <span class="n">CHS_NOTIFY_LL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CHS_D_UP</span> <span class="o">|</span> <span class="n">CHS_NOTIFY_LL</span><span class="p">);</span>
			<span class="n">gigaset_isdn_hupD</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no B channel assigned: just deallocate */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">at_state_p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">at_state_p</span><span class="p">);</span>
		<span class="o">*</span><span class="n">at_state_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* get_free_channel</span>
<span class="cm"> * get a free AT state structure: either one of those associated with the</span>
<span class="cm"> * B channels of the Gigaset device, or if none of those is available,</span>
<span class="cm"> * a newly allocated one with bcs=NULL</span>
<span class="cm"> * The structure should be freed by calling disconnect() after use.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">get_free_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
						  <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="cm">/* cids: &gt;0: siemens-cid</span>
<span class="cm"> *        0: without cid</span>
<span class="cm"> *       -1: no cid assigned yet</span>
<span class="cm"> */</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gigaset_get_channel</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_state</span><span class="p">;</span>
			<span class="n">ret</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_state_t</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gigaset_at_init</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ret</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">temp_at_states</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">init_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_INIT</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_UNINITIALIZED</span><span class="p">;</span>
	<span class="n">gigaset_free_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_CID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CID</span><span class="p">;</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_NOCID</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">schedule_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;not scheduling PC_INIT again&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">M_UNKNOWN</span><span class="p">;</span>
	<span class="n">gigaset_block_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_INIT</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_INIT&quot;</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add &quot;AT&quot; to a command, add the cid, dle encode it, send the result to the</span>
<span class="cm">   hardware. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">dle</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">kmallocflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span> <span class="cm">/* DLE ( A T 1 2 3 4 5 &lt;cmd&gt; DLE ) \0 */</span>
	<span class="n">cb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdbuf_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">kmallocflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cid</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
				   <span class="n">dle</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\020</span><span class="s">(AT%d%s</span><span class="se">\020</span><span class="s">)&quot;</span> <span class="o">:</span> <span class="s">&quot;AT%d%s&quot;</span><span class="p">,</span>
				   <span class="n">cid</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span>
				   <span class="n">dle</span> <span class="o">?</span> <span class="s">&quot;</span><span class="se">\020</span><span class="s">(AT%s</span><span class="se">\020</span><span class="s">)&quot;</span> <span class="o">:</span> <span class="s">&quot;AT%s&quot;</span><span class="p">,</span>
				   <span class="n">cmd</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state_from_cid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_state</span><span class="p">.</span><span class="n">cid</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_state</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">at_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">temp_at_states</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">==</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">at_state</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bchannel_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;</span> <span class="n">CHS_B_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHS_B_UP</span><span class="p">;</span>
		<span class="n">gigaset_isdn_hupB</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHS_D_UP</span> <span class="o">|</span> <span class="n">CHS_NOTIFY_LL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CHS_D_UP</span> <span class="o">|</span> <span class="n">CHS_NOTIFY_LL</span><span class="p">);</span>
		<span class="n">gigaset_isdn_hupD</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">gigaset_free_channel</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>

	<span class="n">gigaset_bcs_reinit</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">bchannel_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;</span> <span class="n">CHS_B_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: B channel already up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">|=</span> <span class="n">CHS_B_UP</span><span class="p">;</span>
	<span class="n">gigaset_isdn_connB</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">start_dial</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="n">seq_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">commands</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">|=</span> <span class="n">CHS_NOTIFY_LL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">seq_index</span> <span class="o">!=</span> <span class="n">seq_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AT_NUM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_CID</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_CID&quot;</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AT_NUM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_NOCID</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_NOCID&quot;</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">start_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AT_NUM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_PROTO</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_ISO</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_PROTO</span><span class="p">]</span> <span class="o">||</span> <span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_ISO</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* error reset */</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_HUP&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_PROTO</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&quot;^SBPR=%u</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_ISO</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&quot;^SISO=%u</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_ACCEPT</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_ACCEPT&quot;</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gigaset_free_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">!=</span> <span class="n">MS_LOCKED</span><span class="p">)</span>
		<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_INIT</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">isdn_up</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gigaset_isdn_start</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">finish_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">!=</span> <span class="n">MS_LOCKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_UNINITIALIZED</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">M_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tell the LL that the device is not available .. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">isdn_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">isdn_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gigaset_isdn_stop</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The rest is done by cleanup_cs () in user mode. */</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmd_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gigaset_block_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">==</span> <span class="n">MS_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_SHUTDOWN</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_SHUTDOWN</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_SHUTDOWN&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">finish_shutdown</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">do_shutdown</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Entering cid mode or getting a cid failed:</span>
<span class="cm"> * try to initialize the device and try again.</span>
<span class="cm"> *</span>
<span class="cm"> * channel &gt;= 0: getting cid for the channel failed</span>
<span class="cm"> * channel &lt; 0:  entering cid mode failed</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 on success, &lt;0 on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reinit_and_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_state</span><span class="p">.</span><span class="n">cid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Could not enter cid mode. Reinit device and try again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Could not get a call id. Reinit device and try again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_CID</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_INIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">at_state_invalid</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">test_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_ptr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">at_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">temp_at_states</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span> <span class="o">==</span> <span class="n">test_ptr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">channel</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">at_state</span> <span class="o">==</span> <span class="n">test_ptr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_icall</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">**</span><span class="n">p_at_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_at_state</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">gigaset_isdn_icall</span><span class="p">(</span><span class="n">at_state</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ICALL_ACCEPT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;internal error: disposition=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="cm">/* --v-- fall through --v-- */</span>
	<span class="k">case</span> <span class="n">ICALL_IGNORE</span>:
	<span class="k">case</span> <span class="n">ICALL_REJECT</span>:
		<span class="cm">/* hang up actively</span>
<span class="cm">		 * Device doc says that would reject the call.</span>
<span class="cm">		 * In fact it doesn&#39;t.</span>
<span class="cm">		 */</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">do_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MS_UNINITIALIZED</span>:
	<span class="k">case</span> <span class="n">MS_READY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">temp_at_states</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">gigaset_get_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MS_LOCKED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_LOCKED</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">M_UNKNOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">do_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">!=</span> <span class="n">MS_LOCKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_UNINITIALIZED</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">M_UNKNOWN</span><span class="p">;</span>
	<span class="n">gigaset_free_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span>
		<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_INIT</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_action</span><span class="p">(</span><span class="kt">int</span> <span class="n">action</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">**</span><span class="n">p_at_state</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">pp_command</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="o">*</span><span class="n">p_genresp</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">p_resp_code</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">event_t</span> <span class="o">*</span><span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span> <span class="o">=</span> <span class="o">*</span><span class="n">p_at_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACT_NOTHING</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_TIMEOUT</span>:
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_INIT</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_INIT</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">M_UNIMODEM</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cidmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">gigaset_free_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_READY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_CIDMODE</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_CIDMODE&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAILINIT</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not initialize the device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">init_failed</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">M_UNKNOWN</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_CONFIGMODE</span>:
		<span class="n">init_failed</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">M_CONFIG</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_SETDLE1</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* cs-&gt;inbuf[0].inputstate |= INS_command | INS_DLE_command; */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">inputstate</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">INS_command</span> <span class="o">|</span> <span class="n">INS_DLE_command</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_SETDLE0</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">inputstate</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">inputstate</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">INS_DLE_command</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">INS_command</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_CMODESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">==</span> <span class="n">MS_INIT</span> <span class="o">||</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">==</span> <span class="n">MS_RECOVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gigaset_free_channels</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_READY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">M_CID</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_UMODESET</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">M_UNIMODEM</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAILCMODE</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">==</span> <span class="n">MS_INIT</span> <span class="o">||</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">==</span> <span class="n">MS_RECOVER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">init_failed</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">M_UNKNOWN</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reinit_and_retry</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_RECOVER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAILUMODE</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_RECOVER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_HUPMODEM</span>:
		<span class="cm">/* send &quot;+++&quot; (hangup in unimodem mode) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>

			<span class="n">cb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdbuf_t</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;+++&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_cmd</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_RING</span>:
		<span class="cm">/* get fresh AT state structure for new CID */</span>
		<span class="n">at_state2</span> <span class="o">=</span> <span class="n">get_free_channel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">at_state2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;RING ignored: could not allocate channel structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* initialize AT state structure</span>
<span class="cm">		 * note that bcs may be NULL if no B channel is free</span>
<span class="cm">		 */</span>
		<span class="n">at_state2</span><span class="o">-&gt;</span><span class="n">ConState</span> <span class="o">=</span> <span class="mi">700</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">STR_NUM</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">at_state2</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">at_state2</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">at_state2</span><span class="o">-&gt;</span><span class="n">int_var</span><span class="p">[</span><span class="n">VAR_ZCTP</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">at_state2</span><span class="o">-&gt;</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="n">RING_TIMEOUT</span><span class="p">;</span>
		<span class="n">at_state2</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_ICALL</span>:
		<span class="n">handle_icall</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="p">,</span> <span class="n">p_at_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAILSDOWN</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not shut down the device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ACT_FAKESDOWN</span>:
	<span class="k">case</span> <span class="n">ACT_SDOWN</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">finish_shutdown</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_CONNECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">onechannel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_DLE1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">|=</span> <span class="n">CHS_D_UP</span><span class="p">;</span>
		<span class="n">gigaset_isdn_connD</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_bchannel</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_DLE1</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span><span class="p">;</span>

		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">|=</span> <span class="n">CHS_D_UP</span><span class="p">;</span>
		<span class="n">gigaset_isdn_connD</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_bchannel</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAKEHUP</span>:
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">int_var</span><span class="p">[</span><span class="n">VAR_ZSAU</span><span class="p">]</span> <span class="o">=</span> <span class="n">ZSAU_NULL</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ACT_DISCONNECT</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">onechannel</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check for other open channels not needed:</span>
<span class="cm">			 * DLE only used for M10x with one B channel.</span>
<span class="cm">			 */</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_DLE0</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">disconnect</span><span class="p">(</span><span class="n">p_at_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAKEDLE0</span>:
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">int_var</span><span class="p">[</span><span class="n">VAR_ZDLE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ACT_DLE0</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">at_state2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span><span class="p">].</span><span class="n">at_state</span><span class="p">;</span>
		<span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at_state2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_ABORTHUP</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not hang up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">onechannel</span><span class="p">)</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_DLE0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">disconnect</span><span class="p">(</span><span class="n">p_at_state</span><span class="p">);</span>
		<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_RECOVER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAILDLE0</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not leave DLE mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">at_state2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span><span class="p">].</span><span class="n">at_state</span><span class="p">;</span>
		<span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at_state2</span><span class="p">);</span>
		<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_RECOVER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_FAILDLE1</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Could not enter DLE mode. Trying to hang up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACT_CID</span>: <span class="cm">/* got cid; start dialing */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">at_state</span><span class="p">.</span><span class="n">cid</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span>
				<span class="n">PC_DIAL</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ACT_FAILCID</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reinit_and_retry</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;Could not get a call ID. Cannot dial.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">at_state2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">at_state</span><span class="p">;</span>
			<span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at_state2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_ABORTCID</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">at_state2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span><span class="p">].</span><span class="n">at_state</span><span class="p">;</span>
		<span class="n">disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at_state2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACT_DIALING</span>:
	<span class="k">case</span> <span class="n">ACT_ACCEPTED</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACT_ABORTACCEPT</span>:	<span class="cm">/* hangup/error/timeout during ICALL procssng */</span>
		<span class="n">disconnect</span><span class="p">(</span><span class="n">p_at_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACT_ABORTDIAL</span>:	<span class="cm">/* error/timeout during dial preparation */</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ACT_REMOTEREJECT</span>:	<span class="cm">/* DISCONNECT_IND after dialling */</span>
	<span class="k">case</span> <span class="n">ACT_CONNTIMEOUT</span>:	<span class="cm">/* timeout waiting for ZSAU=ACTIVE */</span>
	<span class="k">case</span> <span class="n">ACT_REMOTEHUP</span>:	<span class="cm">/* DISCONNECT_IND with established connection */</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_GETSTRING</span>: <span class="cm">/* warning: RING, ZDLE, ...</span>
<span class="cm">			       are not handled properly anymore */</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">getstring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_SETVER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p_genresp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p_resp_code</span> <span class="o">=</span> <span class="n">RSP_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* OK without version string: assume old response */</span>
			<span class="o">*</span><span class="n">p_genresp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p_resp_code</span> <span class="o">=</span> <span class="n">RSP_NONE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span> <span class="o">||</span> <span class="n">e</span> <span class="o">==</span> <span class="n">s</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">e</span> <span class="o">!=</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">s</span> <span class="o">=</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p_genresp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p_resp_code</span> <span class="o">=</span> <span class="n">RSP_ERROR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*at_state-&gt;getstring = 1;*/</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">gotfwver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_GOTVER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">gotfwver</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">gotfwver</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span>
				<span class="s">&quot;firmware version %02d.%03d.%02d.%02d&quot;</span><span class="p">,</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">ACT_FAILVER</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">gotfwver</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not read firmware version.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_ERROR</span>:
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;%s: ERROR response in ConState %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_DEBUG</span>:
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;%s: resp_code %d in ConState %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_WARN</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: resp_code %d in ConState %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_ZCAU</span>:
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cause code %04x in connection state %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">,</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* events from the LL */</span>

	<span class="k">case</span> <span class="n">ACT_DIAL</span>:
		<span class="n">start_dial</span><span class="p">(</span><span class="n">at_state</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_ACCEPT</span>:
		<span class="n">start_accept</span><span class="p">(</span><span class="n">at_state</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_HUP</span>:
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_HUP&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* hotplug events */</span>

	<span class="k">case</span> <span class="n">ACT_STOP</span>:
		<span class="n">do_stop</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_START</span>:
		<span class="n">do_start</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* events from the interface */</span>

	<span class="k">case</span> <span class="n">ACT_IF_LOCK</span>:
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmd_result</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">?</span> <span class="n">do_lock</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="o">:</span> <span class="n">do_unlock</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_IF_VER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmd_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">gotfwver</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmd_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmd_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* events from the proc file system */</span>

	<span class="k">case</span> <span class="n">ACT_PROC_CIDMODE</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">!=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cidmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cidmode</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_CIDMODE</span><span class="p">;</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_CIDMODE&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_UMMODE</span><span class="p">;</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_UMMODE&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* events from the hardware drivers */</span>

	<span class="k">case</span> <span class="n">ACT_NOTIFY_BC_DOWN</span>:
		<span class="n">bchannel_down</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_NOTIFY_BC_UP</span>:
		<span class="n">bchannel_up</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACT_SHUTDOWN</span>:
		<span class="n">do_shutdown</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>


	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">&gt;=</span> <span class="n">ACT_CMD</span> <span class="o">&amp;&amp;</span> <span class="n">action</span> <span class="o">&lt;</span> <span class="n">ACT_CMD</span> <span class="o">+</span> <span class="n">AT_NUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pp_command</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">[</span><span class="n">action</span> <span class="o">-</span> <span class="n">ACT_CMD</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">pp_command</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">p_genresp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="o">*</span><span class="n">p_resp_code</span> <span class="o">=</span> <span class="n">RSP_NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: action==%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* State machine to do the calling and hangup procedure */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event_t</span> <span class="o">*</span><span class="n">ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p_command</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">reply_t</span> <span class="o">*</span><span class="n">rep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rcode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">genresp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resp_code</span> <span class="o">=</span> <span class="n">RSP_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sendcid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curact</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at_state</span> <span class="o">=</span> <span class="n">at_state_from_cid</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">at_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;event %d for invalid cid %d&quot;</span><span class="p">,</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">);</span>
			<span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">RSP_WRONG_CID</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">at_state</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at_state_invalid</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">at_state</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;event for invalid at_state %p&quot;</span><span class="p">,</span>
				<span class="n">at_state</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;connection state %d, event %d&quot;</span><span class="p">,</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">bcs</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">;</span>
	<span class="n">sendcid</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cid</span><span class="p">;</span>

	<span class="cm">/* Setting the pointer to the dial array */</span>
	<span class="n">rep</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">replystruct</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">!=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_index</span>
		    <span class="o">||</span> <span class="o">!</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">RSP_NONE</span><span class="p">;</span> <span class="cm">/* old timeout */</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;old timeout&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">waiting</span><span class="p">)</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;timeout occurred&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;stopped waiting&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* if the response belongs to a variable in at_state-&gt;int_var[VAR_XXXX]</span>
<span class="cm">	   or at_state-&gt;str_var[STR_XXXX], set it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">RSP_VAR</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">RSP_VAR</span> <span class="o">+</span> <span class="n">VAR_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">-</span> <span class="n">RSP_VAR</span><span class="p">;</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">int_var</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">RSP_STR</span> <span class="o">&amp;&amp;</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">RSP_STR</span> <span class="o">+</span> <span class="n">STR_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">-</span> <span class="n">RSP_STR</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* prevent process_events() from</span>
<span class="cm">				   deallocating ptr */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_TIMEOUT</span> <span class="o">||</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">RSP_STRING</span><span class="p">)</span>
		<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">getstring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Search row in dial array which matches modem response and current</span>
<span class="cm">	   constate */</span>
	<span class="k">for</span> <span class="p">(;;</span> <span class="n">rep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcode</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">resp_code</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="n">RSP_LAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* found nothing...*/</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: rcode=RSP_LAST: &quot;</span>
				 <span class="s">&quot;resp_code %d in ConState %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rcode</span> <span class="o">==</span> <span class="n">RSP_ANY</span> <span class="o">||</span> <span class="n">rcode</span> <span class="o">==</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span> <span class="o">&gt;=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">min_ConState</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">max_ConState</span> <span class="o">&lt;</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span> <span class="o">&lt;=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">max_ConState</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">parameter</span> <span class="o">==</span> <span class="n">ev</span><span class="o">-&gt;</span><span class="n">parameter</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p_command</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">;</span>

	<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">curact</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">curact</span> <span class="o">&lt;</span> <span class="n">MAXACT</span><span class="p">;</span> <span class="o">++</span><span class="n">curact</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The row tells us what we should do  ..</span>
<span class="cm">		 */</span>
		<span class="n">do_action</span><span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">[</span><span class="n">curact</span><span class="p">],</span> <span class="n">cs</span><span class="p">,</span> <span class="n">bcs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">at_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_command</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">genresp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp_code</span><span class="p">,</span> <span class="n">ev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">at_state</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* may be freed after disconnect */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Jump to the next con-state regarding the array */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">new_ConState</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">ConState</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">new_ConState</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">genresp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">at_state</span><span class="p">,</span> <span class="n">resp_code</span><span class="p">,</span>
					  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Send command to modem if not NULL... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p_command</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span>
					<span class="n">send_command</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">p_command</span><span class="p">,</span>
						     <span class="n">sendcid</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span><span class="p">,</span>
						     <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">at_state</span><span class="p">,</span>
							  <span class="n">RSP_NODEV</span><span class="p">,</span>
							  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rep</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* new timeout */</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="n">rep</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="o">++</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">timer_index</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">schedule_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sequence</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">=</span> <span class="n">sequence</span><span class="p">;</span>
	<span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">at_state</span><span class="p">,</span> <span class="n">RSP_INIT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sequence</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">process_command_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sequence</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;not searching scheduled commands: busy&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;searching scheduled commands&quot;</span><span class="p">);</span>

	<span class="n">sequence</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>

	<span class="cm">/* clear pending_commands and hangup channels on shutdown */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CIDMODE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">at_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">;</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="n">PC_DLE1</span> <span class="o">|</span> <span class="n">PC_ACCEPT</span> <span class="o">|</span> <span class="n">PC_DIAL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_CID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_NOCID</span><span class="p">;</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CID</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* clear pending_commands and hangup channels on reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CIDMODE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">at_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">;</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="n">PC_DLE1</span> <span class="o">|</span> <span class="n">PC_ACCEPT</span> <span class="o">|</span> <span class="n">PC_DIAL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_HUP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">==</span> <span class="n">MS_RECOVER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_CID</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_NOCID</span><span class="p">;</span>
					<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CID</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* only switch back to unimodem mode if no commands are pending and</span>
<span class="cm">	 * no channels are up */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">==</span> <span class="n">PC_UMMODE</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cidmode</span>
	    <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">temp_at_states</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">M_CID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sequence</span> <span class="o">=</span> <span class="n">SEQ_UMMODE</span><span class="p">;</span>
		<span class="n">at_state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">||</span>
			    <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">cid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sequence</span> <span class="o">=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_UMMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sequence</span> <span class="o">!=</span> <span class="n">SEQ_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">at_state</span><span class="p">,</span> <span class="n">sequence</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_HUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_HUP</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_CID</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* not yet dialing: PC_NOCID is sufficient */</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_NOCID</span><span class="p">;</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CID</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_HUP</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_NOCID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_NOCID</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_NOCID</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_DLE0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_DLE0</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_DLE0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">at_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">temp_at_states</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_HUP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">at_state</span><span class="o">-&gt;</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_HUP</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_HUP</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_INIT</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">inputstate</span> <span class="o">=</span> <span class="n">INS_command</span><span class="p">;</span>
		<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_INIT</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_SHUTDOWN</span><span class="p">;</span>
		<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_SHUTDOWN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_CIDMODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CIDMODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">M_UNIMODEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_CIDMODE</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_DLE1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_DLE1</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_DLE1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_ACCEPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_ACCEPT</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_ACCEPT</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_DIAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_DIAL</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_DIAL</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;</span> <span class="n">PC_CID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">M_UNIMODEM</span>:
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">|=</span> <span class="n">PC_CIDMODE</span><span class="p">;</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_EVENT</span><span class="p">,</span> <span class="s">&quot;Scheduling PC_CIDMODE&quot;</span><span class="p">);</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">M_UNKNOWN</span>:
				<span class="n">schedule_init</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">MS_INIT</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">pending_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PC_CID</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curchannel</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">retry_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">schedule_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">SEQ_CID</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">process_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event_t</span> <span class="o">*</span><span class="n">ev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">check_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_busy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_head</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">MAX_EVENTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_tail</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tail</span> <span class="o">==</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_flags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">check_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">process_command_flags</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_tail</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tail</span> <span class="o">==</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">commands_pending</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ev</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">+</span> <span class="n">head</span><span class="p">;</span>
		<span class="n">was_busy</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">!=</span> <span class="n">SEQ_NONE</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">process_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">ev</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">was_busy</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cur_at_seq</span> <span class="o">==</span> <span class="n">SEQ_NONE</span><span class="p">)</span>
			<span class="n">check_flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MAX_EVENTS</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ev_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">MAX_EVENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;infinite loop in process_events; aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* tasklet scheduled on any event received from the Gigaset device</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	data	ISDN controller state structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="n">gigaset_handle_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* handle incoming data on control/common channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">!=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;processing new data&quot;</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">handle_input</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">process_events</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
