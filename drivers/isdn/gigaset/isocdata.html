<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › gigaset › isocdata.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>isocdata.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Common data handling layer for bas_gigaset</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2005 by Tilman Schmidt &lt;tilman@imap.cc&gt;,</span>
<span class="cm"> *                       Hansjoerg Lipp &lt;hjlipp@web.de&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *	the License, or (at your option) any later version.</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;gigaset.h&quot;</span>
<span class="cp">#include &lt;linux/crc-ccitt.h&gt;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>

<span class="cm">/* access methods for isowbuf_t */</span>
<span class="cm">/* ============================ */</span>

<span class="cm">/* initialize buffer structure</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isowbuf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">idle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">nextread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">writesem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">wbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">BAS_OUTBUFSIZE</span><span class="p">,</span> <span class="n">idle</span><span class="p">,</span> <span class="n">BAS_OUTBUFPAD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* compute number of bytes which can be appended to buffer</span>
<span class="cm"> * so that there is still room to append a maximum frame of flags</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">isowbuf_freebytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">freebytes</span><span class="p">;</span>

	<span class="n">read</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>
	<span class="n">write</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="n">freebytes</span> <span class="o">=</span> <span class="n">read</span> <span class="o">-</span> <span class="n">write</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freebytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no wraparound: need padding space within regular area */</span>
		<span class="k">return</span> <span class="n">freebytes</span> <span class="o">-</span> <span class="n">BAS_OUTBUFPAD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">BAS_OUTBUFPAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wraparound: can use space up to end of regular area */</span>
		<span class="k">return</span> <span class="n">BAS_OUTBUFSIZE</span> <span class="o">-</span> <span class="n">write</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* following the wraparound yields more space */</span>
		<span class="k">return</span> <span class="n">freebytes</span> <span class="o">+</span> <span class="n">BAS_OUTBUFSIZE</span> <span class="o">-</span> <span class="n">BAS_OUTBUFPAD</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* start writing</span>
<span class="cm"> * acquire the write semaphore</span>
<span class="cm"> * return 0 if acquired, &lt;0 if busy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">isowbuf_startwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">writesem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">writesem</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: couldn&#39;t acquire iso write semaphore&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span>
		<span class="s">&quot;%s: acquired iso write semaphore, data[write]=%02x, nbits=%d&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">],</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">wbits</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* finish writing</span>
<span class="cm"> * release the write semaphore</span>
<span class="cm"> * returns the current write position</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">isowbuf_donewrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">writesem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">write</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* append bits to buffer without any checks</span>
<span class="cm"> * - data contains bits to append, starting at LSB</span>
<span class="cm"> * - nbits is number of bits to append (0..24)</span>
<span class="cm"> * must be called with the write semaphore held</span>
<span class="cm"> * If more than nbits bits are set in data, the extraneous bits are set in the</span>
<span class="cm"> * buffer too, but the write position is only advanced by nbits.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">isowbuf_putbits</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">write</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">wbits</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">write</span><span class="p">];</span>
	<span class="n">nbits</span> <span class="o">+=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">wbits</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nbits</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">write</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">write</span> <span class="o">%=</span> <span class="n">BAS_OUTBUFSIZE</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">nbits</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">wbits</span> <span class="o">=</span> <span class="n">nbits</span><span class="p">;</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">write</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* put final flag on HDLC bitstream</span>
<span class="cm"> * also sets the idle fill byte to the correspondingly shifted flag pattern</span>
<span class="cm"> * must be called with the write semaphore held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">isowbuf_putflag</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">write</span><span class="p">;</span>

	<span class="cm">/* add two flags, thus reliably covering one byte */</span>
	<span class="n">isowbuf_putbits</span><span class="p">(</span><span class="n">iwb</span><span class="p">,</span> <span class="mh">0x7e7e</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* recover the idle flag byte */</span>
	<span class="n">write</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">write</span><span class="p">];</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;idle fill byte %02x&quot;</span><span class="p">,</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">);</span>
	<span class="cm">/* mask extraneous bits in buffer */</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">write</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">wbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* retrieve a block of bytes for sending</span>
<span class="cm"> * The requested number of bytes is provided as a contiguous block.</span>
<span class="cm"> * If necessary, the frame is filled to the requested number of bytes</span>
<span class="cm"> * with the idle value.</span>
<span class="cm"> * returns offset to frame, &lt; 0 on busy or error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gigaset_isowbuf_getbytes</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pbyte</span><span class="p">;</span>

	<span class="n">read</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">nextread</span><span class="p">;</span>
	<span class="n">write</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">write</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* return idle frame */</span>
		<span class="k">return</span> <span class="n">read</span> <span class="o">&lt;</span> <span class="n">BAS_OUTBUFPAD</span> <span class="o">?</span>
			<span class="n">BAS_OUTBUFSIZE</span> <span class="o">:</span> <span class="n">read</span> <span class="o">-</span> <span class="n">BAS_OUTBUFPAD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="n">read</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_STREAM</span><span class="p">,</span> <span class="s">&quot;%s: read=%d write=%d limit=%d&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_GIGASET_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">BAS_OUTBUFPAD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;invalid size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">&lt;</span> <span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no wraparound in valid data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="n">write</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* append idle frame */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isowbuf_startwrite</span><span class="p">(</span><span class="n">iwb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="cm">/* write position could have changed */</span>
			<span class="n">write</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="n">write</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pbyte</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">write</span><span class="p">];</span> <span class="cm">/* save</span>
<span class="cm">							     partial byte */</span>
				<span class="n">limit</span> <span class="o">=</span> <span class="n">write</span> <span class="o">+</span> <span class="n">BAS_OUTBUFPAD</span><span class="p">;</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_STREAM</span><span class="p">,</span>
					<span class="s">&quot;%s: filling %d-&gt;%d with %02x&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">write</span> <span class="o">+</span> <span class="n">BAS_OUTBUFPAD</span> <span class="o">&lt;</span> <span class="n">BAS_OUTBUFSIZE</span><span class="p">)</span>
					<span class="n">memset</span><span class="p">(</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">write</span><span class="p">,</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">,</span>
					       <span class="n">BAS_OUTBUFPAD</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* wraparound, fill entire pad area */</span>
					<span class="n">memset</span><span class="p">(</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">write</span><span class="p">,</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">,</span>
					       <span class="n">BAS_OUTBUFSIZE</span> <span class="o">+</span> <span class="n">BAS_OUTBUFPAD</span>
					       <span class="o">-</span> <span class="n">write</span><span class="p">);</span>
					<span class="n">limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_STREAM</span><span class="p">,</span>
					<span class="s">&quot;%s: restoring %02x at %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">pbyte</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
				<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">limit</span><span class="p">]</span> <span class="o">=</span> <span class="n">pbyte</span><span class="p">;</span> <span class="cm">/* restore</span>
<span class="cm">							     partial byte */</span>
				<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">isowbuf_donewrite</span><span class="p">(</span><span class="n">iwb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* valid data wraparound */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="n">BAS_OUTBUFSIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy wrapped part into pad area */</span>
			<span class="n">src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="n">BAS_OUTBUFSIZE</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">src</span> <span class="o">&lt;</span> <span class="n">write</span><span class="p">)</span>
				<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">dst</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">src</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* fill pad area with idle byte */</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">dst</span><span class="p">,</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">,</span>
				       <span class="n">BAS_OUTBUFSIZE</span> <span class="o">+</span> <span class="n">BAS_OUTBUFPAD</span> <span class="o">-</span> <span class="n">dst</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">limit</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">nextread</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">read</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dump_bytes</span>
<span class="cm"> * write hex bytes to syslog for debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_bytes</span><span class="p">(</span><span class="k">enum</span> <span class="n">debuglevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_GIGASET_DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gigaset_debuglevel</span> <span class="o">&amp;</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dbgline</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbgline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">dbgline</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">bytes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbgline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">12</span><span class="p">))</span> <span class="o">?</span> <span class="sc">&#39;-&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbgline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="n">dbgline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbgline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;%s:%s&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">dbgline</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*============================================================================*/</span>

<span class="cm">/* bytewise HDLC bitstuffing via table lookup</span>
<span class="cm"> * lookup table: 5 subtables for 0..4 preceding consecutive &#39;1&#39; bits</span>
<span class="cm"> * index: 256*(number of preceding &#39;1&#39; bits) + (next byte to stuff)</span>
<span class="cm"> * value: bit  9.. 0 = result bits</span>
<span class="cm"> *        bit 12..10 = number of trailing &#39;1&#39; bits in result</span>
<span class="cm"> *        bit 14..13 = number of bits added by stuffing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">stufftab</span><span class="p">[</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* previous 1s = 0: */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span>
	<span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x0019</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="mh">0x201f</span><span class="p">,</span>
	<span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="mh">0x0025</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x0029</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x002b</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">,</span> <span class="mh">0x002e</span><span class="p">,</span> <span class="mh">0x002f</span><span class="p">,</span>
	<span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x0039</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">,</span> <span class="mh">0x003b</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">,</span> <span class="mh">0x003d</span><span class="p">,</span> <span class="mh">0x203e</span><span class="p">,</span> <span class="mh">0x205f</span><span class="p">,</span>
	<span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x0047</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0x0049</span><span class="p">,</span> <span class="mh">0x004a</span><span class="p">,</span> <span class="mh">0x004b</span><span class="p">,</span> <span class="mh">0x004c</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x004e</span><span class="p">,</span> <span class="mh">0x004f</span><span class="p">,</span>
	<span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">,</span> <span class="mh">0x0055</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span> <span class="mh">0x0057</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span> <span class="mh">0x005b</span><span class="p">,</span> <span class="mh">0x005c</span><span class="p">,</span> <span class="mh">0x005d</span><span class="p">,</span> <span class="mh">0x005e</span><span class="p">,</span> <span class="mh">0x209f</span><span class="p">,</span>
	<span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0061</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x0063</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">,</span> <span class="mh">0x0065</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x0067</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x006b</span><span class="p">,</span> <span class="mh">0x006c</span><span class="p">,</span> <span class="mh">0x006d</span><span class="p">,</span> <span class="mh">0x006e</span><span class="p">,</span> <span class="mh">0x006f</span><span class="p">,</span>
	<span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x0071</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span> <span class="mh">0x0073</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span> <span class="mh">0x0075</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0x0077</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x0079</span><span class="p">,</span> <span class="mh">0x007a</span><span class="p">,</span> <span class="mh">0x007b</span><span class="p">,</span> <span class="mh">0x207c</span><span class="p">,</span> <span class="mh">0x207d</span><span class="p">,</span> <span class="mh">0x20be</span><span class="p">,</span> <span class="mh">0x20df</span><span class="p">,</span>
	<span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0481</span><span class="p">,</span> <span class="mh">0x0482</span><span class="p">,</span> <span class="mh">0x0483</span><span class="p">,</span> <span class="mh">0x0484</span><span class="p">,</span> <span class="mh">0x0485</span><span class="p">,</span> <span class="mh">0x0486</span><span class="p">,</span> <span class="mh">0x0487</span><span class="p">,</span> <span class="mh">0x0488</span><span class="p">,</span> <span class="mh">0x0489</span><span class="p">,</span> <span class="mh">0x048a</span><span class="p">,</span> <span class="mh">0x048b</span><span class="p">,</span> <span class="mh">0x048c</span><span class="p">,</span> <span class="mh">0x048d</span><span class="p">,</span> <span class="mh">0x048e</span><span class="p">,</span> <span class="mh">0x048f</span><span class="p">,</span>
	<span class="mh">0x0490</span><span class="p">,</span> <span class="mh">0x0491</span><span class="p">,</span> <span class="mh">0x0492</span><span class="p">,</span> <span class="mh">0x0493</span><span class="p">,</span> <span class="mh">0x0494</span><span class="p">,</span> <span class="mh">0x0495</span><span class="p">,</span> <span class="mh">0x0496</span><span class="p">,</span> <span class="mh">0x0497</span><span class="p">,</span> <span class="mh">0x0498</span><span class="p">,</span> <span class="mh">0x0499</span><span class="p">,</span> <span class="mh">0x049a</span><span class="p">,</span> <span class="mh">0x049b</span><span class="p">,</span> <span class="mh">0x049c</span><span class="p">,</span> <span class="mh">0x049d</span><span class="p">,</span> <span class="mh">0x049e</span><span class="p">,</span> <span class="mh">0x251f</span><span class="p">,</span>
	<span class="mh">0x04a0</span><span class="p">,</span> <span class="mh">0x04a1</span><span class="p">,</span> <span class="mh">0x04a2</span><span class="p">,</span> <span class="mh">0x04a3</span><span class="p">,</span> <span class="mh">0x04a4</span><span class="p">,</span> <span class="mh">0x04a5</span><span class="p">,</span> <span class="mh">0x04a6</span><span class="p">,</span> <span class="mh">0x04a7</span><span class="p">,</span> <span class="mh">0x04a8</span><span class="p">,</span> <span class="mh">0x04a9</span><span class="p">,</span> <span class="mh">0x04aa</span><span class="p">,</span> <span class="mh">0x04ab</span><span class="p">,</span> <span class="mh">0x04ac</span><span class="p">,</span> <span class="mh">0x04ad</span><span class="p">,</span> <span class="mh">0x04ae</span><span class="p">,</span> <span class="mh">0x04af</span><span class="p">,</span>
	<span class="mh">0x04b0</span><span class="p">,</span> <span class="mh">0x04b1</span><span class="p">,</span> <span class="mh">0x04b2</span><span class="p">,</span> <span class="mh">0x04b3</span><span class="p">,</span> <span class="mh">0x04b4</span><span class="p">,</span> <span class="mh">0x04b5</span><span class="p">,</span> <span class="mh">0x04b6</span><span class="p">,</span> <span class="mh">0x04b7</span><span class="p">,</span> <span class="mh">0x04b8</span><span class="p">,</span> <span class="mh">0x04b9</span><span class="p">,</span> <span class="mh">0x04ba</span><span class="p">,</span> <span class="mh">0x04bb</span><span class="p">,</span> <span class="mh">0x04bc</span><span class="p">,</span> <span class="mh">0x04bd</span><span class="p">,</span> <span class="mh">0x253e</span><span class="p">,</span> <span class="mh">0x255f</span><span class="p">,</span>
	<span class="mh">0x08c0</span><span class="p">,</span> <span class="mh">0x08c1</span><span class="p">,</span> <span class="mh">0x08c2</span><span class="p">,</span> <span class="mh">0x08c3</span><span class="p">,</span> <span class="mh">0x08c4</span><span class="p">,</span> <span class="mh">0x08c5</span><span class="p">,</span> <span class="mh">0x08c6</span><span class="p">,</span> <span class="mh">0x08c7</span><span class="p">,</span> <span class="mh">0x08c8</span><span class="p">,</span> <span class="mh">0x08c9</span><span class="p">,</span> <span class="mh">0x08ca</span><span class="p">,</span> <span class="mh">0x08cb</span><span class="p">,</span> <span class="mh">0x08cc</span><span class="p">,</span> <span class="mh">0x08cd</span><span class="p">,</span> <span class="mh">0x08ce</span><span class="p">,</span> <span class="mh">0x08cf</span><span class="p">,</span>
	<span class="mh">0x08d0</span><span class="p">,</span> <span class="mh">0x08d1</span><span class="p">,</span> <span class="mh">0x08d2</span><span class="p">,</span> <span class="mh">0x08d3</span><span class="p">,</span> <span class="mh">0x08d4</span><span class="p">,</span> <span class="mh">0x08d5</span><span class="p">,</span> <span class="mh">0x08d6</span><span class="p">,</span> <span class="mh">0x08d7</span><span class="p">,</span> <span class="mh">0x08d8</span><span class="p">,</span> <span class="mh">0x08d9</span><span class="p">,</span> <span class="mh">0x08da</span><span class="p">,</span> <span class="mh">0x08db</span><span class="p">,</span> <span class="mh">0x08dc</span><span class="p">,</span> <span class="mh">0x08dd</span><span class="p">,</span> <span class="mh">0x08de</span><span class="p">,</span> <span class="mh">0x299f</span><span class="p">,</span>
	<span class="mh">0x0ce0</span><span class="p">,</span> <span class="mh">0x0ce1</span><span class="p">,</span> <span class="mh">0x0ce2</span><span class="p">,</span> <span class="mh">0x0ce3</span><span class="p">,</span> <span class="mh">0x0ce4</span><span class="p">,</span> <span class="mh">0x0ce5</span><span class="p">,</span> <span class="mh">0x0ce6</span><span class="p">,</span> <span class="mh">0x0ce7</span><span class="p">,</span> <span class="mh">0x0ce8</span><span class="p">,</span> <span class="mh">0x0ce9</span><span class="p">,</span> <span class="mh">0x0cea</span><span class="p">,</span> <span class="mh">0x0ceb</span><span class="p">,</span> <span class="mh">0x0cec</span><span class="p">,</span> <span class="mh">0x0ced</span><span class="p">,</span> <span class="mh">0x0cee</span><span class="p">,</span> <span class="mh">0x0cef</span><span class="p">,</span>
	<span class="mh">0x10f0</span><span class="p">,</span> <span class="mh">0x10f1</span><span class="p">,</span> <span class="mh">0x10f2</span><span class="p">,</span> <span class="mh">0x10f3</span><span class="p">,</span> <span class="mh">0x10f4</span><span class="p">,</span> <span class="mh">0x10f5</span><span class="p">,</span> <span class="mh">0x10f6</span><span class="p">,</span> <span class="mh">0x10f7</span><span class="p">,</span> <span class="mh">0x20f8</span><span class="p">,</span> <span class="mh">0x20f9</span><span class="p">,</span> <span class="mh">0x20fa</span><span class="p">,</span> <span class="mh">0x20fb</span><span class="p">,</span> <span class="mh">0x257c</span><span class="p">,</span> <span class="mh">0x257d</span><span class="p">,</span> <span class="mh">0x29be</span><span class="p">,</span> <span class="mh">0x2ddf</span><span class="p">,</span>

<span class="cm">/* previous 1s = 1: */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x200f</span><span class="p">,</span>
	<span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x0019</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="mh">0x202f</span><span class="p">,</span>
	<span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="mh">0x0025</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x0029</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x002b</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">,</span> <span class="mh">0x002e</span><span class="p">,</span> <span class="mh">0x204f</span><span class="p">,</span>
	<span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x0039</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">,</span> <span class="mh">0x003b</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">,</span> <span class="mh">0x003d</span><span class="p">,</span> <span class="mh">0x203e</span><span class="p">,</span> <span class="mh">0x206f</span><span class="p">,</span>
	<span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x0047</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0x0049</span><span class="p">,</span> <span class="mh">0x004a</span><span class="p">,</span> <span class="mh">0x004b</span><span class="p">,</span> <span class="mh">0x004c</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x004e</span><span class="p">,</span> <span class="mh">0x208f</span><span class="p">,</span>
	<span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">,</span> <span class="mh">0x0055</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span> <span class="mh">0x0057</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span> <span class="mh">0x005b</span><span class="p">,</span> <span class="mh">0x005c</span><span class="p">,</span> <span class="mh">0x005d</span><span class="p">,</span> <span class="mh">0x005e</span><span class="p">,</span> <span class="mh">0x20af</span><span class="p">,</span>
	<span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0061</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x0063</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">,</span> <span class="mh">0x0065</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x0067</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x006b</span><span class="p">,</span> <span class="mh">0x006c</span><span class="p">,</span> <span class="mh">0x006d</span><span class="p">,</span> <span class="mh">0x006e</span><span class="p">,</span> <span class="mh">0x20cf</span><span class="p">,</span>
	<span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x0071</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span> <span class="mh">0x0073</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span> <span class="mh">0x0075</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0x0077</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x0079</span><span class="p">,</span> <span class="mh">0x007a</span><span class="p">,</span> <span class="mh">0x007b</span><span class="p">,</span> <span class="mh">0x207c</span><span class="p">,</span> <span class="mh">0x207d</span><span class="p">,</span> <span class="mh">0x20be</span><span class="p">,</span> <span class="mh">0x20ef</span><span class="p">,</span>
	<span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0481</span><span class="p">,</span> <span class="mh">0x0482</span><span class="p">,</span> <span class="mh">0x0483</span><span class="p">,</span> <span class="mh">0x0484</span><span class="p">,</span> <span class="mh">0x0485</span><span class="p">,</span> <span class="mh">0x0486</span><span class="p">,</span> <span class="mh">0x0487</span><span class="p">,</span> <span class="mh">0x0488</span><span class="p">,</span> <span class="mh">0x0489</span><span class="p">,</span> <span class="mh">0x048a</span><span class="p">,</span> <span class="mh">0x048b</span><span class="p">,</span> <span class="mh">0x048c</span><span class="p">,</span> <span class="mh">0x048d</span><span class="p">,</span> <span class="mh">0x048e</span><span class="p">,</span> <span class="mh">0x250f</span><span class="p">,</span>
	<span class="mh">0x0490</span><span class="p">,</span> <span class="mh">0x0491</span><span class="p">,</span> <span class="mh">0x0492</span><span class="p">,</span> <span class="mh">0x0493</span><span class="p">,</span> <span class="mh">0x0494</span><span class="p">,</span> <span class="mh">0x0495</span><span class="p">,</span> <span class="mh">0x0496</span><span class="p">,</span> <span class="mh">0x0497</span><span class="p">,</span> <span class="mh">0x0498</span><span class="p">,</span> <span class="mh">0x0499</span><span class="p">,</span> <span class="mh">0x049a</span><span class="p">,</span> <span class="mh">0x049b</span><span class="p">,</span> <span class="mh">0x049c</span><span class="p">,</span> <span class="mh">0x049d</span><span class="p">,</span> <span class="mh">0x049e</span><span class="p">,</span> <span class="mh">0x252f</span><span class="p">,</span>
	<span class="mh">0x04a0</span><span class="p">,</span> <span class="mh">0x04a1</span><span class="p">,</span> <span class="mh">0x04a2</span><span class="p">,</span> <span class="mh">0x04a3</span><span class="p">,</span> <span class="mh">0x04a4</span><span class="p">,</span> <span class="mh">0x04a5</span><span class="p">,</span> <span class="mh">0x04a6</span><span class="p">,</span> <span class="mh">0x04a7</span><span class="p">,</span> <span class="mh">0x04a8</span><span class="p">,</span> <span class="mh">0x04a9</span><span class="p">,</span> <span class="mh">0x04aa</span><span class="p">,</span> <span class="mh">0x04ab</span><span class="p">,</span> <span class="mh">0x04ac</span><span class="p">,</span> <span class="mh">0x04ad</span><span class="p">,</span> <span class="mh">0x04ae</span><span class="p">,</span> <span class="mh">0x254f</span><span class="p">,</span>
	<span class="mh">0x04b0</span><span class="p">,</span> <span class="mh">0x04b1</span><span class="p">,</span> <span class="mh">0x04b2</span><span class="p">,</span> <span class="mh">0x04b3</span><span class="p">,</span> <span class="mh">0x04b4</span><span class="p">,</span> <span class="mh">0x04b5</span><span class="p">,</span> <span class="mh">0x04b6</span><span class="p">,</span> <span class="mh">0x04b7</span><span class="p">,</span> <span class="mh">0x04b8</span><span class="p">,</span> <span class="mh">0x04b9</span><span class="p">,</span> <span class="mh">0x04ba</span><span class="p">,</span> <span class="mh">0x04bb</span><span class="p">,</span> <span class="mh">0x04bc</span><span class="p">,</span> <span class="mh">0x04bd</span><span class="p">,</span> <span class="mh">0x253e</span><span class="p">,</span> <span class="mh">0x256f</span><span class="p">,</span>
	<span class="mh">0x08c0</span><span class="p">,</span> <span class="mh">0x08c1</span><span class="p">,</span> <span class="mh">0x08c2</span><span class="p">,</span> <span class="mh">0x08c3</span><span class="p">,</span> <span class="mh">0x08c4</span><span class="p">,</span> <span class="mh">0x08c5</span><span class="p">,</span> <span class="mh">0x08c6</span><span class="p">,</span> <span class="mh">0x08c7</span><span class="p">,</span> <span class="mh">0x08c8</span><span class="p">,</span> <span class="mh">0x08c9</span><span class="p">,</span> <span class="mh">0x08ca</span><span class="p">,</span> <span class="mh">0x08cb</span><span class="p">,</span> <span class="mh">0x08cc</span><span class="p">,</span> <span class="mh">0x08cd</span><span class="p">,</span> <span class="mh">0x08ce</span><span class="p">,</span> <span class="mh">0x298f</span><span class="p">,</span>
	<span class="mh">0x08d0</span><span class="p">,</span> <span class="mh">0x08d1</span><span class="p">,</span> <span class="mh">0x08d2</span><span class="p">,</span> <span class="mh">0x08d3</span><span class="p">,</span> <span class="mh">0x08d4</span><span class="p">,</span> <span class="mh">0x08d5</span><span class="p">,</span> <span class="mh">0x08d6</span><span class="p">,</span> <span class="mh">0x08d7</span><span class="p">,</span> <span class="mh">0x08d8</span><span class="p">,</span> <span class="mh">0x08d9</span><span class="p">,</span> <span class="mh">0x08da</span><span class="p">,</span> <span class="mh">0x08db</span><span class="p">,</span> <span class="mh">0x08dc</span><span class="p">,</span> <span class="mh">0x08dd</span><span class="p">,</span> <span class="mh">0x08de</span><span class="p">,</span> <span class="mh">0x29af</span><span class="p">,</span>
	<span class="mh">0x0ce0</span><span class="p">,</span> <span class="mh">0x0ce1</span><span class="p">,</span> <span class="mh">0x0ce2</span><span class="p">,</span> <span class="mh">0x0ce3</span><span class="p">,</span> <span class="mh">0x0ce4</span><span class="p">,</span> <span class="mh">0x0ce5</span><span class="p">,</span> <span class="mh">0x0ce6</span><span class="p">,</span> <span class="mh">0x0ce7</span><span class="p">,</span> <span class="mh">0x0ce8</span><span class="p">,</span> <span class="mh">0x0ce9</span><span class="p">,</span> <span class="mh">0x0cea</span><span class="p">,</span> <span class="mh">0x0ceb</span><span class="p">,</span> <span class="mh">0x0cec</span><span class="p">,</span> <span class="mh">0x0ced</span><span class="p">,</span> <span class="mh">0x0cee</span><span class="p">,</span> <span class="mh">0x2dcf</span><span class="p">,</span>
	<span class="mh">0x10f0</span><span class="p">,</span> <span class="mh">0x10f1</span><span class="p">,</span> <span class="mh">0x10f2</span><span class="p">,</span> <span class="mh">0x10f3</span><span class="p">,</span> <span class="mh">0x10f4</span><span class="p">,</span> <span class="mh">0x10f5</span><span class="p">,</span> <span class="mh">0x10f6</span><span class="p">,</span> <span class="mh">0x10f7</span><span class="p">,</span> <span class="mh">0x20f8</span><span class="p">,</span> <span class="mh">0x20f9</span><span class="p">,</span> <span class="mh">0x20fa</span><span class="p">,</span> <span class="mh">0x20fb</span><span class="p">,</span> <span class="mh">0x257c</span><span class="p">,</span> <span class="mh">0x257d</span><span class="p">,</span> <span class="mh">0x29be</span><span class="p">,</span> <span class="mh">0x31ef</span><span class="p">,</span>

<span class="cm">/* previous 1s = 2: */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x2007</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x2017</span><span class="p">,</span>
	<span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x0019</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="mh">0x2037</span><span class="p">,</span>
	<span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="mh">0x0025</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x2047</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x0029</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x002b</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">,</span> <span class="mh">0x002e</span><span class="p">,</span> <span class="mh">0x2057</span><span class="p">,</span>
	<span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x2067</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x0039</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">,</span> <span class="mh">0x003b</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">,</span> <span class="mh">0x003d</span><span class="p">,</span> <span class="mh">0x203e</span><span class="p">,</span> <span class="mh">0x2077</span><span class="p">,</span>
	<span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x2087</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0x0049</span><span class="p">,</span> <span class="mh">0x004a</span><span class="p">,</span> <span class="mh">0x004b</span><span class="p">,</span> <span class="mh">0x004c</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x004e</span><span class="p">,</span> <span class="mh">0x2097</span><span class="p">,</span>
	<span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">,</span> <span class="mh">0x0055</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span> <span class="mh">0x20a7</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span> <span class="mh">0x005b</span><span class="p">,</span> <span class="mh">0x005c</span><span class="p">,</span> <span class="mh">0x005d</span><span class="p">,</span> <span class="mh">0x005e</span><span class="p">,</span> <span class="mh">0x20b7</span><span class="p">,</span>
	<span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0061</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x0063</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">,</span> <span class="mh">0x0065</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x20c7</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x006b</span><span class="p">,</span> <span class="mh">0x006c</span><span class="p">,</span> <span class="mh">0x006d</span><span class="p">,</span> <span class="mh">0x006e</span><span class="p">,</span> <span class="mh">0x20d7</span><span class="p">,</span>
	<span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x0071</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span> <span class="mh">0x0073</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span> <span class="mh">0x0075</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0x20e7</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x0079</span><span class="p">,</span> <span class="mh">0x007a</span><span class="p">,</span> <span class="mh">0x007b</span><span class="p">,</span> <span class="mh">0x207c</span><span class="p">,</span> <span class="mh">0x207d</span><span class="p">,</span> <span class="mh">0x20be</span><span class="p">,</span> <span class="mh">0x20f7</span><span class="p">,</span>
	<span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0481</span><span class="p">,</span> <span class="mh">0x0482</span><span class="p">,</span> <span class="mh">0x0483</span><span class="p">,</span> <span class="mh">0x0484</span><span class="p">,</span> <span class="mh">0x0485</span><span class="p">,</span> <span class="mh">0x0486</span><span class="p">,</span> <span class="mh">0x2507</span><span class="p">,</span> <span class="mh">0x0488</span><span class="p">,</span> <span class="mh">0x0489</span><span class="p">,</span> <span class="mh">0x048a</span><span class="p">,</span> <span class="mh">0x048b</span><span class="p">,</span> <span class="mh">0x048c</span><span class="p">,</span> <span class="mh">0x048d</span><span class="p">,</span> <span class="mh">0x048e</span><span class="p">,</span> <span class="mh">0x2517</span><span class="p">,</span>
	<span class="mh">0x0490</span><span class="p">,</span> <span class="mh">0x0491</span><span class="p">,</span> <span class="mh">0x0492</span><span class="p">,</span> <span class="mh">0x0493</span><span class="p">,</span> <span class="mh">0x0494</span><span class="p">,</span> <span class="mh">0x0495</span><span class="p">,</span> <span class="mh">0x0496</span><span class="p">,</span> <span class="mh">0x2527</span><span class="p">,</span> <span class="mh">0x0498</span><span class="p">,</span> <span class="mh">0x0499</span><span class="p">,</span> <span class="mh">0x049a</span><span class="p">,</span> <span class="mh">0x049b</span><span class="p">,</span> <span class="mh">0x049c</span><span class="p">,</span> <span class="mh">0x049d</span><span class="p">,</span> <span class="mh">0x049e</span><span class="p">,</span> <span class="mh">0x2537</span><span class="p">,</span>
	<span class="mh">0x04a0</span><span class="p">,</span> <span class="mh">0x04a1</span><span class="p">,</span> <span class="mh">0x04a2</span><span class="p">,</span> <span class="mh">0x04a3</span><span class="p">,</span> <span class="mh">0x04a4</span><span class="p">,</span> <span class="mh">0x04a5</span><span class="p">,</span> <span class="mh">0x04a6</span><span class="p">,</span> <span class="mh">0x2547</span><span class="p">,</span> <span class="mh">0x04a8</span><span class="p">,</span> <span class="mh">0x04a9</span><span class="p">,</span> <span class="mh">0x04aa</span><span class="p">,</span> <span class="mh">0x04ab</span><span class="p">,</span> <span class="mh">0x04ac</span><span class="p">,</span> <span class="mh">0x04ad</span><span class="p">,</span> <span class="mh">0x04ae</span><span class="p">,</span> <span class="mh">0x2557</span><span class="p">,</span>
	<span class="mh">0x04b0</span><span class="p">,</span> <span class="mh">0x04b1</span><span class="p">,</span> <span class="mh">0x04b2</span><span class="p">,</span> <span class="mh">0x04b3</span><span class="p">,</span> <span class="mh">0x04b4</span><span class="p">,</span> <span class="mh">0x04b5</span><span class="p">,</span> <span class="mh">0x04b6</span><span class="p">,</span> <span class="mh">0x2567</span><span class="p">,</span> <span class="mh">0x04b8</span><span class="p">,</span> <span class="mh">0x04b9</span><span class="p">,</span> <span class="mh">0x04ba</span><span class="p">,</span> <span class="mh">0x04bb</span><span class="p">,</span> <span class="mh">0x04bc</span><span class="p">,</span> <span class="mh">0x04bd</span><span class="p">,</span> <span class="mh">0x253e</span><span class="p">,</span> <span class="mh">0x2577</span><span class="p">,</span>
	<span class="mh">0x08c0</span><span class="p">,</span> <span class="mh">0x08c1</span><span class="p">,</span> <span class="mh">0x08c2</span><span class="p">,</span> <span class="mh">0x08c3</span><span class="p">,</span> <span class="mh">0x08c4</span><span class="p">,</span> <span class="mh">0x08c5</span><span class="p">,</span> <span class="mh">0x08c6</span><span class="p">,</span> <span class="mh">0x2987</span><span class="p">,</span> <span class="mh">0x08c8</span><span class="p">,</span> <span class="mh">0x08c9</span><span class="p">,</span> <span class="mh">0x08ca</span><span class="p">,</span> <span class="mh">0x08cb</span><span class="p">,</span> <span class="mh">0x08cc</span><span class="p">,</span> <span class="mh">0x08cd</span><span class="p">,</span> <span class="mh">0x08ce</span><span class="p">,</span> <span class="mh">0x2997</span><span class="p">,</span>
	<span class="mh">0x08d0</span><span class="p">,</span> <span class="mh">0x08d1</span><span class="p">,</span> <span class="mh">0x08d2</span><span class="p">,</span> <span class="mh">0x08d3</span><span class="p">,</span> <span class="mh">0x08d4</span><span class="p">,</span> <span class="mh">0x08d5</span><span class="p">,</span> <span class="mh">0x08d6</span><span class="p">,</span> <span class="mh">0x29a7</span><span class="p">,</span> <span class="mh">0x08d8</span><span class="p">,</span> <span class="mh">0x08d9</span><span class="p">,</span> <span class="mh">0x08da</span><span class="p">,</span> <span class="mh">0x08db</span><span class="p">,</span> <span class="mh">0x08dc</span><span class="p">,</span> <span class="mh">0x08dd</span><span class="p">,</span> <span class="mh">0x08de</span><span class="p">,</span> <span class="mh">0x29b7</span><span class="p">,</span>
	<span class="mh">0x0ce0</span><span class="p">,</span> <span class="mh">0x0ce1</span><span class="p">,</span> <span class="mh">0x0ce2</span><span class="p">,</span> <span class="mh">0x0ce3</span><span class="p">,</span> <span class="mh">0x0ce4</span><span class="p">,</span> <span class="mh">0x0ce5</span><span class="p">,</span> <span class="mh">0x0ce6</span><span class="p">,</span> <span class="mh">0x2dc7</span><span class="p">,</span> <span class="mh">0x0ce8</span><span class="p">,</span> <span class="mh">0x0ce9</span><span class="p">,</span> <span class="mh">0x0cea</span><span class="p">,</span> <span class="mh">0x0ceb</span><span class="p">,</span> <span class="mh">0x0cec</span><span class="p">,</span> <span class="mh">0x0ced</span><span class="p">,</span> <span class="mh">0x0cee</span><span class="p">,</span> <span class="mh">0x2dd7</span><span class="p">,</span>
	<span class="mh">0x10f0</span><span class="p">,</span> <span class="mh">0x10f1</span><span class="p">,</span> <span class="mh">0x10f2</span><span class="p">,</span> <span class="mh">0x10f3</span><span class="p">,</span> <span class="mh">0x10f4</span><span class="p">,</span> <span class="mh">0x10f5</span><span class="p">,</span> <span class="mh">0x10f6</span><span class="p">,</span> <span class="mh">0x31e7</span><span class="p">,</span> <span class="mh">0x20f8</span><span class="p">,</span> <span class="mh">0x20f9</span><span class="p">,</span> <span class="mh">0x20fa</span><span class="p">,</span> <span class="mh">0x20fb</span><span class="p">,</span> <span class="mh">0x257c</span><span class="p">,</span> <span class="mh">0x257d</span><span class="p">,</span> <span class="mh">0x29be</span><span class="p">,</span> <span class="mh">0x41f7</span><span class="p">,</span>

<span class="cm">/* previous 1s = 3: */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x2003</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x200b</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x2013</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x201b</span><span class="p">,</span>
	<span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x2023</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x202b</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x0019</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="mh">0x2033</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="mh">0x203b</span><span class="p">,</span>
	<span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x2043</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="mh">0x0025</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x204b</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x0029</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x2053</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">,</span> <span class="mh">0x002d</span><span class="p">,</span> <span class="mh">0x002e</span><span class="p">,</span> <span class="mh">0x205b</span><span class="p">,</span>
	<span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x2063</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x206b</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x0039</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">,</span> <span class="mh">0x2073</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">,</span> <span class="mh">0x003d</span><span class="p">,</span> <span class="mh">0x203e</span><span class="p">,</span> <span class="mh">0x207b</span><span class="p">,</span>
	<span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span> <span class="mh">0x2083</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span> <span class="mh">0x0045</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x208b</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0x0049</span><span class="p">,</span> <span class="mh">0x004a</span><span class="p">,</span> <span class="mh">0x2093</span><span class="p">,</span> <span class="mh">0x004c</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x004e</span><span class="p">,</span> <span class="mh">0x209b</span><span class="p">,</span>
	<span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="mh">0x20a3</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">,</span> <span class="mh">0x0055</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span> <span class="mh">0x20ab</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span> <span class="mh">0x20b3</span><span class="p">,</span> <span class="mh">0x005c</span><span class="p">,</span> <span class="mh">0x005d</span><span class="p">,</span> <span class="mh">0x005e</span><span class="p">,</span> <span class="mh">0x20bb</span><span class="p">,</span>
	<span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0061</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x20c3</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">,</span> <span class="mh">0x0065</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x20cb</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x20d3</span><span class="p">,</span> <span class="mh">0x006c</span><span class="p">,</span> <span class="mh">0x006d</span><span class="p">,</span> <span class="mh">0x006e</span><span class="p">,</span> <span class="mh">0x20db</span><span class="p">,</span>
	<span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x0071</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span> <span class="mh">0x20e3</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span> <span class="mh">0x0075</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0x20eb</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x0079</span><span class="p">,</span> <span class="mh">0x007a</span><span class="p">,</span> <span class="mh">0x20f3</span><span class="p">,</span> <span class="mh">0x207c</span><span class="p">,</span> <span class="mh">0x207d</span><span class="p">,</span> <span class="mh">0x20be</span><span class="p">,</span> <span class="mh">0x40fb</span><span class="p">,</span>
	<span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0481</span><span class="p">,</span> <span class="mh">0x0482</span><span class="p">,</span> <span class="mh">0x2503</span><span class="p">,</span> <span class="mh">0x0484</span><span class="p">,</span> <span class="mh">0x0485</span><span class="p">,</span> <span class="mh">0x0486</span><span class="p">,</span> <span class="mh">0x250b</span><span class="p">,</span> <span class="mh">0x0488</span><span class="p">,</span> <span class="mh">0x0489</span><span class="p">,</span> <span class="mh">0x048a</span><span class="p">,</span> <span class="mh">0x2513</span><span class="p">,</span> <span class="mh">0x048c</span><span class="p">,</span> <span class="mh">0x048d</span><span class="p">,</span> <span class="mh">0x048e</span><span class="p">,</span> <span class="mh">0x251b</span><span class="p">,</span>
	<span class="mh">0x0490</span><span class="p">,</span> <span class="mh">0x0491</span><span class="p">,</span> <span class="mh">0x0492</span><span class="p">,</span> <span class="mh">0x2523</span><span class="p">,</span> <span class="mh">0x0494</span><span class="p">,</span> <span class="mh">0x0495</span><span class="p">,</span> <span class="mh">0x0496</span><span class="p">,</span> <span class="mh">0x252b</span><span class="p">,</span> <span class="mh">0x0498</span><span class="p">,</span> <span class="mh">0x0499</span><span class="p">,</span> <span class="mh">0x049a</span><span class="p">,</span> <span class="mh">0x2533</span><span class="p">,</span> <span class="mh">0x049c</span><span class="p">,</span> <span class="mh">0x049d</span><span class="p">,</span> <span class="mh">0x049e</span><span class="p">,</span> <span class="mh">0x253b</span><span class="p">,</span>
	<span class="mh">0x04a0</span><span class="p">,</span> <span class="mh">0x04a1</span><span class="p">,</span> <span class="mh">0x04a2</span><span class="p">,</span> <span class="mh">0x2543</span><span class="p">,</span> <span class="mh">0x04a4</span><span class="p">,</span> <span class="mh">0x04a5</span><span class="p">,</span> <span class="mh">0x04a6</span><span class="p">,</span> <span class="mh">0x254b</span><span class="p">,</span> <span class="mh">0x04a8</span><span class="p">,</span> <span class="mh">0x04a9</span><span class="p">,</span> <span class="mh">0x04aa</span><span class="p">,</span> <span class="mh">0x2553</span><span class="p">,</span> <span class="mh">0x04ac</span><span class="p">,</span> <span class="mh">0x04ad</span><span class="p">,</span> <span class="mh">0x04ae</span><span class="p">,</span> <span class="mh">0x255b</span><span class="p">,</span>
	<span class="mh">0x04b0</span><span class="p">,</span> <span class="mh">0x04b1</span><span class="p">,</span> <span class="mh">0x04b2</span><span class="p">,</span> <span class="mh">0x2563</span><span class="p">,</span> <span class="mh">0x04b4</span><span class="p">,</span> <span class="mh">0x04b5</span><span class="p">,</span> <span class="mh">0x04b6</span><span class="p">,</span> <span class="mh">0x256b</span><span class="p">,</span> <span class="mh">0x04b8</span><span class="p">,</span> <span class="mh">0x04b9</span><span class="p">,</span> <span class="mh">0x04ba</span><span class="p">,</span> <span class="mh">0x2573</span><span class="p">,</span> <span class="mh">0x04bc</span><span class="p">,</span> <span class="mh">0x04bd</span><span class="p">,</span> <span class="mh">0x253e</span><span class="p">,</span> <span class="mh">0x257b</span><span class="p">,</span>
	<span class="mh">0x08c0</span><span class="p">,</span> <span class="mh">0x08c1</span><span class="p">,</span> <span class="mh">0x08c2</span><span class="p">,</span> <span class="mh">0x2983</span><span class="p">,</span> <span class="mh">0x08c4</span><span class="p">,</span> <span class="mh">0x08c5</span><span class="p">,</span> <span class="mh">0x08c6</span><span class="p">,</span> <span class="mh">0x298b</span><span class="p">,</span> <span class="mh">0x08c8</span><span class="p">,</span> <span class="mh">0x08c9</span><span class="p">,</span> <span class="mh">0x08ca</span><span class="p">,</span> <span class="mh">0x2993</span><span class="p">,</span> <span class="mh">0x08cc</span><span class="p">,</span> <span class="mh">0x08cd</span><span class="p">,</span> <span class="mh">0x08ce</span><span class="p">,</span> <span class="mh">0x299b</span><span class="p">,</span>
	<span class="mh">0x08d0</span><span class="p">,</span> <span class="mh">0x08d1</span><span class="p">,</span> <span class="mh">0x08d2</span><span class="p">,</span> <span class="mh">0x29a3</span><span class="p">,</span> <span class="mh">0x08d4</span><span class="p">,</span> <span class="mh">0x08d5</span><span class="p">,</span> <span class="mh">0x08d6</span><span class="p">,</span> <span class="mh">0x29ab</span><span class="p">,</span> <span class="mh">0x08d8</span><span class="p">,</span> <span class="mh">0x08d9</span><span class="p">,</span> <span class="mh">0x08da</span><span class="p">,</span> <span class="mh">0x29b3</span><span class="p">,</span> <span class="mh">0x08dc</span><span class="p">,</span> <span class="mh">0x08dd</span><span class="p">,</span> <span class="mh">0x08de</span><span class="p">,</span> <span class="mh">0x29bb</span><span class="p">,</span>
	<span class="mh">0x0ce0</span><span class="p">,</span> <span class="mh">0x0ce1</span><span class="p">,</span> <span class="mh">0x0ce2</span><span class="p">,</span> <span class="mh">0x2dc3</span><span class="p">,</span> <span class="mh">0x0ce4</span><span class="p">,</span> <span class="mh">0x0ce5</span><span class="p">,</span> <span class="mh">0x0ce6</span><span class="p">,</span> <span class="mh">0x2dcb</span><span class="p">,</span> <span class="mh">0x0ce8</span><span class="p">,</span> <span class="mh">0x0ce9</span><span class="p">,</span> <span class="mh">0x0cea</span><span class="p">,</span> <span class="mh">0x2dd3</span><span class="p">,</span> <span class="mh">0x0cec</span><span class="p">,</span> <span class="mh">0x0ced</span><span class="p">,</span> <span class="mh">0x0cee</span><span class="p">,</span> <span class="mh">0x2ddb</span><span class="p">,</span>
	<span class="mh">0x10f0</span><span class="p">,</span> <span class="mh">0x10f1</span><span class="p">,</span> <span class="mh">0x10f2</span><span class="p">,</span> <span class="mh">0x31e3</span><span class="p">,</span> <span class="mh">0x10f4</span><span class="p">,</span> <span class="mh">0x10f5</span><span class="p">,</span> <span class="mh">0x10f6</span><span class="p">,</span> <span class="mh">0x31eb</span><span class="p">,</span> <span class="mh">0x20f8</span><span class="p">,</span> <span class="mh">0x20f9</span><span class="p">,</span> <span class="mh">0x20fa</span><span class="p">,</span> <span class="mh">0x41f3</span><span class="p">,</span> <span class="mh">0x257c</span><span class="p">,</span> <span class="mh">0x257d</span><span class="p">,</span> <span class="mh">0x29be</span><span class="p">,</span> <span class="mh">0x46fb</span><span class="p">,</span>

<span class="cm">/* previous 1s = 4: */</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x2001</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x2005</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x2009</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x200d</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x2011</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x2015</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x2019</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x201d</span><span class="p">,</span>
	<span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x2021</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x2025</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x2029</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="mh">0x202d</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x2031</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="mh">0x2035</span><span class="p">,</span> <span class="mh">0x001c</span><span class="p">,</span> <span class="mh">0x2039</span><span class="p">,</span> <span class="mh">0x001e</span><span class="p">,</span> <span class="mh">0x203d</span><span class="p">,</span>
	<span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x2041</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x2045</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="mh">0x2049</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x204d</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x2051</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x2055</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">,</span> <span class="mh">0x2059</span><span class="p">,</span> <span class="mh">0x002e</span><span class="p">,</span> <span class="mh">0x205d</span><span class="p">,</span>
	<span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x2061</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x2065</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">,</span> <span class="mh">0x2069</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x206d</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x2071</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">,</span> <span class="mh">0x2075</span><span class="p">,</span> <span class="mh">0x003c</span><span class="p">,</span> <span class="mh">0x2079</span><span class="p">,</span> <span class="mh">0x203e</span><span class="p">,</span> <span class="mh">0x407d</span><span class="p">,</span>
	<span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x2081</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span> <span class="mh">0x2085</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span> <span class="mh">0x2089</span><span class="p">,</span> <span class="mh">0x0046</span><span class="p">,</span> <span class="mh">0x208d</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0x2091</span><span class="p">,</span> <span class="mh">0x004a</span><span class="p">,</span> <span class="mh">0x2095</span><span class="p">,</span> <span class="mh">0x004c</span><span class="p">,</span> <span class="mh">0x2099</span><span class="p">,</span> <span class="mh">0x004e</span><span class="p">,</span> <span class="mh">0x209d</span><span class="p">,</span>
	<span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x20a1</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="mh">0x20a5</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">,</span> <span class="mh">0x20a9</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span> <span class="mh">0x20ad</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x20b1</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span> <span class="mh">0x20b5</span><span class="p">,</span> <span class="mh">0x005c</span><span class="p">,</span> <span class="mh">0x20b9</span><span class="p">,</span> <span class="mh">0x005e</span><span class="p">,</span> <span class="mh">0x20bd</span><span class="p">,</span>
	<span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x20c1</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x20c5</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">,</span> <span class="mh">0x20c9</span><span class="p">,</span> <span class="mh">0x0066</span><span class="p">,</span> <span class="mh">0x20cd</span><span class="p">,</span> <span class="mh">0x0068</span><span class="p">,</span> <span class="mh">0x20d1</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">,</span> <span class="mh">0x20d5</span><span class="p">,</span> <span class="mh">0x006c</span><span class="p">,</span> <span class="mh">0x20d9</span><span class="p">,</span> <span class="mh">0x006e</span><span class="p">,</span> <span class="mh">0x20dd</span><span class="p">,</span>
	<span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x20e1</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span> <span class="mh">0x20e5</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span> <span class="mh">0x20e9</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0x20ed</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x20f1</span><span class="p">,</span> <span class="mh">0x007a</span><span class="p">,</span> <span class="mh">0x20f5</span><span class="p">,</span> <span class="mh">0x207c</span><span class="p">,</span> <span class="mh">0x40f9</span><span class="p">,</span> <span class="mh">0x20be</span><span class="p">,</span> <span class="mh">0x417d</span><span class="p">,</span>
	<span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x2501</span><span class="p">,</span> <span class="mh">0x0482</span><span class="p">,</span> <span class="mh">0x2505</span><span class="p">,</span> <span class="mh">0x0484</span><span class="p">,</span> <span class="mh">0x2509</span><span class="p">,</span> <span class="mh">0x0486</span><span class="p">,</span> <span class="mh">0x250d</span><span class="p">,</span> <span class="mh">0x0488</span><span class="p">,</span> <span class="mh">0x2511</span><span class="p">,</span> <span class="mh">0x048a</span><span class="p">,</span> <span class="mh">0x2515</span><span class="p">,</span> <span class="mh">0x048c</span><span class="p">,</span> <span class="mh">0x2519</span><span class="p">,</span> <span class="mh">0x048e</span><span class="p">,</span> <span class="mh">0x251d</span><span class="p">,</span>
	<span class="mh">0x0490</span><span class="p">,</span> <span class="mh">0x2521</span><span class="p">,</span> <span class="mh">0x0492</span><span class="p">,</span> <span class="mh">0x2525</span><span class="p">,</span> <span class="mh">0x0494</span><span class="p">,</span> <span class="mh">0x2529</span><span class="p">,</span> <span class="mh">0x0496</span><span class="p">,</span> <span class="mh">0x252d</span><span class="p">,</span> <span class="mh">0x0498</span><span class="p">,</span> <span class="mh">0x2531</span><span class="p">,</span> <span class="mh">0x049a</span><span class="p">,</span> <span class="mh">0x2535</span><span class="p">,</span> <span class="mh">0x049c</span><span class="p">,</span> <span class="mh">0x2539</span><span class="p">,</span> <span class="mh">0x049e</span><span class="p">,</span> <span class="mh">0x253d</span><span class="p">,</span>
	<span class="mh">0x04a0</span><span class="p">,</span> <span class="mh">0x2541</span><span class="p">,</span> <span class="mh">0x04a2</span><span class="p">,</span> <span class="mh">0x2545</span><span class="p">,</span> <span class="mh">0x04a4</span><span class="p">,</span> <span class="mh">0x2549</span><span class="p">,</span> <span class="mh">0x04a6</span><span class="p">,</span> <span class="mh">0x254d</span><span class="p">,</span> <span class="mh">0x04a8</span><span class="p">,</span> <span class="mh">0x2551</span><span class="p">,</span> <span class="mh">0x04aa</span><span class="p">,</span> <span class="mh">0x2555</span><span class="p">,</span> <span class="mh">0x04ac</span><span class="p">,</span> <span class="mh">0x2559</span><span class="p">,</span> <span class="mh">0x04ae</span><span class="p">,</span> <span class="mh">0x255d</span><span class="p">,</span>
	<span class="mh">0x04b0</span><span class="p">,</span> <span class="mh">0x2561</span><span class="p">,</span> <span class="mh">0x04b2</span><span class="p">,</span> <span class="mh">0x2565</span><span class="p">,</span> <span class="mh">0x04b4</span><span class="p">,</span> <span class="mh">0x2569</span><span class="p">,</span> <span class="mh">0x04b6</span><span class="p">,</span> <span class="mh">0x256d</span><span class="p">,</span> <span class="mh">0x04b8</span><span class="p">,</span> <span class="mh">0x2571</span><span class="p">,</span> <span class="mh">0x04ba</span><span class="p">,</span> <span class="mh">0x2575</span><span class="p">,</span> <span class="mh">0x04bc</span><span class="p">,</span> <span class="mh">0x2579</span><span class="p">,</span> <span class="mh">0x253e</span><span class="p">,</span> <span class="mh">0x467d</span><span class="p">,</span>
	<span class="mh">0x08c0</span><span class="p">,</span> <span class="mh">0x2981</span><span class="p">,</span> <span class="mh">0x08c2</span><span class="p">,</span> <span class="mh">0x2985</span><span class="p">,</span> <span class="mh">0x08c4</span><span class="p">,</span> <span class="mh">0x2989</span><span class="p">,</span> <span class="mh">0x08c6</span><span class="p">,</span> <span class="mh">0x298d</span><span class="p">,</span> <span class="mh">0x08c8</span><span class="p">,</span> <span class="mh">0x2991</span><span class="p">,</span> <span class="mh">0x08ca</span><span class="p">,</span> <span class="mh">0x2995</span><span class="p">,</span> <span class="mh">0x08cc</span><span class="p">,</span> <span class="mh">0x2999</span><span class="p">,</span> <span class="mh">0x08ce</span><span class="p">,</span> <span class="mh">0x299d</span><span class="p">,</span>
	<span class="mh">0x08d0</span><span class="p">,</span> <span class="mh">0x29a1</span><span class="p">,</span> <span class="mh">0x08d2</span><span class="p">,</span> <span class="mh">0x29a5</span><span class="p">,</span> <span class="mh">0x08d4</span><span class="p">,</span> <span class="mh">0x29a9</span><span class="p">,</span> <span class="mh">0x08d6</span><span class="p">,</span> <span class="mh">0x29ad</span><span class="p">,</span> <span class="mh">0x08d8</span><span class="p">,</span> <span class="mh">0x29b1</span><span class="p">,</span> <span class="mh">0x08da</span><span class="p">,</span> <span class="mh">0x29b5</span><span class="p">,</span> <span class="mh">0x08dc</span><span class="p">,</span> <span class="mh">0x29b9</span><span class="p">,</span> <span class="mh">0x08de</span><span class="p">,</span> <span class="mh">0x29bd</span><span class="p">,</span>
	<span class="mh">0x0ce0</span><span class="p">,</span> <span class="mh">0x2dc1</span><span class="p">,</span> <span class="mh">0x0ce2</span><span class="p">,</span> <span class="mh">0x2dc5</span><span class="p">,</span> <span class="mh">0x0ce4</span><span class="p">,</span> <span class="mh">0x2dc9</span><span class="p">,</span> <span class="mh">0x0ce6</span><span class="p">,</span> <span class="mh">0x2dcd</span><span class="p">,</span> <span class="mh">0x0ce8</span><span class="p">,</span> <span class="mh">0x2dd1</span><span class="p">,</span> <span class="mh">0x0cea</span><span class="p">,</span> <span class="mh">0x2dd5</span><span class="p">,</span> <span class="mh">0x0cec</span><span class="p">,</span> <span class="mh">0x2dd9</span><span class="p">,</span> <span class="mh">0x0cee</span><span class="p">,</span> <span class="mh">0x2ddd</span><span class="p">,</span>
	<span class="mh">0x10f0</span><span class="p">,</span> <span class="mh">0x31e1</span><span class="p">,</span> <span class="mh">0x10f2</span><span class="p">,</span> <span class="mh">0x31e5</span><span class="p">,</span> <span class="mh">0x10f4</span><span class="p">,</span> <span class="mh">0x31e9</span><span class="p">,</span> <span class="mh">0x10f6</span><span class="p">,</span> <span class="mh">0x31ed</span><span class="p">,</span> <span class="mh">0x20f8</span><span class="p">,</span> <span class="mh">0x41f1</span><span class="p">,</span> <span class="mh">0x20fa</span><span class="p">,</span> <span class="mh">0x41f5</span><span class="p">,</span> <span class="mh">0x257c</span><span class="p">,</span> <span class="mh">0x46f9</span><span class="p">,</span> <span class="mh">0x29be</span><span class="p">,</span> <span class="mh">0x4b7d</span>
<span class="p">};</span>

<span class="cm">/* hdlc_bitstuff_byte</span>
<span class="cm"> * perform HDLC bitstuffing for one input byte (8 bits, LSB first)</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	cin	input byte</span>
<span class="cm"> *	ones	number of trailing &#39;1&#39; bits in result before this step</span>
<span class="cm"> *	iwb	pointer to output buffer structure</span>
<span class="cm"> *		(write semaphore must be held)</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of trailing &#39;1&#39; bits in result after this step</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdlc_bitstuff_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cin</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">ones</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">stuff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shiftinc</span><span class="p">,</span> <span class="n">newones</span><span class="p">;</span>

	<span class="cm">/* get stuffing information for input byte</span>
<span class="cm">	 * value: bit  9.. 0 = result bits</span>
<span class="cm">	 *        bit 12..10 = number of trailing &#39;1&#39; bits in result</span>
<span class="cm">	 *        bit 14..13 = number of bits added by stuffing</span>
<span class="cm">	 */</span>
	<span class="n">stuff</span> <span class="o">=</span> <span class="n">stufftab</span><span class="p">[</span><span class="mi">256</span> <span class="o">*</span> <span class="n">ones</span> <span class="o">+</span> <span class="n">cin</span><span class="p">];</span>
	<span class="n">shiftinc</span> <span class="o">=</span> <span class="p">(</span><span class="n">stuff</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">newones</span> <span class="o">=</span> <span class="p">(</span><span class="n">stuff</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">stuff</span> <span class="o">&amp;=</span> <span class="mh">0x3ff</span><span class="p">;</span>

	<span class="cm">/* append stuffed byte to output stream */</span>
	<span class="n">isowbuf_putbits</span><span class="p">(</span><span class="n">iwb</span><span class="p">,</span> <span class="n">stuff</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">shiftinc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">newones</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hdlc_buildframe</span>
<span class="cm"> * Perform HDLC framing with bitstuffing on a byte buffer</span>
<span class="cm"> * The input buffer is regarded as a sequence of bits, starting with the least</span>
<span class="cm"> * significant bit of the first byte and ending with the most significant bit</span>
<span class="cm"> * of the last byte. A 16 bit FCS is appended as defined by RFC 1662.</span>
<span class="cm"> * Whenever five consecutive &#39;1&#39; bits appear in the resulting bit sequence, a</span>
<span class="cm"> * &#39;0&#39; bit is inserted after them.</span>
<span class="cm"> * The resulting bit string and a closing flag pattern (PPP_FLAG, &#39;01111110&#39;)</span>
<span class="cm"> * are appended to the output buffer starting at the given bit position, which</span>
<span class="cm"> * is assumed to already contain a leading flag.</span>
<span class="cm"> * The output buffer must have sufficient length; count + count/5 + 6 bytes</span>
<span class="cm"> * starting at *out are safe and are verified to be present.</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	in	input buffer</span>
<span class="cm"> *	count	number of bytes in input buffer</span>
<span class="cm"> *	iwb	pointer to output buffer structure</span>
<span class="cm"> *		(write semaphore must be held)</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	position of end of packet in output buffer on success,</span>
<span class="cm"> *	-EAGAIN if write semaphore busy or buffer full</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdlc_buildframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ones</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isowbuf_freebytes</span><span class="p">(</span><span class="n">iwb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">+</span> <span class="n">count</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">||</span>
	    <span class="n">isowbuf_startwrite</span><span class="p">(</span><span class="n">iwb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: %d bytes free -&gt; -EAGAIN&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">isowbuf_freebytes</span><span class="p">(</span><span class="n">iwb</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dump_bytes</span><span class="p">(</span><span class="n">DEBUG_STREAM_DUMP</span><span class="p">,</span> <span class="s">&quot;snd data&quot;</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* bitstuff and checksum input data */</span>
	<span class="n">fcs</span> <span class="o">=</span> <span class="n">PPP_INITFCS</span><span class="p">;</span>
	<span class="n">ones</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">in</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ones</span> <span class="o">=</span> <span class="n">hdlc_bitstuff_byte</span><span class="p">(</span><span class="n">iwb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ones</span><span class="p">);</span>
		<span class="n">fcs</span> <span class="o">=</span> <span class="n">crc_ccitt_byte</span><span class="p">(</span><span class="n">fcs</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* bitstuff and append FCS</span>
<span class="cm">	 * (complemented, least significant byte first) */</span>
	<span class="n">fcs</span> <span class="o">^=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">ones</span> <span class="o">=</span> <span class="n">hdlc_bitstuff_byte</span><span class="p">(</span><span class="n">iwb</span><span class="p">,</span> <span class="n">fcs</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">,</span> <span class="n">ones</span><span class="p">);</span>
	<span class="n">ones</span> <span class="o">=</span> <span class="n">hdlc_bitstuff_byte</span><span class="p">(</span><span class="n">iwb</span><span class="p">,</span> <span class="p">(</span><span class="n">fcs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">,</span> <span class="n">ones</span><span class="p">);</span>

	<span class="cm">/* put closing flag and repeat byte for flag idle */</span>
	<span class="n">isowbuf_putflag</span><span class="p">(</span><span class="n">iwb</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">isowbuf_donewrite</span><span class="p">(</span><span class="n">iwb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">end</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* trans_buildframe</span>
<span class="cm"> * Append a block of &#39;transparent&#39; data to the output buffer,</span>
<span class="cm"> * inverting the bytes.</span>
<span class="cm"> * The output buffer must have sufficient length; count bytes</span>
<span class="cm"> * starting at *out are safe and are verified to be present.</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	in	input buffer</span>
<span class="cm"> *	count	number of bytes in input buffer</span>
<span class="cm"> *	iwb	pointer to output buffer structure</span>
<span class="cm"> *		(write semaphore must be held)</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	position of end of packet in output buffer on success,</span>
<span class="cm"> *	-EAGAIN if write semaphore busy or buffer full</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">trans_buildframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span> <span class="o">*</span><span class="n">iwb</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">write</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isowbuf_freebytes</span><span class="p">(</span><span class="n">iwb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span> <span class="o">||</span>
	    <span class="n">isowbuf_startwrite</span><span class="p">(</span><span class="n">iwb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;can&#39;t put %d bytes&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_STREAM</span><span class="p">,</span> <span class="s">&quot;put %d bytes&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">dump_bytes</span><span class="p">(</span><span class="n">DEBUG_STREAM_DUMP</span><span class="p">,</span> <span class="s">&quot;snd data&quot;</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">write</span> <span class="o">=</span> <span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="o">++</span><span class="p">);</span>
		<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">write</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">write</span> <span class="o">%=</span> <span class="n">BAS_OUTBUFSIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">write</span><span class="p">;</span>
	<span class="n">iwb</span><span class="o">-&gt;</span><span class="n">idle</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">isowbuf_donewrite</span><span class="p">(</span><span class="n">iwb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">gigaset_isoc_buildframe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2_HDLC</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">hdlc_buildframe</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: %d bytes HDLC -&gt; %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>			<span class="cm">/* assume transparent */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">trans_buildframe</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: %d bytes trans -&gt; %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hdlc_putbyte</span>
<span class="cm"> * append byte c to current skb of B channel structure *bcs, updating fcs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlc_putbyte</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_fcs</span> <span class="o">=</span> <span class="n">crc_ccitt_byte</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_fcs</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* skipping */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received oversized packet discarded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">giants</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">__skb_put</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hdlc_flush</span>
<span class="cm"> * drop partial HDLC data packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlc_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear skb or allocate new if not skipping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">gigaset_new_rx_skb</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>

	<span class="cm">/* reset packet state */</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_fcs</span> <span class="o">=</span> <span class="n">PPP_INITFCS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hdlc_done</span>
<span class="cm"> * process completed HDLC data packet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlc_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">procskb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="o">--</span><span class="p">;</span>
		<span class="n">hdlc_flush</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">procskb</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">procskb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* previous error */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: skb=NULL&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">gigaset_isdn_rcv_err</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">procskb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received short frame (%d octets)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">procskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">runts</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">procskb</span><span class="p">);</span>
		<span class="n">gigaset_isdn_rcv_err</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_fcs</span> <span class="o">!=</span> <span class="n">PPP_GOODFCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;frame check error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">fcserrs</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">procskb</span><span class="p">);</span>
		<span class="n">gigaset_isdn_rcv_err</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">procskb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">__skb_trim</span><span class="p">(</span><span class="n">procskb</span><span class="p">,</span> <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* subtract FCS */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: good frame (%d octets)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dump_bytes</span><span class="p">(</span><span class="n">DEBUG_STREAM_DUMP</span><span class="p">,</span>
			   <span class="s">&quot;rcv data&quot;</span><span class="p">,</span> <span class="n">procskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">goodbytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">gigaset_skb_rcvd</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">procskb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">gigaset_new_rx_skb</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_fcs</span> <span class="o">=</span> <span class="n">PPP_INITFCS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hdlc_frag</span>
<span class="cm"> * drop HDLC data packet with non-integral last byte</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlc_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">inbits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="o">--</span><span class="p">;</span>
		<span class="n">hdlc_flush</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_notice</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received partial byte (%d bits)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inbits</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">alignerrs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">gigaset_isdn_rcv_err</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="n">__skb_trim</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_fcs</span> <span class="o">=</span> <span class="n">PPP_INITFCS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* bit counts lookup table for HDLC bit unstuffing</span>
<span class="cm"> * index: input byte</span>
<span class="cm"> * value: bit 0..3 = number of consecutive &#39;1&#39; bits starting from LSB</span>
<span class="cm"> *        bit 4..6 = number of consecutive &#39;1&#39; bits starting from MSB</span>
<span class="cm"> *		     (replacing 8 by 7 to make it fit; the algorithm won&#39;t care)</span>
<span class="cm"> *        bit 7 set if there are 5 or more &quot;interior&quot; consecutive &#39;1&#39; bits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bitcounts</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span>
	<span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x78</span>
<span class="p">};</span>

<span class="cm">/* hdlc_unpack</span>
<span class="cm"> * perform HDLC frame processing (bit unstuffing, flag detection, FCS</span>
<span class="cm"> * calculation) on a sequence of received data bytes (8 bits each, LSB first)</span>
<span class="cm"> * pass on successfully received, complete frames as SKBs via gigaset_skb_rcvd</span>
<span class="cm"> * notify of errors via gigaset_isdn_rcv_err</span>
<span class="cm"> * tally frames, errors etc. in BC structure counters</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	src	received data</span>
<span class="cm"> *	count	number of received bytes</span>
<span class="cm"> *	bcs	receiving B channel structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdlc_unpack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">inputstate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">seqlen</span><span class="p">,</span> <span class="n">inbyte</span><span class="p">,</span> <span class="n">inbits</span><span class="p">;</span>

	<span class="cm">/* load previous state:</span>
<span class="cm">	 * inputstate = set of flag bits:</span>
<span class="cm">	 * - INS_flag_hunt: no complete opening flag received since connection</span>
<span class="cm">	 *                  setup or last abort</span>
<span class="cm">	 * - INS_have_data: at least one complete data byte received since last</span>
<span class="cm">	 *                  flag</span>
<span class="cm">	 * seqlen = number of consecutive &#39;1&#39; bits in last 7 input stream bits</span>
<span class="cm">	 *          (0..7)</span>
<span class="cm">	 * inbyte = accumulated partial data byte (if !INS_flag_hunt)</span>
<span class="cm">	 * inbits = number of valid bits in inbyte, starting at LSB (0..6)</span>
<span class="cm">	 */</span>
	<span class="n">inputstate</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">inputstate</span><span class="p">;</span>
	<span class="n">seqlen</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">seqlen</span><span class="p">;</span>
	<span class="n">inbyte</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">inbyte</span><span class="p">;</span>
	<span class="n">inbits</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">inbits</span><span class="p">;</span>

	<span class="cm">/* bit unstuffing a byte a time</span>
<span class="cm">	 * Take your time to understand this; it&#39;s straightforward but tedious.</span>
<span class="cm">	 * The &quot;bitcounts&quot; lookup table is used to speed up the counting of</span>
<span class="cm">	 * leading and trailing &#39;1&#39; bits.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tabentry</span> <span class="o">=</span> <span class="n">bitcounts</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="n">lead1</span> <span class="o">=</span> <span class="n">tabentry</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">trail1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tabentry</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

		<span class="n">seqlen</span> <span class="o">+=</span> <span class="n">lead1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">inputstate</span> <span class="o">&amp;</span> <span class="n">INS_flag_hunt</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PPP_FLAG</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* flag-in-one */</span>
				<span class="n">inputstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INS_flag_hunt</span> <span class="o">|</span> <span class="n">INS_have_data</span><span class="p">);</span>
				<span class="n">inbyte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">inbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seqlen</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">trail1</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* flag completed &amp; not followed by abort */</span>
				<span class="n">inputstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INS_flag_hunt</span> <span class="o">|</span> <span class="n">INS_have_data</span><span class="p">);</span>
				<span class="n">inbyte</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">lead1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">inbits</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">lead1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">trail1</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* interior stuffing:</span>
<span class="cm">					 * omitting the MSB handles most cases,</span>
<span class="cm">					 * correct the incorrectly handled</span>
<span class="cm">					 * cases individually */</span>
					<span class="n">inbits</span><span class="o">--</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mh">0xbe</span>:
						<span class="n">inbyte</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* else: continue flag-hunting */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">seqlen</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">trail1</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* streamlined case: 8 data bits, no stuffing */</span>
			<span class="n">inbyte</span> <span class="o">|=</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">inbits</span><span class="p">;</span>
			<span class="n">hdlc_putbyte</span><span class="p">(</span><span class="n">inbyte</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">bcs</span><span class="p">);</span>
			<span class="n">inputstate</span> <span class="o">|=</span> <span class="n">INS_have_data</span><span class="p">;</span>
			<span class="n">inbyte</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="cm">/* inbits unchanged */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">seqlen</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">inbits</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">lead1</span> <span class="o">&amp;&amp;</span>
				  <span class="n">trail1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">inbits</span> <span class="o">&amp;&amp;</span>
				  <span class="o">!</span><span class="p">(</span><span class="n">inputstate</span> <span class="o">&amp;</span> <span class="n">INS_have_data</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* streamlined case: flag idle - state unchanged */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">seqlen</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* abort sequence */</span>
			<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">aborts</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdlc_flush</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="n">inputstate</span> <span class="o">|=</span> <span class="n">INS_flag_hunt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seqlen</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* closing flag, including (6 - lead1) &#39;1&#39;s</span>
<span class="cm">			 * and one &#39;0&#39; from inbits */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inbits</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">lead1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdlc_frag</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">inbits</span> <span class="o">+</span> <span class="n">lead1</span> <span class="o">-</span> <span class="mi">7</span><span class="p">);</span>
				<span class="n">inputstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INS_have_data</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inbits</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">lead1</span><span class="p">)</span>
					<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">stolen0s</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inputstate</span> <span class="o">&amp;</span> <span class="n">INS_have_data</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hdlc_done</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
					<span class="n">inputstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INS_have_data</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PPP_FLAG</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* complete flag, LSB overlaps preceding flag */</span>
				<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">shared0s</span><span class="o">++</span><span class="p">;</span>
				<span class="n">inbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">inbyte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trail1</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* remaining bits */</span>
				<span class="n">inbyte</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">lead1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">inbits</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="n">lead1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">trail1</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* interior stuffing:</span>
<span class="cm">					 * omitting the MSB handles most cases,</span>
<span class="cm">					 * correct the incorrectly handled</span>
<span class="cm">					 * cases individually */</span>
					<span class="n">inbits</span><span class="o">--</span><span class="p">;</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mh">0xbe</span>:
						<span class="n">inbyte</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* abort sequence follows,</span>
<span class="cm">				 * skb already empty anyway */</span>
				<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">aborts</span><span class="o">++</span><span class="p">;</span>
				<span class="n">inputstate</span> <span class="o">|=</span> <span class="n">INS_flag_hunt</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* (seqlen &lt; 6) &amp;&amp; (seqlen == 5 || trail1 &gt;= 7) */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">PPP_FLAG</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* complete flag */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">seqlen</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">stolen0s</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inbits</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hdlc_frag</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">inbits</span><span class="p">);</span>
					<span class="n">inbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">inbyte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inputstate</span> <span class="o">&amp;</span> <span class="n">INS_have_data</span><span class="p">)</span>
					<span class="n">hdlc_done</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
				<span class="n">inputstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INS_have_data</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trail1</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* abort sequence */</span>
				<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">aborts</span><span class="o">++</span><span class="p">;</span>
				<span class="n">hdlc_flush</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
				<span class="n">inputstate</span> <span class="o">|=</span> <span class="n">INS_flag_hunt</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* stuffed data */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">trail1</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* =&gt; seqlen == 5 */</span>
					<span class="cm">/* stuff bit at position lead1,</span>
<span class="cm">					 * no interior stuffing */</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lead1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">c</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">inbyte</span> <span class="o">|=</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">inbits</span><span class="p">;</span>
					<span class="n">inbits</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seqlen</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* trail1 &gt;= 8 */</span>
					<span class="cm">/* interior stuffing:</span>
<span class="cm">					 * omitting the MSB handles most cases,</span>
<span class="cm">					 * correct the incorrectly handled</span>
<span class="cm">					 * cases individually */</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mh">0xbe</span>:
						<span class="n">c</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">inbyte</span> <span class="o">|=</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">inbits</span><span class="p">;</span>
					<span class="n">inbits</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* seqlen == 5 &amp;&amp; trail1 &gt;= 8 */</span>

					<span class="cm">/* stuff bit at lead1 *and* interior</span>
<span class="cm">					 * stuffing -- unstuff individually */</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mh">0x7d</span>:
						<span class="n">c</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mh">0xbe</span>:
						<span class="n">c</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mh">0x3e</span>:
						<span class="n">c</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="mh">0x7c</span>:
						<span class="n">c</span> <span class="o">=</span> <span class="mh">0x3e</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">inbyte</span> <span class="o">|=</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">inbits</span><span class="p">;</span>
					<span class="n">inbits</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">inbits</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">inbits</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
					<span class="n">hdlc_putbyte</span><span class="p">(</span><span class="n">inbyte</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">bcs</span><span class="p">);</span>
					<span class="n">inputstate</span> <span class="o">|=</span> <span class="n">INS_have_data</span><span class="p">;</span>
					<span class="n">inbyte</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">seqlen</span> <span class="o">=</span> <span class="n">trail1</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save new state */</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">inputstate</span> <span class="o">=</span> <span class="n">inputstate</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">seqlen</span> <span class="o">=</span> <span class="n">seqlen</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">inbyte</span> <span class="o">=</span> <span class="n">inbyte</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">inbits</span> <span class="o">=</span> <span class="n">inbits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* trans_receive</span>
<span class="cm"> * pass on received USB frame transparently as SKB via gigaset_skb_rcvd</span>
<span class="cm"> * invert bytes</span>
<span class="cm"> * tally frames, errors etc. in BC structure counters</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	src	received data</span>
<span class="cm"> *	count	number of received bytes</span>
<span class="cm"> *	bcs	receiving B channel structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">trans_receive</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dobytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">gigaset_new_rx_skb</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dobytes</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">dobytes</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="n">dobytes</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dobytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">dobytes</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dobytes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dump_bytes</span><span class="p">(</span><span class="n">DEBUG_STREAM_DUMP</span><span class="p">,</span>
				   <span class="s">&quot;rcv data&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">goodbytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">gigaset_skb_rcvd</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">gigaset_new_rx_skb</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">dobytes</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gigaset_isoc_receive</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">count</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">L2_HDLC</span>:
		<span class="n">hdlc_unpack</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">bcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* assume transparent */</span>
		<span class="n">trans_receive</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">bcs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* == data input =========================================================== */</span>

<span class="cm">/* process a block of received bytes in command mode (mstate != MS_LOCKED)</span>
<span class="cm"> * Append received bytes to the command response buffer and forward them</span>
<span class="cm"> * line by line to the response handler.</span>
<span class="cm"> * Note: Received lines may be terminated by CR, LF, or CR LF, which will be</span>
<span class="cm"> * removed before passing the line to the response handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_loop</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numbytes</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inbuf_t</span> <span class="o">*</span><span class="n">inbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cbytes</span>      <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cbytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">numbytes</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;\n&#39;</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cbytes</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* collapse LF with preceding CR */</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* --v-- fall through --v-- */</span>
		<span class="k">case</span> <span class="sc">&#39;\r&#39;</span>:
			<span class="cm">/* end of message line, pass to response handler */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cbytes</span> <span class="o">&gt;=</span> <span class="n">MAX_RESP_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;response too large (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">cbytes</span><span class="p">);</span>
				<span class="n">cbytes</span> <span class="o">=</span> <span class="n">MAX_RESP_SIZE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cbytes</span> <span class="o">=</span> <span class="n">cbytes</span><span class="p">;</span>
			<span class="n">gigaset_dbg_buffer</span><span class="p">(</span><span class="n">DEBUG_TRANSCMD</span><span class="p">,</span> <span class="s">&quot;received response&quot;</span><span class="p">,</span>
					   <span class="n">cbytes</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">);</span>
			<span class="n">gigaset_handle_modem_response</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">cbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* store EOL byte for CRLF collapsing */</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* append to line buffer if possible */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cbytes</span> <span class="o">&lt;</span> <span class="n">MAX_RESP_SIZE</span><span class="p">)</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">respdata</span><span class="p">[</span><span class="n">cbytes</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">cbytes</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* save state */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cbytes</span> <span class="o">=</span> <span class="n">cbytes</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* process a block of data received through the control channel</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isoc_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">inbuf_t</span> <span class="o">*</span><span class="n">inbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tail</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;buffer state: %u -&gt; %u&quot;</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">&gt;</span> <span class="n">tail</span><span class="p">)</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="n">RBUFSIZE</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">head</span><span class="p">;</span>
		<span class="n">numbytes</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">-</span> <span class="n">head</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;processing %u bytes&quot;</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">==</span> <span class="n">MS_LOCKED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gigaset_dbg_buffer</span><span class="p">(</span><span class="n">DEBUG_LOCKCMD</span><span class="p">,</span> <span class="s">&quot;received response&quot;</span><span class="p">,</span>
					   <span class="n">numbytes</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
			<span class="n">gigaset_if_receive</span><span class="p">(</span><span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd_loop</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span> <span class="n">inbuf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">head</span> <span class="o">+=</span> <span class="n">numbytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">==</span> <span class="n">RBUFSIZE</span><span class="p">)</span>
			<span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;setting head to %u&quot;</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
		<span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* == data output ========================================================== */</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isoc_send_skb() - queue an skb for sending</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> * @skb:	data to send.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by LL to queue an skb for sending, and start transmission if</span>
<span class="cm"> * necessary.</span>
<span class="cm"> * Once the payload data has been transmitted completely, gigaset_skb_sent()</span>
<span class="cm"> * will be called with the skb&#39;s link layer header preserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> *	number of bytes accepted for sending (skb-&gt;len) if ok,</span>
<span class="cm"> *	error code &lt; 0 (eg. -ENODEV) on error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gigaset_isoc_send_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: skb queued, qlen=%d&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">));</span>

	<span class="cm">/* tasklet submits URB if necessary */</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">sent_tasklet</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* ok so far */</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
