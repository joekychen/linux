<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › gigaset › capi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>capi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Kernel CAPI interface for the Gigaset driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 by Tilman Schmidt &lt;tilman@imap.cc&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *	the License, or (at your option) any later version.</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;gigaset.h&quot;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/ratelimit.h&gt;</span>
<span class="cp">#include &lt;linux/isdn/capilli.h&gt;</span>
<span class="cp">#include &lt;linux/isdn/capicmd.h&gt;</span>
<span class="cp">#include &lt;linux/isdn/capiutil.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cm">/* missing from kernelcapi.h */</span>
<span class="cp">#define CapiNcpiNotSupportedByProtocol	0x0001</span>
<span class="cp">#define CapiFlagsNotSupportedByProtocol	0x0002</span>
<span class="cp">#define CapiAlertAlreadySent		0x0003</span>
<span class="cp">#define CapiFacilitySpecificFunctionNotSupported	0x3011</span>

<span class="cm">/* missing from capicmd.h */</span>
<span class="cp">#define CAPI_CONNECT_IND_BASELEN	(CAPI_MSG_BASELEN + 4 + 2 + 8 * 1)</span>
<span class="cp">#define CAPI_CONNECT_ACTIVE_IND_BASELEN	(CAPI_MSG_BASELEN + 4 + 3 * 1)</span>
<span class="cp">#define CAPI_CONNECT_B3_IND_BASELEN	(CAPI_MSG_BASELEN + 4 + 1)</span>
<span class="cp">#define CAPI_CONNECT_B3_ACTIVE_IND_BASELEN	(CAPI_MSG_BASELEN + 4 + 1)</span>
<span class="cp">#define CAPI_DATA_B3_REQ_LEN64		(CAPI_MSG_BASELEN + 4 + 4 + 2 + 2 + 2 + 8)</span>
<span class="cp">#define CAPI_DATA_B3_CONF_LEN		(CAPI_MSG_BASELEN + 4 + 2 + 2)</span>
<span class="cp">#define CAPI_DISCONNECT_IND_LEN		(CAPI_MSG_BASELEN + 4 + 2)</span>
<span class="cp">#define CAPI_DISCONNECT_B3_IND_BASELEN	(CAPI_MSG_BASELEN + 4 + 2 + 1)</span>
<span class="cp">#define CAPI_FACILITY_CONF_BASELEN	(CAPI_MSG_BASELEN + 4 + 2 + 2 + 1)</span>
<span class="cm">/* most _CONF messages contain only Controller/PLCI/NCCI and Info parameters */</span>
<span class="cp">#define CAPI_STDCONF_LEN		(CAPI_MSG_BASELEN + 4 + 2)</span>

<span class="cp">#define CAPI_FACILITY_HANDSET	0x0000</span>
<span class="cp">#define CAPI_FACILITY_DTMF	0x0001</span>
<span class="cp">#define CAPI_FACILITY_V42BIS	0x0002</span>
<span class="cp">#define CAPI_FACILITY_SUPPSVC	0x0003</span>
<span class="cp">#define CAPI_FACILITY_WAKEUP	0x0004</span>
<span class="cp">#define CAPI_FACILITY_LI	0x0005</span>

<span class="cp">#define CAPI_SUPPSVC_GETSUPPORTED	0x0000</span>
<span class="cp">#define CAPI_SUPPSVC_LISTEN		0x0001</span>

<span class="cm">/* missing from capiutil.h */</span>
<span class="cp">#define CAPIMSG_PLCI_PART(m)	CAPIMSG_U8(m, 9)</span>
<span class="cp">#define CAPIMSG_NCCI_PART(m)	CAPIMSG_U16(m, 10)</span>
<span class="cp">#define CAPIMSG_HANDLE_REQ(m)	CAPIMSG_U16(m, 18) </span><span class="cm">/* DATA_B3_REQ/_IND only! */</span><span class="cp"></span>
<span class="cp">#define CAPIMSG_FLAGS(m)	CAPIMSG_U16(m, 20)</span>
<span class="cp">#define CAPIMSG_SETCONTROLLER(m, contr)	capimsg_setu8(m, 8, contr)</span>
<span class="cp">#define CAPIMSG_SETPLCI_PART(m, plci)	capimsg_setu8(m, 9, plci)</span>
<span class="cp">#define CAPIMSG_SETNCCI_PART(m, ncci)	capimsg_setu16(m, 10, ncci)</span>
<span class="cp">#define CAPIMSG_SETFLAGS(m, flags)	capimsg_setu16(m, 20, flags)</span>

<span class="cm">/* parameters with differing location in DATA_B3_CONF/_RESP: */</span>
<span class="cp">#define CAPIMSG_SETHANDLE_CONF(m, handle)	capimsg_setu16(m, 12, handle)</span>
<span class="cp">#define	CAPIMSG_SETINFO_CONF(m, info)		capimsg_setu16(m, 14, info)</span>

<span class="cm">/* Flags (DATA_B3_REQ/_IND) */</span>
<span class="cp">#define CAPI_FLAGS_DELIVERY_CONFIRMATION	0x04</span>
<span class="cp">#define CAPI_FLAGS_RESERVED			(~0x1f)</span>

<span class="cm">/* buffer sizes */</span>
<span class="cp">#define MAX_BC_OCTETS 11</span>
<span class="cp">#define MAX_HLC_OCTETS 3</span>
<span class="cp">#define MAX_NUMBER_DIGITS 20</span>
<span class="cp">#define MAX_FMT_IE_LEN 20</span>

<span class="cm">/* values for bcs-&gt;apconnstate */</span>
<span class="cp">#define APCONN_NONE	0	</span><span class="cm">/* inactive/listening */</span><span class="cp"></span>
<span class="cp">#define APCONN_SETUP	1	</span><span class="cm">/* connecting */</span><span class="cp"></span>
<span class="cp">#define APCONN_ACTIVE	2	</span><span class="cm">/* B channel up */</span><span class="cp"></span>

<span class="cm">/* registered application data structure */</span>
<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">ctrlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">bcnext</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">capi_register_params</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nextMessageNumber</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">listenInfoMask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">listenCIPmask</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* CAPI specific controller data structure */</span>
<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">capi_ctr</span> <span class="n">ctr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">appls</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">sendqueue</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">sendqlen</span><span class="p">;</span>
	<span class="cm">/* two _cmsg structures possibly used concurrently: */</span>
	<span class="n">_cmsg</span> <span class="n">hcmsg</span><span class="p">;</span>	<span class="cm">/* for message composition triggered from hardware */</span>
	<span class="n">_cmsg</span> <span class="n">acmsg</span><span class="p">;</span>	<span class="cm">/* for dissection of messages sent from application */</span>
	<span class="n">u8</span> <span class="n">bc_buf</span><span class="p">[</span><span class="n">MAX_BC_OCTETS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">hlc_buf</span><span class="p">[</span><span class="n">MAX_HLC_OCTETS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cgpty_buf</span><span class="p">[</span><span class="n">MAX_NUMBER_DIGITS</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">cdpty_buf</span><span class="p">[</span><span class="n">MAX_NUMBER_DIGITS</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* CIP Value table (from CAPI 2.0 standard, ch. 6.1) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">hlc</span><span class="p">;</span>
<span class="p">}</span> <span class="n">cip2bchlc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8090A3&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>	<span class="cm">/* Speech (A-law) */</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>		<span class="cm">/* Unrestricted digital information */</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8990&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>		<span class="cm">/* Restricted digital information */</span>
	<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;9090A3&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>	<span class="cm">/* 3,1 kHz audio (A-law) */</span>
	<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;9190&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>		<span class="cm">/* 7 kHz audio */</span>
	<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;9890&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>		<span class="cm">/* Video */</span>
	<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;88C0C6E6&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>	<span class="cm">/* Packet mode */</span>
	<span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890218F&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>	<span class="cm">/* 56 kbit/s rate adaptation */</span>
	<span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;9190A5&quot;</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>	<span class="cm">/* Unrestricted digital information</span>
<span class="cm">					 * with tones/announcements */</span>
	<span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8090A3&quot;</span><span class="p">,</span> <span class="s">&quot;9181&quot;</span> <span class="p">},</span>	<span class="cm">/* Telephony */</span>
	<span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;9090A3&quot;</span><span class="p">,</span> <span class="s">&quot;9184&quot;</span> <span class="p">},</span>	<span class="cm">/* Group 2/3 facsimile */</span>
	<span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91A1&quot;</span> <span class="p">},</span>	<span class="cm">/* Group 4 facsimile Class 1 */</span>
	<span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91A4&quot;</span> <span class="p">},</span>	<span class="cm">/* Teletex service basic and mixed mode</span>
<span class="cm">					 * and Group 4 facsimile service</span>
<span class="cm">					 * Classes II and III */</span>
	<span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91A8&quot;</span> <span class="p">},</span>	<span class="cm">/* Teletex service basic and</span>
<span class="cm">					 * processable mode */</span>
	<span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91B1&quot;</span> <span class="p">},</span>	<span class="cm">/* Teletex service basic mode */</span>
	<span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91B2&quot;</span> <span class="p">},</span>	<span class="cm">/* International interworking for</span>
<span class="cm">					 * Videotex */</span>
	<span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91B5&quot;</span> <span class="p">},</span>	<span class="cm">/* Telex */</span>
	<span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91B8&quot;</span> <span class="p">},</span>	<span class="cm">/* Message Handling Systems</span>
<span class="cm">					 * in accordance with X.400 */</span>
	<span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;91C1&quot;</span> <span class="p">},</span>	<span class="cm">/* OSI application</span>
<span class="cm">					 * in accordance with X.200 */</span>
	<span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;9190A5&quot;</span><span class="p">,</span> <span class="s">&quot;9181&quot;</span> <span class="p">},</span>	<span class="cm">/* 7 kHz telephony */</span>
	<span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;9190A5&quot;</span><span class="p">,</span> <span class="s">&quot;916001&quot;</span> <span class="p">},</span>	<span class="cm">/* Video telephony, first connection */</span>
	<span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;8890&quot;</span><span class="p">,</span> <span class="s">&quot;916002&quot;</span> <span class="p">},</span>	<span class="cm">/* Video telephony, second connection */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * helper functions</span>
<span class="cm"> * ================</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * emit unsupported parameter warning</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ignore_cstruct_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">_cstruct</span> <span class="n">param</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">msgname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">paramname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ignoring unsupported parameter: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">msgname</span><span class="p">,</span> <span class="n">paramname</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * convert an IE from Gigaset hex string to ETSI binary representation</span>
<span class="cm"> * including length byte</span>
<span class="cm"> * return value: result length, -1 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">encode_ie</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="n">isxdigit</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">||</span> <span class="n">l</span> <span class="o">&gt;=</span> <span class="n">maxlen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">out</span><span class="p">[</span><span class="o">++</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hex_to_bin</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">in</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * convert an IE from ETSI binary representation including length byte</span>
<span class="cm"> * to Gigaset hex string</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_ie</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ToDo: conversion to upper case necessary? */</span>
		<span class="o">*</span><span class="n">out</span><span class="o">++</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">hex_asc_hi</span><span class="p">(</span><span class="o">*++</span><span class="n">in</span><span class="p">));</span>
		<span class="o">*</span><span class="n">out</span><span class="o">++</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">hex_asc_lo</span><span class="p">(</span><span class="o">*</span><span class="n">in</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * retrieve application data structure for an application ID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span>
<span class="nf">get_appl</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">appl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">appls</span><span class="p">,</span> <span class="n">ctrlist</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">appl</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ap</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dump CAPI message to kernel messages for debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_cmsg</span><span class="p">(</span><span class="k">enum</span> <span class="n">debuglevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="n">_cmsg</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_GIGASET_DEBUG</span>
	<span class="cm">/* dump at most 20 messages in 20 secs */</span>
	<span class="k">static</span> <span class="n">DEFINE_RATELIMIT_STATE</span><span class="p">(</span><span class="n">msg_dump_ratelimit</span><span class="p">,</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">_cdebbuf</span> <span class="o">*</span><span class="n">cdb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gigaset_debuglevel</span> <span class="o">&amp;</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">___ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_dump_ratelimit</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cdb</span> <span class="o">=</span> <span class="n">capi_cmsg2str</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;%s: [%d] %s&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ApplId</span><span class="p">,</span> <span class="n">cdb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">cdebbuf_free</span><span class="p">(</span><span class="n">cdb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;%s: [%d] %s&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ApplId</span><span class="p">,</span>
			<span class="n">capi_cmd2str</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">Command</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">Subcommand</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_rawmsg</span><span class="p">(</span><span class="k">enum</span> <span class="n">debuglevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_GIGASET_DEBUG</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dbgline</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gigaset_debuglevel</span> <span class="o">&amp;</span> <span class="n">level</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="n">CAPIMSG_LEN</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;%s: ??? LEN=%04d&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;%s: 0x%02x:0x%02x: ID=%03d #0x%04x LEN=%04d NCCI=0x%x&quot;</span><span class="p">,</span>
		<span class="n">tag</span><span class="p">,</span> <span class="n">CAPIMSG_COMMAND</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">CAPIMSG_SUBCOMMAND</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
		<span class="n">CAPIMSG_APPID</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">CAPIMSG_MSGID</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">l</span><span class="p">,</span>
		<span class="n">CAPIMSG_CONTROL</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">l</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">dbgline</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">l</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbgline</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
		<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
		<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;  %s&quot;</span><span class="p">,</span> <span class="n">dbgline</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dbgline</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CAPIMSG_COMMAND</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">CAPI_DATA_B3</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">CAPIMSG_SUBCOMMAND</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">CAPI_REQ</span> <span class="o">||</span>
	     <span class="n">CAPIMSG_SUBCOMMAND</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">CAPI_IND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">CAPIMSG_DATALEN</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;   DataLength=%d&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">gigaset_debuglevel</span> <span class="o">&amp;</span> <span class="n">DEBUG_LLDATA</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span> <span class="cm">/* arbitrary limit */</span>
		<span class="n">dbgline</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">l</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbgline</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">CAPIMSG_LEN</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">l</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dbgline</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;  %s&quot;</span><span class="p">,</span> <span class="n">dbgline</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dbgline</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * format CAPI IE as string</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">format_ie</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">MAX_FMT_IE_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pout</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;NULL&quot;</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_FMT_IE_LEN</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">MAX_FMT_IE_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pout</span><span class="o">++</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="o">*++</span><span class="n">ie</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pout</span><span class="o">++</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="o">*</span><span class="n">ie</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pout</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_FMT_IE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pout</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pout</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pout</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;.&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*--</span><span class="n">pout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * emit DATA_B3_CONF message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_data_b3_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctr</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">appl</span><span class="p">,</span> <span class="n">u16</span> <span class="n">msgid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u16</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">cskb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">cskb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">CAPI_DATA_B3_CONF_LEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* frequent message, avoid _cmsg overhead */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="n">__skb_put</span><span class="p">(</span><span class="n">cskb</span><span class="p">,</span> <span class="n">CAPI_DATA_B3_CONF_LEN</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETLEN</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">CAPI_DATA_B3_CONF_LEN</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETAPPID</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">appl</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETCOMMAND</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">CAPI_DATA_B3</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETSUBCOMMAND</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span>  <span class="n">CAPI_CONF</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETMSGID</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">msgid</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETCONTROLLER</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ctr</span><span class="o">-&gt;</span><span class="n">cnr</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETPLCI_PART</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETNCCI_PART</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETHANDLE_CONF</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETINFO_CONF</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="cm">/* emit message */</span>
	<span class="n">dump_rawmsg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="n">cskb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * driver interface functions</span>
<span class="cm"> * ==========================</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_skb_sent() - acknowledge transmission of outgoing skb</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> * @skb:	sent data.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by hardware module {bas,ser,usb}_gigaset when the data in a</span>
<span class="cm"> * skb has been successfully sent, for signalling completion to the LL.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_skb_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dskb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">dskb</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* update statistics */</span>
	<span class="o">++</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">trans_up</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="s">&quot;%s: application gone&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t send further B3 messages if disconnected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">&lt;</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="s">&quot;%s: disconnected&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * send DATA_B3_CONF if &quot;delivery confirmation&quot; bit was set in request;</span>
<span class="cm">	 * otherwise it has already been sent by do_data_b3_req()</span>
<span class="cm">	 */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">CAPIMSG_FLAGS</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CAPI_FLAGS_DELIVERY_CONFIRMATION</span><span class="p">)</span>
		<span class="n">send_data_b3_conf</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">CAPIMSG_MSGID</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
				  <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CAPIMSG_HANDLE_REQ</span><span class="p">(</span><span class="n">req</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CAPI_FLAGS_DELIVERY_CONFIRMATION</span><span class="p">)</span> <span class="o">?</span>
				  <span class="n">CapiFlagsNotSupportedByProtocol</span> <span class="o">:</span>
				  <span class="n">CAPI_NOERROR</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gigaset_skb_sent</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_skb_rcvd() - pass received skb to LL</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> * @skb:	received data.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by hardware module {bas,ser,usb}_gigaset when user data has</span>
<span class="cm"> * been successfully received, for passing to the LL.</span>
<span class="cm"> * Warning: skb must not be accessed anymore!</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_skb_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* update statistics */</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">trans_down</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="s">&quot;%s: application gone&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t send further B3 messages if disconnected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">&lt;</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="s">&quot;%s: disconnected&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * prepend DATA_B3_IND message to payload</span>
<span class="cm">	 * Parameters: NCCI = 1, all others 0/unused</span>
<span class="cm">	 * frequent message, avoid _cmsg overhead</span>
<span class="cm">	 */</span>
	<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_DATA_B3_REQ_LEN</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETLEN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">CAPI_DATA_B3_REQ_LEN</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETAPPID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETCOMMAND</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">CAPI_DATA_B3</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETSUBCOMMAND</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>  <span class="n">CAPI_IND</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETMSGID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETCONTROLLER</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">cnr</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETPLCI_PART</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">CAPIMSG_SETNCCI_PART</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Data parameter not used */</span>
	<span class="n">CAPIMSG_SETDATALEN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="cm">/* Data handle parameter not used */</span>
	<span class="n">CAPIMSG_SETFLAGS</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Data64 parameter not present */</span>

	<span class="cm">/* emit message */</span>
	<span class="n">dump_rawmsg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gigaset_skb_rcvd</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_rcv_err() - signal receive error</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by hardware module {bas,ser,usb}_gigaset when a receive error</span>
<span class="cm"> * has occurred, for signalling to the LL.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_rcv_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if currently ignoring packets, just count down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ignore</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update statistics */</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">corrupted</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* ToDo: signal error -&gt; LL */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">gigaset_isdn_rcv_err</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_icall() - signal incoming call</span>
<span class="cm"> * @at_state:	connection state structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main module at tasklet level to notify the LL that an incoming</span>
<span class="cm"> * call has been received. @at_state contains the parameters of the call.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: call disposition (ICALL_*)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gigaset_isdn_icall</span><span class="p">(</span><span class="k">struct</span> <span class="n">at_state_t</span> <span class="o">*</span><span class="n">at_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">actCIPmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msgsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ToDo: signal calls without a free B channel, too</span>
<span class="cm">	 * (requires a u8 handle for the at_state structure that can</span>
<span class="cm">	 * be stored in the PLCI and used in the CONNECT_RESP message</span>
<span class="cm">	 * handler to retrieve it)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ICALL_IGNORE</span><span class="p">;</span>

	<span class="cm">/* prepare CONNECT_IND message, using B channel number as PLCI */</span>
	<span class="n">capi_cmsg_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CAPI_CONNECT</span><span class="p">,</span> <span class="n">CAPI_IND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			 <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">cnr</span> <span class="o">|</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* minimum size, all structs empty */</span>
	<span class="n">msgsize</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_IND_BASELEN</span><span class="p">;</span>

	<span class="cm">/* Bearer Capability (mandatory) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* pass on BC from Gigaset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encode_ie</span><span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">],</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">bc_buf</span><span class="p">,</span>
			      <span class="n">MAX_BC_OCTETS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RING ignored - bad BC %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">ICALL_IGNORE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* look up corresponding CIP value */</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CIPValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* default if nothing found */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bc</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">cip2bchlc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hlc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bc</span><span class="p">,</span>
				    <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CIPValue</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no BC (internal call): assume CIP 1 (speech, A-law) */</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CIPValue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">encode_ie</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">bc</span><span class="p">,</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">bc_buf</span><span class="p">,</span> <span class="n">MAX_BC_OCTETS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">BC</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">bc_buf</span><span class="p">;</span>
	<span class="n">msgsize</span> <span class="o">+=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">BC</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* High Layer Compatibility (optional) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZHLC</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* pass on HLC from Gigaset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encode_ie</span><span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZHLC</span><span class="p">],</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hlc_buf</span><span class="p">,</span>
			      <span class="n">MAX_HLC_OCTETS</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RING ignored - bad HLC %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZHLC</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">ICALL_IGNORE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">HLC</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hlc_buf</span><span class="p">;</span>
		<span class="n">msgsize</span> <span class="o">+=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">HLC</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="cm">/* look up corresponding CIP value */</span>
		<span class="cm">/* keep BC based CIP value if none found */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">])</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hlc</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hlc</span><span class="p">,</span>
					    <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZHLC</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bc</span><span class="p">,</span>
					    <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">]))</span> <span class="p">{</span>
					<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CIPValue</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Called Party Number (optional) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZCPN</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZCPN</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_NUMBER_DIGITS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RING ignored - bad number %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">ICALL_IGNORE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">cdpty_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">cdpty_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* type / numbering plan unknown */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">cdpty_buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZCPN</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CalledPartyNumber</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">cdpty_buf</span><span class="p">;</span>
		<span class="n">msgsize</span> <span class="o">+=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CalledPartyNumber</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Calling Party Number (optional) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_NMBR</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_NMBR</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_NUMBER_DIGITS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RING ignored - bad number %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_ZBC</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">ICALL_IGNORE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">cgpty_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">cgpty_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* type / numbering plan unknown */</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">cgpty_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* pres. allowed, not screened */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">cgpty_buf</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">at_state</span><span class="o">-&gt;</span><span class="n">str_var</span><span class="p">[</span><span class="n">STR_NMBR</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CallingPartyNumber</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">cgpty_buf</span><span class="p">;</span>
		<span class="n">msgsize</span> <span class="o">+=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CallingPartyNumber</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* remaining parameters (not supported, always left NULL):</span>
<span class="cm">	 * - CalledPartySubaddress</span>
<span class="cm">	 * - CallingPartySubaddress</span>
<span class="cm">	 * - AdditionalInfo</span>
<span class="cm">	 *   - BChannelinformation</span>
<span class="cm">	 *   - Keypadfacility</span>
<span class="cm">	 *   - Useruserdata</span>
<span class="cm">	 *   - Facilitydataarray</span>
<span class="cm">	 */</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;icall: PLCI %x CIP %d BC %s&quot;</span><span class="p">,</span>
		<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span><span class="p">,</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CIPValue</span><span class="p">,</span>
		<span class="n">format_ie</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">BC</span><span class="p">));</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;icall: HLC %s&quot;</span><span class="p">,</span>
		<span class="n">format_ie</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">HLC</span><span class="p">));</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;icall: CgPty %s&quot;</span><span class="p">,</span>
		<span class="n">format_ie</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CallingPartyNumber</span><span class="p">));</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;icall: CdPty %s&quot;</span><span class="p">,</span>
		<span class="n">format_ie</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CalledPartyNumber</span><span class="p">));</span>

	<span class="cm">/* scan application list for matching listeners */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">!=</span> <span class="n">APCONN_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: channel not properly cleared (%p/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">actCIPmask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">CIPValue</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">appls</span><span class="p">,</span> <span class="n">ctrlist</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">actCIPmask</span> <span class="o">&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">listenCIPmask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* build CONNECT_IND message for this application */</span>
			<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">ApplId</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
			<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">Messagenumber</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">msgsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">msgsize</span><span class="p">));</span>
			<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">);</span>

			<span class="cm">/* add to listeners on this B channel, update state */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">|=</span> <span class="n">CHS_NOTIFY_LL</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_SETUP</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="cm">/* emit message */</span>
			<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Return &quot;accept&quot; if any listeners.</span>
<span class="cm">	 * Gigaset will send ALERTING.</span>
<span class="cm">	 * There doesn&#39;t seem to be a way to avoid this.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">?</span> <span class="n">ICALL_ACCEPT</span> <span class="o">:</span> <span class="n">ICALL_IGNORE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send a DISCONNECT_IND message to an application</span>
<span class="cm"> * does not sleep, clobbers the controller&#39;s hcmsg structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_disconnect_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">==</span> <span class="n">APCONN_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">capi_cmsg_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">CAPI_DISCONNECT</span><span class="p">,</span> <span class="n">CAPI_IND</span><span class="p">,</span>
			 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">,</span>
			 <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">cnr</span> <span class="o">|</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">.</span><span class="n">Reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">CAPI_DISCONNECT_IND_LEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_DISCONNECT_IND_LEN</span><span class="p">));</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send a DISCONNECT_B3_IND message to an application</span>
<span class="cm"> * Parameters: NCCI = 1, NCPI empty, Reason_B3 = 0</span>
<span class="cm"> * does not sleep, clobbers the controller&#39;s hcmsg structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_disconnect_b3_ind</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* nothing to do if no logical connection active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">&lt;</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_SETUP</span><span class="p">;</span>

	<span class="n">capi_cmsg_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">CAPI_DISCONNECT_B3</span><span class="p">,</span> <span class="n">CAPI_IND</span><span class="p">,</span>
			 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">,</span>
			 <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">cnr</span> <span class="o">|</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">CAPI_DISCONNECT_B3_IND_BASELEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span>
			  <span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_DISCONNECT_B3_IND_BASELEN</span><span class="p">));</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_connD() - signal D channel connect</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main module at tasklet level to notify the LL that the D channel</span>
<span class="cm"> * connection has been established.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_connD</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msgsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;%s: application gone&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">==</span> <span class="n">APCONN_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: application %u not connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this should never happen */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: dropping extra application %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">send_disconnect_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">,</span>
				    <span class="n">CapiCallGivenToOtherApplication</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare CONNECT_ACTIVE_IND message</span>
<span class="cm">	 * Note: LLC not supported by device</span>
<span class="cm">	 */</span>
	<span class="n">capi_cmsg_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">CAPI_CONNECT_ACTIVE</span><span class="p">,</span> <span class="n">CAPI_IND</span><span class="p">,</span>
			 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">,</span>
			 <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">cnr</span> <span class="o">|</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* minimum size, all structs empty */</span>
	<span class="n">msgsize</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_ACTIVE_IND_BASELEN</span><span class="p">;</span>

	<span class="cm">/* ToDo: set parameter: Connected number</span>
<span class="cm">	 * (requires ev-layer state machine extension to collect</span>
<span class="cm">	 * ZCON device reply)</span>
<span class="cm">	 */</span>

	<span class="cm">/* build and emit CONNECT_ACTIVE_IND message */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">msgsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">msgsize</span><span class="p">));</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_hupD() - signal D channel hangup</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main module at tasklet level to notify the LL that the D channel</span>
<span class="cm"> * connection has been shut down.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_hupD</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ToDo: pass on reason code reported by device</span>
<span class="cm">	 * (requires ev-layer state machine extension to collect</span>
<span class="cm">	 * ZCAU device reply)</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">send_disconnect_b3_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
		<span class="n">send_disconnect_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_NONE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_connB() - signal B channel connect</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main module at tasklet level to notify the LL that the B channel</span>
<span class="cm"> * connection has been established.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_connB</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msgsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">command</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;%s: application gone&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: application %u not connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * emit CONNECT_B3_ACTIVE_IND if we already got CONNECT_B3_REQ;</span>
<span class="cm">	 * otherwise we have to emit CONNECT_B3_IND first, and follow up with</span>
<span class="cm">	 * CONNECT_B3_ACTIVE_IND in reply to CONNECT_B3_RESP</span>
<span class="cm">	 * Parameters in both cases always: NCCI = 1, NCPI empty</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">&gt;=</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_B3_ACTIVE</span><span class="p">;</span>
		<span class="n">msgsize</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_B3_ACTIVE_IND_BASELEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_B3</span><span class="p">;</span>
		<span class="n">msgsize</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_B3_IND_BASELEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_ACTIVE</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this should never happen */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: dropping extra application %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">send_disconnect_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">,</span>
				    <span class="n">CapiCallGivenToOtherApplication</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">capi_cmsg_header</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">CAPI_IND</span><span class="p">,</span>
			 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">,</span>
			 <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">cnr</span> <span class="o">|</span> <span class="p">((</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">msgsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">,</span> <span class="n">__skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">msgsize</span><span class="p">));</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">hcmsg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_hupB() - signal B channel hangup</span>
<span class="cm"> * @bcs:	B channel descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main module to notify the LL that the B channel connection has</span>
<span class="cm"> * been shut down.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_hupB</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="cm">/* ToDo: assure order of DISCONNECT_B3_IND and DISCONNECT_IND ? */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;%s: application gone&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">send_disconnect_b3_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_start() - signal device availability</span>
<span class="cm"> * @cs:		device descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main module to notify the LL that the device is available for</span>
<span class="cm"> * use.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>

	<span class="cm">/* fill profile data: manufacturer name */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">manu</span><span class="p">,</span> <span class="s">&quot;Siemens&quot;</span><span class="p">);</span>
	<span class="cm">/* CAPI and device version */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">majorversion</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* CAPI 2.0 */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">minorversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* ToDo: check/assert cs-&gt;gotfwver? */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">majormanuversion</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">minormanuversion</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="cm">/* number of B channels supported */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">nbchannel</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="cm">/* global options: internal controller, supplementary services */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">goptions</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="cm">/* B1 protocols: 64 kbit/s HDLC or transparent */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">support1</span> <span class="o">=</span>  <span class="mh">0x03</span><span class="p">;</span>
	<span class="cm">/* B2 protocols: transparent only */</span>
	<span class="cm">/* ToDo: X.75 SLP ? */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">support2</span> <span class="o">=</span>  <span class="mh">0x02</span><span class="p">;</span>
	<span class="cm">/* B3 protocols: transparent only */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">profile</span><span class="p">.</span><span class="n">support3</span> <span class="o">=</span>  <span class="mh">0x01</span><span class="p">;</span>
	<span class="cm">/* no serial number */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="n">capi_ctr_ready</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_stop() - signal device unavailability</span>
<span class="cm"> * @cs:		device descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main module to notify the LL that the device is no longer</span>
<span class="cm"> * available for use.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>
	<span class="n">capi_ctr_down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * kernel CAPI callback methods</span>
<span class="cm"> * ============================</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * register CAPI application</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_register_appl</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">appl</span><span class="p">,</span>
				  <span class="n">capi_register_params</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span>
		<span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gigaset_capi_ctr</span><span class="p">,</span> <span class="n">ctr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">ctr</span><span class="o">-&gt;</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;%s [%u] l3cnt=%u blkcnt=%u blklen=%u&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">appl</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">level3cnt</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablkcnt</span><span class="p">,</span> <span class="n">rp</span><span class="o">-&gt;</span><span class="n">datablklen</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">appls</span><span class="p">,</span> <span class="n">ctrlist</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">appl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;application %u already registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">appl</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">appl</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">rp</span> <span class="o">=</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctrlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">appls</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;application %u registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * remove CAPI application from channel</span>
<span class="cm"> * helper function to keep indentation levels down and stay in 80 columns</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">remove_appl_from_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">bcap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prevconnstate</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">bcap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check first application on channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcap</span> <span class="o">==</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* none left, clear channel state */</span>
		<span class="n">prevconnstate</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_NONE</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prevconnstate</span> <span class="o">==</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: hanging up channel %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span>
					  <span class="n">EV_HUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check remaining list */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">==</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="n">bcap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bcap</span> <span class="o">=</span> <span class="n">bcap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bcap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * release CAPI application</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_release_appl</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">appl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span>
		<span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gigaset_capi_ctr</span><span class="p">,</span> <span class="n">ctr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;%s [%u]&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">appl</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">appls</span><span class="p">,</span> <span class="n">ctrlist</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">appl</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* remove from any channels */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
				<span class="n">remove_appl_from_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">ch</span><span class="p">],</span> <span class="n">ap</span><span class="p">);</span>

			<span class="cm">/* remove from registration list */</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctrlist</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;application %u released</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">appl</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> * outgoing CAPI message handler</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * helper function: emit reply message with given Info value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * _CONF replies always only have NCCI and Info parameters</span>
<span class="cm">	 * so they&#39;ll fit into the _REQ message skb</span>
<span class="cm">	 */</span>
	<span class="n">capi_cmsg_answer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">);</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">.</span><span class="n">Info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">__skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_STDCONF_LEN</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process FACILITY_REQ message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_facility_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">cskb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pparam</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msgsize</span> <span class="o">=</span> <span class="n">CAPI_FACILITY_CONF_BASELEN</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">function</span><span class="p">,</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">confparam</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>	<span class="cm">/* max. 9 octets + length byte */</span>

	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Facility Request Parameter is not decoded by capi_message2cmsg()</span>
<span class="cm">	 * encoding depends on Facility Selector</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">FacilitySelector</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CAPI_FACILITY_DTMF</span>:	<span class="cm">/* ToDo */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">CapiFacilityNotSupported</span><span class="p">;</span>
		<span class="n">confparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* length */</span>
		<span class="cm">/* DTMF information: Unknown DTMF request */</span>
		<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAPI_FACILITY_V42BIS</span>:	<span class="cm">/* not supported */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">CapiFacilityNotSupported</span><span class="p">;</span>
		<span class="n">confparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* length */</span>
		<span class="cm">/* V.42 bis information: not available */</span>
		<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAPI_FACILITY_SUPPSVC</span>:
		<span class="cm">/* decode Function parameter */</span>
		<span class="n">pparam</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">FacilityRequestParameter</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pparam</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">pparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;FACILITY_REQ&quot;</span><span class="p">,</span>
				   <span class="s">&quot;Facility Request Parameter&quot;</span><span class="p">);</span>
			<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiIllMessageParmCoding</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">function</span> <span class="o">=</span> <span class="n">CAPIMSG_U16</span><span class="p">(</span><span class="n">pparam</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CAPI_SUPPSVC_GETSUPPORTED</span>:
			<span class="n">info</span> <span class="o">=</span> <span class="n">CapiSuccess</span><span class="p">;</span>
			<span class="cm">/* Supplementary Service specific parameter */</span>
			<span class="n">confparam</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* length */</span>
			<span class="cm">/* Supplementary services info: Success */</span>
			<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">CapiSuccess</span><span class="p">);</span>
			<span class="cm">/* Supported Services: none */</span>
			<span class="n">capimsg_setu32</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CAPI_SUPPSVC_LISTEN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">pparam</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="s">&quot;FACILITY_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Notification Mask&quot;</span><span class="p">);</span>
				<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					  <span class="n">CapiIllMessageParmCoding</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CAPIMSG_U32</span><span class="p">(</span><span class="n">pparam</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;%s: unsupported supplementary service notification mask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="s">&quot;FACILITY_REQ&quot;</span><span class="p">,</span> <span class="n">CAPIMSG_U32</span><span class="p">(</span><span class="n">pparam</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
				<span class="n">info</span> <span class="o">=</span> <span class="n">CapiFacilitySpecificFunctionNotSupported</span><span class="p">;</span>
				<span class="n">confparam</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* length */</span>
				<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
					       <span class="n">CapiSupplementaryServiceNotSupported</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">CapiSuccess</span><span class="p">;</span>
			<span class="n">confparam</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* length */</span>
			<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">CapiSuccess</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* ToDo: add supported services */</span>

		<span class="nl">default:</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;%s: unsupported supplementary service function 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="s">&quot;FACILITY_REQ&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">CapiFacilitySpecificFunctionNotSupported</span><span class="p">;</span>
			<span class="cm">/* Supplementary Service specific parameter */</span>
			<span class="n">confparam</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* length */</span>
			<span class="cm">/* Supplementary services info: not supported */</span>
			<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				       <span class="n">CapiSupplementaryServiceNotSupported</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Facility confirmation parameter */</span>
		<span class="n">confparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">confparam</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* total length */</span>
		<span class="cm">/* Function: copy from _REQ message */</span>
		<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>
		<span class="cm">/* Supplementary Service specific parameter already set above */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CAPI_FACILITY_WAKEUP</span>:	<span class="cm">/* ToDo */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">CapiFacilityNotSupported</span><span class="p">;</span>
		<span class="n">confparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* length */</span>
		<span class="cm">/* Number of accepted awake request parameters: 0 */</span>
		<span class="n">capimsg_setu16</span><span class="p">(</span><span class="n">confparam</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">CapiFacilityNotSupported</span><span class="p">;</span>
		<span class="n">confparam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* empty struct */</span>
	<span class="p">}</span>

	<span class="cm">/* send FACILITY_CONF with given Info and confirmation parameter */</span>
	<span class="n">capi_cmsg_answer</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">FacilityConfirmationParameter</span> <span class="o">=</span> <span class="n">confparam</span><span class="p">;</span>
	<span class="n">msgsize</span> <span class="o">+=</span> <span class="n">confparam</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* length */</span>
	<span class="n">cskb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">msgsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">__skb_put</span><span class="p">(</span><span class="n">cskb</span><span class="p">,</span> <span class="n">msgsize</span><span class="p">));</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">cskb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * process LISTEN_REQ message</span>
<span class="cm"> * just store the masks in the application data structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_listen_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">);</span>

	<span class="cm">/* store listening parameters */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">listenInfoMask</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">.</span><span class="n">InfoMask</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">listenCIPmask</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">.</span><span class="n">CIPmask</span><span class="p">;</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiSuccess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process ALERT_REQ message</span>
<span class="cm"> * nothing to do, Gigaset always alerts anyway</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_alert_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">);</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiAlertAlreadySent</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process CONNECT_REQ message</span>
<span class="cm"> * allocate a B channel, prepare dial commands, queue a DIAL event,</span>
<span class="cm"> * emit CONNECT_CONF reply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_connect_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">commands</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lbc</span><span class="p">,</span> <span class="n">lhlc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">info</span><span class="p">;</span>

	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>

	<span class="cm">/* get free B channel &amp; construct PLCI */</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="n">gigaset_get_free_channel</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: no B channel available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">);</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiNoPlciAvailable</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">!=</span> <span class="n">APCONN_NONE</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: channel not properly cleared (%p/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_SETUP</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rp</span><span class="p">.</span><span class="n">datablklen</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
	<span class="n">gigaset_new_rx_skb</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span> <span class="o">|=</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* build command table */</span>
	<span class="n">commands</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">AT_NUM</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">commands</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>

	<span class="cm">/* encode parameter: Called party number */</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CalledPartyNumber</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">*</span><span class="n">pp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Called party number&quot;</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">CapiIllMessageParmCoding</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* check type of number/numbering plan byte */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x80</span>:	<span class="cm">/* unknown type / unknown numbering plan */</span>
	<span class="k">case</span> <span class="mh">0x81</span>:	<span class="cm">/* unknown type / ISDN/Telephony numbering plan */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* others: warn about potential misinterpretation */</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s type/plan 0x%02x unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Called party number&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pp</span><span class="o">++</span><span class="p">;</span>
	<span class="n">l</span><span class="o">--</span><span class="p">;</span>
	<span class="cm">/* translate &quot;**&quot; internal call prefix to CTP value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;^SCTP=0</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="n">pp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;^SCTP=1</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">commands</span><span class="p">[</span><span class="n">AT_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_TYPE</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
	<span class="n">commands</span><span class="p">[</span><span class="n">AT_DIAL</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_DIAL</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_DIAL</span><span class="p">],</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;D%.*s</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>

	<span class="cm">/* encode parameter: Calling party number */</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CallingPartyNumber</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">pp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">l</span> <span class="o">=</span> <span class="o">*</span><span class="n">pp</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* check type of number/numbering plan byte */</span>
		<span class="cm">/* ToDo: allow for/handle Ext=1? */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:	<span class="cm">/* unknown type / unknown numbering plan */</span>
		<span class="k">case</span> <span class="mh">0x01</span>:	<span class="cm">/* unknown type / ISDN/Telephony num. plan */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;%s: %s type/plan 0x%02x unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Calling party number&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">l</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* check presentation indicator */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %s IE truncated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Calling party number&quot;</span><span class="p">);</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">CapiIllMessageParmCoding</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pp</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ignore Screening indicator */</span>
		<span class="k">case</span> <span class="mh">0x80</span>:	<span class="cm">/* Presentation allowed */</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;^SCLIP=1</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xa0</span>:	<span class="cm">/* Presentation restricted */</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;^SCLIP=0</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid %s 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span>
				   <span class="s">&quot;Presentation/Screening indicator&quot;</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">pp</span><span class="p">);</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;^SCLIP=1</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">commands</span><span class="p">[</span><span class="n">AT_CLIP</span><span class="p">]</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_CLIP</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">l</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* number */</span>
			<span class="n">commands</span><span class="p">[</span><span class="n">AT_MSN</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_MSN</span><span class="p">])</span>
				<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_MSN</span><span class="p">],</span> <span class="n">l</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;^SMSN=%*s</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check parameter: CIP Value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cip2bchlc</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">].</span><span class="n">bc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unknown CIP value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">);</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">CapiCipValueUnknown</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * check/encode parameters: BC &amp; HLC</span>
<span class="cm">	 * must be encoded together as device doesn&#39;t accept HLC separately</span>
<span class="cm">	 * explicit parameters override values derived from CIP</span>
<span class="cm">	 */</span>

	<span class="cm">/* determine lengths */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BC</span> <span class="o">&amp;&amp;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>		<span class="cm">/* BC specified explicitly */</span>
		<span class="n">lbc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">].</span><span class="n">bc</span><span class="p">)</span>	<span class="cm">/* BC derived from CIP */</span>
		<span class="n">lbc</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">].</span><span class="n">bc</span><span class="p">);</span>
	<span class="k">else</span>					<span class="cm">/* no BC */</span>
		<span class="n">lbc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">HLC</span> <span class="o">&amp;&amp;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">HLC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>		<span class="cm">/* HLC specified explicitly */</span>
		<span class="n">lhlc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">HLC</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">].</span><span class="n">hlc</span><span class="p">)</span>	<span class="cm">/* HLC derived from CIP */</span>
		<span class="n">lhlc</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cip2bchlc</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">].</span><span class="n">hlc</span><span class="p">);</span>
	<span class="k">else</span>					<span class="cm">/* no HLC */</span>
		<span class="n">lhlc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lbc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* have BC: allocate and assemble command string */</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">lbc</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>		<span class="cm">/* &quot;^SBC=&quot; + value + &quot;\r&quot; + null byte */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lhlc</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">+=</span> <span class="n">lhlc</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* &quot;;^SHLC=&quot; + value */</span>
		<span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">],</span> <span class="s">&quot;^SBC=&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BC</span> <span class="o">&amp;&amp;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>	<span class="cm">/* BC specified explicitly */</span>
			<span class="n">decode_ie</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BC</span><span class="p">,</span> <span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">else</span>				<span class="cm">/* BC derived from CIP */</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
			       <span class="n">cip2bchlc</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">].</span><span class="n">bc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lhlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">]</span> <span class="o">+</span> <span class="n">lbc</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;;^SHLC=&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">HLC</span> <span class="o">&amp;&amp;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">HLC</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="cm">/* HLC specified explicitly */</span>
				<span class="n">decode_ie</span><span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">HLC</span><span class="p">,</span>
					  <span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">]</span> <span class="o">+</span> <span class="n">lbc</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
			<span class="k">else</span>	<span class="cm">/* HLC derived from CIP */</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">]</span> <span class="o">+</span> <span class="n">lbc</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span>
				       <span class="n">cip2bchlc</span><span class="p">[</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CIPValue</span><span class="p">].</span><span class="n">hlc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_BC</span><span class="p">]</span> <span class="o">+</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no BC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lhlc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cannot set HLC without BC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">);</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">CapiIllMessageParmCoding</span><span class="p">;</span> <span class="cm">/* ? */</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check/encode parameter: B Protocol */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BProtocol</span> <span class="o">==</span> <span class="n">CAPI_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_HDLC</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;B2 Protocol X.75 SLP unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B1protocol</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_HDLC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_VOICE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;B1 Protocol %u unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B1protocol</span><span class="p">);</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_VOICE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B2protocol</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;B2 Protocol %u unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B2protocol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B3protocol</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;B3 Protocol %u unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B3protocol</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B1configuration</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;B1 Configuration&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B2configuration</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;B2 Configuration&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B3configuration</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;B3 Configuration&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">commands</span><span class="p">[</span><span class="n">AT_PROTO</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_PROTO</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_PROTO</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&quot;^SBPR=%u</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span><span class="p">);</span>

	<span class="cm">/* ToDo: check/encode remaining parameters */</span>
	<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CalledPartySubaddress</span><span class="p">,</span>
			     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Called pty subaddr&quot;</span><span class="p">);</span>
	<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">CallingPartySubaddress</span><span class="p">,</span>
			     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Calling pty subaddr&quot;</span><span class="p">);</span>
	<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">LLC</span><span class="p">,</span>
			     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;LLC&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">AdditionalInfo</span> <span class="o">!=</span> <span class="n">CAPI_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BChannelinformation</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;B Channel Information&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Keypadfacility</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Keypad Facility&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Useruserdata</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;User-User Data&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Facilitydataarray</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Facility Data Array&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* encode parameter: B channel to use */</span>
	<span class="n">commands</span><span class="p">[</span><span class="n">AT_ISO</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_ISO</span><span class="p">])</span>
		<span class="k">goto</span> <span class="n">oom</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">AT_ISO</span><span class="p">],</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&quot;^SISO=%u</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* queue &amp; schedule EV_DIAL event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">EV_DIAL</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span>
			       <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">.</span><span class="n">seq_index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiSuccess</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">oom:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">commands</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AT_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">commands</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">commands</span><span class="p">);</span>
	<span class="n">gigaset_free_channel</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process CONNECT_RESP message</span>
<span class="cm"> * checks protocol parameters and queues an ACCEPT or HUP event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_connect_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">oap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* extract and check channel number from PLCI */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid %s 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;PLCI&quot;</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Reject</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* Accept */</span>
		<span class="cm">/* drop all competing applications, keep only this one */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">oap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">oap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oap</span> <span class="o">!=</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">send_disconnect_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">oap</span><span class="p">,</span>
						    <span class="n">CapiCallGivenToOtherApplication</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">rp</span><span class="p">.</span><span class="n">datablklen</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
		<span class="n">gigaset_new_rx_skb</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">|=</span> <span class="n">CHS_NOTIFY_LL</span><span class="p">;</span>

		<span class="cm">/* check/encode B channel protocol */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BProtocol</span> <span class="o">==</span> <span class="n">CAPI_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_HDLC</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;B2 Protocol X.75 SLP unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B1protocol</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_HDLC</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_VOICE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;B1 Protocol %u unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B1protocol</span><span class="p">);</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">=</span> <span class="n">L2_VOICE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B2protocol</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;B2 Protocol %u unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B2protocol</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B3protocol</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;B3 Protocol %u unsupported, using Transparent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B3protocol</span><span class="p">);</span>
			<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B1configuration</span><span class="p">,</span>
					     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;B1 Configuration&quot;</span><span class="p">);</span>
			<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B2configuration</span><span class="p">,</span>
					     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;B2 Configuration&quot;</span><span class="p">);</span>
			<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">B3configuration</span><span class="p">,</span>
					     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;B3 Configuration&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* ToDo: check/encode remaining parameters */</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">ConnectedNumber</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;Connected Number&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">ConnectedSubaddress</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;Connected Subaddress&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">LLC</span><span class="p">,</span>
				     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;LLC&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">AdditionalInfo</span> <span class="o">!=</span> <span class="n">CAPI_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BChannelinformation</span><span class="p">,</span>
					     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;BChannel Information&quot;</span><span class="p">);</span>
			<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Keypadfacility</span><span class="p">,</span>
					     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;Keypad Facility&quot;</span><span class="p">);</span>
			<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Useruserdata</span><span class="p">,</span>
					     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;User-User Data&quot;</span><span class="p">);</span>
			<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Facilitydataarray</span><span class="p">,</span>
					     <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;Facility Data Array&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Accept call */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">at_state</span><span class="p">,</span>
				       <span class="n">EV_ACCEPT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:			<span class="cm">/* Ignore */</span>
		<span class="cm">/* send DISCONNECT_IND to this application */</span>
		<span class="n">send_disconnect_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* remove it from the list of listening apps */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">==</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* last one: stop ev-layer hupD notifications */</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_NONE</span><span class="p">;</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">chstate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHS_NOTIFY_LL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">oap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span> <span class="n">oap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">oap</span> <span class="o">=</span> <span class="n">oap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">==</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">oap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="n">oap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: application %u not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>		<span class="cm">/* Reject */</span>
		<span class="cm">/* drop all competing applications, keep only this one */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">oap</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">oap</span><span class="o">-&gt;</span><span class="n">bcnext</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">oap</span> <span class="o">!=</span> <span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">send_disconnect_ind</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">oap</span><span class="p">,</span>
						    <span class="n">CapiCallGivenToOtherApplication</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">bcnext</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">aplock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* reject call - will trigger DISCONNECT_IND for this app */</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Reject=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="s">&quot;CONNECT_RESP&quot;</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Reject</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">at_state</span><span class="p">,</span>
				       <span class="n">EV_HUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process CONNECT_B3_REQ message</span>
<span class="cm"> * build NCCI and emit CONNECT_B3_CONF reply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_connect_b3_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>

	<span class="cm">/* extract and check channel number from PLCI */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid %s 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;CONNECT_B3_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;PLCI&quot;</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span><span class="p">);</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiIllContrPlciNcci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* mark logical connection active */</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_ACTIVE</span><span class="p">;</span>

	<span class="cm">/* build NCCI: always 1 (one B3 connection only) */</span>
	<span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* NCPI parameter: not applicable for B3 Transparent */</span>
	<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">NCPI</span><span class="p">,</span> <span class="s">&quot;CONNECT_B3_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;NCPI&quot;</span><span class="p">);</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">NCPI</span> <span class="o">&amp;&amp;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">NCPI</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span>
		  <span class="n">CapiNcpiNotSupportedByProtocol</span> <span class="o">:</span> <span class="n">CapiSuccess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process CONNECT_B3_RESP message</span>
<span class="cm"> * Depending on the Reject parameter, either emit CONNECT_B3_ACTIVE_IND</span>
<span class="cm"> * or queue EV_HUP and emit DISCONNECT_B3_IND.</span>
<span class="cm"> * The emitted message is always shorter than the received one,</span>
<span class="cm"> * allowing to reuse the skb.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_connect_b3_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msgsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">command</span><span class="p">;</span>

	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>

	<span class="cm">/* extract and check channel number and NCCI */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid %s 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;CONNECT_B3_RESP&quot;</span><span class="p">,</span> <span class="s">&quot;NCCI&quot;</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Reject</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reject: clear B3 connect received flag */</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_SETUP</span><span class="p">;</span>

		<span class="cm">/* trigger hangup, causing eventual DISCONNECT_IND */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span>
				       <span class="n">EV_HUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

		<span class="cm">/* emit DISCONNECT_B3_IND */</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">CAPI_DISCONNECT_B3</span><span class="p">;</span>
		<span class="n">msgsize</span> <span class="o">=</span> <span class="n">CAPI_DISCONNECT_B3_IND_BASELEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Accept: emit CONNECT_B3_ACTIVE_IND immediately, as</span>
<span class="cm">		 * we only send CONNECT_B3_IND if the B channel is up</span>
<span class="cm">		 */</span>
		<span class="n">command</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_B3_ACTIVE</span><span class="p">;</span>
		<span class="n">msgsize</span> <span class="o">=</span> <span class="n">CAPI_CONNECT_B3_ACTIVE_IND_BASELEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">capi_cmsg_header</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">CAPI_IND</span><span class="p">,</span>
			 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span><span class="p">);</span>
	<span class="n">__skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">msgsize</span><span class="p">);</span>
	<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>
	<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process DISCONNECT_REQ message</span>
<span class="cm"> * schedule EV_HUP and emit DISCONNECT_B3_IND if necessary,</span>
<span class="cm"> * emit DISCONNECT_CONF reply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_disconnect_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">b3cmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">b3skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>

	<span class="cm">/* extract and check channel number from PLCI */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid %s 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;PLCI&quot;</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span><span class="p">);</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiIllContrPlciNcci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* ToDo: process parameter: Additional info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">AdditionalInfo</span> <span class="o">!=</span> <span class="n">CAPI_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">BChannelinformation</span><span class="p">,</span>
				     <span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;B Channel Information&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Keypadfacility</span><span class="p">,</span>
				     <span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Keypad Facility&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Useruserdata</span><span class="p">,</span>
				     <span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;User-User Data&quot;</span><span class="p">);</span>
		<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">Facilitydataarray</span><span class="p">,</span>
				     <span class="s">&quot;DISCONNECT_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;Facility Data Array&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* skip if DISCONNECT_IND already sent */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* check for active logical connection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">&gt;=</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear it */</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">=</span> <span class="n">APCONN_SETUP</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * emit DISCONNECT_B3_IND with cause 0x3301</span>
<span class="cm">		 * use separate cmsg structure, as the content of iif-&gt;acmsg</span>
<span class="cm">		 * is still needed for creating the _CONF message</span>
<span class="cm">		 */</span>
		<span class="n">b3cmsg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">b3cmsg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b3cmsg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">capi_cmsg_header</span><span class="p">(</span><span class="n">b3cmsg</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">CAPI_DISCONNECT_B3</span><span class="p">,</span> <span class="n">CAPI_IND</span><span class="p">,</span>
				 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nextMessageNumber</span><span class="o">++</span><span class="p">,</span>
				 <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrPLCI</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">b3cmsg</span><span class="o">-&gt;</span><span class="n">Reason_B3</span> <span class="o">=</span> <span class="n">CapiProtocolErrorLayer1</span><span class="p">;</span>
		<span class="n">b3skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">CAPI_DISCONNECT_B3_IND_BASELEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b3skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">b3cmsg</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">capi_cmsg2message</span><span class="p">(</span><span class="n">b3cmsg</span><span class="p">,</span>
				  <span class="n">__skb_put</span><span class="p">(</span><span class="n">b3skb</span><span class="p">,</span> <span class="n">CAPI_DISCONNECT_B3_IND_BASELEN</span><span class="p">));</span>
		<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">b3cmsg</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">b3cmsg</span><span class="p">);</span>
		<span class="n">capi_ctr_handle_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">b3skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* trigger hangup, causing eventual DISCONNECT_IND */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">EV_HUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="cm">/* emit reply */</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiSuccess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process DISCONNECT_B3_REQ message</span>
<span class="cm"> * schedule EV_HUP and emit DISCONNECT_B3_CONF reply</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_disconnect_b3_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="n">_cmsg</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="n">cmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmsg</span><span class="p">);</span>

	<span class="cm">/* extract and check channel number and NCCI */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid %s 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;DISCONNECT_B3_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;NCCI&quot;</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">adr</span><span class="p">.</span><span class="n">adrNCCI</span><span class="p">);</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiIllContrPlciNcci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* reject if logical connection not active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">&lt;</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
			  <span class="n">CapiMessageNotSupportedInCurrentState</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* trigger hangup, causing eventual DISCONNECT_B3_IND */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">EV_HUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="cm">/* NCPI parameter: not applicable for B3 Transparent */</span>
	<span class="n">ignore_cstruct_param</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">NCPI</span><span class="p">,</span>
			     <span class="s">&quot;DISCONNECT_B3_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;NCPI&quot;</span><span class="p">);</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">NCPI</span> <span class="o">&amp;&amp;</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">NCPI</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span>
		  <span class="n">CapiNcpiNotSupportedByProtocol</span> <span class="o">:</span> <span class="n">CapiSuccess</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process DATA_B3_REQ message</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_data_b3_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">CAPIMSG_PLCI_PART</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ncci</span> <span class="o">=</span> <span class="n">CAPIMSG_NCCI_PART</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">msglen</span> <span class="o">=</span> <span class="n">CAPIMSG_LEN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">datalen</span> <span class="o">=</span> <span class="n">CAPIMSG_DATALEN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">CAPIMSG_FLAGS</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">msgid</span> <span class="o">=</span> <span class="n">CAPIMSG_MSGID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">CAPIMSG_HANDLE_REQ</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* frequent message, avoid _cmsg overhead */</span>
	<span class="n">dump_rawmsg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* check parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">||</span> <span class="n">ncci</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: invalid %s 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;DATA_B3_REQ&quot;</span><span class="p">,</span> <span class="s">&quot;NCCI&quot;</span><span class="p">,</span> <span class="n">CAPIMSG_NCCI</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiIllContrPlciNcci</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">!=</span> <span class="n">CAPI_DATA_B3_REQ_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">msglen</span> <span class="o">!=</span> <span class="n">CAPI_DATA_B3_REQ_LEN64</span><span class="p">)</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unexpected length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;DATA_B3_REQ&quot;</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: length mismatch (%d+%d!=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;DATA_B3_REQ&quot;</span><span class="p">,</span> <span class="n">msglen</span><span class="p">,</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msglen</span> <span class="o">+</span> <span class="n">datalen</span> <span class="o">&gt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* message too short for announced data length */</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiIllMessageParmCoding</span><span class="p">);</span> <span class="cm">/* ? */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CAPI_FLAGS_RESERVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: reserved flags set (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="s">&quot;DATA_B3_REQ&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiIllMessageParmCoding</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reject if logical connection not active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">apconnstate</span> <span class="o">&lt;</span> <span class="n">APCONN_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiMessageNotSupportedInCurrentState</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pull CAPI message into link layer header */</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_len</span> <span class="o">=</span> <span class="n">msglen</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">msglen</span><span class="p">);</span>

	<span class="cm">/* pass to device-specific module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_skb</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * DATA_B3_CONF will be sent by gigaset_skb_sent() only if &quot;delivery</span>
<span class="cm">	 * confirmation&quot; bit is set; otherwise we have to send it now</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CAPI_FLAGS_DELIVERY_CONFIRMATION</span><span class="p">))</span>
		<span class="n">send_data_b3_conf</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">msgid</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
				  <span class="n">flags</span> <span class="o">?</span> <span class="n">CapiFlagsNotSupportedByProtocol</span>
				  <span class="o">:</span> <span class="n">CAPI_NOERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * process RESET_B3_REQ message</span>
<span class="cm"> * just always reply &quot;not supported by current protocol&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_reset_b3_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">);</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
		  <span class="n">CapiResetProcedureNotSupportedByCurrentProtocol</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * unsupported CAPI message handler</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_unsupported</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">);</span>
	<span class="n">send_conf</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">CapiMessageNotSupportedInCurrentState</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CAPI message handler: no-op</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_nothing</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* decode message */</span>
	<span class="n">capi_message2cmsg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dump_cmsg</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">acmsg</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_data_b3_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dump_rawmsg</span><span class="p">(</span><span class="n">DEBUG_MCMD</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* table of outgoing CAPI message handlers with lookup function */</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">capi_send_handler_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">capi_send_handler_t</span> <span class="n">handler</span><span class="p">;</span>
<span class="p">}</span> <span class="n">capi_send_handler_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* most frequent messages first for faster lookup */</span>
	<span class="p">{</span> <span class="n">CAPI_DATA_B3_REQ</span><span class="p">,</span> <span class="n">do_data_b3_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_DATA_B3_RESP</span><span class="p">,</span> <span class="n">do_data_b3_resp</span> <span class="p">},</span>

	<span class="p">{</span> <span class="n">CAPI_ALERT_REQ</span><span class="p">,</span> <span class="n">do_alert_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_CONNECT_ACTIVE_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_CONNECT_B3_ACTIVE_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_CONNECT_B3_REQ</span><span class="p">,</span> <span class="n">do_connect_b3_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_CONNECT_B3_RESP</span><span class="p">,</span> <span class="n">do_connect_b3_resp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_CONNECT_B3_T90_ACTIVE_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_CONNECT_REQ</span><span class="p">,</span> <span class="n">do_connect_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_CONNECT_RESP</span><span class="p">,</span> <span class="n">do_connect_resp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_DISCONNECT_B3_REQ</span><span class="p">,</span> <span class="n">do_disconnect_b3_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_DISCONNECT_B3_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_DISCONNECT_REQ</span><span class="p">,</span> <span class="n">do_disconnect_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_DISCONNECT_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_FACILITY_REQ</span><span class="p">,</span> <span class="n">do_facility_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_FACILITY_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_LISTEN_REQ</span><span class="p">,</span> <span class="n">do_listen_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_SELECT_B_PROTOCOL_REQ</span><span class="p">,</span> <span class="n">do_unsupported</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_RESET_B3_REQ</span><span class="p">,</span> <span class="n">do_reset_b3_req</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_RESET_B3_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * ToDo: support overlap sending (requires ev-layer state</span>
<span class="cm">	 * machine extension to generate additional ATD commands)</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">CAPI_INFO_REQ</span><span class="p">,</span> <span class="n">do_unsupported</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_INFO_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * ToDo: what&#39;s the proper response for these?</span>
<span class="cm">	 */</span>
	<span class="p">{</span> <span class="n">CAPI_MANUFACTURER_REQ</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">CAPI_MANUFACTURER_RESP</span><span class="p">,</span> <span class="n">do_nothing</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* look up handler */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">capi_send_handler_t</span> <span class="nf">lookup_capi_send_handler</span><span class="p">(</span><span class="k">const</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">capi_send_handler_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capi_send_handler_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">capi_send_handler_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * gigaset_send_message() - accept a CAPI message from an application</span>
<span class="cm"> * @ctr:	controller descriptor structure.</span>
<span class="cm"> * @skb:	CAPI message.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: CAPI error code</span>
<span class="cm"> * Note: capidrv (and probably others, too) only uses the return value to</span>
<span class="cm"> * decide whether it has to free the skb (only if result != CAPI_NOERROR (0))</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">gigaset_send_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span>
		<span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ctr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">gigaset_capi_ctr</span><span class="p">,</span> <span class="n">ctr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">ctr</span><span class="o">-&gt;</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_appl</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">capi_send_handler_t</span> <span class="n">handler</span><span class="p">;</span>

	<span class="cm">/* can only handle linear sk_buffs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_linearize</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: skb_linearize failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">CAPI_MSGOSRESOURCEERR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* retrieve application data structure */</span>
	<span class="n">ap</span> <span class="o">=</span> <span class="n">get_appl</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">CAPIMSG_APPID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: application %u not registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">CAPIMSG_APPID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">CAPI_ILLAPPNR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* look up command */</span>
	<span class="n">handler</span> <span class="o">=</span> <span class="n">lookup_capi_send_handler</span><span class="p">(</span><span class="n">CAPIMSG_CMD</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unknown/unsupported message type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: unsupported message %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">CAPIMSG_CMD</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">CAPI_ILLCMDORSUBCMDORMSGTOSMALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* serialize */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_add_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">sendqlen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* queue behind other messages */</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">sendqueue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">CAPI_NOERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* process message */</span>
	<span class="n">handler</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* process other messages arrived in the meantime */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_sub_return</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">sendqlen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">sendqueue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* should never happen */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: send queue empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ap</span> <span class="o">=</span> <span class="n">get_appl</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">CAPIMSG_APPID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* could that happen? */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: application %u vanished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">CAPIMSG_APPID</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">handler</span> <span class="o">=</span> <span class="n">lookup_capi_send_handler</span><span class="p">(</span><span class="n">CAPIMSG_CMD</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* should never happen */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: handler %x vanished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">CAPIMSG_CMD</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">handler</span><span class="p">(</span><span class="n">iif</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">CAPI_NOERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_procinfo() - build single line description for controller</span>
<span class="cm"> * @ctr:	controller descriptor structure.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: pointer to generated string (null terminated)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">gigaset_procinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ctr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>	<span class="cm">/* ToDo: more? */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">capi_ctr</span> <span class="o">*</span><span class="n">ctr</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">ctr</span><span class="o">-&gt;</span><span class="n">driverdata</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">ctr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;dev&quot;</span><span class="p">,</span>
		   <span class="n">dev_driver_string</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">myid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">gotfwver</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %d.%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;firmware&quot;</span><span class="p">,</span>
			   <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">fwver</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;channels&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;onechannel&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">onechannel</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">M_UNKNOWN</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_CONFIG</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;config&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_UNIMODEM</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Unimodem&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">M_CID</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;CID&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;??&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;mode&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MS_UNINITIALIZED</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;uninitialized&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MS_INIT</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;init&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MS_LOCKED</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;locked&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MS_SHUTDOWN</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;shutdown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MS_RECOVER</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;recover&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MS_READY</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;ready&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;??&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;mstate&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;running&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;connected&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;isdn_up&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">isdn_up</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%-16s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;cidmode&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cidmode</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%d]%-13s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;corrupted&quot;</span><span class="p">,</span>
			   <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">corrupted</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%d]%-13s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;trans_down&quot;</span><span class="p">,</span>
			   <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trans_down</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%d]%-13s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;trans_up&quot;</span><span class="p">,</span>
			   <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trans_up</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%d]%-13s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;chstate&quot;</span><span class="p">,</span>
			   <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chstate</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">proto2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">L2_BITSYNC</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;bitsync&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">L2_HDLC</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;HDLC&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">L2_VOICE</span>:
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;voice&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;??&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;[%d]%-13s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;proto2&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">gigaset_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">gigaset_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">gigaset_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_regdev() - register device to LL</span>
<span class="cm"> * @cs:		device descriptor structure.</span>
<span class="cm"> * @isdnid:	device name.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value: 0 on success, error code &lt; 0 on failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">gigaset_isdn_regdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isdnid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">iif</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iif</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepare controller structure */</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">owner</span>         <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driverdata</span>    <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">isdnid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">driver_name</span>   <span class="o">=</span> <span class="s">&quot;gigaset&quot;</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">load_firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">reset_ctr</span>     <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">register_appl</span> <span class="o">=</span> <span class="n">gigaset_register_appl</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">release_appl</span>  <span class="o">=</span> <span class="n">gigaset_release_appl</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">send_message</span>  <span class="o">=</span> <span class="n">gigaset_send_message</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">procinfo</span>      <span class="o">=</span> <span class="n">gigaset_procinfo</span><span class="p">;</span>
	<span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">.</span><span class="n">proc_fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gigaset_proc_fops</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">appls</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">sendqueue</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">sendqlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* register controller with CAPI */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">attach_capi_ctr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;attach_capi_ctr failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">iif</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span> <span class="o">=</span> <span class="n">iif</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw_hdr_len</span> <span class="o">=</span> <span class="n">CAPI_DATA_B3_REQ_LEN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_unregdev() - unregister device from LL</span>
<span class="cm"> * @cs:		device descriptor structure.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_unregdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gigaset_capi_ctr</span> <span class="o">*</span><span class="n">iif</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span><span class="p">;</span>

	<span class="n">detach_capi_ctr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iif</span><span class="o">-&gt;</span><span class="n">ctr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iif</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">iif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">capi_driver</span> <span class="n">capi_driver_gigaset</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;gigaset&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">revision</span>	<span class="o">=</span> <span class="s">&quot;1.0&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_regdrv() - register driver to LL</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_regdrv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Kernel CAPI interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">register_capi_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">capi_driver_gigaset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * gigaset_isdn_unregdrv() - unregister driver from LL</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">gigaset_isdn_unregdrv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_capi_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">capi_driver_gigaset</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
