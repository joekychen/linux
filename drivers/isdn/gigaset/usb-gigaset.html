<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › gigaset › usb-gigaset.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>usb-gigaset.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * USB driver for Gigaset 307x directly or using M105 Data.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 by Stefan Eilers</span>
<span class="cm"> *                   and Hansjoerg Lipp &lt;hjlipp@web.de&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver was derived from the USB skeleton driver by</span>
<span class="cm"> * Greg Kroah-Hartman &lt;greg@kroah.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *	the License, or (at your option) any later version.</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;gigaset.h&quot;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cm">/* Version Information */</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Hansjoerg Lipp &lt;hjlipp@web.de&gt;, Stefan Eilers&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;USB Driver for Gigaset 307x using M105&quot;</span>

<span class="cm">/* Module parameters */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">startmode</span> <span class="o">=</span> <span class="n">SM_ISDN</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cidmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">startmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cidmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">startmode</span><span class="p">,</span> <span class="s">&quot;start in isdn4linux mode&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cidmode</span><span class="p">,</span> <span class="s">&quot;Call-ID mode&quot;</span><span class="p">);</span>

<span class="cp">#define GIGASET_MINORS     1</span>
<span class="cp">#define GIGASET_MINOR      8</span>
<span class="cp">#define GIGASET_MODULENAME &quot;usb_gigaset&quot;</span>
<span class="cp">#define GIGASET_DEVNAME    &quot;ttyGU&quot;</span>

<span class="cm">/* length limit according to Siemens 3070usb-protokoll.doc ch. 2.1 */</span>
<span class="cp">#define IF_WRITEBUF 264</span>

<span class="cm">/* Values for the Gigaset M105 Data */</span>
<span class="cp">#define USB_M105_VENDOR_ID	0x0681</span>
<span class="cp">#define USB_M105_PRODUCT_ID	0x0009</span>

<span class="cm">/* table of devices that work with this driver */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">gigaset_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_M105_VENDOR_ID</span><span class="p">,</span> <span class="n">USB_M105_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>					<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">gigaset_table</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Control requests (empty fields: 00)</span>
<span class="cm"> *</span>
<span class="cm"> *       RT|RQ|VALUE|INDEX|LEN  |DATA</span>
<span class="cm"> * In:</span>
<span class="cm"> *       C1 08             01</span>
<span class="cm"> *            Get flags (1 byte). Bits: 0=dtr,1=rts,3-7:?</span>
<span class="cm"> *       C1 0F             ll ll</span>
<span class="cm"> *            Get device information/status (llll: 0x200 and 0x40 seen).</span>
<span class="cm"> *            Real size: I only saw MIN(llll,0x64).</span>
<span class="cm"> *            Contents: seems to be always the same...</span>
<span class="cm"> *              offset 0x00: Length of this structure (0x64) (len: 1,2,3 bytes)</span>
<span class="cm"> *              offset 0x3c: String (16 bit chars): &quot;MCCI USB Serial V2.0&quot;</span>
<span class="cm"> *              rest:        ?</span>
<span class="cm"> * Out:</span>
<span class="cm"> *       41 11</span>
<span class="cm"> *            Initialize/reset device ?</span>
<span class="cm"> *       41 00 xx 00</span>
<span class="cm"> *            ? (xx=00 or 01; 01 on start, 00 on close)</span>
<span class="cm"> *       41 07 vv mm</span>
<span class="cm"> *            Set/clear flags vv=value, mm=mask (see RQ 08)</span>
<span class="cm"> *       41 12 xx</span>
<span class="cm"> *            Used before the following configuration requests are issued</span>
<span class="cm"> *            (with xx=0x0f). I&#39;ve seen other values&lt;0xf, though.</span>
<span class="cm"> *       41 01 xx xx</span>
<span class="cm"> *            Set baud rate. xxxx=ceil(0x384000/rate)=trunc(0x383fff/rate)+1.</span>
<span class="cm"> *       41 03 ps bb</span>
<span class="cm"> *            Set byte size and parity. p:  0x20=even,0x10=odd,0x00=no parity</span>
<span class="cm"> *                                     [    0x30: m, 0x40: s           ]</span>
<span class="cm"> *                                     [s:  0: 1 stop bit; 1: 1.5; 2: 2]</span>
<span class="cm"> *                                      bb: bits/byte (seen 7 and 8)</span>
<span class="cm"> *       41 13 -- -- -- -- 10 00 ww 00 00 00 xx 00 00 00 yy 00 00 00 zz 00 00 00</span>
<span class="cm"> *            ??</span>
<span class="cm"> *            Initialization: 01, 40, 00, 00</span>
<span class="cm"> *            Open device:    00  40, 00, 00</span>
<span class="cm"> *            yy and zz seem to be equal, either 0x00 or 0x0a</span>
<span class="cm"> *            (ww,xx) pairs seen: (00,00), (00,40), (01,40), (09,80), (19,80)</span>
<span class="cm"> *       41 19 -- -- -- -- 06 00 00 00 00 xx 11 13</span>
<span class="cm"> *            Used after every &quot;configuration sequence&quot; (RQ 12, RQs 01/03/13).</span>
<span class="cm"> *            xx is usually 0x00 but was 0x7e before starting data transfer</span>
<span class="cm"> *            in unimodem mode. So, this might be an array of characters that</span>
<span class="cm"> *            need special treatment (&quot;commit all bufferd data&quot;?), 11=^Q, 13=^S.</span>
<span class="cm"> *</span>
<span class="cm"> * Unimodem mode: use &quot;modprobe ppp_async flag_time=0&quot; as the device _needs_ two</span>
<span class="cm"> * flags per packet.</span>
<span class="cm"> */</span>

<span class="cm">/* functions called if a device of this driver is connected/disconnected */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gigaset_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>

<span class="cm">/* functions called before/after suspend */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gigaset_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>

<span class="cm">/* usb specific object needed to register this driver with the usb subsystem */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">gigaset_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">GIGASET_MODULENAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">gigaset_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">gigaset_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">gigaset_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">gigaset_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">gigaset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>	<span class="n">gigaset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_reset</span> <span class="o">=</span>	<span class="n">gigaset_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_reset</span> <span class="o">=</span>	<span class="n">gigaset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">usb_cardstate</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span>	<span class="o">*</span><span class="n">udev</span><span class="p">;</span>		<span class="cm">/* usb device pointer */</span>
	<span class="k">struct</span> <span class="n">usb_interface</span>	<span class="o">*</span><span class="n">interface</span><span class="p">;</span>	<span class="cm">/* interface for this device */</span>
	<span class="kt">int</span>			<span class="n">busy</span><span class="p">;</span>		<span class="cm">/* bulk output in progress */</span>

	<span class="cm">/* Output buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">bulk_out_buffer</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">bulk_out_size</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">bulk_out_endpointAddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">bulk_out_urb</span><span class="p">;</span>

	<span class="cm">/* Input buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">rcvbuf</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rcvbuf_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">read_urb</span><span class="p">;</span>
	<span class="n">__u8</span>			<span class="n">int_in_endpointAddr</span><span class="p">;</span>

	<span class="kt">char</span>			<span class="n">bchars</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* for request 0x19 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">tiocm_to_gigaset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">TIOCM_DTR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">TIOCM_RTS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_set_modem_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">old_state</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">tiocm_to_gigaset</span><span class="p">(</span><span class="n">old_state</span> <span class="o">^</span> <span class="n">new_state</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">tiocm_to_gigaset</span><span class="p">(</span><span class="n">new_state</span><span class="p">);</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;set flags 0x%02x with mask 0x%02x&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span> <span class="cm">/* timeout? */</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set M105 configuration value</span>
<span class="cm"> * using undocumented device commands reverse engineered from USB traces</span>
<span class="cm"> * of the Siemens Windows driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="n">u8</span> <span class="n">req</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">r2</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;request %02x (%04x)&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">req</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
			    <span class="mh">0xf</span> <span class="cm">/*?*/</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span> <span class="cm">/*?*/</span><span class="p">);</span>
	<span class="cm">/* no idea what this does */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error %d on request 0x12</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">req</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
			    <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span> <span class="cm">/*?*/</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error %d on request 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">-</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">req</span><span class="p">);</span>

	<span class="n">r2</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2000</span> <span class="cm">/*?*/</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error %d on request 0x19</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">r2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r</span> <span class="o">:</span> <span class="p">(</span><span class="n">r2</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">r2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the baud rate on the internal serial adapter</span>
<span class="cm"> * using the undocumented parameter setting command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">cflag</span> <span class="o">&amp;=</span> <span class="n">CBAUD</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>    <span class="n">B300</span>: <span class="n">rate</span> <span class="o">=</span>     <span class="mi">300</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>    <span class="n">B600</span>: <span class="n">rate</span> <span class="o">=</span>     <span class="mi">600</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>   <span class="n">B1200</span>: <span class="n">rate</span> <span class="o">=</span>    <span class="mi">1200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>   <span class="n">B2400</span>: <span class="n">rate</span> <span class="o">=</span>    <span class="mi">2400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>   <span class="n">B4800</span>: <span class="n">rate</span> <span class="o">=</span>    <span class="mi">4800</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>   <span class="n">B9600</span>: <span class="n">rate</span> <span class="o">=</span>    <span class="mi">9600</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">B19200</span>: <span class="n">rate</span> <span class="o">=</span>   <span class="mi">19200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">B38400</span>: <span class="n">rate</span> <span class="o">=</span>   <span class="mi">38400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">B57600</span>: <span class="n">rate</span> <span class="o">=</span>   <span class="mi">57600</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B115200</span>: <span class="n">rate</span> <span class="o">=</span>  <span class="mi">115200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rate</span> <span class="o">=</span>  <span class="mi">9600</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported baudrate request 0x%x,&quot;</span>
			<span class="s">&quot; using default of B9600</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cflag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x383fff</span> <span class="o">/</span> <span class="n">rate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_value</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the line format on the internal serial adapter</span>
<span class="cm"> * using the undocumented parameter setting command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_set_line_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set the parity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARENB</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">PARODD</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x10</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="cm">/* set the number of data bits */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CS5</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS6</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS7</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CS8</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CSIZE was not CS5-CS8, using default of 8</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set the number of stop bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSTOPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cflag</span> <span class="o">&amp;</span> <span class="n">CSIZE</span><span class="p">)</span> <span class="o">==</span> <span class="n">CS5</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 1.5 stop bits */</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 2 stop bits */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">set_value</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*============================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_init_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do for M10x */</span>
	<span class="n">gigaset_bchannel_up</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_close_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do for M10x */</span>
	<span class="n">gigaset_bchannel_down</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">write_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">);</span>


<span class="cm">/* Write tasklet handler: Continue sending current skb, or send command, or</span>
<span class="cm"> * start sending an skb from the send queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_modem_fill</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* only one channel */</span>
	<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">again</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;modem_fill&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;modem_fill: busy&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">again</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* no skb is being sent */</span>
			<span class="n">cb</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* commands to send? */</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;modem_fill: cb&quot;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">send_cb</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span>
						<span class="s">&quot;modem_fill: send_cb failed&quot;</span><span class="p">);</span>
					<span class="n">again</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* no callback will be</span>
<span class="cm">						      called! */</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* skbs to send? */</span>
				<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
					<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span>
						<span class="s">&quot;Dequeued skb (Adr: %lx)!&quot;</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;modem_fill: tx_skb&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">write_modem</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span>
					<span class="s">&quot;modem_fill: write_modem failed&quot;</span><span class="p">);</span>
				<span class="n">again</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* no callback will be called! */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">again</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt Input URB completion routine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_read_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbuf_t</span> <span class="o">*</span><span class="n">inbuf</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">numbytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">numbytes</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">numbytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;%s: There was no leading 0, but 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
			<span class="o">++</span><span class="n">src</span><span class="p">;</span> <span class="cm">/* skip leading 0x00 */</span>
			<span class="o">--</span><span class="n">numbytes</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gigaset_fill_inbuf</span><span class="p">(</span><span class="n">inbuf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;%s--&gt;BH&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;Received zero block length&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The urb might have been killed. */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;%s - nonzero status received: %d&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span>
			<span class="cm">/* killed or endpoint shutdown: don&#39;t resubmit */</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* resubmit URB */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error %d resubmitting URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* This callback routine is called when data was transmitted to the device. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_write_bulk_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:			<span class="cm">/* normal completion */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:		<span class="cm">/* killed */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;%s: killed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bulk transfer failed (status %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">-</span><span class="n">status</span><span class="p">);</span>
		<span class="cm">/* That&#39;s all we can do. Communication problems</span>
<span class="cm">		   are handled by timeouts or network protocols. */</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">tcb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tcb</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span> <span class="o">-=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="p">;</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;send_cb: sent %u bytes, %u left&quot;</span><span class="p">,</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tcb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">)</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="n">tcb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tcb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_size</span><span class="p">);</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;send_cb: send %d bytes&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

			<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					  <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
							  <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddr</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">),</span>
					  <span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
					  <span class="n">gigaset_write_bulk_callback</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>

			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">?</span>
				<span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">:</span>
				<span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;could not submit urb (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="o">-</span><span class="n">status</span><span class="p">);</span>
				<span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* skip urb =&gt; remove cb+wakeup</span>
<span class="cm">						in next loop cycle */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">cb</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">);</span> <span class="cm">/* next command on error */</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send command to device. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_write_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">gigaset_dbg_buffer</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">!=</span> <span class="n">MS_LOCKED</span> <span class="o">?</span>
			   <span class="n">DEBUG_TRANSCMD</span> <span class="o">:</span> <span class="n">DEBUG_LOCKCMD</span><span class="p">,</span>
			   <span class="s">&quot;CMD Transmit&quot;</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span> <span class="o">+=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">IF_WRITEBUF</span> <span class="o">?</span> <span class="n">IF_WRITEBUF</span> <span class="o">-</span> <span class="n">bytes</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the break characters on the internal serial adapter</span>
<span class="cm"> * using undocumented device commands reverse engineered from USB traces</span>
<span class="cm"> * of the Siemens Windows driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_brkchars</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">gigaset_dbg_buffer</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;brkchars&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_freebcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unused */</span>
<span class="p">}</span>

<span class="cm">/* Initialize the b-channel structure */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_initbcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unused */</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_reinitbcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do for M10x */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_freecshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_initcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_cardstate</span> <span class="o">*</span><span class="n">ucs</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span> <span class="o">=</span> <span class="n">ucs</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cardstate</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bchars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">,</span>
		     <span class="n">gigaset_modem_fill</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send data from current skb to the device. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* only one channel */</span>
	<span class="k">struct</span> <span class="n">usb_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;len: %d...&quot;</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy data to bulk out buffer and transmit data */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_size</span><span class="p">);</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;write_modem: send %d bytes&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				  <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						  <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddr</span> <span class="o">&amp;</span>
						  <span class="mh">0x0f</span><span class="p">),</span>
				  <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
				  <span class="n">gigaset_write_bulk_callback</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not submit urb (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skb sent completely */</span>
		<span class="n">gigaset_skb_sent</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>

		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;kfree skb (Adr: %lx)!&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">hostif</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buffer_size</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;%s: Check if device matches ...&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* See if the device offered us matches what we can accept */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">)</span>  <span class="o">!=</span> <span class="n">USB_M105_VENDOR_ID</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_M105_PRODUCT_ID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;device ID (0x%x, 0x%x) not for me - skip&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;interface %d not for me - skip&quot;</span><span class="p">,</span>
			<span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported altsetting %d - skip&quot;</span><span class="p">,</span>
			   <span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported interface class %d - skip&quot;</span><span class="p">,</span>
			   <span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Device matched ... !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* allocate memory for our device state and initialize it */</span>
	<span class="n">cs</span> <span class="o">=</span> <span class="n">gigaset_initcs</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cidmode</span><span class="p">,</span> <span class="n">GIGASET_MODULENAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="p">;</span>

	<span class="cm">/* save off device structure ptrs for later use */</span>
	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* save address of controller structure */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>

	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_size</span> <span class="o">=</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_endpointAddr</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate bulk_out_buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate bulk_out_urb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No free urbs available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_endpointAddr</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate rcvbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill the interrupt urb and send it to the core */</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">),</span>
			 <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">,</span>
			 <span class="n">gigaset_read_int_callback</span><span class="p">,</span>
			 <span class="n">cs</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not submit URB (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* tell common part that the device is ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">startmode</span> <span class="o">==</span> <span class="n">SM_LOCKED</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_LOCKED</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">gigaset_start</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gigaset_freecs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cardstate</span> <span class="o">*</span><span class="n">ucs</span><span class="p">;</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnecting Gigaset USB adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>

	<span class="n">gigaset_stop</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">read_urb</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gigaset_freecs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* gigaset_suspend</span>
<span class="cm"> * This function is called before the USB connection is suspended or reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="cm">/* stop activity */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* prevent rescheduling */</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">bulk_out_urb</span><span class="p">);</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;suspend complete&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_resume</span>
<span class="cm"> * This function is called after the USB connection has been resumed or reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* resubmit interrupt URB */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">read_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Could not submit read URB (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;resume complete&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_pre_reset</span>
<span class="cm"> * This function is called before the USB connection is reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* same as suspend */</span>
	<span class="k">return</span> <span class="n">gigaset_suspend</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">PMSG_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gigaset_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">gigaset_write_cmd</span><span class="p">,</span>
	<span class="n">gigaset_write_room</span><span class="p">,</span>
	<span class="n">gigaset_chars_in_buffer</span><span class="p">,</span>
	<span class="n">gigaset_brkchars</span><span class="p">,</span>
	<span class="n">gigaset_init_bchannel</span><span class="p">,</span>
	<span class="n">gigaset_close_bchannel</span><span class="p">,</span>
	<span class="n">gigaset_initbcshw</span><span class="p">,</span>
	<span class="n">gigaset_freebcshw</span><span class="p">,</span>
	<span class="n">gigaset_reinitbcshw</span><span class="p">,</span>
	<span class="n">gigaset_initcshw</span><span class="p">,</span>
	<span class="n">gigaset_freecshw</span><span class="p">,</span>
	<span class="n">gigaset_set_modem_ctrl</span><span class="p">,</span>
	<span class="n">gigaset_baud_rate</span><span class="p">,</span>
	<span class="n">gigaset_set_line_ctrl</span><span class="p">,</span>
	<span class="n">gigaset_m10x_send_skb</span><span class="p">,</span>
	<span class="n">gigaset_m10x_input</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called while kernel-module is loaded</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">usb_gigaset_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* allocate memory for our driver state and initialize it */</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="n">gigaset_initdriver</span><span class="p">(</span><span class="n">GIGASET_MINOR</span><span class="p">,</span> <span class="n">GIGASET_MINORS</span><span class="p">,</span>
				    <span class="n">GIGASET_MODULENAME</span><span class="p">,</span> <span class="n">GIGASET_DEVNAME</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* register this driver with the USB subsystem */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gigaset_usb_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d registering USB driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">gigaset_freedriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called while unloading the kernel-module</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">usb_gigaset_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gigaset_blockdriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span> <span class="cm">/* =&gt; probe will fail</span>
<span class="cm">				      * =&gt; no gigaset_start any more</span>
<span class="cm">				      */</span>

	<span class="cm">/* stop all connected devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">minors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gigaset_shutdown</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* from now on, no isdn callback should be possible */</span>

	<span class="cm">/* deregister this driver with the USB subsystem */</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gigaset_usb_driver</span><span class="p">);</span>
	<span class="cm">/* this will call the disconnect-callback */</span>
	<span class="cm">/* from now on, no disconnect/probe callback should be running */</span>

	<span class="n">gigaset_freedriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">usb_gigaset_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">usb_gigaset_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
