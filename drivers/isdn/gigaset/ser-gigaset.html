<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › gigaset › ser-gigaset.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ser-gigaset.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* This is the serial hardware link layer (HLL) for the Gigaset 307x isdn</span>
<span class="cm"> * DECT base (aka Sinus 45 isdn) using the RS232 DECT data module M101,</span>
<span class="cm"> * written as a line discipline.</span>
<span class="cm"> *</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> * the License, or (at your option) any later version.</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;gigaset.h&quot;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>

<span class="cm">/* Version Information */</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Tilman Schmidt&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Serial Driver for Gigaset 307x using Siemens M101&quot;</span>

<span class="cp">#define GIGASET_MINORS     1</span>
<span class="cp">#define GIGASET_MINOR      0</span>
<span class="cp">#define GIGASET_MODULENAME &quot;ser_gigaset&quot;</span>
<span class="cp">#define GIGASET_DEVNAME    &quot;ttyGS&quot;</span>

<span class="cm">/* length limit according to Siemens 3070usb-protokoll.doc ch. 2.1 */</span>
<span class="cp">#define IF_WRITEBUF 264</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_LDISC</span><span class="p">(</span><span class="n">N_GIGASET_M101</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">startmode</span> <span class="o">=</span> <span class="n">SM_ISDN</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">startmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">startmode</span><span class="p">,</span> <span class="s">&quot;initial operation mode&quot;</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cidmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cidmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cidmode</span><span class="p">,</span> <span class="s">&quot;stay in CID mode when idle&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">gigaset_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ser_cardstate</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span>	<span class="o">*</span><span class="n">tty</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">refcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>	<span class="n">dead_cmp</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">device_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">GIGASET_MODULENAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_send_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* transmit data from current open skb</span>
<span class="cm"> * result: number of bytes sent or error code &lt; 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_modem</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	<span class="cm">/* only one channel */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="n">sent</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;write_modem: sent %d&quot;</span><span class="p">,</span> <span class="n">sent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error */</span>
		<span class="n">flush_send_queue</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* skb sent completely */</span>
		<span class="n">gigaset_skb_sent</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;kfree skb (Adr: %lx)!&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * transmit first queued command buffer</span>
<span class="cm"> * result: number of bytes sent or error code &lt; 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="o">*</span><span class="n">tcb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">cb</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* nothing to do */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sent</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* error */</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;send_cb: write error %d&quot;</span><span class="p">,</span> <span class="n">sent</span><span class="p">);</span>
			<span class="n">flush_send_queue</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">sent</span><span class="p">;</span>
		<span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-=</span> <span class="n">sent</span><span class="p">;</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;send_cb: sent %d, left %u, queued %u&quot;</span><span class="p">,</span>
			<span class="n">sent</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">cb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span> <span class="o">-=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="p">;</span>
		<span class="n">tcb</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cb</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tcb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="n">tcb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tcb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sent</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send queue tasklet</span>
<span class="cm"> * If there is already a skb opened, put data to the transfer buffer</span>
<span class="cm"> * by calling &quot;write_modem&quot;.</span>
<span class="cm"> * Otherwise take a new skb out of the queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_modem_fill</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">nextskb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;%s: no cardstate&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;%s: no cardstate&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no skb is being sent; send command if any */</span>
		<span class="n">sent</span> <span class="o">=</span> <span class="n">send_cb</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;%s: send_cb -&gt; %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sent</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sent</span><span class="p">)</span>
			<span class="cm">/* something sent or error */</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* no command to send; get skb */</span>
		<span class="n">nextskb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nextskb</span><span class="p">)</span>
			<span class="cm">/* no skb either, nothing to do */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">nextskb</span><span class="p">;</span>

		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;Dequeued skb (Adr: %lx)&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send skb */</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;%s: tx_skb&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_modem</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;%s: write_modem failed&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * throw away all data queued for sending</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_send_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* command queue */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cb</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* data queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Gigaset Driver Interface */</span>
<span class="cm">/* ======================== */</span>

<span class="cm">/*</span>
<span class="cm"> * queue an AT command string for transmission to the Gigaset device</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	cs		controller state structure</span>
<span class="cm"> *	buf		buffer containing the string to send</span>
<span class="cm"> *	len		number of characters to send</span>
<span class="cm"> *	wake_tasklet	tasklet to run when transmission is complete, or NULL</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of bytes queued, or error code &lt; 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_write_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">gigaset_dbg_buffer</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">!=</span> <span class="n">MS_LOCKED</span> <span class="o">?</span>
			   <span class="n">DEBUG_TRANSCMD</span> <span class="o">:</span> <span class="n">DEBUG_LOCKCMD</span><span class="p">,</span>
			   <span class="s">&quot;CMD Transmit&quot;</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span> <span class="o">+=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tty_driver.write_room interface routine</span>
<span class="cm"> * return number of characters the driver will accept to be written</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of characters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">IF_WRITEBUF</span> <span class="o">?</span> <span class="n">IF_WRITEBUF</span> <span class="o">-</span> <span class="n">bytes</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * tty_driver.chars_in_buffer interface routine</span>
<span class="cm"> * return number of characters waiting to be sent</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of characters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * implementation of ioctl(GIGASET_BRKCHARS)</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	-EINVAL (unimplemented function)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_brkchars</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="cm">/* not implemented */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open B channel</span>
<span class="cm"> * Called by &quot;do_action&quot; in ev-layer.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_init_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do for M10x */</span>
	<span class="n">gigaset_bchannel_up</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close B channel</span>
<span class="cm"> * Called by &quot;do_action&quot; in ev-layer.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_close_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do for M10x */</span>
	<span class="n">gigaset_bchannel_down</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up B channel structure</span>
<span class="cm"> * This is called by &quot;gigaset_initcs&quot; in common.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_initbcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unused */</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free B channel structure</span>
<span class="cm"> * Called by &quot;gigaset_freebcs&quot; in common.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_freebcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* unused */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reinitialize B channel structure</span>
<span class="cm"> * This is called by &quot;bcs_reinit&quot; in common.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_reinitbcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing to do for M10x */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free hardware specific device data</span>
<span class="cm"> * This will be called by &quot;gigaset_freecs&quot; in common.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_freecshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_device_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* adapted from platform_device_release() in drivers/base/platform.c */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up hardware specific device data</span>
<span class="cm"> * This is called by &quot;gigaset_initcs&quot; in common.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_initcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ser_cardstate</span> <span class="o">*</span><span class="n">scs</span><span class="p">;</span>

	<span class="n">scs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ser_cardstate</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">scs</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">GIGASET_MODULENAME</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">minor_index</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">gigaset_device_release</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d registering platform device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="p">);</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">,</span>
		     <span class="n">gigaset_modem_fill</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set modem control lines</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	card state structure</span>
<span class="cm"> *	modem control line state ([TIOCM_DTR]|[TIOCM_RTS])</span>
<span class="cm"> * Called by &quot;gigaset_start&quot; and &quot;gigaset_enterconfigmode&quot; in common.c</span>
<span class="cm"> * and by &quot;if_lock&quot; and &quot;if_termios&quot; in interface.c</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_set_modem_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">old_state</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tty</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tiocmset</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">new_state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">old_state</span><span class="p">;</span>
	<span class="n">clear</span> <span class="o">=</span> <span class="n">old_state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">new_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">clear</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_IF</span><span class="p">,</span> <span class="s">&quot;tiocmset set %x clear %x&quot;</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tiocmset</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_set_line_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gigaset_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">gigaset_write_cmd</span><span class="p">,</span>
	<span class="n">gigaset_write_room</span><span class="p">,</span>
	<span class="n">gigaset_chars_in_buffer</span><span class="p">,</span>
	<span class="n">gigaset_brkchars</span><span class="p">,</span>
	<span class="n">gigaset_init_bchannel</span><span class="p">,</span>
	<span class="n">gigaset_close_bchannel</span><span class="p">,</span>
	<span class="n">gigaset_initbcshw</span><span class="p">,</span>
	<span class="n">gigaset_freebcshw</span><span class="p">,</span>
	<span class="n">gigaset_reinitbcshw</span><span class="p">,</span>
	<span class="n">gigaset_initcshw</span><span class="p">,</span>
	<span class="n">gigaset_freecshw</span><span class="p">,</span>
	<span class="n">gigaset_set_modem_ctrl</span><span class="p">,</span>
	<span class="n">gigaset_baud_rate</span><span class="p">,</span>
	<span class="n">gigaset_set_line_ctrl</span><span class="p">,</span>
	<span class="n">gigaset_m10x_send_skb</span><span class="p">,</span>	<span class="cm">/* asyncdata.c */</span>
	<span class="n">gigaset_m10x_input</span><span class="p">,</span>	<span class="cm">/* asyncdata.c */</span>
<span class="p">};</span>


<span class="cm">/* Line Discipline Interface */</span>
<span class="cm">/* ========================= */</span>

<span class="cm">/* helper functions for cardstate refcounting */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="nf">cs_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span> <span class="o">||</span> <span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;%s: no cardstate&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cs</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dead_cmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the tty driver when the line discipline is pushed onto the tty.</span>
<span class="cm"> * Called in process context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gigaset_tty_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Starting HLL for Gigaset M101&quot;</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no driver structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate memory for our device state and initialize it */</span>
	<span class="n">cs</span> <span class="o">=</span> <span class="n">gigaset_initcs</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cidmode</span><span class="p">,</span> <span class="n">GIGASET_MODULENAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dead_cmp</span><span class="p">);</span>

	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="n">cs</span><span class="p">;</span>

	<span class="cm">/* OK.. Initialization of the datastructures and the HW is done.. Now</span>
<span class="cm">	 * startup system and notify the LL that we are ready to run</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">startmode</span> <span class="o">==</span> <span class="n">SM_LOCKED</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_LOCKED</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">gigaset_start</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Startup of HLL done&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Startup of HLL failed&quot;</span><span class="p">);</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gigaset_freecs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the tty driver when the line discipline is removed.</span>
<span class="cm"> * Called from process context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gigaset_tty_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Stopping HLL for Gigaset M101&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;%s: no cardstate&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prevent other callers from entering ldisc methods */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no hw cardstate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wait for running methods to finish */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
			<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">ser</span><span class="o">-&gt;</span><span class="n">dead_cmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* stop operations */</span>
	<span class="n">gigaset_stop</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="n">flush_send_queue</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gigaset_freecs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Shutdown of HLL done&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the tty driver when the tty line is hung up.</span>
<span class="cm"> * Wait for I/O to driver to complete and unregister ISDN device.</span>
<span class="cm"> * This is already done by the close routine, so just call that.</span>
<span class="cm"> * Called from process context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_tty_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gigaset_tty_close</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read on the tty.</span>
<span class="cm"> * Unused, received data goes only to the Gigaset driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">gigaset_tty_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write on the tty.</span>
<span class="cm"> * Unused, transmit data comes only from the Gigaset driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">gigaset_tty_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Ioctl on the tty.</span>
<span class="cm"> * Called in process context only.</span>
<span class="cm"> * May be re-entered by multiple ioctl calling threads.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">gigaset_tty_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">FIONREAD</span>:
		<span class="cm">/* unused, always return zero */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TCFLSH</span>:
		<span class="cm">/* flush our buffers and the serial port&#39;s buffer */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TCIFLUSH</span>:
			<span class="cm">/* no own input buffer to flush */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TCIOFLUSH</span>:
		<span class="k">case</span> <span class="n">TCOFLUSH</span>:
			<span class="n">flush_send_queue</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Pass through */</span>

	<span class="nl">default:</span>
		<span class="cm">/* pass through to underlying serial device */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">n_tty_ioctl_helper</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs_put</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the tty driver when a block of data has been received.</span>
<span class="cm"> * Will not be re-entered while running but other ldisc functions</span>
<span class="cm"> * may be called in parallel.</span>
<span class="cm"> * Can be called from hard interrupt level as well as soft interrupt</span>
<span class="cm"> * level or mainline.</span>
<span class="cm"> * Parameters:</span>
<span class="cm"> *	tty	tty structure</span>
<span class="cm"> *	buf	buffer containing received characters</span>
<span class="cm"> *	cflags	buffer containing error flags for received characters (ignored)</span>
<span class="cm"> *	count	number of received characters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gigaset_tty_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		    <span class="kt">char</span> <span class="o">*</span><span class="n">cflags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">tail</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbuf_t</span> <span class="o">*</span><span class="n">inbuf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">inbuf</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: no inbuf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">cs_put</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tail</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">head</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;buffer state: %u -&gt; %u, receive %u bytes&quot;</span><span class="p">,</span>
		<span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head</span> <span class="o">&lt;=</span> <span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* possible buffer wraparound */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">RBUFSIZE</span> <span class="o">-</span> <span class="n">tail</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">tail</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">tail</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">RBUFSIZE</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* tail &lt; head and some data left */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">head</span> <span class="o">-</span> <span class="n">tail</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;inbuf overflow, discarding %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">count</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">tail</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">tail</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;setting tail to %u&quot;</span><span class="p">,</span> <span class="n">tail</span><span class="p">);</span>
	<span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">;</span>

	<span class="cm">/* Everything was received .. Push data into handler */</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;%s--&gt;BH&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">cs_put</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the tty driver when there&#39;s room for more data to send.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gigaset_tty_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">cs_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">write_tasklet</span><span class="p">);</span>
	<span class="n">cs_put</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="n">gigaset_ldisc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">magic</span>		<span class="o">=</span> <span class="n">TTY_LDISC_MAGIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;ser_gigaset&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">gigaset_tty_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">gigaset_tty_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hangup</span>		<span class="o">=</span> <span class="n">gigaset_tty_hangup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">gigaset_tty_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">gigaset_tty_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">gigaset_tty_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">receive_buf</span>	<span class="o">=</span> <span class="n">gigaset_tty_receive</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_wakeup</span>	<span class="o">=</span> <span class="n">gigaset_tty_wakeup</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Initialization / Shutdown */</span>
<span class="cm">/* ========================= */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ser_gigaset_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d registering platform driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate memory for our driver state and initialize it */</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="n">gigaset_initdriver</span><span class="p">(</span><span class="n">GIGASET_MINOR</span><span class="p">,</span> <span class="n">GIGASET_MINORS</span><span class="p">,</span>
				    <span class="n">GIGASET_MODULENAME</span><span class="p">,</span> <span class="n">GIGASET_DEVNAME</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tty_register_ldisc</span><span class="p">(</span><span class="n">N_GIGASET_M101</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gigaset_ldisc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d registering line discipline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gigaset_freedriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ser_gigaset_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gigaset_freedriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">tty_unregister_ldisc</span><span class="p">(</span><span class="n">N_GIGASET_M101</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d unregistering line discipline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ser_gigaset_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ser_gigaset_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
