<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › isdn › gigaset › bas-gigaset.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bas-gigaset.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * USB driver for Gigaset 307x base via direct USB connection.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001 by Hansjoerg Lipp &lt;hjlipp@web.de&gt;,</span>
<span class="cm"> *                       Tilman Schmidt &lt;tilman@imap.cc&gt;,</span>
<span class="cm"> *                       Stefan Eilers.</span>
<span class="cm"> *</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or</span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *	the License, or (at your option) any later version.</span>
<span class="cm"> * =====================================================================</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;gigaset.h&quot;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cm">/* Version Information */</span>
<span class="cp">#define DRIVER_AUTHOR &quot;Tilman Schmidt &lt;tilman@imap.cc&gt;, Hansjoerg Lipp &lt;hjlipp@web.de&gt;, Stefan Eilers&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;USB Driver for Gigaset 307x&quot;</span>


<span class="cm">/* Module parameters */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">startmode</span> <span class="o">=</span> <span class="n">SM_ISDN</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cidmode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">startmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cidmode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">startmode</span><span class="p">,</span> <span class="s">&quot;start in isdn4linux mode&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cidmode</span><span class="p">,</span> <span class="s">&quot;Call-ID mode&quot;</span><span class="p">);</span>

<span class="cp">#define GIGASET_MINORS     1</span>
<span class="cp">#define GIGASET_MINOR      16</span>
<span class="cp">#define GIGASET_MODULENAME &quot;bas_gigaset&quot;</span>
<span class="cp">#define GIGASET_DEVNAME    &quot;ttyGB&quot;</span>

<span class="cm">/* length limit according to Siemens 3070usb-protokoll.doc ch. 2.1 */</span>
<span class="cp">#define IF_WRITEBUF 264</span>

<span class="cm">/* interrupt pipe message size according to ibid. ch. 2.2 */</span>
<span class="cp">#define IP_MSGSIZE 3</span>

<span class="cm">/* Values for the Gigaset 307x */</span>
<span class="cp">#define USB_GIGA_VENDOR_ID      0x0681</span>
<span class="cp">#define USB_3070_PRODUCT_ID     0x0001</span>
<span class="cp">#define USB_3075_PRODUCT_ID     0x0002</span>
<span class="cp">#define USB_SX303_PRODUCT_ID    0x0021</span>
<span class="cp">#define USB_SX353_PRODUCT_ID    0x0022</span>

<span class="cm">/* table of devices that work with this driver */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">gigaset_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_GIGA_VENDOR_ID</span><span class="p">,</span> <span class="n">USB_3070_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_GIGA_VENDOR_ID</span><span class="p">,</span> <span class="n">USB_3075_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_GIGA_VENDOR_ID</span><span class="p">,</span> <span class="n">USB_SX303_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="n">USB_GIGA_VENDOR_ID</span><span class="p">,</span> <span class="n">USB_SX353_PRODUCT_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">gigaset_table</span><span class="p">);</span>

<span class="cm">/*======================= local function prototypes ==========================*/</span>

<span class="cm">/* function called if a new device belonging to this driver is connected */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>

<span class="cm">/* Function will be called if the device is unplugged */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">gigaset_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">);</span>

<span class="cm">/* functions called before/after suspend */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>

<span class="cm">/* functions called before/after device reset */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gigaset_post_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">atread_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">stopurbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">req_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atwrite_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">start_cbsend</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*============================================================================*/</span>

<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span>	<span class="o">*</span><span class="n">udev</span><span class="p">;</span>		<span class="cm">/* USB device pointer */</span>
	<span class="k">struct</span> <span class="n">usb_interface</span>	<span class="o">*</span><span class="n">interface</span><span class="p">;</span>	<span class="cm">/* interface for this device */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">minor</span><span class="p">;</span>		<span class="cm">/* starting minor number */</span>

	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb_ctrl</span><span class="p">;</span>	<span class="cm">/* control pipe default URB */</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">dr_ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer_ctrl</span><span class="p">;</span>	<span class="cm">/* control request timeout */</span>
	<span class="kt">int</span>			<span class="n">retry_ctrl</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer_atrdy</span><span class="p">;</span>	<span class="cm">/* AT command ready timeout */</span>
	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb_cmd_out</span><span class="p">;</span>	<span class="cm">/* for sending AT commands */</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">dr_cmd_out</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">retry_cmd_out</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb_cmd_in</span><span class="p">;</span>	<span class="cm">/* for receiving AT replies */</span>
	<span class="k">struct</span> <span class="n">usb_ctrlrequest</span>	<span class="n">dr_cmd_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer_cmd_in</span><span class="p">;</span>	<span class="cm">/* receive request timeout */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">rcvbuf</span><span class="p">;</span>	<span class="cm">/* AT reply receive buffer */</span>

	<span class="k">struct</span> <span class="n">urb</span>		<span class="o">*</span><span class="n">urb_int_in</span><span class="p">;</span>	<span class="cm">/* URB for interrupt pipe */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">int_in_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span>	<span class="n">int_in_wq</span><span class="p">;</span>	<span class="cm">/* for usb_clear_halt() */</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">timer_int_in</span><span class="p">;</span>	<span class="cm">/* int read retry delay */</span>
	<span class="kt">int</span>			<span class="n">retry_int_in</span><span class="p">;</span>

	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>		<span class="cm">/* locks all following */</span>
	<span class="kt">int</span>			<span class="n">basstate</span><span class="p">;</span>	<span class="cm">/* bitmap (BS_*) */</span>
	<span class="kt">int</span>			<span class="n">pending</span><span class="p">;</span>	<span class="cm">/* uncompleted base request */</span>
	<span class="n">wait_queue_head_t</span>	<span class="n">waitqueue</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">rcvbuf_size</span><span class="p">;</span>	<span class="cm">/* size of AT receive buffer */</span>
						<span class="cm">/* 0: no receive in progress */</span>
	<span class="kt">int</span>			<span class="n">retry_cmd_in</span><span class="p">;</span>	<span class="cm">/* receive req retry count */</span>
<span class="p">};</span>

<span class="cm">/* status of direct USB connection to 307x base (bits in basstate) */</span>
<span class="cp">#define BS_ATOPEN	0x001	</span><span class="cm">/* AT channel open */</span><span class="cp"></span>
<span class="cp">#define BS_B1OPEN	0x002	</span><span class="cm">/* B channel 1 open */</span><span class="cp"></span>
<span class="cp">#define BS_B2OPEN	0x004	</span><span class="cm">/* B channel 2 open */</span><span class="cp"></span>
<span class="cp">#define BS_ATREADY	0x008	</span><span class="cm">/* base ready for AT command */</span><span class="cp"></span>
<span class="cp">#define BS_INIT		0x010	</span><span class="cm">/* base has signalled INIT_OK */</span><span class="cp"></span>
<span class="cp">#define BS_ATTIMER	0x020	</span><span class="cm">/* waiting for HD_READY_SEND_ATDATA */</span><span class="cp"></span>
<span class="cp">#define BS_ATRDPEND	0x040	</span><span class="cm">/* urb_cmd_in in use */</span><span class="cp"></span>
<span class="cp">#define BS_ATWRPEND	0x080	</span><span class="cm">/* urb_cmd_out in use */</span><span class="cp"></span>
<span class="cp">#define BS_SUSPEND	0x100	</span><span class="cm">/* USB port suspended */</span><span class="cp"></span>
<span class="cp">#define BS_RESETTING	0x200	</span><span class="cm">/* waiting for HD_RESET_INTERRUPT_PIPE_ACK */</span><span class="cp"></span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">gigaset_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>

<span class="cm">/* usb specific object needed to register this driver with the usb subsystem */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">gigaset_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">GIGASET_MODULENAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>        <span class="n">gigaset_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>   <span class="n">gigaset_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>     <span class="n">gigaset_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">gigaset_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">gigaset_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>	<span class="n">gigaset_post_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_reset</span> <span class="o">=</span>	<span class="n">gigaset_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_reset</span> <span class="o">=</span>	<span class="n">gigaset_post_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* get message text for usb_submit_urb return code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_usb_rcmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">unkmsg</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="k">return</span> <span class="s">&quot;out of memory&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
		<span class="k">return</span> <span class="s">&quot;device not present&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="k">return</span> <span class="s">&quot;endpoint not present&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENXIO</span>:
		<span class="k">return</span> <span class="s">&quot;URB type not supported&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
		<span class="k">return</span> <span class="s">&quot;invalid argument&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
		<span class="k">return</span> <span class="s">&quot;start frame too early or too much scheduled&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EFBIG</span>:
		<span class="k">return</span> <span class="s">&quot;too many isoc frames requested&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
		<span class="k">return</span> <span class="s">&quot;endpoint stalled&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EMSGSIZE</span>:
		<span class="k">return</span> <span class="s">&quot;invalid packet size&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOSPC</span>:
		<span class="k">return</span> <span class="s">&quot;would overcommit USB bandwidth&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span> <span class="s">&quot;device shut down&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPERM</span>:
		<span class="k">return</span> <span class="s">&quot;reject flag set&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span>:
		<span class="k">return</span> <span class="s">&quot;device suspended&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">unkmsg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">unkmsg</span><span class="p">),</span> <span class="s">&quot;unknown error %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">unkmsg</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* get message text for USB status code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_usb_statmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">unkmsg</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="s">&quot;success&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="k">return</span> <span class="s">&quot;unlinked (sync)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:
		<span class="k">return</span> <span class="s">&quot;URB still pending&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPROTO</span>:
		<span class="k">return</span> <span class="s">&quot;bitstuff error, timeout, or unknown USB error&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EILSEQ</span>:
		<span class="k">return</span> <span class="s">&quot;CRC mismatch, timeout, or unknown USB error&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
		<span class="k">return</span> <span class="s">&quot;USB response timeout&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
		<span class="k">return</span> <span class="s">&quot;endpoint stalled&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECOMM</span>:
		<span class="k">return</span> <span class="s">&quot;IN buffer overrun&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOSR</span>:
		<span class="k">return</span> <span class="s">&quot;OUT buffer underrun&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EOVERFLOW</span>:
		<span class="k">return</span> <span class="s">&quot;endpoint babble&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EREMOTEIO</span>:
		<span class="k">return</span> <span class="s">&quot;short packet&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
		<span class="k">return</span> <span class="s">&quot;device removed&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EXDEV</span>:
		<span class="k">return</span> <span class="s">&quot;partial isoc transfer&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
		<span class="k">return</span> <span class="s">&quot;ISO madness&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
		<span class="k">return</span> <span class="s">&quot;unlinked (async)&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span> <span class="s">&quot;device shut down&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">unkmsg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">unkmsg</span><span class="p">),</span> <span class="s">&quot;unknown status %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">unkmsg</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* usb_pipetype_str</span>
<span class="cm"> * retrieve string representation of USB pipe type</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">usb_pipetype_str</span><span class="p">(</span><span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeisoc</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;Isoc&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipeint</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;Int&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipecontrol</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;Ctrl&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_pipebulk</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;Bulk&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dump_urb</span>
<span class="cm"> * write content of URB to syslog for debugging</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_urb</span><span class="p">(</span><span class="k">enum</span> <span class="n">debuglevel</span> <span class="n">level</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_GIGASET_DEBUG</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;%s urb(0x%08lx)-&gt;{&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span>
			<span class="s">&quot;  dev=0x%08lx, pipe=%s:EP%d/DV%d:%s, &quot;</span>
			<span class="s">&quot;hcpriv=0x%08lx, transfer_flags=0x%x,&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">usb_pipetype_str</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
			<span class="n">usb_pipeendpoint</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span> <span class="n">usb_pipedevice</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">),</span>
			<span class="n">usb_pipein</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;in&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span>
			<span class="s">&quot;  transfer_buffer=0x%08lx[%d], actual_length=%d, &quot;</span>
			<span class="s">&quot;setup_packet=0x%08lx,&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">setup_packet</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span>
			<span class="s">&quot;  start_frame=%d, number_of_packets=%d, interval=%d, &quot;</span>
			<span class="s">&quot;error_count=%d,&quot;</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">,</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">error_count</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span>
			<span class="s">&quot;  context=0x%08lx, complete=0x%08lx, &quot;</span>
			<span class="s">&quot;iso_frame_desc[]={&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_iso_packet_descriptor</span> <span class="o">*</span><span class="n">pifd</span>
				<span class="o">=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span>
				<span class="s">&quot;    {offset=%u, length=%u, actual_length=%u, &quot;</span>
				<span class="s">&quot;status=%u}&quot;</span><span class="p">,</span>
				<span class="n">pifd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">pifd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pifd</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
				<span class="n">pifd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;}}&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* read/set modem control bits etc. (m10x only) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_set_modem_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">old_state</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_set_line_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set/clear bits in base connection state, return previous state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">update_basstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">set</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">clear</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* error_hangup</span>
<span class="cm"> * hang up any existing connection because of an unrecoverable error</span>
<span class="cm"> * This function may be called from any context and takes care of scheduling</span>
<span class="cm"> * the necessary actions for execution outside of interrupt context.</span>
<span class="cm"> * cs-&gt;lock must not be held.</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	B channel control structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">error_hangup</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="n">gigaset_add_event</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">at_state</span><span class="p">,</span> <span class="n">EV_HUP</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* error_reset</span>
<span class="cm"> * reset Gigaset device because of an unrecoverable error</span>
<span class="cm"> * This function may be called from any context, and takes care of</span>
<span class="cm"> * scheduling the necessary actions for execution outside of interrupt context.</span>
<span class="cm"> * cs-&gt;hw.bas-&gt;lock must not be held.</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">error_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset interrupt pipe to recover (ignore errors) */</span>
	<span class="n">update_basstate</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">,</span> <span class="n">BS_RESETTING</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req_submit</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="n">HD_RESET_INTERRUPT_PIPE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">))</span>
		<span class="cm">/* submission failed, escalate to USB port reset */</span>
		<span class="n">usb_queue_reset_device</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* check_pending</span>
<span class="cm"> * check for completion of pending control request</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	ucs	hardware specific controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_OPEN_ATCHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATOPEN</span><span class="p">)</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_OPEN_B1CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B1OPEN</span><span class="p">)</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_OPEN_B2CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B2OPEN</span><span class="p">)</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_CLOSE_ATCHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATOPEN</span><span class="p">))</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_CLOSE_B1CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B1OPEN</span><span class="p">))</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_CLOSE_B2CHANNEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B2OPEN</span><span class="p">))</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_DEVICE_INIT_ACK</span>:		<span class="cm">/* no reply expected */</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_RESET_INTERRUPT_PIPE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_RESETTING</span><span class="p">))</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * HD_READ_ATMESSAGE and HD_WRITE_ATMESSAGE are handled separately</span>
<span class="cm">	 * and should never end up here</span>
<span class="cm">	 */</span>
	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;unknown pending request 0x%02x cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_ctrl</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* cmd_in_timeout</span>
<span class="cm"> * timeout routine for command input request</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmd_in_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: no receive in progress&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">BAS_RETRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;control read: timeout, giving up after %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: timeout, retry %d&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">atread_submit</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* read_ctrl_callback</span>
<span class="cm"> * USB completion handler for control pipe input</span>
<span class="cm"> * called by the USB subsystem in interrupt context</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	urb	USB request block</span>
<span class="cm"> *		urb-&gt;context = inbuf structure for controller state</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_ctrl_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inbuf_t</span> <span class="o">*</span><span class="n">inbuf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">inbuf</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">numbytes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_ATRDPEND</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_cmd_in</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:				<span class="cm">/* normal completion */</span>
		<span class="n">numbytes</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">numbytes</span> <span class="o">!=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;control read: received %d chars, expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">numbytes</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">numbytes</span> <span class="o">&gt;</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">)</span>
				<span class="n">numbytes</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* copy received bytes to inbuf, notify event layer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gigaset_fill_inbuf</span><span class="p">(</span><span class="n">inbuf</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;%s--&gt;BH&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">gigaset_schedule_event</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:			<span class="cm">/* cancelled */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:		<span class="cm">/* cancelled (async) */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:		<span class="cm">/* pending */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:			<span class="cm">/* device removed */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:		<span class="cm">/* device shut down */</span>
		<span class="cm">/* no further action necessary */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>			<span class="cm">/* other errors: retry */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">BAS_RETRY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: %s, retry %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">atread_submit</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* successfully resubmitted, skip freeing */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
				<span class="cm">/* disconnect, no further action necessary */</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;control read: %s, giving up after %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span><span class="p">);</span>
		<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* read finished, free buffer */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* atread_submit</span>
<span class="cm"> * submit an HD_READ_ATMESSAGE command URB and optionally start a timeout</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	cs	controller state structure</span>
<span class="cm"> *	timeout	timeout in 1/10 sec., 0: none</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	-EBUSY if another request is pending</span>
<span class="cm"> *	any URB submission error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atread_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">basstate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;-------&gt; HD_READ_ATMESSAGE (%d)&quot;</span><span class="p">,</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">);</span>

	<span class="n">basstate</span> <span class="o">=</span> <span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_ATRDPEND</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATRDPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;could not submit HD_READ_ATMESSAGE: URB busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;HD_READ_ATMESSAGE not submitted, &quot;</span>
			   <span class="s">&quot;suspend in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_ATRDPEND</span><span class="p">);</span>
		<span class="cm">/* treat like disconnect */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_in</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">IN_VENDOR_REQ</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_in</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">HD_READ_ATMESSAGE</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_in</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_in</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_in</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">);</span>
	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_in</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			     <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_in</span><span class="p">,</span>
			     <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">,</span>
			     <span class="n">read_ctrl_callback</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">inbuf</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_in</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_ATRDPEND</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not submit HD_READ_ATMESSAGE: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;setting timeout of %d/10 secs&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_cmd_in</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* int_in_work</span>
<span class="cm"> * workqueue routine to clear halt on interrupt in endpoint</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_in_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bas_cardstate</span><span class="p">,</span> <span class="n">int_in_wq</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* clear halt condition */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;clear_halt: %s&quot;</span><span class="p">,</span> <span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* success, resubmit interrupt read URB */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clear halt failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_lock_device_for_reset</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_reset_device</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
			<span class="n">usb_unlock_device</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_int_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* int_in_resubmit</span>
<span class="cm"> * timer routine for interrupt read delayed resubmit</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">int_in_resubmit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_int_in</span><span class="o">++</span> <span class="o">&gt;=</span> <span class="n">BAS_RETRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt read: giving up after %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_int_in</span><span class="p">);</span>
		<span class="n">usb_queue_reset_device</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: retry %d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_int_in</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not resubmit interrupt URB: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
		<span class="n">usb_queue_reset_device</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* read_int_callback</span>
<span class="cm"> * USB completion handler for interrupt pipe input</span>
<span class="cm"> * called by the USB subsystem in interrupt context</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	urb	USB request block</span>
<span class="cm"> *		urb-&gt;context = controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_int_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:			<span class="cm">/* success */</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_int_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:			<span class="cm">/* endpoint stalled */</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_wq</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:			<span class="cm">/* cancelled */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:		<span class="cm">/* cancelled (async) */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:		<span class="cm">/* pending */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:			<span class="cm">/* device removed */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:		<span class="cm">/* device shut down */</span>
		<span class="cm">/* no further action necessary */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EPROTO</span>:			<span class="cm">/* protocol error or unplug */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EILSEQ</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
		<span class="cm">/* resubmit after delay */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_int_in</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>		<span class="cm">/* other errors: just resubmit */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt read: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* drop incomplete packets even if the missing bytes wouldn&#39;t matter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&lt;</span> <span class="n">IP_MSGSIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;incomplete interrupt packet (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
		<span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;&lt;-------%d: 0x%02x (%u [0x%02x 0x%02x])&quot;</span><span class="p">,</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HD_DEVICE_INIT_OK</span>:
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_READY_SEND_ATDATA</span>:
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_atrdy</span><span class="p">);</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_ATREADY</span><span class="p">,</span> <span class="n">BS_ATTIMER</span><span class="p">);</span>
		<span class="n">start_cbsend</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_OPEN_B2CHANNEL_ACK</span>:
		<span class="o">++</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_OPEN_B1CHANNEL_ACK</span>:
		<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_B1OPEN</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">gigaset_bchannel_up</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_OPEN_ATCHANNEL_ACK</span>:
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_ATOPEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">start_cbsend</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_CLOSE_B2CHANNEL_ACK</span>:
		<span class="o">++</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_CLOSE_B1CHANNEL_ACK</span>:
		<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_B1OPEN</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">stopurbs</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">);</span>
		<span class="n">gigaset_bchannel_down</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_CLOSE_ATCHANNEL_ACK</span>:
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_ATOPEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_B2_FLOW_CONTROL</span>:
		<span class="o">++</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HD_B1_FLOW_CONTROL</span>:
		<span class="n">bcs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">atomic_add</span><span class="p">((</span><span class="n">l</span> <span class="o">-</span> <span class="n">BAS_NORMFRAME</span><span class="p">)</span> <span class="o">*</span> <span class="n">BAS_CORRFRAMES</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">corrbytes</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span>
			<span class="s">&quot;Flow control (channel %d, sub %d): 0x%02x =&gt; %d&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="p">,</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">numsub</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
			<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">corrbytes</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_RECEIVEATDATA_ACK</span>:	<span class="cm">/* AT response ready to be received */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;HD_RECEIVEATDATA_ACK with length 0 ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATRDPEND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;HD_RECEIVEATDATA_ACK(%d) during HD_READ_ATMESSAGE(%d) ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">l</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* throw away previous buffer - we have no queue */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;receive AT data overrun, %d bytes lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory receiving AT data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">atread_submit</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_RESET_INTERRUPT_PIPE_ACK</span>:
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_RESETTING</span><span class="p">);</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt pipe reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_SUSPEND_END</span>:
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;HD_SUSPEND_END&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;unknown Gigaset signal 0x%02x (%u) ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">l</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">check_pending</span><span class="p">(</span><span class="n">ucs</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>

<span class="nl">resubmit:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not resubmit interrupt URB: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
		<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* read_iso_callback</span>
<span class="cm"> * USB completion handler for B channel isochronous input</span>
<span class="cm"> * called by the USB subsystem in interrupt context</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	urb	USB request block of completed request</span>
<span class="cm"> *		urb-&gt;context = bc_state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_iso_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* status codes not worth bothering the tasklet with */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNRESET</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bcs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">ubc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoindone</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* pass URB to tasklet */</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoindone</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinstatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">rcvd_tasklet</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* tasklet still busy, drop data and resubmit URB */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: overrun&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">loststatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlost</span> <span class="o">+=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				     <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span>
				<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">loststatus</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* urb-&gt;dev is clobbered by USB subsystem */</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;could not resubmit isoc read URB: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
				<span class="n">dump_urb</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;isoc read&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
				<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write_iso_callback</span>
<span class="cm"> * USB completion handler for B channel isochronous output</span>
<span class="cm"> * called by the USB subsystem in interrupt context</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	urb	USB request block of completed request</span>
<span class="cm"> *		urb-&gt;context = isow_urbctx_t structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_iso_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isow_urbctx_t</span> <span class="o">*</span><span class="n">ucx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* status codes not worth bothering the tasklet with */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNRESET</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span> <span class="o">||</span>
		     <span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pass URB context to tasklet */</span>
	<span class="n">ucx</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">ubc</span> <span class="o">=</span> <span class="n">ucx</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="n">ucx</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutovfl</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutdone</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutdone</span> <span class="o">=</span> <span class="n">ucx</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">sent_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* starturbs</span>
<span class="cm"> * prepare and submit USB request blocks for isochronous input and output</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	B channel control structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	&lt; 0 on error (no URBs submitted)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">starturbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* initialize L2 reception */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">proto2</span> <span class="o">==</span> <span class="n">L2_HDLC</span><span class="p">)</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">inputstate</span> <span class="o">|=</span> <span class="n">INS_flag_hunt</span><span class="p">;</span>

	<span class="cm">/* submit all isochronous input URBs */</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">BAS_INURBS</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinbuf</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">BAS_INBUFSIZE</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">BAS_INBUFSIZE</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">BAS_FRAMETIME</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">read_iso_callback</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">BAS_MAXFRAME</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">BAS_MAXFRAME</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dump_urb</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;Initial isoc read&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize L2 transmission */</span>
	<span class="n">gigaset_isowbuf_init</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="p">,</span> <span class="n">PPP_FLAG</span><span class="p">);</span>

	<span class="cm">/* set up isochronous output URBs for flag idling */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">BAS_OUTURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">urb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndisocpipe</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">BAS_FRAMETIME</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">write_iso_callback</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">BAS_OUTBUFSIZE</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">BAS_NORMFRAME</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* keep one URB free, submit the others */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">BAS_OUTURBS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dump_urb</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;Initial isoc write&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dump_urb</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;Initial isoc write (free)&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">BAS_OUTURBS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutdone</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutovfl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">stopurbs</span><span class="p">(</span><span class="n">ubc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* stopurbs</span>
<span class="cm"> * cancel the USB request blocks for isochronous input and output</span>
<span class="cm"> * errors are silently ignored</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	B channel control structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stopurbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">BAS_INURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span>
			<span class="s">&quot;%s: isoc input URB %d unlinked, result = %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">BAS_OUTURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span>
			<span class="s">&quot;%s: isoc output URB %d unlinked, result = %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Isochronous Write - Bottom Half */</span>
<span class="cm">/* =============================== */</span>

<span class="cm">/* submit_iso_write_urb</span>
<span class="cm"> * fill and submit the next isochronous write URB</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	ucx	context structure containing URB</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of frames submitted in URB</span>
<span class="cm"> *	0 if URB not submitted because no data available (isooutbuf busy)</span>
<span class="cm"> *	error code &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">submit_iso_write_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">isow_urbctx_t</span> <span class="o">*</span><span class="n">ucx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="n">ucx</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">ucx</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_iso_packet_descriptor</span> <span class="o">*</span><span class="n">ifd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">corrbytes</span><span class="p">,</span> <span class="n">nframe</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* urb-&gt;dev is clobbered by USB subsystem */</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ucx</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nframe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nframe</span> <span class="o">&lt;</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span> <span class="n">nframe</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ifd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">nframe</span><span class="p">];</span>

		<span class="cm">/* compute frame length according to flow control */</span>
		<span class="n">ifd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">BAS_NORMFRAME</span><span class="p">;</span>
		<span class="n">corrbytes</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">corrbytes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">corrbytes</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: corrbytes=%d&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">corrbytes</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">corrbytes</span> <span class="o">&gt;</span> <span class="n">BAS_HIGHFRAME</span> <span class="o">-</span> <span class="n">BAS_NORMFRAME</span><span class="p">)</span>
				<span class="n">corrbytes</span> <span class="o">=</span> <span class="n">BAS_HIGHFRAME</span> <span class="o">-</span> <span class="n">BAS_NORMFRAME</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">corrbytes</span> <span class="o">&lt;</span> <span class="n">BAS_LOWFRAME</span> <span class="o">-</span> <span class="n">BAS_NORMFRAME</span><span class="p">)</span>
				<span class="n">corrbytes</span> <span class="o">=</span> <span class="n">BAS_LOWFRAME</span> <span class="o">-</span> <span class="n">BAS_NORMFRAME</span><span class="p">;</span>
			<span class="n">ifd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">+=</span> <span class="n">corrbytes</span><span class="p">;</span>
			<span class="n">atomic_add</span><span class="p">(</span><span class="o">-</span><span class="n">corrbytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">corrbytes</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* retrieve block of data to send */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">gigaset_isowbuf_getbytes</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="p">,</span> <span class="n">ifd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span>
					<span class="s">&quot;%s: buffer busy at frame %d&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">nframe</span><span class="p">);</span>
				<span class="cm">/* tasklet will be restarted from</span>
<span class="cm">				   gigaset_isoc_send_skb() */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">ucx</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: buffer error %d at frame %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">nframe</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ifd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">ucx</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="o">-&gt;</span><span class="n">nextread</span><span class="p">;</span>
		<span class="n">ifd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ifd</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">nframe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* no data to send */</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">nframe</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="cm">/* device removed - give up silently */</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: disconnected&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">ucx</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;could not submit isoc write URB: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">++</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">numsub</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">nframe</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* write_iso_tasklet</span>
<span class="cm"> * tasklet scheduled when an isochronous output URB from the Gigaset device</span>
<span class="cm"> * has completed</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	data	B channel state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_iso_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isow_urbctx_t</span> <span class="o">*</span><span class="n">done</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">ovfl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_iso_packet_descriptor</span> <span class="o">*</span><span class="n">ifd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* loop while completed URBs arrive in time */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: not running&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* retrieve completed URBs */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">done</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutdone</span><span class="p">;</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutdone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ovfl</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutovfl</span><span class="p">;</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutovfl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ovfl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isoc write underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* submit free URB if available */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span><span class="p">;</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">submit_iso_write_urb</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* could not submit URB, put it back */</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
					<span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* couldn&#39;t put it back */</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;losing isoc write URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* process completed URB */</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">done</span><span class="o">-&gt;</span><span class="n">urb</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">done</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EXDEV</span>:			<span class="cm">/* partial completion */</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: URB partially completed&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="cm">/* fall through - what&#39;s the difference anyway? */</span>
		<span class="k">case</span> <span class="mi">0</span>:				<span class="cm">/* normal completion */</span>
			<span class="cm">/* inspect individual frames</span>
<span class="cm">			 * assumptions (for lack of documentation):</span>
<span class="cm">			 * - actual_length bytes of first frame in error are</span>
<span class="cm">			 *   successfully sent</span>
<span class="cm">			 * - all following frames are not sent at all</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ifd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ifd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span>
				    <span class="n">ifd</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">!=</span> <span class="n">ifd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="s">&quot;isoc write: frame %d[%d/%d]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">i</span><span class="p">,</span> <span class="n">ifd</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">,</span>
						 <span class="n">ifd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
						 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">ifd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:			<span class="cm">/* stall - probably underrun */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isoc write: stalled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>			<span class="cm">/* other errors */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isoc write: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* mark the write buffer area covered by this URB as free */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">done</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span>

		<span class="cm">/* mark URB as free */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span><span class="p">;</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* only one URB still active - resubmit one */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">submit_iso_write_urb</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* couldn&#39;t submit */</span>
				<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* process queued SKBs */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* copy to output buffer, doing L2 encapsulation */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gigaset_isoc_buildframe</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* insufficient buffer space, push back onto queue */</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: skb requeued, qlen=%d&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">squeue</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">gigaset_skb_sent</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Isochronous Read - Bottom Half */</span>
<span class="cm">/* ============================== */</span>

<span class="cm">/* read_iso_tasklet</span>
<span class="cm"> * tasklet scheduled when an isochronous input URB from the Gigaset device</span>
<span class="cm"> * has completed</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	data	B channel state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_iso_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_iso_packet_descriptor</span> <span class="o">*</span><span class="n">ifd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rcvbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">totleft</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* loop while more completed URBs arrive in the meantime */</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="cm">/* retrieve URB */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoindone</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinstatus</span><span class="p">;</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoindone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">loststatus</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;isoc read overrun, URB dropped (status: %s, %d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">loststatus</span><span class="p">),</span>
				 <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlost</span><span class="p">);</span>
			<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">loststatus</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span>
				<span class="s">&quot;%s: channel not running, &quot;</span>
				<span class="s">&quot;dropped URB with status: %s&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:				<span class="cm">/* normal completion */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EXDEV</span>:			<span class="cm">/* inspect individual frames</span>
<span class="cm">						   (we do that anyway) */</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: URB partially completed&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
		<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
			<span class="k">continue</span><span class="p">;</span>		<span class="cm">/* -&gt; skip */</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isoc read: stalled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>		<span class="cm">/* -&gt; skip */</span>
		<span class="nl">default:</span>			<span class="cm">/* other error */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isoc read: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rcvbuf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
		<span class="n">totleft</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">totleft</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span> <span class="n">frame</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ifd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">frame</span><span class="p">];</span>
			<span class="n">numbytes</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ifd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:			<span class="cm">/* success */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EPROTO</span>:		<span class="cm">/* protocol error or unplug */</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EILSEQ</span>:
			<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:
				<span class="cm">/* probably just disconnected, ignore */</span>
				<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span>
					<span class="s">&quot;isoc read: frame %d[%d]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">frame</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span>
					<span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">ifd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>		<span class="cm">/* other error */</span>
				<span class="cm">/* report, assume transferred bytes are ok */</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;isoc read: frame %d[%d]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">frame</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span>
					 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">ifd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">numbytes</span> <span class="o">&gt;</span> <span class="n">BAS_MAXFRAME</span><span class="p">))</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;isoc read: frame %d[%d]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">frame</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span>
					 <span class="s">&quot;exceeds max frame size&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">numbytes</span> <span class="o">&gt;</span> <span class="n">totleft</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;isoc read: frame %d[%d]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">frame</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span>
					 <span class="s">&quot;exceeds total transfer length&quot;</span><span class="p">);</span>
				<span class="n">numbytes</span> <span class="o">=</span> <span class="n">totleft</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">ifd</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">numbytes</span> <span class="o">&gt;</span> <span class="n">BAS_INBUFSIZE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;isoc read: frame %d[%d]: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">frame</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span>
					 <span class="s">&quot;exceeds end of buffer&quot;</span><span class="p">);</span>
				<span class="n">numbytes</span> <span class="o">=</span> <span class="n">BAS_INBUFSIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">gigaset_isoc_receive</span><span class="p">(</span><span class="n">rcvbuf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">numbytes</span><span class="p">,</span> <span class="n">bcs</span><span class="p">);</span>
			<span class="n">totleft</span> <span class="o">-=</span> <span class="n">numbytes</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">totleft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isoc read: %d data bytes missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">totleft</span><span class="p">);</span>

<span class="nl">error:</span>
		<span class="cm">/* URB processed, resubmit */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span> <span class="n">frame</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">frame</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* urb-&gt;dev is clobbered by USB subsystem */</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">BAS_NUMFRAMES</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;could not resubmit isoc read URB: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
			<span class="n">dump_urb</span><span class="p">(</span><span class="n">DEBUG_ISO</span><span class="p">,</span> <span class="s">&quot;resubmit isoc read&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>
			<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Channel Operations */</span>
<span class="cm">/* ================== */</span>

<span class="cm">/* req_timeout</span>
<span class="cm"> * timeout routine for control output request</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">req_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">check_pending</span><span class="p">(</span><span class="n">ucs</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pending</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:					<span class="cm">/* no pending request */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: no request pending&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_OPEN_ATCHANNEL</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout opening AT channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_OPEN_B1CHANNEL</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout opening channel 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_OPEN_B2CHANNEL</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout opening channel 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error_hangup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_CLOSE_ATCHANNEL</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout closing AT channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_CLOSE_B1CHANNEL</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout closing channel 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_CLOSE_B2CHANNEL</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout closing channel 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error_reset</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HD_RESET_INTERRUPT_PIPE</span>:
		<span class="cm">/* error recovery escalation */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;reset interrupt pipe timeout, attempting USB reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">usb_queue_reset_device</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request 0x%02x timed out, clearing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">pending</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write_ctrl_callback</span>
<span class="cm"> * USB completion handler for control pipe output</span>
<span class="cm"> * called by the USB subsystem in interrupt context</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	urb	USB request block of completed request</span>
<span class="cm"> *		urb-&gt;context = hardware specific controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_ctrl_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* check status */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:					<span class="cm">/* normal completion */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HD_DEVICE_INIT_ACK</span>:	<span class="cm">/* no reply expected */</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_ctrl</span><span class="p">);</span>
			<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:			<span class="cm">/* cancelled */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:		<span class="cm">/* cancelled (async) */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:		<span class="cm">/* pending */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:			<span class="cm">/* device removed */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:		<span class="cm">/* device shut down */</span>
		<span class="cm">/* ignore silently */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>				<span class="cm">/* any failure */</span>
		<span class="cm">/* don&#39;t retry if suspend requested */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_ctrl</span> <span class="o">&gt;</span> <span class="n">BAS_RETRY</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_SUSPEND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;control request 0x%02x failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span>
				<span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>		<span class="cm">/* give up */</span>
		<span class="p">}</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;control request 0x%02x: %s, retry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
			   <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_ctrl</span><span class="p">);</span>
		<span class="cm">/* urb-&gt;dev is clobbered by USB subsystem */</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;could not resubmit request 0x%02x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">bRequest</span><span class="p">,</span> <span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* resubmitted */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* failed, clear pending request */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_ctrl</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* req_submit</span>
<span class="cm"> * submit a control output request without message buffer to the Gigaset base</span>
<span class="cm"> * and optionally start a timeout</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	bcs	B channel control structure</span>
<span class="cm"> *	req	control request code (HD_*)</span>
<span class="cm"> *	val	control request parameter value (set to 0 if unused)</span>
<span class="cm"> *	timeout	timeout in seconds (0: no timeout)</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	-EBUSY if another request is pending</span>
<span class="cm"> *	any URB submission error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">req_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;-------&gt; 0x%02x (%d)&quot;</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;submission of request 0x%02x failed: &quot;</span>
			<span class="s">&quot;request 0x%02x still pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">OUT_VENDOR_REQ</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_ctrl</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_ctrl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">write_ctrl_callback</span><span class="p">,</span> <span class="n">ucs</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_ctrl</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not submit request 0x%02x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">req</span><span class="p">,</span> <span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;setting timeout of %d/10 secs&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_ctrl</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_init_bchannel</span>
<span class="cm"> * called by common.c to connect a B channel</span>
<span class="cm"> * initialize isochronous I/O and tell the Gigaset base to open the channel</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	B channel control structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success, error code &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_init_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: not connected&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;not starting isoc I/O, suspend in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">starturbs</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;could not start isoc I/O for channel B%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">?</span> <span class="s">&quot;null URB&quot;</span> <span class="o">:</span> <span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="n">HD_OPEN_B2CHANNEL</span> <span class="o">:</span> <span class="n">HD_OPEN_B1CHANNEL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">req_submit</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not open channel B%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">stopurbs</span><span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">error_hangup</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_close_bchannel</span>
<span class="cm"> * called by common.c to disconnect a B channel</span>
<span class="cm"> * tell the Gigaset base to close the channel</span>
<span class="cm"> * stopping isochronous I/O and LL notification will be done when the</span>
<span class="cm"> * acknowledgement for the close arrives</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	B channel control structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success, error code &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_close_bchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">req</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: not connected&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="n">BS_B2OPEN</span> <span class="o">:</span> <span class="n">BS_B1OPEN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* channel not running: just signal common.c */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">gigaset_bchannel_down</span><span class="p">(</span><span class="n">bcs</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* channel running: tell device to close it */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">?</span> <span class="n">HD_CLOSE_B2CHANNEL</span> <span class="o">:</span> <span class="n">HD_CLOSE_B1CHANNEL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">req_submit</span><span class="p">(</span><span class="n">bcs</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;closing channel B%d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Device Operations */</span>
<span class="cm">/* ================= */</span>

<span class="cm">/* complete_cb</span>
<span class="cm"> * unqueue first command buffer from queue, waking any sleepers</span>
<span class="cm"> * must be called with cs-&gt;cmdlock held</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	cs	controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">complete_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">;</span>

	<span class="cm">/* unqueue completed buffer */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span> <span class="o">-=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;write_command: sent %u bytes, %u left&quot;</span><span class="p">,</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* write_command_callback</span>
<span class="cm"> * USB completion handler for AT command transmission</span>
<span class="cm"> * called by the USB subsystem in interrupt context</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	urb	USB request block of completed request</span>
<span class="cm"> *		urb-&gt;context = controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_command_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_ATWRPEND</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>

	<span class="cm">/* check status */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:					<span class="cm">/* normal completion */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:			<span class="cm">/* cancelled */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:		<span class="cm">/* cancelled (async) */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINPROGRESS</span>:		<span class="cm">/* pending */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:			<span class="cm">/* device removed */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:		<span class="cm">/* device shut down */</span>
		<span class="cm">/* ignore silently */</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="nl">default:</span>				<span class="cm">/* any failure */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_out</span> <span class="o">&gt;</span> <span class="n">BAS_RETRY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;command write: %s, &quot;</span>
				 <span class="s">&quot;giving up after %d retries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
				 <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_out</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;command write: %s, &quot;</span>
				 <span class="s">&quot;won&#39;t retry - suspend requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;command write: %s, &quot;</span>
				 <span class="s">&quot;cannot retry - cmdbuf gone</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;command write: %s, retry %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">get_usb_statmsg</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atwrite_submit</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* resubmitted - bypass regular exit block */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="cm">/* command send failed, assume base still waiting */</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_ATREADY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">complete_cb</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* atrdy_timeout</span>
<span class="cm"> * timeout routine for AT command transmission</span>
<span class="cm"> * argument:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atrdy_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for HD_READY_SEND_ATDATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* fake the missing signal - what else can I do? */</span>
	<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_ATREADY</span><span class="p">,</span> <span class="n">BS_ATTIMER</span><span class="p">);</span>
	<span class="n">start_cbsend</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* atwrite_submit</span>
<span class="cm"> * submit an HD_WRITE_ATMESSAGE command URB</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	cs	controller state structure</span>
<span class="cm"> *	buf	buffer containing command to send</span>
<span class="cm"> *	len	length of command to send</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	-EBUSY if another request is pending</span>
<span class="cm"> *	any URB submission error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atwrite_submit</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;-------&gt; HD_WRITE_ATMESSAGE (%d)&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_ATWRPEND</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BS_ATWRPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;could not submit HD_WRITE_ATMESSAGE: URB busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_out</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">OUT_VENDOR_REQ</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_out</span><span class="p">.</span><span class="n">bRequest</span> <span class="o">=</span> <span class="n">HD_WRITE_ATMESSAGE</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_out</span><span class="p">.</span><span class="n">wValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_out</span><span class="p">.</span><span class="n">wIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_out</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_out</span><span class="p">,</span> <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">dr_cmd_out</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			     <span class="n">write_command_callback</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_out</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_ATWRPEND</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not submit HD_WRITE_ATMESSAGE: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* submitted successfully, start timeout if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_ATTIMER</span><span class="p">,</span> <span class="n">BS_ATREADY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BS_ATTIMER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;setting ATREADY timeout of %d/10 secs&quot;</span><span class="p">,</span>
			<span class="n">ATRDY_TIMEOUT</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_atrdy</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ATRDY_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* start_cbsend</span>
<span class="cm"> * start transmission of AT command queue if necessary</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	cs		controller state structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success</span>
<span class="cm"> *	error code &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_cbsend</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check if suspend requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;suspending&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EHOSTUNREACH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if AT channel is open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATOPEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_OUTPUT</span><span class="p">,</span> <span class="s">&quot;AT channel not open&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">req_submit</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="n">HD_OPEN_ATCHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* flush command queue */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">complete_cb</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* try to send first command in queue */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cb</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATREADY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_cmd_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">atwrite_submit</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
			<span class="n">complete_cb</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_write_cmd</span>
<span class="cm"> * This function is called by the device independent part of the driver</span>
<span class="cm"> * to transmit an AT command string to the Gigaset device.</span>
<span class="cm"> * It encapsulates the device specific method for transmission over the</span>
<span class="cm"> * direct USB connection to the base.</span>
<span class="cm"> * The command string is added to the queue of commands to send, and</span>
<span class="cm"> * USB transmission is started if necessary.</span>
<span class="cm"> * parameters:</span>
<span class="cm"> *	cs		controller state structure</span>
<span class="cm"> *	cb		command buffer structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of bytes queued on success</span>
<span class="cm"> *	error code &lt; 0 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_write_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmdbuf_t</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">gigaset_dbg_buffer</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">!=</span> <span class="n">MS_LOCKED</span> <span class="o">?</span>
			   <span class="n">DEBUG_TRANSCMD</span> <span class="o">:</span> <span class="n">DEBUG_LOCKCMD</span><span class="p">,</span>
			   <span class="s">&quot;CMD Transmit&quot;</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

	<span class="cm">/* translate &quot;+++&quot; escape sequence sent as a single separate command</span>
<span class="cm">	 * into &quot;close AT channel&quot; command for error recovery</span>
<span class="cm">	 * The next command will reopen the AT channel automatically.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;+++&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If an HD_RECEIVEATDATA_ACK message remains unhandled</span>
<span class="cm">		 * because of an error, the base never sends another one.</span>
<span class="cm">		 * The response channel is thus effectively blocked.</span>
<span class="cm">		 * Closing and reopening the AT channel does *not* clear</span>
<span class="cm">		 * this condition.</span>
<span class="cm">		 * As a stopgap measure, submit a zero-length AT read</span>
<span class="cm">		 * before closing the AT channel. This has the undocumented</span>
<span class="cm">		 * effect of triggering a new HD_RECEIVEATDATA_ACK message</span>
<span class="cm">		 * from the base if necessary.</span>
<span class="cm">		 * The subsequent AT channel close then discards any pending</span>
<span class="cm">		 * messages.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATRDPEND</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">retry_cmd_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">atread_submit</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">req_submit</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="n">HD_CLOSE_ATCHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">wake_tasklet</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">curlen</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span> <span class="o">+=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">lastcmdbuf</span> <span class="o">=</span> <span class="n">cb</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_USBREQ</span><span class="p">,</span> <span class="s">&quot;%s: not connected&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* flush command queue */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">complete_cb</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">start_cbsend</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_write_room</span>
<span class="cm"> * tty_driver.write_room interface routine</span>
<span class="cm"> * return number of characters the driver will accept to be written via</span>
<span class="cm"> * gigaset_write_cmd</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of characters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_write_room</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">IF_WRITEBUF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_chars_in_buffer</span>
<span class="cm"> * tty_driver.chars_in_buffer interface routine</span>
<span class="cm"> * return number of characters waiting to be sent</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	number of characters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_chars_in_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">cmdbytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_brkchars</span>
<span class="cm"> * implementation of ioctl(GIGASET_BRKCHARS)</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	controller state structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	-EINVAL (unimplemented function)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_brkchars</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Device Initialization/Shutdown */</span>
<span class="cm">/* ============================== */</span>

<span class="cm">/* Free hardware dependent part of the B channel structure</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	bcs	B channel structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_freebcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ubc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* kill URBs and tasklets before freeing - better safe than sorry */</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;%s: killing isoc URBs&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_OUTURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_INURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">sent_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">rcvd_tasklet</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ubc</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize hardware dependent part of the B channel structure</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	bcs	B channel structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success, error code &lt; 0 on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_initbcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span><span class="p">;</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span> <span class="o">=</span> <span class="n">ubc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bas_bc_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ubc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">corrbytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_OUTURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bcs</span> <span class="o">=</span> <span class="n">bcs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutdone</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutfree</span> <span class="o">=</span> <span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutovfl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">numsub</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">isowbuf_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ubc</span><span class="p">);</span>
		<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">sent_tasklet</span><span class="p">,</span>
		     <span class="n">write_iso_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bcs</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_INURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoindone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">loststatus</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">seqlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">inbyte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">inbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">goodbytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">alignerrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">fcserrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">frameerrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">giants</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">runts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">aborts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">shared0s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">stolen0s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">rcvd_tasklet</span><span class="p">,</span>
		     <span class="n">read_iso_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bcs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_reinitbcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bc_state</span> <span class="o">*</span><span class="n">bcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span> <span class="o">=</span> <span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>

	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">corrbytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bcs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">numsub</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isooutlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinlock</span><span class="p">);</span>
	<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">loststatus</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_freecshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* timers, URBs and rcvbuf are disposed of in disconnect */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize hardware dependent part of the cardstate structure</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	cs	cardstate structure</span>
<span class="cm"> * return value:</span>
<span class="cm"> *	0 on success, error code &lt; 0 on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_initcshw</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span> <span class="o">=</span> <span class="n">ucs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">ucs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">IP_MSGSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_ctrl</span><span class="p">,</span> <span class="n">req_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_atrdy</span><span class="p">,</span> <span class="n">atrdy_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_cmd_in</span><span class="p">,</span> <span class="n">cmd_in_timeout</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_int_in</span><span class="p">,</span> <span class="n">int_in_resubmit</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">cs</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_wq</span><span class="p">,</span> <span class="n">int_in_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* freeurbs</span>
<span class="cm"> * unlink and deallocate all URBs unconditionally</span>
<span class="cm"> * caller must make sure that no commands are still in progress</span>
<span class="cm"> * parameter:</span>
<span class="cm"> *	cs	controller state structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">freeurbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;%s: killing URBs&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BAS_CHANNELS</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ubc</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_OUTURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
			<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_INURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_out</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_out</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_in</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_in</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_ctrl</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_ctrl</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_probe</span>
<span class="cm"> * This function is called when a new USB device is connected.</span>
<span class="cm"> * It checks whether the new device is handled by this driver.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">hostif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_bc_state</span> <span class="o">*</span><span class="n">ubc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span>
		<span class="s">&quot;%s: Check if device matches .. (Vendor: 0x%x, Product: 0x%x)&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="cm">/* set required alternate setting */</span>
	<span class="n">hostif</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span>
			<span class="s">&quot;%s: wrong alternate setting %d - trying to switch&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usb_set_interface</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
		    <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb_set_interface failed, &quot;</span>
				 <span class="s">&quot;device %d interface %d altsetting %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
				 <span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bAlternateSetting</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hostif</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reject application specific interfaces</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: bInterfaceClass == %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">hostif</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceClass</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;%s: Device matched (Vendor: 0x%x, Product: 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="cm">/* allocate memory for our device state and initialize it */</span>
	<span class="n">cs</span> <span class="o">=</span> <span class="n">gigaset_initcs</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">BAS_CHANNELS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cidmode</span><span class="p">,</span>
			    <span class="n">GIGASET_MODULENAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>

	<span class="cm">/* save off device structure ptrs for later use */</span>
	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* allocate URBs:</span>
<span class="cm">	 * - one for the interrupt pipe</span>
<span class="cm">	 * - three for the different uses of the default control pipe</span>
<span class="cm">	 * - three for each isochronous pipe</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_in</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_cmd_out</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_ctrl</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">allocerr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BAS_CHANNELS</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ubc</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_OUTURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoouturbs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">urb</span> <span class="o">=</span>
			      <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">BAS_NUMFRAMES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">allocerr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BAS_INURBS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ubc</span><span class="o">-&gt;</span><span class="n">isoinurbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			      <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">BAS_NUMFRAMES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
				<span class="k">goto</span> <span class="n">allocerr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Fill the interrupt urb and send it to the core */</span>
	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostif</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">,</span> <span class="n">udev</span><span class="p">,</span>
			 <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span>
					<span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">),</span>
			 <span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_buf</span><span class="p">,</span> <span class="n">IP_MSGSIZE</span><span class="p">,</span> <span class="n">read_int_callback</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span>
			 <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bInterval</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not submit interrupt URB: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_int_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* tell the device that the driver is ready */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">req_submit</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="n">HD_DEVICE_INIT_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* tell common part that the device is ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">startmode</span> <span class="o">==</span> <span class="n">SM_LOCKED</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">mstate</span> <span class="o">=</span> <span class="n">MS_LOCKED</span><span class="p">;</span>

	<span class="cm">/* save address of controller structure */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">gigaset_start</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">allocerr:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate URBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">freeurbs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">gigaset_freecs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_disconnect</span>
<span class="cm"> * This function is called when the Gigaset base is unplugged.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">gigaset_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">cs</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnecting Gigaset base</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* mark base as not ready, all channels disconnected */</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* tell LL all channels are down */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BAS_CHANNELS</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
		<span class="n">gigaset_bchannel_down</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>

	<span class="cm">/* stop driver (common part) */</span>
	<span class="n">gigaset_stop</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>

	<span class="cm">/* stop delayed work and URBs, free ressources */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_ctrl</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_atrdy</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_cmd_in</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_int_in</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_wq</span><span class="p">);</span>
	<span class="n">freeurbs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">rcvbuf_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">gigaset_freecs</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* gigaset_suspend</span>
<span class="cm"> * This function is called before the USB connection is suspended.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* set suspend flag; this stops AT command/response traffic */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="n">BS_SUSPEND</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BS_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;already suspended&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait a bit for blocking conditions to go away */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">,</span>
				<span class="o">!</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span>
				  <span class="p">(</span><span class="n">BS_B1OPEN</span> <span class="o">|</span> <span class="n">BS_B2OPEN</span> <span class="o">|</span> <span class="n">BS_ATRDPEND</span> <span class="o">|</span> <span class="n">BS_ATWRPEND</span><span class="p">)),</span>
				<span class="n">BAS_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;wait_event_timeout() -&gt; %d&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* check for conditions preventing suspend */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BS_B1OPEN</span> <span class="o">|</span> <span class="n">BS_B2OPEN</span> <span class="o">|</span> <span class="n">BS_ATRDPEND</span> <span class="o">|</span> <span class="n">BS_ATWRPEND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot suspend:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B1OPEN</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; B channel 1 open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B2OPEN</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; B channel 2 open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATRDPEND</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; receiving AT reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATWRPEND</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; sending AT command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_SUSPEND</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* close AT channel if open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATOPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;closing AT channel&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">req_submit</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">bcs</span><span class="p">,</span> <span class="n">HD_CLOSE_ATCHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_SUSPEND</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">waitqueue</span><span class="p">,</span> <span class="o">!</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span>
				   <span class="n">BAS_TIMEOUT</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
		<span class="cm">/* in case of timeout, proceed anyway */</span>
	<span class="p">}</span>

	<span class="cm">/* kill all URBs and delayed work that might still be pending */</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_ctrl</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_ctrl</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_atrdy</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_cmd_in</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">timer_int_in</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">int_in_wq</span><span class="p">);</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;suspend complete&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_resume</span>
<span class="cm"> * This function is called after the USB connection has been resumed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cardstate</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* resubmit interrupt URB for spontaneous messages from base */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">urb_int_in</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not resubmit interrupt URB: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">get_usb_rcmsg</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">retry_int_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear suspend flag to reallow activity */</span>
	<span class="n">update_basstate</span><span class="p">(</span><span class="n">ucs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BS_SUSPEND</span><span class="p">);</span>

	<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_SUSPEND</span><span class="p">,</span> <span class="s">&quot;resume complete&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* gigaset_pre_reset</span>
<span class="cm"> * This function is called before the USB connection is reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* handle just like suspend */</span>
	<span class="k">return</span> <span class="n">gigaset_suspend</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">PMSG_ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* gigaset_post_reset</span>
<span class="cm"> * This function is called after the USB connection has been reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">gigaset_post_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: send HD_DEVICE_INIT_ACK? */</span>

	<span class="cm">/* resume operations */</span>
	<span class="k">return</span> <span class="n">gigaset_resume</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">gigaset_ops</span> <span class="n">gigops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">gigaset_write_cmd</span><span class="p">,</span>
	<span class="n">gigaset_write_room</span><span class="p">,</span>
	<span class="n">gigaset_chars_in_buffer</span><span class="p">,</span>
	<span class="n">gigaset_brkchars</span><span class="p">,</span>
	<span class="n">gigaset_init_bchannel</span><span class="p">,</span>
	<span class="n">gigaset_close_bchannel</span><span class="p">,</span>
	<span class="n">gigaset_initbcshw</span><span class="p">,</span>
	<span class="n">gigaset_freebcshw</span><span class="p">,</span>
	<span class="n">gigaset_reinitbcshw</span><span class="p">,</span>
	<span class="n">gigaset_initcshw</span><span class="p">,</span>
	<span class="n">gigaset_freecshw</span><span class="p">,</span>
	<span class="n">gigaset_set_modem_ctrl</span><span class="p">,</span>
	<span class="n">gigaset_baud_rate</span><span class="p">,</span>
	<span class="n">gigaset_set_line_ctrl</span><span class="p">,</span>
	<span class="n">gigaset_isoc_send_skb</span><span class="p">,</span>
	<span class="n">gigaset_isoc_input</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* bas_gigaset_init</span>
<span class="cm"> * This function is called after the kernel module is loaded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bas_gigaset_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* allocate memory for our driver state and initialize it */</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="n">gigaset_initdriver</span><span class="p">(</span><span class="n">GIGASET_MINOR</span><span class="p">,</span> <span class="n">GIGASET_MINORS</span><span class="p">,</span>
				    <span class="n">GIGASET_MODULENAME</span><span class="p">,</span> <span class="n">GIGASET_DEVNAME</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">gigops</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* register this driver with the USB subsystem */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gigaset_usb_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error %d registering USB driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRIVER_DESC</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">gigaset_freedriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* bas_gigaset_exit</span>
<span class="cm"> * This function is called before the kernel module is unloaded.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">bas_gigaset_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bas_cardstate</span> <span class="o">*</span><span class="n">ucs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gigaset_blockdriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span> <span class="cm">/* =&gt; probe will fail</span>
<span class="cm">				      * =&gt; no gigaset_start any more</span>
<span class="cm">				      */</span>

	<span class="cm">/* stop all connected devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">minors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gigaset_shutdown</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">cs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>		<span class="cm">/* no device */</span>
		<span class="cm">/* from now on, no isdn callback should be possible */</span>

		<span class="cm">/* close all still open channels */</span>
		<span class="n">ucs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw</span><span class="p">.</span><span class="n">bas</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B1OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;closing B1 channel&quot;</span><span class="p">);</span>
			<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">HD_CLOSE_B1CHANNEL</span><span class="p">,</span> <span class="n">OUT_VENDOR_REQ</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_B2OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;closing B2 channel&quot;</span><span class="p">);</span>
			<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">HD_CLOSE_B2CHANNEL</span><span class="p">,</span> <span class="n">OUT_VENDOR_REQ</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">&amp;</span> <span class="n">BS_ATOPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gig_dbg</span><span class="p">(</span><span class="n">DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;closing AT channel&quot;</span><span class="p">);</span>
			<span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ucs</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">HD_CLOSE_ATCHANNEL</span><span class="p">,</span> <span class="n">OUT_VENDOR_REQ</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAS_TIMEOUT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ucs</span><span class="o">-&gt;</span><span class="n">basstate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* deregister this driver with the USB subsystem */</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gigaset_usb_driver</span><span class="p">);</span>
	<span class="cm">/* this will call the disconnect-callback */</span>
	<span class="cm">/* from now on, no disconnect/probe callback should be running */</span>

	<span class="n">gigaset_freedriver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">bas_gigaset_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">bas_gigaset_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
