<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › pata_at32.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pata_at32.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * AVR32 SMC/CFC PATA Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 Atmel Norway</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#define DEBUG</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;linux/ata.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>

<span class="cp">#include &lt;mach/board.h&gt;</span>
<span class="cp">#include &lt;mach/smc.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;pata_at32&quot;</span>
<span class="cp">#define DRV_VERSION &quot;0.0.3&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * CompactFlash controller memory layout relative to the base address:</span>
<span class="cm"> *</span>
<span class="cm"> *	Attribute memory:  0000 0000 -&gt; 003f ffff</span>
<span class="cm"> *	Common memory:	   0040 0000 -&gt; 007f ffff</span>
<span class="cm"> *	I/O memory:	   0080 0000 -&gt; 00bf ffff</span>
<span class="cm"> *	True IDE Mode:	   00c0 0000 -&gt; 00df ffff</span>
<span class="cm"> *	Alt IDE Mode:	   00e0 0000 -&gt; 00ff ffff</span>
<span class="cm"> *</span>
<span class="cm"> * Only True IDE and Alt True IDE mode are needed for this driver.</span>
<span class="cm"> *</span>
<span class="cm"> *	True IDE mode	  =&gt; CS0 = 0, CS1 = 1 (cmd, error, stat, etc)</span>
<span class="cm"> *	Alt True IDE mode =&gt; CS0 = 1, CS1 = 0 (ctl, alt_stat)</span>
<span class="cm"> */</span>
<span class="cp">#define CF_IDE_OFFSET	  0x00c00000</span>
<span class="cp">#define CF_ALT_IDE_OFFSET 0x00e00000</span>
<span class="cp">#define CF_RES_SIZE	  2048</span>

<span class="cm">/*</span>
<span class="cm"> * Define DEBUG_BUS if you are doing debugging of your own EBI -&gt; PATA</span>
<span class="cm"> * adaptor with a logic analyzer or similar.</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG_BUS</span>

<span class="cm">/*</span>
<span class="cm"> * ATA PIO modes</span>
<span class="cm"> *</span>
<span class="cm"> *	Name	| Mb/s	| Min cycle time | Mask</span>
<span class="cm"> *	--------+-------+----------------+--------</span>
<span class="cm"> *	Mode 0	| 3.3	| 600 ns	 | 0x01</span>
<span class="cm"> *	Mode 1	| 5.2	| 383 ns	 | 0x03</span>
<span class="cm"> *	Mode 2	| 8.3	| 240 ns	 | 0x07</span>
<span class="cm"> *	Mode 3	| 11.1	| 180 ns	 | 0x0f</span>
<span class="cm"> *	Mode 4	| 16.7	| 120 ns	 | 0x1f</span>
<span class="cm"> *</span>
<span class="cm"> * Alter PIO_MASK below according to table to set maximal PIO mode.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="n">PIO_MASK</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Struct containing private information about device.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">at32_ide_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">res_ide</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">res_alt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">ide_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">alt_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smc_config</span>	<span class="n">smc</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Setup SMC for the given ATA timing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pata_at32_setup_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">at32_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_timing</span> <span class="o">*</span><span class="n">ata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smc_config</span> <span class="o">*</span><span class="n">smc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smc_timing</span> <span class="n">timing</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recover</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timing</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smc_timing</span><span class="p">));</span>

	<span class="cm">/* Total cycle time */</span>
	<span class="n">timing</span><span class="p">.</span><span class="n">read_cycle</span>  <span class="o">=</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">cyc8b</span><span class="p">;</span>

	<span class="cm">/* DIOR &lt;= CFIOR timings */</span>
	<span class="n">timing</span><span class="p">.</span><span class="n">nrd_setup</span>   <span class="o">=</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">;</span>
	<span class="n">timing</span><span class="p">.</span><span class="n">nrd_pulse</span>   <span class="o">=</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">act8b</span><span class="p">;</span>
	<span class="n">timing</span><span class="p">.</span><span class="n">nrd_recover</span> <span class="o">=</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">rec8b</span><span class="p">;</span>

	<span class="cm">/* Convert nanosecond timing to clock cycles */</span>
	<span class="n">smc_set_timing</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">);</span>

	<span class="cm">/* Add one extra cycle setup due to signal ring */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_setup</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_setup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">active</span>  <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_setup</span> <span class="o">+</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_pulse</span><span class="p">;</span>
	<span class="n">recover</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">read_cycle</span> <span class="o">-</span> <span class="n">active</span><span class="p">;</span>

	<span class="cm">/* Need at least two cycles recovery */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recover</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
	  <span class="n">smc</span><span class="o">-&gt;</span><span class="n">read_cycle</span> <span class="o">=</span> <span class="n">active</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* (CS0, CS1, DIR, OE) &lt;= (CFCE1, CFCE2, CFRNW, NCSX) timings */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_read_setup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_read_pulse</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">read_cycle</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Write timings same as read timings */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">write_cycle</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">read_cycle</span><span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">nwe_setup</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_setup</span><span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">nwe_pulse</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_pulse</span><span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_write_setup</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_read_setup</span><span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_write_pulse</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_read_pulse</span><span class="p">;</span>

	<span class="cm">/* Do some debugging output of ATA and SMC timings */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ATA: C=%d S=%d P=%d R=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ata</span><span class="o">-&gt;</span><span class="n">cyc8b</span><span class="p">,</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">,</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">act8b</span><span class="p">,</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">rec8b</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SMC: C=%d S=%d P=%d NS=%d NP=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">read_cycle</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_setup</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">nrd_pulse</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_read_setup</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">ncs_read_pulse</span><span class="p">);</span>

	<span class="cm">/* Finally, configure the SMC */</span>
	<span class="k">return</span> <span class="n">smc_set_configuration</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">,</span> <span class="n">smc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Procedures for libATA.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_at32_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_timing</span> <span class="n">timing</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at32_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Compute ATA timing */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to compute ATA timing %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup SMC to ATA timing */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pata_at32_setup_timing</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to setup ATA timing %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">at32_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_PIO_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">at32_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_sff_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">ata_cable_40wire</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>		<span class="o">=</span> <span class="n">pata_at32_set_piomode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pata_at32_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">at32_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">ata_host_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Setup ATA bindings */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span>	     <span class="o">=</span> <span class="o">&amp;</span><span class="n">at32_port_ops</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">PIO_MASK</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span>   <span class="o">|=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since all 8-bit taskfile transfers has to go on the lower</span>
<span class="cm">	 * byte of the data bus and there is a bug in the SMC that</span>
<span class="cm">	 * makes it impossible to alter the bus width during runtime,</span>
<span class="cm">	 * we need to hardwire the address signals as follows:</span>
<span class="cm">	 *</span>
<span class="cm">	 *	A_IDE(2:0) &lt;= A_EBI(3:1)</span>
<span class="cm">	 *</span>
<span class="cm">	 * This makes all addresses on the EBI even, thus all data</span>
<span class="cm">	 * will be on the lower byte of the data bus.  All addresses</span>
<span class="cm">	 * used by libATA need to be altered according to this.</span>
<span class="cm">	 */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">alt_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x06</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">alt_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x06</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_DATA</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">error_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_ERR</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">feature_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_FEATURE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">nsect_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_NSECT</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbal_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAL</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbam_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAM</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbah_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAH</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">device_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_DEVICE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">status_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_STATUS</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">command_addr</span>	  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_CMD</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Set info as private data of ATA host */</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="cm">/* Register ATA device and return */</span>
	<span class="k">return</span> <span class="n">ata_host_activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ata_sff_interrupt</span><span class="p">,</span>
				 <span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_TRIGGER_RISING</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">at32_sht</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function may come in handy for people analyzing their own</span>
<span class="cm"> * EBI -&gt; PATA adaptors.</span>
<span class="cm"> */</span>
<span class="cp">#ifdef DEBUG_BUS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">pata_at32_debug_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">at32_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">d1</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">d2</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Write 8-bit values (registers) */</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">alt_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x06</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">alt_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x06</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Write 16 bit values (data) */</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span>	   <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">);</span>

	<span class="n">iowrite16</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span>	   <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">d1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pata_at32_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_timing</span> <span class="n">initial_timing</span> <span class="o">=</span>
		<span class="p">{</span><span class="n">XFER_PIO_0</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">struct</span> <span class="n">device</span>		 <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at32_ide_info</span>	 <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ide_platform_data</span> <span class="o">*</span><span class="n">board</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		 <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">board</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* Retrive IRQ */</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Setup struct containing private information */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at32_ide_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cs</span>  <span class="o">=</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">cs</span><span class="p">;</span>

	<span class="cm">/* Request memory resources */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">CF_IDE_OFFSET</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">CF_RES_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;ide&quot;</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_req_res_ide</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">CF_ALT_IDE_OFFSET</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">.</span><span class="n">end</span>   <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">CF_RES_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;alt&quot;</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_req_res_alt</span><span class="p">;</span>

	<span class="cm">/* Setup non-timing elements of SMC */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">.</span><span class="n">bus_width</span>	 <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 16 bit data bus */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">.</span><span class="n">nrd_controlled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Sample data on rising edge of NRD */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">.</span><span class="n">nwe_controlled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Drive data on falling edge of NCS */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">.</span><span class="n">nwait_mode</span>	 <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* NWAIT is in READY mode */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">.</span><span class="n">byte_write</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Byte select access type */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">.</span><span class="n">tdf_mode</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* TDF optimization disabled */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smc</span><span class="p">.</span><span class="n">tdf_cycles</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No TDF wait cycles */</span>

	<span class="cm">/* Setup SMC to ATA timing */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pata_at32_setup_timing</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">initial_timing</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_setup_timing</span><span class="p">;</span>

	<span class="cm">/* Map ATA address space */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">alt_addr</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">alt_addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ioremap</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_BUS</span>
	<span class="n">pata_at32_debug_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Setup and register ATA device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pata_at32_init_one</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ata_device</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_ata_device:</span>
 <span class="nl">err_ioremap:</span>
 <span class="nl">err_setup_timing:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">);</span>
 <span class="nl">err_req_res_alt:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">);</span>
 <span class="nl">err_req_res_ide:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">pata_at32_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">at32_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ata_host_detach</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_ide</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">res_alt</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* work with hotplug and coldplug */</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:at32_ide&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">pata_at32_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>	       <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">pata_at32_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>	       <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;at32_ide&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pata_at32_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pata_at32_driver</span><span class="p">,</span> <span class="n">pata_at32_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pata_at32_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pata_at32_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pata_at32_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pata_at32_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AVR32 SMC/CFC PATA Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kristoffer Nyborg Gregertsen &lt;kngregertsen@norway.atmel.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
