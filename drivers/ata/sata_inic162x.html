<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › sata_inic162x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sata_inic162x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sata_inic162x.c - Driver for Initio 162x SATA controllers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006  SUSE Linux Products GmbH</span>
<span class="cm"> * Copyright 2006  Tejun Heo &lt;teheo@novell.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under GPL v2.</span>
<span class="cm"> *</span>
<span class="cm"> * This controller is eccentric and easily locks up if something isn&#39;t</span>
<span class="cm"> * right.  Documentation is available at initio&#39;s website but it only</span>
<span class="cm"> * documents registers (not programming model).</span>
<span class="cm"> *</span>
<span class="cm"> * This driver has interesting history.  The first version was written</span>
<span class="cm"> * from the documentation and a 2.4 IDE driver posted on a Taiwan</span>
<span class="cm"> * company, which didn&#39;t use any IDMA features and couldn&#39;t handle</span>
<span class="cm"> * LBA48.  The resulting driver couldn&#39;t handle LBA48 devices either</span>
<span class="cm"> * making it pretty useless.</span>
<span class="cm"> *</span>
<span class="cm"> * After a while, initio picked the driver up, renamed it to</span>
<span class="cm"> * sata_initio162x, updated it to use IDMA for ATA DMA commands and</span>
<span class="cm"> * posted it on their website.  It only used ATA_PROT_DMA for IDMA and</span>
<span class="cm"> * attaching both devices and issuing IDMA and !IDMA commands</span>
<span class="cm"> * simultaneously broke it due to PIRQ masking interaction but it did</span>
<span class="cm"> * show how to use the IDMA (ADMA + some initio specific twists)</span>
<span class="cm"> * engine.</span>
<span class="cm"> *</span>
<span class="cm"> * Then, I picked up their changes again and here&#39;s the usable driver</span>
<span class="cm"> * which uses IDMA for everything.  Everything works now including</span>
<span class="cm"> * LBA48, CD/DVD burning, suspend/resume and hotplug.  There are some</span>
<span class="cm"> * issues tho.  Result Tf is not resported properly, NCQ isn&#39;t</span>
<span class="cm"> * supported yet and CD/DVD writing works with DMA assisted PIO</span>
<span class="cm"> * protocol (which, for native SATA devices, shouldn&#39;t cause any</span>
<span class="cm"> * noticeable difference).</span>
<span class="cm"> *</span>
<span class="cm"> * Anyways, so, here&#39;s finally a working driver for inic162x.  Enjoy!</span>
<span class="cm"> *</span>
<span class="cm"> * initio: If you guys wanna improve the driver regarding result TF</span>
<span class="cm"> * access and other stuff, please feel free to contact me.  I&#39;ll be</span>
<span class="cm"> * happy to assist.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>

<span class="cp">#define DRV_NAME	&quot;sata_inic162x&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;0.4&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MMIO_BAR_PCI</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">MMIO_BAR_CARDBUS</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="n">NR_PORTS</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

	<span class="n">IDMA_CPB_TBL_SIZE</span>	<span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">32</span><span class="p">,</span>

	<span class="n">INIC_DMA_BOUNDARY</span>	<span class="o">=</span> <span class="mh">0xffffff</span><span class="p">,</span>

	<span class="n">HOST_ACTRL</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">HOST_CTL</span>		<span class="o">=</span> <span class="mh">0x7c</span><span class="p">,</span>
	<span class="n">HOST_STAT</span>		<span class="o">=</span> <span class="mh">0x7e</span><span class="p">,</span>
	<span class="n">HOST_IRQ_STAT</span>		<span class="o">=</span> <span class="mh">0xbc</span><span class="p">,</span>
	<span class="n">HOST_IRQ_MASK</span>		<span class="o">=</span> <span class="mh">0xbe</span><span class="p">,</span>

	<span class="n">PORT_SIZE</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>

	<span class="cm">/* registers for ATA TF operation */</span>
	<span class="n">PORT_TF_DATA</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">PORT_TF_FEATURE</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">PORT_TF_NSECT</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">PORT_TF_LBAL</span>		<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">PORT_TF_LBAM</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">PORT_TF_LBAH</span>		<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">PORT_TF_DEVICE</span>		<span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="n">PORT_TF_COMMAND</span>		<span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="n">PORT_TF_ALT_STAT</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">PORT_IRQ_STAT</span>		<span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="n">PORT_IRQ_MASK</span>		<span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
	<span class="n">PORT_PRD_CTL</span>		<span class="o">=</span> <span class="mh">0x0b</span><span class="p">,</span>
	<span class="n">PORT_PRD_ADDR</span>		<span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="n">PORT_PRD_XFERLEN</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">PORT_CPB_CPBLAR</span>		<span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
	<span class="n">PORT_CPB_PTQFIFO</span>	<span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="cm">/* IDMA register */</span>
	<span class="n">PORT_IDMA_CTL</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>
	<span class="n">PORT_IDMA_STAT</span>		<span class="o">=</span> <span class="mh">0x16</span><span class="p">,</span>

	<span class="n">PORT_RPQ_FIFO</span>		<span class="o">=</span> <span class="mh">0x1e</span><span class="p">,</span>
	<span class="n">PORT_RPQ_CNT</span>		<span class="o">=</span> <span class="mh">0x1f</span><span class="p">,</span>

	<span class="n">PORT_SCR</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>

	<span class="cm">/* HOST_CTL bits */</span>
	<span class="n">HCTL_LEDEN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>  <span class="cm">/* enable LED operation */</span>
	<span class="n">HCTL_IRQOFF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>  <span class="cm">/* global IRQ off */</span>
	<span class="n">HCTL_FTHD0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="cm">/* fifo threshold 0 */</span>
	<span class="n">HCTL_FTHD1</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span> <span class="cm">/* fifo threshold 1*/</span>
	<span class="n">HCTL_PWRDWN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span> <span class="cm">/* power down PHYs */</span>
	<span class="n">HCTL_SOFTRST</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span> <span class="cm">/* global reset (no phy reset) */</span>
	<span class="n">HCTL_RPGSEL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span> <span class="cm">/* register page select */</span>

	<span class="n">HCTL_KNOWN_BITS</span>		<span class="o">=</span> <span class="n">HCTL_IRQOFF</span> <span class="o">|</span> <span class="n">HCTL_PWRDWN</span> <span class="o">|</span> <span class="n">HCTL_SOFTRST</span> <span class="o">|</span>
				  <span class="n">HCTL_RPGSEL</span><span class="p">,</span>

	<span class="cm">/* HOST_IRQ_(STAT|MASK) bits */</span>
	<span class="n">HIRQ_PORT0</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HIRQ_PORT1</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HIRQ_SOFT</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span>
	<span class="n">HIRQ_GLOBAL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span> <span class="cm">/* STAT only */</span>

	<span class="cm">/* PORT_IRQ_(STAT|MASK) bits */</span>
	<span class="n">PIRQ_OFFLINE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>  <span class="cm">/* device unplugged */</span>
	<span class="n">PIRQ_ONLINE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>  <span class="cm">/* device plugged */</span>
	<span class="n">PIRQ_COMPLETE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>  <span class="cm">/* completion interrupt */</span>
	<span class="n">PIRQ_FATAL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>  <span class="cm">/* fatal error */</span>
	<span class="n">PIRQ_ATA</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>  <span class="cm">/* ATA interrupt */</span>
	<span class="n">PIRQ_REPLY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>  <span class="cm">/* reply FIFO not empty */</span>
	<span class="n">PIRQ_PENDING</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>  <span class="cm">/* port IRQ pending (STAT only) */</span>

	<span class="n">PIRQ_ERR</span>		<span class="o">=</span> <span class="n">PIRQ_OFFLINE</span> <span class="o">|</span> <span class="n">PIRQ_ONLINE</span> <span class="o">|</span> <span class="n">PIRQ_FATAL</span><span class="p">,</span>
	<span class="n">PIRQ_MASK_DEFAULT</span>	<span class="o">=</span> <span class="n">PIRQ_REPLY</span> <span class="o">|</span> <span class="n">PIRQ_ATA</span><span class="p">,</span>
	<span class="n">PIRQ_MASK_FREEZE</span>	<span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>

	<span class="cm">/* PORT_PRD_CTL bits */</span>
	<span class="n">PRD_CTL_START</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">PRD_CTL_WR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">PRD_CTL_DMAEN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>  <span class="cm">/* DMA enable */</span>

	<span class="cm">/* PORT_IDMA_CTL bits */</span>
	<span class="n">IDMA_CTL_RST_ATA</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>  <span class="cm">/* hardreset ATA bus */</span>
	<span class="n">IDMA_CTL_RST_IDMA</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>  <span class="cm">/* reset IDMA machinary */</span>
	<span class="n">IDMA_CTL_GO</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>  <span class="cm">/* IDMA mode go */</span>
	<span class="n">IDMA_CTL_ATA_NIEN</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>  <span class="cm">/* ATA IRQ disable */</span>

	<span class="cm">/* PORT_IDMA_STAT bits */</span>
	<span class="n">IDMA_STAT_PERR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>  <span class="cm">/* PCI ERROR MODE */</span>
	<span class="n">IDMA_STAT_CPBERR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>  <span class="cm">/* ADMA CPB error */</span>
	<span class="n">IDMA_STAT_LGCY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>  <span class="cm">/* ADMA legacy */</span>
	<span class="n">IDMA_STAT_UIRQ</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>  <span class="cm">/* ADMA unsolicited irq */</span>
	<span class="n">IDMA_STAT_STPD</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>  <span class="cm">/* ADMA stopped */</span>
	<span class="n">IDMA_STAT_PSD</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>  <span class="cm">/* ADMA pause */</span>
	<span class="n">IDMA_STAT_DONE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>  <span class="cm">/* ADMA done */</span>

	<span class="n">IDMA_STAT_ERR</span>		<span class="o">=</span> <span class="n">IDMA_STAT_PERR</span> <span class="o">|</span> <span class="n">IDMA_STAT_CPBERR</span><span class="p">,</span>

	<span class="cm">/* CPB Control Flags*/</span>
	<span class="n">CPB_CTL_VALID</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>  <span class="cm">/* CPB valid */</span>
	<span class="n">CPB_CTL_QUEUED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>  <span class="cm">/* queued command */</span>
	<span class="n">CPB_CTL_DATA</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>  <span class="cm">/* data, rsvd in datasheet */</span>
	<span class="n">CPB_CTL_IEN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>  <span class="cm">/* PCI interrupt enable */</span>
	<span class="n">CPB_CTL_DEVDIR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>  <span class="cm">/* device direction control */</span>

	<span class="cm">/* CPB Response Flags */</span>
	<span class="n">CPB_RESP_DONE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>  <span class="cm">/* ATA command complete */</span>
	<span class="n">CPB_RESP_REL</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>  <span class="cm">/* ATA release */</span>
	<span class="n">CPB_RESP_IGNORED</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>  <span class="cm">/* CPB ignored */</span>
	<span class="n">CPB_RESP_ATA_ERR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>  <span class="cm">/* ATA command error */</span>
	<span class="n">CPB_RESP_SPURIOUS</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>  <span class="cm">/* ATA spurious interrupt error */</span>
	<span class="n">CPB_RESP_UNDERFLOW</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>  <span class="cm">/* APRD deficiency length error */</span>
	<span class="n">CPB_RESP_OVERFLOW</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>  <span class="cm">/* APRD exccess length error */</span>
	<span class="n">CPB_RESP_CPB_ERR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>  <span class="cm">/* CPB error flag */</span>

	<span class="cm">/* PRD Control Flags */</span>
	<span class="n">PRD_DRAIN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>  <span class="cm">/* ignore data excess */</span>
	<span class="n">PRD_CDB</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>  <span class="cm">/* atapi packet command pointer */</span>
	<span class="n">PRD_DIRECT_INTR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>  <span class="cm">/* direct interrupt */</span>
	<span class="n">PRD_DMA</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>  <span class="cm">/* data transfer method */</span>
	<span class="n">PRD_WRITE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>  <span class="cm">/* data dir, rsvd in datasheet */</span>
	<span class="n">PRD_IOM</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>  <span class="cm">/* io/memory transfer */</span>
	<span class="n">PRD_END</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>  <span class="cm">/* APRD chain end */</span>
<span class="p">};</span>

<span class="cm">/* Comman Parameter Block */</span>
<span class="k">struct</span> <span class="n">inic_cpb</span> <span class="p">{</span>
	<span class="n">u8</span>		<span class="n">resp_flags</span><span class="p">;</span>	<span class="cm">/* Response Flags */</span>
	<span class="n">u8</span>		<span class="n">error</span><span class="p">;</span>		<span class="cm">/* ATA Error */</span>
	<span class="n">u8</span>		<span class="n">status</span><span class="p">;</span>		<span class="cm">/* ATA Status */</span>
	<span class="n">u8</span>		<span class="n">ctl_flags</span><span class="p">;</span>	<span class="cm">/* Control Flags */</span>
	<span class="n">__le32</span>		<span class="n">len</span><span class="p">;</span>		<span class="cm">/* Total Transfer Length */</span>
	<span class="n">__le32</span>		<span class="n">prd</span><span class="p">;</span>		<span class="cm">/* First PRD pointer */</span>
	<span class="n">u8</span>		<span class="n">rsvd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="cm">/* 16 bytes */</span>
	<span class="n">u8</span>		<span class="n">feature</span><span class="p">;</span>	<span class="cm">/* ATA Feature */</span>
	<span class="n">u8</span>		<span class="n">hob_feature</span><span class="p">;</span>	<span class="cm">/* ATA Ex. Feature */</span>
	<span class="n">u8</span>		<span class="n">device</span><span class="p">;</span>		<span class="cm">/* ATA Device/Head */</span>
	<span class="n">u8</span>		<span class="n">mirctl</span><span class="p">;</span>		<span class="cm">/* Mirror Control */</span>
	<span class="n">u8</span>		<span class="n">nsect</span><span class="p">;</span>		<span class="cm">/* ATA Sector Count */</span>
	<span class="n">u8</span>		<span class="n">hob_nsect</span><span class="p">;</span>	<span class="cm">/* ATA Ex. Sector Count */</span>
	<span class="n">u8</span>		<span class="n">lbal</span><span class="p">;</span>		<span class="cm">/* ATA Sector Number */</span>
	<span class="n">u8</span>		<span class="n">hob_lbal</span><span class="p">;</span>	<span class="cm">/* ATA Ex. Sector Number */</span>
	<span class="n">u8</span>		<span class="n">lbam</span><span class="p">;</span>		<span class="cm">/* ATA Cylinder Low */</span>
	<span class="n">u8</span>		<span class="n">hob_lbam</span><span class="p">;</span>	<span class="cm">/* ATA Ex. Cylinder Low */</span>
	<span class="n">u8</span>		<span class="n">lbah</span><span class="p">;</span>		<span class="cm">/* ATA Cylinder High */</span>
	<span class="n">u8</span>		<span class="n">hob_lbah</span><span class="p">;</span>	<span class="cm">/* ATA Ex. Cylinder High */</span>
	<span class="n">u8</span>		<span class="n">command</span><span class="p">;</span>	<span class="cm">/* ATA Command */</span>
	<span class="n">u8</span>		<span class="n">ctl</span><span class="p">;</span>		<span class="cm">/* ATA Control */</span>
	<span class="n">u8</span>		<span class="n">slave_error</span><span class="p">;</span>	<span class="cm">/* Slave ATA Error */</span>
	<span class="n">u8</span>		<span class="n">slave_status</span><span class="p">;</span>	<span class="cm">/* Slave ATA Status */</span>
	<span class="cm">/* 32 bytes */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Physical Region Descriptor */</span>
<span class="k">struct</span> <span class="n">inic_prd</span> <span class="p">{</span>
	<span class="n">__le32</span>		<span class="n">mad</span><span class="p">;</span>		<span class="cm">/* Physical Memory Address */</span>
	<span class="n">__le16</span>		<span class="n">len</span><span class="p">;</span>		<span class="cm">/* Transfer Length */</span>
	<span class="n">u8</span>		<span class="n">rsvd</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* Control Flags */</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">inic_pkt</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">inic_cpb</span>	<span class="n">cpb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_prd</span>	<span class="n">prd</span><span class="p">[</span><span class="n">LIBATA_MAX_PRD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>	<span class="cm">/* + 1 for cdb */</span>
	<span class="n">u8</span>		<span class="n">cdb</span><span class="p">[</span><span class="n">ATAPI_CDB_LEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">inic_host_priv</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">mmio_base</span><span class="p">;</span>
	<span class="n">u16</span>		<span class="n">cached_hctl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">inic_port_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">inic_pkt</span>	<span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">pkt_dma</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="o">*</span><span class="n">cpb_tbl</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">cpb_tbl_dma</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">inic_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_BASE_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>	<span class="o">=</span> <span class="n">LIBATA_MAX_PRD</span><span class="p">,</span>	<span class="cm">/* maybe it can be larger? */</span>
	<span class="p">.</span><span class="n">dma_boundary</span>	<span class="o">=</span> <span class="n">INIC_DMA_BOUNDARY</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">scr_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SCR_STATUS</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCR_ERROR</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCR_CONTROL</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">inic_port_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inic_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">PORT_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_reset_port</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">idma_ctl</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IDMA_CTL</span><span class="p">;</span>

	<span class="cm">/* stop IDMA engine */</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">idma_ctl</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* mask IRQ and assert reset */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">IDMA_CTL_RST_IDMA</span><span class="p">,</span> <span class="n">idma_ctl</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">idma_ctl</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* release reset */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idma_ctl</span><span class="p">);</span>

	<span class="cm">/* clear irq */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scr_addr</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span> <span class="o">+</span> <span class="n">PORT_SCR</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sc_reg</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">scr_map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">scr_addr</span> <span class="o">+</span> <span class="n">scr_map</span><span class="p">[</span><span class="n">sc_reg</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">scr_addr</span> <span class="o">+</span> <span class="n">scr_map</span><span class="p">[</span><span class="n">sc_reg</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* this controller has stuck DIAG.N, ignore it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc_reg</span> <span class="o">==</span> <span class="n">SCR_ERROR</span><span class="p">)</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SERR_PHYRDY_CHG</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scr_addr</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span> <span class="o">+</span> <span class="n">PORT_SCR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sc_reg</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">scr_map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">scr_addr</span> <span class="o">+</span> <span class="n">scr_map</span><span class="p">[</span><span class="n">sc_reg</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_stop_idma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_RPQ_FIFO</span><span class="p">);</span>
	<span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_RPQ_CNT</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IDMA_CTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_host_err_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">irq_stat</span><span class="p">,</span> <span class="n">u16</span> <span class="n">idma_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_cpb</span> <span class="o">*</span><span class="n">cpb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cpb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">freeze</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ata_ehi_clear_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
	<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;irq_stat=0x%x idma_stat=0x%x&quot;</span><span class="p">,</span>
			  <span class="n">irq_stat</span><span class="p">,</span> <span class="n">idma_stat</span><span class="p">);</span>

	<span class="n">inic_stop_idma</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PIRQ_OFFLINE</span> <span class="o">|</span> <span class="n">PIRQ_ONLINE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;hotplug&quot;</span><span class="p">);</span>
		<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
		<span class="n">freeze</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idma_stat</span> <span class="o">&amp;</span> <span class="n">IDMA_STAT_PERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;PCI error&quot;</span><span class="p">);</span>
		<span class="n">freeze</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idma_stat</span> <span class="o">&amp;</span> <span class="n">IDMA_STAT_CPBERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;CPB error&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpb</span><span class="o">-&gt;</span><span class="n">resp_flags</span> <span class="o">&amp;</span> <span class="n">CPB_RESP_IGNORED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot; ignored&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_INVALID</span><span class="p">;</span>
			<span class="n">freeze</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpb</span><span class="o">-&gt;</span><span class="n">resp_flags</span> <span class="o">&amp;</span> <span class="n">CPB_RESP_ATA_ERR</span><span class="p">)</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpb</span><span class="o">-&gt;</span><span class="n">resp_flags</span> <span class="o">&amp;</span> <span class="n">CPB_RESP_SPURIOUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot; spurious-intr&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
			<span class="n">freeze</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cpb</span><span class="o">-&gt;</span><span class="n">resp_flags</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">CPB_RESP_UNDERFLOW</span> <span class="o">|</span> <span class="n">CPB_RESP_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot; data-over/underflow&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
			<span class="n">freeze</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freeze</span><span class="p">)</span>
		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ata_port_abort</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_host_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">irq_stat</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">idma_stat</span><span class="p">;</span>

	<span class="cm">/* read and clear IRQ status */</span>
	<span class="n">irq_stat</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">irq_stat</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="n">idma_stat</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IDMA_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">PIRQ_ERR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">idma_stat</span> <span class="o">&amp;</span> <span class="n">IDMA_STAT_ERR</span><span class="p">)))</span>
		<span class="n">inic_host_err_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">irq_stat</span><span class="p">,</span> <span class="n">idma_stat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">qc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">spurious</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">idma_stat</span> <span class="o">&amp;</span> <span class="n">IDMA_STAT_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inic_stop_idma</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="cm">/* Depending on circumstances, device error</span>
<span class="cm">		 * isn&#39;t reported by IDMA, check it explicitly.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_COMMAND</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="p">(</span><span class="n">ATA_DF</span> <span class="o">|</span> <span class="n">ATA_ERR</span><span class="p">)))</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>

		<span class="n">ata_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">spurious:</span>
	<span class="n">ata_port_warn</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;unhandled interrupt: cmd=0x%x irq_stat=0x%x idma_stat=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">qc</span> <span class="o">?</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">irq_stat</span><span class="p">,</span> <span class="n">idma_stat</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">inic_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">host_irq_stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">host_irq_stat</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_IRQ_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host_irq_stat</span> <span class="o">&amp;</span> <span class="n">HIRQ_GLOBAL</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host_irq_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HIRQ_PORT0</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">inic_host_intr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">handled</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_check_atapi_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* For some reason ATAPI_PROT_DMA doesn&#39;t work for some</span>
<span class="cm">	 * commands including writes and other misc ops.  Use PIO</span>
<span class="cm">	 * protocol instead, which BTW is driven by the DMA engine</span>
<span class="cm">	 * anyway, so it shouldn&#39;t make much difference for native</span>
<span class="cm">	 * SATA devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atapi_cmd_type</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_fill_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">inic_prd</span> <span class="o">*</span><span class="n">prd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PRD_WRITE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_is_dma</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">PRD_DMA</span><span class="p">;</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prd</span><span class="o">-&gt;</span><span class="n">mad</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">prd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
		<span class="n">prd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">prd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">si</span><span class="p">);</span>
	<span class="n">prd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PRD_END</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_qc_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inic_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_cpb</span> <span class="o">*</span><span class="n">cpb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cpb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_prd</span> <span class="o">*</span><span class="n">prd</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">prd</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_atapi</span> <span class="o">=</span> <span class="n">ata_is_atapi</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_data</span> <span class="o">=</span> <span class="n">ata_is_data</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cdb_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_atapi</span><span class="p">)</span>
		<span class="n">cdb_len</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdb_len</span><span class="p">;</span>

	<span class="cm">/* prepare packet, based on initio driver */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inic_pkt</span><span class="p">));</span>

	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">ctl_flags</span> <span class="o">=</span> <span class="n">CPB_CTL_VALID</span> <span class="o">|</span> <span class="n">CPB_CTL_IEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_atapi</span> <span class="o">||</span> <span class="n">is_data</span><span class="p">)</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">ctl_flags</span> <span class="o">|=</span> <span class="n">CPB_CTL_DATA</span><span class="p">;</span>

	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">+</span> <span class="n">cdb_len</span><span class="p">);</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">prd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt_dma</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inic_pkt</span><span class="p">,</span> <span class="n">prd</span><span class="p">));</span>

	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">feature</span><span class="p">;</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">nsect</span><span class="p">;</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">lbal</span><span class="p">;</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">lbam</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">lbam</span><span class="p">;</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">lbah</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">lbah</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">hob_feature</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">hob_feature</span><span class="p">;</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">hob_nsect</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">hob_nsect</span><span class="p">;</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">hob_lbal</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">hob_lbal</span><span class="p">;</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">hob_lbam</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">hob_lbam</span><span class="p">;</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">hob_lbah</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">hob_lbah</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="cm">/* don&#39;t load ctl - dunno why.  it&#39;s like that in the initio driver */</span>

	<span class="cm">/* setup PRD for CDB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_atapi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">ATAPI_CDB_LEN</span><span class="p">);</span>
		<span class="n">prd</span><span class="o">-&gt;</span><span class="n">mad</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt_dma</span> <span class="o">+</span>
				       <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inic_pkt</span><span class="p">,</span> <span class="n">cdb</span><span class="p">));</span>
		<span class="n">prd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cdb_len</span><span class="p">);</span>
		<span class="n">prd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">PRD_CDB</span> <span class="o">|</span> <span class="n">PRD_WRITE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_data</span><span class="p">)</span>
			<span class="n">prd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PRD_END</span><span class="p">;</span>
		<span class="n">prd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup sg table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_data</span><span class="p">)</span>
		<span class="n">inic_fill_sg</span><span class="p">(</span><span class="n">prd</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_tbl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt_dma</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">inic_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* fire up the ADMA engine */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">HCTL_FTHD0</span> <span class="o">|</span> <span class="n">HCTL_LEDEN</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">IDMA_CTL_GO</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IDMA_CTL</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_CPB_PTQFIFO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_tf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span>	<span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_FEATURE</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span>	<span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_NSECT</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span>	<span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_LBAL</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span>	<span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_LBAM</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span>	<span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_LBAH</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span>	<span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_DEVICE</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span>	<span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_COMMAND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">inic_qc_fill_rtf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">rtf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>

	<span class="cm">/* FIXME: Except for status and error, result TF access</span>
<span class="cm">	 * doesn&#39;t work.  I tried reading from BAR0/2, CPB and BAR5.</span>
<span class="cm">	 * None works regardless of which command interface is used.</span>
<span class="cm">	 * For now return true iff status indicates device error.</span>
<span class="cm">	 * This means that we&#39;re reporting bogus sector for RW</span>
<span class="cm">	 * failures.  Eeekk....</span>
<span class="cm">	 */</span>
	<span class="n">inic_tf_read</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rtf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="n">rtf</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">feature</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">PIRQ_MASK_FREEZE</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PIRQ_MASK_DEFAULT</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_check_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_check_ready</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_TF_COMMAND</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SRST and SControl hardreset don&#39;t give valid signature on this</span>
<span class="cm"> * controller.  Only controller specific hardreset mechanism works.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">idma_ctl</span> <span class="o">=</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IDMA_CTL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timing</span> <span class="o">=</span> <span class="n">sata_ehc_deb_timing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* hammer it into sane state */</span>
	<span class="n">inic_reset_port</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">IDMA_CTL_RST_ATA</span><span class="p">,</span> <span class="n">idma_ctl</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">idma_ctl</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="n">ata_msleep</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">idma_ctl</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_link_resume</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">timing</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
			      <span class="s">&quot;failed to resume link after reset (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_link_online</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>

		<span class="cm">/* wait for link to become ready */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_wait_after_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span> <span class="n">inic_check_ready</span><span class="p">);</span>
		<span class="cm">/* link occupied, -ENODEV too is an error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
				      <span class="s">&quot;device not ready after hardreset (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">inic_tf_read</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">ata_dev_classify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">inic_reset_port</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
	<span class="n">ata_std_error_handler</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">inic_post_internal_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* make DMA engine forget about the failed command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">)</span>
		<span class="n">inic_reset_port</span><span class="p">(</span><span class="n">inic_port_base</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">inic_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inic_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* clear packet and CPB table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inic_pkt</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_tbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IDMA_CPB_TBL_SIZE</span><span class="p">);</span>

	<span class="cm">/* setup CPB lookup table addresses */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_tbl_dma</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_CPB_CPBLAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_port_priv</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="cm">/* alloc and initialize private data */</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>

	<span class="cm">/* Alloc resources */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">dmam_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">inic_pkt</span><span class="p">),</span>
				      <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_tbl</span> <span class="o">=</span> <span class="n">dmam_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IDMA_CPB_TBL_SIZE</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_tbl_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_tbl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">init_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">inic_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sata_port_ops</span><span class="p">,</span>

	<span class="p">.</span><span class="n">check_atapi_dma</span>	<span class="o">=</span> <span class="n">inic_check_atapi_dma</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_prep</span>		<span class="o">=</span> <span class="n">inic_qc_prep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_issue</span>		<span class="o">=</span> <span class="n">inic_qc_issue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_fill_rtf</span>		<span class="o">=</span> <span class="n">inic_qc_fill_rtf</span><span class="p">,</span>

	<span class="p">.</span><span class="n">freeze</span>			<span class="o">=</span> <span class="n">inic_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>			<span class="o">=</span> <span class="n">inic_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardreset</span>		<span class="o">=</span> <span class="n">inic_hardreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>		<span class="o">=</span> <span class="n">inic_error_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_internal_cmd</span>	<span class="o">=</span> <span class="n">inic_post_internal_cmd</span><span class="p">,</span>

	<span class="p">.</span><span class="n">scr_read</span>		<span class="o">=</span> <span class="n">inic_scr_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scr_write</span>		<span class="o">=</span> <span class="n">inic_scr_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">port_resume</span>		<span class="o">=</span> <span class="n">inic_port_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_start</span>		<span class="o">=</span> <span class="n">inic_port_start</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">inic_port_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>			<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span> <span class="o">|</span> <span class="n">ATA_FLAG_PIO_DMA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pio_mask</span>		<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mwdma_mask</span>		<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">udma_mask</span>		<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">inic_port_ops</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_controller</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">u16</span> <span class="n">hctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">hctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HCTL_KNOWN_BITS</span><span class="p">;</span>

	<span class="cm">/* Soft reset whole controller.  Spec says reset duration is 3</span>
<span class="cm">	 * PCI clocks, be generous and give it 10ms.</span>
<span class="cm">	 */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">hctl</span> <span class="o">|</span> <span class="n">HCTL_SOFTRST</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span> <span class="cm">/* flush */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HCTL_SOFTRST</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HCTL_SOFTRST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* mask all interrupts and reset ports */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_base</span> <span class="o">=</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PORT_SIZE</span><span class="p">;</span>

		<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">port_base</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
		<span class="n">inic_reset_port</span><span class="p">(</span><span class="n">port_base</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* port IRQ is masked now, unmask global IRQ */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">hctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCTL_IRQOFF</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_IRQ_MASK</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HIRQ_PORT0</span> <span class="o">|</span> <span class="n">HIRQ_PORT1</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_IRQ_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_pci_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">inic_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_device_do_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">init_controller</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cached_hctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inic_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">inic_port_info</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inic_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">iomap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mmio_bar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ata_print_version_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="cm">/* alloc host */</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ata_host_alloc_pinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="n">NR_PORTS</span><span class="p">);</span>
	<span class="n">hpriv</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hpriv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span> <span class="o">||</span> <span class="o">!</span><span class="n">hpriv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hpriv</span><span class="p">;</span>

	<span class="cm">/* Acquire resources and fill host.  Note that PCI and cardbus</span>
<span class="cm">	 * use different BARs.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MMIO_BAR_PCI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
		<span class="n">mmio_bar</span> <span class="o">=</span> <span class="n">MMIO_BAR_PCI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mmio_bar</span> <span class="o">=</span> <span class="n">MMIO_BAR_CARDBUS</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_iomap_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mmio_bar</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span> <span class="o">=</span> <span class="n">iomap</span> <span class="o">=</span> <span class="n">pcim_iomap_table</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">iomap</span><span class="p">[</span><span class="n">mmio_bar</span><span class="p">];</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cached_hctl</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ata_port_pbar_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">mmio_bar</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;mmio&quot;</span><span class="p">);</span>
		<span class="n">ata_port_pbar_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">mmio_bar</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PORT_SIZE</span><span class="p">,</span> <span class="s">&quot;port&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set dma_mask.  This devices doesn&#39;t support 64bit addressing. */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;32-bit DMA enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;32-bit consistent DMA enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * This controller is braindamaged.  dma_boundary is 0xffff</span>
<span class="cm">	 * like others but it will lock up the whole machine HARD if</span>
<span class="cm">	 * 65536 byte PRD entry is fed. Reduce maximum segment size.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_max_seg_size</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">65536</span> <span class="o">-</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set the maximum segment size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">init_controller</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">,</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cached_hctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ata_host_activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">inic_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">inic_sht</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">inic_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INIT</span><span class="p">,</span> <span class="mh">0x1622</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">inic_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">inic_pci_tbl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ata_pci_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">inic_pci_device_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">probe</span> 		<span class="o">=</span> <span class="n">inic_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ata_pci_remove_one</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">inic_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inic_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">inic_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inic_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Tejun Heo&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;low-level driver for Initio 162x SATA&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">inic_pci_tbl</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">inic_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">inic_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
