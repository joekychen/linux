<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › ata_piix.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ata_piix.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *    ata_piix.c - Intel PATA/SATA controllers</span>
<span class="cm"> *</span>
<span class="cm"> *    Maintained by:  Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> *    		    Please ALWAYS copy linux-ide@vger.kernel.org</span>
<span class="cm"> *		    on emails.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright 2003-2005 Red Hat Inc</span>
<span class="cm"> *	Copyright 2003-2005 Jeff Garzik</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright header from piix.c:</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1998-1999 Andrzej Krzysztofowicz, Author and Maintainer</span>
<span class="cm"> *  Copyright (C) 1998-2000 Andre Hedrick &lt;andre@linux-ide.org&gt;</span>
<span class="cm"> *  Copyright (C) 2003 Red Hat Inc</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  libata documentation is available via &#39;make {ps|pdf}docs&#39;,</span>
<span class="cm"> *  as Documentation/DocBook/libata.*</span>
<span class="cm"> *</span>
<span class="cm"> *  Hardware documentation available at http://developer.intel.com/</span>
<span class="cm"> *</span>
<span class="cm"> * Documentation</span>
<span class="cm"> *	Publicly available from Intel web site. Errata documentation</span>
<span class="cm"> * is also publicly available. As an aide to anyone hacking on this</span>
<span class="cm"> * driver the list of errata that are relevant is below, going back to</span>
<span class="cm"> * PIIX4. Older device documentation is now a bit tricky to find.</span>
<span class="cm"> *</span>
<span class="cm"> * The chipsets all follow very much the same design. The original Triton</span>
<span class="cm"> * series chipsets do _not_ support independent device timings, but this</span>
<span class="cm"> * is fixed in Triton II. With the odd mobile exception the chips then</span>
<span class="cm"> * change little except in gaining more modes until SATA arrives. This</span>
<span class="cm"> * driver supports only the chips with independent timing (that is those</span>
<span class="cm"> * with SITRE and the 0x44 timing register). See pata_oldpiix and pata_mpiix</span>
<span class="cm"> * for the early chip drivers.</span>
<span class="cm"> *</span>
<span class="cm"> * Errata of note:</span>
<span class="cm"> *</span>
<span class="cm"> * Unfixable</span>
<span class="cm"> *	PIIX4    errata #9	- Only on ultra obscure hw</span>
<span class="cm"> *	ICH3	 errata #13     - Not observed to affect real hw</span>
<span class="cm"> *				  by Intel</span>
<span class="cm"> *</span>
<span class="cm"> * Things we must deal with</span>
<span class="cm"> *	PIIX4	errata #10	- BM IDE hang with non UDMA</span>
<span class="cm"> *				  (must stop/start dma to recover)</span>
<span class="cm"> *	440MX   errata #15	- As PIIX4 errata #10</span>
<span class="cm"> *	PIIX4	errata #15	- Must not read control registers</span>
<span class="cm"> * 				  during a PIO transfer</span>
<span class="cm"> *	440MX   errata #13	- As PIIX4 errata #15</span>
<span class="cm"> *	ICH2	errata #21	- DMA mode 0 doesn&#39;t work right</span>
<span class="cm"> *	ICH0/1  errata #55	- As ICH2 errata #21</span>
<span class="cm"> *	ICH2	spec c #9	- Extra operations needed to handle</span>
<span class="cm"> *				  drive hotswap [NOT YET SUPPORTED]</span>
<span class="cm"> *	ICH2    spec c #20	- IDE PRD must not cross a 64K boundary</span>
<span class="cm"> *				  and must be dword aligned</span>
<span class="cm"> *	ICH2    spec c #24	- UDMA mode 4,5 t85/86 should be 6ns not 3.3</span>
<span class="cm"> *	ICH7	errata #16	- MWDMA1 timings are incorrect</span>
<span class="cm"> *</span>
<span class="cm"> * Should have been BIOS fixed:</span>
<span class="cm"> *	450NX:	errata #19	- DMA hangs on old 450NX</span>
<span class="cm"> *	450NX:  errata #20	- DMA hangs on old 450NX</span>
<span class="cm"> *	450NX:  errata #25	- Corruption with DMA on old 450NX</span>
<span class="cm"> *	ICH3    errata #15      - IDE deadlock under high load</span>
<span class="cm"> *				  (BIOS must set dev 31 fn 0 bit 23)</span>
<span class="cm"> *	ICH3	errata #18	- Don&#39;t use native mode</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>

<span class="cp">#define DRV_NAME	&quot;ata_piix&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;2.13&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">PIIX_IOCFG</span>		<span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span> <span class="cm">/* IDE I/O configuration register */</span>
	<span class="n">ICH5_PMR</span>		<span class="o">=</span> <span class="mh">0x90</span><span class="p">,</span> <span class="cm">/* port mapping register */</span>
	<span class="n">ICH5_PCS</span>		<span class="o">=</span> <span class="mh">0x92</span><span class="p">,</span>	<span class="cm">/* port control and status */</span>
	<span class="n">PIIX_SIDPR_BAR</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">PIIX_SIDPR_LEN</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="n">PIIX_SIDPR_IDX</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">PIIX_SIDPR_DATA</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>

	<span class="n">PIIX_FLAG_CHECKINTR</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">),</span> <span class="cm">/* make sure PCI INTx enabled */</span>
	<span class="n">PIIX_FLAG_SIDPR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">),</span> <span class="cm">/* SATA idx/data pair regs */</span>

	<span class="n">PIIX_PATA_FLAGS</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
	<span class="n">PIIX_SATA_FLAGS</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span> <span class="o">|</span> <span class="n">PIIX_FLAG_CHECKINTR</span><span class="p">,</span>

	<span class="n">PIIX_FLAG_PIO16</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">),</span> <span class="cm">/*support 16bit PIO only*/</span>

	<span class="n">PIIX_80C_PRI</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">PIIX_80C_SEC</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>

	<span class="cm">/* constants for mapping table */</span>
	<span class="n">P0</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="cm">/* port 0 */</span>
	<span class="n">P1</span>			<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="cm">/* port 1 */</span>
	<span class="n">P2</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="cm">/* port 2 */</span>
	<span class="n">P3</span>			<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="cm">/* port 3 */</span>
	<span class="n">IDE</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* IDE */</span>
	<span class="n">NA</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/* not available */</span>
	<span class="n">RV</span>			<span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="cm">/* reserved */</span>

	<span class="n">PIIX_AHCI_DEVICE</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

	<span class="cm">/* host-&gt;flags bits */</span>
	<span class="n">PIIX_HOST_BROKEN_SUSPEND</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">piix_controller_ids</span> <span class="p">{</span>
	<span class="cm">/* controller IDs */</span>
	<span class="n">piix_pata_mwdma</span><span class="p">,</span>	<span class="cm">/* PIIX3 MWDMA only */</span>
	<span class="n">piix_pata_33</span><span class="p">,</span>		<span class="cm">/* PIIX4 at 33Mhz */</span>
	<span class="n">ich_pata_33</span><span class="p">,</span>		<span class="cm">/* ICH up to UDMA 33 only */</span>
	<span class="n">ich_pata_66</span><span class="p">,</span>		<span class="cm">/* ICH up to 66 Mhz */</span>
	<span class="n">ich_pata_100</span><span class="p">,</span>		<span class="cm">/* ICH up to UDMA 100 */</span>
	<span class="n">ich_pata_100_nomwdma1</span><span class="p">,</span>	<span class="cm">/* ICH up to UDMA 100 but with no MWDMA1*/</span>
	<span class="n">ich5_sata</span><span class="p">,</span>
	<span class="n">ich6_sata</span><span class="p">,</span>
	<span class="n">ich6m_sata</span><span class="p">,</span>
	<span class="n">ich8_sata</span><span class="p">,</span>
	<span class="n">ich8_2port_sata</span><span class="p">,</span>
	<span class="n">ich8m_apple_sata</span><span class="p">,</span>	<span class="cm">/* locks up on second port enable */</span>
	<span class="n">tolapai_sata</span><span class="p">,</span>
	<span class="n">piix_pata_vmw</span><span class="p">,</span>			<span class="cm">/* PIIX4 for VMware, spurious DMA_ERR */</span>
	<span class="n">ich8_sata_snb</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">piix_map_db</span> <span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="n">port_enable</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">map</span><span class="p">[][</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">saved_iocfg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sidpr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">piix_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_pata_prereset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">piix_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">piix_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ich_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ich_pata_cable_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">piix_vmw_bmdma_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_sidpr_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_sidpr_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_sidpr_set_lpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ata_lpm_policy</span> <span class="n">policy</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">hints</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">piix_irq_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_pci_device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">piix_pci_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_module_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">piix_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Intel PIIX3 for the 430HX etc */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x7010</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piix_pata_mwdma</span> <span class="p">},</span>
	<span class="cm">/* VMware ICH4 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x7111</span><span class="p">,</span> <span class="mh">0x15ad</span><span class="p">,</span> <span class="mh">0x1976</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piix_pata_vmw</span> <span class="p">},</span>
	<span class="cm">/* Intel PIIX4 for the 430TX/440BX/MX chipset: UDMA 33 */</span>
	<span class="cm">/* Also PIIX4E (fn3 rev 2) and PIIX4M (fn3 rev 3) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x7111</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piix_pata_33</span> <span class="p">},</span>
	<span class="cm">/* Intel PIIX4 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x7199</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piix_pata_33</span> <span class="p">},</span>
	<span class="cm">/* Intel PIIX4 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x7601</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piix_pata_33</span> <span class="p">},</span>
	<span class="cm">/* Intel PIIX */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x84CA</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piix_pata_33</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH (i810, i815, i840) UDMA 66*/</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2411</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_66</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH0 : UDMA 33*/</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2421</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_33</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH2M */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x244A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH2 (i810E2, i845, 850, 860) UDMA 100 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x244B</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/*  Intel ICH3M */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x248A</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH3 (E7500/1) UDMA 100 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x248B</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH4-L */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x24C1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH4 (i845GV, i845E, i852, i855) UDMA 100 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x24CA</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x24CB</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* Intel ICH5 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x24DB</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* C-ICH (i810E2) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x245B</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* ESB (855GME/875P + 6300ESB) UDMA 100  */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x25A2</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* ICH6 (and 6) (i915) UDMA 100 */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x266F</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>
	<span class="cm">/* ICH7/7-R (i945, i975) UDMA 100*/</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100_nomwdma1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x269E</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100_nomwdma1</span> <span class="p">},</span>
	<span class="cm">/* ICH8 Mobile PATA Controller */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2850</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich_pata_100</span> <span class="p">},</span>

	<span class="cm">/* SATA ports */</span>

	<span class="cm">/* 82801EB (ICH5) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x24d1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich5_sata</span> <span class="p">},</span>
	<span class="cm">/* 82801EB (ICH5) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x24df</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich5_sata</span> <span class="p">},</span>
	<span class="cm">/* 6300ESB (ICH5 variant with broken PCS present bits) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x25a3</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich5_sata</span> <span class="p">},</span>
	<span class="cm">/* 6300ESB pretending RAID */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x25b0</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich5_sata</span> <span class="p">},</span>
	<span class="cm">/* 82801FB/FW (ICH6/ICH6W) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2651</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich6_sata</span> <span class="p">},</span>
	<span class="cm">/* 82801FR/FRW (ICH6R/ICH6RW) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2652</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich6_sata</span> <span class="p">},</span>
	<span class="cm">/* 82801FBM ICH6M (ICH6R with only port 0 and 2 implemented).</span>
<span class="cm">	 * Attach iff the controller is in IDE mode. */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2653</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	  <span class="n">PCI_CLASS_STORAGE_IDE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="n">ich6m_sata</span> <span class="p">},</span>
	<span class="cm">/* 82801GB/GR/GH (ICH7, identical to ICH6) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x27c0</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich6_sata</span> <span class="p">},</span>
	<span class="cm">/* 2801GBM/GHM (ICH7M, identical to ICH6M) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x27c4</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich6m_sata</span> <span class="p">},</span>
	<span class="cm">/* Enterprise Southbridge 2 (631xESB/632xESB) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2680</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich6_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller 1 IDE (ICH8) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2820</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller 2 IDE (ICH8) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2825</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* Mobile SATA Controller IDE (ICH8M), Apple */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x106b</span><span class="p">,</span> <span class="mh">0x00a0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8m_apple_sata</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x106b</span><span class="p">,</span> <span class="mh">0x00a1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8m_apple_sata</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="mh">0x106b</span><span class="p">,</span> <span class="mh">0x00a3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8m_apple_sata</span> <span class="p">},</span>
	<span class="cm">/* Mobile SATA Controller IDE (ICH8M) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2828</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH9) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2920</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH9) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2921</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH9) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2926</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH9M) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2928</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH9M) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x292d</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH9M) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x292e</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Tolapai) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x5028</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tolapai_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH10) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3a00</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH10) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3a06</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH10) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3a20</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (ICH10) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3a26</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PCH) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3b20</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PCH) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3b21</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PCH) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3b26</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PCH) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3b28</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PCH) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3b2d</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PCH) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x3b2e</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (CPT) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1c00</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata_snb</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (CPT) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1c01</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata_snb</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (CPT) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1c08</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (CPT) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1c09</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PBG) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1d00</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata_snb</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (PBG) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1d08</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Panther Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1e00</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata_snb</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Panther Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1e01</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata_snb</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Panther Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1e08</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Panther Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1e09</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Lynx Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x8c00</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata_snb</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Lynx Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x8c01</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_sata_snb</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Lynx Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x8c08</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (Lynx Point) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x8c09</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="cm">/* SATA Controller IDE (DH89xxCC) */</span>
	<span class="p">{</span> <span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x2326</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ich8_2port_sata</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">piix_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">piix_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">piix_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>			<span class="o">=</span> <span class="n">piix_remove_one</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">piix_pci_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">piix_pci_device_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">piix_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_BMDMA_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">piix_sata_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_bmdma32_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_irq_check</span>		<span class="o">=</span> <span class="n">piix_irq_check</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_start</span>		<span class="o">=</span> <span class="n">piix_port_start</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">piix_pata_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">ata_cable_40wire</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>		<span class="o">=</span> <span class="n">piix_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>		<span class="o">=</span> <span class="n">piix_set_dmamode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prereset</span>		<span class="o">=</span> <span class="n">piix_pata_prereset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">piix_vmw_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_pata_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmdma_status</span>		<span class="o">=</span> <span class="n">piix_vmw_bmdma_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">ich_pata_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_pata_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">ich_pata_cable_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>		<span class="o">=</span> <span class="n">ich_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">piix_sidpr_shost_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_link_power_management_policy</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">piix_sidpr_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_BMDMA_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shost_attrs</span>		<span class="o">=</span> <span class="n">piix_sidpr_shost_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">piix_sidpr_sata_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardreset</span>		<span class="o">=</span> <span class="n">sata_std_hardreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scr_read</span>		<span class="o">=</span> <span class="n">piix_sidpr_scr_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scr_write</span>		<span class="o">=</span> <span class="n">piix_sidpr_scr_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_lpm</span>		<span class="o">=</span> <span class="n">piix_sidpr_set_lpm</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="n">ich5_map_db</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_enable</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* PM   PS   SM   SS       MAP  */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">NA</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">NA</span> <span class="p">},</span> <span class="cm">/* 000b */</span>
		<span class="p">{</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">NA</span><span class="p">,</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">NA</span> <span class="p">},</span> <span class="cm">/* 001b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span> <span class="p">},</span> <span class="cm">/* 100b */</span>
		<span class="p">{</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">P0</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span> <span class="p">},</span> <span class="cm">/* 101b */</span>
		<span class="p">{</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P1</span> <span class="p">},</span> <span class="cm">/* 110b */</span>
		<span class="p">{</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">P0</span> <span class="p">},</span> <span class="cm">/* 111b */</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="n">ich6_map_db</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_enable</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* PM   PS   SM   SS       MAP */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P2</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">P3</span> <span class="p">},</span> <span class="cm">/* 00b */</span>
		<span class="p">{</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">P3</span> <span class="p">},</span> <span class="cm">/* 01b */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P2</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span> <span class="p">},</span> <span class="cm">/* 10b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="n">ich6m_map_db</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_enable</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">,</span>

	<span class="cm">/* Map 01b isn&#39;t specified in the doc but some notebooks use</span>
<span class="cm">	 * it anyway.  MAP 01b have been spotted on both ICH6M and</span>
<span class="cm">	 * ICH7M.</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* PM   PS   SM   SS       MAP */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P2</span><span class="p">,</span>  <span class="n">NA</span><span class="p">,</span>  <span class="n">NA</span> <span class="p">},</span> <span class="cm">/* 00b */</span>
		<span class="p">{</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">P3</span> <span class="p">},</span> <span class="cm">/* 01b */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P2</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span> <span class="p">},</span> <span class="cm">/* 10b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="n">ich8_map_db</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_enable</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* PM   PS   SM   SS       MAP */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P2</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">P3</span> <span class="p">},</span> <span class="cm">/* 00b (hardwired when in AHCI) */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P2</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span> <span class="p">},</span> <span class="cm">/* 10b (IDE mode) */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="n">ich8_2port_map_db</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_enable</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* PM   PS   SM   SS       MAP */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">NA</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">NA</span> <span class="p">},</span> <span class="cm">/* 00b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span> <span class="cm">/* 01b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span> <span class="cm">/* 10b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="n">ich8m_apple_map_db</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_enable</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* PM   PS   SM   SS       MAP */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">NA</span><span class="p">,</span>  <span class="n">NA</span><span class="p">,</span>  <span class="n">NA</span> <span class="p">},</span> <span class="cm">/* 00b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">P2</span><span class="p">,</span> <span class="n">IDE</span><span class="p">,</span> <span class="n">IDE</span> <span class="p">},</span> <span class="cm">/* 10b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="n">tolapai_map_db</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_enable</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* PM   PS   SM   SS       MAP */</span>
		<span class="p">{</span>  <span class="n">P0</span><span class="p">,</span>  <span class="n">NA</span><span class="p">,</span>  <span class="n">P1</span><span class="p">,</span>  <span class="n">NA</span> <span class="p">},</span> <span class="cm">/* 00b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span> <span class="cm">/* 01b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span> <span class="cm">/* 10b */</span>
		<span class="p">{</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span><span class="p">,</span>  <span class="n">RV</span> <span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="o">*</span><span class="n">piix_map_db_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ich5_sata</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich5_map_db</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ich6_sata</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich6_map_db</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ich6m_sata</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich6m_map_db</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ich8_sata</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_map_db</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ich8_2port_sata</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_2port_map_db</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ich8m_apple_sata</span><span class="p">]</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8m_apple_map_db</span><span class="p">,</span>
	<span class="p">[</span><span class="n">tolapai_sata</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">tolapai_map_db</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ich8_sata_snb</span><span class="p">]</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich8_map_db</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">piix_port_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">piix_pata_mwdma</span><span class="p">]</span> <span class="o">=</span> 	<span class="cm">/* PIIX3 MWDMA only */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_PATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="cm">/* mwdma1-2 ?? CHECK 0 should be ok but slow */</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_pata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">piix_pata_33</span><span class="p">]</span> <span class="o">=</span>	<span class="cm">/* PIIX4 at 33MHz */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_PATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="cm">/* mwdma1-2 ?? CHECK 0 should be ok but slow */</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_pata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich_pata_33</span><span class="p">]</span> <span class="o">=</span> 	<span class="cm">/* ICH0 - ICH at 33Mhz*/</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_PATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> 	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="cm">/* Check: maybe MWDMA0 is ok  */</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich_pata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich_pata_66</span><span class="p">]</span> <span class="o">=</span> 	<span class="cm">/* ICH controllers up to 66MHz */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_PATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> 	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="cm">/* MWDMA0 is broken on chip */</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich_pata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich_pata_100</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_PATA_FLAGS</span> <span class="o">|</span> <span class="n">PIIX_FLAG_CHECKINTR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich_pata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich_pata_100_nomwdma1</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_PATA_FLAGS</span> <span class="o">|</span> <span class="n">PIIX_FLAG_CHECKINTR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2_ONLY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ich_pata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich5_sata</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich6_sata</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich6m_sata</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich8_sata</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span> <span class="o">|</span> <span class="n">PIIX_FLAG_SIDPR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich8_2port_sata</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span> <span class="o">|</span> <span class="n">PIIX_FLAG_SIDPR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">tolapai_sata</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">ich8m_apple_sata</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="p">[</span><span class="n">piix_pata_vmw</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_PATA_FLAGS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA12_ONLY</span><span class="p">,</span> <span class="cm">/* mwdma1-2 ?? CHECK 0 should be ok but slow */</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_vmw_ops</span><span class="p">,</span>
	<span class="p">},</span>

	<span class="cm">/*</span>
<span class="cm">	 * some Sandybridge chipsets have broken 32 mode up to now,</span>
<span class="cm">	 * see https://bugzilla.kernel.org/show_bug.cgi?id=40592</span>
<span class="cm">	 */</span>
	<span class="p">[</span><span class="n">ich8_sata_snb</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">PIIX_SATA_FLAGS</span> <span class="o">|</span> <span class="n">PIIX_FLAG_SIDPR</span> <span class="o">|</span> <span class="n">PIIX_FLAG_PIO16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sata_ops</span><span class="p">,</span>
	<span class="p">},</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_bits</span> <span class="n">piix_enable_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x41U</span><span class="p">,</span> <span class="mi">1U</span><span class="p">,</span> <span class="mh">0x80UL</span><span class="p">,</span> <span class="mh">0x80UL</span> <span class="p">},</span>	<span class="cm">/* port 0 */</span>
	<span class="p">{</span> <span class="mh">0x43U</span><span class="p">,</span> <span class="mi">1U</span><span class="p">,</span> <span class="mh">0x80UL</span><span class="p">,</span> <span class="mh">0x80UL</span> <span class="p">},</span>	<span class="cm">/* port 1 */</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Andre Hedrick, Alan Cox, Andrzej Krzysztofowicz, Jeff Garzik&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SCSI low-level driver for Intel PIIX/ICH ATA controllers&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">piix_pci_tbl</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ich_laptop</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subvendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subdevice</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	List of laptops that use short cables rather than 80 wire</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ich_laptop</span> <span class="n">ich_laptop</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* devid, subvendor, subdev */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0280</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Acer 5602WLMi */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0102</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Acer 5602aWLMi */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0110</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Acer 3682WLMi */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x02b0</span> <span class="p">},</span>	<span class="cm">/* ICH7 on unknown Dell */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x1267</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Asus W5F */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x30A1</span> <span class="p">},</span>	<span class="cm">/* ICH7 on HP Compaq nc2400 */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x103C</span><span class="p">,</span> <span class="mh">0x361a</span> <span class="p">},</span>	<span class="cm">/* ICH7 on unknown HP  */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x1071</span><span class="p">,</span> <span class="mh">0xD221</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Hercules EC-900 */</span>
	<span class="p">{</span> <span class="mh">0x27DF</span><span class="p">,</span> <span class="mh">0x152D</span><span class="p">,</span> <span class="mh">0x0778</span> <span class="p">},</span>	<span class="cm">/* ICH7 on unknown Intel */</span>
	<span class="p">{</span> <span class="mh">0x24CA</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0061</span> <span class="p">},</span>	<span class="cm">/* ICH4 on ACER Aspire 2023WLMi */</span>
	<span class="p">{</span> <span class="mh">0x24CA</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x003d</span> <span class="p">},</span>	<span class="cm">/* ICH4 on ACER TM290 */</span>
	<span class="p">{</span> <span class="mh">0x266F</span><span class="p">,</span> <span class="mh">0x1025</span><span class="p">,</span> <span class="mh">0x0066</span> <span class="p">},</span>	<span class="cm">/* ICH6 on ACER Aspire 1694WLMi */</span>
	<span class="p">{</span> <span class="mh">0x2653</span><span class="p">,</span> <span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x82D8</span> <span class="p">},</span>	<span class="cm">/* ICH6M on Asus Eee 701 */</span>
	<span class="p">{</span> <span class="mh">0x27df</span><span class="p">,</span> <span class="mh">0x104d</span><span class="p">,</span> <span class="mh">0x900e</span> <span class="p">},</span>	<span class="cm">/* ICH7 on Sony TZ-90 */</span>
	<span class="cm">/* end marker */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PIIX_FLAG_PIO16</span><span class="p">))</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_PIO32</span> <span class="o">|</span> <span class="n">ATA_PFLAG_PIO32CHANGE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ata_bmdma_port_start</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ich_pata_cable_detect - Probe host controller cable detect info</span>
<span class="cm"> *	@ap: Port for which cable detect info is desired</span>
<span class="cm"> *</span>
<span class="cm"> *	Read 80c cable indicator from ATA PCI device&#39;s PCI config</span>
<span class="cm"> *	register.  This register is normally set by firmware (BIOS).</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None (inherited from caller).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ich_pata_cable_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ich_laptop</span> <span class="o">*</span><span class="n">lap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ich_laptop</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* Check for specials - Acer Aspire 5602WLMi */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lap</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lap</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lap</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lap</span><span class="o">-&gt;</span><span class="n">subdevice</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ATA_CBL_PATA40_SHORT</span><span class="p">;</span>

		<span class="n">lap</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check BIOS cable detect results */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">PIIX_80C_PRI</span> <span class="o">:</span> <span class="n">PIIX_80C_SEC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_iocfg</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA40</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ATA_CBL_PATA80</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_pata_prereset - prereset for PATA host controller</span>
<span class="cm"> *	@link: Target link</span>
<span class="cm"> *	@deadline: deadline jiffies for the operation</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None (inherited from caller).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_pata_prereset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_test_config_bits</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">piix_enable_bits</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ata_sff_prereset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">piix_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_set_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">pio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_slave</span>	<span class="o">=</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">master_port</span><span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">?</span> <span class="mh">0x42</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slave_port</span>	<span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">master_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">slave_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">udma_enable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	See Intel Document 298600-004 for the timing programing rules</span>
<span class="cm">	 *	for ICH controllers.</span>
<span class="cm">	 */</span>

	<span class="k">static</span> <span class="k">const</span>	 <span class="cm">/* ISP  RTC */</span>
	<span class="n">u8</span> <span class="n">timings</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
			    <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
			    <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
			    <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span>
			    <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* TIME1 enable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_pio_need_iordy</span><span class="p">(</span><span class="n">adev</span><span class="p">))</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* IE enable */</span>
	<span class="cm">/* Intel specifies that the PPE functionality is for disk only */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATA</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* PPE enable */</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the drive MWDMA is faster than it can do PIO then</span>
<span class="cm">	 * we must force PIO into PIO0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">&lt;</span> <span class="n">XFER_PIO_0</span> <span class="o">+</span> <span class="n">pio</span><span class="p">)</span>
		<span class="cm">/* Enable DMA timing only */</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* PIO cycles in PIO0 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* PIO configuration clears DTE unconditionally.  It will be</span>
<span class="cm">	 * programmed in set_dmamode which is guaranteed to be called</span>
<span class="cm">	 * after set_piomode if any DMA mode is available.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">master_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">master_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_slave</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear TIME1|IE1|PPE1|DTE1 */</span>
		<span class="n">master_data</span> <span class="o">&amp;=</span> <span class="mh">0xff0f</span><span class="p">;</span>
		<span class="cm">/* enable PPE1, IE1 and TIME1 as needed */</span>
		<span class="n">master_data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">control</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slave_port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slave_data</span><span class="p">);</span>
		<span class="n">slave_data</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">?</span> <span class="mh">0x0f</span> <span class="o">:</span> <span class="mh">0xf0</span><span class="p">);</span>
		<span class="cm">/* Load the timing nibble for this slave */</span>
		<span class="n">slave_data</span> <span class="o">|=</span> <span class="p">((</span><span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
						<span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* clear ISP|RCT|TIME0|IE0|PPE0|DTE0 */</span>
		<span class="n">master_data</span> <span class="o">&amp;=</span> <span class="mh">0xccf0</span><span class="p">;</span>
		<span class="cm">/* Enable PPE, IE and TIME as appropriate */</span>
		<span class="n">master_data</span> <span class="o">|=</span> <span class="n">control</span><span class="p">;</span>
		<span class="cm">/* load ISP and RCT */</span>
		<span class="n">master_data</span> <span class="o">|=</span>
			<span class="p">(</span><span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">timings</span><span class="p">[</span><span class="n">pio</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable SITRE (separate slave timing register) */</span>
	<span class="n">master_data</span> <span class="o">|=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">master_port</span><span class="p">,</span> <span class="n">master_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_slave</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">slave_port</span><span class="p">,</span> <span class="n">slave_data</span><span class="p">);</span>

	<span class="cm">/* Ensure the UDMA bit is off - it will be turned back on if</span>
<span class="cm">	   UDMA is selected */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">udma_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udma_enable</span><span class="p">);</span>
		<span class="n">udma_enable</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">+</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">));</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">udma_enable</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_set_piomode - Initialize host controller PATA PIO timings</span>
<span class="cm"> *	@ap: Port whose timings we are configuring</span>
<span class="cm"> *	@adev: Drive in question</span>
<span class="cm"> *</span>
<span class="cm"> *	Set PIO mode for device, in host controller PCI config space.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None (inherited from caller).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">piix_set_timings</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	do_pata_set_dmamode - Initialize host controller PATA PIO timings</span>
<span class="cm"> *	@ap: Port whose timings we are configuring</span>
<span class="cm"> *	@adev: Drive in question</span>
<span class="cm"> *	@isich: set if the chip is an ICH device</span>
<span class="cm"> *</span>
<span class="cm"> *	Set UDMA mode for device, in host controller PCI config space.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None (inherited from caller).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_pata_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isich</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span>	<span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">speed</span>		<span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devid</span>		<span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">udma_enable</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="n">XFER_UDMA_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">udma</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">udma_timing</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ideconf</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">u_clock</span><span class="p">,</span> <span class="n">u_speed</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udma_enable</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * UDMA is handled by a combination of clock switching and</span>
<span class="cm">		 * selection of dividers</span>
<span class="cm">		 *</span>
<span class="cm">		 * Handy rule: Odd modes are UDMATIMx 01, even are 02</span>
<span class="cm">		 *	       except UDMA0 which is 00</span>
<span class="cm">		 */</span>
		<span class="n">u_speed</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">udma</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">udma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">udma</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">u_clock</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>	<span class="cm">/* 100Mhz */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">udma</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">u_clock</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 66Mhz */</span>
		<span class="k">else</span>
			<span class="n">u_clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* 33Mhz */</span>

		<span class="n">udma_enable</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devid</span><span class="p">);</span>

		<span class="cm">/* Load the CT/RP selection */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udma_timing</span><span class="p">);</span>
		<span class="n">udma_timing</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">devid</span><span class="p">));</span>
		<span class="n">udma_timing</span> <span class="o">|=</span> <span class="n">u_speed</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">devid</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span> <span class="n">udma_timing</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isich</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Select a 33/66/100Mhz clock */</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ideconf</span><span class="p">);</span>
			<span class="n">ideconf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1001</span> <span class="o">&lt;&lt;</span> <span class="n">devid</span><span class="p">);</span>
			<span class="n">ideconf</span> <span class="o">|=</span> <span class="n">u_clock</span> <span class="o">&lt;&lt;</span> <span class="n">devid</span><span class="p">;</span>
			<span class="cm">/* For ICH or later we should set bit 10 for better</span>
<span class="cm">			   performance (WR_PingPong_En) */</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="n">ideconf</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="n">udma_enable</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MWDMA is driven by the PIO timings. */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mwdma</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">-</span> <span class="n">XFER_MW_DMA_0</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">needed_pio</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">XFER_PIO_0</span><span class="p">,</span> <span class="n">XFER_PIO_3</span><span class="p">,</span> <span class="n">XFER_PIO_4</span>
		<span class="p">};</span>
		<span class="kt">int</span> <span class="n">pio</span> <span class="o">=</span> <span class="n">needed_pio</span><span class="p">[</span><span class="n">mwdma</span><span class="p">]</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>

		<span class="cm">/* XFER_PIO_0 is never used currently */</span>
		<span class="n">piix_set_timings</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="n">pio</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_set_dmamode - Initialize host controller PATA DMA timings</span>
<span class="cm"> *	@ap: Port whose timings we are configuring</span>
<span class="cm"> *	@adev: um</span>
<span class="cm"> *</span>
<span class="cm"> *	Set MW/UDMA mode for device, in host controller PCI config space.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None (inherited from caller).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_pata_set_dmamode</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ich_set_dmamode - Initialize host controller PATA DMA timings</span>
<span class="cm"> *	@ap: Port whose timings we are configuring</span>
<span class="cm"> *	@adev: um</span>
<span class="cm"> *</span>
<span class="cm"> *	Set MW/UDMA mode for device, in host controller PCI config space.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None (inherited from caller).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ich_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">do_pata_set_dmamode</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Serial ATA Index/Data Pair Superset Registers access</span>
<span class="cm"> *</span>
<span class="cm"> * Beginning from ICH8, there&#39;s a sane way to access SCRs using index</span>
<span class="cm"> * and data register pair located at BAR5 which means that we have</span>
<span class="cm"> * separate SCRs for master and slave.  This is handled using libata</span>
<span class="cm"> * slave_link facility.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">piix_sidx_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SCR_STATUS</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCR_ERROR</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">SCR_CONTROL</span><span class="p">]</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_sidpr_sel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">piix_sidx_map</span><span class="p">[</span><span class="n">reg</span><span class="p">],</span>
		  <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">sidpr</span> <span class="o">+</span> <span class="n">PIIX_SIDPR_IDX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_sidpr_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">piix_sidx_map</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">piix_sidpr_sel</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">sidpr</span> <span class="o">+</span> <span class="n">PIIX_SIDPR_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_sidpr_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">piix_sidx_map</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">piix_sidpr_sel</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">sidpr</span> <span class="o">+</span> <span class="n">PIIX_SIDPR_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_sidpr_set_lpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ata_lpm_policy</span> <span class="n">policy</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sata_link_scr_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">piix_irq_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">bmdma_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bmdma_status</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ATA_DMA_INTR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_broken_suspend</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">sysids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA M3&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TECRA M3&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA M3&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Tecra M3&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA M4&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Tecra M4&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA M4&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TECRA M4&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA M5&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TECRA M5&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA M6&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TECRA M6&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA M7&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TECRA M7&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;TECRA A8&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TECRA A8&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Satellite R20&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Satellite R20&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Satellite R25&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Satellite R25&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Satellite U200&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Satellite U200&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Satellite U200&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;SATELLITE U200&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Satellite Pro U200&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;SATELLITE PRO U200&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Satellite U205&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Satellite U205&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;SATELLITE U205&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;SATELLITE U205&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Satellite Pro A120&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Satellite Pro A120&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Portege M500&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;PORTEGE M500&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;VGN-BX297XP&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Sony Corporation&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;VGN-BX297XP&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>

		<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oemstrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Tecra M3,&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">sysids</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">oemstrs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmi_find_device</span><span class="p">(</span><span class="n">DMI_DEV_TYPE_OEM_STRING</span><span class="p">,</span> <span class="n">oemstrs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* TECRA M4 sometimes forgets its identify and reports bogus</span>
<span class="cm">	 * DMI information.  As the bogus information is a bit</span>
<span class="cm">	 * generic, match as many entries as possible.  This manual</span>
<span class="cm">	 * matching is necessary because dmi_system_id.matches is</span>
<span class="cm">	 * limited to four entries.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_match</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_match</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;000000&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_match</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">,</span> <span class="s">&quot;000000&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_match</span><span class="p">(</span><span class="n">DMI_PRODUCT_SERIAL</span><span class="p">,</span> <span class="s">&quot;000000&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_match</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;TOSHIBA&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_match</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;Portable PC&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_match</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;Version A0&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_pci_device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_host_suspend</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mesg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Some braindamaged ACPI suspend implementations expect the</span>
<span class="cm">	 * controller to be awake on entry; otherwise, it burns cpu</span>
<span class="cm">	 * cycles and power trying to do something to the sleeping</span>
<span class="cm">	 * beauty.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">piix_broken_suspend</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">PM_EVENT_SLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="cm">/* mark its power state as &quot;unknown&quot;, since we don&#39;t</span>
<span class="cm">		 * know if e.g. the BIOS will change its device state</span>
<span class="cm">		 * when we suspend.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">PCI_D0</span><span class="p">)</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">PCI_UNKNOWN</span><span class="p">;</span>

		<span class="cm">/* tell resume that it&#39;s waking up from broken suspend */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">PIIX_HOST_BROKEN_SUSPEND</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ata_pci_device_do_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mesg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_pci_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PIIX_HOST_BROKEN_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PIIX_HOST_BROKEN_SUSPEND</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

		<span class="cm">/* PCI device wasn&#39;t disabled during suspend.  Use</span>
<span class="cm">		 * pci_reenable_device() to avoid affecting the enable</span>
<span class="cm">		 * count.</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_reenable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to enable device after resume (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_device_do_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">piix_vmw_bmdma_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_bmdma_status</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ATA_DMA_ERR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AHCI_PCI_BAR 5</span>
<span class="cp">#define AHCI_GLOBAL_CTL 0x04</span>
<span class="cp">#define AHCI_ENABLE (1 &lt;&lt; 31)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">piix_disable_ahci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* BUG: pci_enable_device has not yet been called.  This</span>
<span class="cm">	 * works because this device is usually set up by BIOS.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">AHCI_PCI_BAR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">AHCI_PCI_BAR</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mmio</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">AHCI_PCI_BAR</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mmio</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">AHCI_GLOBAL_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AHCI_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHCI_ENABLE</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">AHCI_GLOBAL_CTL</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">AHCI_GLOBAL_CTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">AHCI_ENABLE</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mmio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_check_450nx_errata	-	Check for problem 450NX setup</span>
<span class="cm"> *	@ata_dev: the PCI device to check</span>
<span class="cm"> *</span>
<span class="cm"> *	Check for the present of 450NX errata #19 and errata #25. If</span>
<span class="cm"> *	they are found return an error code so we can turn off DMA</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">piix_check_450nx_errata</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">ata_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">no_piix_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_INTEL_82454NX</span><span class="p">,</span> <span class="n">pdev</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Look for 450NX PXB. Check for problem configurations</span>
<span class="cm">		   A PCI quirk checks bit 6 already */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
		<span class="cm">/* Only on the original revision: IDE DMA can hang */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span>
			<span class="n">no_piix_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* On all revisions below 5 PXB bus lock must be disabled for IDE */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">no_piix_dma</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_piix_dma</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ata_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;450NX errata present, disabling IDE DMA%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">no_piix_dma</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot; - a BIOS update may resolve this&quot;</span>
			 <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">no_piix_dma</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">piix_init_pcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="o">*</span><span class="n">map_db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">pcs</span><span class="p">,</span> <span class="n">new_pcs</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ICH5_PCS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcs</span><span class="p">);</span>

	<span class="n">new_pcs</span> <span class="o">=</span> <span class="n">pcs</span> <span class="o">|</span> <span class="n">map_db</span><span class="o">-&gt;</span><span class="n">port_enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_pcs</span> <span class="o">!=</span> <span class="n">pcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;updating PCS from 0x%x to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcs</span><span class="p">,</span> <span class="n">new_pcs</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ICH5_PCS</span><span class="p">,</span> <span class="n">new_pcs</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">__devinit</span> <span class="nf">piix_init_sata_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">pinfo</span><span class="p">,</span>
					       <span class="k">const</span> <span class="k">struct</span> <span class="n">piix_map_db</span> <span class="o">*</span><span class="n">map_db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">invalid_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">map_value</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ICH5_PMR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map_value</span><span class="p">);</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">map_db</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">map_value</span> <span class="o">&amp;</span> <span class="n">map_db</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">];</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAP [&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RV</span>:
			<span class="n">invalid_map</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; XX&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NA</span>:
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; --&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IDE</span>:
			<span class="n">WARN_ON</span><span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">IDE</span><span class="p">);</span>
			<span class="n">pinfo</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">piix_port_info</span><span class="p">[</span><span class="n">ich_pata_100</span><span class="p">];</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; IDE IDE&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; P%d&quot;</span><span class="p">,</span> <span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pinfo</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invalid_map</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid MAP value %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">map_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">map</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">piix_no_sidpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Samsung DB-P70 only has three ATA ports exposed and</span>
<span class="cm">	 * curiously the unconnected first port reports link online</span>
<span class="cm">	 * while not responding to SRST protocol causing excessive</span>
<span class="cm">	 * detection delay.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unfortunately, the system doesn&#39;t carry enough DMI</span>
<span class="cm">	 * information to identify the machine but does have subsystem</span>
<span class="cm">	 * vendor and device set.  As it&#39;s unclear whether the</span>
<span class="cm">	 * subsystem vendor/device is used only for this specific</span>
<span class="cm">	 * board, the port can&#39;t be disabled solely with the</span>
<span class="cm">	 * information; however, turning off SIDPR access works around</span>
<span class="cm">	 * the problem.  Turn it off.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This problem is reported in bnc#441240.</span>
<span class="cm">	 *</span>
<span class="cm">	 * https://bugzilla.novell.com/show_bug.cgi?id=441420</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_INTEL</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2920</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_SAMSUNG</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0xb049</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;Samsung DB-P70 detected, disabling SIDPR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">piix_init_sidpr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link0</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scontrol</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* check for availability */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">IDE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* is it blacklisted? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">piix_no_sidpr</span><span class="p">(</span><span class="n">host</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PIIX_FLAG_SIDPR</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PIIX_SIDPR_BAR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PIIX_SIDPR_BAR</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PIIX_SIDPR_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcim_iomap_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PIIX_SIDPR_BAR</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">sidpr</span> <span class="o">=</span> <span class="n">pcim_iomap_table</span><span class="p">(</span><span class="n">pdev</span><span class="p">)[</span><span class="n">PIIX_SIDPR_BAR</span><span class="p">];</span>

	<span class="cm">/* SCR access via SIDPR doesn&#39;t work on some configurations.</span>
<span class="cm">	 * Give it a test drive by inhibiting power save modes which</span>
<span class="cm">	 * we&#39;ll do anyway.</span>
<span class="cm">	 */</span>
	<span class="n">piix_sidpr_scr_read</span><span class="p">(</span><span class="n">link0</span><span class="p">,</span> <span class="n">SCR_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scontrol</span><span class="p">);</span>

	<span class="cm">/* if IPM is already 3, SCR access is probably working.  Don&#39;t</span>
<span class="cm">	 * un-inhibit power save modes as BIOS might have inhibited</span>
<span class="cm">	 * them for a reason.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scontrol</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scontrol</span> <span class="o">|=</span> <span class="mh">0x300</span><span class="p">;</span>
		<span class="n">piix_sidpr_scr_write</span><span class="p">(</span><span class="n">link0</span><span class="p">,</span> <span class="n">SCR_CONTROL</span><span class="p">,</span> <span class="n">scontrol</span><span class="p">);</span>
		<span class="n">piix_sidpr_scr_read</span><span class="p">(</span><span class="n">link0</span><span class="p">,</span> <span class="n">SCR_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scontrol</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">scontrol</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x300</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;SCR access via SIDPR is available but doesn&#39;t work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* okay, SCRs available, set ops and ask libata for slave_link */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sidpr_sata_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_slave_link_init</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_iocfg_bit18_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">sysids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="cm">/* Clevo M570U sets IOCFG bit 18 if the cdrom</span>
<span class="cm">			 * isn&#39;t used to boot the system which</span>
<span class="cm">			 * disables the channel.</span>
<span class="cm">			 */</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;M570U&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Clevo Co.&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;M570U&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>

		<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">sysids</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* The datasheet says that bit 18 is NOOP but certain systems</span>
<span class="cm">	 * seem to use it to disable a channel.  Clear the bit on the</span>
<span class="cm">	 * affected systems.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_iocfg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;applying IOCFG bit18 quirk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PIIX_IOCFG</span><span class="p">,</span>
				       <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_iocfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">piix_broken_system_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">broken_systems</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP Compaq 2510p&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq 2510p&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="cm">/* PCI slot number of the controller */</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x1FUL</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP Compaq nc6000&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq nc6000&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="cm">/* PCI slot number of the controller */</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x1FUL</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">dmi</span> <span class="o">=</span> <span class="n">dmi_first_match</span><span class="p">(</span><span class="n">broken_systems</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dmi</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
		<span class="cm">/* apply the quirk only to on-board controllers */</span>
		<span class="k">return</span> <span class="n">slot</span> <span class="o">==</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">prefer_ms_hyperv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">prefer_ms_hyperv</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_ignore_devices_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if IS_ENABLED(CONFIG_HYPERV_STORAGE)</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">ignore_hyperv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="cm">/* On Hyper-V hypervisors the disks are exposed on</span>
<span class="cm">			 * both the emulated SATA controller and on the</span>
<span class="cm">			 * paravirtualised drivers.  The CD/DVD devices</span>
<span class="cm">			 * are only exposed on the emulated controller.</span>
<span class="cm">			 * Request we ignore ATA devices on this host.</span>
<span class="cm">			 */</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Hyper-V Virtual Machine&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
						<span class="s">&quot;Microsoft Corporation&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Virtual Machine&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">dmi</span> <span class="o">=</span> <span class="n">dmi_first_match</span><span class="p">(</span><span class="n">ignore_hyperv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi</span> <span class="o">&amp;&amp;</span> <span class="n">prefer_ms_hyperv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_HOST_IGNORE_ATA</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s detected, ATA device ignore set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dmi</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	piix_init_one - Register PIIX ATA PCI device with kernel services</span>
<span class="cm"> *	@pdev: PCI device to register</span>
<span class="cm"> *	@ent: Entry in piix_pci_tbl matching with @pdev</span>
<span class="cm"> *</span>
<span class="cm"> *	Called from kernel PCI layer.  We probe for combined mode (sigh),</span>
<span class="cm"> *	and then hand over control to libata, for it to do the rest.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Inherited from PCI layer (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Zero on success, or -ERRNO value.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">piix_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">port_info</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">port_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="o">*</span><span class="n">sht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sht</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ata_print_version_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="cm">/* no hotplugging support for later devices (FIXME) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_module_init</span> <span class="o">&amp;&amp;</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&gt;=</span> <span class="n">ich5_sata</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">piix_broken_system_poweroff</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">piix_port_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
				<span class="n">ATA_FLAG_NO_POWEROFF_SPINDOWN</span> <span class="o">|</span>
					<span class="n">ATA_FLAG_NO_HIBERNATE_SPINDOWN</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;quirky BIOS, skipping spindown &quot;</span>
				<span class="s">&quot;on poweroff and hibernation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">piix_port_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>
	<span class="n">port_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">piix_port_info</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>

	<span class="n">port_flags</span> <span class="o">=</span> <span class="n">port_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* enable device and prepare host */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">hpriv</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hpriv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpriv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Save IOCFG, this will be used for cable detection, quirk</span>
<span class="cm">	 * detection and restoration on detach.  This is necessary</span>
<span class="cm">	 * because some ACPI implementations mess up cable related</span>
<span class="cm">	 * bits on _STM.  Reported on kernel bz#11879.</span>
<span class="cm">	 */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PIIX_IOCFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_iocfg</span><span class="p">);</span>

	<span class="cm">/* ICH6R may be driven by either ata_piix or ahci driver</span>
<span class="cm">	 * regardless of BIOS configuration.  Make sure AHCI mode is</span>
<span class="cm">	 * off.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_INTEL</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2652</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">piix_disable_ahci</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* SATA map init can change port_info, do it before prepping host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_SATA</span><span class="p">)</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="n">piix_init_sata_map</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">port_info</span><span class="p">,</span>
					<span class="n">piix_map_db_table</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_bmdma_prepare_host</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hpriv</span><span class="p">;</span>

	<span class="cm">/* initialize controller */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_SATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">piix_init_pcs</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">piix_map_db_table</span><span class="p">[</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">]);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">piix_init_sidpr</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">piix_sidpr_sata_ops</span><span class="p">)</span>
			<span class="n">sht</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">piix_sidpr_sht</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* apply IOCFG bit18 quirk */</span>
	<span class="n">piix_iocfg_bit18_quirk</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* On ICH5, some BIOSen disable the interrupt using the</span>
<span class="cm">	 * PCI_COMMAND_INTX_DISABLE bit added in PCI 2.3.</span>
<span class="cm">	 * On ICH6, this bit has the same effect, but only when</span>
<span class="cm">	 * MSI is disabled (and it is disabled, as we don&#39;t use</span>
<span class="cm">	 * message-signalled interrupts currently).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_flags</span> <span class="o">&amp;</span> <span class="n">PIIX_FLAG_CHECKINTR</span><span class="p">)</span>
		<span class="n">pci_intx</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">piix_check_450nx_errata</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This writes into the master table but it does not</span>
<span class="cm">		   really matter for this errata as we will apply it to</span>
<span class="cm">		   all the PIIX devices on the board */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_HOST_PARALLEL_SCAN</span><span class="p">;</span>

	<span class="cm">/* Allow hosts to specify device types to ignore when scanning. */</span>
	<span class="n">piix_ignore_devices_quirk</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ata_pci_sff_activate_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ata_bmdma_interrupt</span><span class="p">,</span> <span class="n">sht</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">piix_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">piix_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PIIX_IOCFG</span><span class="p">,</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_iocfg</span><span class="p">);</span>

	<span class="n">ata_pci_remove_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">piix_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pci_register_driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">in_module_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">piix_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">piix_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">piix_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">piix_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
