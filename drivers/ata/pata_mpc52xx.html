<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › pata_mpc52xx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pata_mpc52xx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/ata/pata_mpc52xx.c</span>
<span class="cm"> *</span>
<span class="cm"> * libata driver for the Freescale MPC52xx on-chip IDE interface</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Sylvain Munaut &lt;tnt@246tNt.com&gt;</span>
<span class="cm"> * Copyright (C) 2003 Mipsys - Benjamin Herrenschmidt</span>
<span class="cm"> *</span>
<span class="cm"> * UDMA support based on patches by Freescale (Bernard Kuhn, John Rigby),</span>
<span class="cm"> * Domen Puncer and Tim Yamin.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public License</span>
<span class="cm"> * version 2. This program is licensed &quot;as is&quot; without any warranty of any</span>
<span class="cm"> * kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/mpc52xx.h&gt;</span>

<span class="cp">#include &lt;sysdev/bestcomm/bestcomm.h&gt;</span>
<span class="cp">#include &lt;sysdev/bestcomm/bestcomm_priv.h&gt;</span>
<span class="cp">#include &lt;sysdev/bestcomm/ata.h&gt;</span>

<span class="cp">#define DRV_NAME	&quot;mpc52xx_ata&quot;</span>

<span class="cm">/* Private structures used by the driver */</span>
<span class="k">struct</span> <span class="n">mpc52xx_ata_timings</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">pio1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">pio2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">mdma1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">mdma2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">udma1</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">udma2</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">udma3</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">udma4</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">udma5</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">using_udma</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">ipb_period</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">ata_regs</span><span class="p">;</span>
	<span class="n">phys_addr_t</span>			<span class="n">ata_regs_pa</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">ata_irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_timings</span>	<span class="n">timings</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span>				<span class="n">csel</span><span class="p">;</span>

	<span class="cm">/* DMA */</span>
	<span class="k">struct</span> <span class="n">bcom_task</span>		<span class="o">*</span><span class="n">dmatsk</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">udmaspec</span>		<span class="o">*</span><span class="n">udmaspec</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mdmaspec</span>		<span class="o">*</span><span class="n">mdmaspec</span><span class="p">;</span>
	<span class="kt">int</span> 				<span class="n">mpc52xx_ata_dma_last_write</span><span class="p">;</span>
	<span class="kt">int</span>				<span class="n">waiting_for_dma</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* ATAPI-4 PIO specs (in ns) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ataspec_t0</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span><span class="mi">600</span><span class="p">,</span> <span class="mi">383</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">120</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ataspec_t1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="mi">70</span><span class="p">,</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">30</span><span class="p">,</span>  <span class="mi">25</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ataspec_t2_8</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span><span class="mi">290</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span>  <span class="mi">70</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ataspec_t2_16</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span><span class="mi">165</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span>  <span class="mi">70</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ataspec_t2i</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span>  <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">25</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ataspec_t4</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="mi">30</span><span class="p">,</span>  <span class="mi">20</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>  <span class="mi">10</span><span class="p">,</span>  <span class="mi">10</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">ataspec_ta</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="mi">35</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">35</span><span class="p">,</span>  <span class="mi">35</span><span class="p">};</span>

<span class="cp">#define CALC_CLKCYC(c,v) ((((v)+(c)-1)/(c)))</span>

<span class="cm">/* ======================================================================== */</span>

<span class="cm">/* ATAPI-4 MDMA specs (in clocks) */</span>
<span class="k">struct</span> <span class="n">mdmaspec</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">t0M</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">td</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">th</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tj</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tkw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tn</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdmaspec</span> <span class="n">mdmaspec66</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">t0M</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="p">.</span><span class="n">td</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">th</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tj</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tkw</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">tn</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">t0M</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">td</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">th</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tkw</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tn</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">t0M</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">td</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">th</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tkw</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tn</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mdmaspec</span> <span class="n">mdmaspec132</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">t0M</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="p">.</span><span class="n">td</span> <span class="o">=</span> <span class="mi">29</span><span class="p">,</span> <span class="p">.</span><span class="n">th</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">tj</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">tkw</span> <span class="o">=</span> <span class="mi">29</span><span class="p">,</span> <span class="p">.</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">tn</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">t0M</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">td</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">th</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tkw</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">tn</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">t0M</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">td</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">th</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tkw</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">tn</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ATAPI-4 UDMA specs (in clocks) */</span>
<span class="k">struct</span> <span class="n">udmaspec</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">tcyc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">t2cyc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tds</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tdh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tdvs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tdvh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tfs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tli</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmli</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">taz</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tzah</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tenv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tsr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">trfs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">trp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tack</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tss</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">udmaspec</span> <span class="n">udmaspec66</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>  <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>  <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">udmaspec</span> <span class="n">udmaspec132</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">31</span><span class="p">,</span> <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">22</span><span class="p">,</span> <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span> <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">27</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">17</span><span class="p">,</span> <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">23</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">tcyc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">t2cyc</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>  <span class="p">.</span><span class="n">tds</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdh</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">tdvs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="p">.</span><span class="n">tdvh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tfs</span>  <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">tli</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">tmli</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">taz</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">tzah</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">tenv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">tsr</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">.</span><span class="n">trfs</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>  <span class="p">.</span><span class="n">trp</span>  <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">tack</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">tss</span>  <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ======================================================================== */</span>

<span class="cm">/* Bit definitions inside the registers */</span>
<span class="cp">#define MPC52xx_ATA_HOSTCONF_SMR	0x80000000UL </span><span class="cm">/* State machine reset */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_HOSTCONF_FR		0x40000000UL </span><span class="cm">/* FIFO Reset */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_HOSTCONF_IE		0x02000000UL </span><span class="cm">/* Enable interrupt in PIO */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_HOSTCONF_IORDY	0x01000000UL </span><span class="cm">/* Drive supports IORDY protocol */</span><span class="cp"></span>

<span class="cp">#define MPC52xx_ATA_HOSTSTAT_TIP	0x80000000UL </span><span class="cm">/* Transaction in progress */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_HOSTSTAT_UREP	0x40000000UL </span><span class="cm">/* UDMA Read Extended Pause */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_HOSTSTAT_RERR	0x02000000UL </span><span class="cm">/* Read Error */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_HOSTSTAT_WERR	0x01000000UL </span><span class="cm">/* Write Error */</span><span class="cp"></span>

<span class="cp">#define MPC52xx_ATA_FIFOSTAT_EMPTY	0x01 </span><span class="cm">/* FIFO Empty */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_FIFOSTAT_ERROR	0x40 </span><span class="cm">/* FIFO Error */</span><span class="cp"></span>

<span class="cp">#define MPC52xx_ATA_DMAMODE_WRITE	0x01 </span><span class="cm">/* Write DMA */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_DMAMODE_READ	0x02 </span><span class="cm">/* Read DMA */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_DMAMODE_UDMA	0x04 </span><span class="cm">/* UDMA enabled */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_DMAMODE_IE		0x08 </span><span class="cm">/* Enable drive interrupt to CPU in DMA mode */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_DMAMODE_FE		0x10 </span><span class="cm">/* FIFO Flush enable in Rx mode */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_DMAMODE_FR		0x20 </span><span class="cm">/* FIFO Reset */</span><span class="cp"></span>
<span class="cp">#define MPC52xx_ATA_DMAMODE_HUT		0x40 </span><span class="cm">/* Host UDMA burst terminate */</span><span class="cp"></span>

<span class="cp">#define MAX_DMA_BUFFERS 128</span>
<span class="cp">#define MAX_DMA_BUFFER_SIZE 0x20000u</span>

<span class="cm">/* Structure of the hardware registers */</span>
<span class="k">struct</span> <span class="n">mpc52xx_ata</span> <span class="p">{</span>

	<span class="cm">/* Host interface registers */</span>
	<span class="n">u32</span> <span class="n">config</span><span class="p">;</span>		<span class="cm">/* ATA + 0x00 Host configuration */</span>
	<span class="n">u32</span> <span class="n">host_status</span><span class="p">;</span>	<span class="cm">/* ATA + 0x04 Host controller status */</span>
	<span class="n">u32</span> <span class="n">pio1</span><span class="p">;</span>		<span class="cm">/* ATA + 0x08 PIO Timing 1 */</span>
	<span class="n">u32</span> <span class="n">pio2</span><span class="p">;</span>		<span class="cm">/* ATA + 0x0c PIO Timing 2 */</span>
	<span class="n">u32</span> <span class="n">mdma1</span><span class="p">;</span>		<span class="cm">/* ATA + 0x10 MDMA Timing 1 */</span>
	<span class="n">u32</span> <span class="n">mdma2</span><span class="p">;</span>		<span class="cm">/* ATA + 0x14 MDMA Timing 2 */</span>
	<span class="n">u32</span> <span class="n">udma1</span><span class="p">;</span>		<span class="cm">/* ATA + 0x18 UDMA Timing 1 */</span>
	<span class="n">u32</span> <span class="n">udma2</span><span class="p">;</span>		<span class="cm">/* ATA + 0x1c UDMA Timing 2 */</span>
	<span class="n">u32</span> <span class="n">udma3</span><span class="p">;</span>		<span class="cm">/* ATA + 0x20 UDMA Timing 3 */</span>
	<span class="n">u32</span> <span class="n">udma4</span><span class="p">;</span>		<span class="cm">/* ATA + 0x24 UDMA Timing 4 */</span>
	<span class="n">u32</span> <span class="n">udma5</span><span class="p">;</span>		<span class="cm">/* ATA + 0x28 UDMA Timing 5 */</span>
	<span class="n">u32</span> <span class="n">share_cnt</span><span class="p">;</span>		<span class="cm">/* ATA + 0x2c ATA share counter */</span>
	<span class="n">u32</span> <span class="n">reserved0</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* FIFO registers */</span>
	<span class="n">u32</span> <span class="n">fifo_data</span><span class="p">;</span>		<span class="cm">/* ATA + 0x3c */</span>
	<span class="n">u8</span>  <span class="n">fifo_status_frame</span><span class="p">;</span>	<span class="cm">/* ATA + 0x40 */</span>
	<span class="n">u8</span>  <span class="n">fifo_status</span><span class="p">;</span>	<span class="cm">/* ATA + 0x41 */</span>
	<span class="n">u16</span> <span class="n">reserved7</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">fifo_control</span><span class="p">;</span>	<span class="cm">/* ATA + 0x44 */</span>
	<span class="n">u8</span>  <span class="n">reserved8</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">fifo_alarm</span><span class="p">;</span>		<span class="cm">/* ATA + 0x4a */</span>
	<span class="n">u16</span> <span class="n">reserved9</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fifo_rdp</span><span class="p">;</span>		<span class="cm">/* ATA + 0x4e */</span>
	<span class="n">u16</span> <span class="n">reserved10</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fifo_wrp</span><span class="p">;</span>		<span class="cm">/* ATA + 0x52 */</span>
	<span class="n">u16</span> <span class="n">reserved11</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fifo_lfrdp</span><span class="p">;</span>		<span class="cm">/* ATA + 0x56 */</span>
	<span class="n">u16</span> <span class="n">reserved12</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fifo_lfwrp</span><span class="p">;</span>		<span class="cm">/* ATA + 0x5a */</span>

	<span class="cm">/* Drive TaskFile registers */</span>
	<span class="n">u8</span>  <span class="n">tf_control</span><span class="p">;</span>		<span class="cm">/* ATA + 0x5c TASKFILE Control/Alt Status */</span>
	<span class="n">u8</span>  <span class="n">reserved13</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">tf_data</span><span class="p">;</span>		<span class="cm">/* ATA + 0x60 TASKFILE Data */</span>
	<span class="n">u16</span> <span class="n">reserved14</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">tf_features</span><span class="p">;</span>	<span class="cm">/* ATA + 0x64 TASKFILE Features/Error */</span>
	<span class="n">u8</span>  <span class="n">reserved15</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">tf_sec_count</span><span class="p">;</span>	<span class="cm">/* ATA + 0x68 TASKFILE Sector Count */</span>
	<span class="n">u8</span>  <span class="n">reserved16</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">tf_sec_num</span><span class="p">;</span>		<span class="cm">/* ATA + 0x6c TASKFILE Sector Number */</span>
	<span class="n">u8</span>  <span class="n">reserved17</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">tf_cyl_low</span><span class="p">;</span>		<span class="cm">/* ATA + 0x70 TASKFILE Cylinder Low */</span>
	<span class="n">u8</span>  <span class="n">reserved18</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">tf_cyl_high</span><span class="p">;</span>	<span class="cm">/* ATA + 0x74 TASKFILE Cylinder High */</span>
	<span class="n">u8</span>  <span class="n">reserved19</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">tf_dev_head</span><span class="p">;</span>	<span class="cm">/* ATA + 0x78 TASKFILE Device/Head */</span>
	<span class="n">u8</span>  <span class="n">reserved20</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u8</span>  <span class="n">tf_command</span><span class="p">;</span>		<span class="cm">/* ATA + 0x7c TASKFILE Command/Status */</span>
	<span class="n">u8</span>  <span class="n">dma_mode</span><span class="p">;</span>		<span class="cm">/* ATA + 0x7d ATA Host DMA Mode configuration */</span>
	<span class="n">u8</span>  <span class="n">reserved21</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>


<span class="cm">/* ======================================================================== */</span>
<span class="cm">/* Aux fns                                                                  */</span>
<span class="cm">/* ======================================================================== */</span>


<span class="cm">/* MPC52xx low level hw control */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_compute_pio_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_timings</span> <span class="o">*</span><span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipb_period</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ipb_period</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">t0</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2_8</span><span class="p">,</span> <span class="n">t2_16</span><span class="p">,</span> <span class="n">t2i</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="n">ta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pio</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">t0</span>	<span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ataspec_t0</span><span class="p">[</span><span class="n">pio</span><span class="p">]);</span>
	<span class="n">t1</span>	<span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ataspec_t1</span><span class="p">[</span><span class="n">pio</span><span class="p">]);</span>
	<span class="n">t2_8</span>	<span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ataspec_t2_8</span><span class="p">[</span><span class="n">pio</span><span class="p">]);</span>
	<span class="n">t2_16</span>	<span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ataspec_t2_16</span><span class="p">[</span><span class="n">pio</span><span class="p">]);</span>
	<span class="n">t2i</span>	<span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ataspec_t2i</span><span class="p">[</span><span class="n">pio</span><span class="p">]);</span>
	<span class="n">t4</span>	<span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ataspec_t4</span><span class="p">[</span><span class="n">pio</span><span class="p">]);</span>
	<span class="n">ta</span>	<span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">ataspec_ta</span><span class="p">[</span><span class="n">pio</span><span class="p">]);</span>

	<span class="n">timing</span><span class="o">-&gt;</span><span class="n">pio1</span> <span class="o">=</span> <span class="p">(</span><span class="n">t0</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t2_8</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t2_16</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t2i</span><span class="p">);</span>
	<span class="n">timing</span><span class="o">-&gt;</span><span class="n">pio2</span> <span class="o">=</span> <span class="p">(</span><span class="n">t4</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ta</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_compute_mdma_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_timings</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mdmaspec</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdmaspec</span><span class="p">[</span><span class="n">speed</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">mdma1</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">t0M</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">td</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tkw</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tm</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">mdma2</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">th</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tj</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">using_udma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_compute_udma_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_timings</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">udmaspec</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udmaspec</span><span class="p">[</span><span class="n">speed</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">udma1</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">t2cyc</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tcyc</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tds</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tdh</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">udma2</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tdvs</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tdvh</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tfs</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tli</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">udma3</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tmli</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">taz</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tenv</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tsr</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">udma4</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tss</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">trfs</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">trp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">tack</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">udma5</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">tzah</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">using_udma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpc52xx_ata_apply_timings</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_timings</span> <span class="o">*</span><span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">device</span><span class="p">];</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pio1</span><span class="p">,</span>  <span class="n">timing</span><span class="o">-&gt;</span><span class="n">pio1</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">pio2</span><span class="p">,</span>  <span class="n">timing</span><span class="o">-&gt;</span><span class="n">pio2</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdma1</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">mdma1</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">mdma2</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">mdma2</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">udma1</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">udma1</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">udma2</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">udma2</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">udma3</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">udma3</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">udma4</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">udma4</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">udma5</span><span class="p">,</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">udma5</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">csel</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tslot</span><span class="p">;</span>

	<span class="cm">/* Clear share_cnt (all sample code do this ...) */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">share_cnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Configure and reset host */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
			<span class="n">MPC52xx_ATA_HOSTCONF_IE</span> <span class="o">|</span>
			<span class="n">MPC52xx_ATA_HOSTCONF_IORDY</span> <span class="o">|</span>
			<span class="n">MPC52xx_ATA_HOSTCONF_SMR</span> <span class="o">|</span>
			<span class="n">MPC52xx_ATA_HOSTCONF_FR</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
			<span class="n">MPC52xx_ATA_HOSTCONF_IE</span> <span class="o">|</span>
			<span class="n">MPC52xx_ATA_HOSTCONF_IORDY</span><span class="p">);</span>

	<span class="cm">/* Set the time slot to 1us */</span>
	<span class="n">tslot</span> <span class="o">=</span> <span class="n">CALC_CLKCYC</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ipb_period</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">share_cnt</span><span class="p">,</span> <span class="n">tslot</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Init timings to PIO0 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata_timings</span><span class="p">));</span>

	<span class="n">mpc52xx_ata_compute_pio_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpc52xx_ata_compute_pio_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mpc52xx_ata_apply_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ======================================================================== */</span>
<span class="cm">/* libata driver                                                            */</span>
<span class="cm">/* ======================================================================== */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpc52xx_ata_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pio</span><span class="p">,</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">pio</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">mpc52xx_ata_compute_pio_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="n">pio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error: invalid PIO mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pio</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpc52xx_ata_apply_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpc52xx_ata_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">&gt;=</span> <span class="n">XFER_UDMA_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span><span class="p">;</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">mpc52xx_ata_compute_udma_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">-</span> <span class="n">XFER_MW_DMA_0</span><span class="p">;</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">mpc52xx_ata_compute_mdma_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Trying to select invalid DMA mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpc52xx_ata_apply_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpc52xx_ata_dev_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">csel</span><span class="p">)</span>
		<span class="n">mpc52xx_ata_apply_timings</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="n">ata_sff_dev_select</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_build_dmatable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcom_ata_bd</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">),</span> <span class="n">si</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span>
		<span class="n">bcom_ata_rx_prepare</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">bcom_ata_tx_prepare</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">cur_addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">cur_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">cur_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tc</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cur_len</span><span class="p">,</span> <span class="n">MAX_DMA_BUFFER_SIZE</span><span class="p">);</span>
			<span class="n">bd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bcom_ata_bd</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">bcom_prepare_next_buffer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">tc</span><span class="p">;</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">src_pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs_pa</span> <span class="o">+</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata</span><span class="p">,</span> <span class="n">fifo_data</span><span class="p">);</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">dst_pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cur_addr</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">tc</span><span class="p">;</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">src_pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">cur_addr</span><span class="p">;</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">dst_pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">u32</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs_pa</span> <span class="o">+</span>
					<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mpc52xx_ata</span><span class="p">,</span> <span class="n">fifo_data</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">bcom_submit_next_buffer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

			<span class="n">cur_addr</span> <span class="o">+=</span> <span class="n">tc</span><span class="p">;</span>
			<span class="n">cur_len</span> <span class="o">-=</span> <span class="n">tc</span><span class="p">;</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_DMA_BUFFERS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_alert</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma table&quot;</span>
					<span class="s">&quot;too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">use_pio_instead</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">use_pio_instead:</span>
	<span class="n">bcom_ata_reset_bd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpc52xx_bmdma_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">dma_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mpc52xx_ata_build_dmatable</span><span class="p">(</span><span class="n">qc</span><span class="p">))</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: %i, return 1?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>

	<span class="cm">/* Check FIFO is OK... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_ATA_FIFOSTAT_ERROR</span><span class="p">)</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: FIFO error detected: 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_mode</span> <span class="o">=</span> <span class="n">MPC52xx_ATA_DMAMODE_IE</span> <span class="o">|</span> <span class="n">MPC52xx_ATA_DMAMODE_READ</span> <span class="o">|</span>
				<span class="n">MPC52xx_ATA_DMAMODE_FE</span><span class="p">;</span>

		<span class="cm">/* Setup FIFO if direction changed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpc52xx_ata_dma_last_write</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpc52xx_ata_dma_last_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Configure FIFO with granularity to 7 */</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fifo_control</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fifo_alarm</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

			<span class="cm">/* Set FIFO Reset bit (FR) */</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="n">MPC52xx_ATA_DMAMODE_FR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_mode</span> <span class="o">=</span> <span class="n">MPC52xx_ATA_DMAMODE_IE</span> <span class="o">|</span> <span class="n">MPC52xx_ATA_DMAMODE_WRITE</span><span class="p">;</span>

		<span class="cm">/* Setup FIFO if direction changed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpc52xx_ata_dma_last_write</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpc52xx_ata_dma_last_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Configure FIFO with granularity to 4 */</span>
			<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fifo_control</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">out_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">fifo_alarm</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timings</span><span class="p">[</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">].</span><span class="n">using_udma</span><span class="p">)</span>
		<span class="n">dma_mode</span> <span class="o">|=</span> <span class="n">MPC52xx_ATA_DMAMODE_UDMA</span><span class="p">;</span>

	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="n">dma_mode</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="n">ATA_DMA_ACTIVE</span><span class="p">;</span>

	<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_exec_command</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpc52xx_bmdma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">bcom_set_task_auto_start</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="o">-&gt;</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="o">-&gt;</span><span class="n">tasknum</span><span class="p">);</span>
	<span class="n">bcom_enable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mpc52xx_bmdma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">bcom_disable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>
	<span class="n">bcom_ata_reset_bd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check FIFO is OK... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_ATA_FIFOSTAT_ERROR</span><span class="p">)</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: FIFO error detected: 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">mpc52xx_bmdma_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* Check FIFO is OK... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MPC52xx_ATA_FIFOSTAT_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_alert</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: FIFO error detected: 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">|</span> <span class="n">ATA_DMA_ERR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">mpc52xx_ata_task_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">vpriv</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bcom_buffer_done</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">))</span>
		<span class="n">bcom_retrieve_buffer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">waiting_for_dma</span> <span class="o">|=</span> <span class="n">ATA_DMA_INTR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">mpc52xx_ata_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_PIO_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">mpc52xx_ata_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_bmdma_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_dev_select</span>		<span class="o">=</span> <span class="n">mpc52xx_ata_dev_select</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>		<span class="o">=</span> <span class="n">mpc52xx_ata_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>		<span class="o">=</span> <span class="n">mpc52xx_ata_set_dmamode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmdma_setup</span>		<span class="o">=</span> <span class="n">mpc52xx_bmdma_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmdma_start</span>		<span class="o">=</span> <span class="n">mpc52xx_bmdma_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmdma_stop</span>		<span class="o">=</span> <span class="n">mpc52xx_bmdma_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bmdma_status</span>		<span class="o">=</span> <span class="n">mpc52xx_bmdma_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_prep</span>		<span class="o">=</span> <span class="n">ata_noop_qc_prep</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">mpc52xx_ata_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">raw_ata_regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mwdma_mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">udma_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_ioports</span> <span class="o">*</span><span class="n">aio</span><span class="p">;</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">ata_host_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">|=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pio_mask</span>		<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span>		<span class="o">=</span> <span class="n">mwdma_mask</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">udma_mask</span>		<span class="o">=</span> <span class="n">udma_mask</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">mpc52xx_ata_port_ops</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span>	<span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">aio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">cmd_addr</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* Don&#39;t have a classic reg block */</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">altstatus_addr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_control</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">ctl_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_control</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">data_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_data</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">error_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_features</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">feature_addr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_features</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">nsect_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_sec_count</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">lbal_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_sec_num</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">lbam_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_cyl_low</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">lbah_addr</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_cyl_high</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">device_addr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_dev_head</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">status_addr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_command</span><span class="p">;</span>
	<span class="n">aio</span><span class="o">-&gt;</span><span class="n">command_addr</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span><span class="o">-&gt;</span><span class="n">tf_command</span><span class="p">;</span>

	<span class="n">ata_port_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;ata_regs 0x%lx&quot;</span><span class="p">,</span> <span class="n">raw_ata_regs</span><span class="p">);</span>

	<span class="cm">/* activate host */</span>
	<span class="k">return</span> <span class="n">ata_host_activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_irq</span><span class="p">,</span> <span class="n">ata_bmdma_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">mpc52xx_ata_sht</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span>
<span class="nf">mpc52xx_ata_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">ata_host_detach</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ======================================================================== */</span>
<span class="cm">/* OF Platform driver                                                       */</span>
<span class="cm">/* ======================================================================== */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">mpc52xx_ata_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ipb_freq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ata_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ata_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">task_irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mwdma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">udma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">proplen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bcom_task</span> <span class="o">*</span><span class="n">dmatsk</span><span class="p">;</span>

	<span class="cm">/* Get ipb frequency */</span>
	<span class="n">ipb_freq</span> <span class="o">=</span> <span class="n">mpc5xxx_get_bus_frequency</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipb_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not determine IPB bus frequency</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get device base address from device tree, request the region</span>
<span class="cm">	 * and ioremap it. */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">of_address_to_resource</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not determine device base address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res_mem</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ata_regs</span><span class="p">),</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error requesting register region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ata_regs</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res_mem</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ata_regs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error mapping device registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * By default, all DMA modes are disabled for the MPC5200.  Some</span>
<span class="cm">	 * boards don&#39;t have the required signals routed to make DMA work.</span>
<span class="cm">	 * Also, the MPC5200B has a silicon bug that causes data corruption</span>
<span class="cm">	 * with UDMA if it is used at the same time as the LocalPlus bus.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Instead of trying to guess what modes are usable, check the</span>
<span class="cm">	 * ATA device tree node to find out what DMA modes work on the board.</span>
<span class="cm">	 * UDMA/MWDMA modes can also be forced by adding &quot;libata.force=&lt;mode&gt;&quot;</span>
<span class="cm">	 * to the kernel boot parameters.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The MPC5200 ATA controller supports MWDMA modes 0, 1 and 2 and</span>
<span class="cm">	 * UDMA modes 0, 1 and 2.</span>
<span class="cm">	 */</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;mwdma-mode&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proplen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">prop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">proplen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">prop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;udma-mode&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proplen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">prop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">proplen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA2</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">prop</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ata_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error mapping irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prepare our private structure */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error allocating private structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ipb_period</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="p">(</span><span class="n">ipb_freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs</span> <span class="o">=</span> <span class="n">ata_regs</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_regs_pa</span> <span class="o">=</span> <span class="n">res_mem</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_irq</span> <span class="o">=</span> <span class="n">ata_irq</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">csel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mpc52xx_ata_dma_last_write</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ipb_freq</span><span class="o">/</span><span class="mi">1000000</span> <span class="o">==</span> <span class="mi">66</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdmaspec</span> <span class="o">=</span> <span class="n">mdmaspec66</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">udmaspec</span> <span class="o">=</span> <span class="n">udmaspec66</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mdmaspec</span> <span class="o">=</span> <span class="n">mdmaspec132</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">udmaspec</span> <span class="o">=</span> <span class="n">udmaspec132</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a BestComm task for DMA */</span>
	<span class="n">dmatsk</span> <span class="o">=</span> <span class="n">bcom_ata_init</span><span class="p">(</span><span class="n">MAX_DMA_BUFFERS</span><span class="p">,</span> <span class="n">MAX_DMA_BUFFER_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmatsk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bestcomm initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">task_irq</span> <span class="o">=</span> <span class="n">bcom_get_task_irq</span><span class="p">(</span><span class="n">dmatsk</span><span class="p">);</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">devm_request_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">task_irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mpc52xx_ata_task_irq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="s">&quot;ATA task&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error requesting DMA IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span> <span class="o">=</span> <span class="n">dmatsk</span><span class="p">;</span>

	<span class="cm">/* Init the hw */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">mpc52xx_ata_hw_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error initializing hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register ourselves to libata */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">mpc52xx_ata_init_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">res_mem</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
				  <span class="n">mwdma_mask</span><span class="p">,</span> <span class="n">udma_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error registering with ATA layer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err2:</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">task_irq</span><span class="p">);</span>
	<span class="n">bcom_ata_release</span><span class="p">(</span><span class="n">dmatsk</span><span class="p">);</span>
 <span class="nl">err1:</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">ata_irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">task_irq</span><span class="p">;</span>

	<span class="cm">/* Deregister the ATA interface */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">mpc52xx_ata_remove_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Clean up DMA */</span>
	<span class="n">task_irq</span> <span class="o">=</span> <span class="n">bcom_get_task_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">task_irq</span><span class="p">);</span>
	<span class="n">bcom_ata_release</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dmatsk</span><span class="p">);</span>
	<span class="n">irq_dispose_mapping</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ata_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_host_suspend</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mpc52xx_ata_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mpc52xx_ata_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">mpc52xx_ata_hw_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error initializing hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">mpc52xx_ata_of_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,mpc5200-ata&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;mpc5200-ata&quot;</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">mpc52xx_ata_of_platform_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mpc52xx_ata_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">mpc52xx_ata_remove</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">mpc52xx_ata_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">mpc52xx_ata_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">mpc52xx_ata_of_match</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">mpc52xx_ata_of_platform_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sylvain Munaut &lt;tnt@246tNt.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Freescale MPC52xx IDE/ATA libata driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">mpc52xx_ata_of_match</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
