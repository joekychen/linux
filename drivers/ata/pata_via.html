<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › pata_via.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pata_via.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * pata_via.c 	- VIA PATA for new ATA layer</span>
<span class="cm"> *			  (C) 2005-2006 Red Hat Inc</span>
<span class="cm"> *</span>
<span class="cm"> *  Documentation</span>
<span class="cm"> *	Most chipset documentation available under NDA only</span>
<span class="cm"> *</span>
<span class="cm"> *  VIA version guide</span>
<span class="cm"> *	VIA VT82C561	-	early design, uses ata_generic currently</span>
<span class="cm"> *	VIA VT82C576	-	MWDMA, 33Mhz</span>
<span class="cm"> *	VIA VT82C586	-	MWDMA, 33Mhz</span>
<span class="cm"> *	VIA VT82C586a	-	Added UDMA to 33Mhz</span>
<span class="cm"> *	VIA VT82C586b	-	UDMA33</span>
<span class="cm"> *	VIA VT82C596a	-	Nonfunctional UDMA66</span>
<span class="cm"> *	VIA VT82C596b	-	Working UDMA66</span>
<span class="cm"> *	VIA VT82C686	-	Nonfunctional UDMA66</span>
<span class="cm"> *	VIA VT82C686a	-	Working UDMA66</span>
<span class="cm"> *	VIA VT82C686b	-	Updated to UDMA100</span>
<span class="cm"> *	VIA VT8231	-	UDMA100</span>
<span class="cm"> *	VIA VT8233	-	UDMA100</span>
<span class="cm"> *	VIA VT8233a	-	UDMA133</span>
<span class="cm"> *	VIA VT8233c	-	UDMA100</span>
<span class="cm"> *	VIA VT8235	-	UDMA133</span>
<span class="cm"> *	VIA VT8237	-	UDMA133</span>
<span class="cm"> *	VIA VT8237A	-	UDMA133</span>
<span class="cm"> *	VIA VT8237S	-	UDMA133</span>
<span class="cm"> *	VIA VT8251	-	UDMA133</span>
<span class="cm"> *</span>
<span class="cm"> *	Most registers remain compatible across chips. Others start reserved</span>
<span class="cm"> *	and acquire sensible semantics if set to 1 (eg cable detect). A few</span>
<span class="cm"> *	exceptions exist, notably around the FIFO settings.</span>
<span class="cm"> *</span>
<span class="cm"> *	One additional quirk of the VIA design is that like ALi they use few</span>
<span class="cm"> *	PCI IDs for a lot of chips.</span>
<span class="cm"> *</span>
<span class="cm"> *	Based heavily on:</span>
<span class="cm"> *</span>
<span class="cm"> * Version 3.38</span>
<span class="cm"> *</span>
<span class="cm"> * VIA IDE driver for Linux. Supported southbridges:</span>
<span class="cm"> *</span>
<span class="cm"> *   vt82c576, vt82c586, vt82c586a, vt82c586b, vt82c596a, vt82c596b,</span>
<span class="cm"> *   vt82c686, vt82c686a, vt82c686b, vt8231, vt8233, vt8233c, vt8233a,</span>
<span class="cm"> *   vt8235, vt8237</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000-2002 Vojtech Pavlik</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the work of:</span>
<span class="cm"> *	Michel Aubry</span>
<span class="cm"> *	Jeff Garzik</span>
<span class="cm"> *	Andre Hedrick</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;pata_via&quot;</span>
<span class="cp">#define DRV_VERSION &quot;0.3.4&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VIA_BAD_PREQ</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span> <span class="cm">/* Crashes if PREQ# till DDACK# set */</span>
	<span class="n">VIA_BAD_CLK66</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* 66 MHz clock doesn&#39;t work correctly */</span>
	<span class="n">VIA_SET_FIFO</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span> <span class="cm">/* Needs to have FIFO split set */</span>
	<span class="n">VIA_NO_UNMASK</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span> <span class="cm">/* Doesn&#39;t work with IRQ unmasking on */</span>
	<span class="n">VIA_BAD_ID</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* Has wrong vendor ID (0x1107) */</span>
	<span class="n">VIA_BAD_AST</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span> <span class="cm">/* Don&#39;t touch Address Setup Timing */</span>
	<span class="n">VIA_NO_ENABLES</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="cm">/* Has no enablebits */</span>
	<span class="n">VIA_SATA_PATA</span>	<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="cm">/* SATA/PATA combined configuration */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">VIA_IDFLAG_SINGLE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* single channel controller) */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * VIA SouthBridge chips.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rev_min</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rev_max</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">udma_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">via_isa_bridges</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;vx855&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_VX855</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="o">|</span> <span class="n">VIA_SATA_PATA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vx800&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_VX800</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="o">|</span> <span class="n">VIA_SATA_PATA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8261&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8261</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8237s&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8237S</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8251&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8251</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;cx700&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_CX700</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="o">|</span> <span class="n">VIA_SATA_PATA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt6410&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_6410</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="o">|</span> <span class="n">VIA_NO_ENABLES</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt6415&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_6415</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="o">|</span> <span class="n">VIA_NO_ENABLES</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8237a&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8237A</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8237&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8237</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8235&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8235</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8233a&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8233A</span><span class="p">,</span>    <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8233c&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8233C_0</span><span class="p">,</span>  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA5</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8233&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8233_0</span><span class="p">,</span>   <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA5</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt8231&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_8231</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA5</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c686b&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C686</span><span class="p">,</span>   <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="n">ATA_UDMA5</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c686a&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C686</span><span class="p">,</span>   <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c686&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C686</span><span class="p">,</span>   <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">,</span> <span class="n">VIA_BAD_CLK66</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c596b&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C596</span><span class="p">,</span>   <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c596a&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C596</span><span class="p">,</span>   <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">,</span> <span class="n">VIA_BAD_CLK66</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c586b&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C586_0</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">,</span> <span class="n">VIA_SET_FIFO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c586b&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C586_0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">,</span> <span class="n">VIA_SET_FIFO</span> <span class="o">|</span> <span class="n">VIA_BAD_PREQ</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c586b&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C586_0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">,</span> <span class="n">VIA_SET_FIFO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c586a&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C586_0</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">,</span> <span class="n">VIA_SET_FIFO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c586&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C586_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>      <span class="mh">0x00</span><span class="p">,</span> <span class="n">VIA_SET_FIFO</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c576&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C576</span><span class="p">,</span>   <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span>      <span class="mh">0x00</span><span class="p">,</span> <span class="n">VIA_SET_FIFO</span> <span class="o">|</span> <span class="n">VIA_NO_UNMASK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vt82c576&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_82C576</span><span class="p">,</span>   <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span>      <span class="mh">0x00</span><span class="p">,</span> <span class="n">VIA_SET_FIFO</span> <span class="o">|</span> <span class="n">VIA_NO_UNMASK</span> <span class="o">|</span> <span class="n">VIA_BAD_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;vtxxxx&quot;</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_VIA_ANON</span><span class="p">,</span>     <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="n">ATA_UDMA6</span><span class="p">,</span> <span class="n">VIA_BAD_AST</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">no_atapi_dma_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;AVERATEC 3200&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;AVERATEC&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;3200&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">via_port</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">cached_device</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Cable special cases</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">cable_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Ferrari 3400&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer,Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;Ferrari 3400&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_cable_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Systems by DMI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">cable_dmi_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Arima W730-K8/Targa Visionary 811/... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x161F</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x2032</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	via_cable_detect	-	cable detection</span>
<span class="cm"> *	@ap: ATA port</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform cable detection. Actually for the VIA case the BIOS</span>
<span class="cm"> *	already did this for us. We read the values provided by the</span>
<span class="cm"> *	BIOS. If you are using an 8235 in a non-PC configuration you</span>
<span class="cm"> *	may need to update this code.</span>
<span class="cm"> *</span>
<span class="cm"> *	Hotplug also impacts on this.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_cable_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">ata66</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">via_cable_override</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA40_SHORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_SATA_PATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ATA_CBL_SATA</span><span class="p">;</span>

	<span class="cm">/* Early chips are 40 wire */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">&lt;</span> <span class="n">ATA_UDMA4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA40</span><span class="p">;</span>
	<span class="cm">/* UDMA 66 chips have only drive side logic */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">&lt;</span> <span class="n">ATA_UDMA5</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA_UNK</span><span class="p">;</span>
	<span class="cm">/* UDMA 100 or later */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ata66</span><span class="p">);</span>
	<span class="cm">/* Check both the drive cable reporting bits, we might not have</span>
<span class="cm">	   two drives */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata66</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x10100000</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA80</span><span class="p">;</span>
	<span class="cm">/* Check with ACPI so we can spot BIOS reported SATA bridges */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_acpi_init_gtm</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ata_acpi_cbl_80wire</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ata_acpi_init_gtm</span><span class="p">(</span><span class="n">ap</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA80</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ATA_CBL_PATA40</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_NO_ENABLES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_bits</span> <span class="n">via_enable_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">}</span>
		<span class="p">};</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_test_config_bits</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_enable_bits</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ata_sff_prereset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> *	via_do_set_mode	-	set transfer mode data</span>
<span class="cm"> *	@ap: ATA interface</span>
<span class="cm"> *	@adev: ATA device</span>
<span class="cm"> *	@mode: ATA mode being programmed</span>
<span class="cm"> *	@set_ast: Set to program address setup</span>
<span class="cm"> *	@udma_type: UDMA mode/format of registers</span>
<span class="cm"> *</span>
<span class="cm"> *	Program the VIA registers for DMA and PIO modes. Uses the ata timing</span>
<span class="cm"> *	support in order to compute modes.</span>
<span class="cm"> *</span>
<span class="cm"> *	FIXME: Hotplug will require we serialize multiple mode changes</span>
<span class="cm"> *	on the two channels.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_do_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set_ast</span><span class="p">,</span> <span class="kt">int</span> <span class="n">udma_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">peer</span> <span class="o">=</span> <span class="n">ata_dev_pair</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_timing</span> <span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">via_clock</span> <span class="o">=</span> <span class="mi">33333</span><span class="p">;</span>	<span class="cm">/* Bus clock in kHZ */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">T</span> <span class="o">=</span>  <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">via_clock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">UT</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ut</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">)</span> <span class="o">-</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">udma_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_UDMA4</span>:
		<span class="n">UT</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA5</span>:
		<span class="n">UT</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA6</span>:
		<span class="n">UT</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate the timing values we require */</span>
	<span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">UT</span><span class="p">);</span>

	<span class="cm">/* We share 8bit timing so we must merge the constraints */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">UT</span><span class="p">);</span>
			<span class="n">ata_timing_merge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">ATA_TIMING_8BIT</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Address setup is programmable but breaks on UDMA133 setups */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_ast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">setup</span><span class="p">;</span>	<span class="cm">/* 2 bits per drive */</span>
		<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">offset</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">);</span>
		<span class="n">setup</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
		<span class="n">setup</span> <span class="o">|=</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Load the PIO mode bits */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x4F</span> <span class="o">-</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">,</span>
		<span class="p">((</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">act8b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">rec8b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x48</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
		<span class="p">((</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">active</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">recover</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Load the UDMA bits according to type */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">udma_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_UDMA2</span>:
	<span class="nl">default:</span>
		<span class="n">ut</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xe0</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA4</span>:
		<span class="n">ut</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xe8</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">:</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA5</span>:
		<span class="n">ut</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xe0</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">:</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA6</span>:
		<span class="n">ut</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xe0</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">:</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set UDMA unless device is not UDMA capable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udma_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">udma_etc</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udma_etc</span><span class="p">);</span>

		<span class="cm">/* clear transfer mode bit */</span>
		<span class="n">udma_etc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">udma</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* preserve 80-wire cable detection bit */</span>
			<span class="n">udma_etc</span> <span class="o">&amp;=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">udma_etc</span> <span class="o">|=</span> <span class="n">ut</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">udma_etc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set_ast</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_BAD_AST</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">via_do_set_mode</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="n">set_ast</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">udma_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set_ast</span> <span class="o">=</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_BAD_AST</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">via_do_set_mode</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="n">set_ast</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">udma_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	via_mode_filter		-	filter buggy device/mode pairs</span>
<span class="cm"> *	@dev: ATA device</span>
<span class="cm"> *	@mask: Mode bitmask</span>
<span class="cm"> *</span>
<span class="cm"> *	We need to apply some minimal filtering for old controllers and at least</span>
<span class="cm"> *	one breed of Transcend SSD. Return the updated mask.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">via_mode_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">model_num</span><span class="p">[</span><span class="n">ATA_ID_PROD_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_VIA_82C586_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_id_c_string</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">model_num</span><span class="p">,</span> <span class="n">ATA_ID_PROD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">model_num</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model_num</span><span class="p">,</span> <span class="s">&quot;TS64GSSD25-M&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
	<span class="s">&quot;disabling UDMA mode due to reported lockups with this device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">ATA_MASK_UDMA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_check_system</span><span class="p">(</span><span class="n">no_atapi_dma_dmi_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller locks up on ATAPI DMA, forcing PIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">ATA_MASK_PIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	via_tf_load - send taskfile registers to host controller</span>
<span class="cm"> *	@ap: Port to which output is sent</span>
<span class="cm"> *	@tf: ATA taskfile register set</span>
<span class="cm"> *</span>
<span class="cm"> *	Outputs ATA taskfile to standard ATA host controller.</span>
<span class="cm"> *</span>
<span class="cm"> *	Note: This is to fix the internal bug of via chipsets, which</span>
<span class="cm"> *	will reset the device register after changing the IEN bit on</span>
<span class="cm"> *	ctl register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_tf_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_ioports</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_port</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_addr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_ISADDR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>
		<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">newctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">device_addr</span><span class="p">);</span>
		<span class="n">vp</span><span class="o">-&gt;</span><span class="n">cached_device</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newctl</span><span class="p">)</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">vp</span><span class="o">-&gt;</span><span class="n">cached_device</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">device_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_addr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">feature_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbam_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbah_addr</span><span class="p">);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;hob: feat 0x%X nsect 0x%X, lba 0x%X 0x%X 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">feature_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbam_addr</span><span class="p">);</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbah_addr</span><span class="p">);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;feat 0x%X nsect 0x%X lba 0x%X 0x%X 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_port</span> <span class="o">*</span><span class="n">vp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ata_bmdma_port_start</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vp</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">vp</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">via_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_BMDMA_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">via_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_bmdma_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>	<span class="o">=</span> <span class="n">via_cable_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>	<span class="o">=</span> <span class="n">via_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>	<span class="o">=</span> <span class="n">via_set_dmamode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prereset</span>	<span class="o">=</span> <span class="n">via_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_tf_load</span>	<span class="o">=</span> <span class="n">via_tf_load</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_start</span>	<span class="o">=</span> <span class="n">via_port_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_filter</span>	<span class="o">=</span> <span class="n">via_mode_filter</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">via_port_ops_noirq</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">via_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_data_xfer</span>	<span class="o">=</span> <span class="n">ata_sff_data_xfer_noirq</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	via_config_fifo		-	set up the FIFO</span>
<span class="cm"> *	@pdev: PCI device</span>
<span class="cm"> *	@flags: configuration flags</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the FIFO properties for this device if necessary. Used both on</span>
<span class="cm"> *	set up and on and the resume path</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_config_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">enable</span><span class="p">;</span>

	<span class="cm">/* 0x40 low bits indicate enabled channels */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">);</span>
	<span class="n">enable</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_SET_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">fifo_setting</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">};</span>
		<span class="n">u8</span> <span class="n">fifo</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="p">);</span>

		<span class="cm">/* Clear PREQ# until DDACK# for errata */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_BAD_PREQ</span><span class="p">)</span>
			<span class="n">fifo</span> <span class="o">&amp;=</span> <span class="mh">0x7F</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fifo</span> <span class="o">&amp;=</span> <span class="mh">0x9f</span><span class="p">;</span>
		<span class="cm">/* Turn on FIFO for enabled channels */</span>
		<span class="n">fifo</span> <span class="o">|=</span> <span class="n">fifo_setting</span><span class="p">[</span><span class="n">enable</span><span class="p">];</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timing</span><span class="p">;</span>

	<span class="cm">/* Initialise the FIFO for the enabled channels. */</span>
	<span class="n">via_config_fifo</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">==</span> <span class="n">ATA_UDMA4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The 66 MHz devices require we enable the clock */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">);</span>
		<span class="n">timing</span> <span class="o">|=</span> <span class="mh">0x80008</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">timing</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_BAD_CLK66</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable the 66MHz clock on problem devices */</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">);</span>
		<span class="n">timing</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80008</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">timing</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	via_init_one		-	discovery callback</span>
<span class="cm"> *	@pdev: PCI device</span>
<span class="cm"> *	@id: PCI table info</span>
<span class="cm"> *</span>
<span class="cm"> *	A VIA IDE interface has been discovered. Figure out what revision</span>
<span class="cm"> *	and perform configuration work before handing it to the ATA layer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Early VIA without UDMA support */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">via_mwdma_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_port_ops</span>
	<span class="p">};</span>
	<span class="cm">/* Ditto with IRQ masking required */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">via_mwdma_info_borked</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_port_ops_noirq</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="cm">/* VIA UDMA 33 devices (and borked 66) */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">via_udma33_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_port_ops</span>
	<span class="p">};</span>
	<span class="cm">/* VIA UDMA 66 devices */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">via_udma66_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_port_ops</span>
	<span class="p">};</span>
	<span class="cm">/* VIA UDMA 100 devices */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">via_udma100_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_port_ops</span>
	<span class="p">};</span>
	<span class="cm">/* UDMA133 with bad AST (All current 133) */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">via_udma133_info</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>	<span class="cm">/* FIXME: should check north bridge */</span>
		<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_port_ops</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">isa</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">via_isa_bridge</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ata_print_version_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_IDFLAG_SINGLE</span><span class="p">)</span>
		<span class="n">ppi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_dummy_port_info</span><span class="p">;</span>

	<span class="cm">/* To find out how the IDE will behave and what features we</span>
<span class="cm">	   actually have to look at the bridge not the IDE controller */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">config</span> <span class="o">=</span> <span class="n">via_isa_bridges</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_VIA_ANON</span><span class="p">;</span>
	     <span class="n">config</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">isa</span> <span class="o">=</span> <span class="n">pci_get_device</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_VIA</span> <span class="o">+</span>
			<span class="o">!!</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_BAD_ID</span><span class="p">),</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">isa</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
			<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">isa</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x0415</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x3164</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rev_min</span> <span class="o">&amp;&amp;</span> <span class="n">rev</span> <span class="o">&lt;=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">rev_max</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_NO_ENABLES</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 0x40 low bits indicate enabled channels */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">);</span>
		<span class="n">enable</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clock set up */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">udma_mask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VIA_NO_UNMASK</span><span class="p">)</span>
			<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_mwdma_info_borked</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_mwdma_info</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA2</span>:
		<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_udma33_info</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA4</span>:
		<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_udma66_info</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA5</span>:
		<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_udma100_info</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATA_UDMA6</span>:
		<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_udma133_info</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
 	<span class="p">}</span>

	<span class="n">via_fixup</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>

	<span class="cm">/* We have established the device type, now fire it up */</span>
	<span class="k">return</span> <span class="n">ata_pci_bmdma_init_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">via_sht</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">config</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/**</span>
<span class="cm"> *	via_reinit_one		-	reinit after resume</span>
<span class="cm"> *	@pdev; PCI device</span>
<span class="cm"> *</span>
<span class="cm"> *	Called when the VIA PATA device is resumed. We must then</span>
<span class="cm"> *	reconfigure the fifo and other setup we may have altered. In</span>
<span class="cm"> *	addition the kernel needs to have the resume methods on PCI</span>
<span class="cm"> *	quirk supported.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_reinit_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_device_do_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">via_fixup</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>

	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">via</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x0415</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x0571</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x0581</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x1571</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x3164</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x5324</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0xC409</span><span class="p">),</span> <span class="n">VIA_IDFLAG_SINGLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">),</span> <span class="n">VIA_IDFLAG_SINGLE</span> <span class="p">},</span>

	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">via_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">via</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> 		<span class="o">=</span> <span class="n">via_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ata_pci_remove_one</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ata_pci_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">via_reinit_one</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">via_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">via_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Alan Cox&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;low-level driver for VIA PATA&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">via</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">via_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">via_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
