<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › pata_arasan_cf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pata_arasan_cf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/ata/pata_arasan_cf.c</span>
<span class="cm"> *</span>
<span class="cm"> * Arasan Compact Flash host controller source file</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 ST Microelectronics</span>
<span class="cm"> * Viresh Kumar &lt;viresh.linux@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2. This program is licensed &quot;as is&quot; without any</span>
<span class="cm"> * warranty of any kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The Arasan CompactFlash Device Controller IP core has three basic modes of</span>
<span class="cm"> * operation: PC card ATA using I/O mode, PC card ATA using memory mode, PC card</span>
<span class="cm"> * ATA using true IDE modes. This driver supports only True IDE mode currently.</span>
<span class="cm"> *</span>
<span class="cm"> * Arasan CF Controller shares global irq register with Arasan XD Controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Tested on arch/arm/mach-spear13xx</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ata.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dmaengine.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pata_arasan_cf_data.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#define DRIVER_NAME	&quot;arasan_cf&quot;</span>
<span class="cp">#define TIMEOUT		msecs_to_jiffies(3000)</span>

<span class="cm">/* Registers */</span>
<span class="cm">/* CompactFlash Interface Status */</span>
<span class="cp">#define CFI_STS			0x000</span>
	<span class="cp">#define STS_CHG				(1)</span>
	<span class="cp">#define BIN_AUDIO_OUT			(1 &lt;&lt; 1)</span>
	<span class="cp">#define CARD_DETECT1			(1 &lt;&lt; 2)</span>
	<span class="cp">#define CARD_DETECT2			(1 &lt;&lt; 3)</span>
	<span class="cp">#define INP_ACK				(1 &lt;&lt; 4)</span>
	<span class="cp">#define CARD_READY			(1 &lt;&lt; 5)</span>
	<span class="cp">#define IO_READY			(1 &lt;&lt; 6)</span>
	<span class="cp">#define B16_IO_PORT_SEL			(1 &lt;&lt; 7)</span>
<span class="cm">/* IRQ */</span>
<span class="cp">#define IRQ_STS			0x004</span>
<span class="cm">/* Interrupt Enable */</span>
<span class="cp">#define IRQ_EN			0x008</span>
	<span class="cp">#define CARD_DETECT_IRQ			(1)</span>
	<span class="cp">#define STATUS_CHNG_IRQ			(1 &lt;&lt; 1)</span>
	<span class="cp">#define MEM_MODE_IRQ			(1 &lt;&lt; 2)</span>
	<span class="cp">#define IO_MODE_IRQ			(1 &lt;&lt; 3)</span>
	<span class="cp">#define TRUE_IDE_MODE_IRQ		(1 &lt;&lt; 8)</span>
	<span class="cp">#define PIO_XFER_ERR_IRQ		(1 &lt;&lt; 9)</span>
	<span class="cp">#define BUF_AVAIL_IRQ			(1 &lt;&lt; 10)</span>
	<span class="cp">#define XFER_DONE_IRQ			(1 &lt;&lt; 11)</span>
	<span class="cp">#define IGNORED_IRQS	(STATUS_CHNG_IRQ | MEM_MODE_IRQ | IO_MODE_IRQ |\</span>
<span class="cp">					TRUE_IDE_MODE_IRQ)</span>
	<span class="cp">#define TRUE_IDE_IRQS	(CARD_DETECT_IRQ | PIO_XFER_ERR_IRQ |\</span>
<span class="cp">					BUF_AVAIL_IRQ | XFER_DONE_IRQ)</span>
<span class="cm">/* Operation Mode */</span>
<span class="cp">#define OP_MODE			0x00C</span>
	<span class="cp">#define CARD_MODE_MASK			(0x3)</span>
	<span class="cp">#define MEM_MODE			(0x0)</span>
	<span class="cp">#define IO_MODE				(0x1)</span>
	<span class="cp">#define TRUE_IDE_MODE			(0x2)</span>

	<span class="cp">#define CARD_TYPE_MASK			(1 &lt;&lt; 2)</span>
	<span class="cp">#define CF_CARD				(0)</span>
	<span class="cp">#define CF_PLUS_CARD			(1 &lt;&lt; 2)</span>

	<span class="cp">#define CARD_RESET			(1 &lt;&lt; 3)</span>
	<span class="cp">#define CFHOST_ENB			(1 &lt;&lt; 4)</span>
	<span class="cp">#define OUTPUTS_TRISTATE		(1 &lt;&lt; 5)</span>
	<span class="cp">#define ULTRA_DMA_ENB			(1 &lt;&lt; 8)</span>
	<span class="cp">#define MULTI_WORD_DMA_ENB		(1 &lt;&lt; 9)</span>
	<span class="cp">#define DRQ_BLOCK_SIZE_MASK		(0x3 &lt;&lt; 11)</span>
	<span class="cp">#define DRQ_BLOCK_SIZE_512		(0)</span>
	<span class="cp">#define DRQ_BLOCK_SIZE_1024		(1 &lt;&lt; 11)</span>
	<span class="cp">#define DRQ_BLOCK_SIZE_2048		(2 &lt;&lt; 11)</span>
	<span class="cp">#define DRQ_BLOCK_SIZE_4096		(3 &lt;&lt; 11)</span>
<span class="cm">/* CF Interface Clock Configuration */</span>
<span class="cp">#define CLK_CFG			0x010</span>
	<span class="cp">#define CF_IF_CLK_MASK			(0XF)</span>
<span class="cm">/* CF Timing Mode Configuration */</span>
<span class="cp">#define TM_CFG			0x014</span>
	<span class="cp">#define MEM_MODE_TIMING_MASK		(0x3)</span>
	<span class="cp">#define MEM_MODE_TIMING_250NS		(0x0)</span>
	<span class="cp">#define MEM_MODE_TIMING_120NS		(0x1)</span>
	<span class="cp">#define MEM_MODE_TIMING_100NS		(0x2)</span>
	<span class="cp">#define MEM_MODE_TIMING_80NS		(0x3)</span>

	<span class="cp">#define IO_MODE_TIMING_MASK		(0x3 &lt;&lt; 2)</span>
	<span class="cp">#define IO_MODE_TIMING_250NS		(0x0 &lt;&lt; 2)</span>
	<span class="cp">#define IO_MODE_TIMING_120NS		(0x1 &lt;&lt; 2)</span>
	<span class="cp">#define IO_MODE_TIMING_100NS		(0x2 &lt;&lt; 2)</span>
	<span class="cp">#define IO_MODE_TIMING_80NS		(0x3 &lt;&lt; 2)</span>

	<span class="cp">#define TRUEIDE_PIO_TIMING_MASK		(0x7 &lt;&lt; 4)</span>
	<span class="cp">#define TRUEIDE_PIO_TIMING_SHIFT	4</span>

	<span class="cp">#define TRUEIDE_MWORD_DMA_TIMING_MASK	(0x7 &lt;&lt; 7)</span>
	<span class="cp">#define TRUEIDE_MWORD_DMA_TIMING_SHIFT	7</span>

	<span class="cp">#define ULTRA_DMA_TIMING_MASK		(0x7 &lt;&lt; 10)</span>
	<span class="cp">#define ULTRA_DMA_TIMING_SHIFT		10</span>
<span class="cm">/* CF Transfer Address */</span>
<span class="cp">#define XFER_ADDR		0x014</span>
	<span class="cp">#define XFER_ADDR_MASK			(0x7FF)</span>
	<span class="cp">#define MAX_XFER_COUNT			0x20000u</span>
<span class="cm">/* Transfer Control */</span>
<span class="cp">#define XFER_CTR		0x01C</span>
	<span class="cp">#define XFER_COUNT_MASK			(0x3FFFF)</span>
	<span class="cp">#define ADDR_INC_DISABLE		(1 &lt;&lt; 24)</span>
	<span class="cp">#define XFER_WIDTH_MASK			(1 &lt;&lt; 25)</span>
	<span class="cp">#define XFER_WIDTH_8B			(0)</span>
	<span class="cp">#define XFER_WIDTH_16B			(1 &lt;&lt; 25)</span>

	<span class="cp">#define MEM_TYPE_MASK			(1 &lt;&lt; 26)</span>
	<span class="cp">#define MEM_TYPE_COMMON			(0)</span>
	<span class="cp">#define MEM_TYPE_ATTRIBUTE		(1 &lt;&lt; 26)</span>

	<span class="cp">#define MEM_IO_XFER_MASK		(1 &lt;&lt; 27)</span>
	<span class="cp">#define MEM_XFER			(0)</span>
	<span class="cp">#define IO_XFER				(1 &lt;&lt; 27)</span>

	<span class="cp">#define DMA_XFER_MODE			(1 &lt;&lt; 28)</span>

	<span class="cp">#define AHB_BUS_NORMAL_PIO_OPRTN	(~(1 &lt;&lt; 29))</span>
	<span class="cp">#define XFER_DIR_MASK			(1 &lt;&lt; 30)</span>
	<span class="cp">#define XFER_READ			(0)</span>
	<span class="cp">#define XFER_WRITE			(1 &lt;&lt; 30)</span>

	<span class="cp">#define XFER_START			(1 &lt;&lt; 31)</span>
<span class="cm">/* Write Data Port */</span>
<span class="cp">#define WRITE_PORT		0x024</span>
<span class="cm">/* Read Data Port */</span>
<span class="cp">#define READ_PORT		0x028</span>
<span class="cm">/* ATA Data Port */</span>
<span class="cp">#define ATA_DATA_PORT		0x030</span>
	<span class="cp">#define ATA_DATA_PORT_MASK		(0xFFFF)</span>
<span class="cm">/* ATA Error/Features */</span>
<span class="cp">#define ATA_ERR_FTR		0x034</span>
<span class="cm">/* ATA Sector Count */</span>
<span class="cp">#define ATA_SC			0x038</span>
<span class="cm">/* ATA Sector Number */</span>
<span class="cp">#define ATA_SN			0x03C</span>
<span class="cm">/* ATA Cylinder Low */</span>
<span class="cp">#define ATA_CL			0x040</span>
<span class="cm">/* ATA Cylinder High */</span>
<span class="cp">#define ATA_CH			0x044</span>
<span class="cm">/* ATA Select Card/Head */</span>
<span class="cp">#define ATA_SH			0x048</span>
<span class="cm">/* ATA Status-Command */</span>
<span class="cp">#define ATA_STS_CMD		0x04C</span>
<span class="cm">/* ATA Alternate Status/Device Control */</span>
<span class="cp">#define ATA_ASTS_DCTR		0x050</span>
<span class="cm">/* Extended Write Data Port 0x200-0x3FC */</span>
<span class="cp">#define EXT_WRITE_PORT		0x200</span>
<span class="cm">/* Extended Read Data Port 0x400-0x5FC */</span>
<span class="cp">#define EXT_READ_PORT		0x400</span>
	<span class="cp">#define FIFO_SIZE	0x200u</span>
<span class="cm">/* Global Interrupt Status */</span>
<span class="cp">#define GIRQ_STS		0x800</span>
<span class="cm">/* Global Interrupt Status enable */</span>
<span class="cp">#define GIRQ_STS_EN		0x804</span>
<span class="cm">/* Global Interrupt Signal enable */</span>
<span class="cp">#define GIRQ_SGN_EN		0x808</span>
	<span class="cp">#define GIRQ_CF		(1)</span>
	<span class="cp">#define GIRQ_XD		(1 &lt;&lt; 1)</span>

<span class="cm">/* Compact Flash Controller Dev Structure */</span>
<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="p">{</span>
	<span class="cm">/* pointer to ata_host structure */</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="cm">/* clk structure, only if HAVE_CLK is defined */</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* physical base address of controller */</span>
	<span class="n">dma_addr_t</span> <span class="n">pbase</span><span class="p">;</span>
	<span class="cm">/* virtual base address of controller */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vbase</span><span class="p">;</span>
	<span class="cm">/* irq number*/</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* status to be updated to framework regarding DMA transfer */</span>
	<span class="n">u8</span> <span class="n">dma_status</span><span class="p">;</span>
	<span class="cm">/* Card is present or Not */</span>
	<span class="n">u8</span> <span class="n">card_present</span><span class="p">;</span>

	<span class="cm">/* dma specific */</span>
	<span class="cm">/* Completion for transfer complete interrupt from controller */</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">cf_completion</span><span class="p">;</span>
	<span class="cm">/* Completion for DMA transfer complete. */</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">dma_completion</span><span class="p">;</span>
	<span class="cm">/* Dma channel allocated */</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">dma_chan</span><span class="p">;</span>
	<span class="cm">/* Mask for DMA transfers */</span>
	<span class="n">dma_cap_mask_t</span> <span class="n">mask</span><span class="p">;</span>
	<span class="cm">/* dma channel private data */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dma_priv</span><span class="p">;</span>
	<span class="cm">/* DMA transfer work */</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="cm">/* DMA delayed finish work */</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">dwork</span><span class="p">;</span>
	<span class="cm">/* qc to be transferred using DMA */</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">arasan_cf_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_BASE_SHT</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">SG_NONE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_boundary</span> <span class="o">=</span> <span class="mh">0xFFFFFFFFUL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cf_dumpregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: =========== REGISTER DUMP ===========&quot;</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: CFI_STS: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">CFI_STS</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: IRQ_STS: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_STS</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: IRQ_EN: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_EN</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: OP_MODE: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: CLK_CFG: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">CLK_CFG</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: TM_CFG: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">TM_CFG</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: XFER_CTR: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: GIRQ_STS: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">GIRQ_STS</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: GIRQ_STS_EN: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">GIRQ_STS_EN</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: GIRQ_SGN_EN: %x&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">GIRQ_SGN_EN</span><span class="p">));</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;: =====================================&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable/Disable global interrupts shared between CF and XD ctrlr. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cf_ginterrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable should be 0 or 1 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">GIRQ_STS_EN</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">GIRQ_SGN_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable/Disable CF interrupts */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">cf_interrupt_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_EN</span><span class="p">);</span>
	<span class="cm">/* clear &amp; enable/disable irqs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_STS</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_EN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cf_card_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">CARD_RESET</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CARD_RESET</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cf_ctrl_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CFHOST_ENB</span><span class="p">,</span>
			<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="n">CFHOST_ENB</span><span class="p">,</span>
			<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cf_card_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">hotplugged</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">CFI_STS</span><span class="p">);</span>

	<span class="cm">/* Both CD1 &amp; CD2 should be low if card inserted completely */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CARD_DETECT1</span> <span class="o">|</span> <span class="n">CARD_DETECT2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cf_card_reset</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hotplugged</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clock enable failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* configure CF interface clock */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cf_if_clk</span> <span class="o">&lt;=</span> <span class="n">CF_IF_CLK_200M</span><span class="p">)</span> <span class="o">?</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">cf_if_clk</span> <span class="o">:</span>
			<span class="n">CF_IF_CLK_166M</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">CLK_CFG</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">TRUE_IDE_MODE</span> <span class="o">|</span> <span class="n">CFHOST_ENB</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
	<span class="n">cf_interrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">CARD_DETECT_IRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cf_ginterrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cf_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cf_ginterrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cf_interrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">TRUE_IDE_IRQS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cf_card_reset</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CFHOST_ENB</span><span class="p">,</span>
			<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_completion</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dma_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ata_sff_interrupt</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ata_is_dma</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">))</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">,</span> <span class="s">&quot;DMA Failed: Timeout&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wait4buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">cf_completion</span><span class="p">,</span> <span class="n">TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rw</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">;</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s TimeOut&quot;</span><span class="p">,</span> <span class="n">rw</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if PIO Error interrupt has occurred */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_status</span> <span class="o">&amp;</span> <span class="n">ATA_DMA_ERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">dma_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">src</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dest</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_async_tx_descriptor</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_chan</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">;</span>
	<span class="n">dma_cookie_t</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_PREP_INTERRUPT</span> <span class="o">|</span> <span class="n">DMA_COMPL_SKIP_SRC_UNMAP</span> <span class="o">|</span>
		<span class="n">DMA_COMPL_SKIP_DEST_UNMAP</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_prep_dma_memcpy</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device_prep_dma_memcpy failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dma_callback</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">callback_param</span> <span class="o">=</span> <span class="n">acdev</span><span class="p">;</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_submit</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_submit_error</span><span class="p">(</span><span class="n">cookie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma_submit_error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_issue_pending</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="cm">/* Wait for DMA to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_completion</span><span class="p">,</span> <span class="n">TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">DMA_TERMINATE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wait_for_completion_timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sg_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xfer_cnt</span><span class="p">,</span> <span class="n">sglen</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">,</span> <span class="n">xfer_ctr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">write</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sglen</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">pbase</span> <span class="o">+</span> <span class="n">EXT_WRITE_PORT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">pbase</span> <span class="o">+</span> <span class="n">EXT_READ_PORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For each sg:</span>
<span class="cm">	 * MAX_XFER_COUNT data will be transferred before we get transfer</span>
<span class="cm">	 * complete interrupt. Between after FIFO_SIZE data</span>
<span class="cm">	 * buffer available interrupt will be generated. At this time we will</span>
<span class="cm">	 * fill FIFO again: max FIFO_SIZE data.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sglen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xfer_cnt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sglen</span><span class="p">,</span> <span class="n">MAX_XFER_COUNT</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">xfer_ctr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">XFER_COUNT_MASK</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">xfer_ctr</span> <span class="o">|</span> <span class="n">xfer_cnt</span> <span class="o">|</span> <span class="n">XFER_START</span><span class="p">,</span>
				<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* continue dma xfers until current sg is completed */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">xfer_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wait for read to complete */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">wait4buf</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* read/write FIFO in chunk of FIFO_SIZE */</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">xfer_cnt</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_xfer</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dma_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dma failed&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span>
				<span class="n">src</span> <span class="o">+=</span> <span class="n">dma_len</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dest</span> <span class="o">+=</span> <span class="n">dma_len</span><span class="p">;</span>

			<span class="n">sglen</span> <span class="o">-=</span> <span class="n">dma_len</span><span class="p">;</span>
			<span class="n">xfer_cnt</span> <span class="o">-=</span> <span class="n">dma_len</span><span class="p">;</span>

			<span class="cm">/* wait for write to complete */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">wait4buf</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">fail:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XFER_START</span><span class="p">,</span>
			<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This routine uses External DMA controller to read/write data to FIFO of CF</span>
<span class="cm"> * controller. There are two xfer related interrupt supported by CF controller:</span>
<span class="cm"> * - buf_avail: This interrupt is generated as soon as we have buffer of 512</span>
<span class="cm"> *	bytes available for reading or empty buffer available for writing.</span>
<span class="cm"> * - xfer_done: This interrupt is generated on transfer of &quot;xfer_size&quot; amount of</span>
<span class="cm"> *	data to/from FIFO. xfer_size is programmed in XFER_CTR register.</span>
<span class="cm"> *</span>
<span class="cm"> * Max buffer size = FIFO_SIZE = 512 Bytes.</span>
<span class="cm"> * Max xfer_size = MAX_XFER_COUNT = 256 KB.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">data_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">arasan_cf_dev</span><span class="p">,</span>
			<span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* request dma channels */</span>
	<span class="cm">/* dma_request_channel may sleep, so calling from process context */</span>
	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_chan</span> <span class="o">=</span> <span class="n">dma_request_channel</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span>
			<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to get dma_chan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">chan_request_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sg_xfer</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">sg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dma_release_channel</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">);</span>

	<span class="cm">/* data xferred successfully */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ata_sff_queue_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">sff_intr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cf_dumpregs</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>

<span class="nl">chan_request_fail:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* error when transferring data to/from memory */</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HOST_BUS</span><span class="p">;</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">hsm_task_state</span> <span class="o">=</span> <span class="n">HSM_ST_ERR</span><span class="p">;</span>

	<span class="n">cf_ctrl_reset</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">sff_intr:</span>
	<span class="n">dma_complete</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delayed_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">arasan_cf_dev</span><span class="p">,</span>
			<span class="n">dwork</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRQ</span><span class="p">))</span>
		<span class="n">ata_sff_queue_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dma_complete</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">arasan_cf_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqsts</span><span class="p">;</span>

	<span class="n">irqsts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">GIRQ_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irqsts</span> <span class="o">&amp;</span> <span class="n">GIRQ_CF</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">irqsts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_STS</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">irqsts</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">IRQ_STS</span><span class="p">);</span>		<span class="cm">/* clear irqs */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">GIRQ_CF</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">GIRQ_STS</span><span class="p">);</span>	<span class="cm">/* clear girqs */</span>

	<span class="cm">/* handle only relevant interrupts */</span>
	<span class="n">irqsts</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IGNORED_IRQS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqsts</span> <span class="o">&amp;</span> <span class="n">CARD_DETECT_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cf_card_detect</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqsts</span> <span class="o">&amp;</span> <span class="n">PIO_XFER_ERR_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_status</span> <span class="o">=</span> <span class="n">ATA_DMA_ERR</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XFER_START</span><span class="p">,</span>
				<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">cf_completion</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pio xfer err irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqsts</span> <span class="o">&amp;</span> <span class="n">BUF_AVAIL_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">cf_completion</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqsts</span> <span class="o">&amp;</span> <span class="n">XFER_DONE_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="p">;</span>

		<span class="cm">/* Send Complete only for write */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">)</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">cf_completion</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arasan_cf_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* stop transfer and reset controller */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XFER_START</span><span class="p">,</span>
			<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">);</span>
	<span class="n">cf_ctrl_reset</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_status</span> <span class="o">=</span> <span class="n">ATA_DMA_ERR</span><span class="p">;</span>

	<span class="n">ata_sff_dma_pause</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ata_sff_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">arasan_cf_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * DMA transfers using an external DMA controller may be scheduled.</span>
<span class="cm">	 * Abort them before handling error. Refer data_xfer() for further</span>
<span class="cm">	 * details.</span>
<span class="cm">	 */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ata_sff_error_handler</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arasan_cf_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">xfer_ctr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">XFER_DIR_MASK</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">write</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">;</span>

	<span class="n">xfer_ctr</span> <span class="o">|=</span> <span class="n">write</span> <span class="o">?</span> <span class="n">XFER_WRITE</span> <span class="o">:</span> <span class="n">XFER_READ</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">xfer_ctr</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">);</span>

	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_exec_command</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">ata_sff_queue_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">arasan_cf_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* defer PIO handling to sff_qc_issue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_is_dma</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ata_sff_qc_issue</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>

	<span class="cm">/* select the device */</span>
	<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ata_sff_dev_select</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>
	<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* start the command */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_PROT_DMA</span>:
		<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_POLLING</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_tf_load</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
		<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">qc</span> <span class="o">=</span> <span class="n">qc</span><span class="p">;</span>
		<span class="n">arasan_cf_dma_start</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">hsm_task_state</span> <span class="o">=</span> <span class="n">HSM_ST_LAST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AC_ERR_SYSTEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arasan_cf_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pio</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">-</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Arasan ctrl supports Mode0 -&gt; Mode6 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pio</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown PIO mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">ULTRA_DMA_ENB</span> <span class="o">|</span> <span class="n">MULTI_WORD_DMA_ENB</span> <span class="o">|</span> <span class="n">DRQ_BLOCK_SIZE_MASK</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">TM_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TRUEIDE_PIO_TIMING_MASK</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">pio</span> <span class="o">&lt;&lt;</span> <span class="n">TRUEIDE_PIO_TIMING_SHIFT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">TM_CFG</span><span class="p">);</span>

	<span class="n">cf_interrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">BUF_AVAIL_IRQ</span> <span class="o">|</span> <span class="n">XFER_DONE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cf_interrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">PIO_XFER_ERR_IRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">arasan_cf_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opmode</span><span class="p">,</span> <span class="n">tmcfg</span><span class="p">,</span> <span class="n">dma_mode</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">opmode</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">MULTI_WORD_DMA_ENB</span> <span class="o">|</span> <span class="n">ULTRA_DMA_ENB</span><span class="p">);</span>
	<span class="n">tmcfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">TM_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dma_mode</span> <span class="o">&gt;=</span> <span class="n">XFER_UDMA_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma_mode</span> <span class="o">&lt;=</span> <span class="n">XFER_UDMA_6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">opmode</span> <span class="o">|=</span> <span class="n">ULTRA_DMA_ENB</span><span class="p">;</span>
		<span class="n">tmcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ULTRA_DMA_TIMING_MASK</span><span class="p">;</span>
		<span class="n">tmcfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dma_mode</span> <span class="o">-</span> <span class="n">XFER_UDMA_0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ULTRA_DMA_TIMING_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dma_mode</span> <span class="o">&gt;=</span> <span class="n">XFER_MW_DMA_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dma_mode</span> <span class="o">&lt;=</span> <span class="n">XFER_MW_DMA_4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">opmode</span> <span class="o">|=</span> <span class="n">MULTI_WORD_DMA_ENB</span><span class="p">;</span>
		<span class="n">tmcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TRUEIDE_MWORD_DMA_TIMING_MASK</span><span class="p">;</span>
		<span class="n">tmcfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">dma_mode</span> <span class="o">-</span> <span class="n">XFER_MW_DMA_0</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">TRUEIDE_MWORD_DMA_TIMING_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown DMA mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">opmode</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">OP_MODE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmcfg</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">TM_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">DMA_XFER_MODE</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">XFER_CTR</span><span class="p">);</span>

	<span class="n">cf_interrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">PIO_XFER_ERR_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cf_interrupt_enable</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="n">BUF_AVAIL_IRQ</span> <span class="o">|</span> <span class="n">XFER_DONE_IRQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">arasan_cf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_sff_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">arasan_cf_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span> <span class="o">=</span> <span class="n">arasan_cf_error_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_issue</span> <span class="o">=</span> <span class="n">arasan_cf_qc_issue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span> <span class="o">=</span> <span class="n">arasan_cf_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span> <span class="o">=</span> <span class="n">arasan_cf_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">arasan_cf_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arasan_cf_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">irq_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span>
				<span class="n">DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get memory region resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acdev</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acdev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;kzalloc fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if irq is 0, support only PIO */</span>
	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">irq_handler</span> <span class="o">=</span> <span class="n">arasan_cf_interrupt</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">quirk</span> <span class="o">|=</span> <span class="n">CF_BROKEN_MWDMA</span> <span class="o">|</span> <span class="n">CF_BROKEN_UDMA</span><span class="p">;</span>

	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">pbase</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">=</span> <span class="n">devm_ioremap_nocache</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ioremap fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Clock not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* allocate host */</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ata_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;alloc host fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">acdev</span><span class="p">;</span>
	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arasan_cf_ops</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO6</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA4</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">cf_completion</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_completion</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">data_xfer</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dwork</span><span class="p">,</span> <span class="n">delayed_finish</span><span class="p">);</span>
	<span class="n">dma_cap_set</span><span class="p">(</span><span class="n">DMA_MEMCPY</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_priv</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dma_priv</span><span class="p">;</span>

	<span class="cm">/* Handle platform specific quirks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">quirk</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">quirk</span> <span class="o">&amp;</span> <span class="n">CF_BROKEN_PIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_piomode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">quirk</span> <span class="o">&amp;</span> <span class="n">CF_BROKEN_MWDMA</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">quirk</span> <span class="o">&amp;</span> <span class="n">CF_BROKEN_UDMA</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_PIO_POLLING</span> <span class="o">|</span> <span class="n">ATA_FLAG_NO_ATAPI</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">cmd_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_DATA_PORT</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_DATA_PORT</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">error_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_ERR_FTR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">feature_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_ERR_FTR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">nsect_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_SC</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbal_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_SN</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbam_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_CL</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbah_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_CH</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">device_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_SH</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">status_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_STS_CMD</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">command_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_STS_CMD</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_ASTS_DCTR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span> <span class="o">=</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">ATA_ASTS_DCTR</span><span class="p">;</span>

	<span class="n">ata_port_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;phy_addr %llx virt_addr %p&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">vbase</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cf_init</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_clk</span><span class="p">;</span>

	<span class="n">cf_card_detect</span><span class="p">(</span><span class="n">acdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_host_activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">acdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">arasan_cf_sht</span><span class="p">);</span>

<span class="nl">free_clk:</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">arasan_cf_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">ata_host_detach</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">cf_exit</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_HAVE_CLK</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">arasan_cf_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">)</span>
		<span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">device_control</span><span class="p">(</span><span class="n">acdev</span><span class="o">-&gt;</span><span class="n">dma_chan</span><span class="p">,</span>
				<span class="n">DMA_TERMINATE_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cf_exit</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ata_host_suspend</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">PMSG_SUSPEND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">arasan_cf_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">arasan_cf_dev</span> <span class="o">*</span><span class="n">acdev</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">cf_init</span><span class="p">(</span><span class="n">acdev</span><span class="p">);</span>
	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">SIMPLE_DEV_PM_OPS</span><span class="p">(</span><span class="n">arasan_cf_pm_ops</span><span class="p">,</span> <span class="n">arasan_cf_suspend</span><span class="p">,</span> <span class="n">arasan_cf_resume</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">arasan_cf_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">arasan_cf_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">arasan_cf_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">arasan_cf_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">arasan_cf_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Viresh Kumar &lt;viresh.linux@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Arasan ATA Compact Flash driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
