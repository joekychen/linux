<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › ahci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ahci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  ahci.c - AHCI SATA support</span>
<span class="cm"> *</span>
<span class="cm"> *  Maintained by:  Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> *    		    Please ALWAYS copy linux-ide@vger.kernel.org</span>
<span class="cm"> *		    on emails.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2004-2005 Red Hat, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * libata documentation is available via &#39;make {ps|pdf}docs&#39;,</span>
<span class="cm"> * as Documentation/DocBook/libata.*</span>
<span class="cm"> *</span>
<span class="cm"> * AHCI hardware documentation:</span>
<span class="cm"> * http://www.intel.com/technology/serialata/pdf/rev1_0.pdf</span>
<span class="cm"> * http://www.intel.com/technology/serialata/pdf/rev1_1.pdf</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &quot;ahci.h&quot;</span>

<span class="cp">#define DRV_NAME	&quot;ahci&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;3.0&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">AHCI_PCI_BAR_STA2X11</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">AHCI_PCI_BAR_STANDARD</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">board_ids</span> <span class="p">{</span>
	<span class="cm">/* board IDs by feature in alphabetical order */</span>
	<span class="n">board_ahci</span><span class="p">,</span>
	<span class="n">board_ahci_ign_iferr</span><span class="p">,</span>
	<span class="n">board_ahci_nosntf</span><span class="p">,</span>
	<span class="n">board_ahci_yes_fbs</span><span class="p">,</span>

	<span class="cm">/* board IDs for specific chipsets in alphabetical order */</span>
	<span class="n">board_ahci_mcp65</span><span class="p">,</span>
	<span class="n">board_ahci_mcp77</span><span class="p">,</span>
	<span class="n">board_ahci_mcp89</span><span class="p">,</span>
	<span class="n">board_ahci_mv</span><span class="p">,</span>
	<span class="n">board_ahci_sb600</span><span class="p">,</span>
	<span class="n">board_ahci_sb700</span><span class="p">,</span>	<span class="cm">/* for SB700 and SB800 */</span>
	<span class="n">board_ahci_vt8251</span><span class="p">,</span>

	<span class="cm">/* aliases */</span>
	<span class="n">board_ahci_mcp_linux</span>	<span class="o">=</span> <span class="n">board_ahci_mcp65</span><span class="p">,</span>
	<span class="n">board_ahci_mcp67</span>	<span class="o">=</span> <span class="n">board_ahci_mcp65</span><span class="p">,</span>
	<span class="n">board_ahci_mcp73</span>	<span class="o">=</span> <span class="n">board_ahci_mcp65</span><span class="p">,</span>
	<span class="n">board_ahci_mcp79</span>	<span class="o">=</span> <span class="n">board_ahci_mcp77</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_vt8251_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_p5wdh_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_pci_device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_pci_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">ahci_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AHCI_SHT</span><span class="p">(</span><span class="s">&quot;ahci&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">ahci_vt8251_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardreset</span>		<span class="o">=</span> <span class="n">ahci_vt8251_hardreset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">ahci_p5wdh_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardreset</span>		<span class="o">=</span> <span class="n">ahci_p5wdh_hardreset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">ahci_port_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* by features */</span>
	<span class="p">[</span><span class="n">board_ahci</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_ign_iferr</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_IGN_IRQ_IF_ERR</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_nosntf</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_NO_SNTF</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_yes_fbs</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_YES_FBS</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* by chipsets */</span>
	<span class="p">[</span><span class="n">board_ahci_mcp65</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_NO_FPDMA_AA</span> <span class="o">|</span> <span class="n">AHCI_HFLAG_NO_PMP</span> <span class="o">|</span>
				 <span class="n">AHCI_HFLAG_YES_NCQ</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span> <span class="o">|</span> <span class="n">ATA_FLAG_NO_DIPM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_mcp77</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_NO_FPDMA_AA</span> <span class="o">|</span> <span class="n">AHCI_HFLAG_NO_PMP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_mcp89</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_NO_FPDMA_AA</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_mv</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_NO_NCQ</span> <span class="o">|</span> <span class="n">AHCI_HFLAG_NO_MSI</span> <span class="o">|</span>
				 <span class="n">AHCI_HFLAG_MV_PATA</span> <span class="o">|</span> <span class="n">AHCI_HFLAG_NO_PMP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span> <span class="o">|</span> <span class="n">ATA_FLAG_PIO_DMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_sb600</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_IGN_SERR_INTERNAL</span> <span class="o">|</span>
				 <span class="n">AHCI_HFLAG_NO_MSI</span> <span class="o">|</span> <span class="n">AHCI_HFLAG_SECT255</span> <span class="o">|</span>
				 <span class="n">AHCI_HFLAG_32BIT_ONLY</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_pmp_retry_srst_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_sb700</span><span class="p">]</span> <span class="o">=</span>	<span class="cm">/* for SB700 and SB800 */</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_IGN_SERR_INTERNAL</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_pmp_retry_srst_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">board_ahci_vt8251</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="n">AHCI_HFLAGS</span>	<span class="p">(</span><span class="n">AHCI_HFLAG_NO_NCQ</span> <span class="o">|</span> <span class="n">AHCI_HFLAG_NO_PMP</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">AHCI_FLAG_COMMON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_vt8251_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">ahci_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Intel */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2652</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH6 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2653</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH6M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x27c1</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH7 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x27c5</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH7M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x27c3</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH7R */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AL</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">),</span> <span class="n">board_ahci_ign_iferr</span> <span class="p">},</span> <span class="cm">/* ULi M5288 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2681</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ESB2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2682</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ESB2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2683</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ESB2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x27c6</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH7-M DH */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2821</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH8 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2822</span><span class="p">),</span> <span class="n">board_ahci_nosntf</span> <span class="p">},</span> <span class="cm">/* ICH8 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2824</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH8 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2829</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH8M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x282a</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH8M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2922</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2923</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2924</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2925</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2927</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2929</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x292a</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x292b</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x292c</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x292f</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x294d</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x294e</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH9M */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x502a</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Tolapai */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x502b</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Tolapai */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3a05</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH10 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3a22</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH10 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3a25</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* ICH10 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b22</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b23</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b24</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b25</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b29</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b2b</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b2c</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x3b2f</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PCH AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1c02</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* CPT AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1c03</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* CPT AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1c04</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* CPT RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1c05</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* CPT RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1c06</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* CPT RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1c07</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* CPT RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1d02</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PBG AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1d04</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PBG RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1d06</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PBG RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2826</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* PBG RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2323</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* DH89xxCC AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1e02</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Panther Point AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1e03</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Panther Point AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1e04</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Panther Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1e05</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Panther Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1e06</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Panther Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1e07</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Panther Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x1e0e</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Panther Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c02</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c03</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c04</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c05</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c06</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c07</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c0e</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point RAID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x8c0f</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* Lynx Point RAID */</span>

	<span class="cm">/* JMicron 360/1/3/5/6, match class to avoid IDE function */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_JMICRON</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	  <span class="n">PCI_CLASS_STORAGE_SATA_AHCI</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">board_ahci_ign_iferr</span> <span class="p">},</span>

	<span class="cm">/* ATI */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ATI</span><span class="p">,</span> <span class="mh">0x4380</span><span class="p">),</span> <span class="n">board_ahci_sb600</span> <span class="p">},</span> <span class="cm">/* ATI SB600 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ATI</span><span class="p">,</span> <span class="mh">0x4390</span><span class="p">),</span> <span class="n">board_ahci_sb700</span> <span class="p">},</span> <span class="cm">/* ATI SB700/800 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ATI</span><span class="p">,</span> <span class="mh">0x4391</span><span class="p">),</span> <span class="n">board_ahci_sb700</span> <span class="p">},</span> <span class="cm">/* ATI SB700/800 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ATI</span><span class="p">,</span> <span class="mh">0x4392</span><span class="p">),</span> <span class="n">board_ahci_sb700</span> <span class="p">},</span> <span class="cm">/* ATI SB700/800 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ATI</span><span class="p">,</span> <span class="mh">0x4393</span><span class="p">),</span> <span class="n">board_ahci_sb700</span> <span class="p">},</span> <span class="cm">/* ATI SB700/800 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ATI</span><span class="p">,</span> <span class="mh">0x4394</span><span class="p">),</span> <span class="n">board_ahci_sb700</span> <span class="p">},</span> <span class="cm">/* ATI SB700/800 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ATI</span><span class="p">,</span> <span class="mh">0x4395</span><span class="p">),</span> <span class="n">board_ahci_sb700</span> <span class="p">},</span> <span class="cm">/* ATI SB700/800 */</span>

	<span class="cm">/* AMD */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span> <span class="mh">0x7800</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span> <span class="cm">/* AMD Hudson-2 */</span>
	<span class="cm">/* AMD is using RAID class only for ahci controllers */</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_AMD</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	  <span class="n">PCI_CLASS_STORAGE_RAID</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">board_ahci</span> <span class="p">},</span>

	<span class="cm">/* VIA */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x3349</span><span class="p">),</span> <span class="n">board_ahci_vt8251</span> <span class="p">},</span> <span class="cm">/* VIA VT8251 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x6287</span><span class="p">),</span> <span class="n">board_ahci_vt8251</span> <span class="p">},</span> <span class="cm">/* VIA VT8251 */</span>

	<span class="cm">/* NVIDIA */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x044c</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x044d</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x044e</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x044f</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x045c</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x045d</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x045e</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x045f</span><span class="p">),</span> <span class="n">board_ahci_mcp65</span> <span class="p">},</span>	<span class="cm">/* MCP65 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0550</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0551</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0552</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0553</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0554</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0555</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0556</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0557</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0558</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0559</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x055a</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x055b</span><span class="p">),</span> <span class="n">board_ahci_mcp67</span> <span class="p">},</span>	<span class="cm">/* MCP67 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0580</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0581</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0582</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0583</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0584</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0585</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0586</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0587</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0588</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0589</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x058a</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x058b</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x058c</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x058d</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x058e</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x058f</span><span class="p">),</span> <span class="n">board_ahci_mcp_linux</span> <span class="p">},</span>	<span class="cm">/* Linux ID */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f0</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f1</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f2</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f3</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f4</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f5</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f6</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f7</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f8</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07f9</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07fa</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x07fb</span><span class="p">),</span> <span class="n">board_ahci_mcp73</span> <span class="p">},</span>	<span class="cm">/* MCP73 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad0</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad1</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad2</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad3</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad4</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad5</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad6</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad7</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad8</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ad9</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ada</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0adb</span><span class="p">),</span> <span class="n">board_ahci_mcp77</span> <span class="p">},</span>	<span class="cm">/* MCP77 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ab4</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ab5</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ab6</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ab7</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ab8</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0ab9</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0aba</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0abb</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0abc</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0abd</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0abe</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0abf</span><span class="p">),</span> <span class="n">board_ahci_mcp79</span> <span class="p">},</span>	<span class="cm">/* MCP79 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d84</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d85</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d86</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d87</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d88</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d89</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d8a</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d8b</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d8c</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d8d</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d8e</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0d8f</span><span class="p">),</span> <span class="n">board_ahci_mcp89</span> <span class="p">},</span>	<span class="cm">/* MCP89 */</span>

	<span class="cm">/* SiS */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="mh">0x1184</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span>		<span class="cm">/* SiS 966 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="mh">0x1185</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span>		<span class="cm">/* SiS 968 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="mh">0x0186</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span>		<span class="cm">/* SiS 968 */</span>

	<span class="cm">/* ST Microelectronics */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">STMICRO</span><span class="p">,</span> <span class="mh">0xCC06</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span>		<span class="cm">/* ST ConneXt */</span>

	<span class="cm">/* Marvell */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x6145</span><span class="p">),</span> <span class="n">board_ahci_mv</span> <span class="p">},</span>	<span class="cm">/* 6145 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x6121</span><span class="p">),</span> <span class="n">board_ahci_mv</span> <span class="p">},</span>	<span class="cm">/* 6121 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x1b4b</span><span class="p">,</span> <span class="mh">0x9123</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">PCI_CLASS_STORAGE_SATA_AHCI</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">board_ahci_yes_fbs</span> <span class="p">},</span>			<span class="cm">/* 88se9128 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x1b4b</span><span class="p">,</span> <span class="mh">0x9125</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">board_ahci_yes_fbs</span> <span class="p">},</span>			<span class="cm">/* 88se9125 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x1b4b</span><span class="p">,</span> <span class="mh">0x917a</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">board_ahci_yes_fbs</span> <span class="p">},</span>			<span class="cm">/* 88se9172 */</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x1b4b</span><span class="p">,</span> <span class="mh">0x91a3</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">board_ahci_yes_fbs</span> <span class="p">},</span>

	<span class="cm">/* Promise */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">PROMISE</span><span class="p">,</span> <span class="mh">0x3f20</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span>	<span class="cm">/* PDC42819 */</span>

	<span class="cm">/* Asmedia */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ASMEDIA</span><span class="p">,</span> <span class="mh">0x0612</span><span class="p">),</span> <span class="n">board_ahci</span> <span class="p">},</span>	<span class="cm">/* ASM1061 */</span>

	<span class="cm">/* Generic, PCI class code for AHCI */</span>
	<span class="p">{</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	  <span class="n">PCI_CLASS_STORAGE_SATA_AHCI</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="n">board_ahci</span> <span class="p">},</span>

	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ahci_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">ahci_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">ahci_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>			<span class="o">=</span> <span class="n">ata_pci_remove_one</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">ahci_pci_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">ahci_pci_device_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#if defined(CONFIG_PATA_MARVELL) || defined(CONFIG_PATA_MARVELL_MODULE)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">marvell_enable</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">marvell_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">marvell_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">marvell_enable</span><span class="p">,</span> <span class="s">&quot;Marvell SATA via AHCI (1 = enabled)&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_pci_save_initial_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">force_port_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask_port_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_JMICRON</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2361</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;JMB361 has only one port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">force_port_map</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Temporary Marvell 6145 hack: PATA port presence</span>
<span class="cm">	 * is asserted through the standard AHCI port</span>
<span class="cm">	 * presence register, as bit 4 (counting from 0)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_MV_PATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x6121</span><span class="p">)</span>
			<span class="n">mask_port_map</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mask_port_map</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="s">&quot;Disabling your PATA port. Use the boot option &#39;ahci.marvell_enable=0&#39; to avoid this.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ahci_save_initial_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">hpriv</span><span class="p">,</span> <span class="n">force_port_map</span><span class="p">,</span>
				 <span class="n">mask_port_map</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_pci_reset_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ahci_reset_controller</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">tmp16</span><span class="p">;</span>

		<span class="cm">/* configure PCS */</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp16</span> <span class="o">&amp;</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp16</span> <span class="o">|=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span><span class="p">;</span>
			<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="n">tmp16</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_pci_init_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_MV_PATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x6121</span><span class="p">)</span>
			<span class="n">mv</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mv</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">port_mmio</span> <span class="o">=</span> <span class="n">__ahci_port_base</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">mv</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>

		<span class="cm">/* clear port IRQ */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;PORT_IRQ_STAT 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ahci_init_controller</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_vt8251_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">online</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_link_hardreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">sata_ehc_deb_timing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">),</span>
				 <span class="n">deadline</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">online</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, rc=%d, class=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">class</span><span class="p">);</span>

	<span class="cm">/* vt8251 doesn&#39;t clear BSY on signature FIS reception,</span>
<span class="cm">	 * request follow-up softreset.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">online</span> <span class="o">?</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_p5wdh_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">d2h_fis</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis</span> <span class="o">+</span> <span class="n">RX_FIS_D2H_REG</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">online</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* clear D2H reception area to properly wait for D2H FIS */</span>
	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">ata_tf_to_fis</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d2h_fis</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_link_hardreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">sata_ehc_deb_timing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">),</span>
				 <span class="n">deadline</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">online</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* The pseudo configuration device on SIMG4726 attached to</span>
<span class="cm">	 * ASUS P5W-DH Deluxe doesn&#39;t send signature FIS after</span>
<span class="cm">	 * hardreset if no device is attached to the first downstream</span>
<span class="cm">	 * port &amp;&amp; the pseudo device locks up on SRST w/ PMP==0.  To</span>
<span class="cm">	 * work around this, wait for !BSY only briefly.  If BSY isn&#39;t</span>
<span class="cm">	 * cleared, perform CLO and proceed to IDENTIFY (achieved by</span>
<span class="cm">	 * ATA_LFLAG_NO_SRST and ATA_LFLAG_ASSUME_ATA).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Wait for two seconds.  Devices attached to downstream port</span>
<span class="cm">	 * which can&#39;t process the following IDENTIFY after this will</span>
<span class="cm">	 * have to be reset again.  For most cases, this should</span>
<span class="cm">	 * suffice while making probing snappish enough.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">online</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_wait_after_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span>
					  <span class="n">ahci_check_ready</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">ahci_kick_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_pci_device_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">PM_EVENT_SUSPEND</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_NO_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;BIOS update required for suspend/resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">&amp;</span> <span class="n">PM_EVENT_SLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AHCI spec rev1.1 section 8.3.3:</span>
<span class="cm">		 * Software must disable interrupts prior to requesting a</span>
<span class="cm">		 * transition of the HBA to D3 state.</span>
<span class="cm">		 */</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
		<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HOST_IRQ_EN</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ctl</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ata_pci_device_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">mesg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_pci_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_device_do_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_pci_reset_controller</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">ahci_pci_init_controller</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_configure_dma_masks</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">using_dac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device fixup already set the dma_mask to some non-standard</span>
<span class="cm">	 * value, don&#39;t extend it here. This happens on STA2X11, for example.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">&lt;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">using_dac</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;64-bit DMA enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;32-bit DMA enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;32-bit consistent DMA enable failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_pci_print_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">cc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scc_s</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">PCI_CLASS_STORAGE_IDE</span><span class="p">)</span>
		<span class="n">scc_s</span> <span class="o">=</span> <span class="s">&quot;IDE&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">PCI_CLASS_STORAGE_SATA</span><span class="p">)</span>
		<span class="n">scc_s</span> <span class="o">=</span> <span class="s">&quot;SATA&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cc</span> <span class="o">==</span> <span class="n">PCI_CLASS_STORAGE_RAID</span><span class="p">)</span>
		<span class="n">scc_s</span> <span class="o">=</span> <span class="s">&quot;RAID&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scc_s</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>

	<span class="n">ahci_print_info</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">scc_s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* On ASUS P5W DH Deluxe, the second port of PCI device 00:1f.2 is</span>
<span class="cm"> * hardwired to on-board SIMG 4726.  The chipset is ICH8 and doesn&#39;t</span>
<span class="cm"> * support PMP and the 4726 either directly exports the device</span>
<span class="cm"> * attached to the first downstream port or acts as a hardware storage</span>
<span class="cm"> * controller and emulate a single ATA device (can be RAID 0/1 or some</span>
<span class="cm"> * other configuration).</span>
<span class="cm"> *</span>
<span class="cm"> * When there&#39;s no device attached to the first downstream port of the</span>
<span class="cm"> * 4726, &quot;Config Disk&quot; appears, which is a pseudo ATA device to</span>
<span class="cm"> * configure the 4726.  However, ATA emulation of the device is very</span>
<span class="cm"> * lame.  It doesn&#39;t send signature D2H Reg FIS after the initial</span>
<span class="cm"> * hardreset, pukes on SRST w/ PMP==0 and has bunch of other issues.</span>
<span class="cm"> *</span>
<span class="cm"> * The following function works around the problem by always using</span>
<span class="cm"> * hardreset on the port and not depending on receiving signature FIS</span>
<span class="cm"> * afterward.  If signature FIS isn&#39;t received soon, ATA class is</span>
<span class="cm"> * assumed without follow-up softreset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_p5wdh_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">sysids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;P5W DH Deluxe&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
					  <span class="s">&quot;ASUSTEK COMPUTER INC&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;P5W DH Deluxe&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dmi_check_system</span><span class="p">(</span><span class="n">sysids</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;enabling ASUS P5W DH Deluxe on-board SIMG4726 workaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_p5wdh_ops</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_SRST</span> <span class="o">|</span> <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* only some SB600 ahci controllers can do 64bit DMA */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ahci_sb600_enable_64bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">sysids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The oldest version known to be broken is 0901 and</span>
<span class="cm">		 * working is 1501 which was released on 2007-10-26.</span>
<span class="cm">		 * Enable 64bit DMA on 1501 and anything newer.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Please read bko#9412 for more info.</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;ASUS M2A-VM&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span>
					  <span class="s">&quot;ASUSTeK Computer INC.&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;M2A-VM&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="s">&quot;20071026&quot;</span><span class="p">,</span>	<span class="cm">/* yyyymmdd */</span>
		<span class="p">},</span>
		<span class="cm">/*</span>
<span class="cm">		 * All BIOS versions for the MSI K9A2 Platinum (MS-7376)</span>
<span class="cm">		 * support 64bit DMA.</span>
<span class="cm">		 *</span>
<span class="cm">		 * BIOS versions earlier than 1.5 had the Manufacturer DMI</span>
<span class="cm">		 * fields as &quot;MICRO-STAR INTERANTIONAL CO.,LTD&quot;.</span>
<span class="cm">		 * This spelling mistake was fixed in BIOS version 1.5, so</span>
<span class="cm">		 * 1.5 and later have the Manufacturer as</span>
<span class="cm">		 * &quot;MICRO-STAR INTERNATIONAL CO.,LTD&quot;.</span>
<span class="cm">		 * So try to match on DMI_BOARD_VENDOR of &quot;MICRO-STAR INTER&quot;.</span>
<span class="cm">		 *</span>
<span class="cm">		 * BIOS versions earlier than 1.9 had a Board Product Name</span>
<span class="cm">		 * DMI field of &quot;MS-7376&quot;. This was changed to be</span>
<span class="cm">		 * &quot;K9A2 Platinum (MS-7376)&quot; in version 1.9, but we can still</span>
<span class="cm">		 * match on DMI_BOARD_NAME of &quot;MS-7376&quot;.</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI K9A2 Platinum&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span>
					  <span class="s">&quot;MICRO-STAR INTER&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;MS-7376&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="cm">/*</span>
<span class="cm">		 * All BIOS versions for the Asus M3A support 64bit DMA.</span>
<span class="cm">		 * (all release versions from 0301 to 1206 were tested)</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;ASUS M3A&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span>
					  <span class="s">&quot;ASUSTeK Computer INC.&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;M3A&quot;</span><span class="p">),</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">dmi_first_match</span><span class="p">(</span><span class="n">sysids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">!=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mh">0x12</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">enable_64bit</span><span class="p">;</span>

	<span class="n">dmi_get_date</span><span class="p">(</span><span class="n">DMI_BIOS_DATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">year</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">month</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">date</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%04d%02d%02d&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">enable_64bit</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: BIOS too old, forcing 32bit DMA, update BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">match</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">enable_64bit:</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: enabling 64bit DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ahci_broken_system_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">broken_systems</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP Compaq nx6310&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq nx6310&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="cm">/* PCI slot number of the controller */</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x1FUL</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HP Compaq 6720s&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;HP Compaq 6720s&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="cm">/* PCI slot number of the controller */</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x1FUL</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">dmi</span> <span class="o">=</span> <span class="n">dmi_first_match</span><span class="p">(</span><span class="n">broken_systems</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">slot</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dmi</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
		<span class="cm">/* apply the quirk only to on-board controllers */</span>
		<span class="k">return</span> <span class="n">slot</span> <span class="o">==</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ahci_broken_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">sysids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * On HP dv[4-6] and HDX18 with earlier BIOSen, link</span>
<span class="cm">		 * to the harddisk doesn&#39;t become online after</span>
<span class="cm">		 * resuming from STR.  Warn and fail suspend.</span>
<span class="cm">		 *</span>
<span class="cm">		 * http://bugzilla.kernel.org/show_bug.cgi?id=12276</span>
<span class="cm">		 *</span>
<span class="cm">		 * Use dates instead of versions to match as HP is</span>
<span class="cm">		 * apparently recycling both product and version</span>
<span class="cm">		 * strings.</span>
<span class="cm">		 *</span>
<span class="cm">		 * http://bugzilla.kernel.org/show_bug.cgi?id=15462</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;dv4&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span>
					  <span class="s">&quot;HP Pavilion dv4 Notebook PC&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="s">&quot;20090105&quot;</span><span class="p">,</span>	<span class="cm">/* F.30 */</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;dv5&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span>
					  <span class="s">&quot;HP Pavilion dv5 Notebook PC&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="s">&quot;20090506&quot;</span><span class="p">,</span>	<span class="cm">/* F.16 */</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;dv6&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span>
					  <span class="s">&quot;HP Pavilion dv6 Notebook PC&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="s">&quot;20090423&quot;</span><span class="p">,</span>	<span class="cm">/* F.21 */</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;HDX18&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Hewlett-Packard&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span>
					  <span class="s">&quot;HP HDX18 Notebook PC&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="s">&quot;20090430&quot;</span><span class="p">,</span>	<span class="cm">/* F.23 */</span>
		<span class="p">},</span>
		<span class="cm">/*</span>
<span class="cm">		 * Acer eMachines G725 has the same problem.  BIOS</span>
<span class="cm">		 * V1.03 is known to be broken.  V3.04 is known to</span>
<span class="cm">		 * work.  Between, there are V1.06, V2.06 and V3.03</span>
<span class="cm">		 * that we don&#39;t have much idea about.  For now,</span>
<span class="cm">		 * blacklist anything older than V3.04.</span>
<span class="cm">		 *</span>
<span class="cm">		 * http://bugzilla.kernel.org/show_bug.cgi?id=15104</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;G725&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;eMachines&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;eMachines G725&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="s">&quot;20091216&quot;</span><span class="p">,</span>	<span class="cm">/* V3.04 */</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">dmi</span> <span class="o">=</span> <span class="n">dmi_first_match</span><span class="p">(</span><span class="n">sysids</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">!=</span> <span class="n">PCI_DEVFN</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dmi_get_date</span><span class="p">(</span><span class="n">DMI_BIOS_DATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">year</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">month</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">date</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="s">&quot;%04d%02d%02d&quot;</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dmi</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ahci_broken_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ENCODE_BUSDEVFN(bus, slot, func)			\</span>
<span class="cp">	(void *)(unsigned long)(((bus) &lt;&lt; 8) | PCI_DEVFN((slot), (func)))</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">sysids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * There are several gigabyte boards which use</span>
<span class="cm">		 * SIMG5723s configured as hardware RAID.  Certain</span>
<span class="cm">		 * 5723 firmware revisions shipped there keep the link</span>
<span class="cm">		 * online but fail to answer properly to SRST or</span>
<span class="cm">		 * IDENTIFY when no device is attached downstream</span>
<span class="cm">		 * causing libata to retry quite a few times leading</span>
<span class="cm">		 * to excessive detection delay.</span>
<span class="cm">		 *</span>
<span class="cm">		 * As these firmwares respond to the second reset try</span>
<span class="cm">		 * with invalid device signature, considering unknown</span>
<span class="cm">		 * sig as offline works around the problem acceptably.</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;EP45-DQ6&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span>
					  <span class="s">&quot;Gigabyte Technology Co., Ltd.&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;EP45-DQ6&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ENCODE_BUSDEVFN</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;EP45-DS5&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span>
					  <span class="s">&quot;Gigabyte Technology Co., Ltd.&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;EP45-DS5&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ENCODE_BUSDEVFN</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminate list */</span>
	<span class="p">};</span>
<span class="cp">#undef ENCODE_BUSDEVFN</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">dmi</span> <span class="o">=</span> <span class="n">dmi_first_match</span><span class="p">(</span><span class="n">sysids</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dmi</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">==</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ATA_ACPI</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_gtf_filter_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">sysids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Aspire 3810T issues a bunch of SATA enable commands</span>
<span class="cm">		 * via _GTF including an invalid one and one which is</span>
<span class="cm">		 * rejected by the device.  Among the successful ones</span>
<span class="cm">		 * is FPDMA non-zero offset enable which when enabled</span>
<span class="cm">		 * only on the drive side leads to NCQ command</span>
<span class="cm">		 * failures.  Filter it out.</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Aspire 3810T&quot;</span><span class="p">,</span>
			<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
				<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 3810T&quot;</span><span class="p">),</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ATA_ACPI_FILTER_FPDMA_OFFSET</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">dmi</span> <span class="o">=</span> <span class="n">dmi_first_match</span><span class="p">(</span><span class="n">sysids</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">filter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmi</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">filter</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dmi</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;applying extra ACPI _GTF filter 0x%x for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">filter</span><span class="p">,</span> <span class="n">dmi</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
			<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">gtf_filter</span> <span class="o">|=</span> <span class="n">filter</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ahci_gtf_filter_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">board_id</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">ahci_port_info</span><span class="p">[</span><span class="n">board_id</span><span class="p">];</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_ports</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ahci_pci_bar</span> <span class="o">=</span> <span class="n">AHCI_PCI_BAR_STANDARD</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">ATA_MAX_QUEUE</span> <span class="o">&gt;</span> <span class="n">AHCI_MAX_CMDS</span><span class="p">);</span>

	<span class="n">ata_print_version_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="cm">/* The AHCI driver can only drive the SATA ports, the PATA driver</span>
<span class="cm">	   can drive them all so if both drivers are selected make sure</span>
<span class="cm">	   AHCI stays out of the way */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_MARVELL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">marvell_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For some reason, MCP89 on MacBook 7,1 doesn&#39;t work with</span>
<span class="cm">	 * ahci, use ata_generic instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_NVIDIA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP89_SATA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0xcb89</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Promise&#39;s PDC42819 is a SAS/SATA controller that has an AHCI mode.</span>
<span class="cm">	 * At the moment, we can only use the AHCI mode. Let the users know</span>
<span class="cm">	 * that for SAS drives they&#39;re out of luck.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_PROMISE</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;PDC42819 can only drive SATA devices with this driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* The Connext uses non-standard BAR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_STMICRO</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0xCC06</span><span class="p">)</span>
		<span class="n">ahci_pci_bar</span> <span class="o">=</span> <span class="n">AHCI_PCI_BAR_STA2X11</span><span class="p">;</span>

	<span class="cm">/* acquire resources */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* AHCI controllers often implement SFF compatible interface.</span>
<span class="cm">	 * Grab all PCI BARs just in case.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_iomap_regions_request_all</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ahci_pci_bar</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
		<span class="n">pcim_pin_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_INTEL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2652</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x2653</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">map</span><span class="p">;</span>

		<span class="cm">/* ICH6s share the same PCI ID for both piix and ahci</span>
<span class="cm">		 * modes.  Enabling ahci mode while MAP indicates</span>
<span class="cm">		 * combined mode is a bad idea.  Yield to ata_piix.</span>
<span class="cm">		 */</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ICH_MAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;controller is in combined mode, can&#39;t enable AHCI mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hpriv</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hpriv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpriv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pi</span><span class="p">.</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* MCP65 revision A1 and A2 can&#39;t do MSI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board_id</span> <span class="o">==</span> <span class="n">board_ahci_mcp65</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0xa1</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="mh">0xa2</span><span class="p">))</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHCI_HFLAG_NO_MSI</span><span class="p">;</span>

	<span class="cm">/* SB800 does NOT need the workaround to ignore SERR_INTERNAL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">board_id</span> <span class="o">==</span> <span class="n">board_ahci_sb700</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHCI_HFLAG_IGN_SERR_INTERNAL</span><span class="p">;</span>

	<span class="cm">/* only some SB600s can do 64bit DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahci_sb600_enable_64bit</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AHCI_HFLAG_32BIT_ONLY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_NO_MSI</span><span class="p">)</span> <span class="o">||</span> <span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">pci_intx</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pcim_iomap_table</span><span class="p">(</span><span class="n">pdev</span><span class="p">)[</span><span class="n">ahci_pci_bar</span><span class="p">];</span>

	<span class="cm">/* save initial config */</span>
	<span class="n">ahci_pci_save_initial_config</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hpriv</span><span class="p">);</span>

	<span class="cm">/* prepare host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_NCQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pi</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_NCQ</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Auto-activate optimization is supposed to be</span>
<span class="cm">		 * supported on all AHCI controllers indicating NCQ</span>
<span class="cm">		 * capability, but it seems to be broken on some</span>
<span class="cm">		 * chipsets including NVIDIAs.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_NO_FPDMA_AA</span><span class="p">))</span>
			<span class="n">pi</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_FPDMA_AA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_PMP</span><span class="p">)</span>
		<span class="n">pi</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_PMP</span><span class="p">;</span>

	<span class="n">ahci_set_em_messages</span><span class="p">(</span><span class="n">hpriv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahci_broken_system_poweroff</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pi</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_NO_POWEROFF_SPINDOWN</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;quirky BIOS, skipping spindown on poweroff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahci_broken_suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHCI_HFLAG_NO_SUSPEND</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;BIOS update required for suspend/resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ahci_broken_online</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AHCI_HFLAG_SRST_TOUT_IS_OFFLINE</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;online status unreliable, applying workaround</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* CAP.NP sometimes indicate the index of the last enabled</span>
<span class="cm">	 * port, at other times, that of the last possible port, so</span>
<span class="cm">	 * determining the maximum port number requires looking at</span>
<span class="cm">	 * both CAP.NP and port_map.</span>
<span class="cm">	 */</span>
	<span class="n">n_ports</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ahci_nr_ports</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">),</span> <span class="n">fls</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span><span class="p">));</span>

	<span class="n">host</span> <span class="o">=</span> <span class="n">ata_host_alloc_pinfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="n">n_ports</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hpriv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SSS</span><span class="p">)</span> <span class="o">||</span> <span class="n">ahci_ignore_sss</span><span class="p">)</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_HOST_PARALLEL_SCAN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ahci: SSS flag set, parallel bus scan disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_EM</span><span class="p">)</span>
		<span class="n">ahci_reset_em</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ata_port_pbar_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ahci_pci_bar</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;abar&quot;</span><span class="p">);</span>
		<span class="n">ata_port_pbar_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ahci_pci_bar</span><span class="p">,</span>
				   <span class="mh">0x100</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="mh">0x80</span><span class="p">,</span> <span class="s">&quot;port&quot;</span><span class="p">);</span>

		<span class="cm">/* set enclosure management message type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_EM</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">em_message_type</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_msg_type</span><span class="p">;</span>


		<span class="cm">/* disabled/not-implemented port */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_dummy_port_ops</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* apply workaround for ASUS P5W DH Deluxe mainboard */</span>
	<span class="n">ahci_p5wdh_workaround</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* apply gtf filter quirk */</span>
	<span class="n">ahci_gtf_filter_workaround</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* initialize adapter */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_configure_dma_masks</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_pci_reset_controller</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ahci_pci_init_controller</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="n">ahci_pci_print_info</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ata_host_activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ahci_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">ahci_sht</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ahci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahci_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ahci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ahci_pci_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jeff Garzik&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AHCI SATA low-level driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ahci_pci_tbl</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ahci_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ahci_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
