<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › libata-pmp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>libata-pmp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * libata-pmp.c - libata port multiplier support</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2007  SUSE Linux Products GmbH</span>
<span class="cm"> * Copyright (c) 2007  Tejun Heo &lt;teheo@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPLv2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &quot;libata.h&quot;</span>
<span class="cp">#include &quot;libata-transport.h&quot;</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">sata_pmp_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sata_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pmp_prereset</span>		<span class="o">=</span> <span class="n">ata_std_prereset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pmp_hardreset</span>		<span class="o">=</span> <span class="n">sata_std_hardreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pmp_postreset</span>		<span class="o">=</span> <span class="n">ata_std_postreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>		<span class="o">=</span> <span class="n">sata_pmp_error_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_read - read PMP register</span>
<span class="cm"> *	@link: link to read PMP register for</span>
<span class="cm"> *	@reg: register to read</span>
<span class="cm"> *	@r_val: resulting value</span>
<span class="cm"> *</span>
<span class="cm"> *	Read PMP register.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, AC_ERR_* mask on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sata_pmp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">r_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">pmp_dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_PMP_READ</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ATA_PROT_NODATA</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_TFLAG_ISADDR</span> <span class="o">|</span> <span class="n">ATA_TFLAG_DEVICE</span> <span class="o">|</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_exec_internal</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">SATA_PMP_RW_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="o">*</span><span class="n">r_val</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">nsect</span> <span class="o">|</span> <span class="n">tf</span><span class="p">.</span><span class="n">lbal</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">tf</span><span class="p">.</span><span class="n">lbam</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">tf</span><span class="p">.</span><span class="n">lbah</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_write - write PMP register</span>
<span class="cm"> *	@link: link to write PMP register for</span>
<span class="cm"> *	@reg: register to write</span>
<span class="cm"> *	@r_val: value to write</span>
<span class="cm"> *</span>
<span class="cm"> *	Write PMP register.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, AC_ERR_* mask on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sata_pmp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">pmp_dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>

	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_PMP_WRITE</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ATA_PROT_NODATA</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_TFLAG_ISADDR</span> <span class="o">|</span> <span class="n">ATA_TFLAG_DEVICE</span> <span class="o">|</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">lbal</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">lbam</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">lbah</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ata_exec_internal</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">SATA_PMP_RW_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_qc_defer_cmd_switch - qc_defer for command switching PMP</span>
<span class="cm"> *	@qc: ATA command in question</span>
<span class="cm"> *</span>
<span class="cm"> *	A host which has command switching PMP support cannot issue</span>
<span class="cm"> *	commands to multiple links simultaneously.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	ATA_DEFER_* if deferring is needed, 0 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sata_pmp_qc_defer_cmd_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">excl_link</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">excl_link</span> <span class="o">==</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_active_links</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ata_link_active</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_CLEAR_EXCL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ata_std_qc_defer</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">excl_link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ATA_DEFER_PORT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_scr_read - read PSCR</span>
<span class="cm"> *	@link: ATA link to read PSCR for</span>
<span class="cm"> *	@reg: PSCR to read</span>
<span class="cm"> *	@r_val: resulting value</span>
<span class="cm"> *</span>
<span class="cm"> *	Read PSCR @reg into @r_val for @link, to be called from</span>
<span class="cm"> *	ata_scr_read().</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sata_pmp_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">r_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="n">SATA_PMP_PSCR_CONTROL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_read</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">r_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;failed to read SCR %d (Emask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">reg</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_scr_write - write PSCR</span>
<span class="cm"> *	@link: ATA link to write PSCR for</span>
<span class="cm"> *	@reg: PSCR to write</span>
<span class="cm"> *	@val: value to be written</span>
<span class="cm"> *</span>
<span class="cm"> *	Write @val to PSCR @reg for @link, to be called from</span>
<span class="cm"> *	ata_scr_write() and ata_scr_write_flush().</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sata_pmp_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="n">SATA_PMP_PSCR_CONTROL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_write</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;failed to write SCR %d (Emask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">reg</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_set_lpm - configure LPM for a PMP link</span>
<span class="cm"> *	@link: PMP link to configure LPM for</span>
<span class="cm"> *	@policy: target LPM policy</span>
<span class="cm"> *	@hints: LPM hints</span>
<span class="cm"> *</span>
<span class="cm"> *	Configure LPM for @link.  This function will contain any PMP</span>
<span class="cm"> *	specific workarounds if necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sata_pmp_set_lpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ata_lpm_policy</span> <span class="n">policy</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sata_link_scr_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_read_gscr - read GSCR block of SATA PMP</span>
<span class="cm"> *	@dev: PMP device</span>
<span class="cm"> *	@gscr: buffer to read GSCR block into</span>
<span class="cm"> *</span>
<span class="cm"> *	Read selected PMP GSCRs from the PMP at @dev.  This will serve</span>
<span class="cm"> *	as configuration and identification info for the PMP.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_read_gscr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">gscr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">gscr_to_read</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">96</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gscr_to_read</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">gscr_to_read</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_read</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gscr</span><span class="p">[</span><span class="n">reg</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to read PMP GSCR[%d] (Emask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">reg</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">sata_pmp_spec_rev_str</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">gscr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_REV</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;1.2&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;1.1&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="s">&quot;1.0&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PMP_GSCR_SII_POL 129</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">print_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gscr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_vendor</span><span class="p">(</span><span class="n">gscr</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">devid</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_devid</span><span class="p">(</span><span class="n">gscr</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_ports</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">nr_ports</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_ports</span><span class="p">(</span><span class="n">gscr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_ports</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nr_ports</span> <span class="o">&gt;</span> <span class="n">SATA_PMP_MAX_PORTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;invalid nr_ports&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_AN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SATA_PMP_FEAT_NOTIFY</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_DFLAG_AN</span><span class="p">;</span>

	<span class="cm">/* monitor SERR_PHYRDY_CHG on fan-out ports */</span>
	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_write</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SATA_PMP_GSCR_ERROR_EN</span><span class="p">,</span>
				  <span class="n">SERR_PHYRDY_CHG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;failed to write GSCR_ERROR_EN&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable sending Early R_OK.</span>
<span class="cm">	 * With &quot;cached read&quot; HDD testing and multiple ports busy on a SATA</span>
<span class="cm">	 * host controller, 3726 PMP will very rarely drop a deferred</span>
<span class="cm">	 * R_OK that was intended for the host. Symptom will be all</span>
<span class="cm">	 * 5 drives under test will timeout, get reset, and recover.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x1095</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">==</span> <span class="mh">0x3726</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">PMP_GSCR_SII_POL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;failed to read Sil3726 Private Register&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">PMP_GSCR_SII_POL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;failed to write Sil3726 Private Register&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">print_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port Multiplier %s, &quot;</span>
			     <span class="s">&quot;0x%04x:0x%04x r%d, %d ports, feat 0x%x/0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">sata_pmp_spec_rev_str</span><span class="p">(</span><span class="n">gscr</span><span class="p">),</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span>
			     <span class="n">sata_pmp_gscr_rev</span><span class="p">(</span><span class="n">gscr</span><span class="p">),</span>
			     <span class="n">nr_ports</span><span class="p">,</span> <span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">],</span>
			     <span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_AN</span><span class="p">))</span>
			<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Asynchronous notification not supported, &quot;</span>
				<span class="s">&quot;hotplug won&#39;t work on fan-out ports. Use warm-plug instead.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
		    <span class="s">&quot;failed to configure Port Multiplier (%s, Emask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">reason</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_init_links</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_ports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">pmp_link</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pmp_link</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmp_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmp_link</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pmp_link</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">SATA_PMP_MAX_PORTS</span><span class="p">,</span>
				   <span class="n">GFP_NOIO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmp_link</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SATA_PMP_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ata_link_init</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pmp_link</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pmp_link</span> <span class="o">=</span> <span class="n">pmp_link</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SATA_PMP_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ata_tlink_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmp_link</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">err_tlink</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmp_link</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

		<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">probe_mask</span> <span class="o">|=</span> <span class="n">ATA_ALL_DEVICES</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nl">err_tlink:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ata_tlink_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmp_link</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pmp_link</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pmp_link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sata_pmp_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gscr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_vendor</span><span class="p">(</span><span class="n">gscr</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">devid</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_devid</span><span class="p">(</span><span class="n">gscr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x1095</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">==</span> <span class="mh">0x3726</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sil3726 quirks */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* link reports offline after LPM */</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_LPM</span><span class="p">;</span>

			<span class="cm">/* Class code report is unreliable. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">;</span>

			<span class="cm">/* port 5 is for SEMB device and it doesn&#39;t like SRST */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_SRST</span> <span class="o">|</span>
					       <span class="n">ATA_LFLAG_ASSUME_SEMB</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x1095</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">==</span> <span class="mh">0x4723</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sil4723 quirks */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* link reports offline after LPM */</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_LPM</span><span class="p">;</span>

			<span class="cm">/* class code report is unreliable */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">;</span>

			<span class="cm">/* the config device at port 2 locks up on SRST */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_SRST</span> <span class="o">|</span>
					       <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x1095</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">==</span> <span class="mh">0x4726</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sil4726 quirks */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* link reports offline after LPM */</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_LPM</span><span class="p">;</span>

			<span class="cm">/* Class code report is unreliable and SRST</span>
<span class="cm">			 * times out under certain configurations.</span>
<span class="cm">			 * Config device can be at port 0 or 5 and</span>
<span class="cm">			 * locks up on SRST.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_SRST</span> <span class="o">|</span>
					       <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">;</span>

			<span class="cm">/* Port 6 is for SEMB device which doesn&#39;t</span>
<span class="cm">			 * like SRST either.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
				<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_SRST</span> <span class="o">|</span>
					       <span class="n">ATA_LFLAG_ASSUME_SEMB</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x1095</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devid</span> <span class="o">==</span> <span class="mh">0x5723</span> <span class="o">||</span> <span class="n">devid</span> <span class="o">==</span> <span class="mh">0x5733</span> <span class="o">||</span>
					<span class="n">devid</span> <span class="o">==</span> <span class="mh">0x5734</span> <span class="o">||</span> <span class="n">devid</span> <span class="o">==</span> <span class="mh">0x5744</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* sil5723/5744 quirks */</span>

		<span class="cm">/* sil5723/5744 has either two or three downstream</span>
<span class="cm">		 * ports depending on operation mode.  The last port</span>
<span class="cm">		 * is empty if any actual IO device is available or</span>
<span class="cm">		 * occupied by a pseudo configuration device</span>
<span class="cm">		 * otherwise.  Don&#39;t try hard to recover it.</span>
<span class="cm">		 */</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pmp_link</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_pmp_links</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_RETRY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">==</span> <span class="mh">0x197b</span> <span class="o">&amp;&amp;</span> <span class="n">devid</span> <span class="o">==</span> <span class="mh">0x2352</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* chip found in Thermaltake BlackX Duet, jmicron JMB350? */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SRST breaks detection and disks get misclassified</span>
<span class="cm">			 * LPM disabled to avoid potential problems</span>
<span class="cm">			 */</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_LPM</span> <span class="o">|</span>
				       <span class="n">ATA_LFLAG_NO_SRST</span> <span class="o">|</span>
				       <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_attach - attach a SATA PMP device</span>
<span class="cm"> *	@dev: SATA PMP device to attach</span>
<span class="cm"> *</span>
<span class="cm"> *	Configure and attach SATA PMP device @dev.  This function is</span>
<span class="cm"> *	also responsible for allocating and initializing PMP links.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sata_pmp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* is it hanging off the right place? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_pmp_supported</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;host does not support Port Multiplier</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port Multipliers cannot be nested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port Multiplier must be the first device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">=</span> <span class="n">SATA_PMP_CTRL_PORT</span><span class="p">;</span>

	<span class="cm">/* read GSCR block */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_read_gscr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* config PMP */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_init_links</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sata_pmp_gscr_ports</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize PMP links</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* attach it */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_pmp_links</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_pmp_links</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_ports</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sata_pmp_quirks</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_attach</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_attach</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">tlink</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
		<span class="n">sata_link_init_spd</span><span class="p">(</span><span class="n">tlink</span><span class="p">);</span>

	<span class="n">ata_acpi_associate_sata_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_detach - detach a SATA PMP device</span>
<span class="cm"> *	@dev: SATA PMP device to detach</span>
<span class="cm"> *</span>
<span class="cm"> *	Detach SATA PMP device @dev.  This function is also</span>
<span class="cm"> *	responsible for deconfiguring PMP links.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sata_pmp_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Port Multiplier detaching</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span> <span class="o">||</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">!=</span> <span class="n">SATA_PMP_CTRL_PORT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_detach</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_detach</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">tlink</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
		<span class="n">ata_eh_detach_dev</span><span class="p">(</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_pmp_links</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ata_acpi_associate_sata_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_same_pmp - does new GSCR matches the configured PMP?</span>
<span class="cm"> *	@dev: PMP device to compare against</span>
<span class="cm"> *	@new_gscr: GSCR block of the new device</span>
<span class="cm"> *</span>
<span class="cm"> *	Compare @new_gscr against @dev and determine whether @dev is</span>
<span class="cm"> *	the PMP described by @new_gscr.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	1 if @dev matches @new_gscr, 0 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_same_pmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">new_gscr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">old_gscr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">old_vendor</span><span class="p">,</span> <span class="n">new_vendor</span><span class="p">,</span> <span class="n">old_devid</span><span class="p">,</span> <span class="n">new_devid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_nr_ports</span><span class="p">,</span> <span class="n">new_nr_ports</span><span class="p">;</span>

	<span class="n">old_vendor</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_vendor</span><span class="p">(</span><span class="n">old_gscr</span><span class="p">);</span>
	<span class="n">new_vendor</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_vendor</span><span class="p">(</span><span class="n">new_gscr</span><span class="p">);</span>
	<span class="n">old_devid</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_devid</span><span class="p">(</span><span class="n">old_gscr</span><span class="p">);</span>
	<span class="n">new_devid</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_devid</span><span class="p">(</span><span class="n">new_gscr</span><span class="p">);</span>
	<span class="n">old_nr_ports</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_ports</span><span class="p">(</span><span class="n">old_gscr</span><span class="p">);</span>
	<span class="n">new_nr_ports</span> <span class="o">=</span> <span class="n">sata_pmp_gscr_ports</span><span class="p">(</span><span class="n">new_gscr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_vendor</span> <span class="o">!=</span> <span class="n">new_vendor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;Port Multiplier vendor mismatch &#39;0x%x&#39; != &#39;0x%x&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">old_vendor</span><span class="p">,</span> <span class="n">new_vendor</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_devid</span> <span class="o">!=</span> <span class="n">new_devid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;Port Multiplier device ID mismatch &#39;0x%x&#39; != &#39;0x%x&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">old_devid</span><span class="p">,</span> <span class="n">new_devid</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_nr_ports</span> <span class="o">!=</span> <span class="n">new_nr_ports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;Port Multiplier nr_ports mismatch &#39;0x%x&#39; != &#39;0x%x&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">old_nr_ports</span><span class="p">,</span> <span class="n">new_nr_ports</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_revalidate - revalidate SATA PMP</span>
<span class="cm"> *	@dev: PMP device to revalidate</span>
<span class="cm"> *	@new_class: new class code</span>
<span class="cm"> *</span>
<span class="cm"> *	Re-read GSCR block and make sure @dev is still attached to the</span>
<span class="cm"> *	port and properly configured.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_revalidate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gscr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sector_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ata_eh_about_to_do</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wrong class? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_class_enabled</span><span class="p">(</span><span class="n">new_class</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">new_class</span> <span class="o">!=</span> <span class="n">ATA_DEV_PMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read GSCR */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_read_gscr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gscr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* is the pmp still there? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_pmp_same_pmp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gscr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">,</span> <span class="n">gscr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gscr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">SATA_PMP_GSCR_DWORDS</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ata_eh_done</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, rc=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PMP revalidation failed (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_revalidate_quick - revalidate SATA PMP quickly</span>
<span class="cm"> *	@dev: PMP device to revalidate</span>
<span class="cm"> *</span>
<span class="cm"> *	Make sure the attached PMP is accessible.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_revalidate_quick</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prod_id</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_read</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SATA_PMP_GSCR_PROD_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prod_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			    <span class="s">&quot;failed to read PMP product ID (Emask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">err_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prod_id</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_PROD_ID</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PMP product ID mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* something weird is going on, request full PMP recovery */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_eh_recover_pmp - recover PMP</span>
<span class="cm"> *	@ap: ATA port PMP is attached to</span>
<span class="cm"> *	@prereset: prereset method (can be NULL)</span>
<span class="cm"> *	@softreset: softreset method</span>
<span class="cm"> *	@hardreset: hardreset method</span>
<span class="cm"> *	@postreset: postreset method (can be NULL)</span>
<span class="cm"> *</span>
<span class="cm"> *	Recover PMP attached to @ap.  Recovery procedure is somewhat</span>
<span class="cm"> *	similar to that of ata_eh_recover() except that reset should</span>
<span class="cm"> *	always be performed in hard-&gt;soft sequence and recovery</span>
<span class="cm"> *	failure results in PMP detachment.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_eh_recover_pmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
		<span class="n">ata_prereset_fn_t</span> <span class="n">prereset</span><span class="p">,</span> <span class="n">ata_reset_fn_t</span> <span class="n">softreset</span><span class="p">,</span>
		<span class="n">ata_reset_fn_t</span> <span class="n">hardreset</span><span class="p">,</span> <span class="n">ata_postreset_fn_t</span> <span class="n">postreset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">ATA_EH_PMP_TRIES</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">detach</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reval_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_DETACH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">detach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">retry:</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">tlink</span><span class="p">;</span>

		<span class="cm">/* reset */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prereset</span><span class="p">,</span> <span class="n">softreset</span><span class="p">,</span> <span class="n">hardreset</span><span class="p">,</span>
				  <span class="n">postreset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;failed to reset PMP, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* PMP is reset, SErrors cannot be trusted, scan all */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">tlink</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tlink</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">probe_mask</span> <span class="o">|=</span> <span class="n">ATA_ALL_DEVICES</span><span class="p">;</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If revalidation is requested, revalidate and reconfigure;</span>
<span class="cm">	 * otherwise, do quick revalidation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_revalidate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_revalidate_quick</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tries</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">probe_mask</span> <span class="o">|=</span> <span class="n">ATA_ALL_DEVICES</span><span class="p">;</span>
			<span class="n">detach</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* give it just two more chances */</span>
			<span class="n">tries</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">tries</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tries</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* consecutive revalidation failures? speed down */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reval_failed</span><span class="p">)</span>
				<span class="n">sata_down_spd_limit</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">reval_failed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;failed to recover PMP after %d tries, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ATA_EH_PMP_TRIES</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* okay, PMP resurrected */</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, rc=0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">sata_pmp_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">detach</span><span class="p">)</span>
		<span class="n">ata_eh_detach_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_eh_handle_disabled_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_DISABLED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Some PMPs require hardreset sequence to get</span>
<span class="cm">		 * SError.N working.</span>
<span class="cm">		 */</span>
		<span class="n">sata_link_hardreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">sata_deb_timing_normal</span><span class="p">,</span>
				<span class="n">ata_deadline</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ATA_TMOUT_INTERNAL_QUICK</span><span class="p">),</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="cm">/* unconditionally clear SError.N */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_scr_write</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="n">SERR_PHYRDY_CHG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
				     <span class="s">&quot;failed to clear SError.N (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_handle_link_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">link_tries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link_tries</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">link_tries</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* disable this link */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_DISABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
			<span class="s">&quot;failed to recover link after %d tries, disabling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ATA_EH_PMP_LINK_TRIES</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_DISABLED</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_eh_recover - recover PMP-enabled port</span>
<span class="cm"> *	@ap: ATA port to recover</span>
<span class="cm"> *</span>
<span class="cm"> *	Drive EH recovery operation for PMP enabled port @ap.  This</span>
<span class="cm"> *	function recovers host and PMP ports with proper retrials and</span>
<span class="cm"> *	fallbacks.  Actual recovery operations are performed using</span>
<span class="cm"> *	ata_eh_recover() and sata_pmp_eh_recover_pmp().</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sata_pmp_eh_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmp_tries</span><span class="p">,</span> <span class="n">link_tries</span><span class="p">[</span><span class="n">SATA_PMP_MAX_PORTS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">pmp_link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">pmp_dev</span> <span class="o">=</span> <span class="n">pmp_link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">pmp_ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pmp_link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gscr</span> <span class="o">=</span> <span class="n">pmp_dev</span><span class="o">-&gt;</span><span class="n">gscr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gscr_error</span><span class="p">,</span> <span class="n">sntf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pmp_tries</span> <span class="o">=</span> <span class="n">ATA_EH_PMP_TRIES</span><span class="p">;</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
		<span class="n">link_tries</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_EH_PMP_LINK_TRIES</span><span class="p">;</span>

 <span class="nl">retry:</span>
	<span class="cm">/* PMP attached? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_recover</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">prereset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">softreset</span><span class="p">,</span>
				    <span class="n">ops</span><span class="o">-&gt;</span><span class="n">hardreset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">postreset</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
				<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pmp_dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">ATA_DEV_PMP</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* new PMP online */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
			<span class="n">link_tries</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_EH_PMP_LINK_TRIES</span><span class="p">;</span>

		<span class="cm">/* fall through */</span>
	<span class="p">}</span>

	<span class="cm">/* recover pmp */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_eh_recover_pmp</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">prereset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">softreset</span><span class="p">,</span>
				     <span class="n">ops</span><span class="o">-&gt;</span><span class="n">hardreset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">postreset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pmp_fail</span><span class="p">;</span>

	<span class="cm">/* PHY event notification can disturb reset and other recovery</span>
<span class="cm">	 * operations.  Turn it off.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SATA_PMP_FEAT_NOTIFY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SATA_PMP_FEAT_NOTIFY</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_write</span><span class="p">(</span><span class="n">pmp_link</span><span class="p">,</span> <span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">,</span>
					  <span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">pmp_link</span><span class="p">,</span>
				<span class="s">&quot;failed to disable NOTIFY (err_mask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">err_mask</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">pmp_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* handle disabled links */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_eh_handle_disabled_links</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">pmp_fail</span><span class="p">;</span>

	<span class="cm">/* recover links */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_recover</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_prereset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_softreset</span><span class="p">,</span>
			    <span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_hardreset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">pmp_postreset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">link_fail</span><span class="p">;</span>

	<span class="cm">/* clear SNotification */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_scr_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_NOTIFICATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sntf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sata_scr_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_NOTIFICATION</span><span class="p">,</span> <span class="n">sntf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If LPM is active on any fan-out port, hotplug wouldn&#39;t</span>
<span class="cm">	 * work.  Return w/ PHY event notification disabled.</span>
<span class="cm">	 */</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">&gt;</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Connection status might have changed while resetting other</span>
<span class="cm">	 * links, enable notification and check SATA_PMP_GSCR_ERROR</span>
<span class="cm">	 * before returning.</span>
<span class="cm">	 */</span>

	<span class="cm">/* enable notification */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmp_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_AN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SATA_PMP_FEAT_NOTIFY</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_write</span><span class="p">(</span><span class="n">pmp_link</span><span class="p">,</span> <span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">,</span>
					  <span class="n">gscr</span><span class="p">[</span><span class="n">SATA_PMP_GSCR_FEAT_EN</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">,</span>
				    <span class="s">&quot;failed to write PMP_FEAT_EN (Emask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">err_mask</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">pmp_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check GSCR_ERROR */</span>
	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">sata_pmp_read</span><span class="p">(</span><span class="n">pmp_link</span><span class="p">,</span> <span class="n">SATA_PMP_GSCR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gscr_error</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">,</span>
			    <span class="s">&quot;failed to read PMP_GSCR_ERROR (Emask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">err_mask</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">pmp_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gscr_error</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_handle_link_fail</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link_tries</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">.</span><span class="n">i</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
				<span class="s">&quot;PHY status changed but maxed out on retries, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
				<span class="s">&quot;Manually issue scan to resume this link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_port_info</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
			<span class="s">&quot;PMP SError.N set for some ports, repeating recovery</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">link_fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_handle_link_fail</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link_tries</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pmp_ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fall through */</span>
 <span class="nl">pmp_fail:</span>
	<span class="cm">/* Control always ends up here after detaching PMP.  Shut up</span>
<span class="cm">	 * and return if we&#39;re unloading.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_UNLOADING</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">pmp_tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pmp_ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;failed to recover PMP after %d tries, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ATA_EH_PMP_TRIES</span><span class="p">);</span>
	<span class="n">sata_pmp_detach</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">);</span>
	<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">pmp_dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_pmp_error_handler - do standard error handling for PMP-enabled host</span>
<span class="cm"> *	@ap: host port to handle error for</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform standard error handling sequence for PMP-enabled host</span>
<span class="cm"> *	@ap.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sata_pmp_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ata_eh_autopsy</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ata_eh_report</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">sata_pmp_eh_recover</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ata_eh_finish</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sata_pmp_port_ops</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sata_pmp_qc_defer_cmd_switch</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">sata_pmp_error_handler</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
