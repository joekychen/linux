<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › pata_amd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pata_amd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * pata_amd.c 	- AMD PATA for new ATA layer</span>
<span class="cm"> *			  (C) 2005-2006 Red Hat Inc</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on pata-sil680. Errata information is taken from data sheets</span>
<span class="cm"> *  and the amd74xx.c driver by Vojtech Pavlik. Nvidia SATA devices are</span>
<span class="cm"> *  claimed by sata-nv.c.</span>
<span class="cm"> *</span>
<span class="cm"> *  TODO:</span>
<span class="cm"> *	Variable system clock when/if it makes sense</span>
<span class="cm"> *	Power management on ports</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Documentation publicly available.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;pata_amd&quot;</span>
<span class="cp">#define DRV_VERSION &quot;0.4.1&quot;</span>

<span class="cm">/**</span>
<span class="cm"> *	timing_setup		-	shared timing computation and load</span>
<span class="cm"> *	@ap: ATA port being set up</span>
<span class="cm"> *	@adev: drive being configured</span>
<span class="cm"> *	@offset: port offset</span>
<span class="cm"> *	@speed: target speed</span>
<span class="cm"> *	@clock: clock multiplier (number of times 33MHz for this part)</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform the actual timing set up for Nvidia or AMD PATA devices.</span>
<span class="cm"> *	The actual devices vary so they all call into this helper function</span>
<span class="cm"> *	providing the clock multipler and offset (because AMD and Nvidia put</span>
<span class="cm"> *	the ports at different locations).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">timing_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">amd_cyc2udma</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">peer</span> <span class="o">=</span> <span class="n">ata_dev_pair</span><span class="p">(</span><span class="n">adev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dn</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_timing</span> <span class="n">at</span><span class="p">,</span> <span class="n">apeer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">T</span><span class="p">,</span> <span class="n">UT</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">amd_clock</span> <span class="o">=</span> <span class="mi">33333</span><span class="p">;</span>	<span class="cm">/* KHz. */</span>
	<span class="n">u8</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">T</span> <span class="o">=</span> <span class="mi">1000000000</span> <span class="o">/</span> <span class="n">amd_clock</span><span class="p">;</span>
	<span class="n">UT</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clock</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">UT</span> <span class="o">=</span> <span class="n">T</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">at</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">UT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This may be over conservative */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">peer</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apeer</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">UT</span><span class="p">);</span>
			<span class="n">ata_timing_merge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apeer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">at</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">at</span><span class="p">,</span> <span class="n">ATA_TIMING_8BIT</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">peer</span><span class="p">,</span> <span class="n">peer</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apeer</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">UT</span><span class="p">);</span>
		<span class="n">ata_timing_merge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apeer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">at</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">at</span><span class="p">,</span> <span class="n">ATA_TIMING_8BIT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">XFER_UDMA_5</span> <span class="o">&amp;&amp;</span> <span class="n">amd_clock</span> <span class="o">&lt;=</span> <span class="mi">33333</span><span class="p">)</span> <span class="n">at</span><span class="p">.</span><span class="n">udma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">XFER_UDMA_6</span> <span class="o">&amp;&amp;</span> <span class="n">amd_clock</span> <span class="o">&lt;=</span> <span class="mi">33333</span><span class="p">)</span> <span class="n">at</span><span class="p">.</span><span class="n">udma</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Now do the setup work</span>
<span class="cm">	 */</span>

	<span class="cm">/* Configure the address set up timing */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span> <span class="o">-</span> <span class="n">dn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">|</span> <span class="p">((</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">setup</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mi">3</span> <span class="o">-</span> <span class="n">dn</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x0C</span> <span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="cm">/* Configure the 8bit I/O timing */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x0E</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">dn</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)),</span>
		<span class="p">((</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">act8b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">rec8b</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Drive timing */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x08</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">dn</span><span class="p">),</span>
		<span class="p">((</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">active</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">recover</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="p">(</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="n">amd_cyc2udma</span><span class="p">[</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)])</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="n">amd_cyc2udma</span><span class="p">[</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)])</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="n">at</span><span class="p">.</span><span class="n">udma</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0xc0</span> <span class="o">|</span> <span class="n">amd_cyc2udma</span><span class="p">[</span><span class="n">clamp_val</span><span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">udma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)])</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* UDMA timing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">at</span><span class="p">.</span><span class="n">udma</span><span class="p">)</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="n">dn</span><span class="p">),</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	amd_pre_reset		-	perform reset handling</span>
<span class="cm"> *	@link: ATA link</span>
<span class="cm"> *	@deadline: deadline jiffies for the operation</span>
<span class="cm"> *</span>
<span class="cm"> *	Reset sequence checking enable bits to see which ports are</span>
<span class="cm"> *	active.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_bits</span> <span class="n">amd_enable_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_test_config_bits</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amd_enable_bits</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ata_sff_prereset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	amd_cable_detect	-	report cable type</span>
<span class="cm"> *	@ap: port</span>
<span class="cm"> *</span>
<span class="cm"> *	AMD controller/BIOS setups record the cable type in word 0x42</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_cable_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">bitmask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ata66</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ata66</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata66</span> <span class="o">&amp;</span> <span class="n">bitmask</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">])</span>
		<span class="k">return</span> <span class="n">ATA_CBL_PATA80</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ATA_CBL_PATA40</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	amd_fifo_setup		-	set the PIO FIFO for ATA/ATAPI</span>
<span class="cm"> *	@ap: ATA interface</span>
<span class="cm"> *	@adev: ATA device</span>
<span class="cm"> *</span>
<span class="cm"> *	Set the PCI fifo for this device according to the devices present</span>
<span class="cm"> *	on the bus at this point in time. We need to turn the post write buffer</span>
<span class="cm"> *	off for ATAPI devices as we may need to issue a word sized write to the</span>
<span class="cm"> *	device as the final I/O</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd_fifo_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">fifobit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">};</span>
	<span class="n">u8</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">fifobit</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">r</span><span class="p">;</span>


	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_AMD_VIPER_7411</span><span class="p">)</span> <span class="cm">/* FIFO is broken */</span>
		<span class="n">fifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* On the later chips the read prefetch bits become no-op bits */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">fifobit</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">];</span>
	<span class="n">r</span> <span class="o">|=</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	amd33_set_piomode	-	set initial PIO mode data</span>
<span class="cm"> *	@ap: ATA interface</span>
<span class="cm"> *	@adev: ATA device</span>
<span class="cm"> *</span>
<span class="cm"> *	Program the AMD registers for PIO mode.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd33_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amd_fifo_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd66_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amd_fifo_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd100_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amd_fifo_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd133_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amd_fifo_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	amd33_set_dmamode	-	set initial DMA mode data</span>
<span class="cm"> *	@ap: ATA interface</span>
<span class="cm"> *	@adev: ATA device</span>
<span class="cm"> *</span>
<span class="cm"> *	Program the MWDMA/UDMA modes for the AMD and Nvidia</span>
<span class="cm"> *	chipset.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd33_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd66_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd100_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd133_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Both host-side and drive-side detection results are worthless on NV</span>
<span class="cm"> * PATAs.  Ignore them and just follow what BIOS configured.  Both the</span>
<span class="cm"> * current configuration in PCI config reg and ACPI GTM result are</span>
<span class="cm"> * cached during driver attach and are consulted to select transfer</span>
<span class="cm"> * mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">nv_mode_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">xfer_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">udma_mask_map</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">ATA_UDMA2</span><span class="p">,</span> <span class="n">ATA_UDMA1</span><span class="p">,</span> <span class="n">ATA_UDMA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="n">ATA_UDMA3</span><span class="p">,</span> <span class="n">ATA_UDMA4</span><span class="p">,</span> <span class="n">ATA_UDMA5</span><span class="p">,</span> <span class="n">ATA_UDMA6</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">acpi_str</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">saved_udma</span><span class="p">,</span> <span class="n">udma</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_acpi_gtm</span> <span class="o">*</span><span class="n">gtm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bios_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acpi_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>

	<span class="cm">/* find out what BIOS configured */</span>
	<span class="n">udma</span> <span class="o">=</span> <span class="n">saved_udma</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">udma</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">udma</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">udma</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="n">bios_limit</span> <span class="o">=</span> <span class="n">ata_pack_xfermask</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">udma_mask_map</span><span class="p">[</span><span class="n">udma</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">]);</span>

	<span class="cm">/* consult ACPI GTM too */</span>
	<span class="n">gtm</span> <span class="o">=</span> <span class="n">ata_acpi_init_gtm</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gtm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_limit</span> <span class="o">=</span> <span class="n">ata_acpi_gtm_xfermask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gtm</span><span class="p">);</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">acpi_str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">acpi_str</span><span class="p">),</span> <span class="s">&quot; (%u:%u:0x%x)&quot;</span><span class="p">,</span>
			 <span class="n">gtm</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dma</span><span class="p">,</span> <span class="n">gtm</span><span class="o">-&gt;</span><span class="n">drive</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dma</span><span class="p">,</span> <span class="n">gtm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* be optimistic, EH can take care of things if something goes wrong */</span>
	<span class="n">limit</span> <span class="o">=</span> <span class="n">bios_limit</span> <span class="o">|</span> <span class="n">acpi_limit</span><span class="p">;</span>

	<span class="cm">/* If PIO or DMA isn&#39;t configured at all, don&#39;t limit.  Let EH</span>
<span class="cm">	 * handle it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">limit</span> <span class="o">&amp;</span> <span class="n">ATA_MASK_PIO</span><span class="p">))</span>
		<span class="n">limit</span> <span class="o">|=</span> <span class="n">ATA_MASK_PIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">limit</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_MASK_MWDMA</span> <span class="o">|</span> <span class="n">ATA_MASK_UDMA</span><span class="p">)))</span>
		<span class="n">limit</span> <span class="o">|=</span> <span class="n">ATA_MASK_MWDMA</span> <span class="o">|</span> <span class="n">ATA_MASK_UDMA</span><span class="p">;</span>
	<span class="cm">/* PIO4, MWDMA2, UDMA2 should always be supported regardless of</span>
<span class="cm">	   cable detection result */</span>
	<span class="n">limit</span> <span class="o">|=</span> <span class="n">ata_pack_xfermask</span><span class="p">(</span><span class="n">ATA_PIO4</span><span class="p">,</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span> <span class="n">ATA_UDMA2</span><span class="p">);</span>

	<span class="n">ata_port_dbg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;nv_mode_filter: 0x%lx&amp;0x%lx-&gt;0x%lx, &quot;</span>
			<span class="s">&quot;BIOS=0x%lx (0x%x) ACPI=0x%lx%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">xfer_mask</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">xfer_mask</span> <span class="o">&amp;</span> <span class="n">limit</span><span class="p">,</span> <span class="n">bios_limit</span><span class="p">,</span>
			<span class="n">saved_udma</span><span class="p">,</span> <span class="n">acpi_limit</span><span class="p">,</span> <span class="n">acpi_str</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">xfer_mask</span> <span class="o">&amp;</span> <span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	nv_probe_init	-	cable detection</span>
<span class="cm"> *	@lin: ATA link</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform cable detection. The BIOS stores this in PCI config</span>
<span class="cm"> *	space for us.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_pre_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_bits</span> <span class="n">nv_enable_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_test_config_bits</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_enable_bits</span><span class="p">[</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ata_sff_prereset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	nv100_set_piomode	-	set initial PIO mode data</span>
<span class="cm"> *	@ap: ATA interface</span>
<span class="cm"> *	@adev: ATA device</span>
<span class="cm"> *</span>
<span class="cm"> *	Program the AMD registers for PIO mode.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv100_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv133_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	nv100_set_dmamode	-	set initial DMA mode data</span>
<span class="cm"> *	@ap: ATA interface</span>
<span class="cm"> *	@adev: ATA device</span>
<span class="cm"> *</span>
<span class="cm"> *	Program the MWDMA/UDMA modes for the AMD and Nvidia</span>
<span class="cm"> *	chipset.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv100_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv133_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">timing_setup</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">adev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_host_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">udma</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* restore PCI config register 0x60 */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">udma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">amd_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_BMDMA_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">amd_base_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_bmdma32_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prereset</span>	<span class="o">=</span> <span class="n">amd_pre_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">amd33_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">amd_base_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>	<span class="o">=</span> <span class="n">ata_cable_40wire</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>	<span class="o">=</span> <span class="n">amd33_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>	<span class="o">=</span> <span class="n">amd33_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">amd66_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">amd_base_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>	<span class="o">=</span> <span class="n">ata_cable_unknown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>	<span class="o">=</span> <span class="n">amd66_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>	<span class="o">=</span> <span class="n">amd66_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">amd100_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">amd_base_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>	<span class="o">=</span> <span class="n">ata_cable_unknown</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>	<span class="o">=</span> <span class="n">amd100_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>	<span class="o">=</span> <span class="n">amd100_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">amd133_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">amd_base_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>	<span class="o">=</span> <span class="n">amd_cable_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>	<span class="o">=</span> <span class="n">amd133_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>	<span class="o">=</span> <span class="n">amd133_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv_base_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_bmdma_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>	<span class="o">=</span> <span class="n">ata_cable_ignore</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mode_filter</span>	<span class="o">=</span> <span class="n">nv_mode_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prereset</span>	<span class="o">=</span> <span class="n">nv_pre_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">host_stop</span>	<span class="o">=</span> <span class="n">nv_host_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv100_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_base_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>	<span class="o">=</span> <span class="n">nv100_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>	<span class="o">=</span> <span class="n">nv100_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv133_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_base_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>	<span class="o">=</span> <span class="n">nv133_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>	<span class="o">=</span> <span class="n">nv133_set_dmamode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amd_clear_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="cm">/* Disable the FIFO, the FIFO logic will re-enable it as</span>
<span class="cm">	   appropriate */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="p">);</span>
	<span class="n">fifo</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">fifo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">info</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>	<span class="cm">/* 0: AMD 7401 - no swdma */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd33_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 1: Early AMD7409 - no swdma */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd66_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 2: AMD 7409 */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd66_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 3: AMD 7411 */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd100_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 4: AMD 7441 */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd100_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 5: AMD 8111 - no swdma */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd133_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 6: AMD 8111 UDMA 100 (Serenade) - no swdma */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd133_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 7: Nvidia Nforce */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nv100_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 8: Nvidia Nforce2 and later - no swdma */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nv133_port_ops</span>
		<span class="p">},</span>
		<span class="p">{</span>	<span class="cm">/* 9: AMD CS5536 (Geode companion) */</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_FLAG_SLAVE_POSS</span><span class="p">,</span>
			<span class="p">.</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
			<span class="p">.</span><span class="n">mwdma_mask</span> <span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">udma_mask</span> <span class="o">=</span> <span class="n">ATA_UDMA5</span><span class="p">,</span>
			<span class="p">.</span><span class="n">port_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd100_port_ops</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ata_print_version_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fifo</span><span class="p">);</span>

	<span class="cm">/* Check for AMD7409 without swdma errata and if found adjust type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="mh">0x7</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Serenade ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_AMD</span> <span class="o">&amp;&amp;</span>
			 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_AMD_SERENADE</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* UDMA 100 only */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Okay, type is determined now.  Apply type-specific workarounds.</span>
<span class="cm">	 */</span>
	<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ata_pci_bmdma_clear_simplex</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_AMD</span><span class="p">)</span>
		<span class="n">amd_clear_fifo</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="cm">/* Cable detection on Nvidia chips doesn&#39;t work too well,</span>
<span class="cm">	 * cache BIOS programmed UDMA mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">udma</span><span class="p">;</span>

		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udma</span><span class="p">);</span>
		<span class="n">hpriv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">udma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* And fire it up */</span>
	<span class="k">return</span> <span class="n">ata_pci_bmdma_init_one</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amd_sht</span><span class="p">,</span> <span class="n">hpriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">amd_reinit_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_device_do_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_AMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amd_clear_fifo</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_AMD_VIPER_7409</span> <span class="o">||</span>
		    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_AMD_COBRA_7401</span><span class="p">)</span>
			<span class="n">ata_pci_bmdma_clear_simplex</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">amd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_AMD_COBRA_7401</span><span class="p">),</span>		<span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_AMD_VIPER_7409</span><span class="p">),</span>		<span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_AMD_VIPER_7411</span><span class="p">),</span>		<span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_AMD_OPUS_7441</span><span class="p">),</span>		<span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_AMD_8111_IDE</span><span class="p">),</span>		<span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_IDE</span><span class="p">),</span>	<span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE2_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE2S_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE3_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE3S_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP65_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP67_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP73_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP77_IDE</span><span class="p">),</span>	<span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span>	<span class="n">PCI_DEVICE_ID_AMD_CS5536_IDE</span><span class="p">),</span>		<span class="mi">9</span> <span class="p">},</span>

	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">amd_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> 		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">amd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> 		<span class="o">=</span> <span class="n">amd_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ata_pci_remove_one</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ata_pci_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">amd_reinit_one</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">amd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Alan Cox&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;low-level driver for AMD and Nvidia PATA IDE&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">amd</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">amd_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">amd_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
