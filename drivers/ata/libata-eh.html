<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › libata-eh.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>libata-eh.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  libata-eh.c - libata error handling</span>
<span class="cm"> *</span>
<span class="cm"> *  Maintained by:  Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> *    		    Please ALWAYS copy linux-ide@vger.kernel.org</span>
<span class="cm"> *		    on emails.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2006 Tejun Heo &lt;htejun@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *  published by the Free Software Foundation; either version 2, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> *  General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139,</span>
<span class="cm"> *  USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  libata documentation is available via &#39;make {ps|pdf}docs&#39;,</span>
<span class="cm"> *  as Documentation/DocBook/libata.*</span>
<span class="cm"> *</span>
<span class="cm"> *  Hardware documentation available from http://www.t13.org/ and</span>
<span class="cm"> *  http://www.sata-io.org/</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_dbg.h&gt;</span>
<span class="cp">#include &quot;../scsi/scsi_transport_api.h&quot;</span>

<span class="cp">#include &lt;linux/libata.h&gt;</span>

<span class="cp">#include &quot;libata.h&quot;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* speed down verdicts */</span>
	<span class="n">ATA_EH_SPDN_NCQ_OFF</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATA_EH_SPDN_SPEED_DOWN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATA_EH_SPDN_FALLBACK_TO_PIO</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ATA_EH_SPDN_KEEP_ERRORS</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>

	<span class="cm">/* error flags */</span>
	<span class="n">ATA_EFLAG_IS_IO</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ATA_EFLAG_DUBIOUS_XFER</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ATA_EFLAG_OLD_ER</span>                <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">),</span>

	<span class="cm">/* error categories */</span>
	<span class="n">ATA_ECAT_NONE</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">ATA_ECAT_ATA_BUS</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">ATA_ECAT_TOUT_HSM</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">ATA_ECAT_UNK_DEV</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ATA_ECAT_DUBIOUS_NONE</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">ATA_ECAT_DUBIOUS_ATA_BUS</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">ATA_ECAT_DUBIOUS_TOUT_HSM</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">ATA_ECAT_DUBIOUS_UNK_DEV</span>	<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	<span class="n">ATA_ECAT_NR</span>			<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>

	<span class="n">ATA_EH_CMD_DFL_TIMEOUT</span>		<span class="o">=</span>  <span class="mi">5000</span><span class="p">,</span>

	<span class="cm">/* always put at least this amount of time between resets */</span>
	<span class="n">ATA_EH_RESET_COOL_DOWN</span>		<span class="o">=</span>  <span class="mi">5000</span><span class="p">,</span>

	<span class="cm">/* Waiting in -&gt;prereset can never be reliable.  It&#39;s</span>
<span class="cm">	 * sometimes nice to wait there but it can&#39;t be depended upon;</span>
<span class="cm">	 * otherwise, we wouldn&#39;t be resetting.  Just give it enough</span>
<span class="cm">	 * time for most drives to spin up.</span>
<span class="cm">	 */</span>
	<span class="n">ATA_EH_PRERESET_TIMEOUT</span>		<span class="o">=</span> <span class="mi">10000</span><span class="p">,</span>
	<span class="n">ATA_EH_FASTDRAIN_INTERVAL</span>	<span class="o">=</span>  <span class="mi">3000</span><span class="p">,</span>

	<span class="n">ATA_EH_UA_TRIES</span>			<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>

	<span class="cm">/* probe speed down parameters, see ata_eh_schedule_probe() */</span>
	<span class="n">ATA_EH_PROBE_TRIAL_INTERVAL</span>	<span class="o">=</span> <span class="mi">60000</span><span class="p">,</span>	<span class="cm">/* 1 min */</span>
	<span class="n">ATA_EH_PROBE_TRIALS</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The following table determines how we sequence resets.  Each entry</span>
<span class="cm"> * represents timeout for that try.  The first try can be soft or</span>
<span class="cm"> * hardreset.  All others are hardreset if available.  In most cases</span>
<span class="cm"> * the first reset w/ 10sec timeout should succeed.  Following entries</span>
<span class="cm"> * are mostly for error handling, hotplug and retarded devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ata_eh_reset_timeouts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">10000</span><span class="p">,</span>	<span class="cm">/* most drives spin up by 10sec */</span>
	<span class="mi">10000</span><span class="p">,</span>	<span class="cm">/* &gt; 99% working drives spin up before 20sec */</span>
	<span class="mi">35000</span><span class="p">,</span>	<span class="cm">/* give &gt; 30 secs of idleness for retarded devices */</span>
	 <span class="mi">5000</span><span class="p">,</span>	<span class="cm">/* and sweet one last chance */</span>
	<span class="n">ULONG_MAX</span><span class="p">,</span> <span class="cm">/* &gt; 1 min has elapsed, give up */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ata_eh_identify_timeouts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	 <span class="mi">5000</span><span class="p">,</span>	<span class="cm">/* covers &gt; 99% of successes and not too boring on failures */</span>
	<span class="mi">10000</span><span class="p">,</span>  <span class="cm">/* combined time till here is enough even for media access */</span>
	<span class="mi">30000</span><span class="p">,</span>	<span class="cm">/* for true idiots */</span>
	<span class="n">ULONG_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ata_eh_flush_timeouts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">15000</span><span class="p">,</span>	<span class="cm">/* be generous with flush */</span>
	<span class="mi">15000</span><span class="p">,</span>  <span class="cm">/* ditto */</span>
	<span class="mi">30000</span><span class="p">,</span>	<span class="cm">/* and even more generous */</span>
	<span class="n">ULONG_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ata_eh_other_timeouts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	 <span class="mi">5000</span><span class="p">,</span>	<span class="cm">/* same rationale as identify timeout */</span>
	<span class="mi">10000</span><span class="p">,</span>	<span class="cm">/* ditto */</span>
	<span class="cm">/* but no merciful 30sec for other commands, it just isn&#39;t worth it */</span>
	<span class="n">ULONG_MAX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ata_eh_cmd_timeout_ent</span> <span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span>		<span class="o">*</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span>	<span class="o">*</span><span class="n">timeouts</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The following table determines timeouts to use for EH internal</span>
<span class="cm"> * commands.  Each table entry is a command class and matches the</span>
<span class="cm"> * commands the entry applies to and the timeout table to use.</span>
<span class="cm"> *</span>
<span class="cm"> * On the retry after a command timed out, the next timeout value from</span>
<span class="cm"> * the table is used.  If the table doesn&#39;t contain further entries,</span>
<span class="cm"> * the last value is used.</span>
<span class="cm"> *</span>
<span class="cm"> * ehc-&gt;cmd_timeout_idx keeps track of which timeout to use per</span>
<span class="cm"> * command class, so if SET_FEATURES times out on the first try, the</span>
<span class="cm"> * next try will use the second timeout value only for that class.</span>
<span class="cm"> */</span>
<span class="cp">#define CMDS(cmds...)	(const u8 []){ cmds, 0 }</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_eh_cmd_timeout_ent</span>
<span class="n">ata_eh_cmd_timeout_table</span><span class="p">[</span><span class="n">ATA_EH_CMD_TIMEOUT_TABLE_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">CMDS</span><span class="p">(</span><span class="n">ATA_CMD_ID_ATA</span><span class="p">,</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">ata_eh_identify_timeouts</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">CMDS</span><span class="p">(</span><span class="n">ATA_CMD_READ_NATIVE_MAX</span><span class="p">,</span> <span class="n">ATA_CMD_READ_NATIVE_MAX_EXT</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">ata_eh_other_timeouts</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">CMDS</span><span class="p">(</span><span class="n">ATA_CMD_SET_MAX</span><span class="p">,</span> <span class="n">ATA_CMD_SET_MAX_EXT</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">ata_eh_other_timeouts</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">CMDS</span><span class="p">(</span><span class="n">ATA_CMD_SET_FEATURES</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">ata_eh_other_timeouts</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">CMDS</span><span class="p">(</span><span class="n">ATA_CMD_INIT_DEV_PARAMS</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">ata_eh_other_timeouts</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">CMDS</span><span class="p">(</span><span class="n">ATA_CMD_FLUSH</span><span class="p">,</span> <span class="n">ATA_CMD_FLUSH_EXT</span><span class="p">),</span>
	  <span class="p">.</span><span class="n">timeouts</span> <span class="o">=</span> <span class="n">ata_eh_flush_timeouts</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#undef CMDS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__ata_port_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ata_eh_handle_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ata_eh_handle_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_handle_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span> <span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_handle_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span> <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ata_ehi_pushv_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
				 <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">desc_len</span> <span class="o">+=</span> <span class="n">vscnprintf</span><span class="p">(</span><span class="n">ehi</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">+</span> <span class="n">ehi</span><span class="o">-&gt;</span><span class="n">desc_len</span><span class="p">,</span>
				     <span class="n">ATA_EH_DESC_LEN</span> <span class="o">-</span> <span class="n">ehi</span><span class="o">-&gt;</span><span class="n">desc_len</span><span class="p">,</span>
				     <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	__ata_ehi_push_desc - push error description without adding separator</span>
<span class="cm"> *	@ehi: target EHI</span>
<span class="cm"> *	@fmt: printf format string</span>
<span class="cm"> *</span>
<span class="cm"> *	Format string according to @fmt and append it to @ehi-&gt;desc.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__ata_ehi_push_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">__ata_ehi_pushv_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_ehi_push_desc - push error description with separator</span>
<span class="cm"> *	@ehi: target EHI</span>
<span class="cm"> *	@fmt: printf format string</span>
<span class="cm"> *</span>
<span class="cm"> *	Format string according to @fmt and append it to @ehi-&gt;desc.</span>
<span class="cm"> *	If @ehi-&gt;desc is not empty, &quot;, &quot; is added in-between.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_ehi_push_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehi</span><span class="o">-&gt;</span><span class="n">desc_len</span><span class="p">)</span>
		<span class="n">__ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="p">);</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">__ata_ehi_pushv_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_ehi_clear_desc - clean error description</span>
<span class="cm"> *	@ehi: target EHI</span>
<span class="cm"> *</span>
<span class="cm"> *	Clear @ehi-&gt;desc.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_ehi_clear_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">desc_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_port_desc - append port description</span>
<span class="cm"> *	@ap: target ATA port</span>
<span class="cm"> *	@fmt: printf format string</span>
<span class="cm"> *</span>
<span class="cm"> *	Format string according to @fmt and append it to port</span>
<span class="cm"> *	description.  If port description is not empty, &quot; &quot; is added</span>
<span class="cm"> *	in-between.  This function is to be used while initializing</span>
<span class="cm"> *	ata_host.  The description is printed on host registration.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_port_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_INITIALIZING</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">.</span><span class="n">desc_len</span><span class="p">)</span>
		<span class="n">__ata_ehi_push_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">);</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">__ata_ehi_pushv_desc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_port_pbar_desc - append PCI BAR description</span>
<span class="cm"> *	@ap: target ATA port</span>
<span class="cm"> *	@bar: target PCI BAR</span>
<span class="cm"> *	@offset: offset into PCI BAR</span>
<span class="cm"> *	@name: name of the area</span>
<span class="cm"> *</span>
<span class="cm"> *	If @offset is negative, this function formats a string which</span>
<span class="cm"> *	contains the name, address, size and type of the BAR and</span>
<span class="cm"> *	appends it to the port description.  If @offset is zero or</span>
<span class="cm"> *	positive, only name and offsetted address is appended.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_port_pbar_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bar</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">offset</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;m&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;i&quot;</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ata_port_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;%s %s%llu@0x%llx&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ata_port_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;%s 0x%llx&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				<span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_lookup_timeout_table</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATA_EH_CMD_TIMEOUT_TABLE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">cur</span> <span class="o">=</span> <span class="n">ata_eh_cmd_timeout_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">commands</span><span class="p">;</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span> <span class="n">cur</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cur</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_internal_cmd_timeout - determine timeout for an internal command</span>
<span class="cm"> *	@dev: target device</span>
<span class="cm"> *	@cmd: internal command to be issued</span>
<span class="cm"> *</span>
<span class="cm"> *	Determine timeout for internal command @cmd for @dev.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Determined timeout.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">ata_internal_cmd_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ent</span> <span class="o">=</span> <span class="n">ata_lookup_timeout_table</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ATA_EH_CMD_DFL_TIMEOUT</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">cmd_timeout_idx</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">][</span><span class="n">ent</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">ata_eh_cmd_timeout_table</span><span class="p">[</span><span class="n">ent</span><span class="p">].</span><span class="n">timeouts</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_internal_cmd_timed_out - notification for internal command timeout</span>
<span class="cm"> *	@dev: target device</span>
<span class="cm"> *	@cmd: internal command which timed out</span>
<span class="cm"> *</span>
<span class="cm"> *	Notify EH that internal command @cmd for @dev timed out.  This</span>
<span class="cm"> *	function should be called only for commands whose timeouts are</span>
<span class="cm"> *	determined using ata_internal_cmd_timeout().</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_internal_cmd_timed_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ent</span> <span class="o">=</span> <span class="n">ata_lookup_timeout_table</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">cmd_timeout_idx</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">][</span><span class="n">ent</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_eh_cmd_timeout_table</span><span class="p">[</span><span class="n">ent</span><span class="p">].</span><span class="n">timeouts</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ULONG_MAX</span><span class="p">)</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">cmd_timeout_idx</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">][</span><span class="n">ent</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_ering_record</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_ering</span> <span class="o">*</span><span class="n">ering</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eflags</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">err_mask</span><span class="p">);</span>

	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ering</span><span class="o">-&gt;</span><span class="n">cursor</span> <span class="o">%=</span> <span class="n">ATA_ERING_SIZE</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">];</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">=</span> <span class="n">eflags</span><span class="p">;</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">=</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">get_jiffies_64</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="nf">ata_ering_top</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_ering</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="n">ent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ent</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ata_ering_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_ering</span> <span class="o">*</span><span class="n">ering</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">map_fn</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
		  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ering</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">map_fn</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ATA_ERING_SIZE</span><span class="p">)</span> <span class="o">%</span> <span class="n">ATA_ERING_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">ering</span><span class="o">-&gt;</span><span class="n">cursor</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ata_ering_clear_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">void_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ent</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">|=</span> <span class="n">ATA_EFLAG_OLD_ER</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_ering_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_ering</span> <span class="o">*</span><span class="n">ering</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ata_ering_map</span><span class="p">(</span><span class="n">ering</span><span class="p">,</span> <span class="n">ata_ering_clear_cb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ata_eh_dev_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_clear_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">tdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">action</span><span class="p">;</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">dev_action</span><span class="p">[</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">action</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* doesn&#39;t make sense for port-wide EH actions */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_PERDEV_MASK</span><span class="p">));</span>

		<span class="cm">/* break ehi-&gt;action into ehi-&gt;dev_action */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">action</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">tdev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
				<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">dev_action</span><span class="p">[</span><span class="n">tdev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">|=</span>
					<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">action</span><span class="p">;</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">action</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* turn off the specified per-dev action */</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">dev_action</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">action</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_acquire - acquire EH ownership</span>
<span class="cm"> *	@ap: ATA port to acquire EH ownership for</span>
<span class="cm"> *</span>
<span class="cm"> *	Acquire EH ownership for @ap.  This is the basic exclusion</span>
<span class="cm"> *	mechanism for ports sharing a host.  Only one port hanging off</span>
<span class="cm"> *	the same host can claim the ownership of EH.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_acquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eh_mutex</span><span class="p">);</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eh_owner</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eh_owner</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_release - release EH ownership</span>
<span class="cm"> *	@ap: ATA port to release EH ownership for</span>
<span class="cm"> *</span>
<span class="cm"> *	Release EH ownership for @ap if the caller.  The caller must</span>
<span class="cm"> *	have acquired EH ownership using ata_eh_acquire() previously.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eh_owner</span> <span class="o">!=</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eh_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eh_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_scsi_timed_out - SCSI layer time out callback</span>
<span class="cm"> *	@cmd: timed out SCSI command</span>
<span class="cm"> *</span>
<span class="cm"> *	Handles SCSI layer timeout.  We race with normal completion of</span>
<span class="cm"> *	the qc for @cmd.  If the qc is already gone, we lose and let</span>
<span class="cm"> *	the scsi command finish (EH_HANDLED).  Otherwise, the qc has</span>
<span class="cm"> *	timed out and EH should be invoked.  Prevent ata_qc_complete()</span>
<span class="cm"> *	from finishing it by setting EH_SCHEDULED and return</span>
<span class="cm"> *	EH_NOT_HANDLED.</span>
<span class="cm"> *</span>
<span class="cm"> *	TODO: kill this function once old EH is gone.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Called from timer context</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	EH_HANDLED or EH_NOT_HANDLED</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="nf">ata_scsi_timed_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">blk_eh_timer_return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BLK_EH_NOT_HANDLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">BLK_EH_HANDLED</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span> <span class="o">!=</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_EH_SCHEDULED</span><span class="p">;</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">BLK_EH_NOT_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Restore SControl IPM and SPD for the next driver and</span>
<span class="cm">	 * disable attached devices.</span>
<span class="cm">	 */</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">PMP_FIRST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sata_scr_write</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_CONTROL</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">saved_scontrol</span> <span class="o">&amp;</span> <span class="mh">0xff0</span><span class="p">);</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
			<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* freeze and set UNLOADED */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>			<span class="cm">/* won&#39;t be thawed */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_EH_PENDING</span><span class="p">;</span>	<span class="cm">/* clear pending from freeze */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_UNLOADED</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_scsi_error - SCSI layer error handler callback</span>
<span class="cm"> *	@host: SCSI host on which error occurred</span>
<span class="cm"> *</span>
<span class="cm"> *	Handles SCSI-layer-thrown error events.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Inherited from SCSI layer (none, can sleep)</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Zero.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_scsi_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">eh_work_q</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">eh_cmd_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eh_work_q</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ata_scsi_cmd_error_handler</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eh_work_q</span><span class="p">);</span>

	<span class="cm">/* If we timed raced normal completion and there is nothing to</span>
<span class="cm">	   recover nr_timedout == 0 why exactly are we doing error recovery ? */</span>
	<span class="n">ata_scsi_port_error_handler</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* finish or retry handled scmd&#39;s and clean up */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">host_failed</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eh_work_q</span><span class="p">));</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ata_scsi_cmd_error_handler - error callback for a list of commands</span>
<span class="cm"> * @host:	scsi host containing the port</span>
<span class="cm"> * @ap:		ATA port within the host</span>
<span class="cm"> * @eh_work_q:	list of commands to process</span>
<span class="cm"> *</span>
<span class="cm"> * process the given list of commands and return those finished to the</span>
<span class="cm"> * ap-&gt;eh_done_q.  This function is the first part of the libata error</span>
<span class="cm"> * handler which processes a given list of failed commands.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_scsi_cmd_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">eh_work_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* make sure sff pio task is not running */</span>
	<span class="n">ata_sff_flush_pio_task</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* synchronize with host lock and sort out timeouts */</span>

	<span class="cm">/* For new EH, all qcs are finished in one of three ways -</span>
<span class="cm">	 * normal completion, error completion, and SCSI timeout.</span>
<span class="cm">	 * Both completions can race against SCSI timeout.  When normal</span>
<span class="cm">	 * completion wins, the qc never reaches EH.  When error</span>
<span class="cm">	 * completion wins, the qc has ATA_QCFLAG_FAILED set.</span>
<span class="cm">	 *</span>
<span class="cm">	 * When SCSI timeout wins, things are a bit more complex.</span>
<span class="cm">	 * Normal or error completion can occur after the timeout but</span>
<span class="cm">	 * before this point.  In such cases, both types of</span>
<span class="cm">	 * completions are honored.  A scmd is determined to have</span>
<span class="cm">	 * timed out iff its associated qc is active and not failed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nr_timedout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* This must occur under the ap-&gt;lock as we don&#39;t want</span>
<span class="cm">		   a polled recovery to race the real interrupt handler</span>

<span class="cm">		   The lost_interrupt handler checks for any completed but</span>
<span class="cm">		   non-notified command and completes much like an IRQ handler.</span>

<span class="cm">		   We then fall into the error recovery code which will treat</span>
<span class="cm">		   this as if normal completion won the race */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lost_interrupt</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lost_interrupt</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">eh_work_q</span><span class="p">,</span> <span class="n">eh_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_ACTIVE</span> <span class="o">&amp;&amp;</span>
				    <span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span> <span class="o">==</span> <span class="n">scmd</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* the scmd has an associated qc */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* which hasn&#39;t failed yet, timeout */</span>
					<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">;</span>
					<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">;</span>
					<span class="n">nr_timedout</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Normal completion occurred after</span>
<span class="cm">				 * SCSI timeout but before this point.</span>
<span class="cm">				 * Successfully complete it.</span>
<span class="cm">				 */</span>
				<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">allowed</span><span class="p">;</span>
				<span class="n">scsi_eh_finish_cmd</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_done_q</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If we have timed out qcs.  They belong to EH from</span>
<span class="cm">		 * this point but the state of the controller is</span>
<span class="cm">		 * unknown.  Freeze the port to make sure the IRQ</span>
<span class="cm">		 * handler doesn&#39;t diddle with those qcs.  This must</span>
<span class="cm">		 * be done atomically w.r.t. setting QCFLAG_FAILED.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_timedout</span><span class="p">)</span>
			<span class="n">__ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* initialize eh_tries */</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_tries</span> <span class="o">=</span> <span class="n">ATA_EH_MAX_TRIES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_wait</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ata_scsi_cmd_error_handler</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ata_scsi_port_error_handler - recover the port after the commands</span>
<span class="cm"> * @host:	SCSI host containing the port</span>
<span class="cm"> * @ap:		the ATA port</span>
<span class="cm"> *</span>
<span class="cm"> * Handle the recovery of the port @ap after all the commands</span>
<span class="cm"> * have been recovered.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_scsi_port_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* invoke error handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>

		<span class="cm">/* acquire EH ownership */</span>
		<span class="n">ata_eh_acquire</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
 <span class="nl">repeat:</span>
		<span class="cm">/* kill fast drain timer */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_timer</span><span class="p">);</span>

		<span class="cm">/* process port resume request */</span>
		<span class="n">ata_eh_handle_port_resume</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="cm">/* fetch &amp; clear EH info */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">HOST_FIRST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">));</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">));</span>

			<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">devno</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">;</span>

				<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_xfer_mode</span><span class="p">[</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">xfer_mode</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ata_ncq_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
					<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_ncq_enabled</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devno</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_EH_IN_PROGRESS</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_EH_PENDING</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">excl_link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* don&#39;t maintain exclusion over EH */</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* invoke EH, skip if unloading or suspended */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_PFLAG_UNLOADING</span> <span class="o">|</span> <span class="n">ATA_PFLAG_SUSPENDED</span><span class="p">)))</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* if unloading, commence suicide */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_UNLOADING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_UNLOADED</span><span class="p">))</span>
				<span class="n">ata_eh_unload</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="n">ata_eh_finish</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* process port suspend request */</span>
		<span class="n">ata_eh_handle_port_suspend</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="cm">/* Exception might have happened after -&gt;error_handler</span>
<span class="cm">		 * recovered the port but before this point.  Repeat</span>
<span class="cm">		 * EH in such case.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_EH_PENDING</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_tries</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
				     <span class="s">&quot;EH pending after %d tries, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">ATA_EH_MAX_TRIES</span><span class="p">);</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_EH_PENDING</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* this run is complete, make sure EH info is clear */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">HOST_FIRST</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">));</span>

		<span class="cm">/* Clear host_eh_scheduled while holding ap-&gt;lock such</span>
<span class="cm">		 * that if exception occurs after this point but</span>
<span class="cm">		 * before EH completion, SCSI midlayer will</span>
<span class="cm">		 * re-initiate EH.</span>
<span class="cm">		 */</span>
		<span class="n">host</span><span class="o">-&gt;</span><span class="n">host_eh_scheduled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ata_eh_release</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">eng_timeout</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_eh_flush_done_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_done_q</span><span class="p">);</span>

	<span class="cm">/* clean up */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_LOADING</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_LOADING</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_SCSI_HOTPLUG</span><span class="p">)</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">hotplug_task</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_RECOVERED</span><span class="p">)</span>
		<span class="n">ata_port_info</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;EH complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ATA_PFLAG_SCSI_HOTPLUG</span> <span class="o">|</span> <span class="n">ATA_PFLAG_RECOVERED</span><span class="p">);</span>

	<span class="cm">/* tell wait_eh that we&#39;re done */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_EH_IN_PROGRESS</span><span class="p">;</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_wait_q</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ata_scsi_port_error_handler</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_port_wait_eh - Wait for the currently pending EH to complete</span>
<span class="cm"> *	@ap: Port to wait EH for</span>
<span class="cm"> *</span>
<span class="cm"> *	Wait until the currently pending EH is complete.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_port_wait_eh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

 <span class="nl">retry:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_PFLAG_EH_PENDING</span> <span class="o">|</span> <span class="n">ATA_PFLAG_EH_IN_PROGRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_wait_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* make sure SCSI EH is complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scsi_host_in_recovery</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_msleep</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ata_port_wait_eh</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_nr_in_flight</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* count only non-internal commands */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>
			<span class="n">nr</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ata_eh_fastdrain_timerfn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">ata_eh_nr_in_flight</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* are we done? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>

		<span class="cm">/* No progress during the last interval, tag all</span>
<span class="cm">		 * in-flight qcs as timed out and freeze the port.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="p">)</span>
				<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* some qcs have finished, give it another chance */</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
			<span class="n">ata_deadline</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ATA_EH_FASTDRAIN_INTERVAL</span><span class="p">);</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_timer</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_set_pending - set ATA_PFLAG_EH_PENDING and activate fast drain</span>
<span class="cm"> *	@ap: target ATA port</span>
<span class="cm"> *	@fastdrain: activate fast drain</span>
<span class="cm"> *</span>
<span class="cm"> *	Set ATA_PFLAG_EH_PENDING and activate fast drain if @fastdrain</span>
<span class="cm"> *	is non-zero and EH wasn&#39;t pending before.  Fast drain ensures</span>
<span class="cm"> *	that EH kicks in in timely manner.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_set_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fastdrain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* already scheduled? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_EH_PENDING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_EH_PENDING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastdrain</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* do we have in-flight qcs? */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">ata_eh_nr_in_flight</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* activate fast drain */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
		<span class="n">ata_deadline</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ATA_EH_FASTDRAIN_INTERVAL</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">fastdrain_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_qc_schedule_eh - schedule qc for error handling</span>
<span class="cm"> *	@qc: command to schedule error handling for</span>
<span class="cm"> *</span>
<span class="cm"> *	Schedule error handling for @qc.  EH will kick in as soon as</span>
<span class="cm"> *	other commands are drained.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_qc_schedule_eh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">request_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">);</span>

	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">;</span>
	<span class="n">ata_eh_set_pending</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* The following will fail if timeout has already expired.</span>
<span class="cm">	 * ata_scsi_error() takes care of such scmds on EH entry.</span>
<span class="cm">	 * Note that ATA_QCFLAG_FAILED is unconditionally set after</span>
<span class="cm">	 * this function completes.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">blk_abort_request</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_port_schedule_eh - schedule error handling without a qc</span>
<span class="cm"> *	@ap: ATA port to schedule EH for</span>
<span class="cm"> *</span>
<span class="cm"> *	Schedule error handling for @ap.  EH will kick in as soon as</span>
<span class="cm"> *	all commands are drained.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_port_schedule_eh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_INITIALIZING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ata_eh_set_pending</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">scsi_schedule_eh</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">scsi_host</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;port EH scheduled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_do_link_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">nr_aborted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">);</span>

	<span class="cm">/* we&#39;re gonna abort all commands, no need for fast drain */</span>
	<span class="n">ata_eh_set_pending</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span> <span class="o">||</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="n">link</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">;</span>
			<span class="n">ata_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
			<span class="n">nr_aborted</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_aborted</span><span class="p">)</span>
		<span class="n">ata_port_schedule_eh</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nr_aborted</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_link_abort - abort all qc&#39;s on the link</span>
<span class="cm"> *	@link: ATA link to abort qc&#39;s for</span>
<span class="cm"> *</span>
<span class="cm"> *	Abort all active qc&#39;s active on @link and schedule EH.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Number of aborted qc&#39;s.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ata_link_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_do_link_abort</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_port_abort - abort all qc&#39;s on the port</span>
<span class="cm"> *	@ap: ATA port to abort qc&#39;s for</span>
<span class="cm"> *</span>
<span class="cm"> *	Abort all active qc&#39;s of @ap and schedule EH.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host_set lock)</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Number of aborted qc&#39;s.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ata_port_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_do_link_abort</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	__ata_port_freeze - freeze port</span>
<span class="cm"> *	@ap: ATA port to freeze</span>
<span class="cm"> *</span>
<span class="cm"> *	This function is called when HSM violation or some other</span>
<span class="cm"> *	condition disrupts normal operation of the port.  Frozen port</span>
<span class="cm"> *	is not allowed to perform any operation until the port is</span>
<span class="cm"> *	thawed, which usually follows a successful reset.</span>
<span class="cm"> *</span>
<span class="cm"> *	ap-&gt;ops-&gt;freeze() callback can be used for freezing the port</span>
<span class="cm"> *	hardware-wise (e.g. mask interrupt and stop DMA engine).  If a</span>
<span class="cm"> *	port cannot be frozen hardware-wise, the interrupt handler</span>
<span class="cm"> *	must ack and clear interrupts unconditionally while the port</span>
<span class="cm"> *	is frozen.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ata_port_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">freeze</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ata%u port frozen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">print_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_port_freeze - abort &amp; freeze port</span>
<span class="cm"> *	@ap: ATA port to freeze</span>
<span class="cm"> *</span>
<span class="cm"> *	Abort and freeze @ap.  The freeze operation must be called</span>
<span class="cm"> *	first, because some hardware requires special operations</span>
<span class="cm"> *	before the taskfile registers are accessible.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Number of aborted commands.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ata_port_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr_aborted</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">);</span>

	<span class="n">__ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">nr_aborted</span> <span class="o">=</span> <span class="n">ata_port_abort</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nr_aborted</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	sata_async_notification - SATA async notification handler</span>
<span class="cm"> *	@ap: ATA port where async notification is received</span>
<span class="cm"> *</span>
<span class="cm"> *	Handler to be called when async notification via SDB FIS is</span>
<span class="cm"> *	received.  This function schedules EH if necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	1 if EH is scheduled, 0 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sata_async_notification</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sntf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_AN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_scr_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_NOTIFICATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sntf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sata_scr_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_NOTIFICATION</span><span class="p">,</span> <span class="n">sntf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">||</span> <span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PMP is not attached or SNTF is not available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* PMP is not attached.  Check whether ATAPI</span>
<span class="cm">			 * AN is configured.  If so, notify media</span>
<span class="cm">			 * change.</span>
<span class="cm">			 */</span>
			<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_AN</span><span class="p">))</span>
				<span class="n">ata_scsi_media_change_notify</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* PMP is attached but SNTF is not available.</span>
<span class="cm">			 * ATAPI async media change notification is</span>
<span class="cm">			 * not used.  The PMP must be reporting PHY</span>
<span class="cm">			 * status change, schedule EH.</span>
<span class="cm">			 */</span>
			<span class="n">ata_port_schedule_eh</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* PMP is attached and SNTF is available */</span>
		<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>

		<span class="cm">/* check and notify ATAPI AN */</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sntf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_AN</span><span class="p">))</span>
				<span class="n">ata_scsi_media_change_notify</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* If PMP is reporting that PHY status of some</span>
<span class="cm">		 * downstream ports has changed, schedule EH.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sntf</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SATA_PMP_CTRL_PORT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ata_port_schedule_eh</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_freeze_port - EH helper to freeze port</span>
<span class="cm"> *	@ap: ATA port to freeze</span>
<span class="cm"> *</span>
<span class="cm"> *	Freeze @ap.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_freeze_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_port_thaw_port - EH helper to thaw port</span>
<span class="cm"> *	@ap: ATA port to thaw</span>
<span class="cm"> *</span>
<span class="cm"> *	Thaw frozen port @ap.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_thaw_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">error_handler</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_FROZEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">thaw</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">thaw</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ata%u port thawed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">print_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_scsidone</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nada */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ata_eh_qc_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsidone</span> <span class="o">=</span> <span class="n">ata_eh_scsidone</span><span class="p">;</span>
	<span class="n">__ata_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ata_tag_valid</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">scsi_eh_finish_cmd</span><span class="p">(</span><span class="n">scmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_done_q</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_qc_complete - Complete an active ATA command from EH</span>
<span class="cm"> *	@qc: Command to complete</span>
<span class="cm"> *</span>
<span class="cm"> *	Indicate to the mid and upper layers that an ATA command has</span>
<span class="cm"> *	completed.  To be used from EH.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_qc_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="p">;</span>
	<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">=</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">allowed</span><span class="p">;</span>
	<span class="n">__ata_eh_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_qc_retry - Tell midlayer to retry an ATA command after EH</span>
<span class="cm"> *	@qc: Command to retry</span>
<span class="cm"> *</span>
<span class="cm"> *	Indicate to the mid and upper layers that an ATA command</span>
<span class="cm"> *	should be retried.  To be used from EH.</span>
<span class="cm"> *</span>
<span class="cm"> *	SCSI midlayer limits the number of retries to scmd-&gt;allowed.</span>
<span class="cm"> *	scmd-&gt;retries is decremented for commands which get retried</span>
<span class="cm"> *	due to unrelated failures (qc-&gt;err_mask is zero).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_qc_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">scmd</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;&amp;</span> <span class="n">scmd</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">)</span>
		<span class="n">scmd</span><span class="o">-&gt;</span><span class="n">retries</span><span class="o">--</span><span class="p">;</span>
	<span class="n">__ata_eh_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_dev_disable - disable ATA device</span>
<span class="cm"> *	@dev: ATA device to disable</span>
<span class="cm"> *</span>
<span class="cm"> *	Disable @dev.</span>
<span class="cm"> *</span>
<span class="cm"> *	Locking:</span>
<span class="cm"> *	EH context.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_dev_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_msg_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">))</span>
		<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ata_acpi_on_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ata_down_xfermask_limit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ATA_DNXFER_FORCE_PIO0</span> <span class="o">|</span> <span class="n">ATA_DNXFER_QUIET</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* From now till the next successful probe, ering is used to</span>
<span class="cm">	 * track probe failures.  Clear accumulated device error info.</span>
<span class="cm">	 */</span>
	<span class="n">ata_ering_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_detach_dev - detach ATA device</span>
<span class="cm"> *	@dev: ATA device to detach</span>
<span class="cm"> *</span>
<span class="cm"> *	Detach @dev.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_detach_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_DFLAG_DETACH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_scsi_offline_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_DFLAG_DETACHED</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_SCSI_HOTPLUG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear per-dev EH info */</span>
	<span class="n">ata_eh_clear_action</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">,</span> <span class="n">ATA_EH_PERDEV_MASK</span><span class="p">);</span>
	<span class="n">ata_eh_clear_action</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">.</span><span class="n">i</span><span class="p">,</span> <span class="n">ATA_EH_PERDEV_MASK</span><span class="p">);</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_xfer_mode</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_ncq_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_about_to_do - about to perform eh_action</span>
<span class="cm"> *	@link: target ATA link</span>
<span class="cm"> *	@dev: target ATA dev for per-dev action (can be NULL)</span>
<span class="cm"> *	@action: action about to be performed</span>
<span class="cm"> *</span>
<span class="cm"> *	Called just before performing EH actions to clear related bits</span>
<span class="cm"> *	in @link-&gt;eh_info such that eh actions are not unnecessarily</span>
<span class="cm"> *	repeated.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_about_to_do</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ata_eh_clear_action</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ehi</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>

	<span class="cm">/* About to take EH action, set RECOVERED.  Ignore actions on</span>
<span class="cm">	 * slave links as master will do them again.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_QUIET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">link</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_RECOVERED</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_done - EH action complete</span>
<span class="cm">*	@ap: target ATA port</span>
<span class="cm"> *	@dev: target ATA dev for per-dev action (can be NULL)</span>
<span class="cm"> *	@action: action just completed</span>
<span class="cm"> *</span>
<span class="cm"> *	Called right after performing EH actions to clear related bits</span>
<span class="cm"> *	in @link-&gt;eh_context.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

	<span class="n">ata_eh_clear_action</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_err_string - convert err_mask to descriptive string</span>
<span class="cm"> *	@err_mask: error mask to convert to string</span>
<span class="cm"> *</span>
<span class="cm"> *	Convert @err_mask to descriptive string.  Errors are</span>
<span class="cm"> *	prioritized according to severity and only the most severe</span>
<span class="cm"> *	error is reported.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Descriptive string for @err_mask</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ata_err_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_HOST_BUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;host bus error&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_ATA_BUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;ATA bus error&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;timeout&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_HSM</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;HSM violation&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_SYSTEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;internal error&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_MEDIA</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;media error&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;invalid argument&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="s">&quot;device error&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;unknown error&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_read_log_page - read a specific log page</span>
<span class="cm"> *	@dev: target device</span>
<span class="cm"> *	@page: page to read</span>
<span class="cm"> *	@buf: buffer to store read page</span>
<span class="cm"> *	@sectors: number of sectors to read</span>
<span class="cm"> *</span>
<span class="cm"> *	Read log page using READ_LOG_EXT command.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, AC_ERR_* mask otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ata_read_log_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="n">page</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sectors</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;read log page - page %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_READ_LOG_EXT</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">lbal</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">sectors</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">hob_nsect</span> <span class="o">=</span> <span class="n">sectors</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_TFLAG_ISADDR</span> <span class="o">|</span> <span class="n">ATA_TFLAG_LBA48</span> <span class="o">|</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ATA_PROT_PIO</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_exec_internal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
				     <span class="n">buf</span><span class="p">,</span> <span class="n">sectors</span> <span class="o">*</span> <span class="n">ATA_SECT_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, err_mask=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_read_log_10h - Read log page 10h for NCQ error details</span>
<span class="cm"> *	@dev: Device to read log page 10h from</span>
<span class="cm"> *	@tag: Resulting tag of the failed command</span>
<span class="cm"> *	@tf: Resulting taskfile registers of the failed command</span>
<span class="cm"> *</span>
<span class="cm"> *	Read log page 10h to obtain NCQ error details and clear error</span>
<span class="cm"> *	condition.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_read_log_10h</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sector_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">csum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_read_log_page</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ATA_LOG_SATA_NCQ</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">csum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATA_SECT_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">csum</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csum</span><span class="p">)</span>
		<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid checksum 0x%x on log page 10h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">csum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tag</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	atapi_eh_tur - perform ATAPI TEST_UNIT_READY</span>
<span class="cm"> *	@dev: target ATAPI device</span>
<span class="cm"> *	@r_sense_key: out parameter for sense_key</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform ATAPI TEST_UNIT_READY.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, AC_ERR_* mask on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">atapi_eh_tur</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">r_sense_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cdb</span><span class="p">[</span><span class="n">ATAPI_CDB_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">TEST_UNIT_READY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>

	<span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_TFLAG_ISADDR</span> <span class="o">|</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_PACKET</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ATAPI_PROT_NODATA</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_exec_internal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">==</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span>
		<span class="o">*</span><span class="n">r_sense_key</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	atapi_eh_request_sense - perform ATAPI REQUEST_SENSE</span>
<span class="cm"> *	@dev: device to perform REQUEST_SENSE to</span>
<span class="cm"> *	@sense_buf: result sense data buffer (SCSI_SENSE_BUFFERSIZE bytes long)</span>
<span class="cm"> *	@dfl_sense_key: default sense key to use</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform ATAPI REQUEST_SENSE after the device reported CHECK</span>
<span class="cm"> *	SENSE.  This function is EH helper.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, AC_ERR_* mask on failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">atapi_eh_request_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="o">*</span><span class="n">sense_buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dfl_sense_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cdb</span><span class="p">[</span><span class="n">ATAPI_CDB_LEN</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">REQUEST_SENSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ATAPI request sense</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* FIXME: is this needed? */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sense_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">);</span>

	<span class="cm">/* initialize sense_buf with the error register,</span>
<span class="cm">	 * for the case where they are -not- overwritten</span>
<span class="cm">	 */</span>
	<span class="n">sense_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
	<span class="n">sense_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfl_sense_key</span><span class="p">;</span>

	<span class="cm">/* some devices time out if garbage left in tf */</span>
	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>

	<span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_TFLAG_ISADDR</span> <span class="o">|</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_PACKET</span><span class="p">;</span>

	<span class="cm">/* is it pointless to prefer PIO for &quot;safety reasons&quot;? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_PIO_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ATAPI_PROT_DMA</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">|=</span> <span class="n">ATAPI_PKT_DMA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ATAPI_PROT_PIO</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">lbam</span> <span class="o">=</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">lbah</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ata_exec_internal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="n">cdb</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span>
				 <span class="n">sense_buf</span><span class="p">,</span> <span class="n">SCSI_SENSE_BUFFERSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_analyze_serror - analyze SError for a failed port</span>
<span class="cm"> *	@link: ATA link to analyze SError for</span>
<span class="cm"> *</span>
<span class="cm"> *	Analyze SError if available and further determine cause of</span>
<span class="cm"> *	failure.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_analyze_serror</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serror</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotplug_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERR_PERSISTENT</span> <span class="o">|</span> <span class="n">SERR_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_ATA_BUS</span><span class="p">;</span>
		<span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_PROTOCOL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
		<span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_SYSTEM</span><span class="p">;</span>
		<span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine whether a hotplug event has occurred.  Both</span>
<span class="cm">	 * SError.N/X are considered hotplug events for enabled or</span>
<span class="cm">	 * host links.  For disabled PMP links, only N bit is</span>
<span class="cm">	 * considered as X bit is left at 1 for link plugging.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">&gt;</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">)</span>
		<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* hotplug doesn&#39;t work w/ LPM */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_DISABLED</span><span class="p">)</span> <span class="o">||</span> <span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="n">SERR_PHYRDY_CHG</span> <span class="o">|</span> <span class="n">SERR_DEV_XCHG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hotplug_mask</span> <span class="o">=</span> <span class="n">SERR_PHYRDY_CHG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">hotplug_mask</span><span class="p">)</span>
		<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">);</span>

	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_analyze_ncq_error - analyze NCQ error</span>
<span class="cm"> *	@link: ATA link to analyze NCQ error for</span>
<span class="cm"> *</span>
<span class="cm"> *	Read log page 10h, determine the offending qc and acquire</span>
<span class="cm"> *	error status TF.  For NCQ device errors, all LLDDs have to do</span>
<span class="cm"> *	is setting AC_ERR_DEV in ehi-&gt;err_mask.  This function takes</span>
<span class="cm"> *	care of the rest.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_analyze_ncq_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* if frozen, we can&#39;t do much */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* is it NCQ device error? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">sactive</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_DEV</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* has LLDD analyzed already? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* okay, this error is ours */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="p">));</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_read_log_10h</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;failed to read log page 10h (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">sactive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tag</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;log page 10h reported inactive tag %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">tag</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we&#39;ve got the perpetrator, condemn it */</span>
	<span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tf</span><span class="p">));</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATA_TFLAG_ISADDR</span> <span class="o">|</span> <span class="n">ATA_TFLAG_LBA</span> <span class="o">|</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">;</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span> <span class="o">|</span> <span class="n">AC_ERR_NCQ</span><span class="p">;</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC_ERR_DEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_analyze_tf - analyze taskfile of a failed qc</span>
<span class="cm"> *	@qc: qc to analyze</span>
<span class="cm"> *	@tf: Taskfile registers to analyze</span>
<span class="cm"> *</span>
<span class="cm"> *	Analyze taskfile of @qc and further determine cause of</span>
<span class="cm"> *	failure.  This function also requests ATAPI sense data if</span>
<span class="cm"> *	available.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Determined recovery action</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ata_eh_analyze_tf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRQ</span> <span class="o">|</span> <span class="n">ATA_DRDY</span><span class="p">))</span> <span class="o">!=</span> <span class="n">ATA_DRDY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_ERR</span> <span class="o">|</span> <span class="n">ATA_DF</span><span class="p">))</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_DEV_ATA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ATA_ICRC</span><span class="p">)</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_ATA_BUS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ATA_UNC</span><span class="p">)</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_MEDIA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">ATA_IDNF</span><span class="p">)</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_INVALID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATA_DEV_ATAPI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">atapi_eh_request_sense</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">,</span>
						<span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* ATA_QCFLAG_SENSE_VALID is used to</span>
<span class="cm">				 * tell atapi_qc_complete() that sense</span>
<span class="cm">				 * data is already valid.</span>
<span class="cm">				 *</span>
<span class="cm">				 * TODO: interpret sense data and set</span>
<span class="cm">				 * appropriate err_mask.</span>
<span class="cm">				 */</span>
				<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_SENSE_VALID</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AC_ERR_HSM</span> <span class="o">|</span> <span class="n">AC_ERR_TIMEOUT</span> <span class="o">|</span> <span class="n">AC_ERR_ATA_BUS</span><span class="p">))</span>
		<span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_categorize_error</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eflags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="o">*</span><span class="n">xfer_ok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">ATA_EFLAG_DUBIOUS_XFER</span><span class="p">))</span>
		<span class="o">*</span><span class="n">xfer_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">xfer_ok</span><span class="p">)</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">ATA_ECAT_DUBIOUS_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_ATA_BUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ATA_ECAT_ATA_BUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ATA_ECAT_TOUT_HSM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">ATA_EFLAG_IS_IO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_HSM</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ATA_ECAT_TOUT_HSM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err_mask</span> <span class="o">&amp;</span>
		     <span class="p">(</span><span class="n">AC_ERR_DEV</span><span class="o">|</span><span class="n">AC_ERR_MEDIA</span><span class="o">|</span><span class="n">AC_ERR_INVALID</span><span class="p">))</span> <span class="o">==</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ATA_ECAT_UNK_DEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">speed_down_verdict_arg</span> <span class="p">{</span>
	<span class="n">u64</span> <span class="n">since</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xfer_ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_NR</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">speed_down_verdict_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">void_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">speed_down_verdict_arg</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">void_arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">ATA_EFLAG_OLD_ER</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">since</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">cat</span> <span class="o">=</span> <span class="n">ata_eh_categorize_error</span><span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">eflags</span><span class="p">,</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">xfer_ok</span><span class="p">);</span>
	<span class="n">arg</span><span class="o">-&gt;</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_speed_down_verdict - Determine speed down verdict</span>
<span class="cm"> *	@dev: Device of interest</span>
<span class="cm"> *</span>
<span class="cm"> *	This function examines error ring of @dev and determines</span>
<span class="cm"> *	whether NCQ needs to be turned off, transfer speed should be</span>
<span class="cm"> *	stepped down, or falling back to PIO is necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *	ECAT_ATA_BUS	: ATA_BUS error for any command</span>
<span class="cm"> *</span>
<span class="cm"> *	ECAT_TOUT_HSM	: TIMEOUT for any command or HSM violation for</span>
<span class="cm"> *			  IO commands</span>
<span class="cm"> *</span>
<span class="cm"> *	ECAT_UNK_DEV	: Unknown DEV error for IO commands</span>
<span class="cm"> *</span>
<span class="cm"> *	ECAT_DUBIOUS_*	: Identical to above three but occurred while</span>
<span class="cm"> *			  data transfer hasn&#39;t been verified.</span>
<span class="cm"> *</span>
<span class="cm"> *	Verdicts are</span>
<span class="cm"> *</span>
<span class="cm"> *	NCQ_OFF		: Turn off NCQ.</span>
<span class="cm"> *</span>
<span class="cm"> *	SPEED_DOWN	: Speed down transfer speed but don&#39;t fall back</span>
<span class="cm"> *			  to PIO.</span>
<span class="cm"> *</span>
<span class="cm"> *	FALLBACK_TO_PIO	: Fall back to PIO.</span>
<span class="cm"> *</span>
<span class="cm"> *	Even if multiple verdicts are returned, only one action is</span>
<span class="cm"> *	taken per error.  An action triggered by non-DUBIOUS errors</span>
<span class="cm"> *	clears ering, while one triggered by DUBIOUS_* errors doesn&#39;t.</span>
<span class="cm"> *	This is to expedite speed down decisions right after device is</span>
<span class="cm"> *	initially configured.</span>
<span class="cm"> *</span>
<span class="cm"> *	The followings are speed down rules.  #1 and #2 deal with</span>
<span class="cm"> *	DUBIOUS errors.</span>
<span class="cm"> *</span>
<span class="cm"> *	1. If more than one DUBIOUS_ATA_BUS or DUBIOUS_TOUT_HSM errors</span>
<span class="cm"> *	   occurred during last 5 mins, SPEED_DOWN and FALLBACK_TO_PIO.</span>
<span class="cm"> *</span>
<span class="cm"> *	2. If more than one DUBIOUS_TOUT_HSM or DUBIOUS_UNK_DEV errors</span>
<span class="cm"> *	   occurred during last 5 mins, NCQ_OFF.</span>
<span class="cm"> *</span>
<span class="cm"> *	3. If more than 8 ATA_BUS, TOUT_HSM or UNK_DEV errors</span>
<span class="cm"> *	   occurred during last 5 mins, FALLBACK_TO_PIO</span>
<span class="cm"> *</span>
<span class="cm"> *	4. If more than 3 TOUT_HSM or UNK_DEV errors occurred</span>
<span class="cm"> *	   during last 10 mins, NCQ_OFF.</span>
<span class="cm"> *</span>
<span class="cm"> *	5. If more than 3 ATA_BUS or TOUT_HSM errors, or more than 6</span>
<span class="cm"> *	   UNK_DEV errors occurred during last 10 mins, SPEED_DOWN.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Inherited from caller.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	OR of ATA_EH_SPDN_* flags.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ata_eh_speed_down_verdict</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u64</span> <span class="n">j5mins</span> <span class="o">=</span> <span class="mi">5LLU</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">,</span> <span class="n">j10mins</span> <span class="o">=</span> <span class="mi">10LLU</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">j64</span> <span class="o">=</span> <span class="n">get_jiffies_64</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">speed_down_verdict_arg</span> <span class="n">arg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verdict</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* scan past 5 mins of error history */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">since</span> <span class="o">=</span> <span class="n">j64</span> <span class="o">-</span> <span class="n">min</span><span class="p">(</span><span class="n">j64</span><span class="p">,</span> <span class="n">j5mins</span><span class="p">);</span>
	<span class="n">ata_ering_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">,</span> <span class="n">speed_down_verdict_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_DUBIOUS_ATA_BUS</span><span class="p">]</span> <span class="o">+</span>
	    <span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_DUBIOUS_TOUT_HSM</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">verdict</span> <span class="o">|=</span> <span class="n">ATA_EH_SPDN_SPEED_DOWN</span> <span class="o">|</span>
			<span class="n">ATA_EH_SPDN_FALLBACK_TO_PIO</span> <span class="o">|</span> <span class="n">ATA_EH_SPDN_KEEP_ERRORS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_DUBIOUS_TOUT_HSM</span><span class="p">]</span> <span class="o">+</span>
	    <span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_DUBIOUS_UNK_DEV</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">verdict</span> <span class="o">|=</span> <span class="n">ATA_EH_SPDN_NCQ_OFF</span> <span class="o">|</span> <span class="n">ATA_EH_SPDN_KEEP_ERRORS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_ATA_BUS</span><span class="p">]</span> <span class="o">+</span>
	    <span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_TOUT_HSM</span><span class="p">]</span> <span class="o">+</span>
	    <span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_UNK_DEV</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">verdict</span> <span class="o">|=</span> <span class="n">ATA_EH_SPDN_FALLBACK_TO_PIO</span><span class="p">;</span>

	<span class="cm">/* scan past 10 mins of error history */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="n">arg</span><span class="p">.</span><span class="n">since</span> <span class="o">=</span> <span class="n">j64</span> <span class="o">-</span> <span class="n">min</span><span class="p">(</span><span class="n">j64</span><span class="p">,</span> <span class="n">j10mins</span><span class="p">);</span>
	<span class="n">ata_ering_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">,</span> <span class="n">speed_down_verdict_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_TOUT_HSM</span><span class="p">]</span> <span class="o">+</span>
	    <span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_UNK_DEV</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">verdict</span> <span class="o">|=</span> <span class="n">ATA_EH_SPDN_NCQ_OFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_ATA_BUS</span><span class="p">]</span> <span class="o">+</span>
	    <span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_TOUT_HSM</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span>
	    <span class="n">arg</span><span class="p">.</span><span class="n">nr_errors</span><span class="p">[</span><span class="n">ATA_ECAT_UNK_DEV</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">verdict</span> <span class="o">|=</span> <span class="n">ATA_EH_SPDN_SPEED_DOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">verdict</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_speed_down - record error and speed down if necessary</span>
<span class="cm"> *	@dev: Failed device</span>
<span class="cm"> *	@eflags: mask of ATA_EFLAG_* flags</span>
<span class="cm"> *	@err_mask: err_mask of the error</span>
<span class="cm"> *</span>
<span class="cm"> *	Record error and examine error history to determine whether</span>
<span class="cm"> *	adjusting transmission speed is necessary.  It also sets</span>
<span class="cm"> *	transmission limits appropriately if such adjustment is</span>
<span class="cm"> *	necessary.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	Determined recovery action.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ata_eh_speed_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">eflags</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">xfer_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">verdict</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* don&#39;t bother if Cat-0 error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_eh_categorize_error</span><span class="p">(</span><span class="n">eflags</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xfer_ok</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* record error and determine whether speed down is necessary */</span>
	<span class="n">ata_ering_record</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">,</span> <span class="n">eflags</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
	<span class="n">verdict</span> <span class="o">=</span> <span class="n">ata_eh_speed_down_verdict</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* turn off NCQ? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">verdict</span> <span class="o">&amp;</span> <span class="n">ATA_EH_SPDN_NCQ_OFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_DFLAG_PIO</span> <span class="o">|</span> <span class="n">ATA_DFLAG_NCQ</span> <span class="o">|</span>
			   <span class="n">ATA_DFLAG_NCQ_OFF</span><span class="p">))</span> <span class="o">==</span> <span class="n">ATA_DFLAG_NCQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_DFLAG_NCQ_OFF</span><span class="p">;</span>
		<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NCQ disabled due to excessive errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* speed down? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">verdict</span> <span class="o">&amp;</span> <span class="n">ATA_EH_SPDN_SPEED_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* speed down SATA link speed if possible */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sata_down_spd_limit</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* lower transfer mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spdn_cnt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">dma_dnxfer_sel</span><span class="p">[]</span> <span class="o">=</span>
				<span class="p">{</span> <span class="n">ATA_DNXFER_DMA</span><span class="p">,</span> <span class="n">ATA_DNXFER_40C</span> <span class="p">};</span>
			<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pio_dnxfer_sel</span><span class="p">[]</span> <span class="o">=</span>
				<span class="p">{</span> <span class="n">ATA_DNXFER_PIO</span><span class="p">,</span> <span class="n">ATA_DNXFER_FORCE_PIO0</span> <span class="p">};</span>
			<span class="kt">int</span> <span class="n">sel</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xfer_shift</span> <span class="o">!=</span> <span class="n">ATA_SHIFT_PIO</span><span class="p">)</span>
				<span class="n">sel</span> <span class="o">=</span> <span class="n">dma_dnxfer_sel</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spdn_cnt</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">sel</span> <span class="o">=</span> <span class="n">pio_dnxfer_sel</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spdn_cnt</span><span class="p">];</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">spdn_cnt</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ata_down_xfermask_limit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Fall back to PIO?  Slowing down to PIO is meaningless for</span>
<span class="cm">	 * SATA ATA devices.  Consider it only for PATA and SATAPI.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">verdict</span> <span class="o">&amp;</span> <span class="n">ATA_EH_SPDN_FALLBACK_TO_PIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">spdn_cnt</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">cbl</span> <span class="o">!=</span> <span class="n">ATA_CBL_SATA</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xfer_shift</span> <span class="o">!=</span> <span class="n">ATA_SHIFT_PIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_down_xfermask_limit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ATA_DNXFER_FORCE_PIO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">spdn_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">done:</span>
	<span class="cm">/* device has been slowed down, blow error history */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">verdict</span> <span class="o">&amp;</span> <span class="n">ATA_EH_SPDN_KEEP_ERRORS</span><span class="p">))</span>
		<span class="n">ata_ering_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_worth_retry - analyze error and decide whether to retry</span>
<span class="cm"> *	@qc: qc to possibly retry</span>
<span class="cm"> *</span>
<span class="cm"> *	Look at the cause of the error and decide if a retry</span>
<span class="cm"> * 	might be useful or not.  We don&#39;t want to retry media errors</span>
<span class="cm"> *	because the drive itself has probably already taken 10-30 seconds</span>
<span class="cm"> *	doing its own internal retries before reporting the failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ata_eh_worth_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC_ERR_MEDIA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* don&#39;t retry media errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_IO</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* otherwise retry anything from fs stack */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* don&#39;t retry these */</span>
	<span class="k">return</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">!=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>  <span class="cm">/* retry if not dev error */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_link_autopsy - analyze error and determine recovery action</span>
<span class="cm"> *	@link: host link to perform autopsy on</span>
<span class="cm"> *</span>
<span class="cm"> *	Analyze why @link failed and determine which recovery actions</span>
<span class="cm"> *	are needed.  This function also sets more detailed AC_ERR_*</span>
<span class="cm"> *	values and fills sense data for ATAPI CHECK SENSE.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_link_autopsy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">all_err_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serror</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_NO_AUTOPSY</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* obtain and analyze SError */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_scr_read</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serror</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">|=</span> <span class="n">serror</span><span class="p">;</span>
		<span class="n">ata_eh_analyze_serror</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SError read failed, force reset and probing */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">probe_mask</span> <span class="o">|=</span> <span class="n">ATA_ALL_DEVICES</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_OTHER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* analyze NCQ failure */</span>
	<span class="n">ata_eh_analyze_ncq_error</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="cm">/* any real error trumps AC_ERR_OTHER */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC_ERR_OTHER</span><span class="p">)</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC_ERR_OTHER</span><span class="p">;</span>

	<span class="n">all_err_mask</span> <span class="o">|=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">link</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* inherit upper level err_mask */</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span><span class="p">;</span>

		<span class="cm">/* analyze TF */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ata_eh_analyze_tf</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">);</span>

		<span class="cm">/* DEV errors are probably spurious in case of ATA_BUS error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_ATA_BUS</span><span class="p">)</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AC_ERR_DEV</span> <span class="o">|</span> <span class="n">AC_ERR_MEDIA</span> <span class="o">|</span>
					  <span class="n">AC_ERR_INVALID</span><span class="p">);</span>

		<span class="cm">/* any real error trumps unknown error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC_ERR_OTHER</span><span class="p">)</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AC_ERR_OTHER</span><span class="p">;</span>

		<span class="cm">/* SENSE_VALID trumps dev/unknown error and revalidation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_SENSE_VALID</span><span class="p">)</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AC_ERR_DEV</span> <span class="o">|</span> <span class="n">AC_ERR_OTHER</span><span class="p">);</span>

		<span class="cm">/* determine whether the command is worth retrying */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_eh_worth_retry</span><span class="p">(</span><span class="n">qc</span><span class="p">))</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_QCFLAG_RETRY</span><span class="p">;</span>

		<span class="cm">/* accumulate error info */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">all_err_mask</span> <span class="o">|=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_IO</span><span class="p">)</span>
			<span class="n">eflags</span> <span class="o">|=</span> <span class="n">ATA_EFLAG_IS_IO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enforce default EH actions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span> <span class="o">||</span>
	    <span class="n">all_err_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AC_ERR_HSM</span> <span class="o">|</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">))</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">ATA_EFLAG_IS_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all_err_mask</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">ATA_EFLAG_IS_IO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">all_err_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AC_ERR_DEV</span><span class="p">)))</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">;</span>

	<span class="cm">/* If we have offending qcs and the associated failed device,</span>
<span class="cm">	 * perform per-dev EH action only on the offending device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">|=</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_PERDEV_MASK</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EH_PERDEV_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* propagate timeout to host link */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">all_err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_context</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* record error and consider speeding down */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ata_link_max_devices</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		      <span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))))</span>
	    <span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_DUBIOUS_XFER</span><span class="p">)</span>
			<span class="n">eflags</span> <span class="o">|=</span> <span class="n">ATA_EFLAG_DUBIOUS_XFER</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ata_eh_speed_down</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">eflags</span><span class="p">,</span> <span class="n">all_err_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_autopsy - analyze error and determine recovery action</span>
<span class="cm"> *	@ap: host port to perform autopsy on</span>
<span class="cm"> *</span>
<span class="cm"> *	Analyze all links of @ap and determine why they failed and</span>
<span class="cm"> *	which recovery actions are needed.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_autopsy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>

	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
		<span class="n">ata_eh_link_autopsy</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="cm">/* Handle the frigging slave link.  Autopsy is done similarly</span>
<span class="cm">	 * but actions and flags are transferred over to the master</span>
<span class="cm">	 * link and handled from there.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">mehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_context</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">sehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

		<span class="cm">/* transfer control flags from master to slave */</span>
		<span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">mehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_TO_SLAVE_MASK</span><span class="p">;</span>

		<span class="cm">/* perform autopsy on the slave link */</span>
		<span class="n">ata_eh_link_autopsy</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">);</span>

		<span class="cm">/* transfer actions from slave to master and clear slave */</span>
		<span class="n">ata_eh_about_to_do</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_ALL_ACTIONS</span><span class="p">);</span>
		<span class="n">mehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span>		<span class="o">|=</span> <span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span><span class="p">;</span>
		<span class="n">mehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">|=</span> <span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">mehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span>		<span class="o">|=</span> <span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">ata_eh_done</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_ALL_ACTIONS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Autopsy of fanout ports can affect host link autopsy.</span>
<span class="cm">	 * Perform host link autopsy last.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
		<span class="n">ata_eh_link_autopsy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_get_cmd_descript - get description for ATA command</span>
<span class="cm"> *	@command: ATA command code to get description for</span>
<span class="cm"> *</span>
<span class="cm"> *	Return a textual description of the given command, or NULL if the</span>
<span class="cm"> *	command is not known.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ata_get_cmd_descript</span><span class="p">(</span><span class="n">u8</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_ATA_VERBOSE_ERROR</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span>
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">command</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">text</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cmd_descr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ATA_CMD_DEV_RESET</span><span class="p">,</span>		<span class="s">&quot;DEVICE RESET&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CHK_POWER</span><span class="p">,</span> 		<span class="s">&quot;CHECK POWER MODE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_STANDBY</span><span class="p">,</span> 		<span class="s">&quot;STANDBY&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_IDLE</span><span class="p">,</span> 		<span class="s">&quot;IDLE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_EDD</span><span class="p">,</span> 			<span class="s">&quot;EXECUTE DEVICE DIAGNOSTIC&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_DOWNLOAD_MICRO</span><span class="p">,</span>   	<span class="s">&quot;DOWNLOAD MICROCODE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_NOP</span><span class="p">,</span>			<span class="s">&quot;NOP&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_FLUSH</span><span class="p">,</span> 		<span class="s">&quot;FLUSH CACHE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_FLUSH_EXT</span><span class="p">,</span> 		<span class="s">&quot;FLUSH CACHE EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_ID_ATA</span><span class="p">,</span>  		<span class="s">&quot;IDENTIFY DEVICE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_ID_ATAPI</span><span class="p">,</span> 		<span class="s">&quot;IDENTIFY PACKET DEVICE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SERVICE</span><span class="p">,</span> 		<span class="s">&quot;SERVICE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ</span><span class="p">,</span> 		<span class="s">&quot;READ DMA&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_EXT</span><span class="p">,</span> 		<span class="s">&quot;READ DMA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_QUEUED</span><span class="p">,</span> 		<span class="s">&quot;READ DMA QUEUED&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_STREAM_EXT</span><span class="p">,</span> 	<span class="s">&quot;READ STREAM EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_STREAM_DMA_EXT</span><span class="p">,</span>  <span class="s">&quot;READ STREAM DMA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE</span><span class="p">,</span> 		<span class="s">&quot;WRITE DMA&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_EXT</span><span class="p">,</span> 		<span class="s">&quot;WRITE DMA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_QUEUED</span><span class="p">,</span> 	<span class="s">&quot;WRITE DMA QUEUED EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_STREAM_EXT</span><span class="p">,</span> 	<span class="s">&quot;WRITE STREAM EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_STREAM_DMA_EXT</span><span class="p">,</span> <span class="s">&quot;WRITE STREAM DMA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_FUA_EXT</span><span class="p">,</span>	<span class="s">&quot;WRITE DMA FUA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_QUEUED_FUA_EXT</span><span class="p">,</span> <span class="s">&quot;WRITE DMA QUEUED FUA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_FPDMA_READ</span><span class="p">,</span>		<span class="s">&quot;READ FPDMA QUEUED&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_FPDMA_WRITE</span><span class="p">,</span>		<span class="s">&quot;WRITE FPDMA QUEUED&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_PIO_READ</span><span class="p">,</span>		<span class="s">&quot;READ SECTOR(S)&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_PIO_READ_EXT</span><span class="p">,</span>		<span class="s">&quot;READ SECTOR(S) EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_PIO_WRITE</span><span class="p">,</span>		<span class="s">&quot;WRITE SECTOR(S)&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_PIO_WRITE_EXT</span><span class="p">,</span>	<span class="s">&quot;WRITE SECTOR(S) EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_MULTI</span><span class="p">,</span>		<span class="s">&quot;READ MULTIPLE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_MULTI_EXT</span><span class="p">,</span>	<span class="s">&quot;READ MULTIPLE EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_MULTI</span><span class="p">,</span>		<span class="s">&quot;WRITE MULTIPLE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_MULTI_EXT</span><span class="p">,</span>	<span class="s">&quot;WRITE MULTIPLE EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_MULTI_FUA_EXT</span><span class="p">,</span> 	<span class="s">&quot;WRITE MULTIPLE FUA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SET_FEATURES</span><span class="p">,</span>		<span class="s">&quot;SET FEATURES&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SET_MULTI</span><span class="p">,</span>		<span class="s">&quot;SET MULTIPLE MODE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_VERIFY</span><span class="p">,</span>		<span class="s">&quot;READ VERIFY SECTOR(S)&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_VERIFY_EXT</span><span class="p">,</span>		<span class="s">&quot;READ VERIFY SECTOR(S) EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_UNCORR_EXT</span><span class="p">,</span>	<span class="s">&quot;WRITE UNCORRECTABLE EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_STANDBYNOW1</span><span class="p">,</span>		<span class="s">&quot;STANDBY IMMEDIATE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_IDLEIMMEDIATE</span><span class="p">,</span>	<span class="s">&quot;IDLE IMMEDIATE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SLEEP</span><span class="p">,</span>		<span class="s">&quot;SLEEP&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_INIT_DEV_PARAMS</span><span class="p">,</span>	<span class="s">&quot;INITIALIZE DEVICE PARAMETERS&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_NATIVE_MAX</span><span class="p">,</span>	<span class="s">&quot;READ NATIVE MAX ADDRESS&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_NATIVE_MAX_EXT</span><span class="p">,</span>	<span class="s">&quot;READ NATIVE MAX ADDRESS EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SET_MAX</span><span class="p">,</span>		<span class="s">&quot;SET MAX ADDRESS&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SET_MAX_EXT</span><span class="p">,</span>		<span class="s">&quot;SET MAX ADDRESS EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_LOG_EXT</span><span class="p">,</span>		<span class="s">&quot;READ LOG EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_LOG_EXT</span><span class="p">,</span>	<span class="s">&quot;WRITE LOG EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_LOG_DMA_EXT</span><span class="p">,</span>	<span class="s">&quot;READ LOG DMA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_LOG_DMA_EXT</span><span class="p">,</span> 	<span class="s">&quot;WRITE LOG DMA EXT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_TRUSTED_RCV</span><span class="p">,</span>		<span class="s">&quot;TRUSTED RECEIVE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_TRUSTED_RCV_DMA</span><span class="p">,</span> 	<span class="s">&quot;TRUSTED RECEIVE DMA&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_TRUSTED_SND</span><span class="p">,</span>		<span class="s">&quot;TRUSTED SEND&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_TRUSTED_SND_DMA</span><span class="p">,</span> 	<span class="s">&quot;TRUSTED SEND DMA&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_PMP_READ</span><span class="p">,</span>		<span class="s">&quot;READ BUFFER&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_PMP_WRITE</span><span class="p">,</span>		<span class="s">&quot;WRITE BUFFER&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CONF_OVERLAY</span><span class="p">,</span>		<span class="s">&quot;DEVICE CONFIGURATION OVERLAY&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SEC_SET_PASS</span><span class="p">,</span>		<span class="s">&quot;SECURITY SET PASSWORD&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SEC_UNLOCK</span><span class="p">,</span>		<span class="s">&quot;SECURITY UNLOCK&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SEC_ERASE_PREP</span><span class="p">,</span>	<span class="s">&quot;SECURITY ERASE PREPARE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SEC_ERASE_UNIT</span><span class="p">,</span>	<span class="s">&quot;SECURITY ERASE UNIT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SEC_FREEZE_LOCK</span><span class="p">,</span>	<span class="s">&quot;SECURITY FREEZE LOCK&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SEC_DISABLE_PASS</span><span class="p">,</span>	<span class="s">&quot;SECURITY DISABLE PASSWORD&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CONFIG_STREAM</span><span class="p">,</span>	<span class="s">&quot;CONFIGURE STREAM&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_SMART</span><span class="p">,</span>		<span class="s">&quot;SMART&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_MEDIA_LOCK</span><span class="p">,</span>		<span class="s">&quot;DOOR LOCK&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_MEDIA_UNLOCK</span><span class="p">,</span>		<span class="s">&quot;DOOR UNLOCK&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_DSM</span><span class="p">,</span>			<span class="s">&quot;DATA SET MANAGEMENT&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CHK_MED_CRD_TYP</span><span class="p">,</span> 	<span class="s">&quot;CHECK MEDIA CARD TYPE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CFA_REQ_EXT_ERR</span><span class="p">,</span> 	<span class="s">&quot;CFA REQUEST EXTENDED ERROR&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CFA_WRITE_NE</span><span class="p">,</span>		<span class="s">&quot;CFA WRITE SECTORS WITHOUT ERASE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CFA_TRANS_SECT</span><span class="p">,</span>	<span class="s">&quot;CFA TRANSLATE SECTOR&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CFA_ERASE</span><span class="p">,</span>		<span class="s">&quot;CFA ERASE SECTORS&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_CFA_WRITE_MULT_NE</span><span class="p">,</span> 	<span class="s">&quot;CFA WRITE MULTIPLE WITHOUT ERASE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_LONG</span><span class="p">,</span>		<span class="s">&quot;READ LONG (with retries)&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_READ_LONG_ONCE</span><span class="p">,</span>	<span class="s">&quot;READ LONG (without retries)&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_LONG</span><span class="p">,</span>		<span class="s">&quot;WRITE LONG (with retries)&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_WRITE_LONG_ONCE</span><span class="p">,</span>	<span class="s">&quot;WRITE LONG (without retries)&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ATA_CMD_RESTORE</span><span class="p">,</span>		<span class="s">&quot;RECALIBRATE&quot;</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>				<span class="nb">NULL</span> <span class="p">}</span> <span class="cm">/* terminate list */</span>
	<span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cmd_descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">text</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">command</span> <span class="o">==</span> <span class="n">command</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cmd_descr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">text</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_link_report - report error handling to user</span>
<span class="cm"> *	@link: ATA link EH is going on</span>
<span class="cm"> *</span>
<span class="cm"> *	Report EH to user.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_link_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">frozen</span><span class="p">,</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tries_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">,</span> <span class="n">nr_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_QUIET</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">link</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_QUIET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">==</span> <span class="n">AC_ERR_DEV</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_SENSE_VALID</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">nr_failed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nr_failed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">frozen</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span>
		<span class="n">frozen</span> <span class="o">=</span> <span class="s">&quot; frozen&quot;</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tries_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tries_buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_tries</span> <span class="o">&lt;</span> <span class="n">ATA_EH_MAX_TRIES</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">tries_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tries_buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot; t%d&quot;</span><span class="p">,</span>
			 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">eh_tries</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;exception Emask 0x%x &quot;</span>
			    <span class="s">&quot;SAct 0x%x SErr 0x%x action 0x%x%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">sactive</span><span class="p">,</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span><span class="p">,</span>
			    <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span><span class="p">,</span> <span class="n">frozen</span><span class="p">,</span> <span class="n">tries_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;exception Emask 0x%x &quot;</span>
			     <span class="s">&quot;SAct 0x%x SErr 0x%x action 0x%x%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">err_mask</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">sactive</span><span class="p">,</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span><span class="p">,</span>
			     <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span><span class="p">,</span> <span class="n">frozen</span><span class="p">,</span> <span class="n">tries_buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="p">)</span>
			<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ATA_VERBOSE_ERROR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span><span class="p">)</span>
		<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
		  <span class="s">&quot;SError: { %s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s%s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_DATA_RECOVERED</span> <span class="o">?</span> <span class="s">&quot;RecovData &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_COMM_RECOVERED</span> <span class="o">?</span> <span class="s">&quot;RecovComm &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_DATA</span> <span class="o">?</span> <span class="s">&quot;UnrecovData &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_PERSISTENT</span> <span class="o">?</span> <span class="s">&quot;Persist &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_PROTOCOL</span> <span class="o">?</span> <span class="s">&quot;Proto &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_INTERNAL</span> <span class="o">?</span> <span class="s">&quot;HostInt &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_PHYRDY_CHG</span> <span class="o">?</span> <span class="s">&quot;PHYRdyChg &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_PHY_INT_ERR</span> <span class="o">?</span> <span class="s">&quot;PHYInt &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_COMM_WAKE</span> <span class="o">?</span> <span class="s">&quot;CommWake &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_10B_8B_ERR</span> <span class="o">?</span> <span class="s">&quot;10B8B &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_DISPARITY</span> <span class="o">?</span> <span class="s">&quot;Dispar &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_CRC</span> <span class="o">?</span> <span class="s">&quot;BadCRC &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_HANDSHAKE</span> <span class="o">?</span> <span class="s">&quot;Handshk &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_LINK_SEQ_ERR</span> <span class="o">?</span> <span class="s">&quot;LinkSeq &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_TRANS_ST_ERROR</span> <span class="o">?</span> <span class="s">&quot;TrStaTrns &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_UNRECOG_FIS</span> <span class="o">?</span> <span class="s">&quot;UnrecFIS &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		  <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">serror</span> <span class="o">&amp;</span> <span class="n">SERR_DEV_XCHG</span> <span class="o">?</span> <span class="s">&quot;DevExch &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">,</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cdb</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">data_buf</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">cdb_buf</span><span class="p">[</span><span class="mi">70</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">link</span> <span class="o">||</span> <span class="o">!</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">!=</span> <span class="n">DMA_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dma_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">[</span><span class="n">DMA_BIDIRECTIONAL</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;bidi&quot;</span><span class="p">,</span>
				<span class="p">[</span><span class="n">DMA_TO_DEVICE</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;out&quot;</span><span class="p">,</span>
				<span class="p">[</span><span class="n">DMA_FROM_DEVICE</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;in&quot;</span><span class="p">,</span>
			<span class="p">};</span>
			<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prot_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">[</span><span class="n">ATA_PROT_PIO</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span>
				<span class="p">[</span><span class="n">ATA_PROT_DMA</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;dma&quot;</span><span class="p">,</span>
				<span class="p">[</span><span class="n">ATA_PROT_NCQ</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;ncq&quot;</span><span class="p">,</span>
				<span class="p">[</span><span class="n">ATAPI_PROT_PIO</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;pio&quot;</span><span class="p">,</span>
				<span class="p">[</span><span class="n">ATAPI_PROT_DMA</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;dma&quot;</span><span class="p">,</span>
			<span class="p">};</span>

			<span class="n">snprintf</span><span class="p">(</span><span class="n">data_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data_buf</span><span class="p">),</span> <span class="s">&quot; %s %u %s&quot;</span><span class="p">,</span>
				 <span class="n">prot_str</span><span class="p">[</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">],</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">,</span>
				 <span class="n">dma_str</span><span class="p">[</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dma_dir</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ata_is_atapi</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="p">)</span>
				<span class="n">scsi_print_command</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">snprintf</span><span class="p">(</span><span class="n">cdb_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cdb_buf</span><span class="p">),</span>
				 <span class="s">&quot;cdb %02x %02x %02x %02x %02x %02x %02x %02x  &quot;</span>
				 <span class="s">&quot;%02x %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">         &quot;</span><span class="p">,</span>
				 <span class="n">cdb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
				 <span class="n">cdb</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
				 <span class="n">cdb</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span>
				 <span class="n">cdb</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">cdb</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">descr</span> <span class="o">=</span> <span class="n">ata_get_cmd_descript</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">descr</span><span class="p">)</span>
				<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed command: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">descr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd %02x/%02x:%02x:%02x:%02x:%02x/%02x:%02x:%02x:%02x:%02x/%02x &quot;</span>
			<span class="s">&quot;tag %d%s</span><span class="se">\n</span><span class="s">         %s&quot;</span>
			<span class="s">&quot;res %02x/%02x:%02x:%02x:%02x:%02x/%02x:%02x:%02x:%02x:%02x/%02x &quot;</span>
			<span class="s">&quot;Emask 0x%x (%s)%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hob_feature</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span> <span class="n">cdb_buf</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">hob_feature</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">,</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">,</span> <span class="n">ata_err_string</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">),</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_NCQ</span> <span class="o">?</span> <span class="s">&quot; &lt;F&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ATA_VERBOSE_ERROR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRDY</span> <span class="o">|</span> <span class="n">ATA_DF</span> <span class="o">|</span> <span class="n">ATA_DRQ</span> <span class="o">|</span>
				    <span class="n">ATA_ERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">ATA_BUSY</span><span class="p">)</span>
				<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;status: { Busy }</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;status: { %s%s%s%s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">res</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">ATA_DRDY</span> <span class="o">?</span> <span class="s">&quot;DRDY &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				  <span class="n">res</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">ATA_DF</span> <span class="o">?</span> <span class="s">&quot;DF &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				  <span class="n">res</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">ATA_DRQ</span> <span class="o">?</span> <span class="s">&quot;DRQ &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				  <span class="n">res</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span> <span class="o">?</span> <span class="s">&quot;ERR &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">!=</span> <span class="n">ATA_CMD_PACKET</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_ICRC</span> <span class="o">|</span> <span class="n">ATA_UNC</span> <span class="o">|</span> <span class="n">ATA_IDNF</span> <span class="o">|</span>
				     <span class="n">ATA_ABORTED</span><span class="p">)))</span>
			<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error: { %s%s%s%s}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">res</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="n">ATA_ICRC</span> <span class="o">?</span> <span class="s">&quot;ICRC &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			  <span class="n">res</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="n">ATA_UNC</span> <span class="o">?</span> <span class="s">&quot;UNC &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			  <span class="n">res</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="n">ATA_IDNF</span> <span class="o">?</span> <span class="s">&quot;IDNF &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			  <span class="n">res</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">&amp;</span> <span class="n">ATA_ABORTED</span> <span class="o">?</span> <span class="s">&quot;ABRT &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_report - report error handling to user</span>
<span class="cm"> *	@ap: ATA port to report EH about</span>
<span class="cm"> *</span>
<span class="cm"> *	Report EH to user.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>

	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">HOST_FIRST</span><span class="p">)</span>
		<span class="n">ata_eh_link_report</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_do_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="n">ata_reset_fn_t</span> <span class="n">reset</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">classes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">,</span>
			<span class="n">bool</span> <span class="n">clear_classes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clear_classes</span><span class="p">)</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
			<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_followup_srst_needed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_NO_SRST</span><span class="p">)</span> <span class="o">||</span> <span class="n">ata_link_offline</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_supported</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ata_eh_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">int</span> <span class="n">classify</span><span class="p">,</span>
		 <span class="n">ata_prereset_fn_t</span> <span class="n">prereset</span><span class="p">,</span> <span class="n">ata_reset_fn_t</span> <span class="n">softreset</span><span class="p">,</span>
		 <span class="n">ata_reset_fn_t</span> <span class="n">hardreset</span><span class="p">,</span> <span class="n">ata_postreset_fn_t</span> <span class="n">postreset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">sehc</span> <span class="o">=</span> <span class="n">slave</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">eh_context</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">classes</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lflags</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">verbose</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_QUIET</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">try</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">failed_link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">,</span> <span class="n">now</span><span class="p">;</span>
	<span class="n">ata_reset_fn_t</span> <span class="n">reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sstatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_unknown</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Prepare to reset</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ata_eh_reset_timeouts</span><span class="p">[</span><span class="n">max_tries</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ULONG_MAX</span><span class="p">)</span>
		<span class="n">max_tries</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_NO_HRST</span><span class="p">)</span>
		<span class="n">hardreset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_NO_SRST</span><span class="p">)</span>
		<span class="n">softreset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* make sure each reset attempt is at least COOL_DOWN apart */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_DID_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">last_reset</span><span class="p">,</span> <span class="n">now</span><span class="p">));</span>
		<span class="n">deadline</span> <span class="o">=</span> <span class="n">ata_deadline</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">last_reset</span><span class="p">,</span>
					<span class="n">ATA_EH_RESET_COOL_DOWN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">deadline</span> <span class="o">-</span> <span class="n">now</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_RESETTING</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ata_eh_about_to_do</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_RESET</span><span class="p">);</span>

	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we issue an SRST then an ATA drive (not ATAPI)</span>
<span class="cm">		 * may change configuration and be in PIO0 timing. If</span>
<span class="cm">		 * we do a hard reset (or are coming from power on)</span>
<span class="cm">		 * this is true for ATA or ATAPI. Until we&#39;ve set a</span>
<span class="cm">		 * suitable controller mode we should not touch the</span>
<span class="cm">		 * bus as we may be talking too fast.</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>

		<span class="cm">/* If the controller has a pio mode setup function</span>
<span class="cm">		 * then use it to set the chipset to rights. Don&#39;t</span>
<span class="cm">		 * touch the DMA setup as that will be dealt with when</span>
<span class="cm">		 * configuring devices.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_piomode</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_piomode</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* prefer hardreset */</span>
	<span class="n">reset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hardreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="n">hardreset</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_HARDRESET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">softreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="n">softreset</span><span class="p">;</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_SOFTRESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prereset</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span> <span class="o">=</span> <span class="n">ata_deadline</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
						      <span class="n">ATA_EH_PRERESET_TIMEOUT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EH_RESET</span><span class="p">;</span>
			<span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">prereset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>

		<span class="cm">/* If present, do prereset on slave link too.  Reset</span>
<span class="cm">		 * is skipped iff both master and slave links report</span>
<span class="cm">		 * -ENOENT or clear ATA_EH_RESET.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">prereset</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_link_dbg</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;port disabled--ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EH_RESET</span><span class="p">;</span>

				<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
					<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>

				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
					     <span class="s">&quot;prereset failed (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* prereset() might have cleared ATA_EH_RESET.  If so,</span>
<span class="cm">		 * bang classes, thaw and return.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_RESET</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
				<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
				<span class="n">ata_eh_thaw_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">retry:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Perform reset</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="n">ata_eh_freeze_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">deadline</span> <span class="o">=</span> <span class="n">ata_deadline</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">ata_eh_reset_timeouts</span><span class="p">[</span><span class="n">try</span><span class="o">++</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
			<span class="n">ata_link_info</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;%s resetting link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">reset</span> <span class="o">==</span> <span class="n">softreset</span> <span class="o">?</span> <span class="s">&quot;soft&quot;</span> <span class="o">:</span> <span class="s">&quot;hard&quot;</span><span class="p">);</span>

		<span class="cm">/* mark that this EH session started with reset */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">==</span> <span class="n">hardreset</span><span class="p">)</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_EHI_DID_HARDRESET</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_EHI_DID_SOFTRESET</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_do_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">failed_link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* hardreset slave link if existent */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="n">reset</span> <span class="o">==</span> <span class="n">hardreset</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
				<span class="n">ata_link_info</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="s">&quot;hard resetting link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">ata_eh_about_to_do</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_RESET</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">ata_do_reset</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span>
					   <span class="nb">false</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EAGAIN</span>:
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">failed_link</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* perform follow-up SRST if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset</span> <span class="o">==</span> <span class="n">hardreset</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ata_eh_followup_srst_needed</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">rc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reset</span> <span class="o">=</span> <span class="n">softreset</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
	     <span class="s">&quot;follow-up softreset required but no softreset available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">failed_link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ata_eh_about_to_do</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_RESET</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_do_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">failed_link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
			<span class="n">ata_link_info</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
	<span class="s">&quot;no reset method available, skipping reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_ASSUME_CLASS</span><span class="p">))</span>
			<span class="n">lflags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Post-reset processing</span>
<span class="cm">	 */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* After the reset, the device state is PIO 0 and the</span>
<span class="cm">		 * controller state is undefined.  Reset also wakes up</span>
<span class="cm">		 * drives from sleeping mode.</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">=</span> <span class="n">XFER_PIO_0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_DFLAG_SLEEPING</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ata_phys_link_offline</span><span class="p">(</span><span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* apply class override */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_ASSUME_ATA</span><span class="p">)</span>
			<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_ATA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lflags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_ASSUME_SEMB</span><span class="p">)</span>
			<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_SEMB_UNSUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* record current link speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sata_scr_read</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sstatus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">sata_spd</span> <span class="o">=</span> <span class="p">(</span><span class="n">sstatus</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slave</span> <span class="o">&amp;&amp;</span> <span class="n">sata_scr_read</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">SCR_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sstatus</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">slave</span><span class="o">-&gt;</span><span class="n">sata_spd</span> <span class="o">=</span> <span class="p">(</span><span class="n">sstatus</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="cm">/* thaw the port */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="n">ata_eh_thaw_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* postreset() should clear hardware SError.  Although SError</span>
<span class="cm">	 * is cleared during link resume, clearing SError here is</span>
<span class="cm">	 * necessary as some PHYs raise hotplug events after SRST.</span>
<span class="cm">	 * This introduces race condition where hotplug occurs between</span>
<span class="cm">	 * reset and here.  This race is mediated by cross checking</span>
<span class="cm">	 * link onlineness and classification result later.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">postreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">postreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">classes</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span>
			<span class="n">postreset</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">classes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some controllers can&#39;t be frozen very well and may set spurious</span>
<span class="cm">	 * error conditions during reset.  Clear accumulated error</span>
<span class="cm">	 * information and re-thaw the port if frozen.  As reset is the</span>
<span class="cm">	 * final recovery action and we cross check link onlineness against</span>
<span class="cm">	 * device classification later, no hotplug event is lost by this.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">));</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_EH_PENDING</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span>
		<span class="n">ata_eh_thaw_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure onlineness and classification result correspond.</span>
<span class="cm">	 * Hotplug could have happened during reset and some</span>
<span class="cm">	 * controllers fail to wait while a drive is spinning up after</span>
<span class="cm">	 * being hotplugged causing misdetection.  By cross checking</span>
<span class="cm">	 * link on/offlineness and classification result, those</span>
<span class="cm">	 * conditions can be reliably detected and retried.</span>
<span class="cm">	 */</span>
	<span class="n">nr_unknown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_phys_link_online</span><span class="p">(</span><span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">==</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;link online but device misclassified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
				<span class="n">nr_unknown</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ata_phys_link_offline</span><span class="p">(</span><span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ata_class_enabled</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]))</span>
				<span class="n">ata_dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;link offline, clearing class %d to NONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]);</span>
			<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">==</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;link status unknown, clearing UNKNOWN to NONE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">classify</span> <span class="o">&amp;&amp;</span> <span class="n">nr_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try</span> <span class="o">&lt;</span> <span class="n">max_tries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
				      <span class="s">&quot;link online but %d devices misclassified, retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">nr_unknown</span><span class="p">);</span>
			<span class="n">failed_link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
			      <span class="s">&quot;link online but %d devices misclassified, &quot;</span>
			      <span class="s">&quot;device detection might fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr_unknown</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* reset successful, schedule revalidation */</span>
	<span class="n">ata_eh_done</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span>
		<span class="n">ata_eh_done</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_RESET</span><span class="p">);</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">last_reset</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>		<span class="cm">/* update to completion time */</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">=</span> <span class="n">ATA_LPM_UNKNOWN</span><span class="p">;</span>	<span class="cm">/* reset LPM state */</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="cm">/* clear hotplug flag */</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EHI_HOTPLUGGED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span>
		<span class="n">sehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EHI_HOTPLUGGED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_RESETTING</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="cm">/* if SCR isn&#39;t accessible on a fan-out port, PMP needs to be reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sata_scr_read</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sstatus</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTART</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">try</span> <span class="o">&gt;=</span> <span class="n">max_tries</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Thaw host port even if reset failed, so that the port</span>
<span class="cm">		 * can be retried on the next phy event.  This risks</span>
<span class="cm">		 * repeated EH runs but seems to be a better tradeoff than</span>
<span class="cm">		 * shutting down a port after a botched hotplug attempt.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
			<span class="n">ata_eh_thaw_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">deadline</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">deadline</span> <span class="o">-</span> <span class="n">now</span><span class="p">;</span>

		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">failed_link</span><span class="p">,</span>
			<span class="s">&quot;reset failed (errno=%d), retrying in %u secs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rc</span><span class="p">,</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="mi">1000</span><span class="p">));</span>

		<span class="n">ata_eh_release</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">delta</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
		<span class="n">ata_eh_acquire</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * While disks spinup behind PMP, some controllers fail sending SRST.</span>
<span class="cm">	 * They need to be reset - as well as the PMP - before retrying.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ERESTART</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
			<span class="n">ata_eh_thaw_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">try</span> <span class="o">==</span> <span class="n">max_tries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sata_down_spd_limit</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span>
			<span class="n">sata_down_spd_limit</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">)</span>
		<span class="n">sata_down_spd_limit</span><span class="p">(</span><span class="n">failed_link</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hardreset</span><span class="p">)</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="n">hardreset</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ata_eh_pull_park_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This function can be thought of as an extended version of</span>
<span class="cm">	 * ata_eh_about_to_do() specially crafted to accommodate the</span>
<span class="cm">	 * requirements of ATA_EH_PARK handling. Since the EH thread</span>
<span class="cm">	 * does not leave the do {} while () loop in ata_eh_recover as</span>
<span class="cm">	 * long as the timeout for a park request to *one* device on</span>
<span class="cm">	 * the port has not expired, and since we still want to pick</span>
<span class="cm">	 * up park requests to other devices on the same port or</span>
<span class="cm">	 * timeout updates for the same device, we have to pull</span>
<span class="cm">	 * ATA_EH_PARK actions from eh_info into eh_context.i</span>
<span class="cm">	 * ourselves at the beginning of each pass over the loop.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Additionally, all write accesses to &amp;ap-&gt;park_req_pending</span>
<span class="cm">	 * through INIT_COMPLETION() (see below) or complete_all()</span>
<span class="cm">	 * (see ata_scsi_park_store()) are protected by the host lock.</span>
<span class="cm">	 * As a result we have that park_req_pending.done is zero on</span>
<span class="cm">	 * exit from this function, i.e. when ATA_EH_PARK actions for</span>
<span class="cm">	 * *all* devices on port ap have been pulled into the</span>
<span class="cm">	 * respective eh_context structs. If, and only if,</span>
<span class="cm">	 * park_req_pending.done is non-zero by the time we reach</span>
<span class="cm">	 * wait_for_completion_timeout(), another ATA_EH_PARK action</span>
<span class="cm">	 * has been scheduled for at least one of the devices on port</span>
<span class="cm">	 * ap and we have to cycle over the do {} while () loop in</span>
<span class="cm">	 * ata_eh_recover() again.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">park_req_pending</span><span class="p">);</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">;</span>

			<span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">|=</span>
				<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">dev_action</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ATA_EH_PARK</span><span class="p">;</span>
			<span class="n">ata_eh_clear_action</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ehi</span><span class="p">,</span> <span class="n">ATA_EH_PARK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_park_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">park</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">park</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">unloaded_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_IDLEIMMEDIATE</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">feature</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">lbal</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">lbam</span> <span class="o">=</span> <span class="mh">0x4e</span><span class="p">;</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">lbah</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">unloaded_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>
		<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">ATA_CMD_CHK_POWER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_TFLAG_DEVICE</span> <span class="o">|</span> <span class="n">ATA_TFLAG_ISADDR</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">|=</span> <span class="n">ATA_PROT_NODATA</span><span class="p">;</span>
	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_exec_internal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">park</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">||</span> <span class="n">tf</span><span class="p">.</span><span class="n">lbal</span> <span class="o">!=</span> <span class="mh">0xc4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;head unload failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">unloaded_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_revalidate_and_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">**</span><span class="n">r_failed_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* For PATA drive side cable detection to work, IDENTIFY must</span>
<span class="cm">	 * be done backwards such that PDIAG- is released by the slave</span>
<span class="cm">	 * device before the master device is identified.</span>
<span class="cm">	 */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL_REVERSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">action</span> <span class="o">=</span> <span class="n">ata_eh_dev_action</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">readid_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_DID_RESET</span><span class="p">)</span>
			<span class="n">readid_flags</span> <span class="o">|=</span> <span class="n">ATA_READID_POSTRESET</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_PMP</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ata_phys_link_offline</span><span class="p">(</span><span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ata_eh_about_to_do</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_dev_revalidate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">],</span>
						<span class="n">readid_flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">ata_eh_done</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ATA_EH_REVALIDATE</span><span class="p">);</span>

			<span class="cm">/* Configuration may have changed, reconfigure</span>
<span class="cm">			 * transfer mode.</span>
<span class="cm">			 */</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_EHI_SETMODE</span><span class="p">;</span>

			<span class="cm">/* schedule the scsi_rescan_device() here */</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">scsi_rescan_task</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_UNKNOWN</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			   <span class="n">ata_class_enabled</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]))</span> <span class="p">{</span>
			<span class="cm">/* Temporarily set dev-&gt;class, it will be</span>
<span class="cm">			 * permanently set once all configurations are</span>
<span class="cm">			 * complete.  This is necessary because new</span>
<span class="cm">			 * device configuration is done in two</span>
<span class="cm">			 * separate loops.</span>
<span class="cm">			 */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_PMP</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_dev_read_id</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">,</span>
						     <span class="n">readid_flags</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

			<span class="cm">/* read_id might have changed class, store and reset */</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="cm">/* clear error info accumulated during probe */</span>
				<span class="n">ata_ering_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">);</span>
				<span class="n">new_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
				<span class="cm">/* IDENTIFY was issued to non-existent</span>
<span class="cm">				 * device.  No need to reset.  Just</span>
<span class="cm">				 * thaw and ignore the device.</span>
<span class="cm">				 */</span>
				<span class="n">ata_eh_thaw_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* PDIAG- should have been released, ask cable type if post-reset */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_DID_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cable_detect</span><span class="p">)</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">cbl</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">cable_detect</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">ata_force_cbl</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Configure new devices forward such that user doesn&#39;t see</span>
<span class="cm">	 * device detection messages backwards.</span>
<span class="cm">	 */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_PMP</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_EHI_PRINTINFO</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_dev_configure</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EHI_PRINTINFO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_SCSI_HOTPLUG</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* new device discovered, configure xfermode */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_EHI_SETMODE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="o">*</span><span class="n">r_failed_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_set_mode - Program timings and issue SET FEATURES - XFER</span>
<span class="cm"> *	@link: link on which timings will be programmed</span>
<span class="cm"> *	@r_failed_dev: out parameter for failed device</span>
<span class="cm"> *</span>
<span class="cm"> *	Set ATA device disk transfer mode (PIO3, UDMA6, etc.).  If</span>
<span class="cm"> *	ata_set_mode() fails, pointer to the failing device is</span>
<span class="cm"> *	returned in @r_failed_dev.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	PCI/etc. bus probe sem.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, negative errno otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ata_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">**</span><span class="n">r_failed_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* if data transfer is verified, clear DUBIOUS_XFER on ering top */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_DUBIOUS_XFER</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

			<span class="n">ent</span> <span class="o">=</span> <span class="n">ata_ering_top</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ent</span><span class="p">)</span>
				<span class="n">ent</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EFLAG_DUBIOUS_XFER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* has private set_mode? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_mode</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">r_failed_dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_do_set_mode</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">r_failed_dev</span><span class="p">);</span>

	<span class="cm">/* if transfer mode has changed, set DUBIOUS_XFER on device */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">saved_xfer_mode</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_xfer_mode</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">saved_ncq</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_ncq_enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">xfer_mode</span> <span class="o">!=</span> <span class="n">saved_xfer_mode</span> <span class="o">||</span>
		    <span class="n">ata_ncq_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">saved_ncq</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_DFLAG_DUBIOUS_XFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	atapi_eh_clear_ua - Clear ATAPI UNIT ATTENTION after reset</span>
<span class="cm"> *	@dev: ATAPI device to clear UA for</span>
<span class="cm"> *</span>
<span class="cm"> *	Resets and other operations can make an ATAPI device raise</span>
<span class="cm"> *	UNIT ATTENTION which causes the next operation to fail.  This</span>
<span class="cm"> *	function clears UA.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atapi_eh_clear_ua</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATA_EH_UA_TRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">sense_buffer</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sector_buf</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">sense_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">atapi_eh_tur</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sense_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">err_mask</span> <span class="o">!=</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="s">&quot;TEST_UNIT_READY failed (err_mask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">err_mask</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_mask</span> <span class="o">||</span> <span class="n">sense_key</span> <span class="o">!=</span> <span class="n">UNIT_ATTENTION</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">err_mask</span> <span class="o">=</span> <span class="n">atapi_eh_request_sense</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sense_buffer</span><span class="p">,</span> <span class="n">sense_key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to clear &quot;</span>
				<span class="s">&quot;UNIT ATTENTION (err_mask=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_mask</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;UNIT ATTENTION persists after %d tries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ATA_EH_UA_TRIES</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_maybe_retry_flush - Retry FLUSH if necessary</span>
<span class="cm"> *	@dev: ATA device which may need FLUSH retry</span>
<span class="cm"> *</span>
<span class="cm"> *	If @dev failed FLUSH, it needs to be reported upper layer</span>
<span class="cm"> *	immediately as it means that @dev failed to remap and already</span>
<span class="cm"> *	lost at least a sector and further FLUSH retrials won&#39;t make</span>
<span class="cm"> *	any difference to the lost sector.  However, if FLUSH failed</span>
<span class="cm"> *	for other reasons, for example transmission error, FLUSH needs</span>
<span class="cm"> *	to be retried.</span>
<span class="cm"> *</span>
<span class="cm"> *	This function determines whether FLUSH failure retry is</span>
<span class="cm"> *	necessary and performs it if so.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 if EH can continue, -errno if EH needs to be repeated.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_maybe_retry_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* did flush fail for this device? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_tag_valid</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">active_tag</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">active_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span> <span class="o">||</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">ATA_CMD_FLUSH_EXT</span> <span class="o">&amp;&amp;</span>
			       <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">ATA_CMD_FLUSH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if the device failed it, it should be reported to upper layers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* flush failed for some other reason, give it another shot */</span>
	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>

	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">command</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ATA_PROT_NODATA</span><span class="p">;</span>

	<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;retrying FLUSH 0x%x Emask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tf</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">);</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_exec_internal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">DMA_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FLUSH is complete but there&#39;s no way to</span>
<span class="cm">		 * successfully complete a failed command from EH.</span>
<span class="cm">		 * Making sure retry is allowed at least once and</span>
<span class="cm">		 * retrying it should do the trick - whatever was in</span>
<span class="cm">		 * the cache is already on the platter and this won&#39;t</span>
<span class="cm">		 * cause infinite loop.</span>
<span class="cm">		 */</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">allowed</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">scsicmd</span><span class="o">-&gt;</span><span class="n">allowed</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FLUSH failed Emask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">err_mask</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="cm">/* if device failed it, report it to upper layers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>
			<span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_set_lpm - configure SATA interface power management</span>
<span class="cm"> *	@link: link to configure power management</span>
<span class="cm"> *	@policy: the link power management policy</span>
<span class="cm"> *	@r_failed_dev: out parameter for failed device</span>
<span class="cm"> *</span>
<span class="cm"> *	Enable SATA Interface power management.  This will enable</span>
<span class="cm"> *	Device Interface Power Management (DIPM) for min_power</span>
<span class="cm"> * 	policy, and then call driver specific callbacks for</span>
<span class="cm"> *	enabling Host Initiated Power management.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	EH context.</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_set_lpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ata_lpm_policy</span> <span class="n">policy</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">**</span><span class="n">r_failed_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">)</span> <span class="o">?</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">link_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">lpm_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ata_lpm_policy</span> <span class="n">old_policy</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">no_dipm</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_NO_DIPM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hints</span> <span class="o">=</span> <span class="n">ATA_LPM_EMPTY</span> <span class="o">|</span> <span class="n">ATA_LPM_HIPM</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* if the link or host doesn&#39;t do LPM, noop */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_NO_LPM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_lpm</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * DIPM is enabled only for MIN_POWER as some devices</span>
<span class="cm">	 * misbehave when the host NACKs transition to SLUMBER.  Order</span>
<span class="cm">	 * device and link configurations such that the host always</span>
<span class="cm">	 * allows DIPM requests.</span>
<span class="cm">	 */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">hipm</span> <span class="o">=</span> <span class="n">ata_id_has_hipm</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">bool</span> <span class="n">dipm</span> <span class="o">=</span> <span class="n">ata_id_has_dipm</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">no_dipm</span><span class="p">;</span>

		<span class="cm">/* find the first enabled and LPM enabled devices */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_dev</span><span class="p">)</span>
			<span class="n">link_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lpm_dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hipm</span> <span class="o">||</span> <span class="n">dipm</span><span class="p">))</span>
			<span class="n">lpm_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="n">hints</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_LPM_EMPTY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hipm</span><span class="p">)</span>
			<span class="n">hints</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_LPM_HIPM</span><span class="p">;</span>

		<span class="cm">/* disable DIPM before changing link config */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">policy</span> <span class="o">!=</span> <span class="n">ATA_LPM_MIN_POWER</span> <span class="o">&amp;&amp;</span> <span class="n">dipm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_dev_set_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">SETFEATURES_SATA_DISABLE</span><span class="p">,</span> <span class="n">SATA_DIPM</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;&amp;</span> <span class="n">err_mask</span> <span class="o">!=</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;failed to disable DIPM, Emask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">err_mask</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">hints</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_lpm</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">hints</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_pmp_set_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">hints</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Attribute link config failure to the first (LPM) enabled</span>
<span class="cm">	 * device on the link.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_LPM</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">lpm_dev</span> <span class="o">?</span> <span class="n">lpm_dev</span> <span class="o">:</span> <span class="n">link_dev</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Low level driver acked the transition.  Issue DIPM command</span>
<span class="cm">	 * with the new policy set.</span>
<span class="cm">	 */</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">=</span> <span class="n">policy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">=</span> <span class="n">policy</span><span class="p">;</span>

	<span class="cm">/* host config updated, enable DIPM if transitioning to MIN_POWER */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">policy</span> <span class="o">==</span> <span class="n">ATA_LPM_MIN_POWER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">no_dipm</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ata_id_has_dipm</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err_mask</span> <span class="o">=</span> <span class="n">ata_dev_set_feature</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">SETFEATURES_SATA_ENABLE</span><span class="p">,</span> <span class="n">SATA_DIPM</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_mask</span> <span class="o">&amp;&amp;</span> <span class="n">err_mask</span> <span class="o">!=</span> <span class="n">AC_ERR_DEV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;failed to enable DIPM, Emask 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">err_mask</span><span class="p">);</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="cm">/* restore the old policy */</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">=</span> <span class="n">old_policy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">slave_link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">=</span> <span class="n">old_policy</span><span class="p">;</span>

	<span class="cm">/* if no device or only one more chance is left, disable LPM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;disabling LPM on the link</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_NO_LPM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_failed_dev</span><span class="p">)</span>
		<span class="o">*</span><span class="n">r_failed_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ata_link_nr_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ENABLED</span><span class="p">)</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_link_nr_vacant</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">)</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_skip_recovery</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* skip disabled links */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_DISABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* skip if explicitly requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_NO_RECOVERY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* thaw frozen port and recover failed devices */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span> <span class="o">||</span> <span class="n">ata_link_nr_enabled</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* reset at least once if reset is requested */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_DID_RESET</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* skip if class codes for all vacant slots are ATA_DEV_NONE */</span>
	<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_UNKNOWN</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ATA_DEV_NONE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_count_probe_trials_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_ering_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">void_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATA_EH_PROBE_TRIAL_INTERVAL</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">now</span> <span class="o">=</span> <span class="n">get_jiffies_64</span><span class="p">();</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">trials</span> <span class="o">=</span> <span class="n">void_arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">eflags</span> <span class="o">&amp;</span> <span class="n">ATA_EFLAG_OLD_ER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">&lt;</span> <span class="n">now</span> <span class="o">-</span> <span class="n">min</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">interval</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="p">(</span><span class="o">*</span><span class="n">trials</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_schedule_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">trials</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">probe_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">did_probe_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ata_eh_detach_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ata_dev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">did_probe_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_xfer_mode</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">saved_ncq_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>

	<span class="cm">/* the link maybe in a deep sleep, wake it up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">&gt;</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">,</span>
					       <span class="n">ATA_LPM_EMPTY</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sata_pmp_set_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">,</span>
					 <span class="n">ATA_LPM_EMPTY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Record and count probe trials on the ering.  The specific</span>
<span class="cm">	 * error mask used is irrelevant.  Because a successful device</span>
<span class="cm">	 * detection clears the ering, this count accumulates only if</span>
<span class="cm">	 * there are consecutive failed probes.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the count is equal to or higher than ATA_EH_PROBE_TRIALS</span>
<span class="cm">	 * in the last ATA_EH_PROBE_TRIAL_INTERVAL, link speed is</span>
<span class="cm">	 * forced to 1.5Gbps.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This is to work around cases where failed link speed</span>
<span class="cm">	 * negotiation results in device misdetection leading to</span>
<span class="cm">	 * infinite DEVXCHG or PHRDY CHG events.</span>
<span class="cm">	 */</span>
	<span class="n">ata_ering_record</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC_ERR_OTHER</span><span class="p">);</span>
	<span class="n">ata_ering_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">,</span> <span class="n">ata_count_probe_trials_cb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trials</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trials</span> <span class="o">&gt;</span> <span class="n">ATA_EH_PROBE_TRIALS</span><span class="p">)</span>
		<span class="n">sata_down_spd_limit</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ata_eh_handle_dev_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

	<span class="cm">/* -EAGAIN from EH routine indicates retry without prejudice.</span>
<span class="cm">	 * The requester is responsible for ensuring forward progress.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
		<span class="cm">/* device missing or wrong IDENTIFY data, schedule probing */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">probe_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">);</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
		<span class="cm">/* give it just one more chance */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is the last chance, better to slow</span>
<span class="cm">			 * down than lose it.</span>
<span class="cm">			 */</span>
			<span class="n">sata_down_spd_limit</span><span class="p">(</span><span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pio_mode</span> <span class="o">&gt;</span> <span class="n">XFER_PIO_0</span><span class="p">)</span>
				<span class="n">ata_down_xfermask_limit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ATA_DNXFER_PIO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* disable device if it has used up all its chances */</span>
		<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* detach if offline */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_phys_link_offline</span><span class="p">(</span><span class="n">ata_dev_phys_link</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
			<span class="n">ata_eh_detach_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* schedule probe if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_eh_schedule_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_EH_DEV_TRIES</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">cmd_timeout_idx</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">cmd_timeout_idx</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]));</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_recover - recover host port after error</span>
<span class="cm"> *	@ap: host port to recover</span>
<span class="cm"> *	@prereset: prereset method (can be NULL)</span>
<span class="cm"> *	@softreset: softreset method (can be NULL)</span>
<span class="cm"> *	@hardreset: hardreset method (can be NULL)</span>
<span class="cm"> *	@postreset: postreset method (can be NULL)</span>
<span class="cm"> *	@r_failed_link: out parameter for failed link</span>
<span class="cm"> *</span>
<span class="cm"> *	This is the alpha and omega, eum and yang, heart and soul of</span>
<span class="cm"> *	libata exception handling.  On entry, actions required to</span>
<span class="cm"> *	recover each link and hotplug requests are recorded in the</span>
<span class="cm"> *	link&#39;s eh_context.  This function executes all the operations</span>
<span class="cm"> *	with appropriate retrials and fallbacks to resurrect failed</span>
<span class="cm"> *	devices, detach goners and greet newcomers.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> *</span>
<span class="cm"> *	RETURNS:</span>
<span class="cm"> *	0 on success, -errno on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ata_eh_recover</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">ata_prereset_fn_t</span> <span class="n">prereset</span><span class="p">,</span>
		   <span class="n">ata_reset_fn_t</span> <span class="n">softreset</span><span class="p">,</span> <span class="n">ata_reset_fn_t</span> <span class="n">hardreset</span><span class="p">,</span>
		   <span class="n">ata_postreset_fn_t</span> <span class="n">postreset</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ata_link</span> <span class="o">**</span><span class="n">r_failed_link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">nr_fails</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">deadline</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* prep for recovery */</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

		<span class="cm">/* re-enable link? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_ENABLE_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_eh_about_to_do</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_ENABLE_LINK</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_LFLAG_DISABLED</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">ata_eh_done</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ATA_EH_ENABLE_LINK</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_NO_RETRY</span><span class="p">)</span>
				<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_EH_DEV_TRIES</span><span class="p">;</span>

			<span class="cm">/* collect port action mask recorded in dev actions */</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&amp;</span>
					 <span class="o">~</span><span class="n">ATA_EH_PERDEV_MASK</span><span class="p">;</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">ATA_EH_PERDEV_MASK</span><span class="p">;</span>

			<span class="cm">/* process hotplug request */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_DFLAG_DETACH</span><span class="p">)</span>
				<span class="n">ata_eh_detach_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="cm">/* schedule probe if necessary */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">ata_eh_schedule_probe</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">retry:</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if UNLOADING, finish immediately */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_UNLOADING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* prep for EH */</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

		<span class="cm">/* skip EH if possible. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_eh_skip_recovery</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">classes</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATA_DEV_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset */</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">&amp;</span> <span class="n">ATA_EH_RESET</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ata_link_nr_vacant</span><span class="p">(</span><span class="n">link</span><span class="p">),</span>
				  <span class="n">prereset</span><span class="p">,</span> <span class="n">softreset</span><span class="p">,</span> <span class="n">hardreset</span><span class="p">,</span> <span class="n">postreset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;reset failed, giving up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * clears ATA_EH_PARK in eh_info and resets</span>
<span class="cm">		 * ap-&gt;park_req_pending</span>
<span class="cm">		 */</span>
		<span class="n">ata_eh_pull_park_action</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="n">deadline</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">ATA_DEV_ATA</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">dev_action</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">]</span> <span class="o">&amp;</span>
				      <span class="n">ATA_EH_PARK</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">unpark_deadline</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="n">tmp</span><span class="p">))</span>
					<span class="n">deadline</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">unloaded_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">ata_eh_park_issue_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="n">now</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ata_eh_release</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">deadline</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">park_req_pending</span><span class="p">,</span>
						       <span class="n">deadline</span> <span class="o">-</span> <span class="n">now</span><span class="p">);</span>
		<span class="n">ata_eh_acquire</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">deadline</span><span class="p">);</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">.</span><span class="n">unloaded_mask</span> <span class="o">&amp;</span>
			      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devno</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ata_eh_park_issue_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ata_eh_done</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ATA_EH_PARK</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* the rest */</span>
	<span class="n">nr_fails</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">PMP_FIRST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ata_is_host_link</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">config_lpm</span><span class="p">;</span>

		<span class="cm">/* revalidate existing devices and attach new ones */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_revalidate_and_attach</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rest_fail</span><span class="p">;</span>

		<span class="cm">/* if PMP got attached, return, pmp EH will take care of it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_PMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* configure transfer mode if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_SETMODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_set_mode</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">rest_fail</span><span class="p">;</span>
			<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_EHI_SETMODE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If reset has been issued, clear UA to avoid</span>
<span class="cm">		 * disrupting the current users of the device.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_DID_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">atapi_eh_clear_ua</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">rest_fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* retry flush if necessary */</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">!=</span> <span class="n">ATA_DEV_ATA</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_maybe_retry_flush</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">rest_fail</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">config_lpm:</span>
		<span class="cm">/* configure link power saving */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">lpm_policy</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">target_lpm_policy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_set_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">target_lpm_policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">rest_fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* this link is okay now */</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="nl">rest_fail:</span>
		<span class="n">nr_fails</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">ata_eh_handle_dev_fail</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* PMP reset requires working host port.</span>
<span class="cm">			 * Can&#39;t retry if it&#39;s frozen.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_fails</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">r_failed_link</span><span class="p">)</span>
		<span class="o">*</span><span class="n">r_failed_link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, rc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_finish - finish up EH</span>
<span class="cm"> *	@ap: host port to finish EH for</span>
<span class="cm"> *</span>
<span class="cm"> *	Recovery is complete.  Clean up EH states and retry or finish</span>
<span class="cm"> *	failed qcs.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_eh_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>

	<span class="cm">/* retry or finish qcs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tag</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">tag</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">__ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIXME: Once EH migration is complete,</span>
<span class="cm">			 * generate sense data in this function,</span>
<span class="cm">			 * considering both err_mask and tf.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_RETRY</span><span class="p">)</span>
				<span class="n">ata_eh_qc_retry</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ata_eh_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_SENSE_VALID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_eh_qc_complete</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* feed zero TF to sense generation */</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">));</span>
				<span class="n">ata_eh_qc_retry</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* make sure nr_active_links is zero after EH */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_active_links</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_active_links</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_do_eh - do standard error handling</span>
<span class="cm"> *	@ap: host port to handle error for</span>
<span class="cm"> *</span>
<span class="cm"> *	@prereset: prereset method (can be NULL)</span>
<span class="cm"> *	@softreset: softreset method (can be NULL)</span>
<span class="cm"> *	@hardreset: hardreset method (can be NULL)</span>
<span class="cm"> *	@postreset: postreset method (can be NULL)</span>
<span class="cm"> *</span>
<span class="cm"> *	Perform standard error handling sequence.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_do_eh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">ata_prereset_fn_t</span> <span class="n">prereset</span><span class="p">,</span>
	       <span class="n">ata_reset_fn_t</span> <span class="n">softreset</span><span class="p">,</span> <span class="n">ata_reset_fn_t</span> <span class="n">hardreset</span><span class="p">,</span>
	       <span class="n">ata_postreset_fn_t</span> <span class="n">postreset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ata_eh_autopsy</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ata_eh_report</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_eh_recover</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">prereset</span><span class="p">,</span> <span class="n">softreset</span><span class="p">,</span> <span class="n">hardreset</span><span class="p">,</span> <span class="n">postreset</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
			<span class="n">ata_dev_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ata_eh_finish</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_std_error_handler - standard error handler</span>
<span class="cm"> *	@ap: host port to handle error for</span>
<span class="cm"> *</span>
<span class="cm"> *	Standard error handler</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ata_std_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">ata_reset_fn_t</span> <span class="n">hardreset</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">hardreset</span><span class="p">;</span>

	<span class="cm">/* ignore built-in hardreset if SCR access is not available */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hardreset</span> <span class="o">==</span> <span class="n">sata_std_hardreset</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sata_scr_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">))</span>
		<span class="n">hardreset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ata_do_eh</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">prereset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">softreset</span><span class="p">,</span> <span class="n">hardreset</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">postreset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/**</span>
<span class="cm"> *	ata_eh_handle_port_suspend - perform port suspend operation</span>
<span class="cm"> *	@ap: port to suspend</span>
<span class="cm"> *</span>
<span class="cm"> *	Suspend @ap.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_handle_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* are we suspending? */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_PM_PENDING</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_SUSPENDED</span><span class="p">);</span>

	<span class="cm">/* tell ACPI we&#39;re suspending */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_acpi_on_suspend</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* suspend */</span>
	<span class="n">ata_eh_freeze_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">port_suspend</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">port_suspend</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_mesg</span><span class="p">);</span>

	<span class="n">ata_acpi_set_state</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">PMSG_SUSPEND</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="cm">/* report result */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_PFLAG_PM_PENDING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">|=</span> <span class="n">ATA_PFLAG_SUSPENDED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span>
		<span class="n">ata_port_schedule_eh</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ata_eh_handle_port_resume - perform port resume operation</span>
<span class="cm"> *	@ap: port to resume</span>
<span class="cm"> *</span>
<span class="cm"> *	Resume @ap.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	Kernel thread context (may sleep).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_eh_handle_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* are we resuming? */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_PM_PENDING</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_mesg</span><span class="p">.</span><span class="n">event</span> <span class="o">!=</span> <span class="n">PM_EVENT_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_SUSPENDED</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Error timestamps are in jiffies which doesn&#39;t run while</span>
<span class="cm">	 * suspended and PHY events during resume isn&#39;t too uncommon.</span>
<span class="cm">	 * When the two are combined, it can lead to unnecessary speed</span>
<span class="cm">	 * downs if the machine is suspended and resumed repeatedly.</span>
<span class="cm">	 * Clear error history.</span>
<span class="cm">	 */</span>
	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">HOST_FIRST</span><span class="p">)</span>
		<span class="n">ata_for_each_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
			<span class="n">ata_ering_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ering</span><span class="p">);</span>

	<span class="n">ata_acpi_set_state</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">PMSG_ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">port_resume</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">port_resume</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* tell ACPI that we&#39;re resuming */</span>
	<span class="n">ata_acpi_on_resume</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* report result */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ATA_PFLAG_PM_PENDING</span> <span class="o">|</span> <span class="n">ATA_PFLAG_SUSPENDED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_result</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_result</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pm_result</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
