<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › sata_nv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sata_nv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  sata_nv.c - NVIDIA nForce SATA</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2004 NVIDIA Corp.  All rights reserved.</span>
<span class="cm"> *  Copyright 2004 Andrew Chew</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  libata documentation is available via &#39;make {ps|pdf}docs&#39;,</span>
<span class="cm"> *  as Documentation/DocBook/libata.*</span>
<span class="cm"> *</span>
<span class="cm"> *  No hardware documentation available outside of NVIDIA.</span>
<span class="cm"> *  This driver programs the NVIDIA SATA controller in a similar</span>
<span class="cm"> *  fashion as with other PCI IDE BMDMA controllers, with a few</span>
<span class="cm"> *  NV-specific details such as register offsets, SATA phy location,</span>
<span class="cm"> *  hotplug info, etc.</span>
<span class="cm"> *</span>
<span class="cm"> *  CK804/MCP04 controllers support an alternate programming interface</span>
<span class="cm"> *  similar to the ADMA specification (with some modifications).</span>
<span class="cm"> *  This allows the use of NCQ. Non-DMA-mapped ATA commands are still</span>
<span class="cm"> *  sent through the legacy interface.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>

<span class="cp">#define DRV_NAME			&quot;sata_nv&quot;</span>
<span class="cp">#define DRV_VERSION			&quot;3.5&quot;</span>

<span class="cp">#define NV_ADMA_DMA_BOUNDARY		0xffffffffUL</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NV_MMIO_BAR</span>			<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>

	<span class="n">NV_PORTS</span>			<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">NV_PIO_MASK</span>			<span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">,</span>
	<span class="n">NV_MWDMA_MASK</span>			<span class="o">=</span> <span class="n">ATA_MWDMA2</span><span class="p">,</span>
	<span class="n">NV_UDMA_MASK</span>			<span class="o">=</span> <span class="n">ATA_UDMA6</span><span class="p">,</span>
	<span class="n">NV_PORT0_SCR_REG_OFFSET</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">NV_PORT1_SCR_REG_OFFSET</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>

	<span class="cm">/* INT_STATUS/ENABLE */</span>
	<span class="n">NV_INT_STATUS</span>			<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">NV_INT_ENABLE</span>			<span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="n">NV_INT_STATUS_CK804</span>		<span class="o">=</span> <span class="mh">0x440</span><span class="p">,</span>
	<span class="n">NV_INT_ENABLE_CK804</span>		<span class="o">=</span> <span class="mh">0x441</span><span class="p">,</span>

	<span class="cm">/* INT_STATUS/ENABLE bits */</span>
	<span class="n">NV_INT_DEV</span>			<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">NV_INT_PM</span>			<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">NV_INT_ADDED</span>			<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">NV_INT_REMOVED</span>			<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>

	<span class="n">NV_INT_PORT_SHIFT</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* each port occupies 4 bits */</span>

	<span class="n">NV_INT_ALL</span>			<span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="n">NV_INT_MASK</span>			<span class="o">=</span> <span class="n">NV_INT_DEV</span> <span class="o">|</span>
					  <span class="n">NV_INT_ADDED</span> <span class="o">|</span> <span class="n">NV_INT_REMOVED</span><span class="p">,</span>

	<span class="cm">/* INT_CONFIG */</span>
	<span class="n">NV_INT_CONFIG</span>			<span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="n">NV_INT_CONFIG_METHD</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span> <span class="c1">// 0 = INT, 1 = SMI</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>For PCI config register 20</p></td><td class="code"><div class="highlight"><pre>	<span class="n">NV_MCP_SATA_CFG_20</span>		<span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="n">NV_MCP_SATA_CFG_20_SATA_SPACE_EN</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">NV_MCP_SATA_CFG_20_PORT0_EN</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">),</span>
	<span class="n">NV_MCP_SATA_CFG_20_PORT1_EN</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">),</span>
	<span class="n">NV_MCP_SATA_CFG_20_PORT0_PWB_EN</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span>
	<span class="n">NV_MCP_SATA_CFG_20_PORT1_PWB_EN</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>

	<span class="n">NV_ADMA_MAX_CPBS</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
	<span class="n">NV_ADMA_CPB_SZ</span>			<span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
	<span class="n">NV_ADMA_APRD_SZ</span>			<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="n">NV_ADMA_SGTBL_LEN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">-</span> <span class="n">NV_ADMA_CPB_SZ</span><span class="p">)</span> <span class="o">/</span>
					   <span class="n">NV_ADMA_APRD_SZ</span><span class="p">,</span>
	<span class="n">NV_ADMA_SGTBL_TOTAL_LEN</span>		<span class="o">=</span> <span class="n">NV_ADMA_SGTBL_LEN</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">NV_ADMA_SGTBL_SZ</span>                <span class="o">=</span> <span class="n">NV_ADMA_SGTBL_LEN</span> <span class="o">*</span> <span class="n">NV_ADMA_APRD_SZ</span><span class="p">,</span>
	<span class="n">NV_ADMA_PORT_PRIV_DMA_SZ</span>        <span class="o">=</span> <span class="n">NV_ADMA_MAX_CPBS</span> <span class="o">*</span>
					   <span class="p">(</span><span class="n">NV_ADMA_CPB_SZ</span> <span class="o">+</span> <span class="n">NV_ADMA_SGTBL_SZ</span><span class="p">),</span>

	<span class="cm">/* BAR5 offset to ADMA general registers */</span>
	<span class="n">NV_ADMA_GEN</span>			<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
	<span class="n">NV_ADMA_GEN_CTL</span>			<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">NV_ADMA_NOTIFIER_CLEAR</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>

	<span class="cm">/* BAR5 offset to ADMA ports */</span>
	<span class="n">NV_ADMA_PORT</span>			<span class="o">=</span> <span class="mh">0x480</span><span class="p">,</span>

	<span class="cm">/* size of ADMA port register space  */</span>
	<span class="n">NV_ADMA_PORT_SIZE</span>		<span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>

	<span class="cm">/* ADMA port registers */</span>
	<span class="n">NV_ADMA_CTL</span>			<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">NV_ADMA_CPB_COUNT</span>		<span class="o">=</span> <span class="mh">0x42</span><span class="p">,</span>
	<span class="n">NV_ADMA_NEXT_CPB_IDX</span>		<span class="o">=</span> <span class="mh">0x43</span><span class="p">,</span>
	<span class="n">NV_ADMA_STAT</span>			<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>
	<span class="n">NV_ADMA_CPB_BASE_LOW</span>		<span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="n">NV_ADMA_CPB_BASE_HIGH</span>		<span class="o">=</span> <span class="mh">0x4C</span><span class="p">,</span>
	<span class="n">NV_ADMA_APPEND</span>			<span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="n">NV_ADMA_NOTIFIER</span>		<span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
	<span class="n">NV_ADMA_NOTIFIER_ERROR</span>		<span class="o">=</span> <span class="mh">0x6C</span><span class="p">,</span>

	<span class="cm">/* NV_ADMA_CTL register bits */</span>
	<span class="n">NV_ADMA_CTL_HOTPLUG_IEN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">NV_ADMA_CTL_CHANNEL_RESET</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">NV_ADMA_CTL_GO</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">NV_ADMA_CTL_AIEN</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">NV_ADMA_CTL_READ_NON_COHERENT</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span>
	<span class="n">NV_ADMA_CTL_WRITE_NON_COHERENT</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>

	<span class="cm">/* CPB response flag bits */</span>
	<span class="n">NV_CPB_RESP_DONE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">NV_CPB_RESP_ATA_ERR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">NV_CPB_RESP_CMD_ERR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">NV_CPB_RESP_CPB_ERR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>

	<span class="cm">/* CPB control flag bits */</span>
	<span class="n">NV_CPB_CTL_CPB_VALID</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">NV_CPB_CTL_QUEUE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">NV_CPB_CTL_APRD_VALID</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">NV_CPB_CTL_IEN</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">NV_CPB_CTL_FPDMA</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>

	<span class="cm">/* APRD flags */</span>
	<span class="n">NV_APRD_WRITE</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">NV_APRD_END</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">NV_APRD_CONT</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>

	<span class="cm">/* NV_ADMA_STAT flags */</span>
	<span class="n">NV_ADMA_STAT_TIMEOUT</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_HOTUNPLUG</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_HOTPLUG</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_CPBERR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_SERROR</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_CMD_COMPLETE</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_IDLE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_LEGACY</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_STOPPED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_DONE</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">),</span>
	<span class="n">NV_ADMA_STAT_ERR</span>		<span class="o">=</span> <span class="n">NV_ADMA_STAT_CPBERR</span> <span class="o">|</span>
					  <span class="n">NV_ADMA_STAT_TIMEOUT</span><span class="p">,</span>

	<span class="cm">/* port flags */</span>
	<span class="n">NV_ADMA_PORT_REGISTER_MODE</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>

	<span class="cm">/* MCP55 reg offset */</span>
	<span class="n">NV_CTL_MCP55</span>			<span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
	<span class="n">NV_INT_STATUS_MCP55</span>		<span class="o">=</span> <span class="mh">0x440</span><span class="p">,</span>
	<span class="n">NV_INT_ENABLE_MCP55</span>		<span class="o">=</span> <span class="mh">0x444</span><span class="p">,</span>
	<span class="n">NV_NCQ_REG_MCP55</span>		<span class="o">=</span> <span class="mh">0x448</span><span class="p">,</span>

	<span class="cm">/* MCP55 */</span>
	<span class="n">NV_INT_ALL_MCP55</span>		<span class="o">=</span> <span class="mh">0xffff</span><span class="p">,</span>
	<span class="n">NV_INT_PORT_SHIFT_MCP55</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>	<span class="cm">/* each port occupies 16 bits */</span>
	<span class="n">NV_INT_MASK_MCP55</span>		<span class="o">=</span> <span class="n">NV_INT_ALL_MCP55</span> <span class="o">&amp;</span> <span class="mh">0xfffd</span><span class="p">,</span>

	<span class="cm">/* SWNCQ ENABLE BITS*/</span>
	<span class="n">NV_CTL_PRI_SWNCQ</span>		<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">NV_CTL_SEC_SWNCQ</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>

	<span class="cm">/* SW NCQ status bits*/</span>
	<span class="n">NV_SWNCQ_IRQ_DEV</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">NV_SWNCQ_IRQ_PM</span>			<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">NV_SWNCQ_IRQ_ADDED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">NV_SWNCQ_IRQ_REMOVED</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>

	<span class="n">NV_SWNCQ_IRQ_BACKOUT</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">NV_SWNCQ_IRQ_SDBFIS</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">NV_SWNCQ_IRQ_DHREGFIS</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">NV_SWNCQ_IRQ_DMASETUP</span>		<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">),</span>

	<span class="n">NV_SWNCQ_IRQ_HOTPLUG</span>		<span class="o">=</span> <span class="n">NV_SWNCQ_IRQ_ADDED</span> <span class="o">|</span>
					  <span class="n">NV_SWNCQ_IRQ_REMOVED</span><span class="p">,</span>

<span class="p">};</span>

<span class="cm">/* ADMA Physical Region Descriptor - one SG segment */</span>
<span class="k">struct</span> <span class="n">nv_adma_prd</span> <span class="p">{</span>
	<span class="n">__le64</span>			<span class="n">addr</span><span class="p">;</span>
	<span class="n">__le32</span>			<span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">packet_len</span><span class="p">;</span>
	<span class="n">__le16</span>			<span class="n">reserved</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">nv_adma_regbits</span> <span class="p">{</span>
	<span class="n">CMDEND</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">),</span>		<span class="cm">/* end of command list */</span>
	<span class="n">WNB</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">),</span>		<span class="cm">/* wait-not-BSY */</span>
	<span class="n">IGN</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">),</span>		<span class="cm">/* ignore this entry */</span>
	<span class="n">CS1n</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)),</span>	<span class="cm">/* std. PATA signals follow... */</span>
	<span class="n">DA2</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)),</span>
	<span class="n">DA1</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)),</span>
	<span class="n">DA0</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)),</span>
<span class="p">};</span>

<span class="cm">/* ADMA Command Parameter Block</span>
<span class="cm">   The first 5 SG segments are stored inside the Command Parameter Block itself.</span>
<span class="cm">   If there are more than 5 segments the remainder are stored in a separate</span>
<span class="cm">   memory area indicated by next_aprd. */</span>
<span class="k">struct</span> <span class="n">nv_adma_cpb</span> <span class="p">{</span>
	<span class="n">u8</span>			<span class="n">resp_flags</span><span class="p">;</span>    <span class="cm">/* 0 */</span>
	<span class="n">u8</span>			<span class="n">reserved1</span><span class="p">;</span>     <span class="cm">/* 1 */</span>
	<span class="n">u8</span>			<span class="n">ctl_flags</span><span class="p">;</span>     <span class="cm">/* 2 */</span>
	<span class="cm">/* len is length of taskfile in 64 bit words */</span>
	<span class="n">u8</span>			<span class="n">len</span><span class="p">;</span>		<span class="cm">/* 3  */</span>
	<span class="n">u8</span>			<span class="n">tag</span><span class="p">;</span>           <span class="cm">/* 4 */</span>
	<span class="n">u8</span>			<span class="n">next_cpb_idx</span><span class="p">;</span>  <span class="cm">/* 5 */</span>
	<span class="n">__le16</span>			<span class="n">reserved2</span><span class="p">;</span>     <span class="cm">/* 6-7 */</span>
	<span class="n">__le16</span>			<span class="n">tf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>        <span class="cm">/* 8-31 */</span>
	<span class="k">struct</span> <span class="n">nv_adma_prd</span>	<span class="n">aprd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>       <span class="cm">/* 32-111 */</span>
	<span class="n">__le64</span>			<span class="n">next_aprd</span><span class="p">;</span>     <span class="cm">/* 112-119 */</span>
	<span class="n">__le64</span>			<span class="n">reserved3</span><span class="p">;</span>     <span class="cm">/* 120-127 */</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_cpb</span>	<span class="o">*</span><span class="n">cpb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">cpb_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_adma_prd</span>	<span class="o">*</span><span class="n">aprd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">aprd_dma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">gen_block</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">notifier_clear_block</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">adma_dma_mask</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">last_issue_ncq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nv_host_priv</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">defer_queue</span> <span class="p">{</span>
	<span class="n">u32</span>		<span class="n">defer_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tail</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tag</span><span class="p">[</span><span class="n">ATA_MAX_QUEUE</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ncq_saw_flag_list</span> <span class="p">{</span>
	<span class="n">ncq_saw_d2h</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">ncq_saw_dmas</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">ncq_saw_sdb</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">ncq_saw_backout</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_bmdma_prd</span> <span class="o">*</span><span class="n">prd</span><span class="p">;</span>	 <span class="cm">/* our SG list */</span>
	<span class="n">dma_addr_t</span>	<span class="n">prd_dma</span><span class="p">;</span> <span class="cm">/* and its DMA mapping */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">sactive_block</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">irq_block</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">tag_block</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">qc_active</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">last_issue_tag</span><span class="p">;</span>

	<span class="cm">/* fifo circular queue to store deferral command */</span>
	<span class="k">struct</span> <span class="n">defer_queue</span> <span class="n">defer_queue</span><span class="p">;</span>

	<span class="cm">/* for NCQ interrupt analysis */</span>
	<span class="n">u32</span>		<span class="n">dhfis_bits</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">dmafis_bits</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">sdbfis_bits</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ncq_flags</span><span class="p">;</span>
<span class="p">};</span>


<span class="cp">#define NV_ADMA_CHECK_INTR(GCTL, PORT) ((GCTL) &amp; (1 &lt;&lt; (19 + (12 * (PORT)))))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_pci_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_ck804_host_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">nv_generic_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">nv_nf2_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">nv_ck804_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_nf2_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_nf2_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_ck804_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_ck804_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_adma_slave_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_adma_check_atapi_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_qc_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nv_adma_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">nv_adma_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_irq_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_adma_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_port_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_adma_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_adma_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_host_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_post_internal_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_adma_tf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_mcp55_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_mcp55_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_swncq_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_swncq_slave_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_swncq_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_swncq_qc_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_swncq_fill_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nv_swncq_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">nv_swncq_irq_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">fis</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">nv_swncq_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_swncq_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nv_swncq_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">enum</span> <span class="n">nv_host_type</span>
<span class="p">{</span>
	<span class="n">GENERIC</span><span class="p">,</span>
	<span class="n">NFORCE2</span><span class="p">,</span>
	<span class="n">NFORCE3</span> <span class="o">=</span> <span class="n">NFORCE2</span><span class="p">,</span>	<span class="cm">/* NF2 == NF3 as far as sata_nv is concerned */</span>
	<span class="n">CK804</span><span class="p">,</span>
	<span class="n">ADMA</span><span class="p">,</span>
	<span class="n">MCP5x</span><span class="p">,</span>
	<span class="n">SWNCQ</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">nv_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE2S_SATA</span><span class="p">),</span> <span class="n">NFORCE2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE3S_SATA</span><span class="p">),</span> <span class="n">NFORCE3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE3S_SATA2</span><span class="p">),</span> <span class="n">NFORCE3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_SATA</span><span class="p">),</span> <span class="n">CK804</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_CK804_SATA2</span><span class="p">),</span> <span class="n">CK804</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SATA</span><span class="p">),</span> <span class="n">CK804</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP04_SATA2</span><span class="p">),</span> <span class="n">CK804</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA</span><span class="p">),</span> <span class="n">MCP5x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA2</span><span class="p">),</span> <span class="n">MCP5x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA</span><span class="p">),</span> <span class="n">MCP5x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA2</span><span class="p">),</span> <span class="n">MCP5x</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA</span><span class="p">),</span> <span class="n">GENERIC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA2</span><span class="p">),</span> <span class="n">GENERIC</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP61_SATA3</span><span class="p">),</span> <span class="n">GENERIC</span> <span class="p">},</span>

	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminate list */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">nv_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>		<span class="o">=</span> <span class="n">nv_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>			<span class="o">=</span> <span class="n">nv_init_one</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">ata_pci_device_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>			<span class="o">=</span> <span class="n">nv_pci_device_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">remove</span>			<span class="o">=</span> <span class="n">ata_pci_remove_one</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">nv_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_BMDMA_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">nv_adma_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_NCQ_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">NV_ADMA_MAX_CPBS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">NV_ADMA_SGTBL_TOTAL_LEN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_boundary</span>		<span class="o">=</span> <span class="n">NV_ADMA_DMA_BOUNDARY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">nv_adma_slave_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">nv_swncq_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_NCQ_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">can_queue</span>		<span class="o">=</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sg_tablesize</span>		<span class="o">=</span> <span class="n">LIBATA_MAX_PRD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_boundary</span>		<span class="o">=</span> <span class="n">ATA_DMA_BOUNDARY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span>	<span class="o">=</span> <span class="n">nv_swncq_slave_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * NV SATA controllers have various different problems with hardreset</span>
<span class="cm"> * protocol depending on the specific controller and device.</span>
<span class="cm"> *</span>
<span class="cm"> * GENERIC:</span>
<span class="cm"> *</span>
<span class="cm"> *  bko11195 reports that link doesn&#39;t come online after hardreset on</span>
<span class="cm"> *  generic nv&#39;s and there have been several other similar reports on</span>
<span class="cm"> *  linux-ide.</span>
<span class="cm"> *</span>
<span class="cm"> *  bko12351#c23 reports that warmplug on MCP61 doesn&#39;t work with</span>
<span class="cm"> *  softreset.</span>
<span class="cm"> *</span>
<span class="cm"> * NF2/3:</span>
<span class="cm"> *</span>
<span class="cm"> *  bko3352 reports nf2/3 controllers can&#39;t determine device signature</span>
<span class="cm"> *  reliably after hardreset.  The following thread reports detection</span>
<span class="cm"> *  failure on cold boot with the standard debouncing timing.</span>
<span class="cm"> *</span>
<span class="cm"> *  http://thread.gmane.org/gmane.linux.ide/34098</span>
<span class="cm"> *</span>
<span class="cm"> *  bko12176 reports that hardreset fails to bring up the link during</span>
<span class="cm"> *  boot on nf2.</span>
<span class="cm"> *</span>
<span class="cm"> * CK804:</span>
<span class="cm"> *</span>
<span class="cm"> *  For initial probing after boot and hot plugging, hardreset mostly</span>
<span class="cm"> *  works fine on CK804 but curiously, reprobing on the initial port</span>
<span class="cm"> *  by rescanning or rmmod/insmod fails to acquire the initial D2H Reg</span>
<span class="cm"> *  FIS in somewhat undeterministic way.</span>
<span class="cm"> *</span>
<span class="cm"> * SWNCQ:</span>
<span class="cm"> *</span>
<span class="cm"> *  bko12351 reports that when SWNCQ is enabled, for hotplug to work,</span>
<span class="cm"> *  hardreset should be used and hardreset can&#39;t report proper</span>
<span class="cm"> *  signature, which suggests that mcp5x is closer to nf2 as long as</span>
<span class="cm"> *  reset quirkiness is concerned.</span>
<span class="cm"> *</span>
<span class="cm"> *  bko12703 reports that boot probing fails for intel SSD with</span>
<span class="cm"> *  hardreset.  Link fails to come online.  Softreset works fine.</span>
<span class="cm"> *</span>
<span class="cm"> * The failures are varied but the following patterns seem true for</span>
<span class="cm"> * all flavors.</span>
<span class="cm"> *</span>
<span class="cm"> * - Softreset during boot always works.</span>
<span class="cm"> *</span>
<span class="cm"> * - Hardreset during boot sometimes fails to bring up the link on</span>
<span class="cm"> *   certain comibnations and device signature acquisition is</span>
<span class="cm"> *   unreliable.</span>
<span class="cm"> *</span>
<span class="cm"> * - Hardreset is often necessary after hotplug.</span>
<span class="cm"> *</span>
<span class="cm"> * So, preferring softreset for boot probing and error handling (as</span>
<span class="cm"> * hardreset might bring down the link) but using hardreset for</span>
<span class="cm"> * post-boot probing should work around the above issues in most</span>
<span class="cm"> * cases.  Define nv_hardreset() which only kicks in for post-boot</span>
<span class="cm"> * probing and use it for all variants.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv_generic_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_bmdma_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">lost_interrupt</span>		<span class="o">=</span> <span class="n">ATA_OP_NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scr_read</span>		<span class="o">=</span> <span class="n">nv_scr_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scr_write</span>		<span class="o">=</span> <span class="n">nv_scr_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardreset</span>		<span class="o">=</span> <span class="n">nv_hardreset</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv_nf2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_generic_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span>			<span class="o">=</span> <span class="n">nv_nf2_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>			<span class="o">=</span> <span class="n">nv_nf2_thaw</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv_ck804_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_generic_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span>			<span class="o">=</span> <span class="n">nv_ck804_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>			<span class="o">=</span> <span class="n">nv_ck804_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">host_stop</span>		<span class="o">=</span> <span class="n">nv_ck804_host_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv_adma_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_ck804_ops</span><span class="p">,</span>

	<span class="p">.</span><span class="n">check_atapi_dma</span>	<span class="o">=</span> <span class="n">nv_adma_check_atapi_dma</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_tf_read</span>		<span class="o">=</span> <span class="n">nv_adma_tf_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_defer</span>		<span class="o">=</span> <span class="n">ata_std_qc_defer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_prep</span>		<span class="o">=</span> <span class="n">nv_adma_qc_prep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_issue</span>		<span class="o">=</span> <span class="n">nv_adma_qc_issue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_irq_clear</span>		<span class="o">=</span> <span class="n">nv_adma_irq_clear</span><span class="p">,</span>

	<span class="p">.</span><span class="n">freeze</span>			<span class="o">=</span> <span class="n">nv_adma_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>			<span class="o">=</span> <span class="n">nv_adma_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>		<span class="o">=</span> <span class="n">nv_adma_error_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_internal_cmd</span>	<span class="o">=</span> <span class="n">nv_adma_post_internal_cmd</span><span class="p">,</span>

	<span class="p">.</span><span class="n">port_start</span>		<span class="o">=</span> <span class="n">nv_adma_port_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_stop</span>		<span class="o">=</span> <span class="n">nv_adma_port_stop</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">port_suspend</span>		<span class="o">=</span> <span class="n">nv_adma_port_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_resume</span>		<span class="o">=</span> <span class="n">nv_adma_port_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">host_stop</span>		<span class="o">=</span> <span class="n">nv_adma_host_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">nv_swncq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_generic_ops</span><span class="p">,</span>

	<span class="p">.</span><span class="n">qc_defer</span>		<span class="o">=</span> <span class="n">ata_std_qc_defer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_prep</span>		<span class="o">=</span> <span class="n">nv_swncq_qc_prep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_issue</span>		<span class="o">=</span> <span class="n">nv_swncq_qc_issue</span><span class="p">,</span>

	<span class="p">.</span><span class="n">freeze</span>			<span class="o">=</span> <span class="n">nv_mcp55_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>			<span class="o">=</span> <span class="n">nv_mcp55_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>		<span class="o">=</span> <span class="n">nv_swncq_error_handler</span><span class="p">,</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">port_suspend</span>		<span class="o">=</span> <span class="n">nv_swncq_port_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_resume</span>		<span class="o">=</span> <span class="n">nv_swncq_port_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">port_start</span>		<span class="o">=</span> <span class="n">nv_swncq_port_start</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nv_pi_priv</span> <span class="p">{</span>
	<span class="n">irq_handler_t</span>			<span class="n">irq_handler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_host_template</span>	<span class="o">*</span><span class="n">sht</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define NV_PI_PRIV(_irq_handler, _sht) \</span>
<span class="cp">	&amp;(struct nv_pi_priv){ .irq_handler = _irq_handler, .sht = _sht }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="n">nv_port_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* generic */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">NV_PIO_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">NV_MWDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">NV_UDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_generic_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_data</span>	<span class="o">=</span> <span class="n">NV_PI_PRIV</span><span class="p">(</span><span class="n">nv_generic_interrupt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_sht</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="cm">/* nforce2/3 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">NV_PIO_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">NV_MWDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">NV_UDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_nf2_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_data</span>	<span class="o">=</span> <span class="n">NV_PI_PRIV</span><span class="p">(</span><span class="n">nv_nf2_interrupt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_sht</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="cm">/* ck804 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">NV_PIO_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">NV_MWDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">NV_UDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_ck804_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_data</span>	<span class="o">=</span> <span class="n">NV_PI_PRIV</span><span class="p">(</span><span class="n">nv_ck804_interrupt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_sht</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="cm">/* ADMA */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span> <span class="o">|</span> <span class="n">ATA_FLAG_NCQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">NV_PIO_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">NV_MWDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">NV_UDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_adma_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_data</span>	<span class="o">=</span> <span class="n">NV_PI_PRIV</span><span class="p">(</span><span class="n">nv_adma_interrupt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_adma_sht</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="cm">/* MCP5x */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">ATA_FLAG_SATA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">NV_PIO_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">NV_MWDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">NV_UDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_generic_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_data</span>	<span class="o">=</span> <span class="n">NV_PI_PRIV</span><span class="p">(</span><span class="n">nv_generic_interrupt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_sht</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="cm">/* SWNCQ */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span>	        <span class="o">=</span> <span class="n">ATA_FLAG_SATA</span> <span class="o">|</span> <span class="n">ATA_FLAG_NCQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pio_mask</span>	<span class="o">=</span> <span class="n">NV_PIO_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">NV_MWDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">udma_mask</span>	<span class="o">=</span> <span class="n">NV_UDMA_MASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">port_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_swncq_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_data</span>	<span class="o">=</span> <span class="n">NV_PI_PRIV</span><span class="p">(</span><span class="n">nv_swncq_interrupt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nv_swncq_sht</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;NVIDIA&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;low-level driver for NVIDIA nForce SATA controller&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">nv_pci_tbl</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">adma_enabled</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">swncq_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">msi_enabled</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_register_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_IDLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">ata_port_warn</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;timeout waiting for ADMA IDLE, stat=0x%hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">status</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NV_ADMA_CTL_GO</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_LEGACY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">ata_port_warn</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
			      <span class="s">&quot;timeout waiting for ADMA LEGACY, stat=0x%hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">status</span><span class="p">);</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_GO</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_LEGACY</span><span class="p">)</span> <span class="o">||</span>
	      <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_IDLE</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">ata_port_warn</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
			<span class="s">&quot;timeout waiting for ADMA LEGACY clear and IDLE, stat=0x%hx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_slave_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">port0</span><span class="p">,</span> <span class="o">*</span><span class="n">port1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev0</span><span class="p">,</span> <span class="o">*</span><span class="n">sdev1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">segment_boundary</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sg_tablesize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">adma_enable</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">current_reg</span><span class="p">,</span> <span class="n">new_reg</span><span class="p">,</span> <span class="n">config_mask</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_scsi_slave_config</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ATA_MAX_DEVICES</span> <span class="o">||</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">||</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)</span>
		<span class="cm">/* Not a proper libata device, ignore */</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">].</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * NVIDIA reports that ADMA mode does not support ATAPI commands.</span>
<span class="cm">		 * Therefore ATAPI commands are sent through the legacy interface.</span>
<span class="cm">		 * However, the legacy interface only supports 32-bit DMA.</span>
<span class="cm">		 * Restrict DMA parameters as required by the legacy interface</span>
<span class="cm">		 * when an ATAPI device is connected.</span>
<span class="cm">		 */</span>
		<span class="n">segment_boundary</span> <span class="o">=</span> <span class="n">ATA_DMA_BOUNDARY</span><span class="p">;</span>
		<span class="cm">/* Subtract 1 since an extra entry may be needed for padding, see</span>
<span class="cm">		   libata-scsi.c */</span>
		<span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">LIBATA_MAX_PRD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Since the legacy DMA engine is in use, we need to disable ADMA</span>
<span class="cm">		   on the port. */</span>
		<span class="n">adma_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nv_adma_register_mode</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">segment_boundary</span> <span class="o">=</span> <span class="n">NV_ADMA_DMA_BOUNDARY</span><span class="p">;</span>
		<span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">NV_ADMA_SGTBL_TOTAL_LEN</span><span class="p">;</span>
		<span class="n">adma_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">config_mask</span> <span class="o">=</span> <span class="n">NV_MCP_SATA_CFG_20_PORT1_EN</span> <span class="o">|</span>
			      <span class="n">NV_MCP_SATA_CFG_20_PORT1_PWB_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">config_mask</span> <span class="o">=</span> <span class="n">NV_MCP_SATA_CFG_20_PORT0_EN</span> <span class="o">|</span>
			      <span class="n">NV_MCP_SATA_CFG_20_PORT0_PWB_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adma_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_reg</span> <span class="o">=</span> <span class="n">current_reg</span> <span class="o">|</span> <span class="n">config_mask</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">new_reg</span> <span class="o">=</span> <span class="n">current_reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">config_mask</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_reg</span> <span class="o">!=</span> <span class="n">new_reg</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="n">new_reg</span><span class="p">);</span>

	<span class="n">port0</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">port1</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">sdev0</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">sdev1</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">sdev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">port0</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">port1</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/** We have to set the DMA mask to 32-bit if either port is in</span>
<span class="cm">		    ATAPI mode, since they are on the same PCI device which is</span>
<span class="cm">		    used for DMA mapping. If we set the mask we also need to set</span>
<span class="cm">		    the bounce limit on both ports to ensure that the block</span>
<span class="cm">		    layer doesn&#39;t feed addresses that cause DMA mapping to</span>
<span class="cm">		    choke. If either SCSI device is not allocated yet, it&#39;s OK</span>
<span class="cm">		    since that port will discover its correct setting when it</span>
<span class="cm">		    does get allocated.</span>
<span class="cm">		    Note: Setting 32-bit mask should not fail. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev0</span><span class="p">)</span>
			<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">sdev0</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span>
					       <span class="n">ATA_DMA_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev1</span><span class="p">)</span>
			<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">sdev1</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span>
					       <span class="n">ATA_DMA_MASK</span><span class="p">);</span>

		<span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ATA_DMA_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/** This shouldn&#39;t fail as it was set to this value before */</span>
		<span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">adma_dma_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev0</span><span class="p">)</span>
			<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">sdev0</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span>
					       <span class="n">pp</span><span class="o">-&gt;</span><span class="n">adma_dma_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev1</span><span class="p">)</span>
			<span class="n">blk_queue_bounce_limit</span><span class="p">(</span><span class="n">sdev1</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span>
					       <span class="n">pp</span><span class="o">-&gt;</span><span class="n">adma_dma_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">blk_queue_segment_boundary</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">segment_boundary</span><span class="p">);</span>
	<span class="n">blk_queue_max_segments</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="n">sg_tablesize</span><span class="p">);</span>
	<span class="n">ata_port_info</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
		      <span class="s">&quot;DMA mask 0x%llX, segment boundary 0x%lX, hw segs %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">,</span>
		      <span class="n">segment_boundary</span><span class="p">,</span> <span class="n">sg_tablesize</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_check_atapi_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_tf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Other than when internal or pass-through commands are executed,</span>
<span class="cm">	   the only time this function will be called in ADMA mode will be</span>
<span class="cm">	   if a command fails. In the failure case we don&#39;t care about going</span>
<span class="cm">	   into register mode with ADMA commands pending, as the commands will</span>
<span class="cm">	   all shortly be aborted anyway. We assume that NCQ commands are not</span>
<span class="cm">	   issued via passthrough, which is the only way that switching into</span>
<span class="cm">	   ADMA mode could abort outstanding commands. */</span>
	<span class="n">nv_adma_register_mode</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">ata_sff_tf_read</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">nv_adma_tf_to_cpb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">cpb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_ISADDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_ERR</span>   <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span> <span class="o">|</span> <span class="n">WNB</span><span class="p">);</span>
			<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_NSECT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">);</span>
			<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_LBAL</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">);</span>
			<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_LBAM</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">);</span>
			<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_LBAH</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">);</span>
			<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_ERR</span>    <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_ERR</span>    <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">|</span> <span class="n">WNB</span><span class="p">);</span>

		<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_NSECT</span>  <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">);</span>
		<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_LBAL</span>   <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">);</span>
		<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_LBAM</span>   <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">);</span>
		<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_LBAH</span>   <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">)</span>
		<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_DEVICE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">ATA_REG_CMD</span>    <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">|</span> <span class="n">CMDEND</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">cpb</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IGN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_check_cpb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpb_num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force_err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb</span><span class="p">[</span><span class="n">cpb_num</span><span class="p">].</span><span class="n">resp_flags</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;CPB %d, flags=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpb_num</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">force_err</span> <span class="o">||</span>
		     <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_CPB_RESP_ATA_ERR</span> <span class="o">|</span>
			      <span class="n">NV_CPB_RESP_CMD_ERR</span> <span class="o">|</span>
			      <span class="n">NV_CPB_RESP_CPB_ERR</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">freeze</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ata_ehi_clear_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
		<span class="n">__ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;CPB resp_flags 0x%x: &quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_CPB_RESP_ATA_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;ATA error&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_CPB_RESP_CMD_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;CMD error&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_CPB_RESP_CPB_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;CPB error&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_SYSTEM</span><span class="p">;</span>
			<span class="n">freeze</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* notifier error, but no error in CPB flags? */</span>
			<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_OTHER</span><span class="p">;</span>
			<span class="n">freeze</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Kill all commands. EH will determine what actually failed. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freeze</span><span class="p">)</span>
			<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ata_port_abort</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_CPB_RESP_DONE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_host_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">irq_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">);</span>

	<span class="cm">/* freeze if hotplugged */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_INT_ADDED</span> <span class="o">|</span> <span class="n">NV_INT_REMOVED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bail out if not our interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">NV_INT_DEV</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DEV interrupt w/ no active qc? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">qc</span> <span class="o">||</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_POLLING</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ata_sff_check_status</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* handle interrupt */</span>
	<span class="k">return</span> <span class="n">ata_bmdma_port_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_adma_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">notifier_clears</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">gen_ctl</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">notifier</span><span class="p">,</span> <span class="n">notifier_error</span><span class="p">;</span>

		<span class="n">notifier_clears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* if ADMA is disabled, use standard ata interrupt handler */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">irq_stat</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_CK804</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">NV_INT_PORT_SHIFT</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">handled</span> <span class="o">+=</span> <span class="n">nv_host_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">irq_stat</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if in ATA register mode, check for standard interrupts */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">irq_stat</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_CK804</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">NV_INT_PORT_SHIFT</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ata_tag_valid</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">))</span>
				<span class="cm">/** NV_INT_DEV indication seems unreliable</span>
<span class="cm">				    at times at least in ADMA mode. Force it</span>
<span class="cm">				    on always when a command is active, to</span>
<span class="cm">				    prevent losing interrupts. */</span>
				<span class="n">irq_stat</span> <span class="o">|=</span> <span class="n">NV_INT_DEV</span><span class="p">;</span>
			<span class="n">handled</span> <span class="o">+=</span> <span class="n">nv_host_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">irq_stat</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">notifier</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_NOTIFIER</span><span class="p">);</span>
		<span class="n">notifier_error</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_NOTIFIER_ERROR</span><span class="p">);</span>
		<span class="n">notifier_clears</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">notifier</span> <span class="o">|</span> <span class="n">notifier_error</span><span class="p">;</span>

		<span class="n">gen_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">gen_block</span> <span class="o">+</span> <span class="n">NV_ADMA_GEN_CTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NV_ADMA_CHECK_INTR</span><span class="p">(</span><span class="n">gen_ctl</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">notifier</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">notifier_error</span><span class="p">)</span>
			<span class="cm">/* Nothing to do */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear status. Ensure the controller sees the</span>
<span class="cm">		 * clearing before we start looking at any of the CPB</span>
<span class="cm">		 * statuses, so that any CPB completions after this</span>
<span class="cm">		 * point in the handler will raise another interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
		<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span> <span class="cm">/* flush posted write */</span>
		<span class="n">rmb</span><span class="p">();</span>

		<span class="n">handled</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* irq handled if we got here */</span>

		<span class="cm">/* freeze if hotplugged or controller error */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_ADMA_STAT_HOTPLUG</span> <span class="o">|</span>
				       <span class="n">NV_ADMA_STAT_HOTUNPLUG</span> <span class="o">|</span>
				       <span class="n">NV_ADMA_STAT_TIMEOUT</span> <span class="o">|</span>
				       <span class="n">NV_ADMA_STAT_SERROR</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>

			<span class="n">ata_ehi_clear_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
			<span class="n">__ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;ADMA status 0x%08x: &quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_SYSTEM</span><span class="p">;</span>
				<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;timeout&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_HOTPLUG</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
				<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;hotplug&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_HOTUNPLUG</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
				<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;hot unplug&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_SERROR</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* let EH analyze SError and figure out cause */</span>
				<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;SError&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>
			<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NV_ADMA_STAT_DONE</span> <span class="o">|</span>
			      <span class="n">NV_ADMA_STAT_CPBERR</span> <span class="o">|</span>
			      <span class="n">NV_ADMA_STAT_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">check_commands</span> <span class="o">=</span> <span class="n">notifier_clears</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">done_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_STAT_CPBERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* check all active commands */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ata_tag_valid</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">))</span>
					<span class="n">check_commands</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span>
						<span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">check_commands</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">sactive</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* check CPBs for completed commands */</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">pos</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">check_commands</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">pos</span><span class="o">--</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">nv_adma_check_cpb</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span>
						<span class="n">notifier_error</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">done_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
					<span class="n">check_commands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">check_commands</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ata_qc_complete_multiple</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">^</span> <span class="n">done_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notifier_clears</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">notifier_clears</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Note: Both notifier clear registers must be written</span>
<span class="cm">		   if either is set, even if one is zero, according to NVIDIA. */</span>
		<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">notifier_clears</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">notifier_clear_block</span><span class="p">);</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">notifier_clears</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">notifier_clear_block</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">nv_ck804_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* clear any outstanding CK804 notifications */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">NV_INT_ALL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT</span><span class="p">),</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_CK804</span><span class="p">);</span>

	<span class="cm">/* Disable interrupt */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_ADMA_CTL_AIEN</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_HOTPLUG_IEN</span><span class="p">),</span>
		<span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">nv_ck804_thaw</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Enable interrupt */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">NV_ADMA_CTL_AIEN</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_HOTPLUG_IEN</span><span class="p">),</span>
		<span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_irq_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">notifier_clears</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_bmdma_irq_clear</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear any outstanding CK804 notifications */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">NV_INT_ALL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT</span><span class="p">),</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_CK804</span><span class="p">);</span>

	<span class="cm">/* clear ADMA status */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>

	<span class="cm">/* clear notifiers - note both ports need to be written with</span>
<span class="cm">	   something even though we are only clearing on one */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">notifier_clears</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="n">notifier_clears</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">notifier_clears</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">notifier_clears</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">notifier_clears</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">notifier_clear_block</span><span class="p">);</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">notifier_clears</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">notifier_clear_block</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_post_internal_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">)</span>
		<span class="n">ata_bmdma_post_internal_cmd</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mem_dma</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Ensure DMA mask is set to 32-bit before allocating legacy PRD and</span>
<span class="cm">	   pad buffers */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* we might fallback to bmdma, allocate bmdma resources */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_bmdma_port_start</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mmio</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_ADMA_PORT</span> <span class="o">+</span>
	       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_ADMA_PORT_SIZE</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span> <span class="o">=</span> <span class="n">mmio</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">gen_block</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_ADMA_GEN</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">notifier_clear_block</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">gen_block</span> <span class="o">+</span>
	       <span class="n">NV_ADMA_NOTIFIER_CLEAR</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">);</span>

	<span class="cm">/* Now that the legacy PRD and padding buffer are allocated we can</span>
<span class="cm">	   safely raise the DMA mask to allocate the CPB/APRD table.</span>
<span class="cm">	   These are allowed to fail since we store the value that ends up</span>
<span class="cm">	   being used to set as the bounce limit in slave_config later if</span>
<span class="cm">	   needed. */</span>
	<span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">));</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">adma_dma_mask</span> <span class="o">=</span> <span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">dmam_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">NV_ADMA_PORT_PRIV_DMA_SZ</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">mem_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NV_ADMA_PORT_PRIV_DMA_SZ</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First item in chunk of DMA memory:</span>
<span class="cm">	 * 128-byte command parameter block (CPB)</span>
<span class="cm">	 * one for each command tag</span>
<span class="cm">	 */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb</span>     <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_dma</span> <span class="o">=</span> <span class="n">mem_dma</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">mem_dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> 	<span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_BASE_LOW</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">mem_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>	<span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_BASE_HIGH</span><span class="p">);</span>

	<span class="n">mem</span>     <span class="o">+=</span> <span class="n">NV_ADMA_MAX_CPBS</span> <span class="o">*</span> <span class="n">NV_ADMA_CPB_SZ</span><span class="p">;</span>
	<span class="n">mem_dma</span> <span class="o">+=</span> <span class="n">NV_ADMA_MAX_CPBS</span> <span class="o">*</span> <span class="n">NV_ADMA_CPB_SZ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Second item: block of ADMA_SGTBL_LEN s/g entries</span>
<span class="cm">	 */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">aprd</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">aprd_dma</span> <span class="o">=</span> <span class="n">mem_dma</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>

	<span class="cm">/* clear any outstanding interrupt conditions */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>

	<span class="cm">/* initialize port variables */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">;</span>

	<span class="cm">/* clear CPB fetch count */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_COUNT</span><span class="p">);</span>

	<span class="cm">/* clear GO for register mode, enable interrupt */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NV_ADMA_CTL_GO</span><span class="p">)</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_AIEN</span> <span class="o">|</span>
		<span class="n">NV_ADMA_CTL_HOTPLUG_IEN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_CHANNEL_RESET</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NV_ADMA_CTL_CHANNEL_RESET</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_port_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>

	<span class="cm">/* Go to register mode - clears GO */</span>
	<span class="n">nv_adma_register_mode</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* clear CPB fetch count */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_COUNT</span><span class="p">);</span>

	<span class="cm">/* disable interrupt, shut down port */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* set CPB block location */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_dma</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> 	<span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_BASE_LOW</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>	<span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_BASE_HIGH</span><span class="p">);</span>

	<span class="cm">/* clear any outstanding interrupt conditions */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>

	<span class="cm">/* initialize port variables */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">;</span>

	<span class="cm">/* clear CPB fetch count */</span>
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_COUNT</span><span class="p">);</span>

	<span class="cm">/* clear GO for register mode, enable interrupt */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NV_ADMA_CTL_GO</span><span class="p">)</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_AIEN</span> <span class="o">|</span>
		<span class="n">NV_ADMA_CTL_HOTPLUG_IEN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_CHANNEL_RESET</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NV_ADMA_CTL_CHANNEL_RESET</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
	<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_setup_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ata_ioports</span> <span class="o">*</span><span class="n">ioport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mmio</span> <span class="o">+=</span> <span class="n">NV_ADMA_PORT</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_ADMA_PORT_SIZE</span><span class="p">;</span>

	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">cmd_addr</span>	<span class="o">=</span> <span class="n">mmio</span><span class="p">;</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">data_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_DATA</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">error_addr</span>	<span class="o">=</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">feature_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_ERR</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">nsect_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_NSECT</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">lbal_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAL</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">lbam_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAM</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">lbah_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAH</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">device_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_DEVICE</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">status_addr</span>	<span class="o">=</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">command_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_STATUS</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">altstatus_addr</span>	<span class="o">=</span>
	<span class="n">ioport</span><span class="o">-&gt;</span><span class="n">ctl_addr</span>	<span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_host_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* enable ADMA on the ports */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">tmp32</span> <span class="o">|=</span> <span class="n">NV_MCP_SATA_CFG_20_PORT0_EN</span> <span class="o">|</span>
		 <span class="n">NV_MCP_SATA_CFG_20_PORT0_PWB_EN</span> <span class="o">|</span>
		 <span class="n">NV_MCP_SATA_CFG_20_PORT1_EN</span> <span class="o">|</span>
		 <span class="n">NV_MCP_SATA_CFG_20_PORT1_PWB_EN</span><span class="p">;</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nv_adma_setup_port</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_fill_aprd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">nv_adma_prd</span> <span class="o">*</span><span class="n">aprd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NV_APRD_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NV_APRD_END</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NV_APRD_CONT</span><span class="p">;</span>

	<span class="n">aprd</span><span class="o">-&gt;</span><span class="n">addr</span>  <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)));</span>
	<span class="n">aprd</span><span class="o">-&gt;</span><span class="n">len</span>   <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)));</span> <span class="cm">/* len in bytes */</span>
	<span class="n">aprd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">aprd</span><span class="o">-&gt;</span><span class="n">packet_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_fill_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nv_adma_cpb</span> <span class="o">*</span><span class="n">cpb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_adma_prd</span> <span class="o">*</span><span class="n">aprd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aprd</span> <span class="o">=</span> <span class="p">(</span><span class="n">si</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">cpb</span><span class="o">-&gt;</span><span class="n">aprd</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">:</span>
			       <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">aprd</span><span class="p">[</span><span class="n">NV_ADMA_SGTBL_LEN</span> <span class="o">*</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">+</span> <span class="p">(</span><span class="n">si</span><span class="o">-</span><span class="mi">5</span><span class="p">)];</span>
		<span class="n">nv_adma_fill_aprd</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">aprd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">si</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">next_aprd</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(((</span><span class="n">u64</span><span class="p">)(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">aprd_dma</span> <span class="o">+</span> <span class="n">NV_ADMA_SGTBL_SZ</span> <span class="o">*</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">next_aprd</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_adma_use_reg_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* ADMA engine can only be used for non-ATAPI DMA commands,</span>
<span class="cm">	   or interrupt-driven no-data commands. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_POLLING</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_DMAMAP</span><span class="p">)</span> <span class="o">||</span>
	   <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ATA_PROT_NODATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_qc_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_adma_cpb</span> <span class="o">*</span><span class="n">cpb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb</span><span class="p">[</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">ctl_flags</span> <span class="o">=</span> <span class="n">NV_CPB_CTL_CPB_VALID</span> <span class="o">|</span>
		       <span class="n">NV_CPB_CTL_IEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_adma_use_reg_mode</span><span class="p">(</span><span class="n">qc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_DMAMAP</span><span class="p">));</span>
		<span class="n">nv_adma_register_mode</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">ata_bmdma_qc_prep</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">resp_flags</span> <span class="o">=</span> <span class="n">NV_CPB_RESP_DONE</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">ctl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">len</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">tag</span>		<span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">next_cpb_idx</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* turn on NCQ flags for NCQ commands */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ATA_PROT_NCQ</span><span class="p">)</span>
		<span class="n">ctl_flags</span> <span class="o">|=</span> <span class="n">NV_CPB_CTL_QUEUE</span> <span class="o">|</span> <span class="n">NV_CPB_CTL_FPDMA</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;qc-&gt;flags = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">nv_adma_tf_to_cpb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">,</span> <span class="n">cpb</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_DMAMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_adma_fill_sg</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">cpb</span><span class="p">);</span>
		<span class="n">ctl_flags</span> <span class="o">|=</span> <span class="n">NV_CPB_CTL_APRD_VALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpb</span><span class="o">-&gt;</span><span class="n">aprd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">nv_adma_prd</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* Be paranoid and don&#39;t let the device see NV_CPB_CTL_CPB_VALID</span>
<span class="cm">	   until we are finished filling in all of the contents */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">ctl_flags</span> <span class="o">=</span> <span class="n">ctl_flags</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">cpb</span><span class="o">-&gt;</span><span class="n">resp_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">nv_adma_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_ncq</span> <span class="o">=</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ATA_PROT_NCQ</span><span class="p">);</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* We can&#39;t handle result taskfile with NCQ commands, since</span>
<span class="cm">	   retrieving the taskfile switches us out of ADMA mode and would abort</span>
<span class="cm">	   existing commands. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ATA_PROT_NCQ</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_RESULT_TF</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ata_dev_err</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NCQ w/ RESULT_TF not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AC_ERR_SYSTEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nv_adma_use_reg_mode</span><span class="p">(</span><span class="n">qc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* use ATA register mode */</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;using ATA register mode: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_DMAMAP</span><span class="p">));</span>
		<span class="n">nv_adma_register_mode</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ata_bmdma_qc_issue</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nv_adma_mode</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* write append register, command tag in lower 8 bits</span>
<span class="cm">	   and (number of cpbs to append -1) in top 8 bits */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_ncq</span> <span class="o">!=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_ncq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Seems to need some delay before switching between NCQ and</span>
<span class="cm">		   non-NCQ commands, else we get command timeouts and such. */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_ncq</span> <span class="o">=</span> <span class="n">curr_ncq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_APPEND</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Issued tag %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_generic_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>

		<span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_POLLING</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">+=</span> <span class="n">ata_bmdma_port_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * No request pending?  Clear interrupt status</span>
<span class="cm">			 * anyway, in case there&#39;s one pending.</span>
<span class="cm">			 */</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_check_status</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_do_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u8</span> <span class="n">irq_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">+=</span> <span class="n">nv_host_intr</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">irq_stat</span><span class="p">);</span>
		<span class="n">irq_stat</span> <span class="o">&gt;&gt;=</span> <span class="n">NV_INT_PORT_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_nf2_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">irq_stat</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">irq_stat</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span> <span class="o">+</span> <span class="n">NV_INT_STATUS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nv_do_interrupt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irq_stat</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_ck804_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">irq_stat</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">irq_stat</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_CK804</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">nv_do_interrupt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irq_stat</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc_reg</span> <span class="o">&gt;</span> <span class="n">SCR_CONTROL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc_reg</span> <span class="o">&gt;</span> <span class="n">SCR_CONTROL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">sc_reg</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">;</span>

	<span class="cm">/* Do hardreset iff it&#39;s post-boot probing, please read the</span>
<span class="cm">	 * comment above port ops for details.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_LOADING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="n">sata_link_hardreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">sata_deb_timing_hotplug</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span>
				    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timing</span> <span class="o">=</span> <span class="n">sata_ehc_deb_timing</span><span class="p">(</span><span class="n">ehc</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_EHI_QUIET</span><span class="p">))</span>
			<span class="n">ata_link_info</span><span class="p">(</span><span class="n">link</span><span class="p">,</span>
				      <span class="s">&quot;nv: skipping hardreset on occupied port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* make sure the link is online */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_link_resume</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">timing</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
		<span class="cm">/* whine about phy resume failure but proceed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
			<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;failed to resume link (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* device signature acquisition is unreliable */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_nf2_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scr_addr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">scr_addr</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_INT_ALL</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">scr_addr</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_nf2_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scr_addr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">iowrite8</span><span class="p">(</span><span class="n">NV_INT_ALL</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="n">scr_addr</span> <span class="o">+</span> <span class="n">NV_INT_STATUS</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">scr_addr</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NV_INT_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">scr_addr</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_ck804_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_CK804</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_INT_ALL</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_CK804</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_ck804_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">writeb</span><span class="p">(</span><span class="n">NV_INT_ALL</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_CK804</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_CK804</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NV_INT_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_CK804</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_mcp55_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT_MCP55</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NV_INT_ALL_MCP55</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_MCP55</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_INT_ALL_MCP55</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_mcp55_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio_base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="n">NV_INT_PORT_SHIFT_MCP55</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NV_INT_ALL_MCP55</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_MCP55</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">NV_INT_MASK_MCP55</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mmio_base</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_PORT_REGISTER_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">ctl_block</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ata_tag_valid</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">)</span> <span class="o">||</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">sactive</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">notifier</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_NOTIFIER</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">notifier_error</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_NOTIFIER_ERROR</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">gen_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">gen_block</span> <span class="o">+</span> <span class="n">NV_ADMA_GEN_CTL</span><span class="p">);</span>
			<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_STAT</span><span class="p">);</span>
			<span class="n">u8</span> <span class="n">cpb_count</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_COUNT</span><span class="p">);</span>
			<span class="n">u8</span> <span class="n">next_cpb_idx</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_NEXT_CPB_IDX</span><span class="p">);</span>

			<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
				<span class="s">&quot;EH in ADMA mode, notifier 0x%X &quot;</span>
				<span class="s">&quot;notifier_error 0x%X gen_ctl 0x%X status 0x%X &quot;</span>
				<span class="s">&quot;next cpb count 0x%X next cpb idx 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">notifier</span><span class="p">,</span> <span class="n">notifier_error</span><span class="p">,</span> <span class="n">gen_ctl</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
				<span class="n">cpb_count</span><span class="p">,</span> <span class="n">next_cpb_idx</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NV_ADMA_MAX_CPBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">nv_adma_cpb</span> <span class="o">*</span><span class="n">cpb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ata_tag_valid</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">sactive</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
					<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
						<span class="s">&quot;CPB %d: ctl_flags 0x%x, resp_flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i</span><span class="p">,</span> <span class="n">cpb</span><span class="o">-&gt;</span><span class="n">ctl_flags</span><span class="p">,</span> <span class="n">cpb</span><span class="o">-&gt;</span><span class="n">resp_flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Push us back into port register mode for error handling. */</span>
		<span class="n">nv_adma_register_mode</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

		<span class="cm">/* Mark all of the CPBs as invalid to prevent them from</span>
<span class="cm">		   being executed */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NV_ADMA_MAX_CPBS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cpb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_CPB_CTL_CPB_VALID</span><span class="p">;</span>

		<span class="cm">/* clear CPB fetch count */</span>
		<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CPB_COUNT</span><span class="p">);</span>

		<span class="cm">/* Reset channel */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">NV_ADMA_CTL_CHANNEL_RESET</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
		<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NV_ADMA_CTL_CHANNEL_RESET</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>
		<span class="n">readw</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_ADMA_CTL</span><span class="p">);</span>	<span class="cm">/* flush posted write */</span>
	<span class="p">}</span>

	<span class="n">ata_bmdma_error_handler</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_qc_to_dq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">defer_queue</span> <span class="o">*</span><span class="n">dq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">defer_queue</span><span class="p">;</span>

	<span class="cm">/* queue is full */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-</span> <span class="n">dq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">);</span>
	<span class="n">dq</span><span class="o">-&gt;</span><span class="n">defer_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">dq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">++</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_MAX_QUEUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="nf">nv_swncq_qc_from_dq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">defer_queue</span> <span class="o">*</span><span class="n">dq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">defer_queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">dq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>	<span class="cm">/* null queue */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">dq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_MAX_QUEUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
	<span class="n">dq</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">[</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_MAX_QUEUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ATA_TAG_POISON</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dq</span><span class="o">-&gt;</span><span class="n">defer_bits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tag</span><span class="p">)));</span>
	<span class="n">dq</span><span class="o">-&gt;</span><span class="n">defer_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_fis_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">sdbfis_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_pp_reinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">defer_queue</span> <span class="o">*</span><span class="n">dq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">defer_queue</span><span class="p">;</span>

	<span class="n">dq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dq</span><span class="o">-&gt;</span><span class="n">defer_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_tag</span> <span class="o">=</span> <span class="n">ATA_TAG_POISON</span><span class="p">;</span>
	<span class="n">nv_swncq_fis_reinit</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_irq_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">fis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">writew</span><span class="p">(</span><span class="n">fis</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">irq_block</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ata_bmdma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="n">qc</span><span class="p">;</span>

	<span class="n">qc</span><span class="p">.</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">ata_bmdma_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_ncq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sactive</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">done_mask</span><span class="p">;</span>

	<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;EH in SWNCQ mode,QC:qc_active 0x%X sactive 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ap</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">sactive</span><span class="p">);</span>
	<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
		<span class="s">&quot;SWNCQ:qc_active 0x%X defer_bits 0x%X last_issue_tag 0x%x</span><span class="se">\n</span><span class="s">  &quot;</span>
		<span class="s">&quot;dhfis 0x%X dmafis 0x%X sdbfis 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">defer_queue</span><span class="p">.</span><span class="n">defer_bits</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_tag</span><span class="p">,</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">sdbfis_bits</span><span class="p">);</span>

	<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;ATA_REG 0x%X ERR_REG 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_check_status</span><span class="p">(</span><span class="n">ap</span><span class="p">),</span>
		     <span class="n">ioread8</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">error_addr</span><span class="p">));</span>

	<span class="n">sactive</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">sactive_block</span><span class="p">);</span>
	<span class="n">done_mask</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">^</span> <span class="n">sactive</span><span class="p">;</span>

	<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;tag : dhfis dmafis sdbfis sactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">done_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
			     <span class="s">&quot;tag 0x%x: %01x %01x %01x %01x %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">sdbfis_bits</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">sactive</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">err</span> <span class="o">?</span> <span class="s">&quot;error! tag doesn&#39;t exit&quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">nv_swncq_pp_reinit</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_irq_clear</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">__ata_bmdma_stop</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">nv_swncq_irq_clear</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_context</span> <span class="o">*</span><span class="n">ehc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">sactive</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_swncq_ncq_stop</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">ehc</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ata_bmdma_error_handler</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_swncq_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* clear irq */</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_MCP55</span><span class="p">);</span>

	<span class="cm">/* disable irq */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>

	<span class="cm">/* disable swncq */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_CTL_MCP55</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_CTL_PRI_SWNCQ</span> <span class="o">|</span> <span class="n">NV_CTL_SEC_SWNCQ</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_CTL_MCP55</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_swncq_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* clear irq */</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_MCP55</span><span class="p">);</span>

	<span class="cm">/* enable irq */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00fd00fd</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>

	<span class="cm">/* enable swncq */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_CTL_MCP55</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">NV_CTL_PRI_SWNCQ</span> <span class="o">|</span> <span class="n">NV_CTL_SEC_SWNCQ</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_CTL_MCP55</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_host_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

	<span class="cm">/* disable  ECO 398 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>

	<span class="cm">/* enable swncq */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_CTL_MCP55</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;HOST_CTL:0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">NV_CTL_PRI_SWNCQ</span> <span class="o">|</span> <span class="n">NV_CTL_SEC_SWNCQ</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_CTL_MCP55</span><span class="p">);</span>

	<span class="cm">/* enable irq intr */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;HOST_ENABLE:0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x00fd00fd</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_ENABLE_MCP55</span><span class="p">);</span>

	<span class="cm">/*  clear port irq */</span>
	<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_MCP55</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_swncq_slave_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">check_maxtor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">model_num</span><span class="p">[</span><span class="n">ATA_ID_PROD_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_scsi_slave_config</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ATA_MAX_DEVICES</span> <span class="o">||</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">||</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">lun</span><span class="p">)</span>
		<span class="cm">/* Not a proper libata device, ignore */</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_NCQ</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* if MCP51 and Maxtor, then disable ncq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA</span> <span class="o">||</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP51_SATA2</span><span class="p">)</span>
		<span class="n">check_maxtor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* if MCP55 and rev &lt;= a2 and Maxtor, then disable ncq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA</span> <span class="o">||</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_NVIDIA_NFORCE_MCP55_SATA2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mh">0xa2</span><span class="p">)</span>
			<span class="n">check_maxtor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_maxtor</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ata_id_c_string</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">model_num</span><span class="p">,</span> <span class="n">ATA_ID_PROD</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">model_num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">model_num</span><span class="p">,</span> <span class="s">&quot;Maxtor&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_scsi_change_queue_depth</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SCSI_QDEPTH_DEFAULT</span><span class="p">);</span>
		<span class="n">ata_dev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Disabling SWNCQ mode (depth %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">queue_depth</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_swncq_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* we might fallback to bmdma, allocate bmdma resources */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_bmdma_port_start</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">prd</span> <span class="o">=</span> <span class="n">dmam_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ATA_PRD_TBL_SZ</span> <span class="o">*</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">prd_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">prd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">prd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATA_PRD_TBL_SZ</span> <span class="o">*</span> <span class="n">ATA_MAX_QUEUE</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">sactive_block</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">SCR_ACTIVE</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">irq_block</span> <span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_MCP55</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">tag_block</span> <span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">NV_NCQ_REG_MCP55</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_qc_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ATA_PROT_NCQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_bmdma_qc_prep</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_DMAMAP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nv_swncq_fill_sg</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_fill_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_bmdma_prd</span> <span class="o">*</span><span class="n">prd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">prd</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">prd</span> <span class="o">+</span> <span class="n">ATA_MAX_PRD</span> <span class="o">*</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">sg_len</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">sg_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">sg_len</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">sg_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

			<span class="n">prd</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">prd</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">flags_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>

			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sg_len</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">prd</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">flags_len</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ATA_PRD_EOT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">nv_swncq_issue_atacmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">),</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">sactive_block</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_tag</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_tf_load</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>	 <span class="cm">/* load tf registers */</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_exec_command</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Issued tag %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">nv_swncq_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ATA_PROT_NCQ</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ata_bmdma_qc_issue</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">)</span>
		<span class="n">nv_swncq_issue_atacmd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nv_swncq_qc_to_dq</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>	<span class="cm">/* add qc to defer queue */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_hotplug</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">fis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">serror</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>

	<span class="n">ata_ehi_clear_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>

	<span class="cm">/* AHCI needs SError cleared; otherwise, it might lock up */</span>
	<span class="n">sata_scr_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serror</span><span class="p">);</span>
	<span class="n">sata_scr_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="n">serror</span><span class="p">);</span>

	<span class="cm">/* analyze @irq_stat */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_ADDED</span><span class="p">)</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;hot plug&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_REMOVED</span><span class="p">)</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;hot unplug&quot;</span><span class="p">);</span>

	<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>

	<span class="cm">/* okay, let&#39;s hand over to EH */</span>
	<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">serror</span> <span class="o">|=</span> <span class="n">serror</span><span class="p">;</span>

	<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_swncq_sdbfis</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sactive</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">done_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">host_stat</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lack_dhfis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">host_stat</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bmdma_status</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">host_stat</span> <span class="o">&amp;</span> <span class="n">ATA_DMA_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* error when transferring data to/from memory */</span>
		<span class="n">ata_ehi_clear_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;BMDMA stat 0x%x&quot;</span><span class="p">,</span> <span class="n">host_stat</span><span class="p">);</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HOST_BUS</span><span class="p">;</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_irq_clear</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">__ata_bmdma_stop</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">sactive</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">sactive_block</span><span class="p">);</span>
	<span class="n">done_mask</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">^</span> <span class="n">sactive</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">done_mask</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">done_mask</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">done_mask</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">sdbfis_bits</span> <span class="o">|=</span> <span class="n">done_mask</span><span class="p">;</span>
	<span class="n">ata_qc_complete_multiple</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">^</span> <span class="n">done_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">nv_swncq_pp_reinit</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">&amp;</span> <span class="n">ncq_saw_backout</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">^</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span><span class="p">))</span>
		<span class="cm">/* if the controller can&#39;t get a device to host register FIS,</span>
<span class="cm">		 * The driver needs to reissue the new command.</span>
<span class="cm">		 */</span>
		<span class="n">lack_dhfis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;id 0x%x QC: qc_active 0x%x,&quot;</span>
		<span class="s">&quot;SWNCQ:qc_active 0x%X defer_bits %X &quot;</span>
		<span class="s">&quot;dhfis 0x%X dmafis 0x%X last_issue_tag %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">print_id</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">,</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">defer_queue</span><span class="p">.</span><span class="n">defer_bits</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span><span class="p">,</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_tag</span><span class="p">);</span>

	<span class="n">nv_swncq_fis_reinit</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lack_dhfis</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_tag</span><span class="p">);</span>
		<span class="n">nv_swncq_issue_atacmd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">defer_queue</span><span class="p">.</span><span class="n">defer_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send deferral queue command */</span>
		<span class="n">qc</span> <span class="o">=</span> <span class="n">nv_swncq_qc_from_dq</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">qc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">nv_swncq_issue_atacmd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">nv_swncq_tag</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>

	<span class="n">tag</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">tag_block</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">tag</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_dmafis</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dmactl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tag</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">__ata_bmdma_stop</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">nv_swncq_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;dma setup tag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">qc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rw</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">;</span>

	<span class="cm">/* load PRD table addr. */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">prd_dma</span> <span class="o">+</span> <span class="n">ATA_PRD_TBL_SZ</span> <span class="o">*</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span>
		  <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">bmdma_addr</span> <span class="o">+</span> <span class="n">ATA_DMA_TABLE_OFS</span><span class="p">);</span>

	<span class="cm">/* specify data direction, triple-check start bit is clear */</span>
	<span class="n">dmactl</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">bmdma_addr</span> <span class="o">+</span> <span class="n">ATA_DMA_CMD</span><span class="p">);</span>
	<span class="n">dmactl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_DMA_WR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rw</span><span class="p">)</span>
		<span class="n">dmactl</span> <span class="o">|=</span> <span class="n">ATA_DMA_WR</span><span class="p">;</span>

	<span class="n">iowrite8</span><span class="p">(</span><span class="n">dmactl</span> <span class="o">|</span> <span class="n">ATA_DMA_START</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">bmdma_addr</span> <span class="o">+</span> <span class="n">ATA_DMA_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_swncq_host_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">fis</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">nv_swncq_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serror</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ata_stat</span><span class="p">;</span>

	<span class="n">ata_stat</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_check_status</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">nv_swncq_irq_clear</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fis</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fis</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_HOTPLUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nv_swncq_hotplug</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fis</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scr_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serror</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">scr_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="n">serror</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_stat</span> <span class="o">&amp;</span> <span class="n">ATA_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_ehi_clear_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">);</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;Ata error. fis:0x%X&quot;</span><span class="p">,</span> <span class="n">fis</span><span class="p">);</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">serror</span> <span class="o">|=</span> <span class="n">serror</span><span class="p">;</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_BACKOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the IRQ is backout, driver must issue</span>
<span class="cm">		 * the new command again some time later.</span>
<span class="cm">		 */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">|=</span> <span class="n">ncq_saw_backout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_SDBFIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">|=</span> <span class="n">ncq_saw_sdb</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;id 0x%x SWNCQ: qc_active 0x%X &quot;</span>
			<span class="s">&quot;dhfis 0x%X dmafis 0x%X sactive 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">print_id</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span><span class="p">,</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">sactive_block</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nv_swncq_sdbfis</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">irq_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_DHREGFIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The interrupt indicates the new command</span>
<span class="cm">		 * was transmitted correctly to the drive.</span>
<span class="cm">		 */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dhfis_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">last_issue_tag</span><span class="p">);</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">|=</span> <span class="n">ncq_saw_d2h</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ncq_saw_sdb</span> <span class="o">|</span> <span class="n">ncq_saw_backout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;illegal fis transaction&quot;</span><span class="p">);</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
			<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">irq_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_DMASETUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">&amp;</span> <span class="n">ncq_saw_dmas</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ata_stat</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_check_status</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ata_stat</span> <span class="o">&amp;</span> <span class="n">ATA_BUSY</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">irq_exit</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">defer_queue</span><span class="p">.</span><span class="n">defer_bits</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;send next command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">qc</span> <span class="o">=</span> <span class="n">nv_swncq_qc_from_dq</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
				<span class="n">nv_swncq_issue_atacmd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fis</span> <span class="o">&amp;</span> <span class="n">NV_SWNCQ_IRQ_DMASETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* program the dma controller with appropriate PRD buffers</span>
<span class="cm">		 * and start the DMA transfer for requested command.</span>
<span class="cm">		 */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">dmafis_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">nv_swncq_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">));</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ncq_flags</span> <span class="o">|=</span> <span class="n">ncq_saw_dmas</span><span class="p">;</span>
		<span class="n">nv_swncq_dmafis</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">irq_exit:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">irq_error:</span>
	<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;fis:0x%x&quot;</span><span class="p">,</span> <span class="n">fis</span><span class="p">);</span>
	<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">nv_swncq_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_stat</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">irq_stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">]</span> <span class="o">+</span> <span class="n">NV_INT_STATUS_MCP55</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">sactive</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nv_swncq_host_interrupt</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">irq_stat</span><span class="p">);</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span><span class="p">)</span>	<span class="cm">/* reserve Hotplug */</span>
				<span class="n">nv_swncq_irq_clear</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mh">0xfff0</span><span class="p">);</span>

			<span class="n">handled</span> <span class="o">+=</span> <span class="n">nv_host_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">irq_stat</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">irq_stat</span> <span class="o">&gt;&gt;=</span> <span class="n">NV_INT_PORT_SHIFT_MCP55</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">nv_pi_priv</span> <span class="o">*</span><span class="n">ipriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nv_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bar</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">type</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Make sure this is a SATA controller by counting the number of bars
(NVIDIA SATA controllers will always have six bars).  Otherwise,
it's an IDE controller and we ignore it.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">bar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bar</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">bar</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">bar</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ata_print_version_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DRV_VERSION</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* determine type and allocate host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">CK804</span> <span class="o">&amp;&amp;</span> <span class="n">adma_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using ADMA mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">ADMA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">MCP5x</span> <span class="o">&amp;&amp;</span> <span class="n">swncq_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using SWNCQ mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">SWNCQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nv_port_info</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
	<span class="n">ipriv</span> <span class="o">=</span> <span class="n">ppi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_bmdma_prepare_host</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ppi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">host</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">hpriv</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hpriv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hpriv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hpriv</span><span class="p">;</span>

	<span class="cm">/* request and iomap NV_MMIO_BAR */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcim_iomap_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NV_MMIO_BAR</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* configure SCR access */</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">iomap</span><span class="p">[</span><span class="n">NV_MMIO_BAR</span><span class="p">];</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NV_PORT0_SCR_REG_OFFSET</span><span class="p">;</span>
	<span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">scr_addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">NV_PORT1_SCR_REG_OFFSET</span><span class="p">;</span>

	<span class="cm">/* enable SATA space for CK804 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">CK804</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
		<span class="n">regval</span> <span class="o">|=</span> <span class="n">NV_MCP_SATA_CFG_20_SATA_SPACE_EN</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* init ADMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ADMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">nv_adma_host_init</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SWNCQ</span><span class="p">)</span>
		<span class="n">nv_swncq_host_init</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msi_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Using MSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ata_pci_sff_activate_host</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">ipriv</span><span class="o">-&gt;</span><span class="n">irq_handler</span><span class="p">,</span> <span class="n">ipriv</span><span class="o">-&gt;</span><span class="n">sht</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">nv_pci_device_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">nv_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_pci_device_do_resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">power</span><span class="p">.</span><span class="n">power_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">PM_EVENT_SUSPEND</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">CK804</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
			<span class="n">regval</span> <span class="o">|=</span> <span class="n">NV_MCP_SATA_CFG_20_SATA_SPACE_EN</span><span class="p">;</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ADMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">nv_adma_port_priv</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
			<span class="cm">/* enable/disable ADMA on the ports appropriately */</span>
			<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>

			<span class="n">pp</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span>
				<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_MCP_SATA_CFG_20_PORT0_EN</span> <span class="o">|</span>
					   <span class="n">NV_MCP_SATA_CFG_20_PORT0_PWB_EN</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tmp32</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">NV_MCP_SATA_CFG_20_PORT0_EN</span> <span class="o">|</span>
					   <span class="n">NV_MCP_SATA_CFG_20_PORT0_PWB_EN</span><span class="p">);</span>
			<span class="n">pp</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NV_ADMA_ATAPI_SETUP_COMPLETE</span><span class="p">)</span>
				<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_MCP_SATA_CFG_20_PORT1_EN</span> <span class="o">|</span>
					   <span class="n">NV_MCP_SATA_CFG_20_PORT1_PWB_EN</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tmp32</span> <span class="o">|=</span>  <span class="p">(</span><span class="n">NV_MCP_SATA_CFG_20_PORT1_EN</span> <span class="o">|</span>
					   <span class="n">NV_MCP_SATA_CFG_20_PORT1_PWB_EN</span><span class="p">);</span>

			<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_ck804_host_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">regval</span><span class="p">;</span>

	<span class="cm">/* disable SATA space for CK804 */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regval</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NV_MCP_SATA_CFG_20_SATA_SPACE_EN</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nv_adma_host_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

	<span class="cm">/* disable ADMA on the ports */</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp32</span><span class="p">);</span>
	<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">NV_MCP_SATA_CFG_20_PORT0_EN</span> <span class="o">|</span>
		   <span class="n">NV_MCP_SATA_CFG_20_PORT0_PWB_EN</span> <span class="o">|</span>
		   <span class="n">NV_MCP_SATA_CFG_20_PORT1_EN</span> <span class="o">|</span>
		   <span class="n">NV_MCP_SATA_CFG_20_PORT1_PWB_EN</span><span class="p">);</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">NV_MCP_SATA_CFG_20</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="n">nv_ck804_host_stop</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nv_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nv_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nv_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nv_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nv_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nv_exit</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">adma</span><span class="p">,</span> <span class="n">adma_enabled</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adma</span><span class="p">,</span> <span class="s">&quot;Enable use of ADMA (Default: false)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">swncq</span><span class="p">,</span> <span class="n">swncq_enabled</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">swncq</span><span class="p">,</span> <span class="s">&quot;Enable use of SWNCQ (Default: true)&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="n">msi_enabled</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msi</span><span class="p">,</span> <span class="s">&quot;Enable use of MSI (Default: false)&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
