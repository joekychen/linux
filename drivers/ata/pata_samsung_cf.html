<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › pata_samsung_cf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pata_samsung_cf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Samsung Electronics Co., Ltd.</span>
<span class="cm"> *		http://www.samsung.com</span>
<span class="cm"> *</span>
<span class="cm"> * PATA driver for Samsung SoCs.</span>
<span class="cm"> * Supports CF Interface in True IDE mode. Currently only PIO mode has been</span>
<span class="cm"> * implemented; UDMA support has to be added.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on:</span>
<span class="cm"> *	PATA driver for AT91SAM9260 Static Memory Controller</span>
<span class="cm"> *	PATA driver for Toshiba SCC controller</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2</span>
<span class="cm"> * as published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;plat/ata.h&gt;</span>
<span class="cp">#include &lt;plat/regs-ata.h&gt;</span>

<span class="cp">#define DRV_NAME &quot;pata_samsung_cf&quot;</span>
<span class="cp">#define DRV_VERSION &quot;0.1&quot;</span>

<span class="k">enum</span> <span class="n">s3c_cpu_type</span> <span class="p">{</span>
	<span class="n">TYPE_S3C64XX</span><span class="p">,</span>
	<span class="n">TYPE_S5PC100</span><span class="p">,</span>
	<span class="n">TYPE_S5PV210</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * struct s3c_ide_info - S3C PATA instance.</span>
<span class="cm"> * @clk: The clock resource for this controller.</span>
<span class="cm"> * @ide_addr: The area mapped for the hardware registers.</span>
<span class="cm"> * @sfr_addr: The area mapped for the special function registers.</span>
<span class="cm"> * @irq: The IRQ number we are using.</span>
<span class="cm"> * @cpu_type: The exact type of this controller.</span>
<span class="cm"> * @fifo_status_reg: The ATA_FIFO_STATUS register offset.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ide_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sfr_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">s3c_cpu_type</span> <span class="n">cpu_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fifo_status_reg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_set_endian</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">s3c_ide_regbase</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">s3c_ide_regbase</span> <span class="o">+</span> <span class="n">S3C_ATA_CFG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">?</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">S3C_ATA_CFG_SWAP</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="n">S3C_ATA_CFG_SWAP</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">s3c_ide_regbase</span> <span class="o">+</span> <span class="n">S3C_ATA_CFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_cfg_mode</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">s3c_ide_sfrbase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Select true-ide as the internal operating mode */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">s3c_ide_sfrbase</span> <span class="o">+</span> <span class="n">S3C_CFATA_MUX</span><span class="p">)</span> <span class="o">|</span> <span class="n">S3C_CFATA_MUX_TRUEIDE</span><span class="p">,</span>
		<span class="n">s3c_ide_sfrbase</span> <span class="o">+</span> <span class="n">S3C_CFATA_MUX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">pata_s3c_setup_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ata_timing</span> <span class="o">*</span><span class="n">ata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">act8b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t2i</span> <span class="o">=</span> <span class="n">ata</span><span class="o">-&gt;</span><span class="n">rec8b</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">piotime</span><span class="p">;</span>

	<span class="n">piotime</span> <span class="o">=</span> <span class="p">((</span><span class="n">t2i</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">t2</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t1</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">piotime</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">adev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_timing</span> <span class="n">timing</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cycle_time</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">ata_cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_CFG</span><span class="p">);</span>
	<span class="n">ulong</span> <span class="n">piotime</span><span class="p">;</span>

	<span class="cm">/* Enables IORDY if mode requires it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ata_pio_need_iordy</span><span class="p">(</span><span class="n">adev</span><span class="p">))</span>
		<span class="n">ata_cfg</span> <span class="o">|=</span> <span class="n">S3C_ATA_CFG_IORDYEN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ata_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">S3C_ATA_CFG_IORDYEN</span><span class="p">;</span>

	<span class="n">cycle_time</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">1000000000UL</span> <span class="o">/</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">));</span>

	<span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">,</span>
					<span class="n">cycle_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">piotime</span> <span class="o">=</span> <span class="n">pata_s3c_setup_timing</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">ata_cfg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_CFG</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">piotime</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_TIME</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Waits until the IDE controller is able to perform next read/write</span>
<span class="cm"> * operation to the disk. Needed for 64XX series boards only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_for_host_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ulong</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">fifo_reg</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_status_reg</span><span class="p">;</span>

	<span class="cm">/* wait for maximum of 20 msec */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">fifo_reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Writes to one of the task file registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ata_outb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">wait_for_host_ready</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reads from one of the task file registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ata_inb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">wait_for_host_ready</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readb</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">wait_for_host_ready</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_RDATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_tf_load - send taskfile registers to host controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_tf_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_ioports</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_addr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_ISADDR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>
		<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_addr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">feature_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbam_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbah_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">feature_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbam_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbah_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">)</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">device_addr</span><span class="p">);</span>

	<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_tf_read - input device&#39;s ATA taskfile shadow registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_tf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_ioports</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">error_addr</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbam_addr</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbah_addr</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">device_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">|</span> <span class="n">ATA_HOB</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">error_addr</span><span class="p">);</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbam_addr</span><span class="p">);</span>
		<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbah_addr</span><span class="p">);</span>
		<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_exec_command - issue ATA command to host controller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_exec_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">command_addr</span><span class="p">);</span>
	<span class="n">ata_sff_pause</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_check_status - Read device status register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">pata_s3c_check_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">status_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_check_altstatus - Read alternate device status register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">pata_s3c_check_altstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_data_xfer - Transfer data by PIO</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pata_s3c_data_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data_addr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">words</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Requires wait same as in ata_inb/ata_outb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">words</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">data_ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wait_for_host_ready</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readw</span><span class="p">(</span><span class="n">data_addr</span><span class="p">);</span>
			<span class="n">wait_for_host_ready</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="o">*</span><span class="n">data_ptr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span>
					<span class="o">+</span> <span class="n">S3C_ATA_PIO_RDATA</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">words</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">data_ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wait_for_host_ready</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">writew</span><span class="p">(</span><span class="o">*</span><span class="n">data_ptr</span><span class="p">,</span> <span class="n">data_addr</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unexpected trailing data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">words</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_dev_select - Select device on ATA bus</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_dev_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">ATA_DEVICE_OBS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ATA_DEV1</span><span class="p">;</span>

	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">device_addr</span><span class="p">);</span>
	<span class="n">ata_sff_pause</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_devchk - PATA device presence detection</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pata_s3c_devchk</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_ioports</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">nsect</span><span class="p">,</span> <span class="n">lbal</span><span class="p">;</span>

	<span class="n">pata_s3c_dev_select</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>

	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>

	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>

	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>

	<span class="n">nsect</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">nsect_addr</span><span class="p">);</span>
	<span class="n">lbal</span> <span class="o">=</span> <span class="n">ata_inb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">lbal_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nsect</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lbal</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* we found a device */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* nothing found */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_wait_after_reset - wait for devices to become ready after reset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pata_s3c_wait_after_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ata_msleep</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">ATA_WAIT_AFTER_RESET</span><span class="p">);</span>

	<span class="cm">/* always check readiness of the master device */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_sff_wait_ready</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
	<span class="cm">/* -ENODEV means the odd clown forgot the D7 pulldown resistor</span>
<span class="cm">	 * and TF status is 0xff, bail out on it too.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_bus_softreset - PATA device software reset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pata_s3c_bus_softreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_ioports</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">;</span>

	<span class="cm">/* software reset.  causes dev0 to be selected */</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">|</span> <span class="n">ATA_SRST</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ioaddr</span><span class="o">-&gt;</span><span class="n">ctl_addr</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pata_s3c_wait_after_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_softreset - reset host port via ATA SRST</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pata_s3c_softreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">classes</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* determine if device 0 is present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pata_s3c_devchk</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">devmask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* select device 0 again */</span>
	<span class="n">pata_s3c_dev_select</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* issue bus reset */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pata_s3c_bus_softreset</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
	<span class="cm">/* if link is occupied, -ENODEV too is an error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;SRST failed (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine by signature whether we have ATA or ATAPI devices */</span>
	<span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ata_sff_dev_classify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					  <span class="n">devmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pata_s3c_set_devctl - Write device control register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_set_devctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ata_outb</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">,</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">pata_s3c_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_PIO_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">pata_s3c_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_sff_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_check_status</span>	<span class="o">=</span> <span class="n">pata_s3c_check_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_check_altstatus</span>    <span class="o">=</span> <span class="n">pata_s3c_check_altstatus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_tf_load</span>		<span class="o">=</span> <span class="n">pata_s3c_tf_load</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_tf_read</span>		<span class="o">=</span> <span class="n">pata_s3c_tf_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_data_xfer</span>		<span class="o">=</span> <span class="n">pata_s3c_data_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_exec_command</span>	<span class="o">=</span> <span class="n">pata_s3c_exec_command</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_dev_select</span>         <span class="o">=</span> <span class="n">pata_s3c_dev_select</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_set_devctl</span>         <span class="o">=</span> <span class="n">pata_s3c_set_devctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">softreset</span>		<span class="o">=</span> <span class="n">pata_s3c_softreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>		<span class="o">=</span> <span class="n">pata_s3c_set_piomode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">pata_s5p_port_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_sff_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>		<span class="o">=</span> <span class="n">pata_s3c_set_piomode</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_enable</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">s3c_ide_regbase</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">s3c_ide_regbase</span> <span class="o">+</span> <span class="n">S3C_ATA_CTRL</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">state</span> <span class="o">?</span> <span class="p">(</span><span class="n">temp</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">s3c_ide_regbase</span> <span class="o">+</span> <span class="n">S3C_ATA_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pata_s3c_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_IRQ</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_IRQ</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_sff_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_instance</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pata_s3c_hwinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s3c_ide_platdata</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_S3C64XX</span>:
		<span class="cm">/* Configure as big endian */</span>
		<span class="n">pata_s3c_cfg_mode</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sfr_addr</span><span class="p">);</span>
		<span class="n">pata_s3c_set_endian</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pata_s3c_enable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="cm">/* Remove IRQ Status */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x1f</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_IRQ</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x1b</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_IRQ_MSK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TYPE_S5PC100</span>:
		<span class="n">pata_s3c_cfg_mode</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">sfr_addr</span><span class="p">);</span>
		<span class="cm">/* FALLTHROUGH */</span>

	<span class="k">case</span> <span class="n">TYPE_S5PV210</span>:
		<span class="cm">/* Configure as little endian */</span>
		<span class="n">pata_s3c_set_endian</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pata_s3c_enable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="cm">/* Remove IRQ Status */</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_IRQ</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_IRQ_MSK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pata_s3c_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s3c_ide_platdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">s3c_cpu_type</span> <span class="n">cpu_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cpu_type</span> <span class="o">=</span> <span class="n">platform_get_device_id</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate memory for device data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get mem resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devm_request_mem_region</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				<span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error requesting register region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">=</span> <span class="n">devm_ioremap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map IO base address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cfcon&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get access to cf controller clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clk_enable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="cm">/* init ata host */</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ata_host_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to allocate ide host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">stop_clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">TYPE_S3C64XX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pata_s3c_port_ops</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sfr_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="mh">0x1800</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+=</span> <span class="mh">0x1900</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_status_reg</span> <span class="o">=</span> <span class="mh">0x94</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cpu_type</span> <span class="o">==</span> <span class="n">TYPE_S5PC100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pata_s5p_port_ops</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">sfr_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="mh">0x1800</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+=</span> <span class="mh">0x1900</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_status_reg</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pata_s5p_port_ops</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fifo_status_reg</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cpu_type</span> <span class="o">=</span> <span class="n">cpu_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_PIO_POLLING</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ata_port_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;no IRQ, using PIO polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">cmd_addr</span> <span class="o">=</span>  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_CMD</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_DTR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">error_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_FED</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">feature_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_FED</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">nsect_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_SCR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbal_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_LLR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbam_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_LMR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbah_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_LHR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">device_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_DVR</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">status_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_CSD</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">command_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_CSD</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_DAD</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ide_addr</span> <span class="o">+</span> <span class="n">S3C_ATA_PIO_DAD</span><span class="p">;</span>

	<span class="n">ata_port_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;mmio cmd 0x%llx &quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>

	<span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_gpio</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_gpio</span><span class="p">();</span>

	<span class="cm">/* Set endianness and enable the interface */</span>
	<span class="n">pata_s3c_hwinit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_host_activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">?</span> <span class="n">pata_s3c_irq</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pata_s3c_sht</span><span class="p">);</span>

<span class="nl">stop_clk:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">pata_s3c_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">ata_host_detach</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="n">clk_disable</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pata_s3c_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_host_suspend</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">PMSG_SUSPEND</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pata_s3c_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s3c_ide_platdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s3c_ide_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pata_s3c_hwinit</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="n">ata_host_resume</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">pata_s3c_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">pata_s3c_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">pata_s3c_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* driver device registration */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">pata_s3c_driver_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s3c64xx-pata&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="n">TYPE_S3C64XX</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s5pc100-pata&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="n">TYPE_S5PC100</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;s5pv210-pata&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">driver_data</span>	<span class="o">=</span> <span class="n">TYPE_S5PV210</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">pata_s3c_driver_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">pata_s3c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">pata_s3c_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">pata_s3c_driver_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pata_s3c_pm_ops</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pata_s3c_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pata_s3c_driver</span><span class="p">,</span> <span class="n">pata_s3c_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pata_s3c_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pata_s3c_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pata_s3c_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pata_s3c_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Abhilash Kesavan, &lt;a.kesavan@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;low-level driver for Samsung PATA controller&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
