<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › pata_octeon_cf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pata_octeon_cf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the Octeon bootbus compact flash.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005 - 2009 Cavium Networks</span>
<span class="cm"> * Copyright (C) 2008 Wind River Systems</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &lt;asm/octeon/octeon.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * The Octeon bootbus compact flash interface is connected in at least</span>
<span class="cm"> * 3 different configurations on various evaluation boards:</span>
<span class="cm"> *</span>
<span class="cm"> * -- 8  bits no irq, no DMA</span>
<span class="cm"> * -- 16 bits no irq, no DMA</span>
<span class="cm"> * -- 16 bits True IDE mode with DMA, but no irq.</span>
<span class="cm"> *</span>
<span class="cm"> * In the last case the DMA engine can generate an interrupt when the</span>
<span class="cm"> * transfer is complete.  For the first two cases only PIO is supported.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define DRV_NAME	&quot;pata_octeon_cf&quot;</span>
<span class="cp">#define DRV_VERSION	&quot;2.1&quot;</span>


<span class="k">struct</span> <span class="n">octeon_cf_port</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">delayed_finish</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_finished</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">octeon_cf_sht</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ATA_PIO_SHT</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * Convert nanosecond based time to setting used in the</span>
<span class="cm"> * boot bus timing register, based on timing multiple</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ns_to_tim_reg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tim_mult</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nsecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute # of eclock periods to get desired duration in</span>
<span class="cm">	 * nanoseconds.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">nsecs</span> <span class="o">*</span> <span class="p">(</span><span class="n">octeon_get_io_clock_rate</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">),</span>
			  <span class="mi">1000</span> <span class="o">*</span> <span class="n">tim_mult</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_set_boot_reg_cfg</span><span class="p">(</span><span class="kt">int</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cvmx_mio_boot_reg_cfgx</span> <span class="n">reg_cfg</span><span class="p">;</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="n">cvmx_read_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_REG_CFGX</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t assert DMACK on access */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">tim_mult</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Timing mutiplier 2x */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">rd_dly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Sample on falling edge of BOOT_OE */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">sam</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t combine write and output enable */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">we_ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No write enable extension */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">oe_ext</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No read enable extension */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Enable this region */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">orbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t combine with previous region */</span>
	<span class="n">reg_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t do address multiplexing */</span>
	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_REG_CFGX</span><span class="p">(</span><span class="n">cs</span><span class="p">),</span> <span class="n">reg_cfg</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Called after libata determines the needed PIO mode. This</span>
<span class="cm"> * function programs the Octeon bootbus regions to support the</span>
<span class="cm"> * timing requirements of the PIO mode.</span>
<span class="cm"> *</span>
<span class="cm"> * @ap:     ATA port information</span>
<span class="cm"> * @dev:    ATA device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_set_piomode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">octeon_cf_data</span> <span class="o">*</span><span class="n">ocd</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cvmx_mio_boot_reg_timx</span> <span class="n">reg_tim</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cs</span> <span class="o">=</span> <span class="n">ocd</span><span class="o">-&gt;</span><span class="n">base_region</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">T</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_timing</span> <span class="n">timing</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">use_iordy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">trh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pause</span><span class="p">;</span>
	<span class="cm">/* These names are timing parameters from the ATA spec */</span>
	<span class="kt">int</span> <span class="n">t1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t2i</span><span class="p">;</span>

	<span class="n">T</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">2000000000000LL</span> <span class="o">/</span> <span class="n">octeon_get_clock_rate</span><span class="p">());</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ata_timing_compute</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pio_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timing</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">t1</span> <span class="o">=</span> <span class="n">timing</span><span class="p">.</span><span class="n">setup</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t1</span><span class="p">)</span>
		<span class="n">t1</span><span class="o">--</span><span class="p">;</span>
	<span class="n">t2</span> <span class="o">=</span> <span class="n">timing</span><span class="p">.</span><span class="n">active</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t2</span><span class="p">)</span>
		<span class="n">t2</span><span class="o">--</span><span class="p">;</span>
	<span class="n">t2i</span> <span class="o">=</span> <span class="n">timing</span><span class="p">.</span><span class="n">act8b</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t2i</span><span class="p">)</span>
		<span class="n">t2i</span><span class="o">--</span><span class="p">;</span>

	<span class="n">trh</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trh</span><span class="p">)</span>
		<span class="n">trh</span><span class="o">--</span><span class="p">;</span>

	<span class="n">pause</span> <span class="o">=</span> <span class="n">timing</span><span class="p">.</span><span class="n">cycle</span> <span class="o">-</span> <span class="n">timing</span><span class="p">.</span><span class="n">active</span> <span class="o">-</span> <span class="n">timing</span><span class="p">.</span><span class="n">setup</span> <span class="o">-</span> <span class="n">trh</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pause</span><span class="p">)</span>
		<span class="n">pause</span><span class="o">--</span><span class="p">;</span>

	<span class="n">octeon_cf_set_boot_reg_cfg</span><span class="p">(</span><span class="n">cs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* True IDE mode, program both chip selects.  */</span>
		<span class="n">octeon_cf_set_boot_reg_cfg</span><span class="p">(</span><span class="n">cs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>


	<span class="n">use_iordy</span> <span class="o">=</span> <span class="n">ata_pio_need_iordy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">reg_tim</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="n">cvmx_read_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_REG_TIMX</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
	<span class="cm">/* Disable page mode */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">pagem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Enable dynamic timing */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">waitm</span> <span class="o">=</span> <span class="n">use_iordy</span><span class="p">;</span>
	<span class="cm">/* Pages are disabled */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* We don&#39;t use multiplexed address mode */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Not used */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Time after IORDY to coninue to assert the data */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Time to wait to complete the cycle. */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">pause</span> <span class="o">=</span> <span class="n">pause</span><span class="p">;</span>
	<span class="cm">/* How long to hold after a write to de-assert CE. */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">wr_hld</span> <span class="o">=</span> <span class="n">trh</span><span class="p">;</span>
	<span class="cm">/* How long to wait after a read to de-assert CE. */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">rd_hld</span> <span class="o">=</span> <span class="n">trh</span><span class="p">;</span>
	<span class="cm">/* How long write enable is asserted */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">we</span> <span class="o">=</span> <span class="n">t2</span><span class="p">;</span>
	<span class="cm">/* How long read enable is asserted */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">oe</span> <span class="o">=</span> <span class="n">t2</span><span class="p">;</span>
	<span class="cm">/* Time after CE that read/write starts */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">ce</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* Time before CE that address is valid */</span>
	<span class="n">reg_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Program the bootbus region timing for the data port chip select. */</span>
	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_REG_TIMX</span><span class="p">(</span><span class="n">cs</span><span class="p">),</span> <span class="n">reg_tim</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* True IDE mode, program both chip selects.  */</span>
		<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_REG_TIMX</span><span class="p">(</span><span class="n">cs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">reg_tim</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_set_dmamode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">octeon_cf_data</span> <span class="o">*</span><span class="n">ocd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cvmx_mio_boot_dma_timx</span> <span class="n">dma_tim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oe_a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oe_n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_ackh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_arq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pause</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">T0</span><span class="p">,</span> <span class="n">Tkr</span><span class="p">,</span> <span class="n">Td</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tim_mult</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_timing</span> <span class="o">*</span><span class="n">timing</span><span class="p">;</span>

	<span class="n">timing</span> <span class="o">=</span> <span class="n">ata_timing_find_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">);</span>
	<span class="n">T0</span>	<span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">;</span>
	<span class="n">Td</span>	<span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="n">Tkr</span>	<span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">recover</span><span class="p">;</span>
	<span class="n">dma_ackh</span> <span class="o">=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">dmack_hold</span><span class="p">;</span>

	<span class="n">dma_tim</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* dma_tim.s.tim_mult = 0 --&gt; 4x */</span>
	<span class="n">tim_mult</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* not spec&#39;ed, value in eclocks, not affected by tim_mult */</span>
	<span class="n">dma_arq</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">pause</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">-</span> <span class="n">dma_arq</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span>
		<span class="p">(</span><span class="n">octeon_get_clock_rate</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">);</span> <span class="cm">/* Tz */</span>

	<span class="n">oe_a</span> <span class="o">=</span> <span class="n">Td</span><span class="p">;</span>
	<span class="cm">/* Tkr from cf spec, lengthened to meet T0 */</span>
	<span class="n">oe_n</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">T0</span> <span class="o">-</span> <span class="n">oe_a</span><span class="p">,</span> <span class="n">Tkr</span><span class="p">);</span>

	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmack_pi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">oe_n</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="n">oe_n</span><span class="p">);</span>
	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">oe_a</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="n">oe_a</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is tI, C.F. spec. says 0, but Sony CF card requires</span>
<span class="cm">	 * more, we use 20 nS.</span>
<span class="cm">	 */</span>
	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmack_s</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmack_h</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="n">dma_ackh</span><span class="p">);</span>

	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmarq</span> <span class="o">=</span> <span class="n">dma_arq</span><span class="p">;</span>
	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">pause</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="n">pause</span><span class="p">);</span>

	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">rd_dly</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Sample right on edge */</span>

	<span class="cm">/*  writes only */</span>
	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">we_n</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="n">oe_n</span><span class="p">);</span>
	<span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">we_a</span> <span class="o">=</span> <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="n">oe_a</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ns to ticks (mult %d) of %d is: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tim_mult</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span>
		 <span class="n">ns_to_tim_reg</span><span class="p">(</span><span class="n">tim_mult</span><span class="p">,</span> <span class="mi">60</span><span class="p">));</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;oe_n: %d, oe_a: %d, dmack_s: %d, dmack_h: &quot;</span>
		 <span class="s">&quot;%d, dmarq: %d, pause: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">oe_n</span><span class="p">,</span> <span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">oe_a</span><span class="p">,</span> <span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmack_s</span><span class="p">,</span>
		 <span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmack_h</span><span class="p">,</span> <span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">dmarq</span><span class="p">,</span> <span class="n">dma_tim</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">pause</span><span class="p">);</span>

	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_TIMX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span>
		       <span class="n">dma_tim</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handle an 8 bit I/O request.</span>
<span class="cm"> *</span>
<span class="cm"> * @dev:        Device to access</span>
<span class="cm"> * @buffer:     Data buffer</span>
<span class="cm"> * @buflen:     Length of the buffer.</span>
<span class="cm"> * @rw:         True to write.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">octeon_cf_data_xfer8</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span>		<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data_addr</span>		<span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">words</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">words</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">words</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite8</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data_addr</span><span class="p">);</span>
			<span class="n">buffer</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Every 16 writes do a read so the bootbus</span>
<span class="cm">			 * FIFO doesn&#39;t fill up.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioread8</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span><span class="p">);</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ioread8_rep</span><span class="p">(</span><span class="n">data_addr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">words</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Handle a 16 bit I/O request.</span>
<span class="cm"> *</span>
<span class="cm"> * @dev:        Device to access</span>
<span class="cm"> * @buffer:     Data buffer</span>
<span class="cm"> * @buflen:     Length of the buffer.</span>
<span class="cm"> * @rw:         True to write.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">octeon_cf_data_xfer16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">rw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span>		<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">data_addr</span>		<span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">words</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">words</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">words</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data_addr</span><span class="p">);</span>
			<span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Every 16 writes do a read so the bootbus</span>
<span class="cm">			 * FIFO doesn&#39;t fill up.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ioread8</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span><span class="p">);</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">words</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">data_addr</span><span class="p">);</span>
			<span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint16_t</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Transfer trailing 1 byte, if any. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">buflen</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">align_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rw</span> <span class="o">==</span> <span class="n">READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">align_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ioread16</span><span class="p">(</span><span class="n">data_addr</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">align_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">align_buf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">iowrite16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">align_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">data_addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">words</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">buflen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Read the taskfile for 16bit non-True IDE only.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_tf_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">blob</span><span class="p">;</span>
	<span class="cm">/* The base of the registers is at ioaddr.data_addr. */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>

	<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">|</span> <span class="n">ATA_HOB</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">);</span>

			<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span> <span class="o">=</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

			<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">);</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">octeon_cf_check_status16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">blob</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>

	<span class="n">blob</span> <span class="o">=</span> <span class="n">__raw_readw</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">blob</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">octeon_cf_softreset16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">classes</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;about to softreset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">|</span> <span class="n">ATA_SRST</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_sff_wait_after_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">deadline</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;SRST failed (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine by signature whether we have ATA or ATAPI devices */</span>
	<span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ata_sff_dev_classify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, classes[0]=%u [1]=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">classes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Load the taskfile for 16bit non-True IDE only.  The device_addr is</span>
<span class="cm"> * not loaded, we do this as part of octeon_cf_exec_command16.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_tf_load16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_addr</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_ISADDR</span><span class="p">;</span>
	<span class="cm">/* The base of the registers is at ioaddr.data_addr. */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">!=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite8</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_ctl</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">;</span>
		<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_addr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_LBA48</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;hob: feat 0x%X nsect 0x%X, lba 0x%X 0x%X 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_feature</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_nsect</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbal</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbam</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">hob_lbah</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">__raw_writew</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span> <span class="o">|</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;feat 0x%X nsect 0x%X, lba 0x%X 0x%X 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">feature</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">nsect</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbal</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbam</span><span class="p">,</span>
			<span class="n">tf</span><span class="o">-&gt;</span><span class="n">lbah</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_dev_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*  There is only one device, do nothing. */</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Issue ATA command to host controller.  The device_addr is also sent</span>
<span class="cm"> * as it must be written in a combined write with the command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_exec_command16</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The base of the registers is at ioaddr.data_addr. */</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">blob</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;device 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">blob</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ata%u: cmd 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">print_id</span><span class="p">,</span> <span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="n">blob</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">__raw_writew</span><span class="p">(</span><span class="n">blob</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>


	<span class="n">ata_wait_idle</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_irq_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_irq_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_dma_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">octeon_cf_port</span> <span class="o">*</span><span class="n">cf_port</span><span class="p">;</span>

	<span class="n">cf_port</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* issue r/w command */</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">cursg</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">dma_finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_exec_command</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Start a DMA transfer that was already setup</span>
<span class="cm"> *</span>
<span class="cm"> * @qc:     Information about the DMA</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">octeon_cf_data</span> <span class="o">*</span><span class="n">ocd</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cvmx_mio_boot_dma_cfgx</span> <span class="n">mio_boot_dma_cfg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cvmx_mio_boot_dma_intx</span> <span class="n">mio_boot_dma_int</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;%d scatterlists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">);</span>

	<span class="cm">/* Get the scatter list entry we need to DMA into */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">cursg</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the DMA complete status.</span>
<span class="cm">	 */</span>
	<span class="n">mio_boot_dma_int</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mio_boot_dma_int</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_INTX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span>
		       <span class="n">mio_boot_dma_int</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>

	<span class="cm">/* Enable the interrupt.  */</span>
	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_INT_ENX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span>
		       <span class="n">mio_boot_dma_int</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>

	<span class="cm">/* Set the direction of the DMA */</span>
	<span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">rw</span> <span class="o">=</span> <span class="p">((</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t stop the DMA if the device deasserts DMARQ. Many</span>
<span class="cm">	 * compact flashes deassert DMARQ for a short time between</span>
<span class="cm">	 * sectors. Instead of stopping and restarting the DMA, we&#39;ll</span>
<span class="cm">	 * let the hardware do it. If the DMA is really stopped early</span>
<span class="cm">	 * due to an error condition, a later timeout will force us to</span>
<span class="cm">	 * stop.</span>
<span class="cm">	 */</span>
	<span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">clr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Size is specified in 16bit words and minus one notation */</span>
	<span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* We need to swap the high and low bytes of every 16 bits */</span>
	<span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">swap8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;%s %d bytes address=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">rw</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;write&quot;</span> <span class="o">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="n">sg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">adr</span><span class="p">);</span>

	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_CFGX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span>
		       <span class="n">mio_boot_dma_cfg</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	spin_lock_irqsave(host lock)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">octeon_cf_dma_finished</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">octeon_cf_data</span> <span class="o">*</span><span class="n">ocd</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cvmx_mio_boot_dma_cfgx</span> <span class="n">dma_cfg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cvmx_mio_boot_dma_intx</span> <span class="n">dma_int</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">octeon_cf_port</span> <span class="o">*</span><span class="n">cf_port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ata%u: protocol %d task_state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">print_id</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">hsm_task_state</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">hsm_task_state</span> <span class="o">!=</span> <span class="n">HSM_ST_LAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cf_port</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dma_cfg</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="n">cvmx_read_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_CFGX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mh">0xfffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Error, the transfer was not complete.  */</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HOST_BUS</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">hsm_task_state</span> <span class="o">=</span> <span class="n">HSM_ST_ERR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stop and clear the dma engine.  */</span>
	<span class="n">dma_cfg</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_CFGX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span> <span class="n">dma_cfg</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>

	<span class="cm">/* Disable the interrupt.  */</span>
	<span class="n">dma_int</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_INT_ENX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span> <span class="n">dma_int</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>

	<span class="cm">/* Clear the DMA complete status */</span>
	<span class="n">dma_int</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_INTX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span> <span class="n">dma_int</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_check_status</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">ata_sff_hsm_move</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">err_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ATA_PROT_DMA</span><span class="p">))</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">ehi</span><span class="p">,</span> <span class="s">&quot;DMA stat 0x%x&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check if any queued commands have more DMAs, if so start the next</span>
<span class="cm"> * transfer, else do end of transfer handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">octeon_cf_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">octeon_cf_port</span> <span class="o">*</span><span class="n">cf_port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">cvmx_mio_boot_dma_intx</span> <span class="n">dma_int</span><span class="p">;</span>
		<span class="k">union</span> <span class="n">cvmx_mio_boot_dma_cfgx</span> <span class="n">dma_cfg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">octeon_cf_data</span> <span class="o">*</span><span class="n">ocd</span><span class="p">;</span>

		<span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ocd</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
		<span class="n">cf_port</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">dma_int</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span>
			<span class="n">cvmx_read_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_INTX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">));</span>
		<span class="n">dma_cfg</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span>
			<span class="n">cvmx_read_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_CFGX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">));</span>

		<span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_POLLING</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_int</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dma_cfg</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sg_is_last</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">cursg</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">qc</span><span class="o">-&gt;</span><span class="n">cursg</span> <span class="o">=</span> <span class="n">sg_next</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">cursg</span><span class="p">);</span>
					<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">octeon_cf_dma_start</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">dma_finished</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">dma_finished</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRQ</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * We are busy, try to handle it</span>
<span class="cm">				 * later.  This is the DMA finished</span>
<span class="cm">				 * interrupt, and it could take a</span>
<span class="cm">				 * little while for the card to be</span>
<span class="cm">				 * ready for more commands.</span>
<span class="cm">				 */</span>
				<span class="cm">/* Clear DMA irq. */</span>
				<span class="n">dma_int</span><span class="p">.</span><span class="n">u64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">dma_int</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">cvmx_write_csr</span><span class="p">(</span><span class="n">CVMX_MIO_BOOT_DMA_INTX</span><span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span><span class="p">),</span>
					       <span class="n">dma_int</span><span class="p">.</span><span class="n">u64</span><span class="p">);</span>

				<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">delayed_finish</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">handled</span> <span class="o">|=</span> <span class="n">octeon_cf_dma_finished</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_delayed_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">octeon_cf_port</span> <span class="o">*</span><span class="n">cf_port</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
						      <span class="k">struct</span> <span class="n">octeon_cf_port</span><span class="p">,</span>
						      <span class="n">delayed_finish</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the port is not waiting for completion, it must have</span>
<span class="cm">	 * handled it previously.  The hsm_task_state is</span>
<span class="cm">	 * protected by host-&gt;lock.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">hsm_task_state</span> <span class="o">!=</span> <span class="n">HSM_ST_LAST</span> <span class="o">||</span> <span class="o">!</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">dma_finished</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Still busy, try again. */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">delayed_finish</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">active_tag</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_POLLING</span><span class="p">))</span>
		<span class="n">octeon_cf_dma_finished</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">octeon_cf_dev_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * A maximum of 2^20 - 1 16 bit transfers are possible with</span>
<span class="cm">	 * the bootbus DMA.  So we need to throttle max_sectors to</span>
<span class="cm">	 * (2^12 - 1 == 4095) to assure that this can never happen.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_sectors</span><span class="p">,</span> <span class="mi">4095U</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We don&#39;t do ATAPI DMA so return 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">octeon_cf_check_atapi_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">octeon_cf_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATA_PROT_DMA</span>:
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_POLLING</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">sff_tf_load</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>  <span class="cm">/* load tf registers */</span>
		<span class="n">octeon_cf_dma_setup</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>	    <span class="cm">/* set up dma */</span>
		<span class="n">octeon_cf_dma_start</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>	    <span class="cm">/* initiate dma */</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">hsm_task_state</span> <span class="o">=</span> <span class="n">HSM_ST_LAST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATAPI_PROT_DMA</span>:
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error, ATAPI not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">ata_sff_qc_issue</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">octeon_cf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ata_sff_port_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_atapi_dma</span>	<span class="o">=</span> <span class="n">octeon_cf_check_atapi_dma</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_prep</span>		<span class="o">=</span> <span class="n">ata_noop_qc_prep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_issue</span>		<span class="o">=</span> <span class="n">octeon_cf_qc_issue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_dev_select</span>		<span class="o">=</span> <span class="n">octeon_cf_dev_select</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_irq_on</span>		<span class="o">=</span> <span class="n">octeon_cf_irq_on</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sff_irq_clear</span>		<span class="o">=</span> <span class="n">octeon_cf_irq_clear</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cable_detect</span>		<span class="o">=</span> <span class="n">ata_cable_40wire</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_piomode</span>		<span class="o">=</span> <span class="n">octeon_cf_set_piomode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_dmamode</span>		<span class="o">=</span> <span class="n">octeon_cf_set_dmamode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_config</span>		<span class="o">=</span> <span class="n">octeon_cf_dev_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">octeon_cf_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_cs0</span><span class="p">,</span> <span class="o">*</span><span class="n">res_cs1</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cs0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">cs1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">octeon_cf_data</span> <span class="o">*</span><span class="n">ocd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">irq_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">octeon_cf_port</span> <span class="o">*</span><span class="n">cf_port</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">version</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">res_cs0</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cs0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ocd</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">cs0</span> <span class="o">=</span> <span class="n">devm_ioremap_nocache</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res_cs0</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
				   <span class="n">resource_size</span><span class="p">(</span><span class="n">res_cs0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Determine from availability of DMA if True IDE mode or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">dma_engine</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res_cs1</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_cs1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">cs1</span> <span class="o">=</span> <span class="n">devm_ioremap_nocache</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">res_cs1</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
					   <span class="n">resource_size</span><span class="p">(</span><span class="n">res_cs1</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cf_port</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cf_port</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf_port</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* allocate host */</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">ata_host_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_cf_port</span><span class="p">;</span>

	<span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">cf_port</span><span class="p">;</span>
	<span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ap</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">octeon_cf_ops</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">pio_mask</span> <span class="o">=</span> <span class="n">ATA_PIO6</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_NO_ATAPI</span> <span class="o">|</span> <span class="n">ATA_FLAG_PIO_POLLING</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">cs0</span> <span class="o">+</span> <span class="n">ocd</span><span class="o">-&gt;</span><span class="n">base_region_bias</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">is16bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">cmd_addr</span>	<span class="o">=</span> <span class="n">base</span><span class="p">;</span>
		<span class="n">ata_sff_std_ports</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">;</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">sff_data_xfer</span> <span class="o">=</span> <span class="n">octeon_cf_data_xfer8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Presence of cs1 indicates True IDE mode.  */</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">cmd_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_CMD</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_DATA</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">error_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_ERR</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">feature_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_FEATURE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">nsect_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_NSECT</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbal_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAL</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbam_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAM</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbah_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_LBAH</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">device_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_DEVICE</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">status_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_STATUS</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">command_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">ATA_REG_CMD</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span> <span class="o">=</span> <span class="n">cs1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span>	<span class="o">=</span> <span class="n">cs1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">sff_data_xfer</span> <span class="o">=</span> <span class="n">octeon_cf_data_xfer16</span><span class="p">;</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">mwdma_mask</span>	<span class="o">=</span> <span class="n">ATA_MWDMA4</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">irq_handler</span> <span class="o">=</span> <span class="n">octeon_cf_interrupt</span><span class="p">;</span>

		<span class="cm">/* True IDE mode needs delayed work to poll for not-busy.  */</span>
		<span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">free_cf_port</span><span class="p">;</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf_port</span><span class="o">-&gt;</span><span class="n">delayed_finish</span><span class="p">,</span>
				  <span class="n">octeon_cf_delayed_finish</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* 16 bit but not True IDE */</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">sff_data_xfer</span>	<span class="o">=</span> <span class="n">octeon_cf_data_xfer16</span><span class="p">;</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">softreset</span>		<span class="o">=</span> <span class="n">octeon_cf_softreset16</span><span class="p">;</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">sff_check_status</span>	<span class="o">=</span> <span class="n">octeon_cf_check_status16</span><span class="p">;</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">sff_tf_read</span>	<span class="o">=</span> <span class="n">octeon_cf_tf_read16</span><span class="p">;</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">sff_tf_load</span>	<span class="o">=</span> <span class="n">octeon_cf_tf_load16</span><span class="p">;</span>
		<span class="n">octeon_cf_ops</span><span class="p">.</span><span class="n">sff_exec_command</span>	<span class="o">=</span> <span class="n">octeon_cf_exec_command16</span><span class="p">;</span>

		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">data_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ATA_REG_DATA</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">nsect_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ATA_REG_NSECT</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">lbal_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ATA_REG_LBAL</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span>	<span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">;</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">altstatus_addr</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="mh">0xe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ata_port_desc</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;cmd %p ctl %p&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">.</span><span class="n">ctl_addr</span><span class="p">);</span>


	<span class="n">snprintf</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">version</span><span class="p">),</span> <span class="s">&quot;%s %d bit%s&quot;</span><span class="p">,</span>
		 <span class="n">DRV_VERSION</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">ocd</span><span class="o">-&gt;</span><span class="n">is16bit</span><span class="p">)</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">cs1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;, True IDE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">ata_print_version_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ata_host_activate</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">octeon_cf_sht</span><span class="p">);</span>

<span class="nl">free_cf_port:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cf_port</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">octeon_cf_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">octeon_cf_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">octeon_cf_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">octeon_cf_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Daney &lt;ddaney@caviumnetworks.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;low-level driver for Cavium OCTEON Compact Flash PATA&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">DRV_NAME</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">octeon_cf_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
