<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › ata › libahci.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>libahci.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  libahci.c - Common AHCI SATA low-level routines</span>
<span class="cm"> *</span>
<span class="cm"> *  Maintained by:  Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> *    		    Please ALWAYS copy linux-ide@vger.kernel.org</span>
<span class="cm"> *		    on emails.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright 2004-2005 Red Hat, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2, or (at your option)</span>
<span class="cm"> *  any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * libata documentation is available via &#39;make {ps|pdf}docs&#39;,</span>
<span class="cm"> * as Documentation/DocBook/libata.*</span>
<span class="cm"> *</span>
<span class="cm"> * AHCI hardware documentation:</span>
<span class="cm"> * http://www.intel.com/technology/serialata/pdf/rev1_0.pdf</span>
<span class="cm"> * http://www.intel.com/technology/serialata/pdf/rev1_1.pdf</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_cmnd.h&gt;</span>
<span class="cp">#include &lt;linux/libata.h&gt;</span>
<span class="cp">#include &quot;ahci.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_skip_host_reset</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">ahci_ignore_sss</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_ignore_sss</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">skip_host_reset</span><span class="p">,</span> <span class="n">ahci_skip_host_reset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">skip_host_reset</span><span class="p">,</span> <span class="s">&quot;skip global host reset (0=don&#39;t skip, 1=skip)&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">ignore_sss</span><span class="p">,</span> <span class="n">ahci_ignore_sss</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ignore_sss</span><span class="p">,</span> <span class="s">&quot;Ignore staggered spinup flag (0=don&#39;t ignore, 1=ignore)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_set_lpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ata_lpm_policy</span> <span class="n">policy</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">hints</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_led_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_led_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_transmit_led_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">state</span><span class="p">,</span>
					<span class="kt">ssize_t</span> <span class="n">size</span><span class="p">);</span>



<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ahci_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ahci_qc_fill_rtf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_port_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_qc_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_pmp_qc_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_enable_fbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_disable_fbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_pmp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_pmp_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_softreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_pmp_retry_softreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_postreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_post_internal_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_dev_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ahci_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_activity_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_activity_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">sw_activity</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ahci_init_sw_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_show_host_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_show_host_cap2</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_show_host_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_show_port_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_read_em_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_store_em_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ahci_show_em_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ahci_host_caps</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ahci_show_host_caps</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ahci_host_cap2</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ahci_show_host_cap2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ahci_host_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ahci_show_host_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ahci_port_cmd</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ahci_show_port_cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">em_buffer</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">ahci_read_em_buffer</span><span class="p">,</span> <span class="n">ahci_store_em_buffer</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">em_message_supported</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">ahci_show_em_supported</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">ahci_shost_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_link_power_management_policy</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_em_message_type</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_em_message</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ahci_host_caps</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ahci_host_cap2</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ahci_host_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ahci_port_cmd</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_em_buffer</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_em_message_supported</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_shost_attrs</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">ahci_sdev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_sw_activity</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_unload_heads</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_sdev_attrs</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">ahci_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sata_pmp_port_ops</span><span class="p">,</span>

	<span class="p">.</span><span class="n">qc_defer</span>		<span class="o">=</span> <span class="n">ahci_pmp_qc_defer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_prep</span>		<span class="o">=</span> <span class="n">ahci_qc_prep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_issue</span>		<span class="o">=</span> <span class="n">ahci_qc_issue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">qc_fill_rtf</span>		<span class="o">=</span> <span class="n">ahci_qc_fill_rtf</span><span class="p">,</span>

	<span class="p">.</span><span class="n">freeze</span>			<span class="o">=</span> <span class="n">ahci_freeze</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span>			<span class="o">=</span> <span class="n">ahci_thaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">softreset</span>		<span class="o">=</span> <span class="n">ahci_softreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hardreset</span>		<span class="o">=</span> <span class="n">ahci_hardreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">postreset</span>		<span class="o">=</span> <span class="n">ahci_postreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pmp_softreset</span>		<span class="o">=</span> <span class="n">ahci_softreset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">error_handler</span>		<span class="o">=</span> <span class="n">ahci_error_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_internal_cmd</span>	<span class="o">=</span> <span class="n">ahci_post_internal_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_config</span>		<span class="o">=</span> <span class="n">ahci_dev_config</span><span class="p">,</span>

	<span class="p">.</span><span class="n">scr_read</span>		<span class="o">=</span> <span class="n">ahci_scr_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scr_write</span>		<span class="o">=</span> <span class="n">ahci_scr_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pmp_attach</span>		<span class="o">=</span> <span class="n">ahci_pmp_attach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pmp_detach</span>		<span class="o">=</span> <span class="n">ahci_pmp_detach</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_lpm</span>		<span class="o">=</span> <span class="n">ahci_set_lpm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">em_show</span>		<span class="o">=</span> <span class="n">ahci_led_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">em_store</span>		<span class="o">=</span> <span class="n">ahci_led_store</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_activity_show</span>	<span class="o">=</span> <span class="n">ahci_activity_show</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_activity_store</span>	<span class="o">=</span> <span class="n">ahci_activity_store</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">port_suspend</span>		<span class="o">=</span> <span class="n">ahci_port_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_resume</span>		<span class="o">=</span> <span class="n">ahci_port_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">port_start</span>		<span class="o">=</span> <span class="n">ahci_port_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">port_stop</span>		<span class="o">=</span> <span class="n">ahci_port_stop</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_ops</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ata_port_operations</span> <span class="n">ahci_pmp_retry_srst_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">inherits</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">ahci_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">softreset</span>		<span class="o">=</span> <span class="n">ahci_pmp_retry_softreset</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_pmp_retry_srst_ops</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ahci_em_messages</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_em_messages</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ahci_em_messages</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="cm">/* add other LED protocol types when they become supported */</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ahci_em_messages</span><span class="p">,</span>
	<span class="s">&quot;AHCI Enclosure Management Message control (0 = off, 1 = on)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_enable_ahci</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* turn on AHCI_EN */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HOST_AHCI_EN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Some controllers need AHCI_EN to be written multiple times.</span>
<span class="cm">	 * Try a few times before giving up.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">HOST_AHCI_EN</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>	<span class="cm">/* flush &amp;&amp; sanity check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HOST_AHCI_EN</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_show_host_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_show_host_cap2</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_show_host_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_VERSION</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_show_port_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_read_em_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">em_mmio</span> <span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_loc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">em_ctl</span><span class="p">,</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">em_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_EM</span><span class="p">)</span> <span class="o">||</span> <span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_XMT</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_msg_type</span> <span class="o">&amp;</span> <span class="n">EM_MSG_TYPE_SGPIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_MR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_SMB</span><span class="p">))</span>
		<span class="n">em_mmio</span> <span class="o">+=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_buf_sz</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_buf_sz</span><span class="p">;</span>

	<span class="cm">/* the count should not be larger than PAGE_SIZE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_ratelimit</span><span class="p">())</span>
			<span class="n">ata_port_warn</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
				      <span class="s">&quot;EM read buffer size too large: &quot;</span>
				      <span class="s">&quot;buffer size %u, page size %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_buf_sz</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">em_mmio</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_store_em_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">em_mmio</span> <span class="o">=</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_loc</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">em_ctl</span><span class="p">,</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* check size validity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_EM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_msg_type</span> <span class="o">&amp;</span> <span class="n">EM_MSG_TYPE_SGPIO</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">size</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_buf_sz</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">em_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_TM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">msg_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">msg_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
		      <span class="n">msg_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">msg_buf</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">em_mmio</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">em_ctl</span> <span class="o">|</span> <span class="n">EM_CTL_TM</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_show_em_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">shost</span> <span class="o">=</span> <span class="n">class_to_shost</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">ata_shost_to_port</span><span class="p">(</span><span class="n">shost</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">em_ctl</span><span class="p">;</span>

	<span class="n">em_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_LED</span> <span class="o">?</span> <span class="s">&quot;led &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_SAFTE</span> <span class="o">?</span> <span class="s">&quot;saf-te &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_SES</span> <span class="o">?</span> <span class="s">&quot;ses-2 &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		       <span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_SGPIO</span> <span class="o">?</span> <span class="s">&quot;sgpio &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *	ahci_save_initial_config - Save and fixup initial config values</span>
<span class="cm"> *	@dev: target AHCI device</span>
<span class="cm"> *	@hpriv: host private area to store config values</span>
<span class="cm"> *	@force_port_map: force port map to a specified value</span>
<span class="cm"> *	@mask_port_map: mask out particular bits from port map</span>
<span class="cm"> *</span>
<span class="cm"> *	Some registers containing configuration info might be setup by</span>
<span class="cm"> *	BIOS and might be cleared on reset.  This function saves the</span>
<span class="cm"> *	initial values of those registers into @hpriv such that they</span>
<span class="cm"> *	can be restored after controller reset.</span>
<span class="cm"> *</span>
<span class="cm"> *	If inconsistent, config values are fixed up by this function.</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ahci_save_initial_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">force_port_map</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask_port_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap</span><span class="p">,</span> <span class="n">cap2</span><span class="p">,</span> <span class="n">vers</span><span class="p">,</span> <span class="n">port_map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* make sure AHCI mode is enabled before accessing CAP */</span>
	<span class="n">ahci_enable_ahci</span><span class="p">(</span><span class="n">mmio</span><span class="p">);</span>

	<span class="cm">/* Values prefixed with saved_ are written back to host after</span>
<span class="cm">	 * reset.  Values without are used for driver operation.</span>
<span class="cm">	 */</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_cap</span> <span class="o">=</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CAP</span><span class="p">);</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_port_map</span> <span class="o">=</span> <span class="n">port_map</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_PORTS_IMPL</span><span class="p">);</span>

	<span class="cm">/* CAP2 register is only defined for AHCI 1.2 and later */</span>
	<span class="n">vers</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vers</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span>
	   <span class="p">((</span><span class="n">vers</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vers</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x200</span><span class="p">))</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_cap2</span> <span class="o">=</span> <span class="n">cap2</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CAP2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_cap2</span> <span class="o">=</span> <span class="n">cap2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* some chips have errata preventing 64bit use */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_64</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_32BIT_ONLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller can&#39;t do 64bit DMA, forcing 32bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HOST_CAP_64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_NCQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_NO_NCQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller can&#39;t do NCQ, turning off CAP_NCQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HOST_CAP_NCQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_NCQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_YES_NCQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller can do NCQ, turning on CAP_NCQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cap</span> <span class="o">|=</span> <span class="n">HOST_CAP_NCQ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_PMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_NO_PMP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller can&#39;t do PMP, turning off CAP_PMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HOST_CAP_PMP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SNTF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_NO_SNTF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;controller can&#39;t do SNTF, turning off CAP_SNTF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HOST_CAP_SNTF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_FBS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_YES_FBS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller can do FBS, turning on CAP_FBS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cap</span> <span class="o">|=</span> <span class="n">HOST_CAP_FBS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force_port_map</span> <span class="o">&amp;&amp;</span> <span class="n">port_map</span> <span class="o">!=</span> <span class="n">force_port_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forcing port_map 0x%x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">port_map</span><span class="p">,</span> <span class="n">force_port_map</span><span class="p">);</span>
		<span class="n">port_map</span> <span class="o">=</span> <span class="n">force_port_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask_port_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;masking port_map 0x%x -&gt; 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">port_map</span><span class="p">,</span>
			<span class="n">port_map</span> <span class="o">&amp;</span> <span class="n">mask_port_map</span><span class="p">);</span>
		<span class="n">port_map</span> <span class="o">&amp;=</span> <span class="n">mask_port_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* cross check port_map and cap.n_ports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">map_ports</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AHCI_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">map_ports</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* If PI has more ports than n_ports, whine, clear</span>
<span class="cm">		 * port_map and let it be generated from n_ports.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map_ports</span> <span class="o">&gt;</span> <span class="n">ahci_nr_ports</span><span class="p">(</span><span class="n">cap</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;implemented port map (0x%x) contains more ports than nr_ports (%u), using nr_ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">port_map</span><span class="p">,</span> <span class="n">ahci_nr_ports</span><span class="p">(</span><span class="n">cap</span><span class="p">));</span>
			<span class="n">port_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* fabricate port_map from cap.nr_ports */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port_map</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ahci_nr_ports</span><span class="p">(</span><span class="n">cap</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;forcing PORTS_IMPL to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port_map</span><span class="p">);</span>

		<span class="cm">/* write the fixed up value to the PI register */</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_port_map</span> <span class="o">=</span> <span class="n">port_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* record values to use during operation */</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap2</span> <span class="o">=</span> <span class="n">cap2</span><span class="p">;</span>
	<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span> <span class="o">=</span> <span class="n">port_map</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_save_initial_config</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> *	ahci_restore_initial_config - Restore initial config</span>
<span class="cm"> *	@host: target ATA host</span>
<span class="cm"> *</span>
<span class="cm"> *	Restore initial config stored by ahci_save_initial_config().</span>
<span class="cm"> *</span>
<span class="cm"> *	LOCKING:</span>
<span class="cm"> *	None.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_restore_initial_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_cap</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_cap2</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_cap2</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CAP2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">saved_port_map</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_PORTS_IMPL</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_PORTS_IMPL</span><span class="p">);</span>	<span class="cm">/* flush */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">ahci_scr_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">SCR_STATUS</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PORT_SCR_STAT</span><span class="p">,</span>
		<span class="p">[</span><span class="n">SCR_CONTROL</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PORT_SCR_CTL</span><span class="p">,</span>
		<span class="p">[</span><span class="n">SCR_ERROR</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PORT_SCR_ERR</span><span class="p">,</span>
		<span class="p">[</span><span class="n">SCR_ACTIVE</span><span class="p">]</span>		<span class="o">=</span> <span class="n">PORT_SCR_ACT</span><span class="p">,</span>
		<span class="p">[</span><span class="n">SCR_NOTIFICATION</span><span class="p">]</span>	<span class="o">=</span> <span class="n">PORT_SCR_NTF</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc_reg</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sc_reg</span> <span class="o">!=</span> <span class="n">SCR_NOTIFICATION</span> <span class="o">||</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SNTF</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">offset</span><span class="p">[</span><span class="n">sc_reg</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_scr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ahci_scr_offset</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">sc_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_scr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sc_reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ahci_scr_offset</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">sc_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ahci_start_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* start DMA */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PORT_CMD_START</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span> <span class="cm">/* flush */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_start_engine</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ahci_stop_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

	<span class="cm">/* check if the HBA is idle */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_CMD_START</span> <span class="o">|</span> <span class="n">PORT_CMD_LIST_ON</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* setting HBA to idle */</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_CMD_START</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

	<span class="cm">/* wait for engine to stop. This could be as long as 500 msec */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ata_wait_register</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">,</span>
				<span class="n">PORT_CMD_LIST_ON</span><span class="p">,</span> <span class="n">PORT_CMD_LIST_ON</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PORT_CMD_LIST_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_stop_engine</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_start_fis_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* set FIS registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_64</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		       <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_LST_ADDR_HI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_LST_ADDR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_64</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		       <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FIS_ADDR_HI</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FIS_ADDR</span><span class="p">);</span>

	<span class="cm">/* enable FIS reception */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PORT_CMD_FIS_RX</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

	<span class="cm">/* flush */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_stop_fis_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* disable FIS reception */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_CMD_FIS_RX</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

	<span class="cm">/* wait for completion, spec says 500ms, give it 1000 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ata_wait_register</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">,</span> <span class="n">PORT_CMD_FIS_ON</span><span class="p">,</span>
				<span class="n">PORT_CMD_FIS_ON</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PORT_CMD_FIS_ON</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_power_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_CMD_ICC_MASK</span><span class="p">;</span>

	<span class="cm">/* spin up device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PORT_CMD_SPIN_UP</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wake up link */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span> <span class="o">|</span> <span class="n">PORT_CMD_ICC_ACTIVE</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_set_lpm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ata_lpm_policy</span> <span class="n">policy</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span> <span class="o">!=</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable interrupts on Phy Ready. This keeps us from</span>
<span class="cm">		 * getting woken up due to spurious phy ready</span>
<span class="cm">		 * interrupts.</span>
<span class="cm">		 */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_IRQ_PHYRDY</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>

		<span class="n">sata_link_scr_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_ALPM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">policy</span> <span class="o">==</span> <span class="n">ATA_LPM_MAX_POWER</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">hints</span> <span class="o">&amp;</span> <span class="n">ATA_LPM_HIPM</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_CMD_ASP</span> <span class="o">|</span> <span class="n">PORT_CMD_ALPE</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PORT_CMD_ICC_ACTIVE</span><span class="p">;</span>

			<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

			<span class="cm">/* wait 10ms to be sure we&#39;ve come out of LPM state */</span>
			<span class="n">ata_msleep</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PORT_CMD_ALPE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">policy</span> <span class="o">==</span> <span class="n">ATA_LPM_MIN_POWER</span><span class="p">)</span>
				<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PORT_CMD_ASP</span><span class="p">;</span>

			<span class="cm">/* write out new cmd value */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span> <span class="o">==</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sata_link_scr_lpm</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* turn PHYRDY IRQ back on */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">|=</span> <span class="n">PORT_IRQ_PHYRDY</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">scontrol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SSS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* put device into listen mode, first set PxSCTL.DET to 0 */</span>
	<span class="n">scontrol</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SCR_CTL</span><span class="p">);</span>
	<span class="n">scontrol</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">scontrol</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SCR_CTL</span><span class="p">);</span>

	<span class="cm">/* then set PxCMD.SUD to 0 */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_CMD_ICC_MASK</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_CMD_SPIN_UP</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_start_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* enable FIS reception */</span>
	<span class="n">ahci_start_fis_rx</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* enable DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_DELAY_ENGINE</span><span class="p">))</span>
		<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* turn on LEDs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_EM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">];</span>

			<span class="cm">/* EM Transmit bit maybe busy during init */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EM_MAX_RETRY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_transmit_led_message</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span>
							       <span class="n">emp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span>
							       <span class="mi">4</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
					<span class="n">ata_msleep</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_FLAG_SW_ACTIVITY</span><span class="p">)</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
			<span class="n">ahci_init_sw_activity</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_deinit_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">emsg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* disable DMA */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">emsg</span> <span class="o">=</span> <span class="s">&quot;failed to stop engine&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable FIS reception */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_stop_fis_rx</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">emsg</span> <span class="o">=</span> <span class="s">&quot;failed stop FIS RX&quot;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ahci_reset_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* we must be in AHCI mode, before using anything</span>
<span class="cm">	 * AHCI-specific, such as HOST_RESET.</span>
<span class="cm">	 */</span>
	<span class="n">ahci_enable_ahci</span><span class="p">(</span><span class="n">mmio</span><span class="p">);</span>

	<span class="cm">/* global controller reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ahci_skip_host_reset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HOST_RESET</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">HOST_RESET</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
			<span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span> <span class="cm">/* flush */</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * to perform host reset, OS should set HOST_RESET</span>
<span class="cm">		 * and poll until this bit is read to be &quot;0&quot;.</span>
<span class="cm">		 * reset must complete within 1 second, or</span>
<span class="cm">		 * the hardware should be considered fried.</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ata_wait_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">,</span> <span class="n">HOST_RESET</span><span class="p">,</span>
					<span class="n">HOST_RESET</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">HOST_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;controller reset failed (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tmp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* turn on AHCI mode */</span>
		<span class="n">ahci_enable_ahci</span><span class="p">(</span><span class="n">mmio</span><span class="p">);</span>

		<span class="cm">/* Some registers might be cleared on reset.  Restore</span>
<span class="cm">		 * initial values.</span>
<span class="cm">		 */</span>
		<span class="n">ahci_restore_initial_config</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;skipping global host reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_reset_controller</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_sw_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_LFLAG_SW_ACTIVITY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">emp</span><span class="o">-&gt;</span><span class="n">activity</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_sw_activity_blink</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">led_message</span> <span class="o">=</span> <span class="n">emp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">activity_led_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">led_message</span> <span class="o">&amp;=</span> <span class="n">EM_MSG_LED_VALUE</span><span class="p">;</span>
	<span class="n">led_message</span> <span class="o">|=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">|</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* check to see if we&#39;ve had activity.  If so,</span>
<span class="cm">	 * toggle state of LED and reset timer.  If not,</span>
<span class="cm">	 * turn LED to desired idle state.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">saved_activity</span> <span class="o">!=</span> <span class="n">emp</span><span class="o">-&gt;</span><span class="n">activity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emp</span><span class="o">-&gt;</span><span class="n">saved_activity</span> <span class="o">=</span> <span class="n">emp</span><span class="o">-&gt;</span><span class="n">activity</span><span class="p">;</span>
		<span class="cm">/* get the current LED state */</span>
		<span class="n">activity_led_state</span> <span class="o">=</span> <span class="n">led_message</span> <span class="o">&amp;</span> <span class="n">EM_MSG_LED_VALUE_ON</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">activity_led_state</span><span class="p">)</span>
			<span class="n">activity_led_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">activity_led_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* clear old state */</span>
		<span class="n">led_message</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EM_MSG_LED_VALUE_ACTIVITY</span><span class="p">;</span>

		<span class="cm">/* toggle state */</span>
		<span class="n">led_message</span> <span class="o">|=</span> <span class="p">(</span><span class="n">activity_led_state</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* switch to idle */</span>
		<span class="n">led_message</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EM_MSG_LED_VALUE_ACTIVITY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">blink_policy</span> <span class="o">==</span> <span class="n">BLINK_OFF</span><span class="p">)</span>
			<span class="n">led_message</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ahci_transmit_led_message</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">led_message</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_init_sw_activity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">];</span>

	<span class="cm">/* init activity stats, setup timer */</span>
	<span class="n">emp</span><span class="o">-&gt;</span><span class="n">saved_activity</span> <span class="o">=</span> <span class="n">emp</span><span class="o">-&gt;</span><span class="n">activity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">ahci_sw_activity_blink</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">link</span><span class="p">);</span>

	<span class="cm">/* check our blink policy and set flag for link if it&#39;s enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">blink_policy</span><span class="p">)</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_SW_ACTIVITY</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ahci_reset_em</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">em_ctl</span><span class="p">;</span>

	<span class="n">em_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_TM</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_RST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">em_ctl</span> <span class="o">|</span> <span class="n">EM_CTL_RST</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_reset_em</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_transmit_led_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">state</span><span class="p">,</span>
					<span class="kt">ssize_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">em_ctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">message</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span><span class="p">;</span>

	<span class="cm">/* get the slot number from the message */</span>
	<span class="n">pmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">EM_MSG_LED_PMP_SLOT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmp</span> <span class="o">&lt;</span> <span class="n">EM_MAX_SLOTS</span><span class="p">)</span>
		<span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">pmp</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if we are still busy transmitting a previous message,</span>
<span class="cm">	 * do not allow</span>
<span class="cm">	 */</span>
	<span class="n">em_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_TM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_msg_type</span> <span class="o">&amp;</span> <span class="n">EM_MSG_TYPE_LED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * create message header - this is all zero except for</span>
<span class="cm">		 * the message size, which is 4 bytes.</span>
<span class="cm">		 */</span>
		<span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/* ignore 0:4 of byte zero, fill in port info yourself */</span>
		<span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EM_MSG_LED_HBA_PORT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">);</span>

		<span class="cm">/* write message to EM_LOC */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_loc</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_loc</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * tell hardware to transmit the message</span>
<span class="cm">		 */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">em_ctl</span> <span class="o">|</span> <span class="n">EM_CTL_TM</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* save off new led state for port/slot */</span>
	<span class="n">emp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_led_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">];</span>
		<span class="n">rc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_led_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* get the slot number from the message */</span>
	<span class="n">pmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">EM_MSG_LED_PMP_SLOT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pmp</span> <span class="o">&lt;</span> <span class="n">EM_MAX_SLOTS</span><span class="p">)</span>
		<span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">pmp</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* mask off the activity bits if we are in sw_activity</span>
<span class="cm">	 * mode, user should turn off sw_activity before setting</span>
<span class="cm">	 * activity led through em_message</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emp</span><span class="o">-&gt;</span><span class="n">blink_policy</span><span class="p">)</span>
		<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EM_MSG_LED_VALUE_ACTIVITY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ahci_transmit_led_message</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_activity_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sw_activity</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">port_led_state</span> <span class="o">=</span> <span class="n">emp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">;</span>

	<span class="cm">/* save the desired Activity LED behavior */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear LFLAG */</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ATA_LFLAG_SW_ACTIVITY</span><span class="p">);</span>

		<span class="cm">/* set the LED to OFF */</span>
		<span class="n">port_led_state</span> <span class="o">&amp;=</span> <span class="n">EM_MSG_LED_VALUE_OFF</span><span class="p">;</span>
		<span class="n">port_led_state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">|</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">ahci_transmit_led_message</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">port_led_state</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_LFLAG_SW_ACTIVITY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">BLINK_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set LED to ON for idle */</span>
			<span class="n">port_led_state</span> <span class="o">&amp;=</span> <span class="n">EM_MSG_LED_VALUE_OFF</span><span class="p">;</span>
			<span class="n">port_led_state</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span> <span class="o">|</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">port_led_state</span> <span class="o">|=</span> <span class="n">EM_MSG_LED_VALUE_ON</span><span class="p">;</span> <span class="cm">/* check this */</span>
			<span class="n">ahci_transmit_led_message</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">port_led_state</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">emp</span><span class="o">-&gt;</span><span class="n">blink_policy</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ahci_activity_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_em_priv</span> <span class="o">*</span><span class="n">emp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">em_priv</span><span class="p">[</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">];</span>

	<span class="cm">/* display the saved value of activity behavior for this</span>
<span class="cm">	 * disk.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emp</span><span class="o">-&gt;</span><span class="n">blink_policy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_port_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">port_no</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">emsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* make sure port is not active */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_deinit_port</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emsg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emsg</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* clear SError */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SCR_ERR</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;PORT_SCR_ERR 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SCR_ERR</span><span class="p">);</span>

	<span class="cm">/* clear port IRQ */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;PORT_IRQ_STAT 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">port_no</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_IRQ_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ahci_init_controller</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ata_port_is_dummy</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ahci_port_init</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">mmio</span><span class="p">,</span> <span class="n">port_mmio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;HOST_CTL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span> <span class="o">|</span> <span class="n">HOST_IRQ_EN</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_CTL</span><span class="p">);</span>
	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;HOST_CTL 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_init_controller</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_dev_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_SECT255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="n">ata_dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			     <span class="s">&quot;SB600 AHCI: limiting to 255 sectors per cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ahci_dev_classify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SIG</span><span class="p">);</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">lbah</span>		<span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span>	<span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">lbam</span>		<span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>	<span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">lbal</span>		<span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>	<span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">nsect</span>	<span class="o">=</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span>		<span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ata_dev_classify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ahci_fill_cmd_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tag</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">cmd_tbl_dma</span><span class="p">;</span>

	<span class="n">cmd_tbl_dma</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_tbl_dma</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">*</span> <span class="n">AHCI_CMD_TBL_SZ</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">opts</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">opts</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">tbl_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd_tbl_dma</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot</span><span class="p">[</span><span class="n">tag</span><span class="p">].</span><span class="n">tbl_addr_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">cmd_tbl_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_fill_cmd_slot</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ahci_kick_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_TFDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busy</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* stop engine */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_restart</span><span class="p">;</span>

	<span class="cm">/* need to do CLO?</span>
<span class="cm">	 * always do CLO if PMP is attached (AHCI-1.3 9.2)</span>
<span class="cm">	 */</span>
	<span class="n">busy</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATA_BUSY</span> <span class="o">|</span> <span class="n">ATA_DRQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">busy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_CLO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* perform CLO */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">PORT_CMD_CLO</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ata_wait_register</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">,</span>
				<span class="n">PORT_CMD_CLO</span><span class="p">,</span> <span class="n">PORT_CMD_CLO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">PORT_CMD_CLO</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* restart engine */</span>
 <span class="nl">out_restart:</span>
	<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_kick_engine</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_exec_polled_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pmp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="o">*</span><span class="n">tf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flags</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout_msec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">cmd_fis_len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* five dwords */</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fis</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* prep the command */</span>
	<span class="n">ata_tf_to_fis</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="n">is_cmd</span><span class="p">,</span> <span class="n">fis</span><span class="p">);</span>
	<span class="n">ahci_fill_cmd_slot</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd_fis_len</span> <span class="o">|</span> <span class="n">flags</span> <span class="o">|</span> <span class="p">(</span><span class="n">pmp</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>

	<span class="cm">/* issue &amp; wait */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD_ISSUE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout_msec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ata_wait_register</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD_ISSUE</span><span class="p">,</span>
					<span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timeout_msec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahci_kick_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD_ISSUE</span><span class="p">);</span>	<span class="cm">/* flush */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ahci_do_softreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">pmp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">check_ready</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span><span class="p">,</span> <span class="n">msecs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* prepare for SRST (AHCI-1.1 10.4.1) */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_kick_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">)</span>
		<span class="n">ata_link_warn</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;failed to reset engine (errno=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>

	<span class="cm">/* issue the first D2H Register FIS */</span>
	<span class="n">msecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="n">now</span><span class="p">))</span>
		<span class="n">msecs</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">deadline</span> <span class="o">-</span> <span class="n">now</span><span class="p">);</span>

	<span class="n">tf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">|=</span> <span class="n">ATA_SRST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ahci_exec_polled_cmd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">AHCI_CMD_RESET</span> <span class="o">|</span> <span class="n">AHCI_CMD_CLR_BUSY</span><span class="p">,</span> <span class="n">msecs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;1st FIS failed&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* spec says at least 5us, but be generous and sleep for 1ms */</span>
	<span class="n">ata_msleep</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* issue the second D2H Register FIS */</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATA_SRST</span><span class="p">;</span>
	<span class="n">ahci_exec_polled_cmd</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* wait for link to become ready */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_wait_after_reset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span> <span class="n">check_ready</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">&amp;&amp;</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_SRST_TOUT_IS_OFFLINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Workaround for cases where link online status can&#39;t</span>
<span class="cm">		 * be trusted.  Treat device readiness timeout as link</span>
<span class="cm">		 * offline.</span>
<span class="cm">		 */</span>
		<span class="n">ata_link_info</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;device not ready, treating as offline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">ATA_DEV_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* link occupied, -ENODEV too is an error */</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;device not ready&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">ahci_dev_classify</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, class=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">class</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">ata_link_err</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="s">&quot;softreset failed (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ahci_check_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_TFDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ata_check_ready</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_check_ready</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_softreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pmp</span> <span class="o">=</span> <span class="n">sata_srst_pmp</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ahci_do_softreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span> <span class="n">ahci_check_ready</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_do_softreset</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_bad_pmp_check_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_TFDATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * There is no need to check TFDATA if BAD PMP is found due to HW bug,</span>
<span class="cm">	 * which can save timeout delay.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_BAD_PMP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ata_check_ready</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ahci_pmp_retry_softreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pmp</span> <span class="o">=</span> <span class="n">sata_srst_pmp</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_sts</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_do_softreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="n">pmp</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span>
			       <span class="n">ahci_bad_pmp_check_ready</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Soft reset fails with IPMS set when PMP is enabled but</span>
<span class="cm">	 * SATA HDD/ODD is connected to SATA port, do soft reset</span>
<span class="cm">	 * again to port 0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irq_sts</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_sts</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_BAD_PMP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ata_link_printk</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">KERN_WARNING</span><span class="p">,</span>
					<span class="s">&quot;applying PMP SRST workaround &quot;</span>
					<span class="s">&quot;and retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_do_softreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">class</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span>
					       <span class="n">ahci_check_ready</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_hardreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">deadline</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">timing</span> <span class="o">=</span> <span class="n">sata_ehc_deb_timing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_context</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">d2h_fis</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis</span> <span class="o">+</span> <span class="n">RX_FIS_D2H_REG</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_taskfile</span> <span class="n">tf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">online</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* clear D2H reception area to properly wait for D2H FIS */</span>
	<span class="n">ata_tf_init</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
	<span class="n">tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">ata_tf_to_fis</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d2h_fis</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sata_link_hardreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">timing</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">online</span><span class="p">,</span>
				 <span class="n">ahci_check_ready</span><span class="p">);</span>

	<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">online</span><span class="p">)</span>
		<span class="o">*</span><span class="n">class</span> <span class="o">=</span> <span class="n">ahci_dev_classify</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT, rc=%d, class=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">*</span><span class="n">class</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_postreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">new_tmp</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">ata_std_postreset</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>

	<span class="cm">/* Make sure port&#39;s ATAPI bit is set appropriately */</span>
	<span class="n">new_tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">class</span> <span class="o">==</span> <span class="n">ATA_DEV_ATAPI</span><span class="p">)</span>
		<span class="n">new_tmp</span> <span class="o">|=</span> <span class="n">PORT_CMD_ATAPI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_CMD_ATAPI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_tmp</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">new_tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ahci_fill_sg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cmd_tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_sg</span> <span class="o">*</span><span class="n">ahci_sg</span> <span class="o">=</span> <span class="n">cmd_tbl</span> <span class="o">+</span> <span class="n">AHCI_CMD_TBL_HDR_SZ</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Next, the S/G list.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_sg</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">sg</span><span class="p">,</span> <span class="n">sg</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">n_elem</span><span class="p">,</span> <span class="n">si</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">sg_len</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>

		<span class="n">ahci_sg</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
		<span class="n">ahci_sg</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">addr_hi</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ahci_sg</span><span class="p">[</span><span class="n">si</span><span class="p">].</span><span class="n">flags_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">si</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_pmp_qc_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">||</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ata_std_qc_defer</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sata_pmp_qc_defer_cmd_switch</span><span class="p">(</span><span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_qc_prep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_atapi</span> <span class="o">=</span> <span class="n">ata_is_atapi</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cmd_tbl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opts</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">cmd_fis_len</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* five dwords */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_elem</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in command table information.  First, the header,</span>
<span class="cm">	 * a SATA Register - Host to Device command FIS.</span>
<span class="cm">	 */</span>
	<span class="n">cmd_tbl</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_tbl</span> <span class="o">+</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">*</span> <span class="n">AHCI_CMD_TBL_SZ</span><span class="p">;</span>

	<span class="n">ata_tf_to_fis</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmd_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_atapi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">cmd_tbl</span> <span class="o">+</span> <span class="n">AHCI_CMD_TBL_CDB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_tbl</span> <span class="o">+</span> <span class="n">AHCI_CMD_TBL_CDB</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">cdb</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cdb_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">n_elem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_DMAMAP</span><span class="p">)</span>
		<span class="n">n_elem</span> <span class="o">=</span> <span class="n">ahci_fill_sg</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="n">cmd_tbl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in command slot information.</span>
<span class="cm">	 */</span>
	<span class="n">opts</span> <span class="o">=</span> <span class="n">cmd_fis_len</span> <span class="o">|</span> <span class="n">n_elem</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_TFLAG_WRITE</span><span class="p">)</span>
		<span class="n">opts</span> <span class="o">|=</span> <span class="n">AHCI_CMD_WRITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_atapi</span><span class="p">)</span>
		<span class="n">opts</span> <span class="o">|=</span> <span class="n">AHCI_CMD_ATAPI</span> <span class="o">|</span> <span class="n">AHCI_CMD_PREFETCH</span><span class="p">;</span>

	<span class="n">ahci_fill_cmd_slot</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">opts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_fbs_dec_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span><span class="p">);</span>

	<span class="cm">/* time to wait for DEC is not specified by AHCI spec,</span>
<span class="cm">	 * add a retry loop for safety.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">fbs</span> <span class="o">|</span> <span class="n">PORT_FBS_DEC</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="n">PORT_FBS_DEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">retries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="n">PORT_FBS_DEC</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to clear device error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_error_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irq_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">host_ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">active_qc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">active_ehi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fbs_need_dec</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">serror</span><span class="p">;</span>

	<span class="cm">/* determine active link with error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">pmp</span> <span class="o">=</span> <span class="n">fbs</span> <span class="o">&gt;&gt;</span> <span class="n">PORT_FBS_DWE_OFFSET</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="n">PORT_FBS_SDE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pmp</span> <span class="o">&lt;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nr_pmp_links</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ata_link_online</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pmp_link</span><span class="p">[</span><span class="n">pmp</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pmp_link</span><span class="p">[</span><span class="n">pmp</span><span class="p">];</span>
			<span class="n">fbs_need_dec</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ata_for_each_link</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">EDGE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ata_link_active</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span>
		<span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="n">active_qc</span> <span class="o">=</span> <span class="n">ata_qc_from_tag</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">active_tag</span><span class="p">);</span>
	<span class="n">active_ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">eh_info</span><span class="p">;</span>

	<span class="cm">/* record irq stat */</span>
	<span class="n">ata_ehi_clear_desc</span><span class="p">(</span><span class="n">host_ehi</span><span class="p">);</span>
	<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">host_ehi</span><span class="p">,</span> <span class="s">&quot;irq_stat 0x%08x&quot;</span><span class="p">,</span> <span class="n">irq_stat</span><span class="p">);</span>

	<span class="cm">/* AHCI needs SError cleared; otherwise, it might lock up */</span>
	<span class="n">ahci_scr_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">serror</span><span class="p">);</span>
	<span class="n">ahci_scr_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="n">serror</span><span class="p">);</span>
	<span class="n">host_ehi</span><span class="o">-&gt;</span><span class="n">serror</span> <span class="o">|=</span> <span class="n">serror</span><span class="p">;</span>

	<span class="cm">/* some controllers set IRQ_IF_ERR on device errors, ignore it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_IGN_IRQ_IF_ERR</span><span class="p">)</span>
		<span class="n">irq_stat</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_IRQ_IF_ERR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_TF_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If qc is active, charge it; otherwise, the active</span>
<span class="cm">		 * link.  There&#39;s no active qc on NCQ errors.  It will</span>
<span class="cm">		 * be determined by EH by reading log page 10h.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active_qc</span><span class="p">)</span>
			<span class="n">active_qc</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">active_ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_IGN_SERR_INTERNAL</span><span class="p">)</span>
			<span class="n">host_ehi</span><span class="o">-&gt;</span><span class="n">serror</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SERR_INTERNAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_UNK_FIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">unk</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis</span> <span class="o">+</span> <span class="n">RX_FIS_UNK</span><span class="p">);</span>

		<span class="n">active_ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
		<span class="n">active_ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">active_ehi</span><span class="p">,</span>
				  <span class="s">&quot;unknown FIS %08x %08x %08x %08x&quot;</span> <span class="p">,</span>
				  <span class="n">unk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">unk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">unk</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_BAD_PMP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">active_ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
		<span class="n">active_ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">active_ehi</span><span class="p">,</span> <span class="s">&quot;incorrect PMP&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_IRQ_HBUS_ERR</span> <span class="o">|</span> <span class="n">PORT_IRQ_HBUS_DATA_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">host_ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HOST_BUS</span><span class="p">;</span>
		<span class="n">host_ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">host_ehi</span><span class="p">,</span> <span class="s">&quot;host bus error&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_IF_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbs_need_dec</span><span class="p">)</span>
			<span class="n">active_ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_DEV</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">host_ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_ATA_BUS</span><span class="p">;</span>
			<span class="n">host_ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">host_ehi</span><span class="p">,</span> <span class="s">&quot;interface fatal error&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PORT_IRQ_CONNECT</span> <span class="o">|</span> <span class="n">PORT_IRQ_PHYRDY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_ehi_hotplugged</span><span class="p">(</span><span class="n">host_ehi</span><span class="p">);</span>
		<span class="n">ata_ehi_push_desc</span><span class="p">(</span><span class="n">host_ehi</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
			<span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_CONNECT</span> <span class="o">?</span>
			<span class="s">&quot;connection status changed&quot;</span> <span class="o">:</span> <span class="s">&quot;PHY RDY changed&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* okay, let&#39;s hand over to EH */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_FREEZE</span><span class="p">)</span>
		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fbs_need_dec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ata_link_abort</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
		<span class="n">ahci_fbs_dec_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ata_port_abort</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_port_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ata_eh_info</span> <span class="o">*</span><span class="n">ehi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">eh_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resetting</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_RESETTING</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">qc_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>

	<span class="cm">/* ignore BAD_PMP while resetting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">resetting</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_IRQ_BAD_PMP</span><span class="p">;</span>

	<span class="cm">/* if LPM is enabled, PHYRDY doesn&#39;t mean anything */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">lpm_policy</span> <span class="o">&gt;</span> <span class="n">ATA_LPM_MAX_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_IRQ_PHYRDY</span><span class="p">;</span>
		<span class="n">ahci_scr_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">SCR_ERROR</span><span class="p">,</span> <span class="n">SERR_PHYRDY_CHG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_ERROR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ahci_error_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">PORT_IRQ_SDB_FIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If SNotification is available, leave notification</span>
<span class="cm">		 * handling to sata_async_notification().  If not,</span>
<span class="cm">		 * emulate it by snooping SDB FIS RX area.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Snooping FIS RX area is probably cheaper than</span>
<span class="cm">		 * poking SNotification but some constrollers which</span>
<span class="cm">		 * implement SNotification, ICH9 for example, don&#39;t</span>
<span class="cm">		 * store AN SDB FIS into receive area.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SNTF</span><span class="p">)</span>
			<span class="n">sata_async_notification</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If the &#39;N&#39; bit in word 0 of the FIS is set,</span>
<span class="cm">			 * we just received asynchronous notification.</span>
<span class="cm">			 * Tell libata about it.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Lack of SNotification should not appear in</span>
<span class="cm">			 * ahci 1.2, so the workaround is unnecessary</span>
<span class="cm">			 * when FBS is enabled.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span><span class="p">)</span>
				<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">const</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis</span> <span class="o">+</span> <span class="n">RX_FIS_SDB</span><span class="p">;</span>
				<span class="n">u32</span> <span class="n">f0</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">f0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">))</span>
					<span class="n">sata_async_notification</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* pp-&gt;active_link is not reliable once FBS is enabled, both</span>
<span class="cm">	 * PORT_SCR_ACT and PORT_CMD_ISSUE should be checked because</span>
<span class="cm">	 * NCQ and non-NCQ commands may be in flight at the same time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">qc_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qc_active</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SCR_ACT</span><span class="p">);</span>
			<span class="n">qc_active</span> <span class="o">|=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD_ISSUE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* pp-&gt;active_link is valid iff any command is in flight */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">qc_active</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">active_link</span><span class="o">-&gt;</span><span class="n">sactive</span><span class="p">)</span>
			<span class="n">qc_active</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SCR_ACT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">qc_active</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD_ISSUE</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">rc</span> <span class="o">=</span> <span class="n">ata_qc_complete_multiple</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">qc_active</span><span class="p">);</span>

	<span class="cm">/* while resetting, invalid completions are expected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">resetting</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">err_mask</span> <span class="o">|=</span> <span class="n">AC_ERR_HSM</span><span class="p">;</span>
		<span class="n">ehi</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">ATA_EH_RESET</span><span class="p">;</span>
		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">ahci_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_stat</span><span class="p">,</span> <span class="n">irq_masked</span><span class="p">;</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;ENTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>

	<span class="cm">/* sigh.  0xffffffff is a valid return from h/w */</span>
	<span class="n">irq_stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_IRQ_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">irq_stat</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">irq_masked</span> <span class="o">=</span> <span class="n">irq_stat</span> <span class="o">&amp;</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">n_ports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_masked</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ap</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahci_port_intr</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;port %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;port %u (no irq)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ata_ratelimit</span><span class="p">())</span>
				<span class="n">dev_warn</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="s">&quot;interrupt on disabled port %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* HOST_IRQ_STAT behaves as level triggered latch meaning that</span>
<span class="cm">	 * it should be cleared after all the port events are cleared;</span>
<span class="cm">	 * otherwise, it will raise a spurious interrupt after each</span>
<span class="cm">	 * valid one.  Please read section 10.6.2 of ahci 1.1 for more</span>
<span class="cm">	 * information.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also, use the unmasked value to clear interrupt as spurious</span>
<span class="cm">	 * pending event on a dummy port might cause screaming IRQ.</span>
<span class="cm">	 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">irq_stat</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_IRQ_STAT</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">VPRINTK</span><span class="p">(</span><span class="s">&quot;EXIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_interrupt</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ahci_qc_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* Keep track of the currently active link.  It will be used</span>
<span class="cm">	 * in completion path to determine whether NCQ phase is in</span>
<span class="cm">	 * progress.</span>
<span class="cm">	 */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">active_link</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ATA_PROT_NCQ</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_SCR_ACT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_last_dev</span> <span class="o">!=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
		<span class="n">fbs</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PORT_FBS_DEV_MASK</span> <span class="o">|</span> <span class="n">PORT_FBS_DEC</span><span class="p">);</span>
		<span class="n">fbs</span> <span class="o">|=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">&lt;&lt;</span> <span class="n">PORT_FBS_DEV_OFFSET</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">fbs</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_last_dev</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD_ISSUE</span><span class="p">);</span>

	<span class="n">ahci_sw_activity</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ahci_qc_fill_rtf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rx_fis</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span><span class="p">)</span>
		<span class="n">rx_fis</span> <span class="o">+=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">pmp</span> <span class="o">*</span> <span class="n">AHCI_RX_FIS_SZ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * After a successful execution of an ATA PIO data-in command,</span>
<span class="cm">	 * the device doesn&#39;t send D2H Reg FIS to update the TF and</span>
<span class="cm">	 * the host should take TF and E_Status from the preceding PIO</span>
<span class="cm">	 * Setup FIS.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ATA_PROT_PIO</span> <span class="o">&amp;&amp;</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">dma_dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ata_tf_from_fis</span><span class="p">(</span><span class="n">rx_fis</span> <span class="o">+</span> <span class="n">RX_FIS_PIO_SETUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">);</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_fis</span> <span class="o">+</span> <span class="n">RX_FIS_PIO_SETUP</span><span class="p">)[</span><span class="mi">15</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ata_tf_from_fis</span><span class="p">(</span><span class="n">rx_fis</span> <span class="o">+</span> <span class="n">RX_FIS_D2H_REG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">result_tf</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_freeze</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="cm">/* turn IRQ off */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_thaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* clear IRQ */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_STAT</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">,</span> <span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_IRQ_STAT</span><span class="p">);</span>

	<span class="cm">/* turn IRQ back on */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* restart engine */</span>
		<span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sata_pmp_error_handler</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ata_dev_enabled</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">device</span><span class="p">))</span>
		<span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_post_internal_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_queued_cmd</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="cm">/* make DMA engine forget about the failed command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATA_QCFLAG_FAILED</span><span class="p">)</span>
		<span class="n">ahci_kick_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_enable_fbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fbs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_supported</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="n">PORT_FBS_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_last_dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* initialization */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">fbs</span> <span class="o">|</span> <span class="n">PORT_FBS_EN</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="n">PORT_FBS_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FBS is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_last_dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* initialization */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to enable FBS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_disable_fbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fbs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_supported</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="n">PORT_FBS_EN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_stop_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PORT_FBS_EN</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="n">fbs</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_FBS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fbs</span> <span class="o">&amp;</span> <span class="n">PORT_FBS_EN</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to disable FBS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FBS is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ahci_start_engine</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_pmp_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">|=</span> <span class="n">PORT_CMD_PMP</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

	<span class="n">ahci_enable_fbs</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">|=</span> <span class="n">PORT_IRQ_BAD_PMP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must not change the port interrupt mask register if the</span>
<span class="cm">	 * port is marked frozen, the value in pp-&gt;intr_mask will be</span>
<span class="cm">	 * restored later when the port is thawed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that during initialization, the port is marked as</span>
<span class="cm">	 * frozen since the irq handler is not yet registered.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">))</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_pmp_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">ahci_disable_fbs</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_CMD_PMP</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PORT_IRQ_BAD_PMP</span><span class="p">;</span>

	<span class="cm">/* see comment above in ahci_pmp_attach() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pflags</span> <span class="o">&amp;</span> <span class="n">ATA_PFLAG_FROZEN</span><span class="p">))</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">,</span> <span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_IRQ_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ahci_port_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ahci_power_up</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="n">ahci_start_port</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sata_pmp_attached</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span>
		<span class="n">ahci_pmp_attach</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ahci_pmp_detach</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_port_resume</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_port_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">mesg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">emsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_deinit_port</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emsg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ahci_power_down</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ata_port_err</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;%s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emsg</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">ata_port_freeze</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ahci_port_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ahci_port_priv</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mem_dma</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">dma_sz</span><span class="p">,</span> <span class="n">rx_fis_sz</span><span class="p">;</span>

	<span class="n">pp</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* check FBS capability */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_FBS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sata_pmp_supported</span><span class="p">(</span><span class="n">ap</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">port_mmio</span> <span class="o">=</span> <span class="n">ahci_port_base</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">port_mmio</span> <span class="o">+</span> <span class="n">PORT_CMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PORT_CMD_FBSCP</span><span class="p">)</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AHCI_HFLAG_YES_FBS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;port %d can do FBS, forcing FBSCP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">);</span>
			<span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;port %d is not capable of FBS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ap</span><span class="o">-&gt;</span><span class="n">port_no</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">fbs_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_sz</span> <span class="o">=</span> <span class="n">AHCI_PORT_PRIV_FBS_DMA_SZ</span><span class="p">;</span>
		<span class="n">rx_fis_sz</span> <span class="o">=</span> <span class="n">AHCI_RX_FIS_SZ</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dma_sz</span> <span class="o">=</span> <span class="n">AHCI_PORT_PRIV_DMA_SZ</span><span class="p">;</span>
		<span class="n">rx_fis_sz</span> <span class="o">=</span> <span class="n">AHCI_RX_FIS_SZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">dmam_alloc_coherent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dma_sz</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First item in chunk of DMA memory: 32-slot command table,</span>
<span class="cm">	 * 32 bytes each in size</span>
<span class="cm">	 */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_slot_dma</span> <span class="o">=</span> <span class="n">mem_dma</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">+=</span> <span class="n">AHCI_CMD_SLOT_SZ</span><span class="p">;</span>
	<span class="n">mem_dma</span> <span class="o">+=</span> <span class="n">AHCI_CMD_SLOT_SZ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Second item: Received-FIS area</span>
<span class="cm">	 */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">rx_fis_dma</span> <span class="o">=</span> <span class="n">mem_dma</span><span class="p">;</span>

	<span class="n">mem</span> <span class="o">+=</span> <span class="n">rx_fis_sz</span><span class="p">;</span>
	<span class="n">mem_dma</span> <span class="o">+=</span> <span class="n">rx_fis_sz</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Third item: data area for storing a single command</span>
<span class="cm">	 * and its scatter-gather table</span>
<span class="cm">	 */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_tbl</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cmd_tbl_dma</span> <span class="o">=</span> <span class="n">mem_dma</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save off initial list of interrupts to be enabled.</span>
<span class="cm">	 * This could be changed later</span>
<span class="cm">	 */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">=</span> <span class="n">DEF_PORT_IRQ</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pp</span><span class="p">;</span>

	<span class="cm">/* engage engines, captain */</span>
	<span class="k">return</span> <span class="n">ahci_port_resume</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ahci_port_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_port</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">emsg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* de-initialize port */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ahci_deinit_port</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">emsg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">ata_port_warn</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="s">&quot;%s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">emsg</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ahci_print_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ata_host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">scc_s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vers</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">cap2</span><span class="p">,</span> <span class="n">impl</span><span class="p">,</span> <span class="n">speed</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">speed_s</span><span class="p">;</span>

	<span class="n">vers</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_VERSION</span><span class="p">);</span>
	<span class="n">cap</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>
	<span class="n">cap2</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap2</span><span class="p">;</span>
	<span class="n">impl</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">port_map</span><span class="p">;</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">speed_s</span> <span class="o">=</span> <span class="s">&quot;1.5&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">speed_s</span> <span class="o">=</span> <span class="s">&quot;3&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">speed_s</span> <span class="o">=</span> <span class="s">&quot;6&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">speed_s</span> <span class="o">=</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;AHCI %02x%02x.%02x%02x &quot;</span>
		<span class="s">&quot;%u slots %u ports %s Gbps 0x%x impl %s mode</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="p">,</span>

		<span class="p">(</span><span class="n">vers</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">(</span><span class="n">vers</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">(</span><span class="n">vers</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">vers</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>

		<span class="p">((</span><span class="n">cap</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">speed_s</span><span class="p">,</span>
		<span class="n">impl</span><span class="p">,</span>
		<span class="n">scc_s</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;flags: &quot;</span>
		<span class="s">&quot;%s%s%s%s%s%s%s&quot;</span>
		<span class="s">&quot;%s%s%s%s%s%s%s&quot;</span>
		<span class="s">&quot;%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="p">,</span>

		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_64</span> <span class="o">?</span> <span class="s">&quot;64bit &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_NCQ</span> <span class="o">?</span> <span class="s">&quot;ncq &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SNTF</span> <span class="o">?</span> <span class="s">&quot;sntf &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_MPS</span> <span class="o">?</span> <span class="s">&quot;ilck &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SSS</span> <span class="o">?</span> <span class="s">&quot;stag &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_ALPM</span> <span class="o">?</span> <span class="s">&quot;pm &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_LED</span> <span class="o">?</span> <span class="s">&quot;led &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_CLO</span> <span class="o">?</span> <span class="s">&quot;clo &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_ONLY</span> <span class="o">?</span> <span class="s">&quot;only &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_PMP</span> <span class="o">?</span> <span class="s">&quot;pmp &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_FBS</span> <span class="o">?</span> <span class="s">&quot;fbs &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_PIO_MULTI</span> <span class="o">?</span> <span class="s">&quot;pio &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SSC</span> <span class="o">?</span> <span class="s">&quot;slum &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_PART</span> <span class="o">?</span> <span class="s">&quot;part &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_CCC</span> <span class="o">?</span> <span class="s">&quot;ccc &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_EMS</span> <span class="o">?</span> <span class="s">&quot;ems &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_SXS</span> <span class="o">?</span> <span class="s">&quot;sxs &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap2</span> <span class="o">&amp;</span> <span class="n">HOST_CAP2_APST</span> <span class="o">?</span> <span class="s">&quot;apst &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap2</span> <span class="o">&amp;</span> <span class="n">HOST_CAP2_NVMHCI</span> <span class="o">?</span> <span class="s">&quot;nvmp &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">cap2</span> <span class="o">&amp;</span> <span class="n">HOST_CAP2_BOH</span> <span class="o">?</span> <span class="s">&quot;boh &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span>
		<span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_print_info</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ahci_set_em_messages</span><span class="p">(</span><span class="k">struct</span> <span class="n">ahci_host_priv</span> <span class="o">*</span><span class="n">hpriv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ata_port_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">messages</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mmio</span> <span class="o">=</span> <span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">em_loc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_LOC</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">em_ctl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mmio</span> <span class="o">+</span> <span class="n">HOST_EM_CTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ahci_em_messages</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">HOST_CAP_EMS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">messages</span> <span class="o">=</span> <span class="p">(</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTRL_MSG_TYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">messages</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* store em_loc */</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_loc</span> <span class="o">=</span> <span class="p">((</span><span class="n">em_loc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_buf_sz</span> <span class="o">=</span> <span class="p">((</span><span class="n">em_loc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">hpriv</span><span class="o">-&gt;</span><span class="n">em_msg_type</span> <span class="o">=</span> <span class="n">messages</span><span class="p">;</span>
		<span class="n">pi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_EM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">em_ctl</span> <span class="o">&amp;</span> <span class="n">EM_CTL_ALHD</span><span class="p">))</span>
			<span class="n">pi</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATA_FLAG_SW_ACTIVITY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ahci_set_em_messages</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jeff Garzik&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Common AHCI SATA low-level routines&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
