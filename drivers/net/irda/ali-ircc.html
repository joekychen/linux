<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › irda › ali-ircc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ali-ircc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*********************************************************************</span>
<span class="cm"> *                </span>
<span class="cm"> * Filename:      ali-ircc.h</span>
<span class="cm"> * Version:       0.5</span>
<span class="cm"> * Description:   Driver for the ALI M1535D and M1543C FIR Controller</span>
<span class="cm"> * Status:        Experimental.</span>
<span class="cm"> * Author:        Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;</span>
<span class="cm"> * Created at:    2000/10/16 03:46PM</span>
<span class="cm"> * Modified at:   2001/1/3 02:55PM</span>
<span class="cm"> * Modified by:   Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;</span>
<span class="cm"> * Modified at:   2003/11/6 and support for ALi south-bridge chipsets M1563</span>
<span class="cm"> * Modified by:   Clear Zhang &lt;clear_zhang@ali.com.tw&gt;</span>
<span class="cm"> * </span>
<span class="cm"> *     Copyright (c) 2000 Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;</span>
<span class="cm"> *     All Rights Reserved</span>
<span class="cm"> *      </span>
<span class="cm"> *     This program is free software; you can redistribute it and/or </span>
<span class="cm"> *     modify it under the terms of the GNU General Public License as </span>
<span class="cm"> *     published by the Free Software Foundation; either version 2 of </span>
<span class="cm"> *     the License, or (at your option) any later version.</span>
<span class="cm"> *  </span>
<span class="cm"> ********************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/serial_reg.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;net/irda/wrapper.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda_device.h&gt;</span>

<span class="cp">#include &quot;ali-ircc.h&quot;</span>

<span class="cp">#define CHIP_IO_EXTENT 8</span>
<span class="cp">#define BROKEN_DONGLE_ID</span>

<span class="cp">#define ALI_IRCC_DRIVER_NAME &quot;ali-ircc&quot;</span>

<span class="cm">/* Power Management */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ali_ircc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ali_ircc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ali_ircc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">ali_ircc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">ali_ircc_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Module parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qos_mtt_bits</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>  <span class="cm">/* 1 ms or more */</span>

<span class="cm">/* Use BIOS settions by default, but user may supply module parameters */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_probe_53</span><span class="p">(</span><span class="n">ali_chip_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_init_43</span><span class="p">(</span><span class="n">ali_chip_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_init_53</span><span class="p">(</span><span class="n">ali_chip_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/* These are the currently known ALi south-bridge chipsets, the only one difference</span>
<span class="cm"> * is that M1543C doesn&#39;t support HP HDSL-3600</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ali_chip_t</span> <span class="n">chips</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;M1543&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x370</span> <span class="p">},</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">ali_ircc_probe_53</span><span class="p">,</span> <span class="n">ali_ircc_init_43</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;M1535&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x370</span> <span class="p">},</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="n">ali_ircc_probe_53</span><span class="p">,</span> <span class="n">ali_ircc_init_53</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;M1563&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="mh">0x3f0</span><span class="p">,</span> <span class="mh">0x370</span> <span class="p">},</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="n">ali_ircc_probe_53</span><span class="p">,</span> <span class="n">ali_ircc_init_53</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Max 4 instances for now */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">dev_self</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

<span class="cm">/* Dongle Types */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dongle_types</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;TFDS6000&quot;</span><span class="p">,</span>
	<span class="s">&quot;HP HSDL-3600&quot;</span><span class="p">,</span>
	<span class="s">&quot;HP HSDL-1100&quot;</span><span class="p">,</span>	
	<span class="s">&quot;No dongle connected&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Some prototypes */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_setup</span><span class="p">(</span><span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_is_receiving</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ali_ircc_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">baud</span><span class="p">);</span>

<span class="cm">/* SIR function */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ali_ircc_sir_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ali_ircc_sir_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ali_ircc_sir_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ali_ircc_sir_write_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_sir_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ali_ircc_sir_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">speed</span><span class="p">);</span>

<span class="cm">/* FIR function */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span>  <span class="n">ali_ircc_fir_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ali_ircc_fir_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">speed</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ali_ircc_fir_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_dma_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span> 
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_dma_receive_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_dma_xmit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ali_ircc_dma_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>

<span class="cm">/* My Function */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">ali_ircc_read_dongle_id</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ali_ircc_change_dongle_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">);</span>

<span class="cm">/* ALi chip function */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">SIR2FIR</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FIR2SIR</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enable</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_init ()</span>
<span class="cm"> *</span>
<span class="cm"> *    Initialize chip. Find out whay kinds of chips we are dealing with</span>
<span class="cm"> *    and their configuration registers address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ali_ircc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ali_chip_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">chipio_t</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">revision</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ali_ircc_driver</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s, Can&#39;t register driver!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	
	<span class="cm">/* Probe for all the ALi chipsets we know about */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chip</span><span class="o">=</span> <span class="n">chips</span><span class="p">;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), Probing for %s ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				
		<span class="cm">/* Try all config registers for this chip */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cfg</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">cfg</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="n">cfg</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">cfg_base</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="p">[</span><span class="n">cfg</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cfg_base</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
				
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chipio_t</span><span class="p">));</span>
			<span class="n">info</span><span class="p">.</span><span class="n">cfg_base</span> <span class="o">=</span> <span class="n">cfg_base</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fir_base</span> <span class="o">=</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">info</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">info</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			
			
			<span class="cm">/* Enter Configuration */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">entr1</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">entr2</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
			
			<span class="cm">/* Select Logical Device 5 Registers (UART2) */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			
			<span class="cm">/* Read Chip Identification Register */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cid_index</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>	
			<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	
				
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cid_value</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), Chip found at 0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
					   
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x1F</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
				<span class="n">revision</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), Found %s chip, revision=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
					   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">revision</span><span class="p">);</span>					
				
				<span class="cm">/* </span>
<span class="cm">				 * If the user supplies the base address, then</span>
<span class="cm">				 * we init the chip, if not we probe the values</span>
<span class="cm">				 * set by the BIOS</span>
<span class="cm">				 */</span>				
				<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>	
				<span class="p">}</span>
				
				<span class="k">if</span> <span class="p">(</span><span class="n">ali_ircc_open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>				
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), No %s chip at 0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* Exit configuration */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0xbb</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>		
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ali_ircc_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_cleanup ()</span>
<span class="cm"> *</span>
<span class="cm"> *    Close all configured chips</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ali_ircc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_self</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">ali_ircc_close</span><span class="p">(</span><span class="n">dev_self</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ali_ircc_driver</span><span class="p">);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ali_ircc_sir_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">ali_ircc_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">ali_ircc_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">ali_ircc_sir_hard_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">ali_ircc_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ali_ircc_fir_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">ali_ircc_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">ali_ircc_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">ali_ircc_fir_hard_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">ali_ircc_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_open (int i, chipio_t *inf)</span>
<span class="cm"> *</span>
<span class="cm"> *    Open driver instance</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dongle_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
			
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_self</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s(), maximum number of supported chips reached!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Set FIR FIFO and DMA Threshold */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ali_ircc_setup</span><span class="p">(</span><span class="n">info</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_irdadev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s(), can&#39;t allocate memory for control block!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
   
	<span class="cm">/* Need to store self somewhere */</span>
	<span class="n">dev_self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Initialize IO */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">cfg_base</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg_base</span><span class="p">;</span>	<span class="cm">/* In ali_ircc_probe_53 assign 		*/</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fir_base</span><span class="p">;</span>	<span class="cm">/* info-&gt;sir_base = info-&gt;fir_base 	*/</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">sir_base</span>  <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">sir_base</span><span class="p">;</span> 	<span class="cm">/* ALi SIR and FIR use the same address */</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span>       <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span>   <span class="o">=</span> <span class="n">CHIP_IO_EXTENT</span><span class="p">;</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span>       <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>		<span class="cm">/* SIR: 16, FIR: 32 Benjamin 2000/11/1 */</span>
	
	<span class="cm">/* Reserve the ioports that we need */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">,</span>
			    <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s(), can&#39;t get iobase of 0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize QoS for this device */</span>
	<span class="n">irda_init_max_qos_capabilies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
	
	<span class="cm">/* The only value we must override it the baudrate */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">IR_9600</span><span class="o">|</span><span class="n">IR_19200</span><span class="o">|</span><span class="n">IR_38400</span><span class="o">|</span><span class="n">IR_57600</span><span class="o">|</span>
		<span class="n">IR_115200</span><span class="o">|</span><span class="n">IR_576000</span><span class="o">|</span><span class="n">IR_1152000</span><span class="o">|</span><span class="p">(</span><span class="n">IR_4000000</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span> <span class="c1">// benjamin 2000/11/8 05:27PM</span>
			
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">min_turn_time</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">qos_mtt_bits</span><span class="p">;</span>
			
	<span class="n">irda_qos_bits_to_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
	
	<span class="cm">/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="mi">14384</span><span class="p">;</span> 
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="mi">14384</span><span class="p">;</span>

	<span class="cm">/* Allocate memory if needed */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>
	
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">in_frame</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	
	<span class="cm">/* Reset Tx queue info */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>

	<span class="cm">/* Override the network functions we need to use */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ali_ircc_sir_ops</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s(), register_netdev() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;IrDA: Registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Check dongle id */</span>
	<span class="n">dongle_id</span> <span class="o">=</span> <span class="n">ali_ircc_read_dongle_id</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s(), %s, Found dongle: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		     <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">,</span> <span class="n">dongle_types</span><span class="p">[</span><span class="n">dongle_id</span><span class="p">]);</span>
		
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dongle_id</span> <span class="o">=</span> <span class="n">dongle_id</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_out4:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
			  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">);</span>
 <span class="nl">err_out3:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
			  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">);</span>
 <span class="nl">err_out2:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">);</span>
 <span class="nl">err_out1:</span>
	<span class="n">dev_self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_close (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Close driver instance</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">ali_ircc_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

        <span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Remove netdevice */</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Release the PORT that this driver is using */</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), Releasing Region %03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">);</span>

	<span class="n">dev_self</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_init_43 (chip, info)</span>
<span class="cm"> *</span>
<span class="cm"> *    Initialize the ALi M1543 chip. </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_init_43</span><span class="p">(</span><span class="n">ali_chip_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="cm">/* All controller information like I/O address, DMA channel, IRQ</span>
<span class="cm">	 * are set by BIOS</span>
<span class="cm">	 */</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_init_53 (chip, info)</span>
<span class="cm"> *</span>
<span class="cm"> *    Initialize the ALi M1535 chip. </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_init_53</span><span class="p">(</span><span class="n">ali_chip_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="cm">/* All controller information like I/O address, DMA channel, IRQ</span>
<span class="cm">	 * are set by BIOS</span>
<span class="cm">	 */</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_probe_53 (chip, info)</span>
<span class="cm"> *    	</span>
<span class="cm"> *	Probes for the ALi M1535D or M1535</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_probe_53</span><span class="p">(</span><span class="n">ali_chip_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cfg_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hi</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="cm">/* Enter Configuration */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">entr1</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">entr2</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	
	<span class="cm">/* Select Logical Device 5 Registers (UART2) */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	
	<span class="cm">/* Read address control register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">fir_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">low</span><span class="p">;</span>
	
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">sir_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), probing fir_base=0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fir_base</span><span class="p">);</span>
		
	<span class="cm">/* Read IRQ control register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), probing irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	
	<span class="cm">/* Read DMA channel */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s(), No DMA channel assigned !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), probing dma=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	
	<span class="cm">/* Read Enabled Status */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), probing enabled=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">);</span>
	
	<span class="cm">/* Read Power Status */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), probing suspended=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">);</span>
	
	<span class="cm">/* Exit configuration */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xbb</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_setup (info)</span>
<span class="cm"> *</span>
<span class="cm"> *    	Set FIR FIFO and DMA Threshold</span>
<span class="cm"> *	Returns non-negative on success.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_setup</span><span class="p">(</span><span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="cm">/* Locking comments :</span>
<span class="cm">	 * Most operations here need to be protected. We are called before</span>
<span class="cm">	 * the device instance is created in ali_ircc_open(), therefore </span>
<span class="cm">	 * nobody can bother us - Jean II */</span>

	<span class="cm">/* Switch to FIR space */</span>
	<span class="n">SIR2FIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	
	<span class="cm">/* Master Reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_MCR</span><span class="p">);</span> <span class="c1">// benjamin 2000/11/30 11:45AM</span>
	
	<span class="cm">/* Read FIR ID Version Register */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK3</span><span class="p">);</span>
	<span class="n">version</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_ID_VR</span><span class="p">);</span>
	
	<span class="cm">/* Should be 0x00 in the M1535/M1535D */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">version</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s, Wrong chip version %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Set FIR FIFO Threshold Register */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">RX_FIFO_Threshold</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_FIFO_TR</span><span class="p">);</span>
	
	<span class="cm">/* Set FIR DMA Threshold Register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">RX_DMA_Threshold</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_DMA_TR</span><span class="p">);</span>
	
	<span class="cm">/* CRC enable */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">)</span> <span class="o">|</span> <span class="n">IRDA_CR_CRC</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
	
	<span class="cm">/* NDIS driver set TX Length here BANK2 Alias 3, Alias4*/</span>
	
	<span class="cm">/* Switch to Bank 0 */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
	
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_B</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=~</span><span class="mh">0x20</span><span class="p">;</span> <span class="c1">// disable SIP</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="c1">// these two steps make RX mode</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xbf</span><span class="p">;</span>	
	<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_B</span><span class="p">);</span>
		
	<span class="cm">/* Disable Interrupt */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IER</span><span class="p">);</span>
	
	
	<span class="cm">/* Switch to SIR space */</span>
	<span class="n">FIR2SIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	
	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s, driver loaded (Benjamin Kong)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">);</span>
	
	<span class="cm">/* Enable receive interrupts */</span> </pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>outb(UART<em>IER</em>RDI, iobase+UART<em>IER); //benjamin 2000/11/23 01:25PM
Turn on the interrupts in ali</em>ircc<em>net</em>open</p></td><td class="code"><div class="highlight"><pre>	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_read_dongle_id (int index, info)</span>
<span class="cm"> *</span>
<span class="cm"> * Try to read dongle indentification. This procedure needs to be executed</span>
<span class="cm"> * once after power-on/reset. It also needs to be used whenever you suspect</span>
<span class="cm"> * that the user may have plugged/unplugged the IrDA Dongle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_read_dongle_id</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dongle_id</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cfg_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg_base</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		
	<span class="cm">/* Enter Configuration */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entr1</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">chips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entr2</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	
	<span class="cm">/* Select Logical Device 5 Registers (UART2) */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x05</span><span class="p">,</span> <span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	
	<span class="cm">/* Read Dongle ID */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">cfg_base</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>	
	<span class="n">dongle_id</span> <span class="o">=</span> <span class="p">((</span><span class="n">reg</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x02</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">reg</span><span class="o">&gt;&gt;</span><span class="mi">5</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), probing dongle_id=%d, dongle_types=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">dongle_id</span><span class="p">,</span> <span class="n">dongle_types</span><span class="p">[</span><span class="n">dongle_id</span><span class="p">]);</span>
	
	<span class="cm">/* Exit configuration */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xbb</span><span class="p">,</span> <span class="n">cfg_base</span><span class="p">);</span>
			
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">dongle_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_interrupt (irq, dev_id, regs)</span>
<span class="cm"> *</span>
<span class="cm"> *    An interrupt from the chip has arrived. Time to do some work</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ali_ircc_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	
	<span class="cm">/* Dispatch interrupt handler for the current speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ali_ircc_fir_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ali_ircc_sir_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_fir_interrupt(irq, struct ali_ircc_cb *self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Handle MIR/FIR interrupt</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ali_ircc_fir_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">eir</span><span class="p">,</span> <span class="n">OldMessageCount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>	
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">InterruptID</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IIR</span><span class="p">);</span>		
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">BusStatus</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_BSR</span><span class="p">);</span>	
	
	<span class="n">OldMessageCount</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">LineStatus</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">LineStatus</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LSR</span><span class="p">);</span>	</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>self->ier = inb(iobase+FIR_IER);         2000/12/1 04:32PM</p></td><td class="code"><div class="highlight"><pre>	<span class="n">eir</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">InterruptID</span> <span class="o">&amp;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">;</span> <span class="cm">/* Mask out the interesting ones */</span> 
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), self-&gt;InterruptID = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">InterruptID</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), self-&gt;LineStatus = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">LineStatus</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), self-&gt;ier = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), eir = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span><span class="n">eir</span><span class="p">);</span>
	
	<span class="cm">/* Disable interrupts */</span>
	 <span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
	
	<span class="cm">/* Tx or Rx Interrupt */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">eir</span> <span class="o">&amp;</span> <span class="n">IIR_EOM</span><span class="p">)</span> 
	<span class="p">{</span>		
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IO_XMIT</span><span class="p">)</span> <span class="cm">/* TX */</span>
		<span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ******* IIR_EOM (Tx) *******</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			
			<span class="k">if</span><span class="p">(</span><span class="n">ali_ircc_dma_xmit_complete</span><span class="p">(</span><span class="n">self</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irda_device_txqueue_empty</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> 
				<span class="p">{</span>
					<span class="cm">/* Prepare for receive */</span>
					<span class="n">ali_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>					
					<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span>									
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span> 					
			<span class="p">}</span>
									
		<span class="p">}</span>	
		<span class="k">else</span> <span class="cm">/* RX */</span>
		<span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ******* IIR_EOM (Rx) *******</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			
			<span class="k">if</span><span class="p">(</span><span class="n">OldMessageCount</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">LineStatus</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">rcvFramesOverflow</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>	
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ******* self-&gt;rcvFramesOverflow = TRUE ********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
						
			<span class="k">if</span> <span class="p">(</span><span class="n">ali_ircc_dma_receive_complete</span><span class="p">(</span><span class="n">self</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ******* receive complete ********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span>				
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ******* Not receive complete ********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span> <span class="o">|</span> <span class="n">IER_TIMER</span><span class="p">;</span>								
			<span class="p">}</span>	
		
		<span class="p">}</span>		
	<span class="p">}</span>
	<span class="cm">/* Timer Interrupt */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">eir</span> <span class="o">&amp;</span> <span class="n">IIR_TIMER</span><span class="p">)</span>
	<span class="p">{</span>	
		<span class="k">if</span><span class="p">(</span><span class="n">OldMessageCount</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">LineStatus</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">rcvFramesOverflow</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>	
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ******* self-&gt;rcvFramesOverflow = TRUE *******</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Disable Timer */</span>
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span> <span class="n">tmp</span><span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_TIMER_EN</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
		
		<span class="cm">/* Check if this is a Tx timer interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IO_XMIT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ali_ircc_dma_xmit</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
			
			<span class="cm">/* Interrupt on EOM */</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span>
									
		<span class="p">}</span>
		<span class="k">else</span> <span class="cm">/* Rx */</span>
		<span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ali_ircc_dma_receive_complete</span><span class="p">(</span><span class="n">self</span><span class="p">))</span> 
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span> <span class="o">|</span> <span class="n">IER_TIMER</span><span class="p">;</span>
			<span class="p">}</span>	
		<span class="p">}</span>		
	<span class="p">}</span>
	
	<span class="cm">/* Restore Interrupt */</span>	
	<span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>	
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ---------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">eir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_sir_interrupt (irq, self, eir)</span>
<span class="cm"> *</span>
<span class="cm"> *    Handle SIR interrupt</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ali_ircc_sir_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iir</span><span class="p">,</span> <span class="n">lsr</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">sir_base</span><span class="p">;</span>

	<span class="n">iir</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_IIR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_IIR_ID</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iir</span><span class="p">)</span> <span class="p">{</span>	
		<span class="cm">/* Clear interrupt */</span>
		<span class="n">lsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_LSR</span><span class="p">);</span>

		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), iir=%02x, lsr=%02x, iobase=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">iir</span><span class="p">,</span> <span class="n">lsr</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">iir</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">UART_IIR_RLSI</span>:
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), RLSI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UART_IIR_RDI</span>:
				<span class="cm">/* Receive interrupt */</span>
				<span class="n">ali_ircc_sir_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">UART_IIR_THRI</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">UART_LSR_THRE</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/* Transmitter ready for data */</span>
					<span class="n">ali_ircc_sir_write_wakeup</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>				
				<span class="p">}</span>				
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), unhandled IIR=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">iir</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> 
		
	<span class="p">}</span>
	
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">iir</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_sir_receive (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Receive one frame from the infrared port</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ali_ircc_sir_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">boguscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">sir_base</span><span class="p">;</span>

	<span class="cm">/*  </span>
<span class="cm">	 * Receive all characters in Rx FIFO, unwrap and unstuff them. </span>
<span class="cm">         * async_unwrap_char will deliver all found frames  </span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">async_unwrap_char</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span>
				  <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_RX</span><span class="p">));</span>

		<span class="cm">/* Make sure we don&#39;t stay here too long */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">boguscount</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;%s(), breaking!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_DR</span><span class="p">);</span>	
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_sir_write_wakeup (tty)</span>
<span class="cm"> *</span>
<span class="cm"> *    Called by the driver when there&#39;s room for more data.  If we have</span>
<span class="cm"> *    more packets to send, we send them here.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ali_ircc_sir_write_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>	

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">sir_base</span><span class="p">;</span>

	<span class="cm">/* Finished with frame?  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  
	<span class="p">{</span>
		<span class="cm">/* Write data left in transmit buffer */</span>
		<span class="n">actual</span> <span class="o">=</span> <span class="n">ali_ircc_sir_write</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">,</span> 
				      <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span>  <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="k">else</span> 
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="cm">/* We must wait until all data are gone */</span>
			<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_TEMT</span><span class="p">))</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), UART_LSR_THRE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), Changing speed! self-&gt;new_speed = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">);</span>
			<span class="n">ali_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">);</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			
			</pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>benjamin 2000/11/10 06:32PM</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ali_ircc_change_speed from UART_LSR_TEMT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
					
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>SetCOMInterrupts(self, TRUE);                            </p></td><td class="code"><div class="highlight"><pre>				<span class="k">return</span><span class="p">;</span>							
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>	
		<span class="p">}</span>
			
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		
		<span class="cm">/* Turn on receive interrupts */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">UART_IER_RDI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_IER</span><span class="p">);</span>
	<span class="p">}</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ali_ircc_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), setting speed = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
	
	<span class="cm">/* This function *must* be called with irq off and spin-lock.</span>
<span class="cm">	 * - Jean II */</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span> <span class="c1">// 2000/11/24 11:43AM</span>
	
	<span class="cm">/* Go to MIR, FIR Speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span>
	<span class="p">{</span>
		
					
		<span class="n">ali_ircc_fir_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>			
		
		<span class="cm">/* Install FIR xmit handler*/</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ali_ircc_fir_ops</span><span class="p">;</span>
				
		<span class="cm">/* Enable Interuupt */</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span> <span class="c1">// benjamin 2000/11/20 07:24PM					</span>
				
		<span class="cm">/* Be ready for incomming frames */</span>
		<span class="n">ali_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>	<span class="c1">// benajmin 2000/11/8 07:46PM not complete</span>
	<span class="p">}</span>	
	<span class="cm">/* Go to SIR Speed */</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">ali_ircc_sir_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
				
		<span class="cm">/* Install SIR xmit handler*/</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ali_ircc_sir_ops</span><span class="p">;</span>
	<span class="p">}</span>
	
		
	<span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>	<span class="c1">// 2000/11/24 11:43AM</span>
		
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>	
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ali_ircc_fir_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">baud</span><span class="p">)</span>
<span class="p">{</span>
		
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span> 
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), self-&gt;io.speed = %d, change to speed = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span><span class="n">baud</span><span class="p">);</span>
	
	<span class="cm">/* Come from SIR speed */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;=</span><span class="mi">115200</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">SIR2FIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="p">}</span>
		
	<span class="cm">/* Update accounting for new speed */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">baud</span><span class="p">;</span>
		</pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Set Dongle Speed mode</p></td><td class="code"><div class="highlight"><pre>	<span class="n">ali_ircc_change_dongle_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">baud</span><span class="p">);</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_sir_change_speed (self, speed)</span>
<span class="cm"> *</span>
<span class="cm"> *    Set speed of IrDA port to specified baudrate</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ali_ircc_sir_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span> 
	<span class="kt">int</span> <span class="n">fcr</span><span class="p">;</span>    <span class="cm">/* FIFO control reg */</span>
	<span class="kt">int</span> <span class="n">lcr</span><span class="p">;</span>    <span class="cm">/* Line control reg */</span>
	<span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), Setting speed to: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">sir_base</span><span class="p">;</span>
	
	<span class="cm">/* Come from MIR or FIR speed */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span><span class="mi">115200</span><span class="p">)</span>
	<span class="p">{</span>	</pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Set Dongle Speed mode first</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ali_ircc_change_dongle_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
			
		<span class="n">FIR2SIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="p">}</span>
		</pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Clear Line and Auxiluary status registers 2000/11/24 11:47AM</p></td><td class="code"><div class="highlight"><pre>		
	<span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_LSR</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_SCR</span><span class="p">);</span>
		
	<span class="cm">/* Update accounting for new speed */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">divisor</span> <span class="o">=</span> <span class="mi">115200</span><span class="o">/</span><span class="n">speed</span><span class="p">;</span>
	
	<span class="n">fcr</span> <span class="o">=</span> <span class="n">UART_FCR_ENABLE_FIFO</span><span class="p">;</span>

	<span class="cm">/* </span>
<span class="cm">	 * Use trigger level 1 to avoid 3 ms. timeout delay at 9600 bps, and</span>
<span class="cm">	 * almost 1,7 ms at 19200 bps. At speeds above that we can just forget</span>
<span class="cm">	 * about this timeout since it will always be fast enough. </span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">38400</span><span class="p">)</span>
		<span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_TRIGGER_1</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="n">fcr</span> <span class="o">|=</span> <span class="n">UART_FCR_TRIGGER_14</span><span class="p">;</span>
        
	<span class="cm">/* IrDA ports use 8N1 */</span>
	<span class="n">lcr</span> <span class="o">=</span> <span class="n">UART_LCR_WLEN8</span><span class="p">;</span>
	
	<span class="n">outb</span><span class="p">(</span><span class="n">UART_LCR_DLAB</span> <span class="o">|</span> <span class="n">lcr</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_LCR</span><span class="p">);</span> <span class="cm">/* Set DLAB */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">divisor</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>      <span class="n">iobase</span><span class="o">+</span><span class="n">UART_DLL</span><span class="p">);</span> <span class="cm">/* Set speed */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">divisor</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>	  <span class="n">iobase</span><span class="o">+</span><span class="n">UART_DLM</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">lcr</span><span class="p">,</span>		  <span class="n">iobase</span><span class="o">+</span><span class="n">UART_LCR</span><span class="p">);</span> <span class="cm">/* Set 8N1	*/</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">fcr</span><span class="p">,</span>		  <span class="n">iobase</span><span class="o">+</span><span class="n">UART_FCR</span><span class="p">);</span> <span class="cm">/* Enable FIFO&#39;s */</span>

	<span class="cm">/* without this, the connection will be broken after come back from FIR speed,</span>
<span class="cm">	   but with this, the SIR connection is harder to established */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">UART_MCR_DTR</span> <span class="o">|</span> <span class="n">UART_MCR_RTS</span> <span class="o">|</span> <span class="n">UART_MCR_OUT2</span><span class="p">),</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_MCR</span><span class="p">);</span>
	
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ali_ircc_change_dongle_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span><span class="n">dongle_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span> 	<span class="cm">/* or iobase = self-&gt;io.sir_base; */</span>
	<span class="n">dongle_id</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dongle_id</span><span class="p">;</span>
	
	<span class="cm">/* We are already locked, no need to do it again */</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), Set Speed for %s , Speed = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">dongle_types</span><span class="p">[</span><span class="n">dongle_id</span><span class="p">],</span> <span class="n">speed</span><span class="p">);</span>
	
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
		
	<span class="cm">/* IBM type dongle */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dongle_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>				
		<span class="k">if</span><span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">4000000</span><span class="p">)</span>
		<span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><pre><code>  __ __    
</code></pre>

<p>SD/MODE <strong>|     |</strong> <em>_
              _</em> <em>_ 
IRTX    _</em> <strong>|     |</strong>
        T1 T2 T3 T4 T5</p></td><td class="code"><div class="highlight"><pre>			
			<span class="n">tmp</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IRDA_CR_HDLC</span><span class="p">;</span>		<span class="c1">// HDLC=0</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">IRDA_CR_CRC</span><span class="p">;</span>	   	<span class="c1">// CRC=1</span>
			
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
			</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>T1 -> SD/MODE:0 IRTX:0</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x09</span><span class="p">;</span>
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>T2 -> SD/MODE:1 IRTX:0</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x0a</span><span class="p">;</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>T3 -> SD/MODE:1 IRTX:1</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x0b</span><span class="p">;</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>T4 -> SD/MODE:0 IRTX:1</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x08</span><span class="p">;</span>
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>T5 -> SD/MODE:0 IRTX:0</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x09</span><span class="p">;</span>
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>reset -> Normal TX output Signal</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>      			
		<span class="p">}</span>
		<span class="k">else</span> <span class="cm">/* speed &lt;=1152000 */</span>
		<span class="p">{</span>	</pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><pre><code>  __    
</code></pre>

<p>SD/MODE <strong>|  |</strong></p>

<p>IRTX    <strong><em>_</em>_</strong>
        T1 T2 T3  </p></td><td class="code"><div class="highlight"><pre>			
			<span class="cm">/* MIR 115200, 57600 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">==</span><span class="mi">1152000</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0xA0</span><span class="p">;</span>	   <span class="c1">//HDLC=1, 1.152Mbps=1</span>
      			<span class="p">}</span>
      			<span class="k">else</span>
      			<span class="p">{</span>
				<span class="n">tmp</span> <span class="o">&amp;=~</span><span class="mh">0x80</span><span class="p">;</span>	   <span class="c1">//HDLC 0.576Mbps</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	   <span class="c1">//HDLC=1,</span>
      			<span class="p">}</span>			
      			
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">IRDA_CR_CRC</span><span class="p">;</span>	   	<span class="c1">// CRC=1</span>
      			
      			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
						
			<span class="cm">/* MIR 115200, 57600 */</span>	
						</pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>switch_bank(iobase, BANK2); <br />
T1 -> SD/MODE:0 IRTX:0</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x09</span><span class="p">;</span>
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>T2 -> SD/MODE:1 IRTX:0</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>     
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x0a</span><span class="p">;</span>      
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>T3 -> SD/MODE:0 IRTX:0</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x09</span><span class="p">;</span>
      			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>
      			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      			</pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>reset -> Normal TX output Signal</p></td><td class="code"><div class="highlight"><pre>      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>      						
		<span class="p">}</span>		
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dongle_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* HP HDSL-3600 */</span>
	<span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
		<span class="p">{</span>
		<span class="k">case</span> <span class="mi">4000000</span>:
			<span class="n">tmp</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IRDA_CR_HDLC</span><span class="p">;</span>	<span class="c1">// HDLC=0</span>
			<span class="k">break</span><span class="p">;</span>	
			
		<span class="k">case</span> <span class="mi">1152000</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0xA0</span><span class="p">;</span>	   	<span class="c1">// HDLC=1, 1.152Mbps=1</span>
      			<span class="k">break</span><span class="p">;</span>
      			
      		<span class="k">case</span> <span class="mi">576000</span>:
      			<span class="n">tmp</span> <span class="o">&amp;=~</span><span class="mh">0x80</span><span class="p">;</span>	   	<span class="c1">// HDLC 0.576Mbps</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	   	<span class="c1">// HDLC=1,</span>
			<span class="k">break</span><span class="p">;</span>
      		<span class="p">}</span>			
			
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">IRDA_CR_CRC</span><span class="p">;</span>	   	<span class="c1">// CRC=1</span>
			
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
      		<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>		
	<span class="p">}</span>
	<span class="k">else</span> <span class="cm">/* HP HDSL-1100 */</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">speed</span> <span class="o">&lt;=</span> <span class="mi">115200</span><span class="p">)</span> <span class="cm">/* SIR */</span>
		<span class="p">{</span>
			
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IRDA_CR_FIR_SIN</span><span class="p">;</span>	<span class="c1">// HP sin select = 0</span>
			
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>			
		<span class="p">}</span>
		<span class="k">else</span> <span class="cm">/* MIR FIR */</span>
		<span class="p">{</span>	
			
			<span class="k">switch</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span>
			<span class="p">{</span>
			<span class="k">case</span> <span class="mi">4000000</span>:
				<span class="n">tmp</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">IRDA_CR_HDLC</span><span class="p">;</span>	<span class="c1">// HDLC=0</span>
				<span class="k">break</span><span class="p">;</span>	
			
			<span class="k">case</span> <span class="mi">1152000</span>:
				<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0xA0</span><span class="p">;</span>	   	<span class="c1">// HDLC=1, 1.152Mbps=1</span>
      				<span class="k">break</span><span class="p">;</span>
      			
      			<span class="k">case</span> <span class="mi">576000</span>:
      				<span class="n">tmp</span> <span class="o">&amp;=~</span><span class="mh">0x80</span><span class="p">;</span>	   	<span class="c1">// HDLC 0.576Mbps</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	   	<span class="c1">// HDLC=1,</span>
				<span class="k">break</span><span class="p">;</span>
      			<span class="p">}</span>			
			
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">IRDA_CR_CRC</span><span class="p">;</span>	   	<span class="c1">// CRC=1</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">IRDA_CR_FIR_SIN</span><span class="p">;</span>		<span class="c1">// HP sin select = 1</span>
			
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
      			<span class="n">outb</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IRDA_CR</span><span class="p">);</span>			
		<span class="p">}</span>
	<span class="p">}</span>
			
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_sir_write (driver)</span>
<span class="cm"> *</span>
<span class="cm"> *    Fill Tx FIFO with transmit data</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_sir_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		
	<span class="cm">/* Tx FIFO should be empty! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UART_LSR_THRE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), failed, fifo not empty!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
        
	<span class="cm">/* Fill FIFO with current frame */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">fifo_size</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Transmit next byte */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">actual</span><span class="p">],</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_TX</span><span class="p">);</span>

		<span class="n">actual</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	
        <span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">actual</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_net_open (dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Start the device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hwname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="cm">/* Request IRQ and install Interrupt Handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">ali_ircc_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> 
	<span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s, unable to allocate irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">,</span>
			     <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Always allocate the DMA channel after the IRQ, and clean up on </span>
<span class="cm">	 * failure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s, unable to allocate dma=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">,</span>
			     <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Turn on interrups */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">UART_IER_RDI</span> <span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_IER</span><span class="p">);</span>

	<span class="cm">/* Ready to play! */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="c1">//benjamin by irport</span>
	
	<span class="cm">/* Give self a hardware name */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">hwname</span><span class="p">,</span> <span class="s">&quot;ALI-FIR @ 0x%03x&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Open new IrLAP layer instance, now that everything should be</span>
<span class="cm">	 * initialized properly </span>
<span class="cm">	 */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="n">irlap_open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">hwname</span><span class="p">);</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_net_close (dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Stop the device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>	

	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>int iobase;</p></td><td class="code"><div class="highlight"><pre>			
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;);</span>

	<span class="cm">/* Stop device */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="cm">/* Stop and remove instance of IrLAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span>
		<span class="n">irlap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">);</span>
	       
	<span class="n">free_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_fir_hard_xmit (skb, dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Transmit the frame</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ali_ircc_fir_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtt</span><span class="p">,</span> <span class="n">diff</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="cm">/* Make sure tests *&amp; speed change are atomic */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	
	<span class="cm">/* Note : you should make sure that speed changes are not going</span>
<span class="cm">	 * to corrupt any outgoing frame. Look at nsc-ircc for the gory</span>
<span class="cm">	 * details - Jean II */</span>

	<span class="cm">/* Check if we need to change the speed */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check for empty frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ali_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span> 
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register and copy this frame to DMA memory */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
		      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Start transmit only if there is currently no transmit going on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="cm">/* Check if we must wait the min turn time or not */</span>
		<span class="n">mtt</span> <span class="o">=</span> <span class="n">irda_get_mtt</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				
		<span class="k">if</span> <span class="p">(</span><span class="n">mtt</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="cm">/* Check how much time we have used already */</span>
			<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">);</span>
			
			<span class="n">diff</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">stamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
			<span class="cm">/* self-&gt;stamp is set from ali_ircc_dma_receive_complete() */</span>
							
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ******* diff = %d *******</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">diff</span><span class="p">);</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
				<span class="n">diff</span> <span class="o">+=</span> <span class="mi">1000000</span><span class="p">;</span>
			
			<span class="cm">/* Check if the mtt is larger than the time we have</span>
<span class="cm">			 * already used by all the protocol processing</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtt</span> <span class="o">&gt;</span> <span class="n">diff</span><span class="p">)</span>
			<span class="p">{</span>				
				<span class="n">mtt</span> <span class="o">-=</span> <span class="n">diff</span><span class="p">;</span>
								
				<span class="cm">/* </span>
<span class="cm">				 * Use timer if delay larger than 1000 us, and</span>
<span class="cm">				 * use udelay for smaller values which should</span>
<span class="cm">				 * be acceptable</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mtt</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">)</span> 
				<span class="p">{</span>
					<span class="cm">/* Adjust for timer resolution */</span>
					<span class="n">mtt</span> <span class="o">=</span> <span class="p">(</span><span class="n">mtt</span><span class="o">+</span><span class="mi">250</span><span class="p">)</span> <span class="o">/</span> <span class="mi">500</span><span class="p">;</span> 	<span class="cm">/* 4 discard, 5 get advanced, Let&#39;s round off */</span>
					
					<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ************** mtt = %d ***********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">mtt</span><span class="p">);</span>
					
					<span class="cm">/* Setup timer */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mtt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* 500 us */</span>
					<span class="p">{</span>
						<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
						<span class="n">outb</span><span class="p">(</span><span class="n">TIMER_IIR_500</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_TIMER_IIR</span><span class="p">);</span>
					<span class="p">}</span>	
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mtt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* 1 ms */</span>
					<span class="p">{</span>
						<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
						<span class="n">outb</span><span class="p">(</span><span class="n">TIMER_IIR_1ms</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_TIMER_IIR</span><span class="p">);</span>
					<span class="p">}</span>					
					<span class="k">else</span> <span class="cm">/* &gt; 2ms -&gt; 4ms */</span>
					<span class="p">{</span>
						<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
						<span class="n">outb</span><span class="p">(</span><span class="n">TIMER_IIR_2ms</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_TIMER_IIR</span><span class="p">);</span>
					<span class="p">}</span>
					
					
					<span class="cm">/* Start timer */</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">)</span> <span class="o">|</span> <span class="n">CR_TIMER_EN</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
					<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_XMIT</span><span class="p">;</span>
					
					<span class="cm">/* Enable timer interrupt */</span>
					<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_TIMER</span><span class="p">;</span>
					<span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>					
					
					<span class="cm">/* Timer will take care of the rest */</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> 
				<span class="p">}</span> 
				<span class="k">else</span>
					<span class="n">udelay</span><span class="p">(</span><span class="n">mtt</span><span class="p">);</span>
			<span class="p">}</span> <span class="c1">// if (if (mtt &gt; diff)</span>
		<span class="p">}</span><span class="c1">// if (mtt) </span>
				
		<span class="cm">/* Enable EOM interrupt */</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span> <span class="o">=</span> <span class="n">IER_EOM</span><span class="p">;</span>
		<span class="n">SetCOMInterrupts</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
		
		<span class="cm">/* Transmit frame */</span>
		<span class="n">ali_ircc_dma_xmit</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="p">}</span> <span class="c1">// if (self-&gt;tx_fifo.len == 1) </span>
	
 <span class="nl">out:</span>
 	
	<span class="cm">/* Not busy transmitting anymore if window is not full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">&lt;</span> <span class="n">MAX_TX_WINDOW</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	
	<span class="cm">/* Restore bank register */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>	
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ali_ircc_dma_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">FIFO_OPTI</span><span class="p">,</span> <span class="n">Hi</span><span class="p">,</span> <span class="n">Lo</span><span class="p">;</span>
	
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="cm">/* FIFO threshold , this method comes from NDIS5 code */</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">TX_FIFO_Threshold</span><span class="p">)</span>
		<span class="n">FIFO_OPTI</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">FIFO_OPTI</span> <span class="o">=</span> <span class="n">TX_FIFO_Threshold</span><span class="p">;</span>
	
	<span class="cm">/* Disable DMA */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_DMA_EN</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
	
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_XMIT</span><span class="p">;</span>
	
	<span class="n">irda_setup_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> 
		       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">start</span> <span class="o">-</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">,</span>
		       <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span><span class="p">,</span> 
		       <span class="n">DMA_TX_MODE</span><span class="p">);</span>
		
	<span class="cm">/* Reset Tx FIFO */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">LCR_A_FIFO_RESET</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_A</span><span class="p">);</span>
	
	<span class="cm">/* Set Tx FIFO threshold */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">fifo_opti_buf</span><span class="o">!=</span><span class="n">FIFO_OPTI</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	    	<span class="n">outb</span><span class="p">(</span><span class="n">FIFO_OPTI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_FIFO_TR</span><span class="p">)</span> <span class="p">;</span>
	    	<span class="n">self</span><span class="o">-&gt;</span><span class="n">fifo_opti_buf</span><span class="o">=</span><span class="n">FIFO_OPTI</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Set Tx DMA threshold */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">TX_DMA_Threshold</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_DMA_TR</span><span class="p">);</span>
	
	<span class="cm">/* Set max Tx frame size */</span>
	<span class="n">Hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">Lo</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">Hi</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_TX_DSR_HI</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">Lo</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_TX_DSR_LO</span><span class="p">);</span>
	
	<span class="cm">/* Disable SIP , Disable Brick Wall (we don&#39;t support in TX mode), Change to TX mode */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>	
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_B</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span> <span class="c1">// Disable SIP</span>
	<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCR_B_TX_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">LCR_B_BW</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_B</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), *** Change to TX mode: FIR_LCR_B = 0x%x ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_B</span><span class="p">));</span>
	
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LSR</span><span class="p">);</span>
			
	<span class="cm">/* Enable DMA and Burst Mode */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">)</span> <span class="o">|</span> <span class="n">CR_DMA_EN</span> <span class="o">|</span> <span class="n">CR_DMA_BURST</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
	
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span> 
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">ali_ircc_dma_xmit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="cm">/* Disable DMA */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_DMA_EN</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
	
	<span class="cm">/* Check for underrun! */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LSR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LSR_FRAME_ABORT</span><span class="p">)</span> <span class="o">==</span> <span class="n">LSR_FRAME_ABORT</span><span class="p">)</span>
	
	<span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s(), ********* LSR_FRAME_ABORT *********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> 
	<span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if we need to change the speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="n">ali_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finished with this frame, so prepare for next */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* Any frames to be sent back-to-back? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="n">ali_ircc_dma_xmit</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		
		<span class="cm">/* Not finished yet! */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span> 
	<span class="k">else</span> 
	<span class="p">{</span>	<span class="cm">/* Reset Tx FIFO info */</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure we have room for more frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">&lt;</span> <span class="n">MAX_TX_WINDOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Not busy transmitting anymore */</span>
		<span class="cm">/* Tell the network layer, that we can accept more frames */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
		
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span> 
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_dma_receive (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Get ready for receiving a frame. The device will initiate a DMA</span>
<span class="cm"> *    if it starts to receive a frame.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_dma_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="cm">/* Reset Tx FIFO info */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		
	<span class="cm">/* Disable DMA */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CR_DMA_EN</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
	
	<span class="cm">/* Reset Message Count */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LSR</span><span class="p">);</span>
		
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rcvFramesOverflow</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>	
	
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">LineStatus</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LSR</span><span class="p">)</span> <span class="p">;</span>
	
	<span class="cm">/* Reset Rx FIFO info */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_RECV</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		
	<span class="cm">/* Reset Rx FIFO */</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>switch_bank(iobase, BANK0);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">outb</span><span class="p">(</span><span class="n">LCR_A_FIFO_RESET</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_A</span><span class="p">);</span> 
	
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">pending_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		
	<span class="n">irda_setup_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
		       <span class="n">DMA_RX_MODE</span><span class="p">);</span>
	 
	<span class="cm">/* Set Receive Mode,Brick Wall */</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>switch_bank(iobase, BANK0);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_B</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">tmp</span> <span class="o">&amp;</span><span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="n">LCR_B_RX_MODE</span> <span class="o">|</span> <span class="n">LCR_B_BW</span> <span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">FIR_LCR_B</span><span class="p">);</span> <span class="c1">// 2000/12/1 05:16PM</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), *** Change To RX mode: FIR_LCR_B = 0x%x ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LCR_B</span><span class="p">));</span>
			
	<span class="cm">/* Set Rx Threshold */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">RX_FIFO_Threshold</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_FIFO_TR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">RX_DMA_Threshold</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_DMA_TR</span><span class="p">);</span>
		
	<span class="cm">/* Enable DMA and Burst Mode */</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>switch_bank(iobase, BANK1);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">outb</span><span class="p">(</span><span class="n">CR_DMA_EN</span> <span class="o">|</span> <span class="n">CR_DMA_BURST</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
				
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span> 
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">ali_ircc_dma_receive_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_fifo</span> <span class="o">*</span><span class="n">st_fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">MessageCount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>	

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="n">st_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">;</span>		
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>	
		
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
	<span class="n">MessageCount</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span> <span class="n">FIR_LSR</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x07</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">MessageCount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>	
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), Message count = %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">MessageCount</span><span class="p">);</span>
		
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">MessageCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Bank 0 */</span>
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_LSR</span><span class="p">);</span>
		
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK2</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_RX_DSR_HI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> 
		<span class="n">len</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_RX_DSR_LO</span><span class="p">);</span>
		
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), RX Length = 0x%.2x,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), RX Status = 0x%.2x,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&gt;=</span> <span class="n">MAX_RX_WINDOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), window is full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
			
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">pending_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">++</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
			
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">MessageCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>	
		<span class="cm">/* Get first entry */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
		<span class="n">len</span>    <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">pending_bytes</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>			
		
		<span class="cm">/* Check for errors */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xd8</span><span class="p">)</span> <span class="o">||</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rcvFramesOverflow</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span><span class="o">==</span><span class="mi">0</span><span class="p">))</span> 		
		<span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;%s(), ************* RX Errors ************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			
			<span class="cm">/* Skip frame */</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LSR_FIFO_UR</span><span class="p">)</span> 
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;%s(), ************* FIFO Errors ************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="p">}</span>	
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LSR_FRAME_ERROR</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;%s(), ************* FRAME Errors ************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="p">}</span>
							
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LSR_CRC_ERROR</span><span class="p">)</span> 
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;%s(), ************* CRC Errors ************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="p">}</span>
			
			<span class="k">if</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rcvFramesOverflow</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;%s(), ************* Overran DMA buffer ************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;%s(), ********** Receive Frame Size = 0 *********</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>	 
		<span class="k">else</span> 
		<span class="p">{</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">pending_bytes</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span> 
			<span class="p">{</span>
				<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_BSR</span><span class="p">);</span>	
				<span class="k">if</span> <span class="p">((</span><span class="n">val</span><span class="o">&amp;</span> <span class="n">BSR_FIFO_NOT_EMPTY</span><span class="p">)</span><span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> 
				<span class="p">{</span>
					<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), ************* BSR_FIFO_NOT_EMPTY ************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
					
					<span class="cm">/* Put this entry back in fifo */</span>
					<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">--</span><span class="p">;</span>
					<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
					<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">pending_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
					<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
					<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
						
					<span class="cm">/*  </span>
<span class="cm">		 			* DMA not finished yet, so try again </span>
<span class="cm">		 			* later, set timer value, resolution </span>
<span class="cm">		 			* 500 us </span>
<span class="cm">		 			*/</span>
					 
					<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">TIMER_IIR_500</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_TIMER_IIR</span><span class="p">);</span> <span class="c1">// 2001/1/2 05:07PM</span>
					
					<span class="cm">/* Enable Timer */</span>
					<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">)</span> <span class="o">|</span> <span class="n">CR_TIMER_EN</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_CR</span><span class="p">);</span>
						
					<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span> <span class="cm">/* I&#39;ll be back! */</span>
				<span class="p">}</span>
			<span class="p">}</span>		
			
			<span class="cm">/* </span>
<span class="cm">			 * Remember the time we received this frame, so we can</span>
<span class="cm">			 * reduce the min turn time a bit since we will know</span>
<span class="cm">			 * how much time we have used for protocol processing</span>
<span class="cm">			 */</span>
			<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">stamp</span><span class="p">);</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  
			<span class="p">{</span>
				<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s(), memory squeeze, &quot;</span>
					     <span class="s">&quot;dropping frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">__func__</span><span class="p">);</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

				<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="cm">/* Make sure IP header gets aligned */</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> 
			
			<span class="cm">/* Copy frame without CRC, CRC is removed by hardware*/</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="cm">/* Move to next frame */</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
			<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>	
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_sir_hard_xmit (skb, dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Transmit the frame!</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ali_ircc_sir_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">speed</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;);</span>
	
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">sir_base</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="cm">/* Make sure tests *&amp; speed change are atomic */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Note : you should make sure that speed changes are not going</span>
<span class="cm">	 * to corrupt any outgoing frame. Look at nsc-ircc for the gory</span>
<span class="cm">	 * details - Jean II */</span>

	<span class="cm">/* Check if we need to change the speed */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check for empty frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ali_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span> 
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init tx buffer */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>

        <span class="cm">/* Copy skb to tx_buff while wrapping, stuffing and making CRC */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">async_wrap_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> 
					   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>
	
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Turn on transmit finished interrupt. Will fire immediately!  */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">UART_IER_THRI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_IER</span><span class="p">);</span> 

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>	
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_net_ioctl (dev, rq, cmd)</span>
<span class="cm"> *</span>
<span class="cm"> *    Process IOCTL commands for this device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), %s, (cmd=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSBANDWIDTH</span>: <span class="cm">/* Set bandwidth */</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), SIOCSBANDWIDTH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * This function will also be used by IrLAP to change the</span>
<span class="cm">		 * speed, so we still must allow for speed change within</span>
<span class="cm">		 * interrupt context.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ali_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_baudrate</span><span class="p">);</span>		
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSMEDIABUSY</span>: <span class="cm">/* Set media busy */</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), SIOCSMEDIABUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">irda_device_set_media_busy</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGRECEIVING</span>: <span class="cm">/* Check if we are receiving right now */</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), SIOCGRECEIVING</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="cm">/* This is protected */</span>
		<span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_receiving</span> <span class="o">=</span> <span class="n">ali_ircc_is_receiving</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function ali_ircc_is_receiving (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Return TRUE is we are currently receiving a frame</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_is_receiving</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>		
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start -----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="n">FALSE</span><span class="p">;);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
		
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK1</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FIR_FIFO_FR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 		
		<span class="p">{</span>
			<span class="cm">/* We are receiving something */</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), We are receiving something</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>		
	<span class="p">}</span> 
	<span class="k">else</span>
	<span class="p">{</span> 
		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s, Suspending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ali_ircc_net_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ali_ircc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">ali_ircc_net_open</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	
	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s, Waking up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ALi Chip Function */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SetCOMInterrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ali_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">newMask</span><span class="p">;</span>
	
	<span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span> <span class="cm">/* or sir_base */</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), -------- Start -------- ( Enable = %d )</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	
	<span class="cm">/* Enable the interrupt which we wish to */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IO_XMIT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> <span class="cm">/* FIR, MIR */</span>
			<span class="p">{</span>
				<span class="n">newMask</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="cm">/* SIR */</span>
			<span class="p">{</span>
				<span class="n">newMask</span> <span class="o">=</span> <span class="n">UART_IER_THRI</span> <span class="o">|</span> <span class="n">UART_IER_RDI</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> <span class="cm">/* FIR, MIR */</span>
			<span class="p">{</span>
				<span class="n">newMask</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ier</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="cm">/* SIR */</span>
			<span class="p">{</span>
				<span class="n">newMask</span> <span class="o">=</span> <span class="n">UART_IER_RDI</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="cm">/* Disable all the interrupts */</span>
	<span class="p">{</span>
		<span class="n">newMask</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="p">}</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>SIR and FIR has different registers</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span>
	<span class="p">{</span>	
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">BANK0</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">newMask</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_IER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">newMask</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_IER</span><span class="p">);</span>
		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">SIR2FIR</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>unsigned char tmp;</p></td><td class="code"><div class="highlight"><pre>		
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="cm">/* Already protected (change_speed() or setup()), no need to lock.</span>
<span class="cm">	 * Jean II */</span>
	
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_MCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_MCR</span><span class="p">);</span>		
	
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_MCR</span><span class="p">);</span> 	<span class="cm">/*  Master Reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_MCR</span><span class="p">);</span> 	<span class="cm">/*  Master Interrupt Enable */</span>
	</pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>tmp = inb(iobase+FIR<em>LCR</em>B);    /* SIP enable */
tmp |= 0x20;
outb(tmp, iobase+FIR<em>LCR</em>B);    </p></td><td class="code"><div class="highlight"><pre>	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">FIR2SIR</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ---------------- Start ----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="cm">/* Already protected (change_speed() or setup()), no need to lock.</span>
<span class="cm">	 * Jean II */</span>
	
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_MCR</span><span class="p">);</span> 	<span class="cm">/* IRQ to low */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_IER</span><span class="p">);</span> 	
		
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xA0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">FIR_MCR</span><span class="p">);</span> 	<span class="cm">/* Don&#39;t set master reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_FCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UART_FCR</span><span class="p">);</span>		
	
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_RX</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_LSR</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">UART_MSR</span><span class="p">);</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), ----------------- End ------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Benjamin Kong &lt;benjamin_kong@ali.com.tw&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ALi FIR Controller Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:&quot;</span> <span class="n">ALI_IRCC_DRIVER_NAME</span><span class="p">);</span>


<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;Base I/O addresses&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ lines&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;DMA channels&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ali_ircc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ali_ircc_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
