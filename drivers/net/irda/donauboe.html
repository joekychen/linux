<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › irda › donauboe.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>donauboe.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Filename:		donauboe.c</span>
<span class="cm"> * Version: 		2.17</span>
<span class="cm"> * Description:   Driver for the Toshiba OBOE (or type-O or 701)</span>
<span class="cm"> *                FIR Chipset, also supports the DONAUOBOE (type-DO</span>
<span class="cm"> *                or d01) FIR chipset which as far as I know is</span>
<span class="cm"> *                register compatible.</span>
<span class="cm"> * Documentation: http://libxg.free.fr/irda/lib-irda.html</span>
<span class="cm"> * Status:        Experimental.</span>
<span class="cm"> * Author:        James McKenzie &lt;james@fishsoup.dhs.org&gt;</span>
<span class="cm"> * Created at:    Sat May 8  12:35:27 1999</span>
<span class="cm"> * Modified:      Paul Bristow &lt;paul.bristow@technologist.com&gt;</span>
<span class="cm"> * Modified:      Mon Nov 11 19:10:05 1999</span>
<span class="cm"> * Modified:      James McKenzie &lt;james@fishsoup.dhs.org&gt;</span>
<span class="cm"> * Modified:      Thu Mar 16 12:49:00 2000 (Substantial rewrite)</span>
<span class="cm"> * Modified:      Sat Apr 29 00:23:03 2000 (Added DONAUOBOE support)</span>
<span class="cm"> * Modified:      Wed May 24 23:45:02 2000 (Fixed chipio_t structure)</span>
<span class="cm"> * Modified: 2.13 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;</span>
<span class="cm"> * Modified: 2.13 dim jan 07 21:57:39 2001 (tested with kernel 2.4 &amp; irnet/ppp)</span>
<span class="cm"> * Modified: 2.14 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;</span>
<span class="cm"> * Modified: 2.14 lun fev 05 17:55:59 2001 (adapted to patch-2.4.1-pre8-irda1)</span>
<span class="cm"> * Modified: 2.15 Martin Lucina &lt;mato@kotelna.sk&gt;</span>
<span class="cm"> * Modified: 2.15 Fri Jun 21 20:40:59 2002 (sync with 2.4.18, substantial fixes)</span>
<span class="cm"> * Modified: 2.16 Martin Lucina &lt;mato@kotelna.sk&gt;</span>
<span class="cm"> * Modified: 2.16 Sat Jun 22 18:54:29 2002 (fix freeregion, default to verbose)</span>
<span class="cm"> * Modified: 2.17 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;</span>
<span class="cm"> * Modified: 2.17 jeu sep 12 08:50:20 2002 (save_flags();cli(); replaced by spinlocks)</span>
<span class="cm"> * Modified: 2.18 Christian Gennerat &lt;christian.gennerat@polytechnique.org&gt;</span>
<span class="cm"> * Modified: 2.18 ven jan 10 03:14:16 2003 Change probe default options</span>
<span class="cm"> *</span>
<span class="cm"> *     Copyright (c) 1999 James McKenzie, All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *     This program is free software; you can redistribute it and/or</span>
<span class="cm"> *     modify it under the terms of the GNU General Public License as</span>
<span class="cm"> *     published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> *     the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *     Neither James McKenzie nor Cambridge University admit liability nor</span>
<span class="cm"> *     provide warranty for any of this software. This material is</span>
<span class="cm"> *     provided &quot;AS-IS&quot; and at no charge.</span>
<span class="cm"> *</span>
<span class="cm"> *     Applicable Models : Libretto 100/110CT and many more.</span>
<span class="cm"> *     Toshiba refers to this chip as the type-O IR port,</span>
<span class="cm"> *     or the type-DO IR port.</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="cm">/* Look at toshoboe.h (currently in include/net/irda) for details of */</span>
<span class="cm">/* Where to get documentation on the chip         */</span>

<span class="cm">/* See below for a description of the logic in this driver */</span>

<span class="cm">/* User servicable parts */</span>
<span class="cm">/* USE_PROBE Create the code which probes the chip and does a few tests */</span>
<span class="cm">/* do_probe module parameter Enable this code */</span>
<span class="cm">/* Probe code is very useful for understanding how the hardware works */</span>
<span class="cm">/* Use it with various combinations of TT_LEN, RX_LEN */</span>
<span class="cm">/* Strongly recommended, disable if the probe fails on your machine */</span>
<span class="cm">/* and send me &lt;james@fishsoup.dhs.org&gt; the output of dmesg */</span>
<span class="cp">#define USE_PROBE 1</span>
<span class="cp">#undef  USE_PROBE</span>

<span class="cm">/* Trace Transmit ring, interrupts, Receive ring or not ? */</span>
<span class="cp">#define PROBE_VERBOSE 1</span>

<span class="cm">/* Debug option, examine sent and received raw data */</span>
<span class="cm">/* Irdadump is better, but does not see all packets. enable it if you want. */</span>
<span class="cp">#undef DUMP_PACKETS</span>

<span class="cm">/* MIR mode has not been tested. Some behaviour is different */</span>
<span class="cm">/* Seems to work against an Ericsson R520 for me. -Martin */</span>
<span class="cp">#define USE_MIR</span>

<span class="cm">/* Schedule back to back hardware transmits wherever possible, otherwise */</span>
<span class="cm">/* we need an interrupt for every frame, unset if oboe works for a bit and */</span>
<span class="cm">/* then hangs */</span>
<span class="cp">#define OPTIMIZE_TX</span>

<span class="cm">/* Set the number of slots in the rings */</span>
<span class="cm">/* If you get rx/tx fifo overflows at high bitrates, you can try increasing */</span>
<span class="cm">/* these */</span>

<span class="cp">#define RING_SIZE (OBOE_RING_SIZE_RX8 | OBOE_RING_SIZE_TX8)</span>
<span class="cp">#define TX_SLOTS    8</span>
<span class="cp">#define RX_SLOTS    8</span>


<span class="cm">/* Less user servicable parts below here */</span>

<span class="cm">/* Test, Transmit and receive buffer sizes, adjust at your peril */</span>
<span class="cm">/* remarks: nfs usually needs 1k blocks */</span>
<span class="cm">/* remarks: in SIR mode, CRC is received, -&gt; RX_LEN=TX_LEN+2 */</span>
<span class="cm">/* remarks: test accepts large blocks. Standard is 0x80 */</span>
<span class="cm">/* When TT_LEN &gt; RX_LEN (SIR mode) data is stored in successive slots. */</span>
<span class="cm">/* When 3 or more slots are needed for each test packet, */</span>
<span class="cm">/* data received in the first slots is overwritten, even */</span>
<span class="cm">/* if OBOE_CTL_RX_HW_OWNS is not set, without any error! */</span>
<span class="cp">#define TT_LEN      0x80</span>
<span class="cp">#define TX_LEN      0xc00</span>
<span class="cp">#define RX_LEN      0xc04</span>
<span class="cm">/* Real transmitted length (SIR mode) is about 14+(2%*TX_LEN) more */</span>
<span class="cm">/* long than user-defined length (see async_wrap_skb) and is less then 4K */</span>
<span class="cm">/* Real received length is (max RX_LEN) differs from user-defined */</span>
<span class="cm">/* length only b the CRC (2 or 4 bytes) */</span>
<span class="cp">#define BUF_SAFETY  0x7a</span>
<span class="cp">#define RX_BUF_SZ   (RX_LEN)</span>
<span class="cp">#define TX_BUF_SZ   (TX_LEN+BUF_SAFETY)</span>


<span class="cm">/* Logic of the netdev part of this driver                             */</span>

<span class="cm">/* The RX ring is filled with buffers, when a packet arrives           */</span>
<span class="cm">/* it is DMA&#39;d into the buffer which is marked used and RxDone called  */</span>
<span class="cm">/* RxDone forms an skb (and checks the CRC if in SIR mode) and ships   */</span>
<span class="cm">/* the packet off upstairs */</span>

<span class="cm">/* The transmitter on the oboe chip can work in one of two modes       */</span>
<span class="cm">/* for each ring-&gt;tx[] the transmitter can either                      */</span>
<span class="cm">/* a) transmit the packet, leave the trasmitter enabled and proceed to */</span>
<span class="cm">/*    the next ring                                                    */</span>
<span class="cm">/* OR                                                                  */</span>
<span class="cm">/* b) transmit the packet, switch off the transmitter and issue TxDone */</span>

<span class="cm">/* All packets are entered into the ring in mode b), if the ring was   */</span>
<span class="cm">/* empty the transmitter is started.                                   */</span>

<span class="cm">/* If OPTIMIZE_TX is defined then in TxDone if the ring contains       */</span>
<span class="cm">/* more than one packet, all but the last are set to mode a) [HOWEVER  */</span>
<span class="cm">/* the hardware may not notice this, this is why we start in mode b) ] */</span>
<span class="cm">/* then restart the transmitter                                        */</span>

<span class="cm">/* If OPTIMIZE_TX is not defined then we just restart the transmitter  */</span>
<span class="cm">/* if the ring isn&#39;t empty */</span>

<span class="cm">/* Speed changes are delayed until the TxRing is empty                 */</span>
<span class="cm">/* mtt is handled by generating packets with bad CRCs, before the data */</span>

<span class="cm">/* TODO: */</span>
<span class="cm">/* check the mtt works ok      */</span>
<span class="cm">/* finish the watchdog         */</span>

<span class="cm">/* No user servicable parts below here */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;net/irda/wrapper.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>include <net/irda/irmod.h></h1>

<h1>include <net/irda/irlap_frame.h></h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;net/irda/irda_device.h&gt;</span>
<span class="cp">#include &lt;net/irda/crc.h&gt;</span>

<span class="cp">#include &quot;donauboe.h&quot;</span>

<span class="cp">#define INB(port)       inb_p(port)</span>
<span class="cp">#define OUTB(val,port)  outb_p(val,port)</span>
<span class="cp">#define OUTBP(val,port) outb_p(val,port)</span>

<span class="cp">#define PROMPT  OUTB(OBOE_PROMPT_BIT,OBOE_PROMPT);</span>

<span class="cp">#if PROBE_VERBOSE</span>
<span class="cp">#define PROBE_DEBUG(args...) (printk (args))</span>
<span class="cp">#else</span>
<span class="cp">#define PROBE_DEBUG(args...) ;</span>
<span class="cp">#endif</span>

<span class="cm">/* Set the DMA to be byte at a time */</span>
<span class="cp">#define CONFIG0H_DMA_OFF OBOE_CONFIG0H_RCVANY</span>
<span class="cp">#define CONFIG0H_DMA_ON_NORX CONFIG0H_DMA_OFF| OBOE_CONFIG0H_ENDMAC</span>
<span class="cp">#define CONFIG0H_DMA_ON CONFIG0H_DMA_ON_NORX | OBOE_CONFIG0H_ENRX</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">toshoboe_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_TOSHIBA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FIR701</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_TOSHIBA</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FIRD01</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>			<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">toshoboe_pci_tbl</span><span class="p">);</span>

<span class="cp">#define DRIVER_NAME &quot;toshoboe&quot;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">max_baud</span> <span class="o">=</span> <span class="mi">4000000</span><span class="p">;</span>
<span class="cp">#ifdef USE_PROBE</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">do_probe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>


<span class="cm">/**********************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_checkfcs</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">union</span>
  <span class="p">{</span>
    <span class="n">__u16</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">__u8</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">fcs</span><span class="p">;</span>

  <span class="n">fcs</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">INIT_FCS</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">fcs</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">irda_fcs</span> <span class="p">(</span><span class="n">fcs</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">++</span><span class="p">));</span>

  <span class="k">return</span> <span class="n">fcs</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">GOOD_FCS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************/</span>
<span class="cm">/* Generic chip handling code */</span>
<span class="cp">#ifdef DUMP_PACKETS</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dump</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">_dumpbufs</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="n">tete</span><span class="p">)</span>
<span class="p">{</span>
<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">head</span><span class="o">=</span><span class="n">tete</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span><span class="n">i</span><span class="o">+=</span><span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;</span><span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dump</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">],</span><span class="s">&quot;%02x.&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]);</span> <span class="p">}</span>
    <span class="n">dump</span> <span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%c%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">head</span> <span class="p">,</span> <span class="n">dump</span><span class="p">);</span>
    <span class="n">head</span><span class="o">=</span><span class="sc">&#39;+&#39;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef USE_PROBE</span>
<span class="cm">/* Dump the registers */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_dumpregs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u32</span> <span class="n">ringbase</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="n">ringbase</span> <span class="o">=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_RING_BASE0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">ringbase</span> <span class="o">|=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_RING_BASE1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">;</span>
  <span class="n">ringbase</span> <span class="o">|=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_RING_BASE2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">;</span>

  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: Register dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Interrupts: Tx:%d Rx:%d TxUnder:%d RxOver:%d Sip:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_tx</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rx</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_txunder</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rxover</span><span class="p">,</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_sip</span><span class="p">);</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RX %02x TX %02x RingBase %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_RXSLOT</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_TXSLOT</span><span class="p">),</span> <span class="n">ringbase</span><span class="p">);</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RING_SIZE %02x IER %02x ISR %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_RING_SIZE</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_IER</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ISR</span><span class="p">));</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CONFIG1 %02x STATUS %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_CONFIG1</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_STATUS</span><span class="p">));</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CONFIG0 %02x%02x ENABLE %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_CONFIG0H</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_CONFIG0L</span><span class="p">),</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEL</span><span class="p">));</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;NEW_PCONFIG %02x%02x CURR_PCONFIG %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_NEW_PCONFIGH</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_NEW_PCONFIGL</span><span class="p">),</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_CURR_PCONFIGH</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_CURR_PCONFIGL</span><span class="p">));</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MAXLEN %02x%02x RXCOUNT %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_MAXLENH</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_MAXLENL</span><span class="p">),</span>
          <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_RXCOUNTL</span><span class="p">),</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_RXCOUNTH</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
      <span class="n">ringbase</span> <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Ring at %08x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ringbase</span><span class="p">);</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;RX:&quot;</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">printk</span> <span class="p">(</span><span class="s">&quot; (%d,%02x)&quot;</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>
      <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;TX:&quot;</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="n">printk</span> <span class="p">(</span><span class="s">&quot; (%d,%02x)&quot;</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>
      <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*Don&#39;t let the chip look at memory */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_disablebm</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u8</span> <span class="n">command</span><span class="p">;</span>
  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="n">pci_read_config_byte</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
  <span class="n">command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_MASTER</span><span class="p">;</span>
  <span class="n">pci_write_config_byte</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Shutdown the chip and point the taskfile reg somewhere else */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_stopchip</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="cm">/*Disable interrupts */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OBOE_IER</span><span class="p">);</span>
  <span class="cm">/*Disable DMA, Disable Rx, Disable Tx */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">CONFIG0H_DMA_OFF</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H</span><span class="p">);</span>
  <span class="cm">/*Disable SIR MIR FIR, Tx and Rx */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
  <span class="cm">/*Point the ring somewhere safe */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x3f</span><span class="p">,</span> <span class="n">OBOE_RING_BASE2</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_RING_BASE1</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_RING_BASE0</span><span class="p">);</span>

  <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">OBOE_MAXLENH</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_MAXLENL</span><span class="p">);</span>

  <span class="cm">/*Acknoledge any pending interrupts */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_ISR</span><span class="p">);</span>

  <span class="cm">/*Why */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH_PHYANDCLOCK</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>

  <span class="cm">/*switch it off */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_CONFIG1_OFF</span><span class="p">,</span> <span class="n">OBOE_CONFIG1</span><span class="p">);</span>

  <span class="n">toshoboe_disablebm</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Transmitter initialization */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_start_DMA</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opts</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">CONFIG0H_DMA_ON</span> <span class="o">|</span> <span class="n">opts</span><span class="p">,</span>  <span class="n">OBOE_CONFIG0H</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH_PHYANDCLOCK</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
  <span class="n">PROMPT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*Set the baud rate */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_setbaud</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u16</span> <span class="n">pconfig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">__u8</span> <span class="n">config0l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="mi">2400</span>:
    <span class="k">case</span> <span class="mi">4800</span>:
    <span class="k">case</span> <span class="mi">9600</span>:
    <span class="k">case</span> <span class="mi">19200</span>:
    <span class="k">case</span> <span class="mi">38400</span>:
    <span class="k">case</span> <span class="mi">57600</span>:
    <span class="k">case</span> <span class="mi">115200</span>:
<span class="cp">#ifdef USE_MIR</span>
    <span class="k">case</span> <span class="mi">1152000</span>:
<span class="cp">#endif</span>
    <span class="k">case</span> <span class="mi">4000000</span>:
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>

      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: switch to unsupported baudrate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
              <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* For SIR the preamble is done by adding XBOFs */</span>
      <span class="cm">/* to the packet */</span>
      <span class="cm">/* set to filtered SIR mode, filter looks for BOF and EOF */</span>
    <span class="k">case</span> <span class="mi">2400</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">47</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">4800</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">23</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">9600</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">11</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">19200</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">38400</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">57600</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">115200</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="cm">/*Set to packet based reception */</span>
      <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">OBOE_MAXLENH</span><span class="p">);</span>
      <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_MAXLENL</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="mi">2400</span>:
    <span class="k">case</span> <span class="mi">4800</span>:
    <span class="k">case</span> <span class="mi">9600</span>:
    <span class="k">case</span> <span class="mi">19200</span>:
    <span class="k">case</span> <span class="mi">38400</span>:
    <span class="k">case</span> <span class="mi">57600</span>:
    <span class="k">case</span> <span class="mi">115200</span>:
      <span class="n">config0l</span> <span class="o">=</span> <span class="n">OBOE_CONFIG0L_ENSIR</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="cm">/*Set to character based reception */</span>
          <span class="cm">/*System will lock if MAXLEN=0 */</span>
          <span class="cm">/*so have to be careful */</span>
          <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">OBOE_MAXLENH</span><span class="p">);</span>
          <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">OBOE_MAXLENL</span><span class="p">);</span>
          <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">OBOE_MAXLENH</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="k">else</span>
        <span class="p">{</span>
          <span class="cm">/*Set to packet based reception */</span>
          <span class="n">config0l</span> <span class="o">|=</span> <span class="n">OBOE_CONFIG0L_ENSIRF</span><span class="p">;</span>
          <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">OBOE_MAXLENH</span><span class="p">);</span>
          <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_MAXLENL</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef USE_MIR</span>
      <span class="cm">/* MIR mode */</span>
      <span class="cm">/* Set for 16 bit CRC and enable MIR */</span>
      <span class="cm">/* Preamble now handled by the chip */</span>
    <span class="k">case</span> <span class="mi">1152000</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_WIDTHSHIFT</span><span class="p">;</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_PREAMBLESHIFT</span><span class="p">;</span>
      <span class="n">config0l</span> <span class="o">=</span> <span class="n">OBOE_CONFIG0L_CRC16</span> <span class="o">|</span> <span class="n">OBOE_CONFIG0L_ENMIR</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
      <span class="cm">/* FIR mode */</span>
      <span class="cm">/* Set for 32 bit CRC and enable FIR */</span>
      <span class="cm">/* Preamble handled by the chip */</span>
    <span class="k">case</span> <span class="mi">4000000</span>:
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_BAUDSHIFT</span><span class="p">;</span>
      <span class="cm">/* Documentation says 14, but toshiba use 15 in their drivers */</span>
      <span class="n">pconfig</span> <span class="o">|=</span> <span class="mi">15</span> <span class="o">&lt;&lt;</span> <span class="n">OBOE_PCONFIG_PREAMBLESHIFT</span><span class="p">;</span>
      <span class="n">config0l</span> <span class="o">=</span> <span class="n">OBOE_CONFIG0L_ENFIR</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* Copy into new PHY config buffer */</span>
  <span class="n">OUTBP</span> <span class="p">(</span><span class="n">pconfig</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">OBOE_NEW_PCONFIGH</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">pconfig</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_NEW_PCONFIGL</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">config0l</span><span class="p">,</span> <span class="n">OBOE_CONFIG0L</span><span class="p">);</span>

  <span class="cm">/* Now make OBOE copy from new PHY to current PHY */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH_PHYANDCLOCK</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
  <span class="n">PROMPT</span><span class="p">;</span>

  <span class="cm">/* speed change executed */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*Let the chip look at memory */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_enablebm</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
  <span class="n">pci_set_master</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*setup the ring */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_initring</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">RX_LEN</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">address</span> <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">OBOE_CTL_RX_HW_OWNS</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_resetptrs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* Can reset pointers by twidling DMA */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
  <span class="n">OUTBP</span> <span class="p">(</span><span class="n">CONFIG0H_DMA_OFF</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH_PHYANDCLOCK</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span> <span class="o">=</span> <span class="n">inb_p</span> <span class="p">(</span><span class="n">OBOE_RXSLOT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_SLOT_MASK</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span> <span class="o">=</span> <span class="n">inb_p</span> <span class="p">(</span><span class="n">OBOE_TXSLOT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_SLOT_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called in locked state */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_initptrs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>

  <span class="cm">/* spin_lock_irqsave(self-&gt;spinlock, flags); */</span>
  <span class="cm">/* save_flags (flags); */</span>

  <span class="cm">/* Can reset pointers by twidling DMA */</span>
  <span class="n">toshoboe_resetptrs</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">CONFIG0H_DMA_ON</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH_PHYANDCLOCK</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* spin_unlock_irqrestore(self-&gt;spinlock, flags); */</span>
  <span class="cm">/* restore_flags (flags); */</span>
<span class="p">}</span>

<span class="cm">/* Wake the chip up and get it looking at the rings */</span>
<span class="cm">/* Called in locked state */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_startchip</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">__u32</span> <span class="n">physaddr</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="n">toshoboe_initring</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">toshoboe_enablebm</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">OUTBP</span> <span class="p">(</span><span class="n">OBOE_CONFIG1_RESET</span><span class="p">,</span> <span class="n">OBOE_CONFIG1</span><span class="p">);</span>
  <span class="n">OUTBP</span> <span class="p">(</span><span class="n">OBOE_CONFIG1_ON</span><span class="p">,</span> <span class="n">OBOE_CONFIG1</span><span class="p">);</span>

  <span class="cm">/* Stop the clocks */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>

  <span class="cm">/*Set size of rings */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">RING_SIZE</span><span class="p">,</span> <span class="n">OBOE_RING_SIZE</span><span class="p">);</span>

  <span class="cm">/*Acknoledge any pending interrupts */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_ISR</span><span class="p">);</span>

  <span class="cm">/*Enable ints */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_INT_TXDONE</span>  <span class="o">|</span> <span class="n">OBOE_INT_RXDONE</span> <span class="o">|</span>
        <span class="n">OBOE_INT_TXUNDER</span> <span class="o">|</span> <span class="n">OBOE_INT_RXOVER</span> <span class="o">|</span> <span class="n">OBOE_INT_SIP</span> <span class="p">,</span> <span class="n">OBOE_IER</span><span class="p">);</span>

  <span class="cm">/*Acknoledge any pending interrupts */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_ISR</span><span class="p">);</span>

  <span class="cm">/*Set the maximum packet length to 0xfff (4095) */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">OBOE_MAXLENH</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">RX_LEN</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_MAXLENL</span><span class="p">);</span>

  <span class="cm">/*Shutdown DMA */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">CONFIG0H_DMA_OFF</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H</span><span class="p">);</span>

  <span class="cm">/*Find out where the rings live */</span>
  <span class="n">physaddr</span> <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">);</span>

  <span class="n">IRDA_ASSERT</span> <span class="p">((</span><span class="n">physaddr</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;ring not correctly aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	       <span class="k">return</span><span class="p">;);</span>

  <span class="n">OUTB</span> <span class="p">((</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_RING_BASE0</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">((</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">OBOE_RING_BASE1</span><span class="p">);</span>
  <span class="n">OUTB</span> <span class="p">((</span><span class="n">physaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">OBOE_RING_BASE2</span><span class="p">);</span>

  <span class="cm">/*Enable DMA controller in byte mode and RX */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">CONFIG0H_DMA_ON</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H</span><span class="p">);</span>

  <span class="cm">/* Start up the clocks */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH_PHYANDCLOCK</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>

  <span class="cm">/*set to sensible speed */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
  <span class="n">toshoboe_setbaud</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">toshoboe_initptrs</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_isntstuck</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_checkstuck</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

      <span class="cm">/* This will reset the chip completely */</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: Resetting chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

      <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="n">toshoboe_startchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*Generate packet of about mtt us long */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_makemttpacket</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtt</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">xbofs</span><span class="p">;</span>

  <span class="n">xbofs</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">mtt</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
  <span class="n">xbofs</span><span class="o">=</span><span class="n">xbofs</span><span class="o">/</span><span class="mi">80000</span><span class="p">;</span> <span class="cm">/*Eight bits per byte, and mtt is in us*/</span>
  <span class="n">xbofs</span><span class="o">++</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">DRIVER_NAME</span>
      <span class="s">&quot;: generated mtt of %d bytes for %d us at %d baud</span><span class="se">\n</span><span class="s">&quot;</span>
	  <span class="p">,</span> <span class="n">xbofs</span><span class="p">,</span><span class="n">mtt</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">xbofs</span> <span class="o">&gt;</span> <span class="n">TX_LEN</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: wanted %d bytes MTT but TX_LEN is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
              <span class="n">xbofs</span><span class="p">,</span> <span class="n">TX_LEN</span><span class="p">);</span>
      <span class="n">xbofs</span> <span class="o">=</span> <span class="n">TX_LEN</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/*xbofs will do for SIR, MIR and FIR,SIR mode doesn&#39;t generate a checksum anyway */</span>
  <span class="n">memset</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">XBOF</span><span class="p">,</span> <span class="n">xbofs</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">xbofs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef USE_PROBE</span>
<span class="cm">/***********************************************************************/</span>
<span class="cm">/* Probe code */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_dumptx</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;TX:&quot;</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot; (%d,%02x)&quot;</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>
  <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot; [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_dumprx</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">score</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot; %d</span><span class="se">\n</span><span class="s">RX:&quot;</span><span class="p">,</span><span class="n">score</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot; (%d,%02x)&quot;</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>
  <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">stuff_byte</span> <span class="p">(</span><span class="n">__u8</span> <span class="n">byte</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span> <span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">BOF</span>:                  <span class="cm">/* FALLTHROUGH */</span>
    <span class="k">case</span> <span class="n">EOF</span>:                  <span class="cm">/* FALLTHROUGH */</span>
    <span class="k">case</span> <span class="n">CE</span>:
      <span class="cm">/* Insert transparently coded */</span>
      <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CE</span><span class="p">;</span>              <span class="cm">/* Send link escape */</span>
      <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte</span> <span class="o">^</span> <span class="n">IRDA_TRANS</span><span class="p">;</span> <span class="cm">/* Complement bit 5 */</span>
      <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
      <span class="cm">/* break; */</span>
    <span class="nl">default:</span>
      <span class="cm">/* Non-special value, no transparency required */</span>
      <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="cm">/* break; */</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">toshoboe_probeinterrupt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
  <span class="n">__u8</span> <span class="n">irqstat</span><span class="p">;</span>

  <span class="n">irqstat</span> <span class="o">=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ISR</span><span class="p">);</span>

<span class="cm">/* was it us */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_MASK</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

<span class="cm">/* Ack all the interrupts */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">irqstat</span><span class="p">,</span> <span class="n">OBOE_ISR</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_TXDONE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">int</span> <span class="n">txp</span><span class="p">;</span>

      <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_tx</span><span class="o">++</span><span class="p">;</span>
      <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot;T&quot;</span><span class="p">);</span>

      <span class="n">txp</span> <span class="o">=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_TXSLOT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_SLOT_MASK</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">txp</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_tx</span><span class="o">+=</span><span class="mi">100</span><span class="p">;</span>
          <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot;S&quot;</span><span class="p">);</span>
          <span class="n">toshoboe_start_DMA</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H_ENTX</span> <span class="o">|</span> <span class="n">OBOE_CONFIG0H_LOOP</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_RXDONE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rx</span><span class="o">++</span><span class="p">;</span>
    <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot;R&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_TXUNDER</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_txunder</span><span class="o">++</span><span class="p">;</span>
    <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot;U&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_RXOVER</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rxover</span><span class="o">++</span><span class="p">;</span>
    <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot;O&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_SIP</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_sip</span><span class="o">++</span><span class="p">;</span>
    <span class="n">PROBE_DEBUG</span><span class="p">(</span><span class="s">&quot;I&quot;</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_maketestpacket</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">badcrc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fir</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">union</span>
  <span class="p">{</span>
    <span class="n">__u16</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">__u8</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="n">fcs</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fir</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">memset</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TT_LEN</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">TT_LEN</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">fcs</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">INIT_FCS</span><span class="p">;</span>

  <span class="n">memset</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">XBOF</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="n">len</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">BOF</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TT_LEN</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">len</span> <span class="o">+=</span> <span class="n">stuff_byte</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
      <span class="n">fcs</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">irda_fcs</span> <span class="p">(</span><span class="n">fcs</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">len</span> <span class="o">+=</span> <span class="n">stuff_byte</span> <span class="p">(</span><span class="n">fcs</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">badcrc</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">len</span> <span class="o">+=</span> <span class="n">stuff_byte</span> <span class="p">(</span><span class="n">fcs</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">^</span> <span class="n">badcrc</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
  <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">EOF</span><span class="p">;</span>
  <span class="n">len</span><span class="o">++</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_probefail</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;probe(%d) failed %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span> <span class="n">speed</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
  <span class="n">toshoboe_dumpregs</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">free_irq</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_numvalidrcvs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">ret</span><span class="o">++</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_numrcvs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_RX_HW_OWNS</span><span class="p">))</span>
      <span class="n">ret</span><span class="o">++</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_probe</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
<span class="cp">#ifdef USE_MIR</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bauds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="mi">4000000</span><span class="p">,</span> <span class="mi">1152000</span> <span class="p">};</span>
<span class="cp">#else</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bauds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">115200</span><span class="p">,</span> <span class="mi">4000000</span> <span class="p">};</span>
<span class="cp">#endif</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">toshoboe_probeinterrupt</span><span class="p">,</span>
                   <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqflags</span><span class="p">,</span> <span class="s">&quot;toshoboe&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: probe failed to allocate irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
              <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="cm">/* test 1: SIR filter and back to back */</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bauds</span><span class="p">);</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">int</span> <span class="n">fir</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>


      <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
      <span class="cm">/*Address is already setup */</span>
      <span class="n">toshoboe_startchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rx</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">bauds</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
      <span class="n">toshoboe_setbaud</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="n">toshoboe_initptrs</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span>
<span class="cm">/*   (FIR only) OBOE_CTL_TX_SIP needed for switching to next slot */</span>
<span class="cm">/*    MIR: all received data is stored in one slot */</span>
        <span class="p">(</span><span class="n">fir</span><span class="p">)</span> <span class="o">?</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_RTCENTX</span>
              <span class="o">:</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
        <span class="n">toshoboe_maketestpacket</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fir</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="o">++</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span> <span class="o">%=</span> <span class="n">TX_SLOTS</span><span class="p">;</span>

      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span>
        <span class="p">(</span><span class="n">fir</span><span class="p">)</span> <span class="o">?</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_SIP</span>
              <span class="o">:</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_RTCENTX</span> <span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
        <span class="n">toshoboe_maketestpacket</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fir</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="o">++</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span> <span class="o">%=</span> <span class="n">TX_SLOTS</span><span class="p">;</span>

      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span>
        <span class="p">(</span><span class="n">fir</span><span class="p">)</span> <span class="o">?</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_RTCENTX</span>
              <span class="o">:</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
        <span class="n">toshoboe_maketestpacket</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fir</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="o">++</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span> <span class="o">%=</span> <span class="n">TX_SLOTS</span><span class="p">;</span>

      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span>
        <span class="p">(</span><span class="n">fir</span><span class="p">)</span> <span class="o">?</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_RTCENTX</span>
              <span class="o">|</span> <span class="n">OBOE_CTL_TX_SIP</span>     <span class="o">|</span> <span class="n">OBOE_CTL_TX_BAD_CRC</span>
              <span class="o">:</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_RTCENTX</span> <span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
        <span class="n">toshoboe_maketestpacket</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fir</span><span class="p">);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="o">++</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span> <span class="o">%=</span> <span class="n">TX_SLOTS</span><span class="p">;</span>

      <span class="n">toshoboe_dumptx</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
      <span class="cm">/* Turn on TX and RX and loopback */</span>
      <span class="n">toshoboe_start_DMA</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H_ENTX</span> <span class="o">|</span> <span class="n">OBOE_CONFIG0H_LOOP</span><span class="p">);</span>

      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">n</span> <span class="o">=</span> <span class="n">fir</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">toshoboe_numvalidrcvs</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">4800</span><span class="p">)</span>
              <span class="k">return</span> <span class="n">toshoboe_probefail</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s">&quot;filter test&quot;</span><span class="p">);</span>
          <span class="n">udelay</span> <span class="p">((</span><span class="mi">9600</span><span class="o">*</span><span class="p">(</span><span class="n">TT_LEN</span><span class="o">+</span><span class="mi">16</span><span class="p">))</span><span class="o">/</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="n">n</span> <span class="o">=</span> <span class="n">fir</span> <span class="o">?</span> <span class="mi">203</span> <span class="o">:</span> <span class="mi">102</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">((</span><span class="n">toshoboe_numrcvs</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rx</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">!=</span> <span class="n">n</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">4800</span><span class="p">)</span>
              <span class="k">return</span> <span class="n">toshoboe_probefail</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s">&quot;interrupt test&quot;</span><span class="p">);</span>
          <span class="n">udelay</span> <span class="p">((</span><span class="mi">9600</span><span class="o">*</span><span class="p">(</span><span class="n">TT_LEN</span><span class="o">+</span><span class="mi">16</span><span class="p">))</span><span class="o">/</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
          <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
     <span class="n">toshoboe_dumprx</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>

     <span class="p">}</span>

  <span class="cm">/* test 2: SIR in char at a time */</span>

  <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rx</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">toshoboe_startchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
  <span class="n">toshoboe_setbaud</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span>
    <span class="n">OBOE_CTL_TX_RTCENTX</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">;</span>
  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;i&#39;</span><span class="p">;</span>
  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">])[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="p">;</span>
  <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">])[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;h&#39;</span><span class="p">;</span>
  <span class="n">toshoboe_dumptx</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">toshoboe_start_DMA</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H_ENTX</span> <span class="o">|</span> <span class="n">OBOE_CONFIG0H_LOOP</span><span class="p">);</span>

  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">toshoboe_numvalidrcvs</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">toshoboe_probefail</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s">&quot;Async test&quot;</span><span class="p">);</span>
      <span class="n">udelay</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">while</span> <span class="p">((</span><span class="n">toshoboe_numrcvs</span> <span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_rx</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">int_tx</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">toshoboe_probefail</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="s">&quot;Async interrupt test&quot;</span><span class="p">);</span>
      <span class="n">udelay</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
      <span class="n">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">toshoboe_dumprx</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
  <span class="n">toshoboe_setbaud</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>

  <span class="n">free_irq</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">);</span>

  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: Self test passed ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/******************************************************************/</span>
<span class="cm">/* Netdev style code */</span>

<span class="cm">/* Transmit something */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">toshoboe_hard_xmit</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
  <span class="n">__s32</span> <span class="n">speed</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">mtt</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ctl</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">irda_skb_cb</span> <span class="o">*</span><span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">irda_skb_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>

  <span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="n">IRDA_ASSERT</span> <span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span> <span class="p">);</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s.tx:%x(%x)%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
      <span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">,</span><span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s.Not IrLAP:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>
<span class="cp">#ifdef DUMP_PACKETS</span>
      <span class="n">_dumpbufs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>

  <span class="cm">/* change speed pending, wait for its execution */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

  <span class="cm">/* device stopped (apm) wait for restart */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

  <span class="n">toshoboe_checkstuck</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>

 <span class="cm">/* Check if we need to change the speed */</span>
  <span class="cm">/* But not now. Wait after transmission if mtt not required */</span>
  <span class="n">speed</span><span class="o">=</span><span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
          <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Queued TxDone scheduled speed change %d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="p">,</span>
		      <span class="n">__func__</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
          <span class="cm">/* if no data, that&#39;s all! */</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
            <span class="p">{</span>
	      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
              <span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
              <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="cm">/* True packet, go on, but */</span>
          <span class="cm">/* do not accept anything before change speed execution */</span>
          <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
          <span class="cm">/* ready to process TxDone interrupt */</span>
	  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="k">else</span>
        <span class="p">{</span>
          <span class="cm">/* idle and no data, change speed now */</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
          <span class="n">toshoboe_setbaud</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
	  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
          <span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">mtt</span> <span class="o">=</span> <span class="n">irda_get_mtt</span><span class="p">(</span><span class="n">skb</span><span class="p">)))</span>
    <span class="p">{</span>
      <span class="cm">/* This is fair since the queue should be empty anyway */</span>
      <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">)</span>
        <span class="p">{</span>
	  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="cm">/* If in SIR mode we need to generate a string of XBOFs */</span>
      <span class="cm">/* In MIR and FIR we need to generate a string of data */</span>
      <span class="cm">/* which we will add a wrong checksum to */</span>

      <span class="n">mtt</span> <span class="o">=</span> <span class="n">toshoboe_makemttpacket</span> <span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">],</span> <span class="n">mtt</span><span class="p">);</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s.mtt:%x(%x)%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
          <span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="n">mtt</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">mtt</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">mtt</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>

          <span class="n">ctl</span> <span class="o">=</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_RTCENTX</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_ENABLEH_FIRON</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">ctl</span> <span class="o">|=</span> <span class="n">OBOE_CTL_TX_BAD_CRC</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_SIP</span> <span class="p">;</span>
            <span class="p">}</span>
<span class="cp">#ifdef USE_MIR</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_ENABLEH_MIRON</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">ctl</span> <span class="o">|=</span> <span class="n">OBOE_CTL_TX_BAD_CRC</span><span class="p">;</span>
            <span class="p">}</span>
<span class="cp">#endif</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">;</span>

          <span class="n">OUTB</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">OBOE_ENABLEH</span><span class="p">);</span>
          <span class="cm">/* It is only a timer. Do not send mtt packet outside! */</span>
          <span class="n">toshoboe_start_DMA</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H_ENTX</span> <span class="o">|</span> <span class="n">OBOE_CONFIG0H_LOOP</span><span class="p">);</span>

          <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="o">++</span><span class="p">;</span>

          <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="o">++</span><span class="p">;</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span> <span class="o">%=</span> <span class="n">TX_SLOTS</span><span class="p">;</span>

        <span class="p">}</span>
      <span class="k">else</span>
        <span class="p">{</span>
          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: problem with mtt packet - ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cp">#ifdef DUMP_PACKETS</span>
<span class="n">dumpbufs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="sc">&#39;&gt;&#39;</span><span class="p">);</span>
<span class="cp">#endif</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s.ful:%x(%x)%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
          <span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">);</span>
      <span class="n">toshoboe_start_DMA</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H_ENTX</span><span class="p">);</span>
      <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_ENABLEH_SIRON</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">len</span> <span class="o">=</span> <span class="n">async_wrap_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">],</span> <span class="n">TX_BUF_SZ</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
      <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
      <span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>

  <span class="cm">/*Sometimes the HW doesn&#39;t see us assert RTCENTX in the interrupt code */</span>
  <span class="cm">/*later this plays safe, we garuntee the last packet to be transmitted */</span>
  <span class="cm">/*has RTCENTX set */</span>

  <span class="n">ctl</span> <span class="o">=</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span> <span class="o">|</span> <span class="n">OBOE_CTL_TX_RTCENTX</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_ENABLEH_FIRON</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">ctl</span> <span class="o">|=</span> <span class="n">OBOE_CTL_TX_SIP</span> <span class="p">;</span>
    <span class="p">}</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctl</span><span class="p">;</span>

  <span class="cm">/* If transmitter is idle start in one-shot mode */</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">)</span>
      <span class="n">toshoboe_start_DMA</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H_ENTX</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="o">++</span><span class="p">;</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span><span class="o">++</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">txs</span> <span class="o">%=</span> <span class="n">TX_SLOTS</span><span class="p">;</span>

  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">dev_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*interrupt handler */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">toshoboe_interrupt</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
  <span class="n">__u8</span> <span class="n">irqstat</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">irqstat</span> <span class="o">=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ISR</span><span class="p">);</span>

<span class="cm">/* was it us */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_MASK</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

<span class="cm">/* Ack all the interrupts */</span>
  <span class="n">OUTB</span> <span class="p">(</span><span class="n">irqstat</span><span class="p">,</span> <span class="n">OBOE_ISR</span><span class="p">);</span>

  <span class="n">toshoboe_isntstuck</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>

<span class="cm">/* Txdone */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_TXDONE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">int</span> <span class="n">txp</span><span class="p">,</span> <span class="n">txpc</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

      <span class="n">txp</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">;</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span><span class="p">)</span>
              <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s.txd(%x)%x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
          <span class="p">,</span><span class="n">irqstat</span><span class="p">,</span><span class="n">txp</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">);</span>

      <span class="n">txp</span> <span class="o">=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_TXSLOT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_SLOT_MASK</span><span class="p">;</span>

      <span class="cm">/* Got anything queued ? start it together */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">txp</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="n">txpc</span> <span class="o">=</span> <span class="n">txp</span><span class="p">;</span>
<span class="cp">#ifdef OPTIMIZE_TX</span>
          <span class="k">while</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">txpc</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">txp</span> <span class="o">=</span> <span class="n">txpc</span><span class="p">;</span>
              <span class="n">txpc</span><span class="o">++</span><span class="p">;</span>
              <span class="n">txpc</span> <span class="o">%=</span> <span class="n">TX_SLOTS</span><span class="p">;</span>
              <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">txpc</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_TX_HW_OWNS</span><span class="p">)</span>
                  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">txp</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OBOE_CTL_TX_RTCENTX</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#else</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
          <span class="n">toshoboe_start_DMA</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">OBOE_CONFIG0H_ENTX</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">;</span>
          <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: Executed TxDone scheduled speed change %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">__func__</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
          <span class="n">toshoboe_setbaud</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="cm">/* Tell network layer that we want more frames */</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">)</span>
          <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_RXDONE</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">].</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">OBOE_CTL_RX_HW_OWNS</span><span class="p">))</span>
        <span class="p">{</span>
          <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
          <span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
          <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s.rcv:%x(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
		      <span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>

<span class="cp">#ifdef DUMP_PACKETS</span>
<span class="n">dumpbufs</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">],</span><span class="n">len</span><span class="p">,</span><span class="sc">&#39;&lt;&#39;</span><span class="p">);</span>
<span class="cp">#endif</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">].</span><span class="n">control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
              <span class="n">__u8</span> <span class="n">enable</span> <span class="o">=</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_ENABLEH</span><span class="p">);</span>

              <span class="cm">/* In SIR mode we need to check the CRC as this */</span>
              <span class="cm">/* hasn&#39;t been done by the hardware */</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">OBOE_ENABLEH_SIRON</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">toshoboe_checkfcs</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">],</span> <span class="n">len</span><span class="p">))</span>
                      <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="cm">/*Trim off the CRC */</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                      <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                  <span class="k">else</span>
                      <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s.SIR:%x(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span><span class="n">enable</span><span class="p">);</span>
                <span class="p">}</span>

<span class="cp">#ifdef USE_MIR</span>
              <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">OBOE_ENABLEH_MIRON</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
                      <span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
                  <span class="k">else</span>
                      <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s.MIR:%x(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span><span class="n">enable</span><span class="p">);</span>
                <span class="p">}</span>
<span class="cp">#endif</span>
              <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="n">OBOE_ENABLEH_FIRON</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
                      <span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>   <span class="cm">/*FIXME: check this */</span>
                  <span class="k">else</span>
                      <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s.FIR:%x(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span><span class="n">enable</span><span class="p">);</span>
                <span class="p">}</span>
              <span class="k">else</span>
                  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s.?IR:%x(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span><span class="n">enable</span><span class="p">);</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
                <span class="p">{</span>
                  <span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                  <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
                    <span class="p">{</span>
                      <span class="n">skb_reserve</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

                      <span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
                      <span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">],</span>
					      <span class="n">len</span><span class="p">);</span>
                      <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
                      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
                      <span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span> <span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
                    <span class="p">}</span>
                  <span class="k">else</span>
                    <span class="p">{</span>
                      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span>
                              <span class="s">&quot;%s(), memory squeeze, dropping frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">__func__</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
          <span class="k">else</span>
            <span class="p">{</span>
            <span class="cm">/* TODO: =========================================== */</span>
            <span class="cm">/*  if OBOE_CTL_RX_LENGTH, our buffers are too small */</span>
            <span class="cm">/* (MIR or FIR) data is lost. */</span>
            <span class="cm">/* (SIR) data is splitted in several slots. */</span>
            <span class="cm">/* we have to join all the received buffers received */</span>
            <span class="cm">/*in a large buffer before checking CRC. */</span>
            <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s.err:%x(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
                <span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">].</span><span class="n">control</span><span class="p">);</span>
            <span class="p">}</span>

          <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="p">].</span><span class="n">control</span> <span class="o">=</span> <span class="n">OBOE_CTL_RX_HW_OWNS</span><span class="p">;</span>

          <span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span><span class="o">++</span><span class="p">;</span>
          <span class="n">self</span><span class="o">-&gt;</span><span class="n">rxs</span> <span class="o">%=</span> <span class="n">RX_SLOTS</span><span class="p">;</span>

          <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
              <span class="n">netif_rx</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

        <span class="p">}</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_TXUNDER</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: tx fifo underflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_RXOVER</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: rx fifo overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cm">/* This must be useful for something... */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">irqstat</span> <span class="o">&amp;</span> <span class="n">OBOE_INT_SIP</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">int_sip</span><span class="o">++</span><span class="p">;</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s.sip:%x(%x)%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
	      <span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">int_sip</span><span class="p">,</span><span class="n">irqstat</span><span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_net_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">toshoboe_interrupt</span><span class="p">,</span>
                    <span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
  	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="n">toshoboe_startchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

  <span class="cm">/* Ready to play! */</span>
  <span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="cm">/*</span>
<span class="cm">   * Open new IrLAP layer instance, now that everything should be</span>
<span class="cm">   * initialized properly</span>
<span class="cm">   */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="n">irlap_open</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">irdad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_net_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="n">IRDA_ASSERT</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">);</span>
  <span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="cm">/* Stop device */</span>
  <span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="cm">/* Stop and remove instance of IrLAP */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span>
    <span class="n">irlap_close</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">irdad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">free_irq</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">self</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function toshoboe_net_ioctl (dev, rq, cmd)</span>
<span class="cm"> *</span>
<span class="cm"> *    Process IOCTL commands for this device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_net_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">IRDA_ASSERT</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">);</span>

  <span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="n">IRDA_ASSERT</span> <span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">);</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%s(), %s, (cmd=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="cm">/* Disable interrupts &amp; save flags */</span>
  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">SIOCSBANDWIDTH</span>:       <span class="cm">/* Set bandwidth */</span>
      <span class="cm">/* This function will also be used by IrLAP to change the</span>
<span class="cm">       * speed, so we still must allow for speed change within</span>
<span class="cm">       * interrupt context.</span>
<span class="cm">       */</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(BANDWIDTH), %s, (%X/%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
          <span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_STATUS</span><span class="p">),</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_baudrate</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span> <span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capable</span> <span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* self-&gt;speed=irq-&gt;ifr_baudrate; */</span>
      <span class="cm">/* toshoboe_setbaud(self); */</span>
      <span class="cm">/* Just change speed once - inserted by Paul Bristow */</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_baudrate</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SIOCSMEDIABUSY</span>:       <span class="cm">/* Set media busy */</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(MEDIABUSY), %s, (%X/%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
          <span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_STATUS</span><span class="p">),</span> <span class="n">capable</span> <span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">)</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span> <span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">irda_device_set_media_busy</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">SIOCGRECEIVING</span>:       <span class="cm">/* Check if we are receiving right now */</span>
      <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_receiving</span> <span class="o">=</span> <span class="p">(</span><span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OBOE_STATUS_RXBUSY</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s(RECEIVING), %s, (%X/%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>
          <span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">INB</span> <span class="p">(</span><span class="n">OBOE_STATUS</span><span class="p">),</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_receiving</span> <span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
      <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(?), %s, (cmd=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">out:</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Toshiba OBOE IrDA Device Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;James McKenzie &lt;james@fishsoup.dhs.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span> <span class="p">(</span><span class="n">max_baud</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">max_baud</span><span class="p">,</span> <span class="s">&quot;Maximum baud rate&quot;</span><span class="p">);</span>

<span class="cp">#ifdef USE_PROBE</span>
<span class="n">module_param</span> <span class="p">(</span><span class="n">do_probe</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">do_probe</span><span class="p">,</span> <span class="s">&quot;Enable/disable chip probing and self-test&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">toshoboe_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span><span class="o">*</span><span class="p">)</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="n">IRDA_ASSERT</span> <span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;</span> <span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="n">release_region</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">kfree</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">kfree</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">unregister_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

  <span class="n">kfree</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ringbuf</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ringbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="n">free_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">toshoboe_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	<span class="o">=</span> <span class="n">toshoboe_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	<span class="o">=</span> <span class="n">toshoboe_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>	<span class="o">=</span> <span class="n">toshoboe_hard_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>	<span class="o">=</span> <span class="n">toshoboe_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pdid</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">err</span><span class="o">=</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

  <span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_irdadev</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: can&#39;t allocate memory for &quot;</span>
              <span class="s">&quot;IrDA control block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span> <span class="o">=</span> <span class="n">OBOE_IO_EXTENT</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irqflags</span> <span class="o">=</span> <span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">;</span>

  <span class="n">self</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">async</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="cm">/* Lock the port that we need */</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span><span class="o">==</span><span class="n">request_region</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: can&#39;t get iobase of 0x%03x</span><span class="se">\n</span><span class="s">&quot;</span>
	      <span class="p">,</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>
      <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">freeself</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">);</span>

  <span class="n">irda_init_max_qos_capabilies</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">max_baud</span> <span class="o">&gt;=</span> <span class="mi">2400</span><span class="p">)</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">|=</span> <span class="n">IR_2400</span><span class="p">;</span>
  <span class="cm">/*if (max_baud&gt;=4800) idev-&gt;qos.baud_rate.bits|=IR_4800; */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">max_baud</span> <span class="o">&gt;=</span> <span class="mi">9600</span><span class="p">)</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">|=</span> <span class="n">IR_9600</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">max_baud</span> <span class="o">&gt;=</span> <span class="mi">19200</span><span class="p">)</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">|=</span> <span class="n">IR_19200</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">max_baud</span> <span class="o">&gt;=</span> <span class="mi">115200</span><span class="p">)</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">|=</span> <span class="n">IR_115200</span><span class="p">;</span>
<span class="cp">#ifdef USE_MIR</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">max_baud</span> <span class="o">&gt;=</span> <span class="mi">1152000</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">|=</span> <span class="n">IR_1152000</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">max_baud</span> <span class="o">&gt;=</span> <span class="mi">4000000</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IR_4000000</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/*FIXME: work this out... */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">min_turn_time</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

  <span class="n">irda_qos_bits_to_value</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

  <span class="cm">/* Allocate twice the size to guarantee alignment */</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">ringbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">OBOE_RING_LEN</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ringbuf</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">freeregion</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#if (BITS_PER_LONG == 64)</span>
<span class="cp">#error broken on 64-bit:  casts pointer to 32-bit, and then back to pointer.</span>
<span class="cp">#endif</span>

  <span class="cm">/*We need to align the taskfile on a taskfile size boundary */</span>
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

    <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ringbuf</span><span class="p">;</span>
    <span class="n">addr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">OBOE_RING_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">addr</span> <span class="o">+=</span> <span class="n">OBOE_RING_LEN</span><span class="p">;</span>
    <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">OboeRing</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">memset</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OBOE_RING_LEN</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">mem_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">ring</span><span class="p">;</span>

  <span class="n">ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">TX_BUF_SZ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">RX_BUF_SZ</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">freebufs</span><span class="p">;</span>
    <span class="p">}</span>


<span class="cp">#ifdef USE_PROBE</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">do_probe</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">toshoboe_probe</span> <span class="p">(</span><span class="n">self</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">freebufs</span><span class="p">;</span>
      <span class="p">}</span>
<span class="cp">#endif</span>

  <span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">toshoboe_netdev_ops</span><span class="p">;</span>

  <span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: register_netdev() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
      <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">freebufs</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;IrDA: Registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

  <span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">self</span><span class="p">);</span>

  <span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: Using multiple tasks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">freebufs:</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">kfree</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_SLOTS</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">kfree</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_bufs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">kfree</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ringbuf</span><span class="p">);</span>

<span class="nl">freeregion:</span>
  <span class="n">release_region</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">);</span>

<span class="nl">freeself:</span>
  <span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_gotosleep</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">crap</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span><span class="o">*</span><span class="p">)</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span> <span class="o">||</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irdad</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Flush all packets */</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span><span class="p">))</span>
    <span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

  <span class="n">toshoboe_stopchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">txpending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">toshoboe_wakeup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">toshoboe_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">toshoboe_cb</span><span class="o">*</span><span class="p">)</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

  <span class="n">IRDA_DEBUG</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span> <span class="o">||</span> <span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irdad</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">async</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

  <span class="n">toshoboe_startchip</span> <span class="p">(</span><span class="n">self</span><span class="p">);</span>
  <span class="n">self</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">spinlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">donauboe_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;donauboe&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">toshoboe_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">toshoboe_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">toshoboe_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">toshoboe_gotosleep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">toshoboe_wakeup</span> 
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">donauboe_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">donauboe_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">donauboe_cleanup</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">donauboe_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">donauboe_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">donauboe_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
