<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › irda › vlsi_ir.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vlsi_ir.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*********************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *	vlsi_ir.c:	VLSI82C147 PCI IrDA controller driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2001-2003 Martin Diehl</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or </span>
<span class="cm"> *	modify it under the terms of the GNU General Public License as </span>
<span class="cm"> *	published by the Free Software Foundation; either version 2 of </span>
<span class="cm"> *	the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> *	GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *	You should have received a copy of the GNU General Public License </span>
<span class="cm"> *	along with this program; if not, write to the Free Software </span>
<span class="cm"> *	Foundation, Inc., 59 Temple Place, Suite 330, Boston, </span>
<span class="cm"> *	MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
 
<span class="cp">#define DRIVER_NAME 		&quot;vlsi_ir&quot;</span>
<span class="cp">#define DRIVER_VERSION		&quot;v0.5&quot;</span>
<span class="cp">#define DRIVER_DESCRIPTION	&quot;IrDA SIR/MIR/FIR driver for VLSI 82C147&quot;</span>
<span class="cp">#define DRIVER_AUTHOR		&quot;Martin Diehl &lt;info@mdiehl.de&gt;&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/********************************************************/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;net/irda/irda.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda_device.h&gt;</span>
<span class="cp">#include &lt;net/irda/wrapper.h&gt;</span>
<span class="cp">#include &lt;net/irda/crc.h&gt;</span>

<span class="cp">#include &quot;vlsi_ir.h&quot;</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="cm">/* const */</span> <span class="kt">char</span> <span class="n">drivername</span><span class="p">[]</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">vlsi_irda_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">class</span> <span class="o">=</span>        <span class="n">PCI_CLASS_WIRELESS_IRDA</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span>	<span class="n">PCI_CLASS_SUBCLASS_MASK</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> 
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span>       <span class="n">PCI_VENDOR_ID_VLSI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span> <span class="o">=</span>       <span class="n">PCI_DEVICE_ID_VLSI_82C147</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> 	<span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span>	<span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* all zeroes */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">vlsi_irda_table</span><span class="p">);</span>

<span class="cm">/********************************************************/</span>

<span class="cm">/*	clksrc: which clock source to be used</span>
<span class="cm"> *		0: auto - try PLL, fallback to 40MHz XCLK</span>
<span class="cm"> *		1: on-chip 48MHz PLL</span>
<span class="cm"> *		2: external 48MHz XCLK</span>
<span class="cm"> *		3: external 40MHz XCLK (HP OB-800)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">clksrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* default is 0(auto) */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">clksrc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">clksrc</span><span class="p">,</span> <span class="s">&quot;clock input source selection&quot;</span><span class="p">);</span>

<span class="cm">/*	ringsize: size of the tx and rx descriptor rings</span>
<span class="cm"> *		independent for tx and rx</span>
<span class="cm"> *		specify as ringsize=tx[,rx]</span>
<span class="cm"> *		allowed values: 4, 8, 16, 32, 64</span>
<span class="cm"> *		Due to the IrDA 1.x max. allowed window size=7,</span>
<span class="cm"> *		there should be no gain when using rings larger than 8</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ringsize</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">};</span>		<span class="cm">/* default is tx=8 / rx=8 */</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">ringsize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ringsize</span><span class="p">,</span> <span class="s">&quot;TX, RX ring descriptor size&quot;</span><span class="p">);</span>

<span class="cm">/*	sirpulse: tuning of the SIR pulse width within IrPHY 1.3 limits</span>
<span class="cm"> *		0: very short, 1.5us (exception: 6us at 2.4 kbaud)</span>
<span class="cm"> *		1: nominal 3/16 bittime width</span>
<span class="cm"> *	note: IrDA compliant peer devices should be happy regardless</span>
<span class="cm"> *		which one is used. Primary goal is to save some power</span>
<span class="cm"> *		on the sender&#39;s side - at 9.6kbaud for example the short</span>
<span class="cm"> *		pulse width saves more than 90% of the transmitted IR power.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sirpulse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* default is 3/16 bittime */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sirpulse</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sirpulse</span><span class="p">,</span> <span class="s">&quot;SIR pulse width tuning&quot;</span><span class="p">);</span>

<span class="cm">/*	qos_mtt_bits: encoded min-turn-time value we require the peer device</span>
<span class="cm"> *		 to use before transmitting to us. &quot;Type 1&quot; (per-station)</span>
<span class="cm"> *		 bitfield according to IrLAP definition (section 6.6.8)</span>
<span class="cm"> *		 Don&#39;t know which transceiver is used by my OB800 - the</span>
<span class="cm"> *		 pretty common HP HDLS-1100 requires 1 msec - so lets use this.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qos_mtt_bits</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>		<span class="cm">/* default is 1 ms or more */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qos_mtt_bits</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qos_mtt_bits</span><span class="p">,</span> <span class="s">&quot;IrLAP bitfield representing min-turn-time&quot;</span><span class="p">);</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_reg_debug</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">iobase</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: &quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">inb</span><span class="p">((</span><span class="n">iobase</span><span class="o">+</span><span class="n">i</span><span class="p">)));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_ring_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s - ring %p / size %u / mask 0x%04x / len %u / dir %d / hw %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s - head = %d / tail = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s - ring descr %u: &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;skb=%p data=%p hw=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s - hw: status=%02x count=%u addr=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">rd_get_status</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">rd_get_count</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********************************************************/</span>

<span class="cm">/* needed regardless of CONFIG_PROC_FS */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">vlsi_proc_root</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_proc_pdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s (vid/did: [%04x:%04x])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;pci-power-state: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;resources: irq=%u / io=0x%04x / dma_mask=0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;hw registers: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">inb</span><span class="p">((</span><span class="n">iobase</span><span class="o">+</span><span class="n">i</span><span class="p">)));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
		
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_proc_ndev</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">delta1</span><span class="p">,</span> <span class="n">delta2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s link state: %s / %s / %s / %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">netif_device_present</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;attached&quot;</span> <span class="o">:</span> <span class="s">&quot;detached&quot;</span><span class="p">,</span> 
		<span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;running&quot;</span> <span class="o">:</span> <span class="s">&quot;not running&quot;</span><span class="p">,</span>
		<span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;carrier ok&quot;</span> <span class="o">:</span> <span class="s">&quot;no carrier&quot;</span><span class="p">,</span>
		<span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;queue stopped&quot;</span> <span class="o">:</span> <span class="s">&quot;queue running&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">hw-state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_IRMISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IRMISC:%s%s%s uart%s&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRMISC_IRRAIL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; irrail&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRMISC_IRPD</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; irpd&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRMISC_UARTTST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; uarttest&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRMISC_UARTEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;@&quot;</span> <span class="o">:</span> <span class="s">&quot; disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRMISC_UARTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;0x%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">byte</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;3e8&quot;</span> <span class="o">:</span> <span class="s">&quot;2e8&quot;</span><span class="p">)</span>
				 <span class="o">:</span> <span class="p">((</span><span class="n">byte</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;3f8&quot;</span> <span class="o">:</span> <span class="s">&quot;2f8&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;CLKCTL: PLL %s%s%s / clock %s / wakeup %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">CLKCTL_PD_INV</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;powered&quot;</span> <span class="o">:</span> <span class="s">&quot;down&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">CLKCTL_LOCK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; locked&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">CLKCTL_EXTCLK</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">CLKCTL_XCKSEL</span><span class="p">)</span><span class="o">?</span><span class="s">&quot; / 40 MHz XCLK&quot;</span><span class="o">:</span><span class="s">&quot; / 48 MHz XCLK&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">CLKCTL_CLKSTP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;stopped&quot;</span> <span class="o">:</span> <span class="s">&quot;running&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">CLKCTL_WAKE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_MSTRPAGE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;MSTRPAGE: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">byte</span><span class="p">);</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IRINTR:%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_ACTEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ACTEN&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_RPKTEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; RPKTEN&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_TPKTEN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; TPKTEN&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_OE_EN</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; OE_EN&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_ACTIVITY</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ACTIVITY&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_RPKTINT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; RPKTINT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_TPKTINT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; TPKTINT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">byte</span><span class="o">&amp;</span><span class="n">IRINTR_OE_INT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; OE_INT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RINGPTR</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RINGPTR: rx=%u / tx=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RINGPTR_GET_RX</span><span class="p">(</span><span class="n">word</span><span class="p">),</span> <span class="n">RINGPTR_GET_TX</span><span class="p">(</span><span class="n">word</span><span class="p">));</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RINGBASE</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RINGBASE: busmap=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">word</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">MSTRPAGE_VALUE</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">));</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RINGSIZE</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RINGSIZE: rx=%u / tx=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">RINGSIZE_TO_RXSIZE</span><span class="p">(</span><span class="n">word</span><span class="p">),</span>
		<span class="n">RINGSIZE_TO_TXSIZE</span><span class="p">(</span><span class="n">word</span><span class="p">));</span>

	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IRCFG:%s%s%s%s%s%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_LOOP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; LOOP&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_ENTX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ENTX&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_ENRX</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ENRX&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_MSTR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; MSTR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_RXANY</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; RXANY&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_CRC16</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CRC16&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_FIR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FIR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_MIR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; MIR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_SIR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SIR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_SIRFILT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SIRFILT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_SIRTEST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SIRTEST&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_TXPOL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; TXPOL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRCFG_RXPOL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; RXPOL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IRENABLE:%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_PHYANDCLOCK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; PHYANDCLOCK&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_CFGER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CFGERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_FIR_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FIR_ON&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_MIR_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; MIR_ON&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_SIR_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SIR_ON&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_ENTXST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ENTXST&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_ENRXST</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ENRXST&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">word</span><span class="o">&amp;</span><span class="n">IRENABLE_CRC16_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CRC16_ON&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_PHYCTL</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;PHYCTL: baud-divisor=%u / pulsewidth=%u / preamble=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">PHYCTL_TO_BAUD</span><span class="p">(</span><span class="n">word</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">PHYCTL_TO_PLSWID</span><span class="p">(</span><span class="n">word</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">PHYCTL_TO_PREAMB</span><span class="p">(</span><span class="n">word</span><span class="p">));</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_NPHYCTL</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;NPHYCTL: baud-divisor=%u / pulsewidth=%u / preamble=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">PHYCTL_TO_BAUD</span><span class="p">(</span><span class="n">word</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">PHYCTL_TO_PLSWID</span><span class="p">(</span><span class="n">word</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">PHYCTL_TO_PREAMB</span><span class="p">(</span><span class="n">word</span><span class="p">));</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_MAXPKT</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;MAXPKT: max. rx packet size = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
	<span class="n">word</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RCVBCNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCVBCNT_MASK</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RCVBCNT: rx-fifo filling level = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">sw-state:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;IrPHY setup: %d baud - %s encoding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">,</span> 
		<span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">==</span><span class="n">IFF_SIR</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;SIR&quot;</span><span class="o">:</span><span class="p">((</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">==</span><span class="n">IFF_MIR</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;MIR&quot;</span><span class="o">:</span><span class="s">&quot;FIR&quot;</span><span class="p">));</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&gt;=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta2</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
		<span class="n">delta1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">delta2</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
		<span class="n">delta1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;last rx: %lu.%06u sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">delta1</span><span class="p">,</span> <span class="n">delta2</span><span class="p">);</span>	

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RX: packets=%lu / bytes=%lu / errors=%lu / dropped=%lu&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; / overrun=%lu / length=%lu / frame=%lu / crc=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;TX: packets=%lu / bytes=%lu / errors=%lu / dropped=%lu / fifo=%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">,</span>
		<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="p">);</span>

<span class="p">}</span>
		
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_proc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;size %u / mask 0x%04x / len %u / dir %d / hw %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;head = %d / tail = %d &quot;</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;(empty)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">h</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;(full)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;(level = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">t</span><span class="o">-</span><span class="n">h</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">));</span> 
		<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">[</span><span class="n">h</span><span class="p">];</span>
		<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">rd_get_count</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;current: rd = %d / status = %02x / len = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">h</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">rd_get_status</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="n">j</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;   data:&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
				<span class="n">j</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;&gt; ring descr %u: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;skb=%p data=%p hw=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  hw: status=%02x count=%u busaddr=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">rd_get_status</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">rd_get_count</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">%s %s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;clksrc: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="p">(</span><span class="n">clksrc</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="n">clksrc</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;40MHz XCLK&quot;</span><span class="o">:</span><span class="s">&quot;48MHz XCLK&quot;</span><span class="p">)</span>
			    <span class="o">:</span> <span class="p">((</span><span class="n">clksrc</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;48MHz PLL&quot;</span><span class="o">:</span><span class="s">&quot;autodetect&quot;</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ringsize: tx=%d / rx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ringsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ringsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;sirpulse: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">sirpulse</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;3/16 bittime&quot;</span><span class="o">:</span><span class="s">&quot;short&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;qos_mtt_bits: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">qos_mtt_bits</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vlsi_proc_pdev</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">vlsi_proc_ndev</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">PCI controller down - resume_ok = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">idev</span><span class="o">-&gt;</span><span class="n">resume_ok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">&amp;&amp;</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">--------- RX ring -----------</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">vlsi_proc_ring</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">--------- TX ring -----------</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">vlsi_proc_ring</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">vlsi_seq_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">vlsi_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">vlsi_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define VLSI_PROC_FOPS		(&amp;vlsi_proc_fops)</span>

<span class="cp">#else	</span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>
<span class="cp">#define VLSI_PROC_FOPS		NULL</span>
<span class="cp">#endif</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="nf">vlsi_alloc_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_descr_hw</span> <span class="o">*</span><span class="n">hwmap</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">busaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span>  <span class="o">||</span>  <span class="p">((</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="n">size</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>	<span class="cm">/* must be &gt;0 and power of 2 */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_descr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">));</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="p">)(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rd</span><span class="p">));</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hwmap</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">busaddr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: failed to create PCI-MAP for %p&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rd</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">+</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">busaddr</span> <span class="o">=</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
				<span class="n">rd_set_addr_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">busaddr</span><span class="p">)</span>
					<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">busaddr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rd_set_addr_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">busaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* initially, the dma buffer is owned by the CPU */</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_free_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>	<span class="n">busaddr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rd</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rd</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">busaddr</span> <span class="o">=</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
		<span class="n">rd_set_addr_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">busaddr</span><span class="p">)</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">busaddr</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_create_hwif</span><span class="p">(</span><span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> 			<span class="o">*</span><span class="n">ringarea</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_descr_hw</span>	<span class="o">*</span><span class="n">hwmap</span><span class="p">;</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">virtaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ringarea</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">HW_RING_AREA_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ringarea</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: insufficient memory for descriptor rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ringarea</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HW_RING_AREA_SIZE</span><span class="p">);</span>

	<span class="n">hwmap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ring_descr_hw</span> <span class="o">*</span><span class="p">)</span><span class="n">ringarea</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">vlsi_alloc_ring</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hwmap</span><span class="p">,</span> <span class="n">ringsize</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
					<span class="n">XFER_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unmap</span><span class="p">;</span>

	<span class="n">hwmap</span> <span class="o">+=</span> <span class="n">MAX_RING_DESCR</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">vlsi_alloc_ring</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hwmap</span><span class="p">,</span> <span class="n">ringsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">XFER_BUF_SIZE</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_rx</span><span class="p">;</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">virtaddr</span> <span class="o">=</span> <span class="n">ringarea</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_rx:</span>
	<span class="n">vlsi_free_ring</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
<span class="nl">out_unmap:</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">HW_RING_AREA_SIZE</span><span class="p">,</span> <span class="n">ringarea</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_destroy_hwif</span><span class="p">(</span><span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_free_ring</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="n">vlsi_free_ring</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span><span class="n">HW_RING_AREA_SIZE</span><span class="p">,</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">virtaddr</span><span class="p">,</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">);</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">virtaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_process_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">crclen</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="cm">/* dma buffer now owned by the CPU */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">rd_get_status</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_RX_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_RX_OVER</span><span class="p">)</span>  
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">VLSI_RX_OVER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_RX_LENGTH</span><span class="p">)</span>  
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">VLSI_RX_LENGTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_RX_PHYERR</span><span class="p">)</span>  
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">VLSI_RX_FRAME</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_RX_CRCERR</span><span class="p">)</span>  
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">VLSI_RX_CRC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">rd_get_count</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
	<span class="n">crclen</span> <span class="o">=</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mode</span><span class="o">==</span><span class="n">IFF_FIR</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">crclen</span><span class="p">;</span>		<span class="cm">/* remove trailing CRC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: strange frame (len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">VLSI_RX_DROP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IFF_SIR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* hw checks CRC in MIR, FIR mode */</span>

		<span class="cm">/* rd-&gt;buf is a streaming PCI_DMA_FROMDEVICE map. Doing the</span>
<span class="cm">		 * endian-adjustment there just in place will dirty a cache line</span>
<span class="cm">		 * which belongs to the map and thus we must be sure it will</span>
<span class="cm">		 * get flushed before giving the buffer back to hardware.</span>
<span class="cm">		 * vlsi_fill_rx() will do this anyway - but here we rely on.</span>
<span class="cm">		 */</span>
		<span class="n">le16_to_cpus</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irda_calc_crc16</span><span class="p">(</span><span class="n">INIT_FCS</span><span class="p">,</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="o">+</span><span class="n">crclen</span><span class="p">)</span> <span class="o">!=</span> <span class="n">GOOD_FCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: crc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">VLSI_RX_CRC</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: rx packet lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">VLSI_RX_DROP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">),</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_rx_ni</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">rd_set_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rd_set_count</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* buffer still owned by CPU */</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ret</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_fill_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">ring_last</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="n">rd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">ring_put</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd_is_active</span><span class="p">(</span><span class="n">rd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: driver bug: rx descr race with hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
			<span class="n">vlsi_ring_debug</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">IRLAP_SKB_ALLOCSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* probably not worth logging? */</span>
		<span class="p">}</span>
		<span class="cm">/* give dma buffer back to busmaster */</span>
		<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
		<span class="n">rd_activate</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">ring_first</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="n">rd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">ring_get</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rd_is_active</span><span class="p">(</span><span class="n">rd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">vlsi_process_rx</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_DROP</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_OVER</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_LENGTH</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_FRAME</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_CRC</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">);</span> <span class="cm">/* remember &quot;now&quot; for later mtt delay */</span>

	<span class="n">vlsi_fill_rx</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring_first</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we are in big trouble, if this should ever happen */</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: rx ring exhausted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">vlsi_ring_debug</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">VLSI_PIO_PROMPT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* caller must have stopped the controller from busmastering */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_unarm_rx</span><span class="p">(</span><span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">ring_first</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="n">rd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">ring_get</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd_is_active</span><span class="p">(</span><span class="n">rd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rd_set_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rd_get_count</span><span class="p">(</span><span class="n">rd</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s - dropping rx packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">VLSI_RX_DROP</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rd_set_count</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vlsi_process_rx</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_DROP</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_OVER</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_LENGTH</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_FRAME</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_RX_CRC</span><span class="p">)</span>  
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_process_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ret</span><span class="p">;</span>

	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
	<span class="cm">/* dma buffer now owned by the CPU */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">rd_get_status</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RD_TX_UNDRN</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">VLSI_TX_FIFO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rd_set_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>	<span class="cm">/* tx-skb already freed? - should never happen */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">rd_get_count</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>		<span class="cm">/* incorrect for SIR! (due to wrapping) */</span>

	<span class="n">rd_set_count</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* dma buffer still owned by the CPU */</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ret</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_set_baud</span><span class="p">(</span><span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">nphyctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">baudrate</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">fifocnt</span><span class="p">;</span>

	<span class="n">baudrate</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span><span class="p">;</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">baudrate</span> <span class="o">==</span> <span class="mi">4000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IFF_FIR</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">IRCFG_FIR</span><span class="p">;</span>
		<span class="n">nphyctl</span> <span class="o">=</span> <span class="n">PHYCTL_FIR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">baudrate</span> <span class="o">==</span> <span class="mi">1152000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IFF_MIR</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">IRCFG_MIR</span> <span class="o">|</span> <span class="n">IRCFG_CRC16</span><span class="p">;</span>
		<span class="n">nphyctl</span> <span class="o">=</span> <span class="n">PHYCTL_MIR</span><span class="p">(</span><span class="n">clksrc</span><span class="o">==</span><span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IFF_SIR</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">=</span> <span class="n">IRCFG_SIR</span> <span class="o">|</span> <span class="n">IRCFG_SIRFILT</span>  <span class="o">|</span> <span class="n">IRCFG_RXANY</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">baudrate</span><span class="p">)</span> <span class="p">{</span>
			<span class="nl">default:</span>
				<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: undefined baudrate %d - fallback to 9600!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">__func__</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">);</span>
				<span class="n">baudrate</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
				<span class="cm">/* fallthru */</span>
			<span class="k">case</span> <span class="mi">2400</span>:
			<span class="k">case</span> <span class="mi">9600</span>:
			<span class="k">case</span> <span class="mi">19200</span>:
			<span class="k">case</span> <span class="mi">38400</span>:
			<span class="k">case</span> <span class="mi">57600</span>:
			<span class="k">case</span> <span class="mi">115200</span>:
				<span class="n">nphyctl</span> <span class="o">=</span> <span class="n">PHYCTL_SIR</span><span class="p">(</span><span class="n">baudrate</span><span class="p">,</span><span class="n">sirpulse</span><span class="p">,</span><span class="n">clksrc</span><span class="o">==</span><span class="mi">3</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">config</span> <span class="o">|=</span> <span class="n">IRCFG_MSTR</span> <span class="o">|</span> <span class="n">IRCFG_ENRX</span><span class="p">;</span>

	<span class="n">fifocnt</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RCVBCNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCVBCNT_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fifocnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: rx fifo not empty(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifocnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">nphyctl</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_NPHYCTL</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">IRENABLE_PHYANDCLOCK</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>	<span class="cm">/* chip applies IRCFG on next rising edge of its 8MHz clock */</span>

	<span class="cm">/* read back settings for validation */</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRENABLE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IFF_FIR</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">^=</span> <span class="n">IRENABLE_FIR_ON</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IFF_MIR</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">^=</span> <span class="p">(</span><span class="n">IRENABLE_MIR_ON</span><span class="o">|</span><span class="n">IRENABLE_CRC16_ON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">config</span> <span class="o">^=</span> <span class="n">IRENABLE_SIR_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">!=</span> <span class="p">(</span><span class="n">IRENABLE_PHYANDCLOCK</span><span class="o">|</span><span class="n">IRENABLE_ENRXST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: failed to set %s mode!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="n">IFF_SIR</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;SIR&quot;</span><span class="o">:</span><span class="p">((</span><span class="n">mode</span><span class="o">==</span><span class="n">IFF_MIR</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;MIR&quot;</span><span class="o">:</span><span class="s">&quot;FIR&quot;</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_PHYCTL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nphyctl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: failed to apply baudrate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">baudrate</span><span class="p">;</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">vlsi_reg_debug</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">vlsi_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vlsi_ring</span>	<span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">speed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span>  <span class="n">now</span><span class="p">,</span> <span class="n">ready</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>  <span class="o">&amp;&amp;</span>  <span class="n">speed</span> <span class="o">!=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">RD_TX_CLRENTX</span><span class="p">;</span>  <span class="cm">/* stop tx-ring after this frame */</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* handle zero packets - should be speed change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;bogus zero-length packet&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* due to the completely asynch tx operation we might have</span>
<span class="cm">		 * IrLAP racing with the hardware here, f.e. if the controller</span>
<span class="cm">		 * is just sending the last packet with current speed while</span>
<span class="cm">		 * the LAP is already switching the speed using synchronous</span>
<span class="cm">		 * len=0 packet. Immediate execution would lead to hw lockup</span>
<span class="cm">		 * requiring a powercycle to reset. Good candidate to trigger</span>
<span class="cm">		 * this is the final UA:RSP packet after receiving a DISC:CMD</span>
<span class="cm">		 * when getting the LAP down.</span>
<span class="cm">		 * Note that we are not protected by the queue_stop approach</span>
<span class="cm">		 * because the final UA:RSP arrives _without_ request to apply</span>
<span class="cm">		 * new-speed-after-this-packet - hence the driver doesn&#39;t know</span>
<span class="cm">		 * this was the last packet and doesn&#39;t stop the queue. So the</span>
<span class="cm">		 * forced switch to default speed from LAP gets through as fast</span>
<span class="cm">		 * as only some 10 usec later while the UA:RSP is still processed</span>
<span class="cm">		 * by the hardware and we would get screwed.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ring_first</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no race - tx-ring already empty */</span>
			<span class="n">vlsi_set_baud</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="p">;</span>
			<span class="cm">/* keep the speed change pending like it would</span>
<span class="cm">			 * for any len&gt;0 packet. tx completion interrupt</span>
<span class="cm">			 * will apply it when the tx ring becomes empty.</span>
<span class="cm">			 */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sanity checks - simply drop the packet */</span>

	<span class="n">rd</span> <span class="o">=</span> <span class="n">ring_last</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;ring full, but queue wasn&#39;t stopped&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd_is_active</span><span class="p">(</span><span class="n">rd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;entry still owned by hw&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;tx ring entry without pci buffer&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;ring entry with old skb still attached&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* no need for serialization or interrupt disable during mtt */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mtt</span> <span class="o">=</span> <span class="n">irda_get_mtt</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	
		<span class="n">ready</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">+</span> <span class="n">mtt</span><span class="p">;</span>
		<span class="n">ready</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ready</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">&gt;=</span> <span class="mi">1000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ready</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-=</span> <span class="mi">1000000</span><span class="p">;</span>
			<span class="n">ready</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* IrLAP 1.1: mtt always &lt; 1 sec */</span>
		<span class="p">}</span>
		<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">&gt;</span> <span class="n">ready</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">==</span><span class="n">ready</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">&amp;&amp;</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span><span class="o">&gt;=</span><span class="n">ready</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">))</span>
			    	<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
			<span class="cm">/* must not sleep here - called under netif_tx_lock! */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* tx buffer already owned by CPU due to pci_dma_sync_single_for_cpu()</span>
<span class="cm">	 * after subsequent tx-completion</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IFF_SIR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">RD_TX_DISCRC</span><span class="p">;</span>		<span class="cm">/* no hw-crc creation */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">async_wrap_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="cm">/* Some rare worst case situation in SIR mode might lead to</span>
<span class="cm">		 * potential buffer overflow. The wrapper detects this, returns</span>
<span class="cm">		 * with a shortened frame (without FCS/EOF) but doesn&#39;t provide</span>
<span class="cm">		 * any error indication about the invalid packet which we are</span>
<span class="cm">		 * going to transmit.</span>
<span class="cm">		 * Therefore we log if the buffer got filled to the point, where the</span>
<span class="cm">		 * wrapper would abort, i.e. when there are less than 5 bytes left to</span>
<span class="cm">		 * allow appending the FCS/EOF.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="mi">5</span><span class="p">)</span>
			 <span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: possible buffer overflow with SIR wrapping!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* hw deals with MIR/FIR mode wrapping */</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">RD_TX_PULSE</span><span class="p">;</span>		<span class="cm">/* send 2 us highspeed indication pulse */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;frame exceeds tx buffer length&quot;</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>			<span class="cm">/* remember skb for tx-complete stats */</span>

	<span class="n">rd_set_count</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">rd_set_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>	<span class="cm">/* not yet active! */</span>

	<span class="cm">/* give dma buffer back to busmaster-hw (flush caches to make</span>
<span class="cm">	 * CPU-driven changes visible from the pci bus).</span>
<span class="cm">	 */</span>

	<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>

<span class="cm">/*	Switching to TX mode here races with the controller</span>
<span class="cm"> *	which may stop TX at any time when fetching an inactive descriptor</span>
<span class="cm"> *	or one with CLR_ENTX set. So we switch on TX only, if TX was not running</span>
<span class="cm"> *	_after_ the new descriptor was activated on the ring. This ensures</span>
<span class="cm"> *	we will either find TX already stopped or we can be sure, there</span>
<span class="cm"> *	will be a TX-complete interrupt even if the chip stopped doing</span>
<span class="cm"> *	TX just after we found it still running. The ISR will then find</span>
<span class="cm"> *	the non-empty ring and restart TX processing. The enclosing</span>
<span class="cm"> *	spinlock provides the correct serialization to prevent race with isr.</span>
<span class="cm"> */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rd_activate</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRENABLE_ENTXST</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fifocnt</span><span class="p">;</span>

		<span class="n">fifocnt</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">VLSI_PIO_RCVBCNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCVBCNT_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifocnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: rx fifo not empty(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fifocnt</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">config</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">config</span> <span class="o">|</span> <span class="n">IRCFG_ENTX</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_PROMPT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ring_put</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: tx ring full - queue stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="nl">drop_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: dropping packet - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Don&#39;t even think about returning NET_XMIT_DROP (=1) here!</span>
<span class="cm">	 * In fact any retval!=0 causes the packet scheduler to requeue the</span>
<span class="cm">	 * packet for later retry of transmission - which isn&#39;t exactly</span>
<span class="cm">	 * what we want after we&#39;ve just called dev_kfree_skb_any ;-)</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_tx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vlsi_ring</span>	<span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_descr</span>	<span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">unsigned</span>	<span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">config</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">ring_first</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="n">rd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">ring_get</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rd_is_active</span><span class="p">(</span><span class="n">rd</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">vlsi_process_tx</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_TX_DROP</span><span class="p">)</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_TX_FIFO</span><span class="p">)</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span>  <span class="o">&amp;&amp;</span>  <span class="n">rd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/* tx ring empty and speed change pending */</span>
		<span class="n">vlsi_set_baud</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>			<span class="cm">/* tx ring empty: re-enable rx */</span>
		<span class="n">outw</span><span class="p">((</span><span class="n">config</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IRCFG_ENTX</span><span class="p">)</span> <span class="o">|</span> <span class="n">IRCFG_ENRX</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>

	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRENABLE_ENTXST</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fifocnt</span><span class="p">;</span>

		<span class="n">fifocnt</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RCVBCNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCVBCNT_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fifocnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: rx fifo not empty(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">fifocnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">config</span> <span class="o">|</span> <span class="n">IRCFG_ENTX</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_PROMPT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s: queue awoken</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* caller must have stopped the controller from busmastering */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_unarm_tx</span><span class="p">(</span><span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vlsi_ring</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_descr</span> <span class="o">*</span><span class="n">rd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rd</span> <span class="o">=</span> <span class="n">ring_first</span><span class="p">(</span><span class="n">r</span><span class="p">);</span> <span class="n">rd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">ring_get</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rd_is_active</span><span class="p">(</span><span class="n">rd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rd_set_status</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rd_set_count</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rd_get_addr</span><span class="p">(</span><span class="n">rd</span><span class="p">),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">rd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s - dropping tx packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">VLSI_TX_DROP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vlsi_process_tx</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_TX_DROP</span><span class="p">)</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">VLSI_TX_FIFO</span><span class="p">)</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_start_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">clkctl</span><span class="p">,</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clksrc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* auto or PLL: try PLL */</span>
		<span class="n">clkctl</span> <span class="o">=</span> <span class="n">CLKCTL_PD_INV</span> <span class="o">|</span> <span class="n">CLKCTL_CLKSTP</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>

		<span class="cm">/* procedure to detect PLL lock synchronisation:</span>
<span class="cm">		 * after 0.5 msec initial delay we expect to find 3 PLL lock</span>
<span class="cm">		 * indications within 10 msec for successful PLL detection.</span>
<span class="cm">		 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* max 10 msec */</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="o">&amp;</span><span class="n">CLKCTL_LOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">clksrc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* explicitly asked for PLL hence bail out */</span>
				<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: no PLL or failed to lock!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">__func__</span><span class="p">);</span>
				<span class="n">clkctl</span> <span class="o">=</span> <span class="n">CLKCTL_CLKSTP</span><span class="p">;</span>
				<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>			<span class="cm">/* was: clksrc=0(auto) */</span>
				<span class="n">clksrc</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* fallback to 40MHz XCLK (OB800) */</span>

			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: PLL not locked, fallback to clksrc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">clksrc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">clksrc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* got successful PLL lock */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clksrc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we get here if either no PLL detected in auto-mode or</span>
<span class="cm">		   an external clock source was explicitly specified */</span>

		<span class="n">clkctl</span> <span class="o">=</span> <span class="n">CLKCTL_EXTCLK</span> <span class="o">|</span> <span class="n">CLKCTL_CLKSTP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clksrc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">clkctl</span> <span class="o">|=</span> <span class="n">CLKCTL_XCKSEL</span><span class="p">;</span>	
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>

		<span class="cm">/* no way to test for working XCLK */</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clkctl</span><span class="p">);</span>

	<span class="cm">/* ok, now going to connect the chip with the clock source */</span>

	<span class="n">clkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLKCTL_CLKSTP</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_stop_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span>	<span class="n">clkctl</span><span class="p">;</span>

	<span class="cm">/* disconnect chip from clock source */</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clkctl</span><span class="p">);</span>
	<span class="n">clkctl</span> <span class="o">|=</span> <span class="n">CLKCTL_CLKSTP</span><span class="p">;</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>

	<span class="cm">/* disable all clock sources */</span>
	<span class="n">clkctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CLKCTL_EXTCLK</span> <span class="o">|</span> <span class="n">CLKCTL_PD_INV</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_CLKCTL</span><span class="p">,</span> <span class="n">clkctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************/</span>

<span class="cm">/* writing all-zero to the VLSI PCI IO register area seems to prevent</span>
<span class="cm"> * some occasional situations where the hardware fails (symptoms are </span>
<span class="cm"> * what appears as stalled tx/rx state machines, i.e. everything ok for</span>
<span class="cm"> * receive or transmit but hw makes no progress or is unable to access</span>
<span class="cm"> * the bus memory locations).</span>
<span class="cm"> * Best place to call this is immediately after/before the internal clock</span>
<span class="cm"> * gets started/stopped.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vlsi_clear_regs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span>	<span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span>	<span class="n">chip_io_extent</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip_io_extent</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span>
		<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span>	<span class="n">iobase</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* start the clock and clean the registers */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlsi_start_clock</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: no valid clock source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">vlsi_clear_regs</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">IRINTR_INT_MASK</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span> <span class="cm">/* w/c pending IRQ, disable all INT */</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">);</span>	<span class="cm">/* disable IrPHY-interface */</span>

	<span class="cm">/* disable everything, particularly IRCFG_MSTR - (also resetting the RING_PTR) */</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">MAX_PACKET_LENGTH</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_MAXPKT</span><span class="p">);</span>  <span class="cm">/* max possible value=0x0fff */</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">BUS_TO_RINGBASE</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">busaddr</span><span class="p">),</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RINGBASE</span><span class="p">);</span>

	<span class="n">outw</span><span class="p">(</span><span class="n">TX_RX_TO_RINGSIZE</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span>
		<span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RINGSIZE</span><span class="p">);</span>	

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_RINGPTR</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">RINGPTR_GET_RX</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">RINGPTR_GET_RX</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">RINGPTR_GET_TX</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">RINGPTR_GET_TX</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>

	<span class="n">vlsi_set_baud</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>	<span class="cm">/* idev-&gt;new_baud used as provided by caller */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">IRINTR_INT_MASK</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>	<span class="cm">/* just in case - w/c pending IRQ&#39;s */</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="cm">/* DO NOT BLINDLY ENABLE IRINTR_ACTEN!</span>
<span class="cm">	 * basically every received pulse fires an ACTIVITY-INT</span>
<span class="cm">	 * leading to &gt;&gt;1000 INT&#39;s per second instead of few 10</span>
<span class="cm">	 */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">IRINTR_RPKTEN</span><span class="o">|</span><span class="n">IRINTR_TPKTEN</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_start_hw</span><span class="p">(</span><span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t use the legacy UART, disable its address decoding */</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_IRMISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">);</span>
	<span class="n">byte</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IRMISC_UARTEN</span> <span class="o">|</span> <span class="n">IRMISC_UARTTST</span><span class="p">);</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_IRMISC</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="cm">/* enable PCI busmaster access to our 16MB page */</span>

	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">VLSI_PCI_MSTRPAGE</span><span class="p">,</span> <span class="n">MSTRPAGE_VALUE</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlsi_init_chip</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vlsi_fill_rx</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">);</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">);</span>	<span class="cm">/* first mtt may start from now on */</span>

	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_PROMPT</span><span class="p">);</span>	<span class="cm">/* kick hw state machine */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_stop_hw</span><span class="p">(</span><span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRENABLE</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRCFG</span><span class="p">);</span>			<span class="cm">/* disable everything */</span>

	<span class="cm">/* disable and w/c irqs */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">IRINTR_INT_MASK</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">vlsi_unarm_tx</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">vlsi_unarm_rx</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>

	<span class="n">vlsi_clear_regs</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">vlsi_stop_clock</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vlsi_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>


	<span class="n">vlsi_reg_debug</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">vlsi_ring_debug</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">vlsi_stop_hw</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>

	<span class="cm">/* now simply restart the whole thing */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span><span class="p">)</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>		<span class="cm">/* keep current baudrate */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlsi_start_hw</span><span class="p">(</span><span class="n">idev</span><span class="p">))</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: failed to restart hw - %s(%s) unusable!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fifocnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SIOCSBANDWIDTH</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span> <span class="o">=</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_baudrate</span><span class="p">;</span>
			<span class="cm">/* when called from userland there might be a minor race window here</span>
<span class="cm">			 * if the stack tries to change speed concurrently - which would be</span>
<span class="cm">			 * pretty strange anyway with the userland having full control...</span>
<span class="cm">			 */</span>
			<span class="n">vlsi_set_baud</span><span class="p">(</span><span class="n">idev</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIOCSMEDIABUSY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">irda_device_set_media_busy</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIOCGRECEIVING</span>:
			<span class="cm">/* the best we can do: check whether there are any bytes in rx fifo.</span>
<span class="cm">			 * The trustable window (in case some data arrives just afterwards)</span>
<span class="cm">			 * may be as short as 1usec or so at 4Mbps.</span>
<span class="cm">			 */</span>
			<span class="n">fifocnt</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">VLSI_PIO_RCVBCNT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCVBCNT_MASK</span><span class="p">;</span>
			<span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_receiving</span> <span class="o">=</span> <span class="p">(</span><span class="n">fifocnt</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: notsupp - cmd=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>	
	
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vlsi_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_instance</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">dev_instance</span><span class="p">;</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">unsigned</span>	<span class="n">iobase</span><span class="p">;</span>
	<span class="n">u8</span>		<span class="n">irintr</span><span class="p">;</span>
	<span class="kt">int</span> 		<span class="n">boguscount</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">irintr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">irintr</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>	<span class="cm">/* acknowledge asap */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irintr</span><span class="o">&amp;=</span><span class="n">IRINTR_INT_MASK</span><span class="p">))</span>		<span class="cm">/* not our INT - probably shared */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irintr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IRINTR_ACTIVITY</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>				<span class="cm">/* nothing todo if only activity */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irintr</span><span class="o">&amp;</span><span class="n">IRINTR_RPKTINT</span><span class="p">)</span>
			<span class="n">vlsi_rx_interrupt</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irintr</span><span class="o">&amp;</span><span class="n">IRINTR_TPKTINT</span><span class="p">)</span>
			<span class="n">vlsi_tx_interrupt</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">boguscount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s: too much work in interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">hwname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_request_regions</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">drivername</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: io resource busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* under some rare occasions the chip apparently comes up with</span>
<span class="cm">	 * IRQ&#39;s pending. We better w/c pending IRQ and disable them all</span>
<span class="cm">	 */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">IRINTR_INT_MASK</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">VLSI_PIO_IRINTR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">vlsi_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">drivername</span><span class="p">,</span> <span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: couldn&#39;t get IRQ: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout_io</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">vlsi_create_hwif</span><span class="p">(</span><span class="n">idev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout_irq</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">hwname</span><span class="p">,</span> <span class="s">&quot;VLSI-FIR @ 0x%04x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="n">irlap_open</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span><span class="n">hwname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout_free_ring</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">);</span>  <span class="cm">/* first mtt may start from now on */</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>		<span class="cm">/* start with IrPHY using 9600(SIR) mode */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">vlsi_start_hw</span><span class="p">(</span><span class="n">idev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">errout_close_irlap</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s: device %s operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout_close_irlap:</span>
	<span class="n">irlap_close</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
<span class="nl">errout_free_ring:</span>
	<span class="n">vlsi_destroy_hwif</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
<span class="nl">errout_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">ndev</span><span class="p">);</span>
<span class="nl">errout_io:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">errout:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span>
		<span class="n">irlap_close</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vlsi_stop_hw</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>

	<span class="n">vlsi_destroy_hwif</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s: device %s stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">vlsi_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">vlsi_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">vlsi_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">vlsi_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">vlsi_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">vlsi_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_irda_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* PCI busmastering</span>
<span class="cm">	 * see include file for details why we need these 2 masks, in this order!</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">DMA_MASK_USED_BY_HW</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="n">DMA_MASK_MSTRPAGE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: aborting due to PCI BM-DMA address limitations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irda_init_max_qos_capabilies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="cm">/* the VLSI82C147 does not support 576000! */</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">IR_2400</span> <span class="o">|</span> <span class="n">IR_9600</span>
		<span class="o">|</span> <span class="n">IR_19200</span> <span class="o">|</span> <span class="n">IR_38400</span> <span class="o">|</span> <span class="n">IR_57600</span> <span class="o">|</span> <span class="n">IR_115200</span>
		<span class="o">|</span> <span class="n">IR_1152000</span> <span class="o">|</span> <span class="p">(</span><span class="n">IR_4000000</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">min_turn_time</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">qos_mtt_bits</span><span class="p">;</span>

	<span class="n">irda_qos_bits_to_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="cm">/* currently no public media definitions for IrDA */</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_PORTSEL</span> <span class="o">|</span> <span class="n">IFF_AUTOMEDIA</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">if_port</span> <span class="o">=</span> <span class="n">IF_PORT_UNKNOWN</span><span class="p">;</span>
 
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vlsi_netdev_ops</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>  <span class="o">=</span> <span class="mi">500</span><span class="o">*</span><span class="n">HZ</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* max. allowed turn time for IrLAP */</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>	

<span class="cm">/**************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">vlsi_irda_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="n">vlsi_irda_dev_t</span>		<span class="o">*</span><span class="n">idev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* hw must be running now */</span>

	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s: IrDA PCI controller %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">drivername</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IO</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: bar 0 invalid&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_irdadev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">idev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: Unable to allocate device memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlsi_irda_init</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_freedev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: register_netdev failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_freedev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vlsi_proc_root</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

		<span class="n">ent</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span><span class="o">|</span><span class="n">S_IRUGO</span><span class="p">,</span>
				       <span class="n">vlsi_proc_root</span><span class="p">,</span> <span class="n">VLSI_PROC_FOPS</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: failed to create proc entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ent</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s: registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drivername</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_freedev:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="nl">out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">vlsi_irda_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: lost netdevice?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drivername</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vlsi_proc_root</span><span class="p">);</span>
		<span class="n">idev</span><span class="o">-&gt;</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;%s: %s removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drivername</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/* The Controller doesn&#39;t provide PCI PM capabilities as defined by PCI specs.</span>
<span class="cm"> * Some of the Linux PCI-PM code however depends on this, for example in</span>
<span class="cm"> * pci_set_power_state(). So we have to take care to perform the required</span>
<span class="cm"> * operations on our own (particularly reflecting the pdev-&gt;current_state)</span>
<span class="cm"> * otherwise we might get cheated by pci-pm.</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_irda_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">vlsi_irda_dev_t</span> <span class="o">*</span><span class="n">idev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s - %s: no netdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* already suspended */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">event</span> <span class="o">&gt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* simply go deeper */</span>
			<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s - %s: invalid suspend request %u -&gt; %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">vlsi_stop_hw</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span><span class="p">)</span>
			<span class="cm">/* remember speed settings to restore on resume */</span>
			<span class="n">idev</span><span class="o">-&gt;</span><span class="n">new_baud</span> <span class="o">=</span> <span class="n">idev</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">;</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">resume_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vlsi_irda_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">vlsi_irda_dev_t</span>	<span class="o">*</span><span class="n">idev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s - %s: no netdevice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s - %s: already resumed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">__func__</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">PM_EVENT_ON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">resume_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* should be obsolete now - but used to happen due to:</span>
<span class="cm">		 * - pci layer initially setting pdev-&gt;current_state = 4 (unknown)</span>
<span class="cm">		 * - pci layer did not walk the save_state-tree (might be APM problem)</span>
<span class="cm">		 *   so we could not refuse to suspend from undefined state</span>
<span class="cm">		 * - vlsi_irda_suspend detected invalid state and refused to save</span>
<span class="cm">		 *   configuration for resume - but was too late to stop suspending</span>
<span class="cm">		 * - vlsi_irda_resume got screwed when trying to resume from garbage</span>
<span class="cm">		 *</span>
<span class="cm">		 * now we explicitly set pdev-&gt;current_state = 0 after enabling the</span>
<span class="cm">		 * device and independently resume_ok should catch any garbage config.</span>
<span class="cm">		 */</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s - hm, nothing to resume?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">ndev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">vlsi_start_hw</span><span class="p">(</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idev</span><span class="o">-&gt;</span><span class="n">resume_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cm">/*********************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">vlsi_irda_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">drivername</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">vlsi_irda_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">vlsi_irda_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">vlsi_irda_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">vlsi_irda_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">vlsi_irda_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#define PROC_DIR (&quot;driver/&quot; DRIVER_NAME)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vlsi_mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">clksrc</span> <span class="o">&lt;</span> <span class="mi">0</span>  <span class="o">||</span>  <span class="n">clksrc</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: invalid clksrc=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drivername</span><span class="p">,</span> <span class="n">clksrc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">ringsize</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">case</span> <span class="mi">8</span>:
			<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">case</span> <span class="mi">32</span>:
			<span class="k">case</span> <span class="mi">64</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s: invalid %s ringsize %d, using default=8&quot;</span><span class="p">,</span> <span class="n">drivername</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;rx&quot;</span><span class="o">:</span><span class="s">&quot;tx&quot;</span><span class="p">,</span> <span class="n">ringsize</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">ringsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> 

	<span class="n">sirpulse</span> <span class="o">=</span> <span class="o">!!</span><span class="n">sirpulse</span><span class="p">;</span>

	<span class="cm">/* proc_mkdir returns NULL if !CONFIG_PROC_FS.</span>
<span class="cm">	 * Failure to create the procfs entry is handled like running</span>
<span class="cm">	 * without procfs - it&#39;s not required for the driver to work.</span>
<span class="cm">	 */</span>
	<span class="n">vlsi_proc_root</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">PROC_DIR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vlsi_irda_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">vlsi_proc_root</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">PROC_DIR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">vlsi_mod_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vlsi_irda_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlsi_proc_root</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">PROC_DIR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">vlsi_mod_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vlsi_mod_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
