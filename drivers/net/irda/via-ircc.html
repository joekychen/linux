<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › irda › via-ircc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>via-ircc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/********************************************************************</span>
<span class="cm"> Filename:      via-ircc.c</span>
<span class="cm"> Version:       1.0 </span>
<span class="cm"> Description:   Driver for the VIA VT8231/VT8233 IrDA chipsets</span>
<span class="cm"> Author:        VIA Technologies,inc</span>
<span class="cm"> Date  :	08/06/2003</span>

<span class="cm">Copyright (c) 1998-2003 VIA Technologies, Inc.</span>

<span class="cm">This program is free software; you can redistribute it and/or modify it under</span>
<span class="cm">the terms of the GNU General Public License as published by the Free Software</span>
<span class="cm">Foundation; either version 2, or (at your option) any later version.</span>

<span class="cm">This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm">ANY WARRANTIES OR REPRESENTATIONS; without even the implied warranty of</span>
<span class="cm">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm">See the GNU General Public License for more details.</span>

<span class="cm">You should have received a copy of the GNU General Public License along with</span>
<span class="cm">this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm">59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>

<span class="cm">F01 Oct/02/02: Modify code for V0.11(move out back to back transfer)</span>
<span class="cm">F02 Oct/28/02: Add SB device ID for 3147 and 3177.</span>
<span class="cm"> Comment :</span>
<span class="cm">       jul/09/2002 : only implement two kind of dongle currently.</span>
<span class="cm">       Oct/02/2002 : work on VT8231 and VT8233 .</span>
<span class="cm">       Aug/06/2003 : change driver format to pci driver .</span>

<span class="cm">2004-02-16: &lt;sda@bdit.de&gt;</span>
<span class="cm">- Removed unneeded &#39;legacy&#39; pci stuff.</span>
<span class="cm">- Make sure SIR mode is set (hw_init()) before calling mode-dependent stuff.</span>
<span class="cm">- On speed change from core, don&#39;t send SIR frame with new speed. </span>
<span class="cm">  Use current speed and change speeds later.</span>
<span class="cm">- Make module-param dongle_id actually work.</span>
<span class="cm">- New dongle_id 17 (0x11): TDFS4500. Single-ended SIR only. </span>
<span class="cm">  Tested with home-grown PCB on EPIA boards.</span>
<span class="cm">- Code cleanup.</span>
<span class="cm">       </span>
<span class="cm"> ********************************************************************/</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;linux/pm.h&gt;</span>

<span class="cp">#include &lt;net/irda/wrapper.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda_device.h&gt;</span>

<span class="cp">#include &quot;via-ircc.h&quot;</span>

<span class="cp">#define VIA_MODULE_NAME &quot;via-ircc&quot;</span>
<span class="cp">#define CHIP_IO_EXTENT 0x40</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">VIA_MODULE_NAME</span><span class="p">;</span>

<span class="cm">/* Module parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qos_mtt_bits</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>	<span class="cm">/* 1 ms or more */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dongle_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* default: probe */</span>

<span class="cm">/* We can&#39;t guess the type of connected dongle, user *must* supply it. */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dongle_id</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* Some prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_dma_receive_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">via_ircc_hard_xmit_sir</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">via_ircc_hard_xmit_fir</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">via_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">via_ircc_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">baud</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">via_ircc_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_is_receiving</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_read_dongle_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">via_ircc_change_dongle_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">dongle_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">RxTimerHandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hwreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">via_ircc_dma_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">upload_rxdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">via_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="n">via_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="cm">/* FIXME : Should use udelay() instead, even if we are x86 only - Jean II */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iodelay</span><span class="p">(</span><span class="kt">int</span> <span class="n">udelay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">udelay</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">via_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="mh">0x8231</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="mh">0x3109</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="mh">0x3074</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="mh">0x3147</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_VIA</span><span class="p">,</span> <span class="mh">0x3177</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span><span class="n">via_pci_tbl</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">via_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">VIA_MODULE_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">via_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">via_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">via_remove_one</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_init ()</span>
<span class="cm"> *</span>
<span class="cm"> *    Initialize chip. Just find out chip type and resource.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">via_ircc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(): error rc = %d, returning  -ENODEV...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">via_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
        <span class="n">u8</span> <span class="n">temp</span><span class="p">,</span><span class="n">oldPCI_40</span><span class="p">,</span><span class="n">oldPCI_44</span><span class="p">,</span><span class="n">bTmp</span><span class="p">,</span><span class="n">bTmp1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">Chipset</span><span class="p">,</span><span class="n">FirDRQ1</span><span class="p">,</span><span class="n">FirDRQ0</span><span class="p">,</span><span class="n">FirIRQ</span><span class="p">,</span><span class="n">FirIOBase</span><span class="p">;</span>
	<span class="n">chipio_t</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): Device ID=(0X%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span> <span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(): error rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>South Bridge exist</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span> <span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3C</span> <span class="p">)</span>
		<span class="n">Chipset</span><span class="o">=</span><span class="mh">0x3096</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">Chipset</span><span class="o">=</span><span class="mh">0x3076</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">Chipset</span><span class="o">==</span><span class="mh">0x3076</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): Chipset = 3076</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">WriteLPCReg</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x0c</span> <span class="p">);</span>
		<span class="n">temp</span><span class="o">=</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x30</span><span class="p">);</span><span class="c1">//check if BIOS Enable Fir</span>
		<span class="k">if</span><span class="p">((</span><span class="n">temp</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>   <span class="c1">// BIOS close or no FIR</span>
			<span class="n">WriteLPCReg</span><span class="p">(</span><span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x82</span> <span class="p">);</span>
			<span class="n">WriteLPCReg</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span><span class="mh">0x18</span><span class="p">);</span>
			<span class="n">temp</span><span class="o">=</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0xF0</span><span class="p">);</span>
			<span class="k">if</span><span class="p">((</span><span class="n">temp</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">temp</span><span class="o">=</span><span class="p">(</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x74</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x03</span><span class="p">);</span>    <span class="c1">//DMA</span>
				<span class="n">FirDRQ0</span><span class="o">=</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">temp</span><span class="o">=</span><span class="p">(</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x74</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">FirDRQ1</span><span class="o">=</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">temp</span><span class="o">=</span><span class="p">(</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x74</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>    <span class="c1">//DMA</span>
				<span class="n">FirDRQ0</span><span class="o">=</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">FirDRQ1</span><span class="o">=</span><span class="n">FirDRQ0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">FirIRQ</span><span class="o">=</span><span class="p">(</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x70</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">);</span>		<span class="c1">//IRQ</span>
			<span class="n">FirIOBase</span><span class="o">=</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x60</span> <span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>	<span class="c1">//IO Space :high byte</span>
			<span class="n">FirIOBase</span><span class="o">=</span><span class="n">FirIOBase</span><span class="o">|</span> <span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x61</span><span class="p">)</span> <span class="p">;</span>	<span class="c1">//low byte</span>
			<span class="n">FirIOBase</span><span class="o">=</span><span class="n">FirIOBase</span>  <span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fir_base</span><span class="o">=</span><span class="n">FirIOBase</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">irq</span><span class="o">=</span><span class="n">FirIRQ</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">dma</span><span class="o">=</span><span class="n">FirDRQ1</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">dma2</span><span class="o">=</span><span class="n">FirDRQ0</span><span class="p">;</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,((</span><span class="n">bTmp</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">));</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,(</span><span class="n">bTmp</span> <span class="o">|</span> <span class="mh">0xf0</span><span class="p">));</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x5a</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">);</span>
			<span class="n">WriteLPCReg</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x70</span> <span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">via_ircc_open</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mh">0x3076</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="c1">//IR not turn on	 </span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//Not VT1211</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): Chipset = 3096</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x67</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp</span><span class="p">);</span><span class="c1">//check if BIOS Enable Fir</span>
		<span class="k">if</span><span class="p">((</span><span class="n">bTmp</span><span class="o">&amp;</span><span class="mh">0x01</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// BIOS enable FIR</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Enable Double DMA clock</p></td><td class="code"><div class="highlight"><pre>			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="o">&amp;</span><span class="n">oldPCI_40</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x42</span><span class="p">,</span><span class="n">oldPCI_40</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="o">&amp;</span><span class="n">oldPCI_40</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="n">oldPCI_40</span> <span class="o">&amp;</span> <span class="mh">0xf7</span><span class="p">);</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="o">&amp;</span><span class="n">oldPCI_44</span><span class="p">);</span>
			<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x4e</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>---------- read configuration from Function0 of south bridge</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span><span class="p">((</span><span class="n">bTmp</span><span class="o">&amp;</span><span class="mh">0x02</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp1</span><span class="p">);</span> <span class="c1">//DMA</span>
				<span class="n">FirDRQ0</span> <span class="o">=</span> <span class="p">(</span><span class="n">bTmp1</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp1</span><span class="p">);</span>
				<span class="n">FirDRQ1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bTmp1</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
				<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp1</span><span class="p">);</span>    <span class="c1">//DMA</span>
				<span class="n">FirDRQ0</span> <span class="o">=</span> <span class="p">(</span><span class="n">bTmp1</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="p">;</span>
				<span class="n">FirDRQ1</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x47</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp1</span><span class="p">);</span>  <span class="c1">//IRQ</span>
			<span class="n">FirIRQ</span> <span class="o">=</span> <span class="n">bTmp1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp</span><span class="p">);</span>
			<span class="n">FirIOBase</span> <span class="o">=</span> <span class="n">bTmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span><span class="c1">//hight byte</span>
			<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="o">&amp;</span><span class="n">bTmp</span><span class="p">);</span>
			<span class="n">FirIOBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">FirIOBase</span> <span class="o">|</span> <span class="n">bTmp</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre>			<span class="n">info</span><span class="p">.</span><span class="n">fir_base</span><span class="o">=</span><span class="n">FirIOBase</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">irq</span><span class="o">=</span><span class="n">FirIRQ</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">dma</span><span class="o">=</span><span class="n">FirDRQ1</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">dma2</span><span class="o">=</span><span class="n">FirDRQ0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">via_ircc_open</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mh">0x3096</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rc</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="c1">//IR not turn on !!!!!</span>
	<span class="p">}</span><span class="c1">//Not VT1211</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): End - rc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">via_ircc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Cleanup all instances of the driver */</span>
	<span class="n">pci_unregister_driver</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">via_driver</span><span class="p">);</span> 
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">via_ircc_sir_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">via_ircc_hard_xmit_sir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">via_ircc_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">via_ircc_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> <span class="o">=</span> <span class="n">via_ircc_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">via_ircc_fir_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">via_ircc_hard_xmit_fir</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">via_ircc_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">via_ircc_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> <span class="o">=</span> <span class="n">via_ircc_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_open(pdev, iobase, irq)</span>
<span class="cm"> *</span>
<span class="cm"> *    Open driver instance</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">via_ircc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chipio_t</span> <span class="o">*</span> <span class="n">info</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Allocate new instance of the driver */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_irdadev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

	<span class="cm">/* Initialize Resource */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">cfg_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cfg_base</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span> <span class="o">=</span> <span class="n">CHIP_IO_EXTENT</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma2</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">RxDataReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reserve the ioports that we need */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), can&#39;t get iobase of 0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* Initialize QoS for this device */</span>
	<span class="n">irda_init_max_qos_capabilies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="cm">/* Check if user has supplied the dongle id or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dongle_id</span><span class="p">)</span>
		<span class="n">dongle_id</span> <span class="o">=</span> <span class="n">via_ircc_read_dongle_id</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dongle_id</span> <span class="o">=</span> <span class="n">dongle_id</span><span class="p">;</span>

	<span class="cm">/* The only value we must override it the baudrate */</span>
	<span class="cm">/* Maximum speeds and capabilities are dongle-dependent. */</span>
	<span class="k">switch</span><span class="p">(</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dongle_id</span> <span class="p">){</span>
	<span class="k">case</span> <span class="mh">0x0d</span>:
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span>
		    <span class="n">IR_9600</span> <span class="o">|</span> <span class="n">IR_19200</span> <span class="o">|</span> <span class="n">IR_38400</span> <span class="o">|</span> <span class="n">IR_57600</span> <span class="o">|</span> <span class="n">IR_115200</span> <span class="o">|</span>
		    <span class="n">IR_576000</span> <span class="o">|</span> <span class="n">IR_1152000</span> <span class="o">|</span> <span class="p">(</span><span class="n">IR_4000000</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span>
		    <span class="n">IR_9600</span> <span class="o">|</span> <span class="n">IR_19200</span> <span class="o">|</span> <span class="n">IR_38400</span> <span class="o">|</span> <span class="n">IR_57600</span> <span class="o">|</span> <span class="n">IR_115200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Following was used for testing:</span>
<span class="cm">	 *</span>
<span class="cm">	 *   self-&gt;qos.baud_rate.bits = IR_9600;</span>
<span class="cm">	 *</span>
<span class="cm">	 * Is is no good, as it prohibits (error-prone) speed-changes.</span>
<span class="cm">	 */</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">min_turn_time</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">qos_mtt_bits</span><span class="p">;</span>
	<span class="n">irda_qos_bits_to_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="cm">/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="mi">14384</span> <span class="o">+</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="mi">14384</span> <span class="o">+</span> <span class="mi">2048</span><span class="p">;</span>

	<span class="cm">/* Allocate memory if needed */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">in_frame</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>

	<span class="cm">/* Reset Tx queue info */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>

	<span class="cm">/* Override the network functions we need to use */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_ircc_sir_ops</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out4</span><span class="p">;</span>

	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;IrDA: Registered device %s (via-ircc)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Initialise the hardware..</span>
<span class="cm">	*/</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">via_hw_init</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">err_out4:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
			  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">);</span>
 <span class="nl">err_out3:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
			  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">);</span>
 <span class="nl">err_out2:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">);</span>
 <span class="nl">err_out1:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_remove_one(pdev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Close driver instance</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">via_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>	<span class="c1">//hardware reset.</span>
	<span class="cm">/* Remove netdevice */</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Release the PORT that this driver is using */</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), Releasing Region %03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_hw_init(self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Returns non-negative on success.</span>
<span class="cm"> *</span>
<span class="cm"> * Formerly via_ircc_setup </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">SetMaxRxPacketSize</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">);</span>	<span class="c1">//set to max:4095</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>FIFO Init</p></td><td class="code"><div class="highlight"><pre>	<span class="n">EnRXFIFOReadyInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnRXFIFOHalfLevelInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnTXFIFOHalfLevelInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnTXFIFOUnderrunEOMInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnTXFIFOReadyInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">InvertTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">InvertRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ReadLPCReg</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3c</span><span class="p">)</span>
		<span class="n">WriteLPCReg</span><span class="p">(</span><span class="mh">0xF0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="c1">// for VT1211</span>
	<span class="cm">/* Int Init */</span>
	<span class="n">EnRXSpecInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="cm">/* The following is basically hwreset */</span>
	<span class="cm">/* If this is the case, why not just call hwreset() ? Jean II */</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">EnableDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnableTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnableRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnTXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">TXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">InitCard</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">CommonInit</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">SIRFilter</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">SetSIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">CRC16</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnTXCRC</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SetBaudRate</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">9600</span><span class="p">);</span>
	<span class="n">SetPulseWidth</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">SetSendPreambleCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">via_ircc_change_dongle_speed</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span>
				     <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dongle_id</span><span class="p">);</span>

	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_read_dongle_id (void)</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_read_dongle_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dongle_id</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>	<span class="cm">/* Default to IBM */</span>

	<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;via-ircc: dongle probing not supported, please specify dongle_id module parameter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dongle_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_change_dongle_speed (iobase, speed, dongle_id)</span>
<span class="cm"> *    Change speed of the attach dongle</span>
<span class="cm"> *    only implement two type of dongle currently.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_ircc_change_dongle_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">dongle_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* speed is unused, as we use IsSIROn()/IsMIROn() */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): change_dongle_speed to %d for 0x%x, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">dongle_id</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dongle_id</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Note: The dongle_id&#39;s listed here are derived from</span>
<span class="cm">		 * nsc-ircc.c */</span> 

	<span class="k">case</span> <span class="mh">0x08</span>:		<span class="cm">/* HP HSDL-2300, HP HSDL-3600/HSDL-3610 */</span>
		<span class="n">UseOneRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>	<span class="c1">// use one RX pin   RX1,RX2</span>
		<span class="n">InvertTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">InvertRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

		<span class="n">EnRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>	<span class="c1">//sir to rx2</span>
		<span class="n">EnGPIOtoRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">IsSIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//sir</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Mode select Off</p></td><td class="code"><div class="highlight"><pre>			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IsMIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//mir</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Mode select On</p></td><td class="code"><div class="highlight"><pre>				<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// fir</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">IsFIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//fir</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Mode select On</p></td><td class="code"><div class="highlight"><pre>					<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x09</span>:		<span class="cm">/* IBM31T1100 or Temic TFDS6000/TFDS6500 */</span>
		<span class="n">UseOneRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>	<span class="c1">//use ONE RX....RX1</span>
		<span class="n">InvertTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">InvertRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>	<span class="c1">// invert RX pin</span>

		<span class="n">EnRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="n">EnGPIOtoRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IsSIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//sir</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Mode select On</p></td><td class="code"><div class="highlight"><pre>			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Mode select Off</p></td><td class="code"><div class="highlight"><pre>			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IsMIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//mir</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Mode select On</p></td><td class="code"><div class="highlight"><pre>			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Mode select Off</p></td><td class="code"><div class="highlight"><pre>			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// fir</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IsFIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//fir</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Mode select On</p></td><td class="code"><div class="highlight"><pre>				<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>TX On</p></td><td class="code"><div class="highlight"><pre>				<span class="n">WriteTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Mode select OFF</p></td><td class="code"><div class="highlight"><pre>				<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>TX Off</p></td><td class="code"><div class="highlight"><pre>				<span class="n">WriteTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x0d</span>:
		<span class="n">UseOneRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>	<span class="c1">// use two RX pin   RX1,RX2</span>
		<span class="n">InvertTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">InvertRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IsSIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>	<span class="c1">//sir</span>
			<span class="n">EnGPIOtoRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">WriteGIO</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">EnRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>	<span class="c1">//sir to rx2</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// fir mir</span>
			<span class="n">EnGPIOtoRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">WriteGIO</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
			<span class="n">EnRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>	<span class="c1">//fir to rx</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x11</span>:		<span class="cm">/* Temic TFDS4500 */</span>

		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s: Temic TFDS4500: One RX pin, TX normal, RX inverted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">UseOneRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>	<span class="c1">//use ONE RX....RX1</span>
		<span class="n">InvertTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">InvertRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>	<span class="c1">// invert RX pin</span>
	
		<span class="n">EnRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>	<span class="c1">//sir to rx2</span>
		<span class="n">EnGPIOtoRX2</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">IsSIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">)</span> <span class="p">){</span>	<span class="c1">//sir</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Mode select On</p></td><td class="code"><div class="highlight"><pre>			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Mode select Off</p></td><td class="code"><div class="highlight"><pre>			<span class="n">SlowIRRXLowActive</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span><span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s: Warning: TFDS4500 not running in SIR mode !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x0ff</span>:		<span class="cm">/* Vishay */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IsSIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IsMIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IsFIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IsVFIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="c1">//VFIR-16</span>
		<span class="n">SI_SetMode</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s: Error: dongle_id %d unsupported !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">dongle_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_change_speed (self, baud)</span>
<span class="cm"> *</span>
<span class="cm"> *    Change the speed of the device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">via_ircc_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bTmp</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="cm">/* Update accounting for new speed */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: change_speed to %d bps.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Controller mode sellection */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">2400</span>:
	<span class="k">case</span> <span class="mi">9600</span>:
	<span class="k">case</span> <span class="mi">19200</span>:
	<span class="k">case</span> <span class="mi">38400</span>:
	<span class="k">case</span> <span class="mi">57600</span>:
	<span class="k">case</span> <span class="mi">115200</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">115200</span><span class="o">/</span><span class="n">speed</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">SetSIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="n">CRC16</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">576000</span>:
		<span class="cm">/* FIXME: this can&#39;t be right, as it&#39;s the same as 115200,</span>
<span class="cm">		 * and 576000 is MIR, not SIR. */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SetSIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="n">CRC16</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1152000</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SetMIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="cm">/* FIXME: CRC ??? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4000000</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SetFIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="n">SetPulseWidth</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SetSendPreambleCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
		<span class="n">CRC16</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">EnTXCRC</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16000000</span>:
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SetVFIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="cm">/* FIXME: CRC ??? */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set baudrate to 0x19[2..7] */</span>
	<span class="n">bTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ReadReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_CF_H_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">bTmp</span> <span class="o">|=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_CF_H_1</span><span class="p">,</span> <span class="n">bTmp</span><span class="p">);</span>

	<span class="cm">/* Some dongles may need to be informed about speed changes. */</span>
	<span class="n">via_ircc_change_dongle_speed</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dongle_id</span><span class="p">);</span>

	<span class="cm">/* Set FIFO size to 64 */</span>
	<span class="n">SetFIFO</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="cm">/* Enable IR */</span>
	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>EnTXFIFOHalfLevelInt(iobase,ON);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Enable some interrupts so we can receive frames */</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>EnAllInt(iobase,ON);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">IsSIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SIRFilter</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
		<span class="n">SIRRecvAny</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SIRFilter</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">SIRRecvAny</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Install FIR xmit handler */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_ircc_fir_ops</span><span class="p">;</span>
		<span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Install SIR xmit handler */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">via_ircc_sir_ops</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_hard_xmit (skb, dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Transmit the frame!</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">via_ircc_hard_xmit_sir</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Check if we need to change the speed */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check for empty frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">via_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">InitCard</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">CommonInit</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">SIRFilter</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">SetSIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">CRC16</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnTXCRC</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
	    <span class="n">async_wrap_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
			   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="cm">/* Send this frame with old speed */</span>
	<span class="n">SetBaudRate</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">SetPulseWidth</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">SetSendPreambleCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">EnableTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnableRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">EnAllInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnTXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="n">irda_setup_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
		       <span class="n">DMA_TX_MODE</span><span class="p">);</span>

	<span class="n">SetSendByte</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">TXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">via_ircc_hard_xmit_fir</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x3076</span><span class="p">)</span>
		<span class="n">iodelay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">via_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
		      <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>F01   if (self->tx_fifo.len == 1) {</p></td><td class="code"><div class="highlight"><pre>	<span class="n">via_ircc_dma_xmit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>F01   }
F01   if (self->tx<em>fifo.free &lt; (MAX</em>TX<em>WINDOW -1 )) netif</em>wake_queue(self->netdev);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_dma_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">u16</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EnTXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_XMIT</span><span class="p">;</span>
	<span class="n">EnPhys</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnableTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnableRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">EnAllInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnTXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">irda_setup_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">start</span> <span class="o">-</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">,</span>
		       <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TX_MODE</span><span class="p">);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s: tx_fifo.ptr=%x,len=%x,tx_fifo.len=%x..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
		   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span><span class="p">,</span>
		   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">SetSendByte</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">queue</span><span class="p">[</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
	<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">TXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_dma_xmit_complete (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    The transfer of a frame in finished. This function will only be called </span>
<span class="cm"> *    by the interrupt handler</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_dma_xmit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">Tx_status</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="cm">/* Disable DMA */</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><pre><code> DisableDmaChannel(self-&gt;io.dma);
</code></pre></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* Check for underrun! */</span>
	<span class="cm">/* Clear bit, by writing 1 into it */</span>
	<span class="n">Tx_status</span> <span class="o">=</span> <span class="n">GetTXStatus</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">Tx_status</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hwreset</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="cm">/* how to clear underrun? */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Check if we need to change the speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">via_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finished with this frame, so prepare for next */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IsFIROn</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
		   <span class="s">&quot;%s: tx_fifo.len=%x ,tx_fifo.ptr=%x,tx_fifo.free=%x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span>
		   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span><span class="p">);</span>
<span class="cm">/* F01_S</span>

<span class="cm">//DIVIDER</span>
<span class="cm">	if (self-&gt;tx_fifo.len) {</span>

<span class="cm">//DIVIDER</span>
<span class="cm">	  	via_ircc_dma_xmit(self, iobase);</span>
<span class="cm">		ret = FALSE;</span>
<span class="cm">	} else { </span>
<span class="cm">F01_E*/</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Any frames to be sent back-to-back? </p></td><td class="code"><div class="highlight"><pre>	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Not finished yet! </p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Reset Tx FIFO info </p></td><td class="code"><div class="highlight"><pre>	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>F01   }</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_dma_receive (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Set configuration for receive a frame.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_dma_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">RxDataReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_RECV</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">pending_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">EnPhys</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnableTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnableRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">EnAllInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnTXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">irda_setup_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma2</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">,</span>
		  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span> <span class="n">DMA_RX_MODE</span><span class="p">);</span>
	<span class="n">TXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_dma_receive_complete (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Controller Finished with receiving frames,</span>
<span class="cm"> *    and this routine is call by ISR</span>
<span class="cm"> *    </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_dma_receive_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_fifo</span> <span class="o">*</span><span class="n">st_fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="n">st_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">4000000</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">//Speed below FIR</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">GetRecvByte</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Make sure we have room for more frames 
F01   if (self->tx<em>fifo.free &lt; (MAX</em>TX_WINDOW -1 )) {
Not busy transmitting anymore 
Tell the network layer, that we can accept more frames </p></td><td class="code"><div class="highlight"><pre>		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x3076</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x3096</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>F01   }</p></td><td class="code"><div class="highlight"><pre>		<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">else</span> <span class="p">{</span>			<span class="c1">//FIR mode</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">GetRecvByte</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>	<span class="c1">//interrupt only, data maybe move by RxT  </span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(): Trouble:len=%x,CurCount=%x,LastCount=%x..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">RxCurCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">),</span>
				   <span class="n">self</span><span class="o">-&gt;</span><span class="n">RxLastCount</span><span class="p">);</span>
			<span class="n">hwreset</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): fifo.len=%x,len=%x,CurCount=%x..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">RxCurCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">));</span>

		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">pending_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">++</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&gt;</span> <span class="n">MAX_RX_WINDOW</span><span class="p">)</span>
			<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">RxDataReady</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Make sure IP header gets aligned </p></td><td class="code"><div class="highlight"><pre><span class="cm">/* F01_S</span>
<span class="cm">          if (st_fifo-&gt;len &lt; (MAX_RX_WINDOW+2 )) { </span>
<span class="cm">		  RXStart(iobase,ON);</span>
<span class="cm">	  	  SetTimer(iobase,4);</span>
<span class="cm">	  }</span>
<span class="cm">	  else	  { </span>
<span class="cm">F01_E */</span>
		<span class="n">EnableRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Move to next frame </p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&gt;</span> <span class="n">MAX_RX_WINDOW</span><span class="p">)</span>
			<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * if frame size, data ptr, or skb ptr are wrong, then get next</span>
<span class="cm">		 * entry.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): len=%x.rx_buff=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>It maybe have MAX<em>RX</em>WINDOW package receive by
receive_complete before Timer IRQ</p></td><td class="code"><div class="highlight"><pre>		<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>F01_S
Put this entry back in fifo </p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>			<span class="c1">//FIR</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * if frame is received , but no INT ,then use this routine to upload frame.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">upload_rxdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_fifo</span> <span class="o">*</span><span class="n">st_fifo</span><span class="p">;</span>
	<span class="n">st_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">GetRecvByte</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): len=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">++</span><span class="p">;</span>
	<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">&gt;</span> <span class="n">MAX_RX_WINDOW</span><span class="p">)</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Move to next frame </p></td><td class="code"><div class="highlight"><pre>	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_RX_WINDOW</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">EnableRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
		<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Implement back to back receive , use this routine to upload data.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">RxTimerHandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_fifo</span> <span class="o">*</span><span class="n">st_fifo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">st_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CkRxRecv</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>F01_E</p></td><td class="code"><div class="highlight"><pre>		<span class="n">self</span><span class="o">-&gt;</span><span class="n">RetryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">SetTimer</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">RxDataReady</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">RetryCount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">RetryCount</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">pending_bytes</span> <span class="o">+</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">MAX_RX_WINDOW</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">//upload frame</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Move to next frame </p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&gt;</span> <span class="n">MAX_RX_WINDOW</span><span class="p">)</span>
				<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span><span class="p">;</span>
			<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * if frame size, data ptr, or skb ptr are wrong,</span>
<span class="cm">			 * then get next entry.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): len=%x.head=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				   <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>if still receiving ,then return ,don't upload frame </p></td><td class="code"><div class="highlight"><pre>			<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
			<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>		<span class="c1">//while</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">RetryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
			   <span class="s">&quot;%s(): End of upload HostStatus=%x,RxStatus=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span>
			   <span class="n">GetHostStatus</span><span class="p">(</span><span class="n">iobase</span><span class="p">),</span> <span class="n">GetRXStatus</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * if frame is receive complete at this routine ,then upload</span>
<span class="cm">		 * frame.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">GetRXStatus</span><span class="p">(</span><span class="n">iobase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">RxCurCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">RxLastCount</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">upload_rxdata</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irda_device_txqueue_empty</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
				<span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="c1">// timer detect complete</span>
	<span class="k">else</span>
		<span class="n">SetTimer</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_interrupt (irq, dev_id)</span>
<span class="cm"> *</span>
<span class="cm"> *    An interrupt from the chip has arrived. Time to do some work</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">via_ircc_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iHostIntType</span><span class="p">,</span> <span class="n">iRxIntType</span><span class="p">,</span> <span class="n">iTxIntType</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">iHostIntType</span> <span class="o">=</span> <span class="n">GetHostStatus</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(): iHostIntType %02x:  %s %s %s  %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">iHostIntType</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">iHostIntType</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Timer&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">iHostIntType</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Tx&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">iHostIntType</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Rx&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">iHostIntType</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">iHostIntType</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">//Timer Event</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">EventFlag</span><span class="p">.</span><span class="n">TimeOut</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ClearTimerInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IO_XMIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">via_ircc_dma_xmit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IO_RECV</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * frame ready hold too long, must reset.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">RxDataReady</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hwreset</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irda_device_txqueue_empty</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// call this to upload frame.</span>
				<span class="n">RxTimerHandler</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="c1">//RECV</span>
	<span class="p">}</span>			<span class="c1">//Timer Event</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">iHostIntType</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">//Tx Event</span>
		<span class="n">iTxIntType</span> <span class="o">=</span> <span class="n">GetTXStatus</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>

		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(): iTxIntType %02x:  %s %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">iTxIntType</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iTxIntType</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;FIFO underr.&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iTxIntType</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;EOM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iTxIntType</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;FIFO ready&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iTxIntType</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Early EOM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iTxIntType</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">EventFlag</span><span class="p">.</span><span class="n">EOMessage</span><span class="o">++</span><span class="p">;</span>	<span class="c1">// read and will auto clean</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">via_ircc_dma_xmit_complete</span><span class="p">(</span><span class="n">self</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">irda_device_txqueue_empty</span>
				    <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">EventFlag</span><span class="p">.</span><span class="n">Unknown</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="c1">//EOP</span>
	<span class="p">}</span>			<span class="c1">//Tx Event</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Put this entry back in fifo </p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">iHostIntType</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">//Rx Event</span>
		<span class="cm">/* Check if DMA has finished */</span>
		<span class="n">iRxIntType</span> <span class="o">=</span> <span class="n">GetRXStatus</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>

		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(): iRxIntType %02x:  %s %s %s %s %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">iRxIntType</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PHY err.&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CRC err&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;FIFO overr.&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;EOF&quot;</span>		<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RxData&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RxMaxLen&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SIR bad&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iRxIntType</span><span class="p">)</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s(): RxIRQ =0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">via_ircc_dma_receive_complete</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">iobase</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Move to next frame </p></td><td class="code"><div class="highlight"><pre>				<span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>		<span class="c1">// No ERR     </span>
		<span class="k">else</span> <span class="p">{</span>		<span class="c1">//ERR</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(): RxIRQ ERR:iRxIntType=%x,HostIntType=%x,CurCount=%x,RxLastCount=%x_____</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">iRxIntType</span><span class="p">,</span> <span class="n">iHostIntType</span><span class="p">,</span>
				   <span class="n">RxCurCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">),</span>
				   <span class="n">self</span><span class="o">-&gt;</span><span class="n">RxLastCount</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">//FIFO OverRun ERR</span>
				<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">//PHY,CRC ERR</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">iRxIntType</span> <span class="o">!=</span> <span class="mh">0x08</span><span class="p">)</span>
					<span class="n">hwreset</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>	<span class="c1">//F01</span>
			<span class="p">}</span>
			<span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		<span class="p">}</span>		<span class="c1">//ERR</span>

	<span class="p">}</span>			<span class="c1">//Rx Event</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">iHostIntType</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ResetChip</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">EnableDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnableTX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnableRX</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnTXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">RXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">TXStart</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">InitCard</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">CommonInit</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">SIRFilter</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">SetSIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">CRC16</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnTXCRC</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">SetBaudRate</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">9600</span><span class="p">);</span>
	<span class="n">SetPulseWidth</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">SetSendPreambleCount</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WriteReg</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">I_ST_CT_0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/* Restore speed. */</span>
	<span class="n">via_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_is_receiving (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Return TRUE is we are currently receiving a frame</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_is_receiving</span><span class="p">(</span><span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="n">FALSE</span><span class="p">;);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CkRxRecv</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(): status=%x....</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_net_open (dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Start the device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hwname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;);</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">via_ircc_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s, unable to allocate irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span>
			     <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Always allocate the DMA channel after the IRQ, and clean up on </span>
<span class="cm">	 * failure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s, unable to allocate dma=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">,</span>
			     <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma2</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IRDA_WARNING</span><span class="p">(</span><span class="s">&quot;%s, unable to allocate dma2=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">driver_name</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma2</span><span class="p">);</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="n">free_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/* turn on interrupts */</span>
	<span class="n">EnAllInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">ON</span><span class="p">);</span>
	<span class="n">EnInternalLoop</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnExternalLoop</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>

	<span class="cm">/* */</span>
	<span class="n">via_ircc_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

	<span class="cm">/* Ready to play! */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Open new IrLAP layer instance, now that everything should be</span>
<span class="cm">	 * initialized properly </span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">hwname</span><span class="p">,</span> <span class="s">&quot;VIA @ 0x%x&quot;</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="n">irlap_open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">hwname</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">RxLastCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_net_close (dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Stop the device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;);</span>

	<span class="cm">/* Stop device */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Stop and remove instance of IrLAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span>
		<span class="n">irlap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="n">EnTXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">EnRXDMA</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">DisableDmaChannel</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">EnAllInt</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">OFF</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma2</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">free_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function via_ircc_net_ioctl (dev, rq, cmd)</span>
<span class="cm"> *</span>
<span class="cm"> *    Process IOCTL commands for this device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">via_ircc_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via_ircc_cb</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s(), %s, (cmd=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		   <span class="n">cmd</span><span class="p">);</span>
	<span class="cm">/* Disable interrupts &amp; save flags */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSBANDWIDTH</span>:	<span class="cm">/* Set bandwidth */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">via_ircc_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_baudrate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSMEDIABUSY</span>:	<span class="cm">/* Set media busy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">irda_device_set_media_busy</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGRECEIVING</span>:	<span class="cm">/* Check if we are receiving right now */</span>
		<span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_receiving</span> <span class="o">=</span> <span class="n">via_ircc_is_receiving</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;VIA Technologies,inc&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VIA IrDA Device Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">via_ircc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">via_ircc_cleanup</span><span class="p">);</span>

</pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>F01       if(!(IsFIROn(iobase)))  via<em>ircc</em>dma_receive(self);</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
