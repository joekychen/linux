<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › irda › stir4200.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>stir4200.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************</span>
<span class="cm">*</span>
<span class="cm">* Filename:      stir4200.c</span>
<span class="cm">* Version:       0.4</span>
<span class="cm">* Description:   Irda SigmaTel USB Dongle</span>
<span class="cm">* Status:        Experimental</span>
<span class="cm">* Author:        Stephen Hemminger &lt;shemminger@osdl.org&gt;</span>
<span class="cm">*</span>
<span class="cm">*  	Based on earlier driver by Paul Stewart &lt;stewart@parc.com&gt;</span>
<span class="cm">*</span>
<span class="cm">*	Copyright (C) 2000, Roman Weissgaerber &lt;weissg@vienna.at&gt;</span>
<span class="cm">*	Copyright (C) 2001, Dag Brattli &lt;dag@brattli.net&gt;</span>
<span class="cm">*	Copyright (C) 2001, Jean Tourrilhes &lt;jt@hpl.hp.com&gt;</span>
<span class="cm">*	Copyright (C) 2004, Stephen Hemminger &lt;shemminger@osdl.org&gt;</span>
<span class="cm">*</span>
<span class="cm">*	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">*	it under the terms of the GNU General Public License as published by</span>
<span class="cm">*	the Free Software Foundation; either version 2 of the License.</span>
<span class="cm">*</span>
<span class="cm">*	This program is distributed in the hope that it will be useful,</span>
<span class="cm">*	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">*	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">*	GNU General Public License for more details.</span>
<span class="cm">*</span>
<span class="cm">*	You should have received a copy of the GNU General Public License</span>
<span class="cm">*	along with this program; if not, write to the Free Software</span>
<span class="cm">*	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*</span>
<span class="cm">*****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * This dongle does no framing, and requires polling to receive the</span>
<span class="cm"> * data.  The STIr4200 has bulk in and out endpoints just like</span>
<span class="cm"> * usr-irda devices, but the data it sends and receives is raw; like</span>
<span class="cm"> * irtty, it needs to call the wrap and unwrap functions to add and</span>
<span class="cm"> * remove SOF/BOF and escape characters to/from the frame.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda_device.h&gt;</span>
<span class="cp">#include &lt;net/irda/wrapper.h&gt;</span>
<span class="cp">#include &lt;net/irda/crc.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Stephen Hemminger &lt;shemminger@linux-foundation.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IrDA-USB Dongle Driver for SigmaTel STIr4200&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">qos_mtt_bits</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>	<span class="cm">/* 1 ms or more */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">qos_mtt_bits</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qos_mtt_bits</span><span class="p">,</span> <span class="s">&quot;Minimum Turn Time&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_sensitivity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* FIR 0..4, SIR 0..6 */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_sensitivity</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_sensitivity</span><span class="p">,</span> <span class="s">&quot;Set Receiver sensitivity (0-6, 0 is most sensitive)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 0 = highest ... 3 = lowest */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tx_power</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tx_power</span><span class="p">,</span> <span class="s">&quot;Set Transmitter power (0-3, 0 is highest power)&quot;</span><span class="p">);</span>

<span class="cp">#define STIR_IRDA_HEADER  	4</span>
<span class="cp">#define CTRL_TIMEOUT		100	   </span><span class="cm">/* milliseconds */</span><span class="cp"></span>
<span class="cp">#define TRANSMIT_TIMEOUT	200	   </span><span class="cm">/* milliseconds */</span><span class="cp"></span>
<span class="cp">#define STIR_FIFO_SIZE		4096</span>
<span class="cp">#define FIFO_REGS_SIZE		3</span>

<span class="k">enum</span> <span class="n">FirChars</span> <span class="p">{</span>
	<span class="n">FIR_CE</span>   <span class="o">=</span> <span class="mh">0x7d</span><span class="p">,</span>
	<span class="n">FIR_XBOF</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
	<span class="n">FIR_EOF</span>  <span class="o">=</span> <span class="mh">0x7e</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirRequests</span> <span class="p">{</span>
	<span class="n">REQ_WRITE_REG</span> <span class="o">=</span>		<span class="mh">0x00</span><span class="p">,</span>
	<span class="n">REQ_READ_REG</span> <span class="o">=</span>		<span class="mh">0x01</span><span class="p">,</span>
	<span class="n">REQ_READ_ROM</span> <span class="o">=</span>		<span class="mh">0x02</span><span class="p">,</span>
	<span class="n">REQ_WRITE_SINGLE</span> <span class="o">=</span>	<span class="mh">0x03</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Register offsets */</span>
<span class="k">enum</span> <span class="n">StirRegs</span> <span class="p">{</span>
	<span class="n">REG_RSVD</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
	<span class="n">REG_MODE</span><span class="p">,</span>
	<span class="n">REG_PDCLK</span><span class="p">,</span>
	<span class="n">REG_CTRL1</span><span class="p">,</span>
	<span class="n">REG_CTRL2</span><span class="p">,</span>
	<span class="n">REG_FIFOCTL</span><span class="p">,</span>
	<span class="n">REG_FIFOLSB</span><span class="p">,</span>
	<span class="n">REG_FIFOMSB</span><span class="p">,</span>
	<span class="n">REG_DPLL</span><span class="p">,</span>
	<span class="n">REG_IRDIG</span><span class="p">,</span>
	<span class="n">REG_TEST</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirModeMask</span> <span class="p">{</span>
	<span class="n">MODE_FIR</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">MODE_SIR</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">MODE_ASK</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">MODE_FASTRX</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">MODE_FFRSTEN</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">MODE_NRESET</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">MODE_2400</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirPdclkMask</span> <span class="p">{</span>
	<span class="n">PDCLK_4000000</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">PDCLK_115200</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
	<span class="n">PDCLK_57600</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>
	<span class="n">PDCLK_38400</span> <span class="o">=</span> <span class="mh">0x1D</span><span class="p">,</span>
	<span class="n">PDCLK_19200</span> <span class="o">=</span> <span class="mh">0x3B</span><span class="p">,</span>
	<span class="n">PDCLK_9600</span> <span class="o">=</span> <span class="mh">0x77</span><span class="p">,</span>
	<span class="n">PDCLK_2400</span> <span class="o">=</span> <span class="mh">0xDF</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirCtrl1Mask</span> <span class="p">{</span>
	<span class="n">CTRL1_SDMODE</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">CTRL1_RXSLOW</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">CTRL1_TXPWD</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">CTRL1_RXPWD</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">CTRL1_SRESET</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirCtrl2Mask</span> <span class="p">{</span>
	<span class="n">CTRL2_SPWIDTH</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">CTRL2_REVID</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirFifoCtlMask</span> <span class="p">{</span>
	<span class="n">FIFOCTL_DIR</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">FIFOCTL_CLR</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">FIFOCTL_EMPTY</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirDiagMask</span> <span class="p">{</span>
	<span class="n">IRDIG_RXHIGH</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">IRDIG_RXLOW</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">StirTestMask</span> <span class="p">{</span>
	<span class="n">TEST_PLLDOWN</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">TEST_LOOPIR</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">TEST_LOOPUSB</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">TEST_TSTENA</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">TEST_TSTOSC</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">stir_cb</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>      <span class="cm">/* init: probe_irda */</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>      <span class="cm">/* network layer */</span>
        <span class="k">struct</span> <span class="n">irlap_cb</span>   <span class="o">*</span><span class="n">irlap</span><span class="p">;</span>       <span class="cm">/* The link layer we are binded to */</span>

        <span class="k">struct</span> <span class="n">qos_info</span>   <span class="n">qos</span><span class="p">;</span>
	<span class="kt">unsigned</span> 	  <span class="n">speed</span><span class="p">;</span>	<span class="cm">/* Current speed */</span>

        <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>     <span class="cm">/* transmit thread */</span>

	<span class="k">struct</span> <span class="n">sk_buff</span>	  <span class="o">*</span><span class="n">tx_pending</span><span class="p">;</span>
	<span class="kt">void</span>		  <span class="o">*</span><span class="n">io_buf</span><span class="p">;</span>	<span class="cm">/* transmit/receive buffer */</span>
	<span class="n">__u8</span>		  <span class="o">*</span><span class="n">fifo_status</span><span class="p">;</span>

	<span class="n">iobuff_t</span>  	  <span class="n">rx_buff</span><span class="p">;</span>	<span class="cm">/* receive unwrap state machine */</span>
	<span class="k">struct</span> <span class="n">timeval</span>	  <span class="n">rx_time</span><span class="p">;</span>
	<span class="kt">int</span>		  <span class="n">receiving</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span>	 <span class="o">*</span><span class="n">rx_urb</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/* These are the currently known USB ids */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">dongles</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/* SigmaTel, Inc,  STIr4200 IrDA/USB Bridge */</span>
    <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x066f</span><span class="p">,</span> <span class="mh">0x4200</span><span class="p">)</span> <span class="p">},</span>
    <span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">dongles</span><span class="p">);</span>

<span class="cm">/* Send control message to set dongle register */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: write reg %d = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">REQ_WRITE_SINGLE</span><span class="p">,</span>
			       <span class="n">USB_DIR_OUT</span><span class="o">|</span><span class="n">USB_TYPE_VENDOR</span><span class="o">|</span><span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			       <span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">CTRL_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send control message to read multiple registers */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">reg</span><span class="p">,</span>
		    <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			       <span class="n">REQ_READ_REG</span><span class="p">,</span>
			       <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			       <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
			       <span class="n">CTRL_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">isfir</span><span class="p">(</span><span class="n">u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">speed</span> <span class="o">==</span> <span class="mi">4000000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare a FIR IrDA frame for transmission to the USB dongle.  The</span>
<span class="cm"> * FIR transmit frame is documented in the datasheet.  It consists of</span>
<span class="cm"> * a two byte 0x55 0xAA sequence, two little-endian length bytes, a</span>
<span class="cm"> * sequence of exactly 16 XBOF bytes of 0x7E, two BOF bytes of 0x7E,</span>
<span class="cm"> * then the data escaped as follows:</span>
<span class="cm"> *</span>
<span class="cm"> *    0x7D -&gt; 0x7D 0x5D</span>
<span class="cm"> *    0x7E -&gt; 0x7D 0x5E</span>
<span class="cm"> *    0x7F -&gt; 0x7D 0x5F</span>
<span class="cm"> *</span>
<span class="cm"> * Then, 4 bytes of little endian (stuffed) FCS follow, then two</span>
<span class="cm"> * trailing EOF bytes of 0x7E.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span> <span class="o">*</span><span class="nf">stuff_fir</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x7d</span>:
	<span class="k">case</span> <span class="mh">0x7e</span>:
	<span class="k">case</span> <span class="mh">0x7f</span>:
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x7d</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">^=</span> <span class="n">IRDA_TRANS</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Take raw data in skb and put it wrapped into buf */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">wrap_fir_skb</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">fcs</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">crc32_le</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="n">__u16</span> <span class="n">wraplen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Header */</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">STIR_IRDA_HEADER</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/* BOF */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span>  <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span>  <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>

	<span class="cm">/* Address / Control / Information */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">stuff_fir</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* FCS */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">stuff_fir</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">fcs</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">stuff_fir</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">fcs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">stuff_fir</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">fcs</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">stuff_fir</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">fcs</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* EOFs */</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x7e</span><span class="p">;</span>

	<span class="cm">/* Total length, minus the header */</span>
	<span class="n">wraplen</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="n">STIR_IRDA_HEADER</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">wraplen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wraplen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wraplen</span> <span class="o">+</span> <span class="n">STIR_IRDA_HEADER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">wrap_sir_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u16</span> <span class="n">wraplen</span><span class="p">;</span>

	<span class="n">wraplen</span> <span class="o">=</span> <span class="n">async_wrap_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">STIR_IRDA_HEADER</span><span class="p">,</span>
				 <span class="n">STIR_FIFO_SIZE</span> <span class="o">-</span> <span class="n">STIR_IRDA_HEADER</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">wraplen</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wraplen</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wraplen</span> <span class="o">+</span> <span class="n">STIR_IRDA_HEADER</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Frame is fully formed in the rx_buff so check crc</span>
<span class="cm"> * and pass up to irlap</span>
<span class="cm"> * setup for next receive</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fir_eof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iobuff_t</span> <span class="o">*</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">nskb</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">fcs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: short frame len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="o">++</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
		<span class="o">++</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fcs</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">crc32_le</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fcs</span> <span class="o">!=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;crc error calc 0x%x len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fcs</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if frame is short then just copy it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IRDA_RX_COPY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nskb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">nskb</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">++</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">nskb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">nskb</span><span class="p">;</span>
		<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">nskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Unwrap FIR stuffed data and bump it to IrLAP */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stir_fir_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span>
			    <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iobuff_t</span> <span class="o">*</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span>	<span class="n">byte</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OUTSIDE_FRAME</span>:
			<span class="cm">/* ignore garbage till start of frame */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">byte</span> <span class="o">!=</span> <span class="n">FIR_EOF</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Now receiving frame */</span>
			<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BEGIN_FRAME</span><span class="p">;</span>

			<span class="cm">/* Time to initialize receive buffer */</span>
			<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
			<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">LINK_ESCAPE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">==</span> <span class="n">FIR_EOF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: got EOF after escape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">frame_error</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">INSIDE_FRAME</span><span class="p">;</span>
			<span class="n">byte</span> <span class="o">^=</span> <span class="n">IRDA_TRANS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">BEGIN_FRAME</span>:
			<span class="cm">/* ignore multiple BOF/EOF */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">==</span> <span class="n">FIR_EOF</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">INSIDE_FRAME</span><span class="p">;</span>
			<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">in_frame</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>

			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">INSIDE_FRAME</span>:
			<span class="k">switch</span><span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FIR_CE</span>:
				<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">LINK_ESCAPE</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FIR_XBOF</span>:
				<span class="cm">/* 0x7f is not used in this framing */</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: got XBOF without escape</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">frame_error</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">FIR_EOF</span>:
				<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">;</span>
				<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">in_frame</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
				<span class="n">fir_eof</span><span class="p">(</span><span class="n">stir</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* add byte to rx buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: fir frame exceeds %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
			<span class="o">++</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error_recovery</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
		<span class="k">continue</span><span class="p">;</span>

	<span class="nl">frame_error:</span>
		<span class="o">++</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="p">;</span>

	<span class="nl">error_recovery:</span>
		<span class="o">++</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
		<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">;</span>
		<span class="n">rx_buff</span><span class="o">-&gt;</span><span class="n">in_frame</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Unwrap SIR stuffed data and bump it up to IrLAP */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stir_sir_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span>
			    <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">async_unwrap_char</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span> <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">unwrap_chars</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">bytes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isfir</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">))</span>
		<span class="n">stir_fir_chars</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">stir_sir_chars</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Mode parameters for each speed */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pdclk</span><span class="p">;</span>
<span class="p">}</span> <span class="n">stir_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="mi">2400</span><span class="p">,</span>    <span class="n">PDCLK_2400</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">9600</span><span class="p">,</span>    <span class="n">PDCLK_9600</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">19200</span><span class="p">,</span>   <span class="n">PDCLK_19200</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">38400</span><span class="p">,</span>   <span class="n">PDCLK_38400</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">57600</span><span class="p">,</span>   <span class="n">PDCLK_57600</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">115200</span><span class="p">,</span>  <span class="n">PDCLK_115200</span> <span class="p">},</span>
        <span class="p">{</span> <span class="mi">4000000</span><span class="p">,</span> <span class="n">PDCLK_4000000</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * Setup chip for speed.</span>
<span class="cm"> *  Called at startup to initialize the chip</span>
<span class="cm"> *  and on speed changes.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Write multiple registers doesn&#39;t appear to work</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stir_modes</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">stir_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid speed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

 <span class="nl">found:</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;speed change from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="cm">/* Reset modulator */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_CTRL1</span><span class="p">,</span> <span class="n">CTRL1_SRESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Undocumented magic to tweak the DPLL */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_DPLL</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Set clock */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_PDCLK</span><span class="p">,</span> <span class="n">stir_modes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pdclk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">MODE_NRESET</span> <span class="o">|</span> <span class="n">MODE_FASTRX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isfir</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">MODE_FIR</span> <span class="o">|</span> <span class="n">MODE_FFRSTEN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">MODE_SIR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">2400</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">MODE_2400</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* This resets TEMIC style transceiver if any. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_CTRL1</span><span class="p">,</span>
			<span class="n">CTRL1_SDMODE</span> <span class="o">|</span> <span class="p">(</span><span class="n">tx_power</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_CTRL1</span><span class="p">,</span> <span class="p">(</span><span class="n">tx_power</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Reset sensitivity */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_CTRL2</span><span class="p">,</span> <span class="p">(</span><span class="n">rx_sensitivity</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called from net/core when new frame is available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">stir_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* the IRDA wrapping routines don&#39;t deal with non linear skb */</span>
	<span class="n">SKB_LINEAR_ASSERT</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
        <span class="n">wake_up_process</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	
	<span class="cm">/* this should never happen unless stop/wakeup problem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the transmit FIFO to have space for next data</span>
<span class="cm"> *</span>
<span class="cm"> * If space &lt; 0 then wait till FIFO completely drains.</span>
<span class="cm"> * FYI: can take up to 13 seconds at 2400baud.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fifo_txwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prev_count</span> <span class="o">=</span> <span class="mh">0x1fff</span><span class="p">;</span>

	<span class="cm">/* Read FIFO status and count */</span>
	<span class="k">for</span> <span class="p">(;;</span> <span class="n">prev_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_FIFOCTL</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">,</span> 
				   <span class="n">FIFO_REGS_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">FIFO_REGS_SIZE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;FIFO register read error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> 
			<span class="o">|</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;fifo status 0x%lx count %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

		<span class="cm">/* is fifo receiving already, or empty */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_DIR</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FIFOCTL_EMPTY</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

		<span class="cm">/* shutting down? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">;</span>

		<span class="cm">/* only waiting for some space */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">STIR_FIFO_SIZE</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">&gt;</span> <span class="n">space</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* queue confused */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prev_count</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* estimate transfer time for remaining chars */</span>
		<span class="n">msleep</span><span class="p">((</span><span class="n">count</span> <span class="o">*</span> <span class="mi">8000</span><span class="p">)</span> <span class="o">/</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
	<span class="p">}</span>
			
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_FIFOCTL</span><span class="p">,</span> <span class="n">FIFOCTL_CLR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_FIFOCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Wait for turnaround delay before starting transmit.  */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">turnaround_delay</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span> <span class="kt">long</span> <span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">ticks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">us</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">us</span> <span class="o">-=</span> <span class="n">USEC_PER_SEC</span><span class="p">;</span>
	<span class="n">us</span> <span class="o">-=</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_time</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">us</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ticks</span> <span class="o">=</span> <span class="n">us</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ticks</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">us</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start receiver by submitting a request to the receive pipe.</span>
<span class="cm"> * If nothing is available it will return after rx_interval.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">receive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* reset state */</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">in_frame</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">;</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Stop all pending receive Urb&#39;s */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">receive_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">in_frame</span><span class="p">)</span> 
		<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Wrap data in socket buffer and send it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stir_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">wraplen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if receiving, need to turnaround */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">receive_stop</span><span class="p">(</span><span class="n">stir</span><span class="p">);</span>
		<span class="n">turnaround_delay</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">irda_get_mtt</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">first_frame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isfir</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">))</span>
		<span class="n">wraplen</span> <span class="o">=</span> <span class="n">wrap_fir_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wraplen</span> <span class="o">=</span> <span class="n">wrap_sir_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span><span class="p">);</span>
		
	<span class="cm">/* check for space available in fifo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_frame</span><span class="p">)</span>
		<span class="n">fifo_txwait</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">wraplen</span><span class="p">);</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;send %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">wraplen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			 <span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span><span class="p">,</span> <span class="n">wraplen</span><span class="p">,</span>
			 <span class="nb">NULL</span><span class="p">,</span> <span class="n">TRANSMIT_TIMEOUT</span><span class="p">))</span>
		<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transmit state machine thread</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stir_transmit_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PM</span>
		<span class="cm">/* if suspending, then power off and wait */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">freezing</span><span class="p">(</span><span class="n">current</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span><span class="p">)</span>
				<span class="n">receive_stop</span><span class="p">(</span><span class="n">stir</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">fifo_txwait</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">write_reg</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">REG_CTRL1</span><span class="p">,</span> <span class="n">CTRL1_TXPWD</span><span class="o">|</span><span class="n">CTRL1_RXPWD</span><span class="p">);</span>

			<span class="n">try_to_freeze</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">change_speed</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="cm">/* if something to send? */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">new_speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">stir_send</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">new_speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">new_speed</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fifo_txwait</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">change_speed</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">new_speed</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* nothing to send? start receiving */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span> <span class="o">&amp;&amp;</span>
		    <span class="n">irda_device_txqueue_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Wait otherwise chip gets confused. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fifo_txwait</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">receive_start</span><span class="p">(</span><span class="n">stir</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
					<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						 <span class="s">&quot;%s: receive usb submit failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* sleep if nothing to send */</span>
                <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
                <span class="n">schedule</span><span class="p">();</span>

	<span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * USB bulk receive completion callback.</span>
<span class="cm"> * Wakes up every ms (usb round trip) with wrapped </span>
<span class="cm"> * data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stir_rcv_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* in process of stopping, just drop data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* unlink, shutdown, unplug, other nasties */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> 
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;receive %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="n">unwrap_chars</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
			     <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_time</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* kernel thread is stopping receiver don&#39;t resubmit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* resubmit existing urb */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="cm">/* in case of error, the kernel thread will restart us */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb receive submit error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">err</span><span class="p">);</span>
		<span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up_process</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function stir_net_open (dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Network device is taken up. Usually this is done by &quot;ifconfig irda0 up&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stir_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hwname</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">change_speed</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="mi">9600</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Initialize for SIR/FIR to copy data directly into skb.  */</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="n">IRDA_SKB_MAX_MTU</span><span class="p">;</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">IRDA_SKB_MAX_MTU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">skb</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_time</span><span class="p">);</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">STIR_FIFO_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out3</span><span class="p">;</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span>
			  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			  <span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span><span class="p">,</span> <span class="n">STIR_FIFO_SIZE</span><span class="p">,</span>
			  <span class="n">stir_rcv_irq</span><span class="p">,</span> <span class="n">stir</span><span class="p">);</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">FIFO_REGS_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> 
		<span class="k">goto</span> <span class="n">err_out4</span><span class="p">;</span>
		
	<span class="cm">/*</span>
<span class="cm">	 * Now that everything should be initialized properly,</span>
<span class="cm">	 * Open new IrLAP layer instance to take care of us...</span>
<span class="cm">	 * Note : will send immediately a speed change...</span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">hwname</span><span class="p">,</span> <span class="s">&quot;usb#%d&quot;</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">);</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="n">irlap_open</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">hwname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irlap_open failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/** Start kernel thread for transmit.  */</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">stir_transmit_thread</span><span class="p">,</span> <span class="n">stir</span><span class="p">,</span>
				   <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to start kernel thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_out6:</span>
	<span class="n">irlap_close</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
 <span class="nl">err_out5:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">);</span>
 <span class="nl">err_out4:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span><span class="p">);</span>
 <span class="nl">err_out3:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
 <span class="nl">err_out2:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">skb</span><span class="p">);</span>
 <span class="nl">err_out1:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function stir_net_close (stir)</span>
<span class="cm"> *</span>
<span class="cm"> *    Network device is taken down. Usually this is done by</span>
<span class="cm"> *    &quot;ifconfig irda0 down&quot;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stir_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Stop transmit processing */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Kill transmit thread */</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">);</span>

	<span class="cm">/* Mop up receive urb&#39;s */</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	
	<span class="n">kfree</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">io_buf</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Stop and remove instance of IrLAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span>
		<span class="n">irlap_close</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>

	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IOCTLs : Extra out-of-band network commands...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stir_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSBANDWIDTH</span>: <span class="cm">/* Set bandwidth */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="cm">/* Check if the device is still there */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">change_speed</span><span class="p">(</span><span class="n">stir</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_baudrate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSMEDIABUSY</span>: <span class="cm">/* Set media busy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="cm">/* Check if the IrDA stack is still there */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
			<span class="n">irda_device_set_media_busy</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGRECEIVING</span>:
		<span class="cm">/* Only approximately true */</span>
		<span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_receiving</span> <span class="o">=</span> <span class="n">stir</span><span class="o">-&gt;</span><span class="n">receiving</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">stir_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">stir_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">stir_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">stir_hard_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">stir_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This routine is called by the USB subsystem for each new device</span>
<span class="cm"> * in the system. We need to check if the device is ours, and in</span>
<span class="cm"> * this case start handling it.</span>
<span class="cm"> * Note : it might be worth protecting this function by a global</span>
<span class="cm"> * spinlock... Or not, because maybe USB already deal with that...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stir_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Allocate network device container. */</span>
	<span class="n">net</span> <span class="o">=</span> <span class="n">alloc_irdadev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stir</span><span class="p">));</span>
	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">net</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">stir</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">net</span><span class="p">;</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_reset_configuration</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usb reset configuration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SigmaTel STIr4200 IRDA/USB found at address %d, &quot;</span>
		<span class="s">&quot;Vendor: %x, Product: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
	       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="cm">/* Initialize QoS for this device */</span>
	<span class="n">irda_init_max_qos_capabilies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="cm">/* That&#39;s the Rx capability. */</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span>       <span class="o">&amp;=</span> <span class="n">IR_2400</span> <span class="o">|</span> <span class="n">IR_9600</span> <span class="o">|</span> <span class="n">IR_19200</span> <span class="o">|</span>
					 <span class="n">IR_38400</span> <span class="o">|</span> <span class="n">IR_57600</span> <span class="o">|</span> <span class="n">IR_115200</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">IR_4000000</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">stir</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">min_turn_time</span><span class="p">.</span><span class="n">bits</span>   <span class="o">&amp;=</span> <span class="n">qos_mtt_bits</span><span class="p">;</span>
	<span class="n">irda_qos_bits_to_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="cm">/* Override the network functions we need to use */</span>
	<span class="n">net</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stir_netdev_ops</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IrDA: Registered SigmaTel device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">net</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">stir</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out2:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>
<span class="nl">err_out1:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The current device is removed, the USB layer tell us to shut it down...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stir_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/* USB suspend, so power off the transmitter/receiver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stir_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Coming out of suspend, so reset hardware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stir_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stir_cb</span> <span class="o">*</span><span class="n">stir</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">stir</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* receiver restarted when send thread wakes up */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * USB device callbacks</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">irda_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;stir4200&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">stir_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">stir_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">dongles</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">stir_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">stir_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">irda_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
