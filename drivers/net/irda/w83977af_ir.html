<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › irda › w83977af_ir.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>w83977af_ir.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*********************************************************************</span>
<span class="cm"> *                </span>
<span class="cm"> * Filename:      w83977af_ir.c</span>
<span class="cm"> * Version:       1.0</span>
<span class="cm"> * Description:   FIR driver for the Winbond W83977AF Super I/O chip</span>
<span class="cm"> * Status:        Experimental.</span>
<span class="cm"> * Author:        Paul VanderSpek</span>
<span class="cm"> * Created at:    Wed Nov  4 11:46:16 1998</span>
<span class="cm"> * Modified at:   Fri Jan 28 12:10:59 2000</span>
<span class="cm"> * Modified by:   Dag Brattli &lt;dagb@cs.uit.no&gt;</span>
<span class="cm"> * </span>
<span class="cm"> *     Copyright (c) 1998-2000 Dag Brattli &lt;dagb@cs.uit.no&gt;</span>
<span class="cm"> *     Copyright (c) 1998-1999 Rebel.com</span>
<span class="cm"> *      </span>
<span class="cm"> *     This program is free software; you can redistribute it and/or </span>
<span class="cm"> *     modify it under the terms of the GNU General Public License as </span>
<span class="cm"> *     published by the Free Software Foundation; either version 2 of </span>
<span class="cm"> *     the License, or (at your option) any later version.</span>
<span class="cm"> *  </span>
<span class="cm"> *     Neither Paul VanderSpek nor Rebel.com admit liability nor provide</span>
<span class="cm"> *     warranty for any of this software. This material is provided &quot;AS-IS&quot;</span>
<span class="cm"> *     and at no charge.</span>
<span class="cm"> *     </span>
<span class="cm"> *     If you find bugs in this file, its very likely that the same bug</span>
<span class="cm"> *     will also be in pc87108.c since the implementations are quite</span>
<span class="cm"> *     similar.</span>
<span class="cm"> *</span>
<span class="cm"> *     Notice that all functions that needs to access the chip in _any_</span>
<span class="cm"> *     way, must save BSR register on entry, and restore it on exit. </span>
<span class="cm"> *     It is _very_ important to follow this policy!</span>
<span class="cm"> *</span>
<span class="cm"> *         __u8 bank;</span>
<span class="cm"> *     </span>
<span class="cm"> *         bank = inb( iobase+BSR);</span>
<span class="cm"> *  </span>
<span class="cm"> *         do_your_stuff_here();</span>
<span class="cm"> *</span>
<span class="cm"> *         outb( bank, iobase+BSR);</span>
<span class="cm"> *</span>
<span class="cm"> ********************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;net/irda/irda.h&gt;</span>
<span class="cp">#include &lt;net/irda/wrapper.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda_device.h&gt;</span>
<span class="cp">#include &quot;w83977af.h&quot;</span>
<span class="cp">#include &quot;w83977af_ir.h&quot;</span>

<span class="cp">#ifdef  CONFIG_ARCH_NETWINDER            </span><span class="cm">/* Adjust to NetWinder differences */</span><span class="cp"></span>
<span class="cp">#undef  CONFIG_NETWINDER_TX_DMA_PROBLEMS </span><span class="cm">/* Not needed */</span><span class="cp"></span>
<span class="cp">#define CONFIG_NETWINDER_RX_DMA_PROBLEMS </span><span class="cm">/* Must have this one! */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#define CONFIG_USE_W977_PNP        </span><span class="cm">/* Currently needed */</span><span class="cp"></span>
<span class="cp">#define PIO_MAX_SPEED       115200 </span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">driver_name</span> <span class="o">=</span> <span class="s">&quot;w83977af_ir&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">qos_mtt_bits</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>   <span class="cm">/* 1 ms or more */</span>

<span class="cp">#define CHIP_IO_EXTENT 8</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x180</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span> <span class="p">};</span>
<span class="cp">#ifdef CONFIG_ARCH_NETWINDER             </span><span class="cm">/* Adjust to NetWinder differences */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">efbase</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">W977_EFIO_BASE</span><span class="p">,</span> <span class="n">W977_EFIO2_BASE</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">efio</span> <span class="o">=</span> <span class="n">W977_EFIO_BASE</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">dev_self</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>

<span class="cm">/* Some prototypes */</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> 
                          <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_dma_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span> 
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_dma_receive_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span>  <span class="n">w83977af_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_pio_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo_size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">w83977af_dma_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">w83977af_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">speed</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_is_receiving</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">w83977af_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_init ()</span>
<span class="cm"> *</span>
<span class="cm"> *    Initialize chip. Just try to find out how many chips we are dealing with</span>
<span class="cm"> *    and where they are</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">w83977af_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_self</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w83977af_open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_cleanup ()</span>
<span class="cm"> *</span>
<span class="cm"> *    Close all configured chips</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">w83977af_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_self</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_self</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">w83977af_close</span><span class="p">(</span><span class="n">dev_self</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">w83977_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">w83977af_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">w83977af_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">w83977af_hard_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">w83977af_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_open (iobase, irq)</span>
<span class="cm"> *</span>
<span class="cm"> *    Open driver instance</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="cm">/* Lock the port that we need */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">CHIP_IO_EXTENT</span><span class="p">,</span> <span class="n">driver_name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), can&#39;t get iobase of 0x%03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">__func__</span> <span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w83977af_probe</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Allocate new instance of the driver</span>
<span class="cm">	 */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_irdadev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span> <span class="n">KERN_ERR</span> <span class="s">&quot;IrDA: Can&#39;t allocate memory for &quot;</span>
			<span class="s">&quot;IrDA control block!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
   

	<span class="cm">/* Initialize IO */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span>   <span class="o">=</span> <span class="n">iobase</span><span class="p">;</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span>       <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span>   <span class="o">=</span> <span class="n">CHIP_IO_EXTENT</span><span class="p">;</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span>       <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
        <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/* Initialize QoS for this device */</span>
	<span class="n">irda_init_max_qos_capabilies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
	
	<span class="cm">/* The only value we must override it the baudrate */</span>

	<span class="cm">/* FIXME: The HP HDLS-1100 does not support 1152000! */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">IR_9600</span><span class="o">|</span><span class="n">IR_19200</span><span class="o">|</span><span class="n">IR_38400</span><span class="o">|</span><span class="n">IR_57600</span><span class="o">|</span>
		<span class="n">IR_115200</span><span class="o">|</span><span class="n">IR_576000</span><span class="o">|</span><span class="n">IR_1152000</span><span class="o">|</span><span class="p">(</span><span class="n">IR_4000000</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* The HP HDLS-1100 needs 1 ms according to the specs */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">min_turn_time</span><span class="p">.</span><span class="n">bits</span> <span class="o">=</span> <span class="n">qos_mtt_bits</span><span class="p">;</span>
	<span class="n">irda_qos_bits_to_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
	
	<span class="cm">/* Max DMA buffer size needed = (data_size + 6) * (window_size) + 6; */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="mi">14384</span><span class="p">;</span> 
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
	
	<span class="cm">/* Allocate memory if needed */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>
	
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">in_frame</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">w83977_netdev_ops</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_ERROR</span><span class="p">(</span><span class="s">&quot;%s(), register_netdevice() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;IrDA: Registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Need to store self somewhere */</span>
	<span class="n">dev_self</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_out3:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
			  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">);</span>
<span class="nl">err_out2:</span>	
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
			  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">);</span>
<span class="nl">err_out1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">CHIP_IO_EXTENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_close (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Close driver instance</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

        <span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_USE_W977_PNP</span>
	<span class="cm">/* enter PnP configuration mode */</span>
	<span class="n">w977_efm_enter</span><span class="p">(</span><span class="n">efio</span><span class="p">);</span>

	<span class="n">w977_select_device</span><span class="p">(</span><span class="n">W977_DEVICE_IR</span><span class="p">,</span> <span class="n">efio</span><span class="p">);</span>

	<span class="cm">/* Deactivate device */</span>
	<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">efio</span><span class="p">);</span>

	<span class="n">w977_efm_exit</span><span class="p">(</span><span class="n">efio</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_USE_W977_PNP */</span><span class="cp"></span>

	<span class="cm">/* Remove netdevice */</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="cm">/* Release the PORT that this driver is using */</span>
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span> <span class="p">,</span> <span class="s">&quot;%s(), Releasing Region %03x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	      <span class="n">__func__</span> <span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_ext</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				  <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
				  <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
  	<span class="kt">int</span> <span class="n">version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  	
 	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
<span class="cp">#ifdef CONFIG_USE_W977_PNP</span>
 		<span class="cm">/* Enter PnP configuration mode */</span>
		<span class="n">w977_efm_enter</span><span class="p">(</span><span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  
 		<span class="n">w977_select_device</span><span class="p">(</span><span class="n">W977_DEVICE_IR</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  
 		<span class="cm">/* Configure PnP port, IRQ, and DMA channel */</span>
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="p">(</span><span class="n">iobase</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x61</span><span class="p">,</span> <span class="p">(</span><span class="n">iobase</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x70</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#ifdef CONFIG_ARCH_NETWINDER</span>
		<span class="cm">/* Netwinder uses 1 higher than Linux */</span>
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">dma</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#else</span>
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x74</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>   
<span class="cp">#endif </span><span class="cm">/*CONFIG_ARCH_NETWINDER */</span><span class="cp"></span>
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>  <span class="cm">/* Disable Tx DMA */</span>
  	
 		<span class="cm">/* Set append hardware CRC, enable IR bank selection */</span>	
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0xf0</span><span class="p">,</span> <span class="n">APEDCRC</span><span class="o">|</span><span class="n">ENBNKSEL</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  
 		<span class="cm">/* Activate device */</span>
 		<span class="n">w977_write_reg</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  
 		<span class="n">w977_efm_exit</span><span class="p">(</span><span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_USE_W977_PNP */</span><span class="cp"></span>
  		<span class="cm">/* Disable Advanced mode */</span>
  		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
  		<span class="n">outb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  
 
 		<span class="cm">/* Turn on UART (global) interrupts */</span>
 		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
  		<span class="n">outb</span><span class="p">(</span><span class="n">HCR_EN_IRQ</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
  	
  		<span class="cm">/* Switch to advanced mode */</span>
  		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
  		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">ADCR1</span><span class="p">)</span> <span class="o">|</span> <span class="n">ADCR1_ADV_SL</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ADCR1</span><span class="p">);</span>
  
  		<span class="cm">/* Set default IR-mode */</span>
  		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
  		<span class="n">outb</span><span class="p">(</span><span class="n">HCR_SIR</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
  
  		<span class="cm">/* Read the Advanced IR ID */</span>
  		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET3</span><span class="p">);</span>
  		<span class="n">version</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">AUID</span><span class="p">);</span>
  	
  		<span class="cm">/* Should be 0x1? */</span>
  		<span class="k">if</span> <span class="p">(</span><span class="mh">0x10</span> <span class="o">==</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">))</span> <span class="p">{</span>
 			<span class="n">efio</span> <span class="o">=</span> <span class="n">efbase</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
 
 			<span class="cm">/* Set FIFO size to 32 */</span>
 			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
 			<span class="n">outb</span><span class="p">(</span><span class="n">ADCR2_RXFS32</span><span class="o">|</span><span class="n">ADCR2_TXFS32</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ADCR2</span><span class="p">);</span>	
 	
 			<span class="cm">/* Set FIFO threshold to TX17, RX16 */</span>
 			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>	
 			<span class="n">outb</span><span class="p">(</span><span class="n">UFR_RXTL</span><span class="o">|</span><span class="n">UFR_TXTL</span><span class="o">|</span><span class="n">UFR_TXF_RST</span><span class="o">|</span><span class="n">UFR_RXF_RST</span><span class="o">|</span>
			     <span class="n">UFR_EN_FIFO</span><span class="p">,</span><span class="n">iobase</span><span class="o">+</span><span class="n">UFR</span><span class="p">);</span>
 
 			<span class="cm">/* Receiver frame length */</span>
 			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET4</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">2048</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="mi">6</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">((</span><span class="mi">2048</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="mi">7</span><span class="p">);</span>

			<span class="cm">/* </span>
<span class="cm">			 * Init HP HSDL-1100 transceiver. </span>
<span class="cm">			 * </span>
<span class="cm">			 * Set IRX_MSL since we have 2 * receive paths IRRX, </span>
<span class="cm">			 * and IRRXH. Clear IRSL0D since we want IRSL0 * to </span>
<span class="cm">			 * be a input pin used for IRRXH </span>
<span class="cm">			 *</span>
<span class="cm">			 *   IRRX  pin 37 connected to receiver </span>
<span class="cm">			 *   IRTX  pin 38 connected to transmitter</span>
<span class="cm">			 *   FIRRX pin 39 connected to receiver      (IRSL0) </span>
<span class="cm">			 *   CIRRX pin 40 connected to pin 37</span>
<span class="cm">			 */</span>
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET7</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="mi">7</span><span class="p">);</span>
			
			<span class="n">IRDA_MESSAGE</span><span class="p">(</span><span class="s">&quot;W83977AF (IR) driver loaded. &quot;</span>
				     <span class="s">&quot;Version: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
			
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Try next extented function register address */</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), Wrong chip version&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="p">}</span>
  	<span class="p">}</span>   	
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w83977af_change_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ir_mode</span> <span class="o">=</span> <span class="n">HCR_SIR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span> 
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Update accounting for new speed */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="cm">/* Save current bank */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>

	<span class="cm">/* Select Set 2 */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ABHL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">speed</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">9600</span>:   <span class="n">outb</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ABLL</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">19200</span>:  <span class="n">outb</span><span class="p">(</span><span class="mh">0x06</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ABLL</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">38400</span>:  <span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ABLL</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">57600</span>:  <span class="n">outb</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ABLL</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">115200</span>: <span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ABLL</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">576000</span>:
		<span class="n">ir_mode</span> <span class="o">=</span> <span class="n">HCR_MIR_576</span><span class="p">;</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), handling baud of 576000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1152000</span>:
		<span class="n">ir_mode</span> <span class="o">=</span> <span class="n">HCR_MIR_1152</span><span class="p">;</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), handling baud of 1152000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4000000</span>:
		<span class="n">ir_mode</span> <span class="o">=</span> <span class="n">HCR_FIR</span><span class="p">;</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), handling baud of 4000000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ir_mode</span> <span class="o">=</span> <span class="n">HCR_FIR</span><span class="p">;</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), unknown baud rate of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set speed mode */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ir_mode</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>

	<span class="cm">/* set FIFO size to 32 */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ADCR2_RXFS32</span><span class="o">|</span><span class="n">ADCR2_TXFS32</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ADCR2</span><span class="p">);</span>	
	
	<span class="cm">/* set FIFO threshold to TX17, RX16 */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UFR</span><span class="p">);</span>        <span class="cm">/* Reset */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">UFR_EN_FIFO</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UFR</span><span class="p">);</span> <span class="cm">/* First we must enable FIFO */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xa7</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UFR</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
		
	<span class="cm">/* Enable some interrupts so we can receive frames */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">PIO_MAX_SPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ICR_EFSFI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>
		<span class="n">w83977af_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ICR_ERBRI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>
    	
	<span class="cm">/* Restore SSR */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_hard_xmit (skb, dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Sets up a DMA transfer to send the current frame.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">w83977af_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mtt</span><span class="p">;</span>
	
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(%ld), skb-&gt;len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	
	<span class="cm">/* Lock transmit buffer */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="cm">/* Check if we need to change the speed */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Check for empty frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w83977af_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span> 
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save current set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
	
	<span class="cm">/* Decide if we should use PIO or DMA transfer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">PIO_MAX_SPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		
		<span class="n">mtt</span> <span class="o">=</span> <span class="n">irda_get_mtt</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(%ld), mtt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">jiffies</span><span class="p">,</span> <span class="n">mtt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtt</span><span class="p">)</span>
				<span class="n">udelay</span><span class="p">(</span><span class="n">mtt</span><span class="p">);</span>

			<span class="cm">/* Enable DMA interrupt */</span>
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	 		<span class="n">outb</span><span class="p">(</span><span class="n">ICR_EDMAI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>
	     		<span class="n">w83977af_dma_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">async_wrap_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> 
						   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>
		
		<span class="cm">/* Add interrupt on tx low level (will fire immediately) */</span>
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">ICR_ETXTHI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Restore set register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_dma_write (self, iobase)</span>
<span class="cm"> *</span>
<span class="cm"> *    Send frame using DMA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w83977af_dma_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_NETWINDER_TX_DMA_PROBLEMS</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">hcr</span><span class="p">;</span>
<span class="cp">#endif</span>
        <span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Save current set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="cm">/* Disable DMA */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCR_EN_DMA</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>

	<span class="cm">/* Choose transmit DMA channel  */</span> 
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ADCR1_D_CHSW</span><span class="o">|</span><span class="cm">/*ADCR1_DMA_F|*/</span><span class="n">ADCR1_ADV_SL</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ADCR1</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NETWINDER_TX_DMA_PROBLEMS</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">disable_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">irda_setup_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff_dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">,</span>
		       <span class="n">DMA_MODE_WRITE</span><span class="p">);</span>	
<span class="cp">#endif</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_XMIT</span><span class="p">;</span>
	
	<span class="cm">/* Enable DMA */</span>
 	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NETWINDER_TX_DMA_PROBLEMS</span>
	<span class="n">hcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">hcr</span> <span class="o">|</span> <span class="n">HCR_EN_DMA</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#else	</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">HCR_EN_DMA</span> <span class="o">|</span> <span class="n">HCR_TX_WT</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Restore set register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_pio_write (iobase, buf, len, fifo_size)</span>
<span class="cm"> *</span>
<span class="cm"> *    </span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_pio_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="cm">/* Save current bank */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb_p</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">USR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USR_TSRE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>
			   <span class="s">&quot;%s(), warning, FIFO not empty yet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span>  <span class="p">);</span>

		<span class="n">fifo_size</span> <span class="o">-=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), %d bytes left in tx fifo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			   <span class="n">__func__</span> <span class="p">,</span> <span class="n">fifo_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Fill FIFO with current frame */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">fifo_size</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">actual</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Transmit next byte */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">actual</span><span class="o">++</span><span class="p">],</span> <span class="n">iobase</span><span class="o">+</span><span class="n">TBR</span><span class="p">);</span>
	<span class="p">}</span>
        
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), fifo_size %d ; %d sent of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		   <span class="n">__func__</span> <span class="p">,</span> <span class="n">fifo_size</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Restore bank */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">actual</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_dma_xmit_complete (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    The transfer of a frame in finished. So do the necessary things</span>
<span class="cm"> *</span>
<span class="cm"> *    </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w83977af_dma_xmit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Save current set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="cm">/* Disable DMA */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCR_EN_DMA</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
	
	<span class="cm">/* Check for underrun! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">AUDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AUDR_UNDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s(), Transmit underrun!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
		
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Clear bit, by writing 1 to it */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">AUDR_UNDR</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">AUDR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

	
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w83977af_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Unlock tx_buff and request another frame */</span>
	<span class="cm">/* Tell the network layer, that we want more frames */</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	
	<span class="cm">/* Restore set */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_dma_receive (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Get ready for receiving a frame. The device will initiate a DMA</span>
<span class="cm"> *    if it starts to receive a frame.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_dma_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_NETWINDER_RX_DMA_PROBLEMS</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">hcr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="n">iobase</span><span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Save current set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="cm">/* Disable DMA */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HCR_EN_DMA</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>

	<span class="cm">/* Choose DMA Rx, DMA Fairness, and Advanced mode */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">ADCR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ADCR1_D_CHSW</span><span class="p">)</span><span class="cm">/*|ADCR1_DMA_F*/</span><span class="o">|</span><span class="n">ADCR1_ADV_SL</span><span class="p">,</span>
	     <span class="n">iobase</span><span class="o">+</span><span class="n">ADCR1</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_RECV</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_NETWINDER_RX_DMA_PROBLEMS</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">disable_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">irda_setup_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff_dma</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">,</span>
		       <span class="n">DMA_MODE_READ</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* </span>
<span class="cm">	 * Reset Rx FIFO. This will also flush the ST_FIFO, it&#39;s very </span>
<span class="cm">	 * important that we don&#39;t reset the Tx FIFO since it might not</span>
<span class="cm">	 * be finished transmitting yet</span>
<span class="cm">	 */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">UFR_RXTL</span><span class="o">|</span><span class="n">UFR_TXTL</span><span class="o">|</span><span class="n">UFR_RXF_RST</span><span class="o">|</span><span class="n">UFR_EN_FIFO</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">UFR</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="cm">/* Enable DMA */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_NETWINDER_RX_DMA_PROBLEMS</span>
	<span class="n">hcr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">hcr</span> <span class="o">|</span> <span class="n">HCR_EN_DMA</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#else	</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">HCR_EN_DMA</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">HCR</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Restore set */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_receive_complete (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Finished with receiving a frame</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_dma_receive_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_fifo</span> <span class="o">*</span><span class="n">st_fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="n">st_fifo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">st_fifo</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Save current set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Read status FIFO */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET5</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">FS_FO</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">FS_FO_FSFDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">len</span>  <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">RFLFL</span><span class="p">);</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">].</span><span class="n">len</span> <span class="o">|=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">RFLFH</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">++</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get first entry */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
		<span class="n">len</span>    <span class="o">=</span> <span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span><span class="p">;</span>
		<span class="n">st_fifo</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>

		<span class="cm">/* Check for errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FS_FO_ERR_MSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FS_FO_LST_FR</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Add number of lost frames to stats */</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Skip frame */</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
				
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FS_FO_MX_LEX</span><span class="p">)</span>
					<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
				
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FS_FO_PHY_ERR</span><span class="p">)</span> 
					<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
				
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FS_FO_CRC_ERR</span><span class="p">)</span> 
					<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* The errors below can be reported in both cases */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FS_FO_RX_OV</span><span class="p">)</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">FS_FO_FSF_OV</span><span class="p">)</span>
				<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Check if we have transferred all data to memory */</span>
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">USR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USR_RDR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">80</span><span class="p">);</span> <span class="cm">/* Should be enough!? */</span>
			<span class="p">}</span>
						
			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				       <span class="s">&quot;%s(), memory squeeze, dropping frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
				<span class="cm">/* Restore set register */</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

				<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="cm">/*  Align to 20 bytes */</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> 
			
			<span class="cm">/* Copy frame without CRC */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">4000000</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
							<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
							<span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
				<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
							<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
							<span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Move to next frame */</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
			<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IRDA</span><span class="p">);</span>
			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Restore set register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function pc87108_pio_receive (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Receive all data in receiver FIFO</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w83977af_pio_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">byte</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span><span class="p">;);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	
	<span class="cm">/*  Receive all characters in Rx FIFO */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">byte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">RBR</span><span class="p">);</span>
		<span class="n">async_unwrap_char</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span>
				  <span class="n">byte</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">USR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">USR_RDR</span><span class="p">);</span> <span class="cm">/* Data available */</span>	
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_sir_interrupt (self, eir)</span>
<span class="cm"> *</span>
<span class="cm"> *    Handle SIR interrupt</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__u8</span> <span class="nf">w83977af_sir_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">new_icr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;%s(), isr=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="cm">/* Transmit FIFO low on data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_TXTH_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write data left in transmit buffer */</span>
		<span class="n">actual</span> <span class="o">=</span> <span class="n">w83977af_pio_write</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">,</span> 
					    <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> 
					    <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> 
					    <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fifo_size</span><span class="p">);</span>

		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span>  <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
		
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_XMIT</span><span class="p">;</span>

		<span class="cm">/* Check if finished */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_ETXTHI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">AUDR_SFEND</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">AUDR</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span> 

			<span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Feed me more packets */</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
			<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_ETBREI</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Check if transmission has completed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_TXEMP_I</span><span class="p">)</span> <span class="p">{</span>		
		<span class="cm">/* Check if we need to change the speed? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				   <span class="s">&quot;%s(), Changing speed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
			<span class="n">w83977af_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span><span class="p">);</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">new_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Turn around and get ready to receive some data */</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">IO_RECV</span><span class="p">;</span>
		<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_ERBRI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Rx FIFO threshold or timeout */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_RXTH_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w83977af_pio_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

		<span class="cm">/* Keep receiving */</span>
		<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_ERBRI</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">new_icr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function pc87108_fir_interrupt (self, eir)</span>
<span class="cm"> *</span>
<span class="cm"> *    Handle MIR/FIR interrupt</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__u8</span> <span class="nf">w83977af_fir_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">new_icr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
	
	<span class="cm">/* End of frame detected in FIFO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISR_FEND_I</span><span class="o">|</span><span class="n">ISR_FSF_I</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w83977af_dma_receive_complete</span><span class="p">(</span><span class="n">self</span><span class="p">))</span> <span class="p">{</span>
			
			<span class="cm">/* Wait for next status FIFO interrupt */</span>
			<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_EFSFI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* DMA not finished yet */</span>

			<span class="cm">/* Set timer value, resolution 1 ms */</span>
			<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET4</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">TMRL</span><span class="p">);</span> <span class="cm">/* 1 ms */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">TMRH</span><span class="p">);</span>

			<span class="cm">/* Start timer */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">IR_MSL_EN_TMR</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">IR_MSL</span><span class="p">);</span>

			<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_ETMRI</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Timer finished */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_TMR_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable timer */</span>
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET4</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">IR_MSL</span><span class="p">);</span>

		<span class="cm">/* Clear timer event */</span>
		<span class="cm">/* switch_bank(iobase, SET0); */</span>
<span class="cm">/* 		outb(ASCR_CTE, iobase+ASCR); */</span>

		<span class="cm">/* Check if this is a TX timer interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">IO_XMIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w83977af_dma_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">iobase</span><span class="p">);</span>

			<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_EDMAI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Check if DMA has now finished */</span>
			<span class="n">w83977af_dma_receive_complete</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

			<span class="n">new_icr</span> <span class="o">|=</span> <span class="n">ICR_EFSFI</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>	
	<span class="cm">/* Finished with DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_DMA_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w83977af_dma_xmit_complete</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

		<span class="cm">/* Check if there are more frames to be transmitted */</span>
		<span class="cm">/* if (irda_device_txqueue_empty(self)) { */</span>
		
		<span class="cm">/* Prepare for receive </span>
<span class="cm">		 * </span>
<span class="cm">		 * ** Netwinder Tx DMA likes that we do this anyway **</span>
<span class="cm">		 */</span>
		<span class="n">w83977af_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		<span class="n">new_icr</span> <span class="o">=</span> <span class="n">ICR_EFSFI</span><span class="p">;</span>
	       <span class="cm">/* } */</span>
	<span class="p">}</span>
	
	<span class="cm">/* Restore set */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">new_icr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_interrupt (irq, dev_id, regs)</span>
<span class="cm"> *</span>
<span class="cm"> *    An interrupt from the chip has arrived. Time to do some work</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">w83977af_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">,</span> <span class="n">icr</span><span class="p">,</span> <span class="n">isr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Save current bank */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	
	<span class="n">icr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span> 
	<span class="n">isr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">ISR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">icr</span><span class="p">;</span> <span class="cm">/* Mask out the interesting ones */</span> 

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span> <span class="cm">/* Disable interrupts */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Dispatch interrupt handler for the current speed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">PIO_MAX_SPEED</span> <span class="p">)</span>
			<span class="n">icr</span> <span class="o">=</span> <span class="n">w83977af_fir_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">icr</span> <span class="o">=</span> <span class="n">w83977af_sir_interrupt</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">icr</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>    <span class="cm">/* Restore (new) interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>    <span class="cm">/* Restore bank register */</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">isr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_is_receiving (self)</span>
<span class="cm"> *</span>
<span class="cm"> *    Return TRUE is we are currently receiving a frame</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_is_receiving</span><span class="p">(</span><span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="n">FALSE</span><span class="p">;);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

		<span class="cm">/* Check if rx FIFO is not empty */</span>
		<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
		<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">RXFDTH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We are receiving something */</span>
			<span class="n">status</span> <span class="o">=</span>  <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> 
		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_net_open (dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Start the device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hwname</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>
	
	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">w83977af_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> 
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Always allocate the DMA channel after the IRQ,</span>
<span class="cm">	 * and clean up on failure.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="cm">/* Save current set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

 	<span class="cm">/* Enable some interrupts so we can receive frames again */</span>
 	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">115200</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">outb</span><span class="p">(</span><span class="n">ICR_EFSFI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>
 		<span class="n">w83977af_dma_receive</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
 	<span class="p">}</span> <span class="k">else</span>
 		<span class="n">outb</span><span class="p">(</span><span class="n">ICR_ERBRI</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span>

	<span class="cm">/* Restore bank register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="cm">/* Ready to play! */</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="cm">/* Give self a hardware name */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">hwname</span><span class="p">,</span> <span class="s">&quot;w83977af @ 0x%03x&quot;</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Open new IrLAP layer instance, now that everything should be</span>
<span class="cm">	 * initialized properly </span>
<span class="cm">	 */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="n">irlap_open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">hwname</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_net_close (dev)</span>
<span class="cm"> *</span>
<span class="cm"> *    Stop the device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>
	
	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;);</span>
	
	<span class="n">iobase</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">fir_base</span><span class="p">;</span>

	<span class="cm">/* Stop device */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="cm">/* Stop and remove instance of IrLAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span>
		<span class="n">irlap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">disable_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/* Save current set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>
	
	<span class="cm">/* Disable interrupts */</span>
	<span class="n">switch_bank</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">SET0</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">ICR</span><span class="p">);</span> 

	<span class="n">free_irq</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="cm">/* Restore bank register */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="n">iobase</span><span class="o">+</span><span class="n">SSR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Function w83977af_net_ioctl (dev, rq, cmd)</span>
<span class="cm"> *</span>
<span class="cm"> *    Process IOCTL commands for this device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w83977af_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">if_irda_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w83977af_ir</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">IRDA_ASSERT</span><span class="p">(</span><span class="n">self</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;);</span>

	<span class="n">IRDA_DEBUG</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;%s(), %s, (cmd=0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span> <span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSBANDWIDTH</span>: <span class="cm">/* Set bandwidth */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">w83977af_change_speed</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_baudrate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCSMEDIABUSY</span>: <span class="cm">/* Set media busy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">irda_device_set_media_busy</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIOCGRECEIVING</span>: <span class="cm">/* Check if we are receiving right now */</span>
		<span class="n">irq</span><span class="o">-&gt;</span><span class="n">ifr_receiving</span> <span class="o">=</span> <span class="n">w83977af_is_receiving</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Dag Brattli &lt;dagb@cs.uit.no&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Winbond W83977AF IrDA Device Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="n">module_param</span><span class="p">(</span><span class="n">qos_mtt_bits</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qos_mtt_bits</span><span class="p">,</span> <span class="s">&quot;Mimimum Turn Time&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;Base I/O addresses&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ lines&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function init_module (void)</span>
<span class="cm"> *</span>
<span class="cm"> *    </span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">w83977af_init</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Function cleanup_module (void)</span>
<span class="cm"> *</span>
<span class="cm"> *    </span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">w83977af_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
