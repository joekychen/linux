<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › irda › sh_irda.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sh_irda.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SuperH IrDA Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Renesas Solutions Corp.</span>
<span class="cm"> * Kuninori Morimoto &lt;kuninori.morimoto.gx@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on sh_sir.c</span>
<span class="cm"> * Copyright (C) 2009 Renesas Solutions Corp.</span>
<span class="cm"> * Copyright 2006-2009 Analog Devices Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * CAUTION</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is very simple.</span>
<span class="cm"> * So, it doesn&#39;t have below support now</span>
<span class="cm"> *  - MIR/FIR support</span>
<span class="cm"> *  - DMA transfer support</span>
<span class="cm"> *  - FIFO mode support</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;net/irda/wrapper.h&gt;</span>
<span class="cp">#include &lt;net/irda/irda_device.h&gt;</span>

<span class="cp">#define DRIVER_NAME &quot;sh_irda&quot;</span>

<span class="cp">#if defined(CONFIG_ARCH_SH7367) || defined(CONFIG_ARCH_SH7377)</span>
<span class="cp">#define __IRDARAM_LEN	0x13FF</span>
<span class="cp">#else</span>
<span class="cp">#define __IRDARAM_LEN	0x1039</span>
<span class="cp">#endif</span>

<span class="cp">#define IRTMR		0x1F00 </span><span class="cm">/* Transfer mode */</span><span class="cp"></span>
<span class="cp">#define IRCFR		0x1F02 </span><span class="cm">/* Configuration */</span><span class="cp"></span>
<span class="cp">#define IRCTR		0x1F04 </span><span class="cm">/* IR control */</span><span class="cp"></span>
<span class="cp">#define IRTFLR		0x1F20 </span><span class="cm">/* Transmit frame length */</span><span class="cp"></span>
<span class="cp">#define IRTCTR		0x1F22 </span><span class="cm">/* Transmit control */</span><span class="cp"></span>
<span class="cp">#define IRRFLR		0x1F40 </span><span class="cm">/* Receive frame length */</span><span class="cp"></span>
<span class="cp">#define IRRCTR		0x1F42 </span><span class="cm">/* Receive control */</span><span class="cp"></span>
<span class="cp">#define SIRISR		0x1F60 </span><span class="cm">/* SIR-UART mode interrupt source */</span><span class="cp"></span>
<span class="cp">#define SIRIMR		0x1F62 </span><span class="cm">/* SIR-UART mode interrupt mask */</span><span class="cp"></span>
<span class="cp">#define SIRICR		0x1F64 </span><span class="cm">/* SIR-UART mode interrupt clear */</span><span class="cp"></span>
<span class="cp">#define SIRBCR		0x1F68 </span><span class="cm">/* SIR-UART mode baud rate count */</span><span class="cp"></span>
<span class="cp">#define MFIRISR		0x1F70 </span><span class="cm">/* MIR/FIR mode interrupt source */</span><span class="cp"></span>
<span class="cp">#define MFIRIMR		0x1F72 </span><span class="cm">/* MIR/FIR mode interrupt mask */</span><span class="cp"></span>
<span class="cp">#define MFIRICR		0x1F74 </span><span class="cm">/* MIR/FIR mode interrupt clear */</span><span class="cp"></span>
<span class="cp">#define CRCCTR		0x1F80 </span><span class="cm">/* CRC engine control */</span><span class="cp"></span>
<span class="cp">#define CRCIR		0x1F86 </span><span class="cm">/* CRC engine input data */</span><span class="cp"></span>
<span class="cp">#define CRCCR		0x1F8A </span><span class="cm">/* CRC engine calculation */</span><span class="cp"></span>
<span class="cp">#define CRCOR		0x1F8E </span><span class="cm">/* CRC engine output data */</span><span class="cp"></span>
<span class="cp">#define FIFOCP		0x1FC0 </span><span class="cm">/* FIFO current pointer */</span><span class="cp"></span>
<span class="cp">#define FIFOFP		0x1FC2 </span><span class="cm">/* FIFO follow pointer */</span><span class="cp"></span>
<span class="cp">#define FIFORSMSK	0x1FC4 </span><span class="cm">/* FIFO receive status mask */</span><span class="cp"></span>
<span class="cp">#define FIFORSOR	0x1FC6 </span><span class="cm">/* FIFO receive status OR */</span><span class="cp"></span>
<span class="cp">#define FIFOSEL		0x1FC8 </span><span class="cm">/* FIFO select */</span><span class="cp"></span>
<span class="cp">#define FIFORS		0x1FCA </span><span class="cm">/* FIFO receive status */</span><span class="cp"></span>
<span class="cp">#define FIFORFL		0x1FCC </span><span class="cm">/* FIFO receive frame length */</span><span class="cp"></span>
<span class="cp">#define FIFORAMCP	0x1FCE </span><span class="cm">/* FIFO RAM current pointer */</span><span class="cp"></span>
<span class="cp">#define FIFORAMFP	0x1FD0 </span><span class="cm">/* FIFO RAM follow pointer */</span><span class="cp"></span>
<span class="cp">#define BIFCTL		0x1FD2 </span><span class="cm">/* BUS interface control */</span><span class="cp"></span>
<span class="cp">#define IRDARAM		0x0000 </span><span class="cm">/* IrDA buffer RAM */</span><span class="cp"></span>
<span class="cp">#define IRDARAM_LEN	__IRDARAM_LEN </span><span class="cm">/* - 8/16/32 (read-only for 32) */</span><span class="cp"></span>

<span class="cm">/* IRTMR */</span>
<span class="cp">#define TMD_MASK	(0x3 &lt;&lt; 14) </span><span class="cm">/* Transfer Mode */</span><span class="cp"></span>
<span class="cp">#define TMD_SIR		(0x0 &lt;&lt; 14)</span>
<span class="cp">#define TMD_MIR		(0x3 &lt;&lt; 14)</span>
<span class="cp">#define TMD_FIR		(0x2 &lt;&lt; 14)</span>

<span class="cp">#define FIFORIM		(1 &lt;&lt; 8) </span><span class="cm">/* FIFO receive interrupt mask */</span><span class="cp"></span>
<span class="cp">#define MIM		(1 &lt;&lt; 4) </span><span class="cm">/* MIR/FIR Interrupt Mask */</span><span class="cp"></span>
<span class="cp">#define SIM		(1 &lt;&lt; 0) </span><span class="cm">/* SIR Interrupt Mask */</span><span class="cp"></span>
<span class="cp">#define xIM_MASK	(FIFORIM | MIM | SIM)</span>

<span class="cm">/* IRCFR */</span>
<span class="cp">#define RTO_SHIFT	8 </span><span class="cm">/* shift for Receive Timeout */</span><span class="cp"></span>
<span class="cp">#define RTO		(0x3 &lt;&lt; RTO_SHIFT)</span>

<span class="cm">/* IRTCTR */</span>
<span class="cp">#define ARMOD		(1 &lt;&lt; 15) </span><span class="cm">/* Auto-Receive Mode */</span><span class="cp"></span>
<span class="cp">#define TE		(1 &lt;&lt;  0) </span><span class="cm">/* Transmit Enable */</span><span class="cp"></span>

<span class="cm">/* IRRFLR */</span>
<span class="cp">#define RFL_MASK	(0x1FFF) </span><span class="cm">/* mask for Receive Frame Length */</span><span class="cp"></span>

<span class="cm">/* IRRCTR */</span>
<span class="cp">#define RE		(1 &lt;&lt;  0) </span><span class="cm">/* Receive Enable */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * SIRISR,  SIRIMR,  SIRICR,</span>
<span class="cm"> * MFIRISR, MFIRIMR, MFIRICR</span>
<span class="cm"> */</span>
<span class="cp">#define FRE		(1 &lt;&lt; 15) </span><span class="cm">/* Frame Receive End */</span><span class="cp"></span>
<span class="cp">#define TROV		(1 &lt;&lt; 11) </span><span class="cm">/* Transfer Area Overflow */</span><span class="cp"></span>
<span class="cp">#define xIR_9		(1 &lt;&lt; 9)</span>
<span class="cp">#define TOT		xIR_9     </span><span class="cm">/* for SIR     Timeout */</span><span class="cp"></span>
<span class="cp">#define ABTD		xIR_9     </span><span class="cm">/* for MIR/FIR Abort Detection */</span><span class="cp"></span>
<span class="cp">#define xIR_8		(1 &lt;&lt; 8)</span>
<span class="cp">#define FER		xIR_8     </span><span class="cm">/* for SIR     Framing Error */</span><span class="cp"></span>
<span class="cp">#define CRCER		xIR_8     </span><span class="cm">/* for MIR/FIR CRC error */</span><span class="cp"></span>
<span class="cp">#define FTE		(1 &lt;&lt; 7)  </span><span class="cm">/* Frame Transmit End */</span><span class="cp"></span>
<span class="cp">#define xIR_MASK	(FRE | TROV | xIR_9 | xIR_8 | FTE)</span>

<span class="cm">/* SIRBCR */</span>
<span class="cp">#define BRC_MASK	(0x3F) </span><span class="cm">/* mask for Baud Rate Count */</span><span class="cp"></span>

<span class="cm">/* CRCCTR */</span>
<span class="cp">#define CRC_RST		(1 &lt;&lt; 15) </span><span class="cm">/* CRC Engine Reset */</span><span class="cp"></span>
<span class="cp">#define CRC_CT_MASK	0x0FFF    </span><span class="cm">/* mask for CRC Engine Input Data Count */</span><span class="cp"></span>

<span class="cm">/* CRCIR */</span>
<span class="cp">#define CRC_IN_MASK	0x0FFF    </span><span class="cm">/* mask for CRC Engine Input Data */</span><span class="cp"></span>

<span class="cm">/************************************************************************</span>


<span class="cm">			enum / structure</span>


<span class="cm">************************************************************************/</span>
<span class="k">enum</span> <span class="n">sh_irda_mode</span> <span class="p">{</span>
	<span class="n">SH_IRDA_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">SH_IRDA_SIR</span><span class="p">,</span>
	<span class="n">SH_IRDA_MIR</span><span class="p">,</span>
	<span class="n">SH_IRDA_FIR</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh_irda_self</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">sh_irda_xir_func</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xir_fre</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xir_trov</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xir_9</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xir_8</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">xir_fte</span><span class="p">)</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">membase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">irlap_cb</span>		<span class="o">*</span><span class="n">irlap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qos_info</span>		<span class="n">qos</span><span class="p">;</span>

	<span class="n">iobuff_t</span>		<span class="n">tx_buff</span><span class="p">;</span>
	<span class="n">iobuff_t</span>		<span class="n">rx_buff</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">sh_irda_mode</span>	<span class="n">mode</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sh_irda_xir_func</span>	<span class="o">*</span><span class="n">xir_func</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/************************************************************************</span>


<span class="cm">			common function</span>


<span class="cm">************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">sh_irda_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_update_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span>
		<span class="n">iowrite16</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>


<span class="cm">			mode function</span>


<span class="cm">************************************************************************/</span>
<span class="cm">/*=====================================</span>
<span class="cm"> *</span>
<span class="cm"> *		common</span>
<span class="cm"> *</span>
<span class="cm"> *=====================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRRCTR</span><span class="p">,</span> <span class="n">RE</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">RE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;recv %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_set_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SH_IRDA_SIR</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported timeout interval</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRCFR</span><span class="p">,</span> <span class="n">RTO</span><span class="p">,</span> <span class="n">interval</span> <span class="o">&lt;&lt;</span> <span class="n">RTO_SHIFT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_set_baudrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">baudrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baudrate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SH_IRDA_SIR</span> <span class="o">!=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;it is not SIR mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Baud rate (bits/s) =</span>
<span class="cm">	 *   (48 MHz / 26) / (baud rate counter value + 1) x 16</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">48000000</span> <span class="o">/</span> <span class="mi">26</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">/</span> <span class="n">baudrate</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;baudrate = %d,  val = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">baudrate</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">SIRBCR</span><span class="p">,</span> <span class="n">BRC_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_get_rcv_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">RFL_MASK</span> <span class="o">&amp;</span> <span class="n">sh_irda_read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRRFLR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*=====================================</span>
<span class="cm"> *</span>
<span class="cm"> *		NONE MODE</span>
<span class="cm"> *</span>
<span class="cm"> *=====================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_xir_fre</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;none mode: frame recv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_xir_trov</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;none mode: buffer ram over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_xir_9</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;none mode: time over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_xir_8</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;none mode: framing error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_xir_fte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;none mode: frame transmit end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_irda_xir_func</span> <span class="n">sh_irda_xir_func</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xir_fre</span>	<span class="o">=</span> <span class="n">sh_irda_xir_fre</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_trov</span>	<span class="o">=</span> <span class="n">sh_irda_xir_trov</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_9</span>		<span class="o">=</span> <span class="n">sh_irda_xir_9</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_8</span>		<span class="o">=</span> <span class="n">sh_irda_xir_8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_fte</span>	<span class="o">=</span> <span class="n">sh_irda_xir_fte</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*=====================================</span>
<span class="cm"> *</span>
<span class="cm"> *		MIR/FIR MODE</span>
<span class="cm"> *</span>
<span class="cm"> * MIR/FIR are not supported now</span>
<span class="cm"> *=====================================*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_irda_xir_func</span> <span class="n">sh_irda_mfir_func</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xir_fre</span>	<span class="o">=</span> <span class="n">sh_irda_xir_fre</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_trov</span>	<span class="o">=</span> <span class="n">sh_irda_xir_trov</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_9</span>		<span class="o">=</span> <span class="n">sh_irda_xir_9</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_8</span>		<span class="o">=</span> <span class="n">sh_irda_xir_8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_fte</span>	<span class="o">=</span> <span class="n">sh_irda_xir_fte</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*=====================================</span>
<span class="cm"> *</span>
<span class="cm"> *		SIR MODE</span>
<span class="cm"> *</span>
<span class="cm"> *=====================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_sir_fre</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data16</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">data16</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sh_irda_get_rcv_length</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">IRDARAM_LEN</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">IRDARAM_LEN</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;frame recv length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">j</span><span class="p">)</span>
			<span class="n">data16</span> <span class="o">=</span> <span class="n">sh_irda_read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRDARAM</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

		<span class="n">async_unwrap_char</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_sir_trov</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;buffer ram over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_sir_tot</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;time over</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sh_irda_set_baudrate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">9600</span><span class="p">);</span>
	<span class="n">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_sir_fer</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;framing error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_sir_fte</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;frame transmit end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_irda_xir_func</span> <span class="n">sh_irda_sir_func</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xir_fre</span>	<span class="o">=</span> <span class="n">sh_irda_sir_fre</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_trov</span>	<span class="o">=</span> <span class="n">sh_irda_sir_trov</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_9</span>		<span class="o">=</span> <span class="n">sh_irda_sir_tot</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_8</span>		<span class="o">=</span> <span class="n">sh_irda_sir_fer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xir_fte</span>	<span class="o">=</span> <span class="n">sh_irda_sir_fte</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="k">enum</span> <span class="n">sh_irda_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_irda_xir_func</span>	<span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SH_IRDA_SIR</span>:
		<span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;SIR&quot;</span><span class="p">;</span>
		<span class="n">data</span>	<span class="o">=</span> <span class="n">TMD_SIR</span><span class="p">;</span>
		<span class="n">func</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_irda_sir_func</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SH_IRDA_MIR</span>:
		<span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;MIR&quot;</span><span class="p">;</span>
		<span class="n">data</span>	<span class="o">=</span> <span class="n">TMD_MIR</span><span class="p">;</span>
		<span class="n">func</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_irda_mfir_func</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SH_IRDA_FIR</span>:
		<span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;FIR&quot;</span><span class="p">;</span>
		<span class="n">data</span>	<span class="o">=</span> <span class="n">TMD_FIR</span><span class="p">;</span>
		<span class="n">func</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_irda_mfir_func</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;NONE&quot;</span><span class="p">;</span>
		<span class="n">data</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">func</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_irda_xir_func</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">xir_func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRTMR</span><span class="p">,</span> <span class="n">TMD_MASK</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;switch to %s mode&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>


<span class="cm">			irq function</span>


<span class="cm">************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_set_irq_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmr_hole</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">xir_reg</span><span class="p">;</span>

	<span class="cm">/* set all mask */</span>
	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRTMR</span><span class="p">,</span>   <span class="n">xIM_MASK</span><span class="p">,</span> <span class="n">xIM_MASK</span><span class="p">);</span>
	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">SIRIMR</span><span class="p">,</span>  <span class="n">xIR_MASK</span><span class="p">,</span> <span class="n">xIR_MASK</span><span class="p">);</span>
	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">MFIRIMR</span><span class="p">,</span> <span class="n">xIR_MASK</span><span class="p">,</span> <span class="n">xIR_MASK</span><span class="p">);</span>

	<span class="cm">/* clear irq */</span>
	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">SIRICR</span><span class="p">,</span>  <span class="n">xIR_MASK</span><span class="p">,</span> <span class="n">xIR_MASK</span><span class="p">);</span>
	<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">MFIRICR</span><span class="p">,</span> <span class="n">xIR_MASK</span><span class="p">,</span> <span class="n">xIR_MASK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SH_IRDA_SIR</span>:
		<span class="n">tmr_hole</span>	<span class="o">=</span> <span class="n">SIM</span><span class="p">;</span>
		<span class="n">xir_reg</span>		<span class="o">=</span> <span class="n">SIRIMR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SH_IRDA_MIR</span>:
	<span class="k">case</span> <span class="n">SH_IRDA_FIR</span>:
		<span class="n">tmr_hole</span>	<span class="o">=</span> <span class="n">MIM</span><span class="p">;</span>
		<span class="n">xir_reg</span>		<span class="o">=</span> <span class="n">MFIRIMR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tmr_hole</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">xir_reg</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* open mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xir_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRTMR</span><span class="p">,</span> <span class="n">tmr_hole</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sh_irda_update_bits</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">xir_reg</span><span class="p">,</span> <span class="n">xIR_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sh_irda_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_irda_xir_func</span>	<span class="o">*</span><span class="n">func</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">xir_func</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">isr</span> <span class="o">=</span> <span class="n">sh_irda_read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">SIRISR</span><span class="p">);</span>

	<span class="cm">/* clear irq */</span>
	<span class="n">sh_irda_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">SIRICR</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">FRE</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">xir_fre</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">TROV</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">xir_trov</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">xIR_9</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">xir_9</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">xIR_8</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">xir_8</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">FTE</span><span class="p">)</span>
		<span class="n">func</span><span class="o">-&gt;</span><span class="n">xir_fte</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>


<span class="cm">			CRC function</span>


<span class="cm">************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_crc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh_irda_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">CRCCTR</span><span class="p">,</span> <span class="n">CRC_RST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_crc_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh_irda_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">CRCIR</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">CRC_IN_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">sh_irda_crc_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">CRC_CT_MASK</span> <span class="o">&amp;</span> <span class="n">sh_irda_read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">CRCCTR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">sh_irda_crc_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sh_irda_read</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">CRCOR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_crc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">sh_irda_crc_reset</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

	<span class="n">sh_irda_crc_add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">);</span>
	<span class="n">sh_irda_crc_add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">);</span>
	<span class="n">sh_irda_crc_add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mh">0xF1</span><span class="p">);</span>
	<span class="n">sh_irda_crc_add</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mh">0xA7</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">sh_irda_crc_cnt</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CRC count error %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">crc_init_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">sh_irda_crc_out</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mh">0x51DF</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CRC result error%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">crc_init_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">crc_init_out:</span>

	<span class="n">sh_irda_crc_reset</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>


<span class="cm">			iobuf function</span>


<span class="cm">************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_irda_remove_iobuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_init_iobuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rxsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">||</span>
	    <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;iobuff has already existed.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rx_buff */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">rxsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">truesize</span>	<span class="o">=</span> <span class="n">rxsize</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">in_frame</span>	<span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">state</span>	<span class="o">=</span> <span class="n">OUTSIDE_FRAME</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>

	<span class="cm">/* tx_buff */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span>	<span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">IRDARAM</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span>	<span class="o">=</span> <span class="n">IRDARAM_LEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************************************</span>


<span class="cm">			net_device_ops function</span>


<span class="cm">************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_hard_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">irda_get_next_speed</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hard xmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_irda_set_baudrate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">sh_irda_hard_xmit_end</span><span class="p">;</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">async_wrap_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
						   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">head</span><span class="p">,</span>
						   <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">)</span>
			<span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">truesize</span><span class="p">;</span>

		<span class="n">sh_irda_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRTFLR</span><span class="p">,</span> <span class="n">self</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">sh_irda_write</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRTCTR</span><span class="p">,</span> <span class="n">ARMOD</span> <span class="o">|</span> <span class="n">TE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">sh_irda_hard_xmit_end</span><span class="p">;</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">sh_irda_hard_xmit_end:</span>
	<span class="n">sh_irda_set_baudrate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">9600</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifreq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME</span>
<span class="cm">	 *</span>
<span class="cm">	 * This function is needed for irda framework.</span>
<span class="cm">	 * But nothing to do now</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">sh_irda_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sh_irda_crc_init</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">open_err</span><span class="p">;</span>

	<span class="n">sh_irda_set_mode</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">SH_IRDA_SIR</span><span class="p">);</span>
	<span class="n">sh_irda_set_timeout</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">sh_irda_set_baudrate</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">9600</span><span class="p">);</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="n">irlap_open</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">open_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">sh_irda_rcv_ctrl</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sh_irda_set_irq_mask</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;opened</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">open_err:</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Stop IrLAP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">irlap_close</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span><span class="p">);</span>
		<span class="n">self</span><span class="o">-&gt;</span><span class="n">irlap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sh_irda_ndo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sh_irda_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sh_irda_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sh_irda_hard_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">sh_irda_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">sh_irda_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/************************************************************************</span>


<span class="cm">			platform_driver function</span>


<span class="cm">************************************************************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sh_irda_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Not enough platform resources.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">alloc_irdadev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">self</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to ioremap.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mem_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sh_irda_init_iobuf</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">IRDA_SKB_MAX_MTU</span><span class="p">,</span> <span class="n">IRDA_SIR_MAX_FRAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_mem_2</span><span class="p">;</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">irda_init_max_qos_capabilies</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_irda_ndo</span><span class="p">;</span>
	<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">self</span><span class="o">-&gt;</span><span class="n">ndev</span>			<span class="o">=</span> <span class="n">ndev</span><span class="p">;</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">baud_rate</span><span class="p">.</span><span class="n">bits</span>	<span class="o">&amp;=</span> <span class="n">IR_9600</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
	<span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">min_turn_time</span><span class="p">.</span><span class="n">bits</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* 10 ms or more */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">irda_qos_bits_to_value</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_mem_4</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sh_irda_irq</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;sh_irda&quot;</span><span class="p">,</span> <span class="n">self</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to attach sh_irda interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_mem_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SuperH IrDA probed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">err_mem_4:</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sh_irda_remove_iobuf</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="nl">err_mem_2:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
<span class="nl">err_mem_1:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">sh_irda_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_irda_self</span> <span class="o">*</span><span class="n">self</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">self</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sh_irda_remove_iobuf</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_irda_runtime_nop</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Runtime PM callback shared between -&gt;runtime_suspend()</span>
<span class="cm">	 * and -&gt;runtime_resume(). Simply returns success.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This driver re-initializes all registers after</span>
<span class="cm">	 * pm_runtime_get_sync() anyway so there is no need</span>
<span class="cm">	 * to save and restore registers here.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">sh_irda_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">runtime_suspend</span>	<span class="o">=</span> <span class="n">sh_irda_runtime_nop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">runtime_resume</span>		<span class="o">=</span> <span class="n">sh_irda_runtime_nop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">sh_irda_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">sh_irda_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sh_irda_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_irda_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">sh_irda_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kuninori Morimoto &lt;kuninori.morimoto.gx@renesas.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SuperH IrDA driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
