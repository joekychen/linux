<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hamradio › mkiss.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mkiss.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  This program is free software; you can distribute it and/or modify it</span>
<span class="cm"> *  under the terms of the GNU General Public License (Version 2) as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> *  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License along</span>
<span class="cm"> *  with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> *  59 Temple Place - Suite 330, Boston MA 02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) Hans Alblas PE1AYX &lt;hans@esrac.ele.tue.nl&gt;</span>
<span class="cm"> * Copyright (C) 2004, 05 Ralf Baechle DL5RB &lt;ralf@linux-mips.org&gt;</span>
<span class="cm"> * Copyright (C) 2004, 05 Thomas Osterried DL9SAU &lt;thomas@x-berg.in-berlin.de&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/crc16.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>

<span class="cp">#include &lt;net/ax25.h&gt;</span>

<span class="cp">#define AX_MTU		236</span>

<span class="cm">/* SLIP/KISS protocol characters. */</span>
<span class="cp">#define END             0300		</span><span class="cm">/* indicates end of frame	*/</span><span class="cp"></span>
<span class="cp">#define ESC             0333		</span><span class="cm">/* indicates byte stuffing	*/</span><span class="cp"></span>
<span class="cp">#define ESC_END         0334		</span><span class="cm">/* ESC ESC_END means END &#39;data&#39;	*/</span><span class="cp"></span>
<span class="cp">#define ESC_ESC         0335		</span><span class="cm">/* ESC ESC_ESC means ESC &#39;data&#39;	*/</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">mkiss</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">tty_struct</span>	<span class="o">*</span><span class="n">tty</span><span class="p">;</span>	<span class="cm">/* ptr to TTY structure		*/</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>	<span class="cm">/* easy for intr handling	*/</span>

	<span class="cm">/* These are pointers to the malloc()ed frame buffers. */</span>
	<span class="n">spinlock_t</span>		<span class="n">buflock</span><span class="p">;</span><span class="cm">/* lock for rbuf and xbuf */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">rbuff</span><span class="p">;</span>	<span class="cm">/* receiver buffer		*/</span>
	<span class="kt">int</span>			<span class="n">rcount</span><span class="p">;</span>	<span class="cm">/* received chars counter       */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">xbuff</span><span class="p">;</span>	<span class="cm">/* transmitter buffer		*/</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">xhead</span><span class="p">;</span>	<span class="cm">/* pointer to next byte to XMIT */</span>
	<span class="kt">int</span>			<span class="n">xleft</span><span class="p">;</span>	<span class="cm">/* bytes left in XMIT queue     */</span>

	<span class="cm">/* Detailed SLIP statistics. */</span>
	<span class="kt">int</span>		<span class="n">mtu</span><span class="p">;</span>		<span class="cm">/* Our mtu (to spot changes!)   */</span>
	<span class="kt">int</span>		<span class="n">buffsize</span><span class="p">;</span>	<span class="cm">/* Max buffers sizes            */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* Flag values/ mode etc	*/</span>
					<span class="cm">/* long req&#39;d: used by set_bit --RR */</span>
<span class="cp">#define AXF_INUSE	0		</span><span class="cm">/* Channel in use               */</span><span class="cp"></span>
<span class="cp">#define AXF_ESCAPE	1               </span><span class="cm">/* ESC received                 */</span><span class="cp"></span>
<span class="cp">#define AXF_ERROR	2               </span><span class="cm">/* Parity, etc. error           */</span><span class="cp"></span>
<span class="cp">#define AXF_KEEPTEST	3		</span><span class="cm">/* Keepalive test flag		*/</span><span class="cp"></span>
<span class="cp">#define AXF_OUTWAIT	4		</span><span class="cm">/* is outpacket was flag	*/</span><span class="cp"></span>

	<span class="kt">int</span>		<span class="n">mode</span><span class="p">;</span>
        <span class="kt">int</span>		<span class="n">crcmode</span><span class="p">;</span>	<span class="cm">/* MW: for FlexNet, SMACK etc.  */</span>
	<span class="kt">int</span>		<span class="n">crcauto</span><span class="p">;</span>	<span class="cm">/* CRC auto mode */</span>

<span class="cp">#define CRC_MODE_NONE		0</span>
<span class="cp">#define CRC_MODE_FLEX		1</span>
<span class="cp">#define CRC_MODE_SMACK		2</span>
<span class="cp">#define CRC_MODE_FLEX_TEST	3</span>
<span class="cp">#define CRC_MODE_SMACK_TEST	4</span>

	<span class="n">atomic_t</span>		<span class="n">refcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">semaphore</span>	<span class="n">dead_sem</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc_flex_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0f87</span><span class="p">,</span> <span class="mh">0x1e0e</span><span class="p">,</span> <span class="mh">0x2c95</span><span class="p">,</span> <span class="mh">0x3d1c</span><span class="p">,</span> <span class="mh">0x49a3</span><span class="p">,</span> <span class="mh">0x582a</span><span class="p">,</span> <span class="mh">0x6ab1</span><span class="p">,</span> <span class="mh">0x7b38</span><span class="p">,</span>
	<span class="mh">0x83cf</span><span class="p">,</span> <span class="mh">0x9246</span><span class="p">,</span> <span class="mh">0xa0dd</span><span class="p">,</span> <span class="mh">0xb154</span><span class="p">,</span> <span class="mh">0xc5eb</span><span class="p">,</span> <span class="mh">0xd462</span><span class="p">,</span> <span class="mh">0xe6f9</span><span class="p">,</span> <span class="mh">0xf770</span><span class="p">,</span>
	<span class="mh">0x1f06</span><span class="p">,</span> <span class="mh">0x0e8f</span><span class="p">,</span> <span class="mh">0x3c14</span><span class="p">,</span> <span class="mh">0x2d9d</span><span class="p">,</span> <span class="mh">0x5922</span><span class="p">,</span> <span class="mh">0x48ab</span><span class="p">,</span> <span class="mh">0x7a30</span><span class="p">,</span> <span class="mh">0x6bb9</span><span class="p">,</span>
	<span class="mh">0x934e</span><span class="p">,</span> <span class="mh">0x82c7</span><span class="p">,</span> <span class="mh">0xb05c</span><span class="p">,</span> <span class="mh">0xa1d5</span><span class="p">,</span> <span class="mh">0xd56a</span><span class="p">,</span> <span class="mh">0xc4e3</span><span class="p">,</span> <span class="mh">0xf678</span><span class="p">,</span> <span class="mh">0xe7f1</span><span class="p">,</span>
	<span class="mh">0x2e85</span><span class="p">,</span> <span class="mh">0x3f0c</span><span class="p">,</span> <span class="mh">0x0d97</span><span class="p">,</span> <span class="mh">0x1c1e</span><span class="p">,</span> <span class="mh">0x68a1</span><span class="p">,</span> <span class="mh">0x7928</span><span class="p">,</span> <span class="mh">0x4bb3</span><span class="p">,</span> <span class="mh">0x5a3a</span><span class="p">,</span>
	<span class="mh">0xa2cd</span><span class="p">,</span> <span class="mh">0xb344</span><span class="p">,</span> <span class="mh">0x81df</span><span class="p">,</span> <span class="mh">0x9056</span><span class="p">,</span> <span class="mh">0xe4e9</span><span class="p">,</span> <span class="mh">0xf560</span><span class="p">,</span> <span class="mh">0xc7fb</span><span class="p">,</span> <span class="mh">0xd672</span><span class="p">,</span>
	<span class="mh">0x3e04</span><span class="p">,</span> <span class="mh">0x2f8d</span><span class="p">,</span> <span class="mh">0x1d16</span><span class="p">,</span> <span class="mh">0x0c9f</span><span class="p">,</span> <span class="mh">0x7820</span><span class="p">,</span> <span class="mh">0x69a9</span><span class="p">,</span> <span class="mh">0x5b32</span><span class="p">,</span> <span class="mh">0x4abb</span><span class="p">,</span>
	<span class="mh">0xb24c</span><span class="p">,</span> <span class="mh">0xa3c5</span><span class="p">,</span> <span class="mh">0x915e</span><span class="p">,</span> <span class="mh">0x80d7</span><span class="p">,</span> <span class="mh">0xf468</span><span class="p">,</span> <span class="mh">0xe5e1</span><span class="p">,</span> <span class="mh">0xd77a</span><span class="p">,</span> <span class="mh">0xc6f3</span><span class="p">,</span>
	<span class="mh">0x4d83</span><span class="p">,</span> <span class="mh">0x5c0a</span><span class="p">,</span> <span class="mh">0x6e91</span><span class="p">,</span> <span class="mh">0x7f18</span><span class="p">,</span> <span class="mh">0x0ba7</span><span class="p">,</span> <span class="mh">0x1a2e</span><span class="p">,</span> <span class="mh">0x28b5</span><span class="p">,</span> <span class="mh">0x393c</span><span class="p">,</span>
	<span class="mh">0xc1cb</span><span class="p">,</span> <span class="mh">0xd042</span><span class="p">,</span> <span class="mh">0xe2d9</span><span class="p">,</span> <span class="mh">0xf350</span><span class="p">,</span> <span class="mh">0x87ef</span><span class="p">,</span> <span class="mh">0x9666</span><span class="p">,</span> <span class="mh">0xa4fd</span><span class="p">,</span> <span class="mh">0xb574</span><span class="p">,</span>
	<span class="mh">0x5d02</span><span class="p">,</span> <span class="mh">0x4c8b</span><span class="p">,</span> <span class="mh">0x7e10</span><span class="p">,</span> <span class="mh">0x6f99</span><span class="p">,</span> <span class="mh">0x1b26</span><span class="p">,</span> <span class="mh">0x0aaf</span><span class="p">,</span> <span class="mh">0x3834</span><span class="p">,</span> <span class="mh">0x29bd</span><span class="p">,</span>
	<span class="mh">0xd14a</span><span class="p">,</span> <span class="mh">0xc0c3</span><span class="p">,</span> <span class="mh">0xf258</span><span class="p">,</span> <span class="mh">0xe3d1</span><span class="p">,</span> <span class="mh">0x976e</span><span class="p">,</span> <span class="mh">0x86e7</span><span class="p">,</span> <span class="mh">0xb47c</span><span class="p">,</span> <span class="mh">0xa5f5</span><span class="p">,</span>
	<span class="mh">0x6c81</span><span class="p">,</span> <span class="mh">0x7d08</span><span class="p">,</span> <span class="mh">0x4f93</span><span class="p">,</span> <span class="mh">0x5e1a</span><span class="p">,</span> <span class="mh">0x2aa5</span><span class="p">,</span> <span class="mh">0x3b2c</span><span class="p">,</span> <span class="mh">0x09b7</span><span class="p">,</span> <span class="mh">0x183e</span><span class="p">,</span>
	<span class="mh">0xe0c9</span><span class="p">,</span> <span class="mh">0xf140</span><span class="p">,</span> <span class="mh">0xc3db</span><span class="p">,</span> <span class="mh">0xd252</span><span class="p">,</span> <span class="mh">0xa6ed</span><span class="p">,</span> <span class="mh">0xb764</span><span class="p">,</span> <span class="mh">0x85ff</span><span class="p">,</span> <span class="mh">0x9476</span><span class="p">,</span>
	<span class="mh">0x7c00</span><span class="p">,</span> <span class="mh">0x6d89</span><span class="p">,</span> <span class="mh">0x5f12</span><span class="p">,</span> <span class="mh">0x4e9b</span><span class="p">,</span> <span class="mh">0x3a24</span><span class="p">,</span> <span class="mh">0x2bad</span><span class="p">,</span> <span class="mh">0x1936</span><span class="p">,</span> <span class="mh">0x08bf</span><span class="p">,</span>
	<span class="mh">0xf048</span><span class="p">,</span> <span class="mh">0xe1c1</span><span class="p">,</span> <span class="mh">0xd35a</span><span class="p">,</span> <span class="mh">0xc2d3</span><span class="p">,</span> <span class="mh">0xb66c</span><span class="p">,</span> <span class="mh">0xa7e5</span><span class="p">,</span> <span class="mh">0x957e</span><span class="p">,</span> <span class="mh">0x84f7</span><span class="p">,</span>
	<span class="mh">0x8b8f</span><span class="p">,</span> <span class="mh">0x9a06</span><span class="p">,</span> <span class="mh">0xa89d</span><span class="p">,</span> <span class="mh">0xb914</span><span class="p">,</span> <span class="mh">0xcdab</span><span class="p">,</span> <span class="mh">0xdc22</span><span class="p">,</span> <span class="mh">0xeeb9</span><span class="p">,</span> <span class="mh">0xff30</span><span class="p">,</span>
	<span class="mh">0x07c7</span><span class="p">,</span> <span class="mh">0x164e</span><span class="p">,</span> <span class="mh">0x24d5</span><span class="p">,</span> <span class="mh">0x355c</span><span class="p">,</span> <span class="mh">0x41e3</span><span class="p">,</span> <span class="mh">0x506a</span><span class="p">,</span> <span class="mh">0x62f1</span><span class="p">,</span> <span class="mh">0x7378</span><span class="p">,</span>
	<span class="mh">0x9b0e</span><span class="p">,</span> <span class="mh">0x8a87</span><span class="p">,</span> <span class="mh">0xb81c</span><span class="p">,</span> <span class="mh">0xa995</span><span class="p">,</span> <span class="mh">0xdd2a</span><span class="p">,</span> <span class="mh">0xcca3</span><span class="p">,</span> <span class="mh">0xfe38</span><span class="p">,</span> <span class="mh">0xefb1</span><span class="p">,</span>
	<span class="mh">0x1746</span><span class="p">,</span> <span class="mh">0x06cf</span><span class="p">,</span> <span class="mh">0x3454</span><span class="p">,</span> <span class="mh">0x25dd</span><span class="p">,</span> <span class="mh">0x5162</span><span class="p">,</span> <span class="mh">0x40eb</span><span class="p">,</span> <span class="mh">0x7270</span><span class="p">,</span> <span class="mh">0x63f9</span><span class="p">,</span>
	<span class="mh">0xaa8d</span><span class="p">,</span> <span class="mh">0xbb04</span><span class="p">,</span> <span class="mh">0x899f</span><span class="p">,</span> <span class="mh">0x9816</span><span class="p">,</span> <span class="mh">0xeca9</span><span class="p">,</span> <span class="mh">0xfd20</span><span class="p">,</span> <span class="mh">0xcfbb</span><span class="p">,</span> <span class="mh">0xde32</span><span class="p">,</span>
	<span class="mh">0x26c5</span><span class="p">,</span> <span class="mh">0x374c</span><span class="p">,</span> <span class="mh">0x05d7</span><span class="p">,</span> <span class="mh">0x145e</span><span class="p">,</span> <span class="mh">0x60e1</span><span class="p">,</span> <span class="mh">0x7168</span><span class="p">,</span> <span class="mh">0x43f3</span><span class="p">,</span> <span class="mh">0x527a</span><span class="p">,</span>
	<span class="mh">0xba0c</span><span class="p">,</span> <span class="mh">0xab85</span><span class="p">,</span> <span class="mh">0x991e</span><span class="p">,</span> <span class="mh">0x8897</span><span class="p">,</span> <span class="mh">0xfc28</span><span class="p">,</span> <span class="mh">0xeda1</span><span class="p">,</span> <span class="mh">0xdf3a</span><span class="p">,</span> <span class="mh">0xceb3</span><span class="p">,</span>
	<span class="mh">0x3644</span><span class="p">,</span> <span class="mh">0x27cd</span><span class="p">,</span> <span class="mh">0x1556</span><span class="p">,</span> <span class="mh">0x04df</span><span class="p">,</span> <span class="mh">0x7060</span><span class="p">,</span> <span class="mh">0x61e9</span><span class="p">,</span> <span class="mh">0x5372</span><span class="p">,</span> <span class="mh">0x42fb</span><span class="p">,</span>
	<span class="mh">0xc98b</span><span class="p">,</span> <span class="mh">0xd802</span><span class="p">,</span> <span class="mh">0xea99</span><span class="p">,</span> <span class="mh">0xfb10</span><span class="p">,</span> <span class="mh">0x8faf</span><span class="p">,</span> <span class="mh">0x9e26</span><span class="p">,</span> <span class="mh">0xacbd</span><span class="p">,</span> <span class="mh">0xbd34</span><span class="p">,</span>
	<span class="mh">0x45c3</span><span class="p">,</span> <span class="mh">0x544a</span><span class="p">,</span> <span class="mh">0x66d1</span><span class="p">,</span> <span class="mh">0x7758</span><span class="p">,</span> <span class="mh">0x03e7</span><span class="p">,</span> <span class="mh">0x126e</span><span class="p">,</span> <span class="mh">0x20f5</span><span class="p">,</span> <span class="mh">0x317c</span><span class="p">,</span>
	<span class="mh">0xd90a</span><span class="p">,</span> <span class="mh">0xc883</span><span class="p">,</span> <span class="mh">0xfa18</span><span class="p">,</span> <span class="mh">0xeb91</span><span class="p">,</span> <span class="mh">0x9f2e</span><span class="p">,</span> <span class="mh">0x8ea7</span><span class="p">,</span> <span class="mh">0xbc3c</span><span class="p">,</span> <span class="mh">0xadb5</span><span class="p">,</span>
	<span class="mh">0x5542</span><span class="p">,</span> <span class="mh">0x44cb</span><span class="p">,</span> <span class="mh">0x7650</span><span class="p">,</span> <span class="mh">0x67d9</span><span class="p">,</span> <span class="mh">0x1366</span><span class="p">,</span> <span class="mh">0x02ef</span><span class="p">,</span> <span class="mh">0x3074</span><span class="p">,</span> <span class="mh">0x21fd</span><span class="p">,</span>
	<span class="mh">0xe889</span><span class="p">,</span> <span class="mh">0xf900</span><span class="p">,</span> <span class="mh">0xcb9b</span><span class="p">,</span> <span class="mh">0xda12</span><span class="p">,</span> <span class="mh">0xaead</span><span class="p">,</span> <span class="mh">0xbf24</span><span class="p">,</span> <span class="mh">0x8dbf</span><span class="p">,</span> <span class="mh">0x9c36</span><span class="p">,</span>
	<span class="mh">0x64c1</span><span class="p">,</span> <span class="mh">0x7548</span><span class="p">,</span> <span class="mh">0x47d3</span><span class="p">,</span> <span class="mh">0x565a</span><span class="p">,</span> <span class="mh">0x22e5</span><span class="p">,</span> <span class="mh">0x336c</span><span class="p">,</span> <span class="mh">0x01f7</span><span class="p">,</span> <span class="mh">0x107e</span><span class="p">,</span>
	<span class="mh">0xf808</span><span class="p">,</span> <span class="mh">0xe981</span><span class="p">,</span> <span class="mh">0xdb1a</span><span class="p">,</span> <span class="mh">0xca93</span><span class="p">,</span> <span class="mh">0xbe2c</span><span class="p">,</span> <span class="mh">0xafa5</span><span class="p">,</span> <span class="mh">0x9d3e</span><span class="p">,</span> <span class="mh">0x8cb7</span><span class="p">,</span>
	<span class="mh">0x7440</span><span class="p">,</span> <span class="mh">0x65c9</span><span class="p">,</span> <span class="mh">0x5752</span><span class="p">,</span> <span class="mh">0x46db</span><span class="p">,</span> <span class="mh">0x3264</span><span class="p">,</span> <span class="mh">0x23ed</span><span class="p">,</span> <span class="mh">0x1176</span><span class="p">,</span> <span class="mh">0x00ff</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">calc_crc_flex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="n">crc_flex_table</span><span class="p">[((</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_crc_flex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="o">--</span><span class="p">)</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="n">crc_flex_table</span><span class="p">[((</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7070</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_crc_16</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crc</span> <span class="o">!=</span> <span class="mh">0x0000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Standard encapsulation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kiss_esc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send an initial END character to flush out any data that may have</span>
<span class="cm">	 * accumulated in the receiver due to line noise.</span>
<span class="cm">	 */</span>

	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">END</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">END</span>:
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC_END</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ESC</span>:
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC_ESC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">END</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MW:</span>
<span class="cm"> * OK its ugly, but tell me a better solution without copying the</span>
<span class="cm"> * packet to a temporary buffer :-)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kiss_esc_crc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">END</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">crc</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">len</span><span class="o">--</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">END</span>:
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC_END</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ESC</span>:
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">ESC_ESC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">END</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send one completely decapsulated AX.25 packet to the AX.25 layer. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ax_bump</span><span class="p">(</span><span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_crc_16</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>

				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">!=</span> <span class="n">CRC_MODE_SMACK</span> <span class="o">&amp;&amp;</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcauto</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				       <span class="s">&quot;mkiss: %s: Switching to crc-smack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">=</span> <span class="n">CRC_MODE_SMACK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>  <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_crc_flex</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">!=</span> <span class="n">CRC_MODE_FLEX</span> <span class="o">&amp;&amp;</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcauto</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				       <span class="s">&quot;mkiss: %s: Switching to crc-flexnet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">=</span> <span class="n">CRC_MODE_FLEX</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * dl9sau bugfix: the trailling two bytes flexnet crc</span>
<span class="cm">			 * will not be passed to the kernel. thus we have to</span>
<span class="cm">			 * correct the kissparm signature, because it indicates</span>
<span class="cm">			 * a crc but there&#39;s none</span>
<span class="cm">			 */</span>
			<span class="o">*</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span>
 	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">count</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mkiss: %s: memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">count</span><span class="p">),</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ax25_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kiss_unesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">END</span>:
		<span class="cm">/* drop keeptest bit = VSV */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AXF_KEEPTEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">AXF_KEEPTEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AXF_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">ax_bump</span><span class="p">(</span><span class="n">ax</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">AXF_ESCAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ESC</span>:
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AXF_ESCAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESC_ESC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AXF_ESCAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">ESC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ESC_END</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">AXF_ESCAPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">END</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AXF_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">&lt;</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">[</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">AXF_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ax_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_ax25</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sax25_call</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
	<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*---------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ax_changedmtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xbuff</span><span class="p">,</span> <span class="o">*</span><span class="n">rbuff</span><span class="p">,</span> <span class="o">*</span><span class="n">oxbuff</span><span class="p">,</span> <span class="o">*</span><span class="n">orbuff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allow for arrival of larger UDP packets, even if we say not to</span>
<span class="cm">	 * also fixes a bug in which SunOS sends 512-byte packets even with</span>
<span class="cm">	 * an MSS of 128</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">576</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">576</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">xbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">rbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xbuff</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">rbuff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mkiss: %s: unable to grow ax25 buffers, &quot;</span>
		       <span class="s">&quot;MTU change cancelled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xbuff</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rbuff</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>

	<span class="n">oxbuff</span>    <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span> <span class="o">=</span> <span class="n">xbuff</span><span class="p">;</span>
	<span class="n">orbuff</span>    <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span> <span class="o">=</span> <span class="n">rbuff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xhead</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
			<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">,</span> <span class="n">orbuff</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
			<span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">AXF_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">mtu</span>      <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">73</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">oxbuff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">orbuff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Encapsulate one AX.25 packet and stuff into a TTY queue. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ax_encaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">icp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">!=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">73</span><span class="p">)</span>	<span class="cm">/* Someone has been ifconfigging */</span>
		<span class="n">ax_changedmtu</span><span class="p">(</span><span class="n">ax</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Sigh, shouldn&#39;t occur BUT ... */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mkiss: %s: truncating oversized transmit packet!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">icp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Configuration Command (kissparms(1).</span>
<span class="cm">		 * Protocol spec says: never append CRC.</span>
<span class="cm">		 * This fixes a very old bug in the linux</span>
<span class="cm">		 * kiss driver. -- dl9sau */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x85</span>:
			<span class="cm">/* command from userspace especially for us,</span>
<span class="cm">			 * not for delivery to the tnc */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">3</span>:
				  <span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">=</span> <span class="n">CRC_MODE_SMACK</span><span class="p">;</span>
				  <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
				  <span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">=</span> <span class="n">CRC_MODE_FLEX</span><span class="p">;</span>
				  <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">1</span>:
				  <span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">=</span> <span class="n">CRC_MODE_NONE</span><span class="p">;</span>
				  <span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">0</span>:
				<span class="nl">default:</span>
				  <span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">=</span> <span class="n">CRC_MODE_SMACK_TEST</span><span class="p">;</span>
				  <span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcauto</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mkiss: %s: crc mode %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;set to&quot;</span> <span class="o">:</span> <span class="s">&quot;is&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
			<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">kiss_esc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">crc</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CRC_MODE_SMACK_TEST</span>:
			<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span>  <span class="o">=</span> <span class="n">CRC_MODE_FLEX_TEST</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mkiss: %s: Trying crc-smack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>fall through</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">CRC_MODE_SMACK</span>:
			<span class="o">*</span><span class="n">p</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">crc16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">kiss_esc_crc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CRC_MODE_FLEX_TEST</span>:
			<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span> <span class="o">=</span> <span class="n">CRC_MODE_NONE</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mkiss: %s: Trying crc-flexnet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>fall through</p></td><td class="code"><div class="highlight"><pre>		<span class="k">case</span> <span class="n">CRC_MODE_FLEX</span>:
			<span class="o">*</span><span class="n">p</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">calc_crc_flex</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">kiss_esc_crc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">kiss_esc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
  	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">actual</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">actual</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span> <span class="o">+</span> <span class="n">actual</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Encapsulate an AX.25 packet and kick it into a TTY queue. */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ax_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>  <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mkiss: %s: xmit call when iface is down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * May be we must check transmitter timeout here ?</span>
<span class="cm">		 *      14 Oct 1994 Dmitry Gorodchanin.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* 20 sec timeout not reached */</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mkiss: %s: transmit timed out, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">tty_chars_in_buffer</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">)</span> <span class="o">||</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span><span class="p">)</span> <span class="o">?</span>
		       <span class="s">&quot;bad line quality&quot;</span> <span class="o">:</span> <span class="s">&quot;driver error&quot;</span><span class="p">);</span>

		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We were not busy, so we are now... :-) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ax_encaps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ax_open_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_AX25) || defined(CONFIG_AX25_MODULE)</span>

<span class="cm">/* Return the frame type ID */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ax_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_INET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ETH_P_AX25</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ax25_hard_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ax_rebuild_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_INET</span>
	<span class="k">return</span> <span class="n">ax25_rebuild_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_{AX25,AX25_MODULE} */</span><span class="cp"></span>

<span class="cm">/* Open the low-level part of the AX25 channel. Easy! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ax_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the frame buffers:</span>
<span class="cm">	 *</span>
<span class="cm">	 * rbuff	Receive buffer.</span>
<span class="cm">	 * xbuff	Transmit buffer.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * allow for arrival of larger UDP packets, even if we say not to</span>
<span class="cm">	 * also fixes a bug in which SunOS sends 512-byte packets even with</span>
<span class="cm">	 * an MSS of 128</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">576</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">576</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">norbuff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">noxbuff</span><span class="p">;</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">mtu</span>	     <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">73</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">rcount</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span>   <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AXF_INUSE</span><span class="p">);</span>      <span class="cm">/* Clear ESCAPE &amp; ERROR flags */</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">noxbuff:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">);</span>

<span class="nl">norbuff:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Close the low-level part of the AX25 channel. Easy! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ax_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">header_ops</span> <span class="n">ax_header_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span>    <span class="o">=</span> <span class="n">ax_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rebuild</span>   <span class="o">=</span> <span class="n">ax_rebuild_header</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ax_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>            <span class="o">=</span> <span class="n">ax_open_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>            <span class="o">=</span> <span class="n">ax_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>	     <span class="o">=</span> <span class="n">ax_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">ax_set_mac_address</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ax_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Finish setting up the DEVICE info. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span>             <span class="o">=</span> <span class="n">AX_MTU</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>            <span class="o">=</span> <span class="n">ARPHRD_AX25</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>    <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ax_header_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	     <span class="o">=</span> <span class="o">&amp;</span><span class="n">ax_netdev_ops</span><span class="p">;</span>


	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax25_bcast</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">ax25_defaddr</span><span class="p">,</span>  <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">IFF_BROADCAST</span> <span class="o">|</span> <span class="n">IFF_MULTICAST</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We have a potential race on dereferencing tty-&gt;disc_data, because the tty</span>
<span class="cm"> * layer provides no locking at all - thus one cpu could be running</span>
<span class="cm"> * sixpack_receive_buf while another calls sixpack_close, which zeroes</span>
<span class="cm"> * tty-&gt;disc_data and frees the memory that sixpack_receive_buf is using.  The</span>
<span class="cm"> * best way to fix this is to use a rwlock in the tty struct, but for now we</span>
<span class="cm"> * use a single global rwlock for all ttys in ppp line discipline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">disc_data_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="nf">mkiss_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>
	<span class="n">ax</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ax</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mkiss_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">dead_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">crc_force</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Can be overridden with insmod */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mkiss_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mkiss</span><span class="p">),</span> <span class="s">&quot;ax%d&quot;</span><span class="p">,</span> <span class="n">ax_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ax</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">buflock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">dead_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="n">ax</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="n">tty_driver_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="cm">/* Restore default settings */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_AX25</span><span class="p">;</span>

	<span class="cm">/* Perform the low-level AX25 initialization. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">ax_open</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free_buffers</span><span class="p">;</span>

	<span class="cm">/* after register_netdev() - because else printk smashes the kernel */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">crc_force</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span>  <span class="o">=</span> <span class="n">CRC_MODE_SMACK</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mkiss: %s: crc mode smack forced.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span>  <span class="o">=</span> <span class="n">CRC_MODE_FLEX</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mkiss: %s: crc mode flexnet forced.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span>  <span class="o">=</span> <span class="n">CRC_MODE_NONE</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mkiss: %s: crc mode disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* fall through */</span>
	<span class="nl">default:</span>
		<span class="n">crc_force</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;mkiss: %s: crc mode is auto.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcmode</span>  <span class="o">=</span> <span class="n">CRC_MODE_SMACK_TEST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">crcauto</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc_force</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Done.  We have linked the TTY line to a channel. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_buffers:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">);</span>

<span class="nl">out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mkiss_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>
	<span class="n">ax</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ax</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have now ensured that nobody can start using ap from now on, but</span>
<span class="cm">	 * we have to wait for all existing users to finish.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">dead_sem</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Free all AX25 frame buffers. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">);</span>

	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform I/O control on an active ax25 channel. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mkiss_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">mkiss_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* First make sure we&#39;re connected. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
 	<span class="k">case</span> <span class="n">SIOCGIFNAME</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		                   <span class="n">strlen</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIFENCAP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFENCAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ax</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>        <span class="o">=</span> <span class="n">AX25_ADDR_LEN</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="n">AX25_KISS_HEADER_LEN</span> <span class="o">+</span>
		                       <span class="n">AX25_MAX_HEADER_LEN</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>            <span class="o">=</span> <span class="n">ARPHRD_AX25</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFHWADDR</span>: <span class="p">{</span>
		<span class="kt">char</span> <span class="n">addr</span><span class="p">[</span><span class="n">AX25_ADDR_LEN</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
		                   <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
		<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mkiss_put</span><span class="p">(</span><span class="n">ax</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">mkiss_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGIFNAME</span>:
	<span class="k">case</span> <span class="n">SIOCGIFENCAP</span>:
	<span class="k">case</span> <span class="n">SIOCSIFENCAP</span>:
	<span class="k">case</span> <span class="n">SIOCSIFHWADDR</span>:
		<span class="k">return</span> <span class="n">mkiss_ioctl</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the &#39;receiver data ready&#39; interrupt.</span>
<span class="cm"> * This function is called by the &#39;tty_io&#39; module in the kernel when</span>
<span class="cm"> * a block of data has been received, which can now be decapsulated</span>
<span class="cm"> * and sent on to the AX.25 layer for further processing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mkiss_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">mkiss_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ax</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Argh! mtu change time! - costs us the packet part received</span>
<span class="cm">	 * at the change</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">!=</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="mi">73</span><span class="p">)</span>
		<span class="n">ax_changedmtu</span><span class="p">(</span><span class="n">ax</span><span class="p">);</span>

	<span class="cm">/* Read the characters out of the buffer */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">AXF_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kiss_unesc</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mkiss_put</span><span class="p">(</span><span class="n">ax</span><span class="p">);</span>
	<span class="n">tty_unthrottle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the driver when there&#39;s room for more data.  If we have</span>
<span class="cm"> * more packets to send, we send them here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mkiss_write_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mkiss</span> <span class="o">*</span><span class="n">ax</span> <span class="o">=</span> <span class="n">mkiss_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ax</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
		<span class="cm">/* Now serial buffer is almost free &amp; we can start</span>
<span class="cm">		 * transmission of another packet</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ax</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">actual</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xhead</span><span class="p">,</span> <span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span><span class="p">);</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
	<span class="n">ax</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mkiss_put</span><span class="p">(</span><span class="n">ax</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="n">ax_ldisc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">magic</span>		<span class="o">=</span> <span class="n">TTY_LDISC_MAGIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;mkiss&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mkiss_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">mkiss_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">mkiss_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">mkiss_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">receive_buf</span>	<span class="o">=</span> <span class="n">mkiss_receive_buf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_wakeup</span>	<span class="o">=</span> <span class="n">mkiss_write_wakeup</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">banner</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">KERN_INFO</span> \
	<span class="s">&quot;mkiss: AX.25 Multikiss, Hans Albas PE1AYX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">msg_regfail</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">KERN_ERR</span> \
	<span class="s">&quot;mkiss: can&#39;t register line discipline (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">mkiss_init_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">banner</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">tty_register_ldisc</span><span class="p">(</span><span class="n">N_AX25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax_ldisc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">msg_regfail</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">msg_unregfail</span><span class="p">[]</span> <span class="n">__exitdata</span> <span class="o">=</span> <span class="n">KERN_ERR</span> \
	<span class="s">&quot;mkiss: can&#39;t unregister line discipline (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">mkiss_exit_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">tty_unregister_ldisc</span><span class="p">(</span><span class="n">N_AX25</span><span class="p">)))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">msg_unregfail</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralf Baechle DL5RB &lt;ralf@linux-mips.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;KISS driver for AX.25 over TTYs&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">crc_force</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">crc_force</span><span class="p">,</span> <span class="s">&quot;crc [0 = auto | 1 = none | 2 = flexnet | 3 = smack]&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_LDISC</span><span class="p">(</span><span class="n">N_AX25</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">mkiss_init_driver</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">mkiss_exit_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
