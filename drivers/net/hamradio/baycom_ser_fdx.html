<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hamradio › baycom_ser_fdx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>baycom_ser_fdx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *	baycom_ser_fdx.c  -- baycom ser12 fullduplex radio modem driver.</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1996-2000  Thomas Sailer (sailer@ife.ee.ethz.ch)</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *	GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *	You should have received a copy of the GNU General Public License</span>
<span class="cm"> *	along with this program; if not, write to the Free Software</span>
<span class="cm"> *	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *  Please note that the GPL allows you to use the driver, NOT the radio.</span>
<span class="cm"> *  In order to use the radio, you need a license from the communications</span>
<span class="cm"> *  authority of your country.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Supported modems</span>
<span class="cm"> *</span>
<span class="cm"> *  ser12:  This is a very simple 1200 baud AFSK modem. The modem consists only</span>
<span class="cm"> *          of a modulator/demodulator chip, usually a TI TCM3105. The computer</span>
<span class="cm"> *          is responsible for regenerating the receiver bit clock, as well as</span>
<span class="cm"> *          for handling the HDLC protocol. The modem connects to a serial port,</span>
<span class="cm"> *          hence the name. Since the serial port is not used as an async serial</span>
<span class="cm"> *          port, the kernel driver for serial ports cannot be used, and this</span>
<span class="cm"> *          driver only supports standard serial hardware (8250, 16450, 16550A)</span>
<span class="cm"> *</span>
<span class="cm"> *          This modem usually draws its supply current out of the otherwise unused</span>
<span class="cm"> *          TXD pin of the serial port. Thus a contiguous stream of 0x00-bytes</span>
<span class="cm"> *          is transmitted to achieve a positive supply voltage.</span>
<span class="cm"> *</span>
<span class="cm"> *  hsk:    This is a 4800 baud FSK modem, designed for TNC use. It works fine</span>
<span class="cm"> *          in &#39;baycom-mode&#39; :-)  In contrast to the TCM3105 modem, power is</span>
<span class="cm"> *          externally supplied. So there&#39;s no need to provide the 0x00-byte-stream</span>
<span class="cm"> *          when receiving or idle, which drastically reduces interrupt load.</span>
<span class="cm"> *</span>
<span class="cm"> *  Command line options (insmod command line)</span>
<span class="cm"> *</span>
<span class="cm"> *  mode     ser#    hardware DCD</span>
<span class="cm"> *           ser#*   software DCD</span>
<span class="cm"> *           ser#+   hardware DCD, inverted signal at DCD pin</span>
<span class="cm"> *           &#39;#&#39; denotes the baud rate / 100, eg. ser12* is &#39;1200 baud, soft DCD&#39;</span>
<span class="cm"> *  iobase   base address of the port; common values are 0x3f8, 0x2f8, 0x3e8, 0x2e8</span>
<span class="cm"> *  baud     baud rate (between 300 and 4800)</span>
<span class="cm"> *  irq      interrupt line of the port; common values are 4,3</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  History:</span>
<span class="cm"> *   0.1  26.06.1996  Adapted from baycom.c and made network driver interface</span>
<span class="cm"> *        18.10.1996  Changed to new user space access routines (copy_{to,from}_user)</span>
<span class="cm"> *   0.3  26.04.1997  init code/data tagged</span>
<span class="cm"> *   0.4  08.07.1997  alternative ser12 decoding algorithm (uses delta CTS ints)</span>
<span class="cm"> *   0.5  11.11.1997  ser12/par96 split into separate files</span>
<span class="cm"> *   0.6  24.01.1998  Thorsten Kranzkowski, dl8bcu and Thomas Sailer:</span>
<span class="cm"> *                    reduced interrupt load in transmit case</span>
<span class="cm"> *                    reworked receiver</span>
<span class="cm"> *   0.7  03.08.1999  adapt to Linus&#39; new __setup/__initcall</span>
<span class="cm"> *   0.8  10.08.1999  use module_init/module_exit</span>
<span class="cm"> *   0.9  12.02.2000  adapted to softnet driver interface</span>
<span class="cm"> *   0.10 03.07.2000  fix interface name handling</span>
<span class="cm"> */</span>

<span class="cm">/*****************************************************************************/</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/hdlcdrv.h&gt;</span>
<span class="cp">#include &lt;linux/baycom.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define BAYCOM_DEBUG</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">bc_drvname</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;baycom_ser_fdx&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">bc_drvinfo</span><span class="p">[]</span> <span class="o">=</span> <span class="n">KERN_INFO</span> <span class="s">&quot;baycom_ser_fdx: (C) 1996-2000 Thomas Sailer, HB9JNX/AE4WA</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;baycom_ser_fdx: version 0.10</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define NR_PORTS 4</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">baycom_device</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define RBR(iobase) (iobase+0)</span>
<span class="cp">#define THR(iobase) (iobase+0)</span>
<span class="cp">#define IER(iobase) (iobase+1)</span>
<span class="cp">#define IIR(iobase) (iobase+2)</span>
<span class="cp">#define FCR(iobase) (iobase+2)</span>
<span class="cp">#define LCR(iobase) (iobase+3)</span>
<span class="cp">#define MCR(iobase) (iobase+4)</span>
<span class="cp">#define LSR(iobase) (iobase+5)</span>
<span class="cp">#define MSR(iobase) (iobase+6)</span>
<span class="cp">#define SCR(iobase) (iobase+7)</span>
<span class="cp">#define DLL(iobase) (iobase+0)</span>
<span class="cp">#define DLM(iobase) (iobase+1)</span>

<span class="cp">#define SER12_EXTENT 8</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * Information that need to be kept for each board.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">baycom_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="n">hdrv</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">,</span> <span class="n">baud_us</span><span class="p">,</span> <span class="n">baud_arbdiv</span><span class="p">,</span> <span class="n">baud_uartdiv</span><span class="p">,</span> <span class="n">baud_dcdtimeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opt_dcd</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">modem_state</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ptt</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shreg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">modem_state_ser12</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_bit</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">last_rxbit</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">dcd_sum0</span><span class="p">,</span> <span class="n">dcd_sum1</span><span class="p">,</span> <span class="n">dcd_sum2</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">dcd_time</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pll_time</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txshreg</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">ser12</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">modem</span><span class="p">;</span>

<span class="cp">#ifdef BAYCOM_DEBUG</span>
	<span class="k">struct</span> <span class="n">debug_vals</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_jiffies</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">cur_intcnt</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">last_intcnt</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cur_pllcorr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">last_pllcorr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">debug_vals</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* BAYCOM_DEBUG */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">baycom_int_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BAYCOM_DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cur_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * measure the interrupt frequency</span>
<span class="cm">	 */</span>
	<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_intcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">cur_jiffies</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_jiffies</span> <span class="o">=</span> <span class="n">cur_jiffies</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_intcnt</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_intcnt</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_intcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_pllcorr</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_pllcorr</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_pllcorr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* BAYCOM_DEBUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * ===================== SER12 specific routines =========================</span>
<span class="cm"> */</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ser12_set_divisor</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
                                     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">divisor</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x81</span><span class="p">,</span> <span class="n">LCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>        <span class="cm">/* DLAB = 1 */</span>
        <span class="n">outb</span><span class="p">(</span><span class="n">divisor</span><span class="p">,</span> <span class="n">DLL</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
        <span class="n">outb</span><span class="p">(</span><span class="n">divisor</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">DLM</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">LCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>        <span class="cm">/* word length = 6 */</span>
        <span class="cm">/*</span>
<span class="cm">         * make sure the next interrupt is generated;</span>
<span class="cm">         * 0 must be used to power the modem; the modem draws its</span>
<span class="cm">         * power from the TxD line</span>
<span class="cm">         */</span>
        <span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">THR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
        <span class="cm">/*</span>
<span class="cm">         * it is important not to set the divider while transmitting;</span>
<span class="cm">         * this reportedly makes some UARTs generating interrupts</span>
<span class="cm">         * in the hundredthousands per second region</span>
<span class="cm">         * Reported by: Ignacio.Arenaza@studi.epfl.ch (Ignacio Arenaza Nuno)</span>
<span class="cm">         */</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static inline unsigned int hweight16(unsigned int w)</span>
<span class="c">        __attribute__ ((unused));</span>
<span class="c">static inline unsigned int hweight8(unsigned int w)</span>
<span class="c">        __attribute__ ((unused));</span>

<span class="c">static inline unsigned int hweight16(unsigned int w)</span>
<span class="c">{</span>
<span class="c">        unsigned short res = (w &amp; 0x5555) + ((w &gt;&gt; 1) &amp; 0x5555);</span>
<span class="c">        res = (res &amp; 0x3333) + ((res &gt;&gt; 2) &amp; 0x3333);</span>
<span class="c">        res = (res &amp; 0x0F0F) + ((res &gt;&gt; 4) &amp; 0x0F0F);</span>
<span class="c">        return (res &amp; 0x00FF) + ((res &gt;&gt; 8) &amp; 0x00FF);</span>
<span class="c">}</span>

<span class="c">static inline unsigned int hweight8(unsigned int w)</span>
<span class="c">{</span>
<span class="c">        unsigned short res = (w &amp; 0x55) + ((w &gt;&gt; 1) &amp; 0x55);</span>
<span class="c">        res = (res &amp; 0x33) + ((res &gt;&gt; 2) &amp; 0x33);</span>
<span class="c">        return (res &amp; 0x0F) + ((res &gt;&gt; 4) &amp; 0x0F);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">ser12_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timediff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bdus8</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_us</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bdus4</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_us</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bdus2</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_us</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">timediff</span> <span class="o">=</span> <span class="mi">1000000</span> <span class="o">+</span> <span class="n">tv</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">pll_time</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timediff</span> <span class="o">&gt;=</span> <span class="mi">500000</span><span class="p">)</span>
		<span class="n">timediff</span> <span class="o">-=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timediff</span> <span class="o">&gt;=</span> <span class="n">bdus2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timediff</span> <span class="o">-=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_us</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">pll_time</span> <span class="o">+=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_us</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_time</span><span class="o">--</span><span class="p">;</span>
		<span class="cm">/* first check if there is room to add a bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">shreg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdlcdrv_putbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">shreg</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">shreg</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* add a one bit */</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">shreg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span><span class="p">)</span>
			<span class="n">hdlcdrv_setdcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum0</span> <span class="o">+</span> 
						   <span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum1</span> <span class="o">+</span> 
						   <span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum2</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum1</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum1</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum0</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum0</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* slight bias */</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_time</span> <span class="o">+=</span> <span class="mi">120</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">last_rxbit</span> <span class="o">!=</span> <span class="n">curs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">last_rxbit</span> <span class="o">=</span> <span class="n">curs</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">shreg</span> <span class="o">|=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="cm">/* adjust the PLL */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timediff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">pll_time</span> <span class="o">+=</span> <span class="n">bdus8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">pll_time</span> <span class="o">+=</span> <span class="mi">1000000</span> <span class="o">-</span> <span class="n">bdus8</span><span class="p">;</span>
		<span class="cm">/* update DCD */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">timediff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">bdus4</span><span class="p">)</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum0</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">dcd_sum0</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#ifdef BAYCOM_DEBUG</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_pllcorr</span> <span class="o">=</span> <span class="n">timediff</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* BAYCOM_DEBUG */</span><span class="cp"></span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">pll_time</span> <span class="o">&gt;=</span> <span class="mi">1000000</span><span class="p">)</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">pll_time</span> <span class="o">-=</span> <span class="mi">1000000</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ser12_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iir</span><span class="p">,</span> <span class="n">msr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bc</span> <span class="o">||</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">HDLCDRV_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="cm">/* fast way out for shared irq */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">iir</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IIR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> 	
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="cm">/* get current time */</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="n">msr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="cm">/* delta DCD */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span><span class="p">)</span>
		<span class="n">hdlcdrv_setdcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="o">!</span><span class="p">((</span><span class="n">msr</span> <span class="o">^</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">inb</span><span class="p">(</span><span class="n">LSR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">inb</span><span class="p">(</span><span class="n">RBR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/*</span>
<span class="cm">			 * make sure the next interrupt is generated;</span>
<span class="cm">			 * 0 must be used to power the modem; the modem draws its</span>
<span class="cm">			 * power from the TxD line</span>
<span class="cm">			 */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">THR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
			<span class="n">baycom_int_freq</span><span class="p">(</span><span class="n">bc</span><span class="p">);</span>
			<span class="n">txcount</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * first output the last bit (!) then call HDLC transmitter,</span>
<span class="cm">			 * since this may take quite long</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ptt</span><span class="p">)</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x0e</span> <span class="o">|</span> <span class="p">(</span><span class="o">!!</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">tx_bit</span><span class="p">),</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">outb</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>       <span class="cm">/* transmitter off */</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="nl">default:</span>
			<span class="n">msr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
			<span class="cm">/* delta DCD */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span><span class="p">)</span> 
				<span class="n">hdlcdrv_setdcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="o">!</span><span class="p">((</span><span class="n">msr</span> <span class="o">^</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iir</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">IIR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iir</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">ser12_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">,</span> <span class="n">msr</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span> <span class="cm">/* CTS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ptt</span> <span class="o">&amp;&amp;</span> <span class="n">txcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">txshreg</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">txshreg</span> <span class="o">=</span> <span class="mh">0x10000</span> <span class="o">|</span> <span class="n">hdlcdrv_getbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdlcdrv_ptt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ser12_set_divisor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">115200</span><span class="o">/</span><span class="mi">100</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
				<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ptt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">end_transmit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">tx_bit</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">tx_bit</span> <span class="o">^</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">txshreg</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">txshreg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">end_transmit:</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ptt</span> <span class="o">&amp;&amp;</span> <span class="n">txcount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdlcdrv_arbitrate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdlcdrv_ptt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ser12_set_divisor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_uartdiv</span><span class="p">);</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ser12</span><span class="p">.</span><span class="n">txshreg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">ptt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hdlcdrv_transmitter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
	<span class="n">hdlcdrv_receiver</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">enum</span> <span class="n">uart</span> <span class="p">{</span> <span class="n">c_uart_unknown</span><span class="p">,</span> <span class="n">c_uart_8250</span><span class="p">,</span>
	    <span class="n">c_uart_16450</span><span class="p">,</span> <span class="n">c_uart_16550</span><span class="p">,</span> <span class="n">c_uart_16550A</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uart_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> 
	<span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="s">&quot;8250&quot;</span><span class="p">,</span> <span class="s">&quot;16450&quot;</span><span class="p">,</span> <span class="s">&quot;16550&quot;</span><span class="p">,</span> <span class="s">&quot;16550A&quot;</span> 
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">uart</span> <span class="nf">ser12_check_uart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">b3</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uart</span> <span class="n">u</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uart</span> <span class="n">uart_tab</span><span class="p">[]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="n">c_uart_16450</span><span class="p">,</span> <span class="n">c_uart_unknown</span><span class="p">,</span> <span class="n">c_uart_16550</span><span class="p">,</span> <span class="n">c_uart_16550A</span> <span class="p">};</span>

	<span class="n">b1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">b1</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* loopback mode */</span>
	<span class="n">b2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x1a</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">b3</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>			<span class="cm">/* restore old values */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b3</span> <span class="o">!=</span> <span class="mh">0x90</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c_uart_unknown</span><span class="p">;</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">RBR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">RBR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">FCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>		<span class="cm">/* enable FIFOs */</span>
	<span class="n">u</span> <span class="o">=</span> <span class="n">uart_tab</span><span class="p">[(</span><span class="n">inb</span><span class="p">(</span><span class="n">IIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">c_uart_16450</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x5a</span><span class="p">,</span> <span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xa5</span><span class="p">,</span> <span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">b1</span> <span class="o">!=</span> <span class="mh">0x5a</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b2</span> <span class="o">!=</span> <span class="mh">0xa5</span><span class="p">))</span>
			<span class="n">u</span> <span class="o">=</span> <span class="n">c_uart_8250</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ser12_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">uart</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">bc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="o">-</span><span class="n">SER12_EXTENT</span> <span class="o">||</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="n">nr_irqs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;baycom_ser_fdx: invalid portnumber (max %u) &quot;</span>
				<span class="s">&quot;or irq (2 &lt;= irq &lt;= %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="mh">0xffff</span><span class="o">-</span><span class="n">SER12_EXTENT</span><span class="p">,</span> <span class="n">nr_irqs</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="o">||</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">&gt;</span> <span class="mi">4800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;baycom_ser_fdx: invalid baudrate &quot;</span>
				<span class="s">&quot;(300...4800)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SER12_EXTENT</span><span class="p">,</span> <span class="s">&quot;baycom_ser_fdx&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;BAYCOM_SER_FSX: I/O port 0x%04lx busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">));</span>
	<span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">par</span><span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>
	<span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_us</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">/</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>
	<span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud_uartdiv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">115200</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">ser12_check_uart</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">))</span> <span class="o">==</span> <span class="n">c_uart_unknown</span><span class="p">){</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SER12_EXTENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>  <span class="cm">/* disable FIFOs */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0d</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ser12_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="s">&quot;baycom_ser_fdx&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SER12_EXTENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * set the SIO to 6 Bits/character; during receive,</span>
<span class="cm">	 * the baud rate is set to produce 100 ints/sec</span>
<span class="cm">	 * to feed the channel arbitration process,</span>
<span class="cm">	 * during transmit to baud ints/sec to run</span>
<span class="cm">	 * the transmitter</span>
<span class="cm">	 */</span>
	<span class="n">ser12_set_divisor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">115200</span><span class="o">/</span><span class="mi">100</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * enable transmitter empty interrupt and modem status interrupt</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0a</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * make sure the next interrupt is generated;</span>
<span class="cm">	 * 0 must be used to power the modem; the modem draws its</span>
<span class="cm">	 * power from the TxD line</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">THR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">hdlcdrv_setdcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: ser_fdx at iobase 0x%lx irq %u baud %u uart %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bc_drvname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span><span class="p">,</span> <span class="n">uart_str</span><span class="p">[</span><span class="n">u</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ser12_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">bc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * disable interrupts</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SER12_EXTENT</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: close ser_fdx at iobase 0x%lx irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bc_drvname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * ===================== hdlcdrv driver interface =========================</span>
<span class="cm"> */</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">baycom_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span> <span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hdlcdrv_ops</span> <span class="n">ser12_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drvname</span> <span class="o">=</span> <span class="n">bc_drvname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drvinfo</span> <span class="o">=</span> <span class="n">bc_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">ser12_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>   <span class="o">=</span> <span class="n">ser12_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>   <span class="o">=</span> <span class="n">baycom_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">baycom_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modestr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">modestr</span><span class="p">,</span> <span class="s">&quot;ser&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">baud</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">modestr</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baud</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">baud</span> <span class="o">&lt;=</span> <span class="mi">48</span><span class="p">)</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">baud</span><span class="o">*</span><span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">modestr</span><span class="p">,</span> <span class="sc">&#39;*&#39;</span><span class="p">))</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">modestr</span><span class="p">,</span> <span class="sc">&#39;+&#39;</span><span class="p">))</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">baycom_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span> <span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">baycom_ioctl</span> <span class="n">bi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">HDLCDRV_MAGIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCDEVPRIVATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_GETMODE</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">,</span> <span class="s">&quot;ser%u&quot;</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">,</span> <span class="p">(</span><span class="o">!</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">opt_dcd</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;*&quot;</span> <span class="o">:</span> <span class="s">&quot;+&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_SETMODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">baycom_setmode</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_MODELIST</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">,</span> <span class="s">&quot;ser12,ser3,ser24&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_MODEMPARMASK</span>:
		<span class="k">return</span> <span class="n">HDLCDRV_PARMASK_IOBASE</span> <span class="o">|</span> <span class="n">HDLCDRV_PARMASK_IRQ</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bi</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bi</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

<span class="cp">#ifdef BAYCOM_DEBUG</span>
	<span class="k">case</span> <span class="n">BAYCOMCTL_GETDEBUG</span>:
		<span class="n">bi</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">dbg</span><span class="p">.</span><span class="n">debug1</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">ptt_keyed</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">dbg</span><span class="p">.</span><span class="n">debug2</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_intcnt</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">dbg</span><span class="p">.</span><span class="n">debug3</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_pllcorr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* BAYCOM_DEBUG */</span><span class="cp"></span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bi</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * command line settable parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ser12*&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3f8</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">baud</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">NR_PORTS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1200</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;baycom operating mode; * for software DCD&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="s">&quot;baycom io base address&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;baycom irq number&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="s">&quot;baycom baud rate (300 to 4800)&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas M. Sailer, sailer@ife.ee.ethz.ch, hb9jnx@hb9w.che.eu&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Baycom ser12 full duplex amateur radio modem driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_baycomserfdx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">set_hw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">bc_drvinfo</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * register net devices</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">ifname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="s">&quot;bcsf%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">set_hw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_hw</span><span class="p">)</span>
			<span class="n">iobase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">hdlcdrv_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ser12_ops</span><span class="p">,</span> 
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">baycom_state</span><span class="p">),</span>
				       <span class="n">ifname</span><span class="p">,</span> <span class="n">iobase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> 
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_hw</span> <span class="o">&amp;&amp;</span> <span class="n">baycom_setmode</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">mode</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">set_hw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">baud</span> <span class="o">=</span> <span class="n">baud</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>
		<span class="n">baycom_device</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_baycomserfdx</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">baycom_device</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> 
			<span class="n">hdlcdrv_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_baycomserfdx</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_baycomserfdx</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#ifndef MODULE</span>

<span class="cm">/*</span>
<span class="cm"> * format: baycom_ser_fdx=io,irq,mode</span>
<span class="cm"> * mode: ser#    hardware DCD</span>
<span class="cm"> *       ser#*   software DCD</span>
<span class="cm"> *       ser#+   hardware DCD, inverted signal at DCD pin</span>
<span class="cm"> * &#39;#&#39; denotes the baud rate / 100, eg. ser12* is &#39;1200 baud, soft DCD&#39;</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">baycom_ser_fdx_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">static</span> <span class="kt">unsigned</span> <span class="n">nr_dev</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nr_dev</span> <span class="o">&gt;=</span> <span class="n">NR_PORTS</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mode</span><span class="p">[</span><span class="n">nr_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
        <span class="n">iobase</span><span class="p">[</span><span class="n">nr_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">irq</span><span class="p">[</span><span class="n">nr_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">baud</span><span class="p">[</span><span class="n">nr_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">nr_dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;baycom_ser_fdx=&quot;</span><span class="p">,</span> <span class="n">baycom_ser_fdx_setup</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
<span class="cm">/* --------------------------------------------------------------------- */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
