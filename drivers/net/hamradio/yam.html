<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hamradio › yam.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>yam.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *    yam.c  -- YAM radio modem driver.</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 1998 Frederic Rible F1OAT (frible@teaser.fr)</span>
<span class="cm"> *      Adapted from baycom.c driver written by Thomas Sailer (sailer@ife.ee.ethz.ch)</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *      it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *      (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *      but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *      GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *      You should have received a copy of the GNU General Public License</span>
<span class="cm"> *      along with this program; if not, write to the Free Software</span>
<span class="cm"> *      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *  Please note that the GPL allows you to use the driver, NOT the radio.</span>
<span class="cm"> *  In order to use the radio, you need a license from the communications</span>
<span class="cm"> *  authority of your country.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  History:</span>
<span class="cm"> *   0.0 F1OAT 06.06.98  Begin of work with baycom.c source code V 0.3</span>
<span class="cm"> *   0.1 F1OAT 07.06.98  Add timer polling routine for channel arbitration</span>
<span class="cm"> *   0.2 F6FBB 08.06.98  Added delay after FPGA programming</span>
<span class="cm"> *   0.3 F6FBB 29.07.98  Delayed PTT implementation for dupmode=2</span>
<span class="cm"> *   0.4 F6FBB 30.07.98  Added TxTail, Slottime and Persistence</span>
<span class="cm"> *   0.5 F6FBB 01.08.98  Shared IRQs, /proc/net and network statistics</span>
<span class="cm"> *   0.6 F6FBB 25.08.98  Added 1200Bds format</span>
<span class="cm"> *   0.7 F6FBB 12.09.98  Added to the kernel configuration</span>
<span class="cm"> *   0.8 F6FBB 14.10.98  Fixed slottime/persistence timing bug</span>
<span class="cm"> *       OK1ZIA 2.09.01  Fixed &quot;kfree_skb on hard IRQ&quot; </span>
<span class="cm"> *                       using dev_kfree_skb_any(). (important in 2.4 kernel)</span>
<span class="cm"> *   </span>
<span class="cm"> */</span>

<span class="cm">/*****************************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/net.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;net/ax25.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;linux/yam.h&gt;</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">yam_drvname</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;yam&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">yam_drvinfo</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">KERN_INFO</span> \
	<span class="s">&quot;YAM driver version 0.8 by F1OAT/F6FBB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define FIRMWARE_9600	&quot;yam/9600.bin&quot;</span>
<span class="cp">#define FIRMWARE_1200	&quot;yam/1200.bin&quot;</span>

<span class="cp">#define YAM_9600	1</span>
<span class="cp">#define YAM_1200	2</span>

<span class="cp">#define NR_PORTS	4</span>
<span class="cp">#define YAM_MAGIC	0xF10A7654</span>

<span class="cm">/* Transmitter states */</span>

<span class="cp">#define TX_OFF		0</span>
<span class="cp">#define TX_HEAD		1</span>
<span class="cp">#define TX_DATA		2</span>
<span class="cp">#define TX_CRC1		3</span>
<span class="cp">#define TX_CRC2		4</span>
<span class="cp">#define TX_TAIL		5</span>

<span class="cp">#define YAM_MAX_FRAME	1024</span>

<span class="cp">#define DEFAULT_BITRATE	9600			</span><span class="cm">/* bps */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_HOLDD	10			</span><span class="cm">/* sec */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_TXD	300			</span><span class="cm">/* ms */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_TXTAIL	10			</span><span class="cm">/* ms */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_SLOT	100			</span><span class="cm">/* ms */</span><span class="cp"></span>
<span class="cp">#define DEFAULT_PERS	64			</span><span class="cm">/* 0-&gt;255 */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">yam_port</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bitrate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">baudrate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dupmode</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">nb_rxint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nb_mdint</span><span class="p">;</span>

	<span class="cm">/* Parameters section */</span>

	<span class="kt">int</span> <span class="n">txd</span><span class="p">;</span>				<span class="cm">/* tx delay */</span>
	<span class="kt">int</span> <span class="n">holdd</span><span class="p">;</span>				<span class="cm">/* duplex ptt delay */</span>
	<span class="kt">int</span> <span class="n">txtail</span><span class="p">;</span>				<span class="cm">/* txtail delay */</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>				<span class="cm">/* slottime */</span>
	<span class="kt">int</span> <span class="n">pers</span><span class="p">;</span>				<span class="cm">/* persistence */</span>

	<span class="cm">/* Tx section */</span>

	<span class="kt">int</span> <span class="n">tx_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slotcnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_buf</span><span class="p">[</span><span class="n">YAM_MAX_FRAME</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tx_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_crcl</span><span class="p">,</span> <span class="n">tx_crch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">send_queue</span><span class="p">;</span>		<span class="cm">/* Packets awaiting transmission */</span>

	<span class="cm">/* Rx section */</span>

	<span class="kt">int</span> <span class="n">dcd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_buf</span><span class="p">[</span><span class="n">YAM_MAX_FRAME</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rx_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_crcl</span><span class="p">,</span> <span class="n">rx_crch</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">yam_mcs</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">[</span><span class="n">YAM_FPGA_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bitrate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yam_mcs</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">yam_devs</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">yam_mcs</span> <span class="o">*</span><span class="n">yam_data</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">yam_timer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define RBR(iobase)	(iobase+0)</span>
<span class="cp">#define THR(iobase)	(iobase+0)</span>
<span class="cp">#define IER(iobase)	(iobase+1)</span>
<span class="cp">#define IIR(iobase)	(iobase+2)</span>
<span class="cp">#define FCR(iobase)	(iobase+2)</span>
<span class="cp">#define LCR(iobase)	(iobase+3)</span>
<span class="cp">#define MCR(iobase)	(iobase+4)</span>
<span class="cp">#define LSR(iobase)	(iobase+5)</span>
<span class="cp">#define MSR(iobase)	(iobase+6)</span>
<span class="cp">#define SCR(iobase)	(iobase+7)</span>
<span class="cp">#define DLL(iobase)	(iobase+0)</span>
<span class="cp">#define DLM(iobase)	(iobase+1)</span>

<span class="cp">#define YAM_EXTENT	8</span>

<span class="cm">/* Interrupt Identification Register Bit Masks */</span>
<span class="cp">#define IIR_NOPEND	1</span>
<span class="cp">#define IIR_MSR		0</span>
<span class="cp">#define IIR_TX		2</span>
<span class="cp">#define IIR_RX		4</span>
<span class="cp">#define IIR_LSR		6</span>
<span class="cp">#define IIR_TIMEOUT	12			</span><span class="cm">/* Fifo mode only */</span><span class="cp"></span>

<span class="cp">#define IIR_MASK	0x0F</span>

<span class="cm">/* Interrupt Enable Register Bit Masks */</span>
<span class="cp">#define IER_RX		1			</span><span class="cm">/* enable rx interrupt */</span><span class="cp"></span>
<span class="cp">#define IER_TX		2			</span><span class="cm">/* enable tx interrupt */</span><span class="cp"></span>
<span class="cp">#define IER_LSR		4			</span><span class="cm">/* enable line status interrupts */</span><span class="cp"></span>
<span class="cp">#define IER_MSR		8			</span><span class="cm">/* enable modem status interrupts */</span><span class="cp"></span>

<span class="cm">/* Modem Control Register Bit Masks */</span>
<span class="cp">#define MCR_DTR		0x01			</span><span class="cm">/* DTR output */</span><span class="cp"></span>
<span class="cp">#define MCR_RTS		0x02			</span><span class="cm">/* RTS output */</span><span class="cp"></span>
<span class="cp">#define MCR_OUT1	0x04			</span><span class="cm">/* OUT1 output (not accessible in RS232) */</span><span class="cp"></span>
<span class="cp">#define MCR_OUT2	0x08			</span><span class="cm">/* Master Interrupt enable (must be set on PCs) */</span><span class="cp"></span>
<span class="cp">#define MCR_LOOP	0x10			</span><span class="cm">/* Loopback enable */</span><span class="cp"></span>

<span class="cm">/* Modem Status Register Bit Masks */</span>
<span class="cp">#define MSR_DCTS	0x01			</span><span class="cm">/* Delta CTS input */</span><span class="cp"></span>
<span class="cp">#define MSR_DDSR	0x02			</span><span class="cm">/* Delta DSR */</span><span class="cp"></span>
<span class="cp">#define MSR_DRIN	0x04			</span><span class="cm">/* Delta RI */</span><span class="cp"></span>
<span class="cp">#define MSR_DDCD	0x08			</span><span class="cm">/* Delta DCD */</span><span class="cp"></span>
<span class="cp">#define MSR_CTS		0x10			</span><span class="cm">/* CTS input */</span><span class="cp"></span>
<span class="cp">#define MSR_DSR		0x20			</span><span class="cm">/* DSR input */</span><span class="cp"></span>
<span class="cp">#define MSR_RING	0x40			</span><span class="cm">/* RI  input */</span><span class="cp"></span>
<span class="cp">#define MSR_DCD		0x80			</span><span class="cm">/* DCD input */</span><span class="cp"></span>

<span class="cm">/* line status register bit mask */</span>
<span class="cp">#define LSR_RXC		0x01</span>
<span class="cp">#define LSR_OE		0x02</span>
<span class="cp">#define LSR_PE		0x04</span>
<span class="cp">#define LSR_FE		0x08</span>
<span class="cp">#define LSR_BREAK	0x10</span>
<span class="cp">#define LSR_THRE	0x20</span>
<span class="cp">#define LSR_TSRE	0x40</span>

<span class="cm">/* Line Control Register Bit Masks */</span>
<span class="cp">#define LCR_DLAB	0x80</span>
<span class="cp">#define LCR_BREAK	0x40</span>
<span class="cp">#define LCR_PZERO	0x28</span>
<span class="cp">#define LCR_PEVEN	0x18</span>
<span class="cp">#define LCR_PODD	0x08</span>
<span class="cp">#define LCR_STOP1	0x00</span>
<span class="cp">#define LCR_STOP2	0x04</span>
<span class="cp">#define LCR_BIT5	0x00</span>
<span class="cp">#define LCR_BIT6	0x02</span>
<span class="cp">#define LCR_BIT7	0x01</span>
<span class="cp">#define LCR_BIT8	0x03</span>

<span class="cm">/* YAM Modem &lt;-&gt; UART Port mapping */</span>

<span class="cp">#define TX_RDY		MSR_DCTS		</span><span class="cm">/* transmitter ready to send */</span><span class="cp"></span>
<span class="cp">#define RX_DCD		MSR_DCD			</span><span class="cm">/* carrier detect */</span><span class="cp"></span>
<span class="cp">#define RX_FLAG		MSR_RING		</span><span class="cm">/* hdlc flag received */</span><span class="cp"></span>
<span class="cp">#define FPGA_DONE	MSR_DSR			</span><span class="cm">/* FPGA is configured */</span><span class="cp"></span>
<span class="cp">#define PTT_ON		(MCR_RTS|MCR_OUT2)	</span><span class="cm">/* activate PTT */</span><span class="cp"></span>
<span class="cp">#define PTT_OFF		(MCR_DTR|MCR_OUT2)	</span><span class="cm">/* release PTT */</span><span class="cp"></span>

<span class="cp">#define ENABLE_RXINT	IER_RX			</span><span class="cm">/* enable uart rx interrupt during rx */</span><span class="cp"></span>
<span class="cp">#define ENABLE_TXINT	IER_MSR			</span><span class="cm">/* enable uart ms interrupt during tx */</span><span class="cp"></span>
<span class="cp">#define ENABLE_RTXINT	(IER_RX|IER_MSR)	</span><span class="cm">/* full duplex operations */</span><span class="cp"></span>


<span class="cm">/*************************************************************************</span>
<span class="cm">* CRC Tables</span>
<span class="cm">************************************************************************/</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">chktabl</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span>
 <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span>
 <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
 <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span>
 <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>
 <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span>
 <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span>
 <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span>
 <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
 <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span>
 <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
 <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
 <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
 <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span>
 <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">,</span>
 <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">,</span>
 <span class="mh">0x78</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">chktabh</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span> <span class="mh">0xaf</span><span class="p">,</span> <span class="mh">0xbe</span><span class="p">,</span> <span class="mh">0xca</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span>
 <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0xae</span><span class="p">,</span> <span class="mh">0xda</span><span class="p">,</span> <span class="mh">0xcb</span><span class="p">,</span>
 <span class="mh">0xf9</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x8e</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
 <span class="mh">0xfa</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0xd9</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span>
 <span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0xed</span><span class="p">,</span>
 <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0xab</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">,</span>
 <span class="mh">0xfd</span><span class="p">,</span> <span class="mh">0xec</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xef</span><span class="p">,</span>
 <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
 <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xcd</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0xb6</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
 <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x2b</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">,</span> <span class="mh">0xa6</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span>
 <span class="mh">0xf1</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
 <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span>
 <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0xd7</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
 <span class="mh">0xf4</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0xd6</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span>
 <span class="mh">0xf5</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span>
 <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span>
 <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span> <span class="mh">0xd4</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span>
 <span class="mh">0x0f</span><span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm">* FPGA functions</span>
<span class="cm">************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delay</span><span class="p">(</span><span class="kt">int</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="n">ms</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reset FPGA</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fpga_reset</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">LCR_DLAB</span> <span class="o">|</span> <span class="n">LCR_BIT5</span><span class="p">,</span> <span class="n">LCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DLL</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DLM</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">LCR_BIT5</span><span class="p">,</span> <span class="n">LCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">LSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="cm">/* turn off FPGA supply voltage */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MCR_OUT1</span> <span class="o">|</span> <span class="n">MCR_OUT2</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* turn on FPGA supply voltage again */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">MCR_DTR</span> <span class="o">|</span> <span class="n">MCR_RTS</span> <span class="o">|</span> <span class="n">MCR_OUT1</span> <span class="o">|</span> <span class="n">MCR_OUT2</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send one byte to FPGA</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpga_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">wrd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrd</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">MCR_RTS</span> <span class="o">|</span> <span class="n">MCR_DTR</span><span class="p">)</span> <span class="o">:</span> <span class="n">MCR_DTR</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">bit</span> <span class="o">|</span> <span class="n">MCR_OUT1</span> <span class="o">|</span> <span class="n">MCR_OUT2</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">wrd</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xfc</span><span class="p">,</span> <span class="n">THR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">LSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">LSR_TSRE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * predef should be 0 for loading user defined mcs</span>
<span class="cm"> * predef should be YAM_1200 for loading predef 1200 mcs</span>
<span class="cm"> * predef should be YAM_9600 for loading predef 9600 mcs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">add_mcs</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitrate</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">predef</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">FIRMWARE_9600</span><span class="p">,</span> <span class="n">FIRMWARE_1200</span><span class="p">};</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yam_mcs</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">predef</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">YAM_1200</span>:
	<span class="k">case</span> <span class="n">YAM_9600</span>:
		<span class="n">predef</span><span class="o">--</span><span class="p">;</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;yam&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;yam: Failed to register firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">[</span><span class="n">predef</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to load firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fw_name</span><span class="p">[</span><span class="n">predef</span><span class="p">]);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">YAM_FPGA_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Bogus length %zu in firmware </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">[</span><span class="n">predef</span><span class="p">]);</span>
			<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;yam: Invalid predef number %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">predef</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If it already exists, replace the bit data */</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">yam_data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">bitrate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">YAM_FPGA_SIZE</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a new mcs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">yam_mcs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">YAM_FPGA_SIZE</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">yam_data</span><span class="p">;</span>
	<span class="n">yam_data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_mcs</span><span class="p">(</span><span class="kt">int</span> <span class="n">bitrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_mcs</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">yam_data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">bitrate</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Load predefined mcs data */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bitrate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1200</span>:
		<span class="cm">/* setting predef as YAM_1200 for loading predef 1200 mcs */</span>
		<span class="k">return</span> <span class="n">add_mcs</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">YAM_1200</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="cm">/* setting predef as YAM_9600 for loading predef 9600 mcs */</span>
		<span class="k">return</span> <span class="n">add_mcs</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">bitrate</span><span class="p">,</span> <span class="n">YAM_9600</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * download bitstream to FPGA</span>
<span class="cm"> * data is contained in bits[] array in yam1200.h resp. yam9600.h</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fpga_download</span><span class="p">(</span><span class="kt">int</span> <span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bitrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pbits</span><span class="p">;</span>

	<span class="n">pbits</span> <span class="o">=</span> <span class="n">get_mcs</span><span class="p">(</span><span class="n">bitrate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbits</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">fpga_reset</span><span class="p">(</span><span class="n">iobase</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">YAM_FPGA_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fpga_write</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="n">pbits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;yam: error in write cycle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>			<span class="cm">/* write... */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fpga_write</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>		<span class="cm">/* check DONE signal */</span>

	<span class="cm">/* Needed for some hardwares */</span>
	<span class="n">delay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="n">MSR_DSR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/************************************************************************</span>
<span class="cm">* Serial port init </span>
<span class="cm">************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">yam_set_uart</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">115200</span> <span class="o">/</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">baudrate</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">LCR_DLAB</span> <span class="o">|</span> <span class="n">LCR_BIT8</span><span class="p">,</span> <span class="n">LCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">divisor</span><span class="p">,</span> <span class="n">DLL</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DLM</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">LCR_BIT8</span><span class="p">,</span> <span class="n">LCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">PTT_OFF</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">FCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>

	<span class="cm">/* Flush pending irq */</span>

	<span class="n">inb</span><span class="p">(</span><span class="n">RBR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>

	<span class="cm">/* Enable rx irq */</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ENABLE_RTXINT</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">enum</span> <span class="n">uart</span> <span class="p">{</span>
	<span class="n">c_uart_unknown</span><span class="p">,</span> <span class="n">c_uart_8250</span><span class="p">,</span>
	<span class="n">c_uart_16450</span><span class="p">,</span> <span class="n">c_uart_16550</span><span class="p">,</span> <span class="n">c_uart_16550A</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uart_str</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span><span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="s">&quot;8250&quot;</span><span class="p">,</span> <span class="s">&quot;16450&quot;</span><span class="p">,</span> <span class="s">&quot;16550&quot;</span><span class="p">,</span> <span class="s">&quot;16550A&quot;</span><span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">uart</span> <span class="nf">yam_check_uart</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uart</span> <span class="n">u</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">uart</span> <span class="n">uart_tab</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span><span class="n">c_uart_16450</span><span class="p">,</span> <span class="n">c_uart_unknown</span><span class="p">,</span> <span class="n">c_uart_16550</span><span class="p">,</span> <span class="n">c_uart_16550A</span><span class="p">};</span>

	<span class="n">b1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">b1</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* loopback mode */</span>
	<span class="n">b2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x1a</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">b3</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>		<span class="cm">/* restore old values */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">b2</span><span class="p">,</span> <span class="n">MSR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b3</span> <span class="o">!=</span> <span class="mh">0x90</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">c_uart_unknown</span><span class="p">;</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">RBR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">RBR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="n">FCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>	<span class="cm">/* enable FIFOs */</span>
	<span class="n">u</span> <span class="o">=</span> <span class="n">uart_tab</span><span class="p">[(</span><span class="n">inb</span><span class="p">(</span><span class="n">IIR</span><span class="p">(</span><span class="n">iobase</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span> <span class="o">==</span> <span class="n">c_uart_16450</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0x5a</span><span class="p">,</span> <span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">b1</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(</span><span class="mh">0xa5</span><span class="p">,</span> <span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="n">b2</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">SCR</span><span class="p">(</span><span class="n">iobase</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">b1</span> <span class="o">!=</span> <span class="mh">0x5a</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">b2</span> <span class="o">!=</span> <span class="mh">0xa5</span><span class="p">))</span>
			<span class="n">u</span> <span class="o">=</span> <span class="n">c_uart_8250</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm">* Rx Section</span>
<span class="cm">******************************************************************************/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">yam_rx_flag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">&amp;&amp;</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">&lt;</span> <span class="n">YAM_MAX_FRAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pkt_len</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* -CRC + kiss */</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crch</span> <span class="o">&amp;</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crcl</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Bad crc */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">pkt_len</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: memory squeeze, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
				<span class="n">cp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* KISS kludge */</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">pkt_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ax25_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crcl</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crch</span> <span class="o">=</span> <span class="mh">0xf3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">yam_rx_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_len</span> <span class="o">&lt;</span> <span class="n">YAM_MAX_FRAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crcl</span><span class="p">;</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crcl</span> <span class="o">=</span> <span class="p">(</span><span class="n">chktabl</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crch</span><span class="p">);</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_crch</span> <span class="o">=</span> <span class="p">(</span><span class="n">chktabh</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">^</span> <span class="n">rxb</span><span class="p">);</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">rx_len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxb</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********************************************************************************</span>
<span class="cm">* TX Section</span>
<span class="cm">********************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ptt_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">PTT_ON</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ptt_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">PTT_OFF</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">yam_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">yam_start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TX_TAIL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">*</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8000</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_HEAD</span><span class="p">;</span>
	<span class="n">ptt_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">yam_arbitrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">YAM_MAGIC</span> <span class="o">||</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">!=</span> <span class="n">TX_OFF</span> <span class="o">||</span>
	    <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* tx_state is TX_OFF and there is data to send */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">dupmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Full duplex mode, don&#39;t wait */</span>
		<span class="n">yam_start_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">yp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DCD on, wait slotime ... */</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">slotcnt</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Is slottime passed ? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">--</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">slotcnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">slotcnt</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* is random &gt; persist ? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">random32</span><span class="p">()</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">yam_start_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">yp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">yam_dotimer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">yam_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">yam_arbitrate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">yam_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yam_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">yam_tx_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_OFF</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_HEAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">ptt_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_OFF</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_DATA</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*                              do_kiss_params(s, skb-&gt;data, skb-&gt;len); */</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* strip KISS byte */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_len</span> <span class="o">&gt;=</span> <span class="n">YAM_MAX_FRAME</span> <span class="o">||</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
							 <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span>
							 <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_len</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crcl</span> <span class="o">=</span> <span class="mh">0x21</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crch</span> <span class="o">=</span> <span class="mh">0xf3</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_DATA</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_DATA</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="o">++</span><span class="p">];</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">THR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crcl</span><span class="p">;</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crcl</span> <span class="o">=</span> <span class="n">chktabl</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">^</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crch</span><span class="p">;</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crch</span> <span class="o">=</span> <span class="n">chktabh</span><span class="p">[</span><span class="n">temp</span><span class="p">]</span> <span class="o">^</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&gt;=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_CRC1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_CRC1</span>:
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crch</span> <span class="o">=</span> <span class="n">chktabl</span><span class="p">[</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crcl</span><span class="p">]</span> <span class="o">^</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crch</span><span class="p">;</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crcl</span> <span class="o">=</span> <span class="n">chktabh</span><span class="p">[</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crcl</span><span class="p">]</span> <span class="o">^</span> <span class="n">chktabl</span><span class="p">[</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crch</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crcl</span><span class="p">,</span> <span class="n">THR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
		<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_CRC2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_CRC2</span>:
		<span class="n">outb</span><span class="p">(</span><span class="n">chktabh</span><span class="p">[</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_crch</span><span class="p">]</span> <span class="o">^</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">THR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">*</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8000</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">dupmode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">+=</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">*</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">holdd</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_TAIL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_HEAD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_TAIL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TX_OFF</span><span class="p">;</span>
			<span class="n">ptt_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************************</span>
<span class="cm">* ISR routine</span>
<span class="cm">************************************************************************************/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">yam_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">yam_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">iir</span> <span class="o">=</span> <span class="n">IIR_MASK</span> <span class="o">&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">IIR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)))</span> <span class="o">!=</span> <span class="n">IIR_NOPEND</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">msr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MSR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lsr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">LSR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rxb</span><span class="p">;</span>

			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">LSR_OE</span><span class="p">)</span>
				<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="p">;</span>

			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">RX_DCD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">counter</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: too many irq iir=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iir</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">TX_RDY</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">nb_mdint</span><span class="p">;</span>
				<span class="n">yam_tx_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">yp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lsr</span> <span class="o">&amp;</span> <span class="n">LSR_RXC</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">++</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">nb_rxint</span><span class="p">;</span>
				<span class="n">rxb</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">RBR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msr</span> <span class="o">&amp;</span> <span class="n">RX_FLAG</span><span class="p">)</span>
					<span class="n">yam_rx_flag</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">yp</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">yam_rx_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">yp</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">yam_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">yam_devs</span><span class="p">[</span><span class="o">*</span><span class="n">pos</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">yam_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">yam_devs</span><span class="p">[</span><span class="o">*</span><span class="n">pos</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">yam_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">yam_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  Up       %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  Speed    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  IoBase   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  BaudRate %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">baudrate</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  IRQ      %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  TxState  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  Duplex   %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">dupmode</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  HoldDly  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">holdd</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  TxDelay  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  TxTail   %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  SlotTime %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  Persist  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  TxFrames %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  RxFrames %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  TxInt    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">nb_mdint</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  RxInt    %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">nb_rxint</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;  RxOver   %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">yam_seqops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">yam_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">yam_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">yam_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">yam_seq_show</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">yam_info_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yam_seqops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">yam_info_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">yam_info_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif</span>


<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">yam_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">uart</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Trying %s at iobase 0x%lx irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">&gt;</span> <span class="mh">0x1000</span> <span class="o">-</span> <span class="n">YAM_EXTENT</span> <span class="o">||</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">YAM_EXTENT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: cannot 0x%lx busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">u</span> <span class="o">=</span> <span class="n">yam_check_uart</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">))</span> <span class="o">==</span> <span class="n">c_uart_unknown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: cannot find uart type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release_base</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fpga_download</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: cannot init FPGA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release_base</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">yam_interrupt</span><span class="p">,</span> <span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: irq %d busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release_base</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">yam_set_uart</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">slotcnt</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* Reset overruns for all ports - FPGA programming makes overruns */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">yam_dev</span> <span class="o">=</span> <span class="n">yam_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">inb</span><span class="p">(</span><span class="n">LSR</span><span class="p">(</span><span class="n">yam_dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
		<span class="n">yam_dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s at iobase 0x%lx irq %u uart %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		   <span class="n">uart_str</span><span class="p">[</span><span class="n">u</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_release_base:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">YAM_EXTENT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">yam_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * disable interrupts</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">IER</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">MCR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">));</span>
	<span class="cm">/* Remove IRQ handler if last */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">YAM_EXTENT</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">)))</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: close yam at iobase 0x%lx irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">yam_drvname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">yam_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">yamdrv_ioctl_cfg</span> <span class="n">yi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yamdrv_ioctl_mcs</span> <span class="o">*</span><span class="n">ym</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioctl_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ioctl_cmd</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span>
		 <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">YAM_MAGIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCDEVPRIVATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ioctl_cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SIOCYAMRESERVED</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>			<span class="cm">/* unused */</span>

	<span class="k">case</span> <span class="n">SIOCYAMSMCS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* Cannot change this parameter when up */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ym</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">yamdrv_ioctl_mcs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="n">ym</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">ym</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">yamdrv_ioctl_mcs</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ym</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ym</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">&gt;</span> <span class="n">YAM_MAXBITRATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ym</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* setting predef as 0 for loading userdefined mcs data */</span>
		<span class="n">add_mcs</span><span class="p">(</span><span class="n">ym</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span> <span class="n">ym</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ym</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCYAMSCFG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yi</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">yamdrv_ioctl_cfg</span><span class="p">)))</span>
			 <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_IOBASE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* Cannot change this parameter when up */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_IRQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* Cannot change this parameter when up */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_BITRATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* Cannot change this parameter when up */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_BAUDRATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>		<span class="cm">/* Cannot change this parameter when up */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_IOBASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">iobase</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">iobase</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_BITRATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">bitrate</span> <span class="o">&gt;</span> <span class="n">YAM_MAXBITRATE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">bitrate</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_BAUDRATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">baudrate</span> <span class="o">&gt;</span> <span class="n">YAM_MAXBAUDRATE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">baudrate</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">&gt;</span> <span class="n">YAM_MAXMODE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">dupmode</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_HOLDDLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">holddly</span> <span class="o">&gt;</span> <span class="n">YAM_MAXHOLDDLY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">holdd</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">holddly</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_TXDELAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">txdelay</span> <span class="o">&gt;</span> <span class="n">YAM_MAXTXDELAY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">txdelay</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_TXTAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">txtail</span> <span class="o">&gt;</span> <span class="n">YAM_MAXTXTAIL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">txtail</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">txtail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_PERSIST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">persist</span> <span class="o">&gt;</span> <span class="n">YAM_MAXPERSIST</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">persist</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">YAM_SLOTTIME</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">slottime</span> <span class="o">&gt;</span> <span class="n">YAM_MAXSLOTTIME</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">slottime</span><span class="p">;</span>
			<span class="n">yp</span><span class="o">-&gt;</span><span class="n">slotcnt</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCYAMGCFG</span>:
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">baudrate</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">dupmode</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">txdelay</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">holddly</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">holdd</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">txtail</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">txtail</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">persist</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">pers</span><span class="p">;</span>
		<span class="n">yi</span><span class="p">.</span><span class="n">cfg</span><span class="p">.</span><span class="n">slottime</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">yamdrv_ioctl_cfg</span><span class="p">)))</span>
			 <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">yam_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* addr is an AX.25 shifted ASCII mac address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">yam_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	     <span class="o">=</span> <span class="n">yam_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	     <span class="o">=</span> <span class="n">yam_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>      <span class="o">=</span> <span class="n">yam_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> 	     <span class="o">=</span> <span class="n">yam_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">yam_set_mac_address</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">yam_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_port</span> <span class="o">*</span><span class="n">yp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">YAM_MAGIC</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">DEFAULT_BITRATE</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">DEFAULT_BITRATE</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">dupmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">holdd</span> <span class="o">=</span> <span class="n">DEFAULT_HOLDD</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="n">DEFAULT_TXD</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">txtail</span> <span class="o">=</span> <span class="n">DEFAULT_TXTAIL</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">slot</span> <span class="o">=</span> <span class="n">DEFAULT_SLOT</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">pers</span> <span class="o">=</span> <span class="n">DEFAULT_PERS</span><span class="p">;</span>
	<span class="n">yp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">yp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yp</span><span class="o">-&gt;</span><span class="n">send_queue</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">yam_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ax25_header_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_AX25</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="n">AX25_MAX_HEADER_LEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">AX25_MTU</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">AX25_ADDR_LEN</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax25_bcast</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax25_defaddr</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">yam_init_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">yam_drvinfo</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;yam%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">yam_port</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span>
				   <span class="n">yam_setup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;yam: cannot allocate net device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;yam: cannot register net device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">yam_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">yam_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">yam_dotimer</span><span class="p">;</span>
	<span class="n">yam_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yam_timer</span><span class="p">);</span>

	<span class="n">proc_net_fops_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="s">&quot;yam&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yam_info_fops</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">error:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">yam_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">yam_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">yam_cleanup_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yam_mcs</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yam_timer</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">yam_devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">yam_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">yam_data</span><span class="p">;</span>
		<span class="n">yam_data</span> <span class="o">=</span> <span class="n">yam_data</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">proc_net_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="s">&quot;yam&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Frederic Rible F1OAT frible@teaser.fr&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Yam amateur radio modem driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_1200</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FIRMWARE_9600</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">yam_init_driver</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">yam_cleanup_driver</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
