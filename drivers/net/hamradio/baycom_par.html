<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hamradio › baycom_par.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>baycom_par.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> *	baycom_par.c  -- baycom par96 and picpar radio modem driver.</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (C) 1996-2000  Thomas Sailer (sailer@ife.ee.ethz.ch)</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *	GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *	You should have received a copy of the GNU General Public License</span>
<span class="cm"> *	along with this program; if not, write to the Free Software</span>
<span class="cm"> *	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *  Please note that the GPL allows you to use the driver, NOT the radio.</span>
<span class="cm"> *  In order to use the radio, you need a license from the communications</span>
<span class="cm"> *  authority of your country.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Supported modems</span>
<span class="cm"> *</span>
<span class="cm"> *  par96:  This is a modem for 9600 baud FSK compatible to the G3RUH standard.</span>
<span class="cm"> *          The modem does all the filtering and regenerates the receiver clock.</span>
<span class="cm"> *          Data is transferred from and to the PC via a shift register.</span>
<span class="cm"> *          The shift register is filled with 16 bits and an interrupt is</span>
<span class="cm"> *          signalled. The PC then empties the shift register in a burst. This</span>
<span class="cm"> *          modem connects to the parallel port, hence the name. The modem</span>
<span class="cm"> *          leaves the implementation of the HDLC protocol and the scrambler</span>
<span class="cm"> *          polynomial to the PC. This modem is no longer available (at least</span>
<span class="cm"> *          from Baycom) and has been replaced by the PICPAR modem (see below).</span>
<span class="cm"> *          You may however still build one from the schematics published in</span>
<span class="cm"> *          cq-DL :-).</span>
<span class="cm"> *</span>
<span class="cm"> *  picpar: This is a redesign of the par96 modem by Henning Rech, DF9IC. The</span>
<span class="cm"> *          modem is protocol compatible to par96, but uses only three low</span>
<span class="cm"> *          power ICs and can therefore be fed from the parallel port and</span>
<span class="cm"> *          does not require an additional power supply. It features</span>
<span class="cm"> *          built in DCD circuitry. The driver should therefore be configured</span>
<span class="cm"> *          for hardware DCD.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Command line options (insmod command line)</span>
<span class="cm"> *</span>
<span class="cm"> *  mode     driver mode string. Valid choices are par96 and picpar.</span>
<span class="cm"> *  iobase   base address of the port; common values are 0x378, 0x278, 0x3bc</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  History:</span>
<span class="cm"> *   0.1  26.06.1996  Adapted from baycom.c and made network driver interface</span>
<span class="cm"> *        18.10.1996  Changed to new user space access routines (copy_{to,from}_user)</span>
<span class="cm"> *   0.3  26.04.1997  init code/data tagged</span>
<span class="cm"> *   0.4  08.07.1997  alternative ser12 decoding algorithm (uses delta CTS ints)</span>
<span class="cm"> *   0.5  11.11.1997  split into separate files for ser12/par96</span>
<span class="cm"> *   0.6  03.08.1999  adapt to Linus&#39; new __setup/__initcall</span>
<span class="cm"> *                    removed some pre-2.2 kernel compatibility cruft</span>
<span class="cm"> *   0.7  10.08.1999  Check if parport can do SPP and is safe to access during interrupt contexts</span>
<span class="cm"> *   0.8  12.02.2000  adapted to softnet driver interface</span>
<span class="cm"> *                    removed direct parport access, uses parport driver methods</span>
<span class="cm"> *   0.9  03.07.2000  fix interface name handling</span>
<span class="cm"> */</span>

<span class="cm">/*****************************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/hdlcdrv.h&gt;</span>
<span class="cp">#include &lt;linux/baycom.h&gt;</span>
<span class="cp">#include &lt;linux/parport.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define BAYCOM_DEBUG</span>

<span class="cm">/*</span>
<span class="cm"> * modem options; bit mask</span>
<span class="cm"> */</span>
<span class="cp">#define BAYCOM_OPTIONS_SOFTDCD  1</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">bc_drvname</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;baycom_par&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">bc_drvinfo</span><span class="p">[]</span> <span class="o">=</span> <span class="n">KERN_INFO</span> <span class="s">&quot;baycom_par: (C) 1996-2000 Thomas Sailer, HB9JNX/AE4WA</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;baycom_par: version 0.9</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define NR_PORTS 4</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">baycom_device</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">];</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define PAR96_BURSTBITS 16</span>
<span class="cp">#define PAR96_BURST     4</span>
<span class="cp">#define PAR96_PTT       2</span>
<span class="cp">#define PAR96_TXBIT     1</span>
<span class="cp">#define PAR96_ACK       0x40</span>
<span class="cp">#define PAR96_RXBIT     0x20</span>
<span class="cp">#define PAR96_DCD       0x10</span>
<span class="cp">#define PAR97_POWER     0xf8</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * Information that need to be kept for each board.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">baycom_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdlcdrv_state</span> <span class="n">hdrv</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pardevice</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">options</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">modem_state</span> <span class="p">{</span>
		<span class="kt">short</span> <span class="n">arb_divider</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shreg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">modem_state_par96</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">dcd_count</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dcd_shreg</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">descram</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scram</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">par96</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">modem</span><span class="p">;</span>

<span class="cp">#ifdef BAYCOM_DEBUG</span>
	<span class="k">struct</span> <span class="n">debug_vals</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_jiffies</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">cur_intcnt</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">last_intcnt</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">cur_pllcorr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">last_pllcorr</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">debug_vals</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* BAYCOM_DEBUG */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__inline__</span> <span class="nf">baycom_int_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef BAYCOM_DEBUG</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cur_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * measure the interrupt frequency</span>
<span class="cm">	 */</span>
	<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_intcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">cur_jiffies</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_jiffies</span> <span class="o">=</span> <span class="n">cur_jiffies</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_intcnt</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_intcnt</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_intcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_pllcorr</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_pllcorr</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">cur_pllcorr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* BAYCOM_DEBUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * ===================== PAR96 specific routines =========================</span>
<span class="cm"> */</span>

<span class="cp">#define PAR96_DESCRAM_TAP1 0x20000</span>
<span class="cp">#define PAR96_DESCRAM_TAP2 0x01000</span>
<span class="cp">#define PAR96_DESCRAM_TAP3 0x00001</span>

<span class="cp">#define PAR96_DESCRAM_TAPSH1 17</span>
<span class="cp">#define PAR96_DESCRAM_TAPSH2 12</span>
<span class="cp">#define PAR96_DESCRAM_TAPSH3 0</span>

<span class="cp">#define PAR96_SCRAM_TAP1 0x20000 </span><span class="cm">/* X^17 */</span><span class="cp"></span>
<span class="cp">#define PAR96_SCRAM_TAPN 0x00021 </span><span class="cm">/* X^0+X^5 */</span><span class="cp"></span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">par96_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="n">hdlcdrv_getbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAR96_BURSTBITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">PAR97_POWER</span><span class="p">;</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">scram</span> <span class="o">=</span> <span class="p">((</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">scram</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">scram</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">scram</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">scram</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAR96_SCRAM_TAP1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">scram</span> <span class="o">^=</span>
				<span class="p">(</span><span class="n">PAR96_SCRAM_TAPN</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">scram</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAR96_SCRAM_TAP1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">PAR96_TXBIT</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_data</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_data</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">PAR96_BURST</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">par96_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mask2</span><span class="p">,</span> <span class="n">descx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * do receiver; differential decode and descramble on the fly</span>
<span class="cm">	 */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAR96_BURSTBITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">descram</span> <span class="o">=</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">descram</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAR96_RXBIT</span><span class="p">)</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">descram</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">descx</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">descram</span> <span class="o">^</span>
			<span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">descram</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* now the diff decoded data is inverted in descram */</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_data</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">PAR97_POWER</span> <span class="o">|</span> <span class="n">PAR96_PTT</span><span class="p">);</span>
		<span class="n">descx</span> <span class="o">^=</span> <span class="p">((</span><span class="n">descx</span> <span class="o">&gt;&gt;</span> <span class="n">PAR96_DESCRAM_TAPSH1</span><span class="p">)</span> <span class="o">^</span>
			  <span class="p">(</span><span class="n">descx</span> <span class="o">&gt;&gt;</span> <span class="n">PAR96_DESCRAM_TAPSH2</span><span class="p">));</span>
		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">descx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_data</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">PAR97_POWER</span> <span class="o">|</span> <span class="n">PAR96_PTT</span> <span class="o">|</span> <span class="n">PAR96_BURST</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hdlcdrv_putbits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * do DCD algorithm</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">BAYCOM_OPTIONS_SOFTDCD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_shreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_shreg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="cm">/* search for flags and set the dcd counter appropriately */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x1fe00</span><span class="p">,</span> <span class="n">mask2</span> <span class="o">=</span> <span class="mh">0xfc00</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAR96_BURSTBITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask2</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_shreg</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask2</span><span class="p">)</span>
				<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_count</span> <span class="o">=</span> <span class="n">HDLCDRV_MAXFLEN</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
		<span class="cm">/* check for abort/noise sequences */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0x1fe00</span><span class="p">,</span> <span class="n">mask2</span> <span class="o">=</span> <span class="mh">0x1fe00</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAR96_BURSTBITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mask2</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_shreg</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_count</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_count</span> <span class="o">-=</span> <span class="n">HDLCDRV_MAXFLEN</span><span class="o">-</span><span class="mi">10</span><span class="p">;</span>
		<span class="cm">/* decrement and set the dcd variable */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_count</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_count</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hdlcdrv_setdcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">par96</span><span class="p">.</span><span class="n">dcd_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdlcdrv_setdcd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">read_status</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAR96_DCD</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">par96_interrupt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">baycom_int_freq</span><span class="p">(</span><span class="n">bc</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * check if transmitter active</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdlcdrv_ptt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">))</span>
		<span class="n">par96_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">par96_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">arb_divider</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">arb_divider</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">local_irq_enable</span><span class="p">();</span>
			<span class="n">hdlcdrv_arbitrate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>
	<span class="n">hdlcdrv_transmitter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
	<span class="n">hdlcdrv_receiver</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">);</span>
        <span class="n">local_irq_disable</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">par96_wakeup</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;baycom_par: %s: why am I being woken up?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parport_claim</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;baycom_par: %s: I&#39;m broken.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">par96_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">bc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">parport_find_base</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;baycom_par: parport at 0x%lx unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;baycom_par: parport at 0x%lx has no irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">parport_put_port</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="n">pp</span><span class="o">-&gt;</span><span class="n">modes</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PARPORT_MODE_PCSPP</span> <span class="o">|</span> <span class="n">PARPORT_MODE_SAFEININT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;baycom_par: parport at 0x%lx cannot be used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">parport_put_port</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">));</span>
	<span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">par</span><span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">parport_register_device</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">par96_wakeup</span><span class="p">,</span> 
				 <span class="n">par96_interrupt</span><span class="p">,</span> <span class="n">PARPORT_DEV_EXCL</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">parport_put_port</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;baycom_par: cannot register parport at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parport_claim</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;baycom_par: parport at 0x%lx busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">data_forward</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
        <span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">par</span><span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">9600</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_data</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">PAR96_PTT</span> <span class="o">|</span> <span class="n">PAR97_POWER</span><span class="p">);</span> <span class="cm">/* switch off PTT */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">enable_irq</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: par96 at iobase 0x%lx irq %u options 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bc_drvname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">par96_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">parport</span> <span class="o">*</span><span class="n">pp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">bc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pp</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="cm">/* disable interrupt */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">disable_irq</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
	<span class="cm">/* switch off PTT */</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write_data</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">PAR96_PTT</span> <span class="o">|</span> <span class="n">PAR97_POWER</span><span class="p">);</span>
	<span class="n">parport_release</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">parport_unregister_device</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: close par96 at iobase 0x%lx irq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bc_drvname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * ===================== hdlcdrv driver interface =========================</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">baycom_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span> <span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hdlcdrv_ops</span> <span class="n">par96_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">drvname</span> <span class="o">=</span> <span class="n">bc_drvname</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drvinfo</span> <span class="o">=</span> <span class="n">bc_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">par96_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>   <span class="o">=</span> <span class="n">par96_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>   <span class="o">=</span> <span class="n">baycom_ioctl</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">baycom_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modestr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">modestr</span><span class="p">,</span> <span class="s">&quot;picpar&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">modestr</span><span class="p">,</span> <span class="s">&quot;par96&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="n">BAYCOM_OPTIONS_SOFTDCD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="o">!!</span><span class="n">strchr</span><span class="p">(</span><span class="n">modestr</span><span class="p">,</span> <span class="sc">&#39;*&#39;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">baycom_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span> <span class="o">*</span><span class="n">hi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">baycom_ioctl</span> <span class="n">bi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">HDLCDRV_MAGIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCDEVPRIVATE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_GETMODE</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">,</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">?</span> <span class="s">&quot;par96&quot;</span> <span class="o">:</span> <span class="s">&quot;picpar&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_SETMODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">baycom_setmode</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_MODELIST</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">hi</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">modename</span><span class="p">,</span> <span class="s">&quot;par96,picpar&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdlcdrv_ioctl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HDLCDRVCTL_MODEMPARMASK</span>:
		<span class="k">return</span> <span class="n">HDLCDRV_PARMASK_IOBASE</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bi</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bi</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

<span class="cp">#ifdef BAYCOM_DEBUG</span>
	<span class="k">case</span> <span class="n">BAYCOMCTL_GETDEBUG</span>:
		<span class="n">bi</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">dbg</span><span class="p">.</span><span class="n">debug1</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">hdrv</span><span class="p">.</span><span class="n">ptt_keyed</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">dbg</span><span class="p">.</span><span class="n">debug2</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_intcnt</span><span class="p">;</span>
		<span class="n">bi</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">dbg</span><span class="p">.</span><span class="n">debug3</span> <span class="o">=</span> <span class="n">bc</span><span class="o">-&gt;</span><span class="n">debug_vals</span><span class="p">.</span><span class="n">last_pllcorr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* BAYCOM_DEBUG */</span><span class="cp"></span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bi</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * command line settable parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mode</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;picpar&quot;</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">iobase</span><span class="p">[</span><span class="n">NR_PORTS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x378</span><span class="p">,</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="s">&quot;baycom operating mode; eg. par96 or picpar&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">iobase</span><span class="p">,</span> <span class="s">&quot;baycom io base address&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas M. Sailer, sailer@ife.ee.ethz.ch, hb9jnx@hb9w.che.eu&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Baycom par96 and picpar amateur radio modem driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_baycompar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">set_hw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">bc_drvinfo</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * register net devices</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">baycom_state</span> <span class="o">*</span><span class="n">bc</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">ifname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="s">&quot;bcp%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">set_hw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_hw</span><span class="p">)</span>
			<span class="n">iobase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">hdlcdrv_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">par96_ops</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">baycom_state</span><span class="p">),</span>
				       <span class="n">ifname</span><span class="p">,</span> <span class="n">iobase</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> 
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bc</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_hw</span> <span class="o">&amp;&amp;</span> <span class="n">baycom_setmode</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">mode</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">set_hw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">found</span><span class="o">++</span><span class="p">;</span>
		<span class="n">baycom_device</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_baycompar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">baycom_device</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			<span class="n">hdlcdrv_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_baycompar</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_baycompar</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#ifndef MODULE</span>

<span class="cm">/*</span>
<span class="cm"> * format: baycom_par=io,mode</span>
<span class="cm"> * mode: par96,picpar</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">baycom_par_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">static</span> <span class="kt">unsigned</span> <span class="n">nr_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nr_dev</span> <span class="o">&gt;=</span> <span class="n">NR_PORTS</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ints</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mode</span><span class="p">[</span><span class="n">nr_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
        <span class="n">iobase</span><span class="p">[</span><span class="n">nr_dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">nr_dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;baycom_par=&quot;</span><span class="p">,</span> <span class="n">baycom_par_setup</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
<span class="cm">/* --------------------------------------------------------------------- */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
