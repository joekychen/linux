<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hamradio › scc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>scc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#define RCS_ID &quot;$Id: scc.c,v 1.75 1998/11/04 15:15:01 jreuter Exp jreuter $&quot;</span>

<span class="cp">#define VERSION &quot;3.0&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Please use z8530drv-utils-3.0 with this version.</span>
<span class="cm"> *            ------------------</span>
<span class="cm"> *</span>
<span class="cm"> * You can find a subset of the documentation in </span>
<span class="cm"> * Documentation/networking/z8530drv.txt.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">   ********************************************************************</span>
<span class="cm">   *   SCC.C - Linux driver for Z8530 based HDLC cards for AX.25      *</span>
<span class="cm">   ********************************************************************</span>


<span class="cm">   ********************************************************************</span>

<span class="cm">	Copyright (c) 1993, 2000 Joerg Reuter DL1BKE</span>

<span class="cm">	portions (c) 1993 Guido ten Dolle PE1NNZ</span>

<span class="cm">   ********************************************************************</span>
<span class="cm">   </span>
<span class="cm">   The driver and the programs in the archive are UNDER CONSTRUCTION.</span>
<span class="cm">   The code is likely to fail, and so your kernel could --- even </span>
<span class="cm">   a whole network. </span>

<span class="cm">   This driver is intended for Amateur Radio use. If you are running it</span>
<span class="cm">   for commercial purposes, please drop me a note. I am nosy...</span>

<span class="cm">   ...BUT:</span>
<span class="cm"> </span>
<span class="cm">   ! You  m u s t  recognize the appropriate legislations of your country !</span>
<span class="cm">   ! before you connect a radio to the SCC board and start to transmit or !</span>
<span class="cm">   ! receive. The GPL allows you to use the  d r i v e r,  NOT the RADIO! !</span>

<span class="cm">   For non-Amateur-Radio use please note that you might need a special</span>
<span class="cm">   allowance/licence from the designer of the SCC Board and/or the</span>
<span class="cm">   MODEM. </span>

<span class="cm">   This program is free software; you can redistribute it and/or modify </span>
<span class="cm">   it under the terms of the (modified) GNU General Public License </span>
<span class="cm">   delivered with the Linux kernel source.</span>
<span class="cm">   </span>
<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should find a copy of the GNU General Public License in </span>
<span class="cm">   /usr/src/linux/COPYING; </span>
<span class="cm">   </span>
<span class="cm">   ******************************************************************** </span>

<span class="cm">		</span>
<span class="cm">   Incomplete history of z8530drv:</span>
<span class="cm">   -------------------------------</span>

<span class="cm">   1994-09-13	started to write the driver, rescued most of my own</span>
<span class="cm">		code (and Hans Alblas&#39; memory buffer pool concept) from </span>
<span class="cm">		an earlier project &quot;sccdrv&quot; which was initiated by </span>
<span class="cm">		Guido ten Dolle. Not much of the old driver survived, </span>
<span class="cm">		though. The first version I put my hands on was sccdrv1.3</span>
<span class="cm">		from August 1993. The memory buffer pool concept</span>
<span class="cm">		appeared in an unauthorized sccdrv version (1.5) from</span>
<span class="cm">		August 1994.</span>

<span class="cm">   1995-01-31	changed copyright notice to GPL without limitations.</span>
<span class="cm">   </span>
<span class="cm">     .</span>
<span class="cm">     .	&lt;SNIP&gt;</span>
<span class="cm">     .</span>
<span class="cm">   		  </span>
<span class="cm">   1996-10-05	New semester, new driver... </span>

<span class="cm">   		  * KISS TNC emulator removed (TTY driver)</span>
<span class="cm">   		  * Source moved to drivers/net/</span>
<span class="cm">   		  * Includes Z8530 defines from drivers/net/z8530.h</span>
<span class="cm">   		  * Uses sk_buffer memory management</span>
<span class="cm">   		  * Reduced overhead of /proc/net/z8530drv output</span>
<span class="cm">   		  * Streamlined quite a lot things</span>
<span class="cm">   		  * Invents brand new bugs... ;-)</span>

<span class="cm">   		  The move to version number 3.0 reflects theses changes.</span>
<span class="cm">   		  You can use &#39;kissbridge&#39; if you need a KISS TNC emulator.</span>

<span class="cm">   1996-12-13	Fixed for Linux networking changes. (G4KLX)</span>
<span class="cm">   1997-01-08	Fixed the remaining problems.</span>
<span class="cm">   1997-04-02	Hopefully fixed the problems with the new *_timer()</span>
<span class="cm">   		routines, added calibration code.</span>
<span class="cm">   1997-10-12	Made SCC_DELAY a CONFIG option, added CONFIG_SCC_TRXECHO</span>
<span class="cm">   1998-01-29	Small fix to avoid lock-up on initialization</span>
<span class="cm">   1998-09-29	Fixed the &quot;grouping&quot; bugs, tx_inhibit works again,</span>
<span class="cm">   		using dev-&gt;tx_queue_len now instead of MAXQUEUE now.</span>
<span class="cm">   1998-10-21	Postponed the spinlock changes, would need a lot of</span>
<span class="cm">   		testing I currently don&#39;t have the time to. Softdcd doesn&#39;t</span>
<span class="cm">   		work.</span>
<span class="cm">   1998-11-04	Softdcd does not work correctly in DPLL mode, in fact it </span>
<span class="cm">   		never did. The DPLL locks on noise, the SYNC unit sees</span>
<span class="cm">   		flags that aren&#39;t... Restarting the DPLL does not help</span>
<span class="cm">   		either, it resynchronizes too slow and the first received</span>
<span class="cm">   		frame gets lost.</span>
<span class="cm">   2000-02-13	Fixed for new network driver interface changes, still</span>
<span class="cm">   		does TX timeouts itself since it uses its own queue</span>
<span class="cm">   		scheme.</span>

<span class="cm">   Thanks to all who contributed to this driver with ideas and bug</span>
<span class="cm">   reports!</span>
<span class="cm">   </span>
<span class="cm">   NB -- if you find errors, change something, please let me know</span>
<span class="cm">      	 first before you distribute it... And please don&#39;t touch</span>
<span class="cm">   	 the version number. Just replace my callsign in</span>
<span class="cm">   	 &quot;v3.0.dl1bke&quot; with your own. Just to avoid confusion...</span>

<span class="cm">   If you want to add your modification to the linux distribution</span>
<span class="cm">   please (!) contact me first.</span>
<span class="cm">   </span>
<span class="cm">   New versions of the driver will be announced on the linux-hams</span>
<span class="cm">   mailing list on vger.kernel.org. To subscribe send an e-mail</span>
<span class="cm">   to majordomo@vger.kernel.org with the following line in</span>
<span class="cm">   the body of the mail:</span>
<span class="cm">   </span>
<span class="cm">	   subscribe linux-hams</span>
<span class="cm">	   </span>
<span class="cm">   The content of the &quot;Subject&quot; field will be ignored.</span>

<span class="cm">   vy 73,</span>
<span class="cm">   Joerg Reuter	ampr-net: dl1bke@db0pra.ampr.org</span>
<span class="cm">		AX-25   : DL1BKE @ DB0ABH.#BAY.DEU.EU</span>
<span class="cm">		Internet: jreuter@yaina.de</span>
<span class="cm">		www     : http://yaina.de/jreuter</span>
<span class="cm">*/</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cp">#undef  SCC_LDELAY		</span><span class="cm">/* slow it even a bit more down */</span><span class="cp"></span>
<span class="cp">#undef  SCC_DONT_CHECK		</span><span class="cm">/* don&#39;t look if the SCCs you specified are available */</span><span class="cp"></span>

<span class="cp">#define SCC_MAXCHIPS	4       </span><span class="cm">/* number of max. supported chips */</span><span class="cp"></span>
<span class="cp">#define SCC_BUFSIZE	384     </span><span class="cm">/* must not exceed 4096 */</span><span class="cp"></span>
<span class="cp">#undef	SCC_DEBUG</span>

<span class="cp">#define SCC_DEFAULT_CLOCK	4915200 </span>
				<span class="cm">/* default pclock if nothing is specified */</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/socket.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/scc.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/ax25.h&gt;</span>

<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;z8530.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">banner</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">KERN_INFO</span> \
	<span class="s">&quot;AX.25: Z8530 SCC driver version &quot;</span><span class="n">VERSION</span><span class="s">&quot;.dl1bke</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">t_dwait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">t_txdelay</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">t_tail</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">t_busy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">t_maxkeyup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">t_idle</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_start_maxkeyup</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_start_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">z8530_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">init_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_key_trx</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">tx</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_init_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">scc_net_alloc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_net_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scc_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scc_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">scc_net_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">scc_net_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scc_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">scc_net_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span> <span class="n">scc_net_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">SCC_DriverName</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;scc&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">irqflags</span> <span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">used</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span> <span class="n">Ivec</span><span class="p">[</span><span class="n">NR_IRQS</span><span class="p">];</span>
	
<span class="k">static</span> <span class="k">struct</span> <span class="n">scc_channel</span> <span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">SCC_MAXCHIPS</span><span class="p">];</span>	<span class="cm">/* information per channel */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scc_ctrl</span> <span class="p">{</span>
	<span class="n">io_port</span> <span class="n">chan_A</span><span class="p">;</span>
	<span class="n">io_port</span> <span class="n">chan_B</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">SCC_ctrl</span><span class="p">[</span><span class="n">SCC_MAXCHIPS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Driver_Initialized</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">Nchips</span><span class="p">;</span>
<span class="k">static</span> <span class="n">io_port</span> <span class="n">Vector_Latch</span><span class="p">;</span>


<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *			Port Access Functions			      * */</span>
<span class="cm">/* ******************************************************************** */</span>

<span class="cm">/* These provide interrupt save 2-step access to the Z8530 registers */</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">iolock</span><span class="p">);</span>	<span class="cm">/* Guards paired accesses */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">InReg</span><span class="p">(</span><span class="n">io_port</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iolock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>	
<span class="cp">#ifdef SCC_LDELAY</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">SCC_LDELAY</span><span class="p">);</span>
	<span class="n">r</span><span class="o">=</span><span class="n">Inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">SCC_LDELAY</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">r</span><span class="o">=</span><span class="n">Inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iolock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">OutReg</span><span class="p">(</span><span class="n">io_port</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iolock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef SCC_LDELAY</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="n">SCC_LDELAY</span><span class="p">);</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span> <span class="n">udelay</span><span class="p">(</span><span class="n">SCC_LDELAY</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iolock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">or</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cl</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *			Some useful macros			      * */</span>
<span class="cm">/* ******************************************************************** */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scc_discard_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>	
	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">))</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">));</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *			Interrupt Service Routines		      * */</span>
<span class="cm">/* ******************************************************************** */</span>


<span class="cm">/* ----&gt; subroutines for the interrupt handlers &lt;---- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scc_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">bp</span><span class="p">;</span>
	
        <span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">!=</span> <span class="n">KISS_DUPLEX_OPTIMA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">bp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">PARAM_HWEVENT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bp</span><span class="o">++</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>
		<span class="n">scc_net_rx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">nospace</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">flush_rx_FIFO</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="n">Inb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		
	<span class="k">if</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>		<span class="cm">/* did we receive something? */</span>
	<span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rxerrs</span><span class="o">++</span><span class="p">;</span>  <span class="cm">/* then count it as an error */</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_hunt</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">clocksrc</span> <span class="o">!=</span> <span class="n">CLK_EXTERNAL</span><span class="p">))</span>
		<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R14</span><span class="p">,</span><span class="n">SEARCH</span><span class="o">|</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R14</span><span class="p">]);</span> <span class="cm">/* DPLL: enter search mode */</span>
	<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R3</span><span class="p">,</span><span class="n">ENT_HM</span><span class="o">|</span><span class="n">RxENABLE</span><span class="p">);</span>  <span class="cm">/* enable the receiver, hunt mode */</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; four different interrupt handlers for Tx, Rx, changing of	*/</span>
<span class="cm">/*       DCD/CTS and Rx/Tx errors					*/</span>

<span class="cm">/* Transmitter interrupt handler */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scc_txint</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">txints</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">;</span>
	
	<span class="cm">/* send first octet */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">scc_tx_done</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">RES_Tx_P</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* Paranoia... */</span>
		<span class="p">{</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">scc_tx_done</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">RES_Tx_P</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_ACTIVE</span><span class="p">;</span>

		<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">RES_Tx_CRC</span><span class="p">);</span>
						<span class="cm">/* reset CRC generator */</span>
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R10</span><span class="p">,</span><span class="n">ABUNDER</span><span class="p">);</span>		<span class="cm">/* re-install underrun protection */</span>
		<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>	<span class="cm">/* send byte */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">enhanced</span><span class="p">)</span>		<span class="cm">/* reset EOM latch */</span>
			<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EOM_L</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* End Of Frame... */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">RES_Tx_P</span><span class="p">);</span>	<span class="cm">/* reset pending int */</span>
		<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R10</span><span class="p">,</span> <span class="n">ABUNDER</span><span class="p">);</span>		<span class="cm">/* send CRC */</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_NEWFRAME</span><span class="p">;</span> <span class="cm">/* next frame... */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> 
	
	<span class="cm">/* send octet */</span>
	
	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>		
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* External/Status interrupt handler */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scc_exint</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">,</span><span class="n">changes</span><span class="p">,</span><span class="n">chg_and_stat</span><span class="p">;</span>

	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">exints</span><span class="o">++</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R0</span><span class="p">);</span>
	<span class="n">changes</span> <span class="o">=</span> <span class="n">status</span> <span class="o">^</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">chg_and_stat</span> <span class="o">=</span> <span class="n">changes</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">;</span>
	
	<span class="cm">/* ABORT: generated whenever DCD drops while receiving */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chg_and_stat</span> <span class="o">&amp;</span> <span class="n">BRK_ABRT</span><span class="p">)</span>		<span class="cm">/* Received an ABORT */</span>
		<span class="n">flush_rx_FIFO</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>

	<span class="cm">/* HUNT: software DCD; on = waiting for SYNC, off = receiving frame */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">SYNC_HUNT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SYNC_HUNT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">flush_rx_FIFO</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">clocksrc</span> <span class="o">!=</span> <span class="n">CLK_EXTERNAL</span><span class="p">))</span>
				<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R14</span><span class="p">,</span><span class="n">SEARCH</span><span class="o">|</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R14</span><span class="p">]);</span> <span class="cm">/* DPLL: enter search mode */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scc_notify</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">?</span> <span class="n">HWEV_DCD_OFF</span><span class="o">:</span><span class="n">HWEV_DCD_ON</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* DCD: on = start to receive packet, off = ABORT condition */</span>
	<span class="cm">/* (a successfully received packet generates a special condition int) */</span>
	
	<span class="k">if</span><span class="p">((</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">DCD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="p">)</span> <span class="cm">/* DCD input changed state */</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DCD</span><span class="p">)</span>                <span class="cm">/* DCD is now ON */</span>
		<span class="p">{</span>
			<span class="n">start_hunt</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>                        <span class="cm">/* DCD is now OFF */</span>
			<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R3</span><span class="p">,</span><span class="n">ENT_HM</span><span class="o">|</span><span class="n">RxENABLE</span><span class="p">);</span> <span class="cm">/* disable the receiver */</span>
			<span class="n">flush_rx_FIFO</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="n">scc_notify</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">?</span> <span class="n">HWEV_DCD_ON</span><span class="o">:</span><span class="n">HWEV_DCD_OFF</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef notdef</span>
	<span class="cm">/* CTS: use external TxDelay (what&#39;s that good for?!)</span>
<span class="cm">	 * Anyway: If we _could_ use it (BayCom USCC uses CTS for</span>
<span class="cm">	 * own purposes) we _should_ use the &quot;autoenable&quot; feature</span>
<span class="cm">	 * of the Z8530 and not this interrupt...</span>
<span class="cm">	 */</span>
	 
	<span class="k">if</span> <span class="p">(</span><span class="n">chg_and_stat</span> <span class="o">&amp;</span> <span class="n">CTS</span><span class="p">)</span>			<span class="cm">/* CTS is now ON */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">txdelay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* zero TXDELAY = wait for CTS */</span>
			<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_txdelay</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TXS_ACTIVE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TxEOM</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_under</span><span class="o">++</span><span class="p">;</span>	  <span class="cm">/* oops, an underrun! count &#39;em */</span>
		<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">RES_EXT_INT</span><span class="p">);</span>	<span class="cm">/* reset ext/status interrupts */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span><span class="p">);</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R10</span><span class="p">,</span><span class="n">ABUNDER</span><span class="p">);</span>
		<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_txdelay</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* restart transmission */</span>
	<span class="p">}</span>
		
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EXT_INT</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Receiver interrupt handler */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scc_rxint</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rxints</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">==</span> <span class="n">KISS_DUPLEX_HALF</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Inb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>		<span class="cm">/* discard char */</span>
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R3</span><span class="p">,</span><span class="n">ENT_HM</span><span class="p">);</span>	<span class="cm">/* enter hunt mode for next flag */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bufsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">nospace</span><span class="o">++</span><span class="p">;</span>
			<span class="n">Inb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">ENT_HM</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* KISS data */</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bufsize</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cp">#ifdef notdef</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;z8530drv: oops, scc_rxint() received huge frame...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">Inb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">ENT_HM</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="n">Inb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Receive Special Condition interrupt handler */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">scc_spint</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">spints</span><span class="o">++</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R1</span><span class="p">);</span>		<span class="cm">/* read receiver status */</span>
	
	<span class="n">Inb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>				<span class="cm">/* throw away Rx byte */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">Rx_OVR</span><span class="p">)</span>			<span class="cm">/* receiver overrun */</span>
	<span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rx_over</span><span class="o">++</span><span class="p">;</span>             <span class="cm">/* count them */</span>
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R3</span><span class="p">,</span><span class="n">ENT_HM</span><span class="p">);</span>               <span class="cm">/* enter hunt mode for next flag */</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> 
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">END_FR</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/* end of frame */</span>
	<span class="p">{</span>
		<span class="cm">/* CRC okay, frame ends on 8 bit boundary and received something ? */</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CRC_ERR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">==</span> <span class="n">RES8</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* ignore last received byte (first of the CRC bytes) */</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">scc_net_rx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rxframes</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>				<span class="cm">/* a bad frame */</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">rx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rxerrs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> 

	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">ERR_RES</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ----&gt; interrupt service routine for the Z8530 &lt;---- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_isr_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vector</span> <span class="o">&amp;</span> <span class="n">VECTOR_MASK</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">TXINT</span>: <span class="n">scc_txint</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EXINT</span>: <span class="n">scc_exint</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RXINT</span>: <span class="n">scc_rxint</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SPINT</span>: <span class="n">scc_spint</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* If the card has a latch for the interrupt vector (like the PA0HZP card)</span>
<span class="cm">   use it to get the number of the chip that generated the int.</span>
<span class="cm">   If not: poll all defined chips.</span>
<span class="cm"> */</span>

<span class="cp">#define SCC_IRQTIMEOUT 30000</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">scc_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chip_irq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vector</span><span class="p">;</span>	
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">Vector_Latch</span><span class="p">)</span>
	<span class="p">{</span>
	    	<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">SCC_IRQTIMEOUT</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
    		<span class="p">{</span>
			<span class="n">Outb</span><span class="p">(</span><span class="n">Vector_Latch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>      <span class="cm">/* Generate INTACK */</span>
        
			<span class="cm">/* Read the vector */</span>
			<span class="k">if</span><span class="p">((</span><span class="n">vector</span><span class="o">=</span><span class="n">Inb</span><span class="p">(</span><span class="n">Vector_Latch</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">Nchips</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> 
			<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        	 
		        <span class="n">scc</span><span class="o">=&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">vector</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">^</span> <span class="mh">0x01</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

			<span class="n">scc_isr_dispatch</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>

			<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R0</span><span class="p">,</span><span class="n">RES_H_IUS</span><span class="p">);</span>              <span class="cm">/* Reset Highest IUS */</span>
		<span class="p">}</span>  

		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">SCC_IRQTIMEOUT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;z8530drv: endless loop in scc_isr()?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find the SCC generating the interrupt by polling all attached SCCs</span>
<span class="cm">	 * reading RR3A (the interrupt pending register)</span>
<span class="cm">	 */</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">SCC_ctrl</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">chan_A</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="n">chip_irq</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">ctrl</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">InReg</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">chan_A</span><span class="p">,</span><span class="n">R3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">SCC_IRQTIMEOUT</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">vector</span><span class="o">=</span><span class="n">InReg</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">chan_B</span><span class="p">,</span><span class="n">R2</span><span class="p">);</span>	<span class="cm">/* Read the vector */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vector</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> 

			<span class="n">scc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">vector</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">^</span> <span class="mh">0x01</span><span class="p">];</span>
		        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

			<span class="n">scc_isr_dispatch</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">vector</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">SCC_IRQTIMEOUT</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;z8530drv: endless loop in scc_isr()?!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This looks weird and it is. At least the BayCom USCC doesn&#39;t</span>
<span class="cm">		 * use the Interrupt Daisy Chain, thus we&#39;ll have to start</span>
<span class="cm">		 * all over again to be sure not to miss an interrupt from </span>
<span class="cm">		 * (any of) the other chip(s)...</span>
<span class="cm">		 * Honestly, the situation *is* braindamaged...</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R0</span><span class="p">,</span><span class="n">RES_H_IUS</span><span class="p">);</span>
			<span class="n">ctrl</span> <span class="o">=</span> <span class="n">SCC_ctrl</span><span class="p">;</span> 
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ctrl</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *			Init Channel					*/</span>
<span class="cm">/* ******************************************************************** */</span>


<span class="cm">/* ----&gt; set SCC channel speed &lt;---- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_brg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R14</span><span class="p">,</span><span class="n">BRENABL</span><span class="p">);</span>		<span class="cm">/* disable baudrate generator */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R12</span><span class="p">,</span><span class="n">tc</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">);</span>		<span class="cm">/* brg rate LOW */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R13</span><span class="p">,</span><span class="n">tc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>   		<span class="cm">/* brg rate HIGH */</span>
	<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R14</span><span class="p">,</span><span class="n">BRENABL</span><span class="p">);</span>		<span class="cm">/* enable baudrate generator */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* paranoia... */</span>
		<span class="n">set_brg</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">/</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span> <span class="o">*</span> <span class="mi">64</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
		
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ----&gt; initialize a SCC channel &lt;---- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">init_brg</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">BRSRC</span><span class="p">);</span>				<span class="cm">/* BRG source = PCLK */</span>
	<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">SSBR</span><span class="o">|</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R14</span><span class="p">]);</span>	<span class="cm">/* DPLL source = BRG */</span>
	<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">SNRZI</span><span class="o">|</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R14</span><span class="p">]);</span>	<span class="cm">/* DPLL NRZI mode */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialization according to the Z8530 manual (SGS-Thomson&#39;s version):</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Modes and constants</span>
<span class="cm"> *</span>
<span class="cm"> * WR9	11000000	chip reset</span>
<span class="cm"> * WR4	XXXXXXXX	Tx/Rx control, async or sync mode</span>
<span class="cm"> * WR1	0XX00X00	select W/REQ (optional)</span>
<span class="cm"> * WR2	XXXXXXXX	program interrupt vector</span>
<span class="cm"> * WR3	XXXXXXX0	select Rx control</span>
<span class="cm"> * WR5	XXXX0XXX	select Tx control</span>
<span class="cm"> * WR6	XXXXXXXX	sync character</span>
<span class="cm"> * WR7	XXXXXXXX	sync character</span>
<span class="cm"> * WR9	000X0XXX	select interrupt control</span>
<span class="cm"> * WR10	XXXXXXXX	miscellaneous control (optional)</span>
<span class="cm"> * WR11	XXXXXXXX	clock control</span>
<span class="cm"> * WR12	XXXXXXXX	time constant lower byte (optional)</span>
<span class="cm"> * WR13	XXXXXXXX	time constant upper byte (optional)</span>
<span class="cm"> * WR14	XXXXXXX0	miscellaneous control</span>
<span class="cm"> * WR14	XXXSSSSS	commands (optional)</span>
<span class="cm"> *</span>
<span class="cm"> * 2. Enables</span>
<span class="cm"> *</span>
<span class="cm"> * WR14	000SSSS1	baud rate enable</span>
<span class="cm"> * WR3	SSSSSSS1	Rx enable</span>
<span class="cm"> * WR5	SSSS1SSS	Tx enable</span>
<span class="cm"> * WR0	10000000	reset Tx CRG (optional)</span>
<span class="cm"> * WR1	XSS00S00	DMA enable (optional)</span>
<span class="cm"> *</span>
<span class="cm"> * 3. Interrupt status</span>
<span class="cm"> *</span>
<span class="cm"> * WR15	XXXXXXXX	enable external/status</span>
<span class="cm"> * WR0	00010000	reset external status</span>
<span class="cm"> * WR0	00010000	reset external status twice</span>
<span class="cm"> * WR1	SSSXXSXX	enable Rx, Tx and Ext/status</span>
<span class="cm"> * WR9	000SXSSS	enable master interrupt enable</span>
<span class="cm"> *</span>
<span class="cm"> * 1 = set to one, 0 = reset to zero</span>
<span class="cm"> * X = user defined, S = same as previous init</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Note that the implementation differs in some points from above scheme.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R4</span><span class="p">,</span><span class="n">X1CLK</span><span class="o">|</span><span class="n">SDLC</span><span class="p">);</span>		<span class="cm">/* *1 clock, SDLC mode */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>			<span class="cm">/* no W/REQ operation */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R3</span><span class="p">,</span><span class="n">Rx8</span><span class="o">|</span><span class="n">RxCRC_ENAB</span><span class="p">);</span>	<span class="cm">/* RX 8 bits/char, CRC, disabled */</span>	
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R5</span><span class="p">,</span><span class="n">Tx8</span><span class="o">|</span><span class="n">DTR</span><span class="o">|</span><span class="n">TxCRC_ENAB</span><span class="p">);</span>	<span class="cm">/* TX 8 bits/char, disabled, DTR */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R6</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>			<span class="cm">/* SDLC address zero (not used) */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R7</span><span class="p">,</span><span class="n">FLAG</span><span class="p">);</span>		<span class="cm">/* SDLC flag value */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R9</span><span class="p">,</span><span class="n">VIS</span><span class="p">);</span>			<span class="cm">/* vector includes status */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R10</span><span class="p">,(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">nrz</span><span class="o">?</span> <span class="n">NRZ</span> <span class="o">:</span> <span class="n">NRZI</span><span class="p">)</span><span class="o">|</span><span class="n">CRCPS</span><span class="o">|</span><span class="n">ABUNDER</span><span class="p">);</span> <span class="cm">/* abort on underrun, preset CRC generator, NRZ(I) */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R14</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="cm">/* set clock sources:</span>

<span class="cm">   CLK_DPLL: normal halfduplex operation</span>
<span class="cm">   </span>
<span class="cm">		RxClk: use DPLL</span>
<span class="cm">		TxClk: use DPLL</span>
<span class="cm">		TRxC mode DPLL output</span>
<span class="cm">		</span>
<span class="cm">   CLK_EXTERNAL: external clocking (G3RUH or DF9IC modem)</span>
<span class="cm">   </span>
<span class="cm">  	        BayCom: 		others:</span>
<span class="cm">  	        </span>
<span class="cm">  	        TxClk = pin RTxC	TxClk = pin TRxC</span>
<span class="cm">  	        RxClk = pin TRxC 	RxClk = pin RTxC</span>
<span class="cm">  	     </span>

<span class="cm">   CLK_DIVIDER:</span>
<span class="cm">   		RxClk = use DPLL</span>
<span class="cm">   		TxClk = pin RTxC</span>
<span class="cm">   		</span>
<span class="cm">   		BayCom:			others:</span>
<span class="cm">   		pin TRxC = DPLL		pin TRxC = BRG</span>
<span class="cm">   		(RxClk * 1)		(RxClk * 32)</span>
<span class="cm">*/</span>  

   		
	<span class="k">switch</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">clocksrc</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">CLK_DPLL</span>:
			<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R11</span><span class="p">,</span> <span class="n">RCDPLL</span><span class="o">|</span><span class="n">TCDPLL</span><span class="o">|</span><span class="n">TRxCOI</span><span class="o">|</span><span class="n">TRxCDP</span><span class="p">);</span>
			<span class="n">init_brg</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLK_DIVIDER</span>:
			<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R11</span><span class="p">,</span> <span class="p">((</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">brand</span> <span class="o">&amp;</span> <span class="n">BAYCOM</span><span class="p">)</span><span class="o">?</span> <span class="n">TRxCDP</span> <span class="o">:</span> <span class="n">TRxCBR</span><span class="p">)</span> <span class="o">|</span> <span class="n">RCDPLL</span><span class="o">|</span><span class="n">TCRTxCP</span><span class="o">|</span><span class="n">TRxCOI</span><span class="p">);</span>
			<span class="n">init_brg</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLK_EXTERNAL</span>:
			<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R11</span><span class="p">,</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">brand</span> <span class="o">&amp;</span> <span class="n">BAYCOM</span><span class="p">)</span><span class="o">?</span> <span class="n">RCTRxCP</span><span class="o">|</span><span class="n">TCRTxCP</span> <span class="o">:</span> <span class="n">RCRTxCP</span><span class="o">|</span><span class="n">TCTRxCP</span><span class="p">);</span>
			<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">R14</span><span class="p">,</span> <span class="n">DISDPLL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	
	<span class="n">set_speed</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>			<span class="cm">/* set baudrate */</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">enhanced</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R15</span><span class="p">,</span><span class="n">SHDLCE</span><span class="o">|</span><span class="n">FIFOE</span><span class="p">);</span>	<span class="cm">/* enable FIFO, SDLC/HDLC Enhancements (From now R7 is R7&#39;) */</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R7</span><span class="p">,</span><span class="n">AUTOEOM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span> <span class="o">||</span> <span class="p">(</span><span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DCD</span><span class="p">))</span>
						<span class="cm">/* DCD is now ON */</span>
	<span class="p">{</span>
		<span class="n">start_hunt</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="cm">/* enable ABORT, DCD &amp; SYNC/HUNT interrupts */</span>

	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R15</span><span class="p">,</span> <span class="n">BRKIE</span><span class="o">|</span><span class="n">TxUIE</span><span class="o">|</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="o">?</span> <span class="n">SYNCIE</span><span class="o">:</span><span class="n">DCDIE</span><span class="p">));</span>

	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EXT_INT</span><span class="p">);</span>	<span class="cm">/* reset ext/status interrupts */</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EXT_INT</span><span class="p">);</span>	<span class="cm">/* must be done twice */</span>

	<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R1</span><span class="p">,</span><span class="n">INT_ALL_Rx</span><span class="o">|</span><span class="n">TxINT_ENAB</span><span class="o">|</span><span class="n">EXT_INT_ENAB</span><span class="p">);</span> <span class="cm">/* enable interrupts */</span>
	
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R0</span><span class="p">);</span>	<span class="cm">/* read initial status */</span>
	
	<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R9</span><span class="p">,</span><span class="n">MIE</span><span class="p">);</span>			<span class="cm">/* master interrupt enable */</span>
	
	<span class="n">scc_init_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *			SCC timer functions			      * */</span>
<span class="cm">/* ******************************************************************** */</span>


<span class="cm">/* ----&gt; scc_key_trx sets the time constant for the baudrate </span>
<span class="cm">         generator and keys the transmitter		     &lt;---- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_key_trx</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time_const</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">brand</span> <span class="o">&amp;</span> <span class="n">PRIMUS</span><span class="p">)</span>
		<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">option</span> <span class="o">|</span> <span class="p">(</span><span class="n">tx</span><span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">)</span> 
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">;</span>

	<span class="n">time_const</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">/</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span> <span class="o">*</span> <span class="p">(</span><span class="n">tx</span><span class="o">?</span> <span class="mi">2</span><span class="o">:</span><span class="mi">64</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">disable_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">TxINT_ENAB</span><span class="p">);</span>	<span class="cm">/* t_maxkeyup may have reset these */</span>
		<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">TxUIE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">clocksrc</span> <span class="o">==</span> <span class="n">CLK_DPLL</span><span class="p">)</span>
	<span class="p">{</span>				<span class="cm">/* force simplex operation */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
		<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCC_TRXECHO</span>
			<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">RxENABLE</span><span class="o">|</span><span class="n">ENT_HM</span><span class="p">);</span>	<span class="cm">/* switch off receiver */</span>
			<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">DCDIE</span><span class="o">|</span><span class="n">SYNCIE</span><span class="p">);</span>	<span class="cm">/* No DCD changes, please */</span>
<span class="cp">#endif</span>
			<span class="n">set_brg</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">time_const</span><span class="p">);</span>	<span class="cm">/* reprogram baudrate generator */</span>

			<span class="cm">/* DPLL -&gt; Rx clk, BRG -&gt; Tx CLK, TRxC mode output, TRxC = BRG */</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R11</span><span class="p">,</span> <span class="n">RCDPLL</span><span class="o">|</span><span class="n">TCBR</span><span class="o">|</span><span class="n">TRxCOI</span><span class="o">|</span><span class="n">TRxCBR</span><span class="p">);</span>
			
			<span class="cm">/* By popular demand: tx_inhibit */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tx_inhibit</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R5</span><span class="p">,</span> <span class="n">TxENAB</span><span class="p">);</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RTS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R5</span><span class="p">,</span><span class="n">RTS</span><span class="o">|</span><span class="n">TxENAB</span><span class="p">);</span>	<span class="cm">/* set the RTS line and enable TX */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R5</span><span class="p">,</span><span class="n">RTS</span><span class="o">|</span><span class="n">TxENAB</span><span class="p">);</span>
			
			<span class="n">set_brg</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">time_const</span><span class="p">);</span>	<span class="cm">/* reprogram baudrate generator */</span>
			
			<span class="cm">/* DPLL -&gt; Rx clk, DPLL -&gt; Tx CLK, TRxC mode output, TRxC = DPLL */</span>
			<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R11</span><span class="p">,</span> <span class="n">RCDPLL</span><span class="o">|</span><span class="n">TCDPLL</span><span class="o">|</span><span class="n">TRxCOI</span><span class="o">|</span><span class="n">TRxCDP</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_SCC_TRXECHO</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="p">{</span>
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R15</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="o">?</span> <span class="n">SYNCIE</span><span class="o">:</span><span class="n">DCDIE</span><span class="p">);</span>
				<span class="n">start_hunt</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
		<span class="p">{</span>
<span class="cp">#ifdef CONFIG_SCC_TRXECHO</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">==</span> <span class="n">KISS_DUPLEX_HALF</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R3</span><span class="p">,</span> <span class="n">RxENABLE</span><span class="p">);</span>
				<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">DCDIE</span><span class="o">|</span><span class="n">SYNCIE</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
				
			<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tx_inhibit</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R5</span><span class="p">,</span> <span class="n">TxENAB</span><span class="p">);</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R5</span><span class="p">]</span> <span class="o">|=</span> <span class="n">RTS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R5</span><span class="p">,</span><span class="n">RTS</span><span class="o">|</span><span class="n">TxENAB</span><span class="p">);</span>	<span class="cm">/* enable tx */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R5</span><span class="p">,</span><span class="n">RTS</span><span class="o">|</span><span class="n">TxENAB</span><span class="p">);</span>		<span class="cm">/* disable tx */</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">==</span> <span class="n">KISS_DUPLEX_HALF</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
<span class="cp">#ifndef CONFIG_SCC_TRXECHO</span>
			    <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="p">)</span>
<span class="cp">#else</span>
			    <span class="mi">1</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="p">{</span>
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="o">?</span> <span class="n">SYNCIE</span><span class="o">:</span><span class="n">DCDIE</span><span class="p">);</span>
				<span class="n">start_hunt</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">enable_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ----&gt; SCC timer interrupt handler and friends. &lt;---- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__scc_start_tx_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">when</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">when</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">handler</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">when</span> <span class="o">!=</span> <span class="n">TIMER_OFF</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scc</span><span class="p">;</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">when</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_start_tx_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">when</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">when</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_start_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxdefer</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxdefer</span> <span class="o">!=</span> <span class="n">TIMER_OFF</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scc</span><span class="p">;</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">t_busy</span><span class="p">;</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxdefer</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_start_maxkeyup</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxkeyup</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxkeyup</span> <span class="o">!=</span> <span class="n">TIMER_OFF</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scc</span><span class="p">;</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">t_maxkeyup</span><span class="p">;</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxkeyup</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * This is called from scc_txint() when there are no more frames to send.</span>
<span class="cm"> * Not exactly a timer function, but it is a close friend of the family...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* </span>
<span class="cm">	 * trx remains keyed in fulldup mode 2 until t_idle expires.</span>
<span class="cm">	 */</span>
				 
	<span class="k">switch</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">KISS_DUPLEX_LINK</span>:
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_IDLE2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">idletime</span> <span class="o">!=</span> <span class="n">TIMER_OFF</span><span class="p">)</span>
				<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_idle</span><span class="p">,</span>
						   <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">idletime</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KISS_DUPLEX_OPTIMA</span>:
			<span class="n">scc_notify</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">HWEV_ALL_SENT</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_BUSY</span><span class="p">;</span>
			<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_tail</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tailtime</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Rand</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_grouped</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">grp1</span><span class="p">,</span> <span class="n">grp2</span><span class="p">;</span>

	<span class="n">grp1</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">group</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">Nchips</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">scc2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">grp2</span> <span class="o">=</span> <span class="n">scc2</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">group</span><span class="p">;</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">scc2</span> <span class="o">==</span> <span class="n">scc</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">scc2</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">grp2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		
		<span class="k">if</span> <span class="p">((</span><span class="n">grp1</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">grp2</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">grp1</span> <span class="o">&amp;</span> <span class="n">TXGROUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">scc2</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RTS</span><span class="p">)</span> <span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">grp1</span> <span class="o">&amp;</span> <span class="n">RXGROUP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scc2</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DWAIT and SLOTTIME expired</span>
<span class="cm"> *</span>
<span class="cm"> * fulldup == 0:  DCD is active or Rand &gt; P-persistence: start t_busy timer</span>
<span class="cm"> *                else key trx and start txdelay</span>
<span class="cm"> * fulldup == 1:  key trx and start txdelay</span>
<span class="cm"> * fulldup == 2:  mintime expired, reset status or key trx and start txdelay</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t_dwait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TXS_WAIT</span><span class="p">)</span>	<span class="cm">/* maxkeyup or idle timeout */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* nothing to send */</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_IDLE</span><span class="p">;</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* t_maxkeyup locked it. */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">==</span> <span class="n">KISS_DUPLEX_HALF</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">Rand</span> <span class="o">=</span> <span class="n">Rand</span> <span class="o">*</span> <span class="mi">17</span> <span class="o">+</span> <span class="mi">31</span><span class="p">;</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span> <span class="o">||</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">persist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Rand</span> <span class="o">||</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="n">is_grouped</span><span class="p">(</span><span class="n">scc</span><span class="p">))</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">scc_start_defer</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_dwait</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">slottime</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RTS</span><span class="p">)</span> <span class="p">)</span>
	<span class="p">{</span>
		<span class="n">scc_key_trx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">TX_ON</span><span class="p">);</span>
		<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_txdelay</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">txdelay</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_txdelay</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* TXDELAY expired</span>
<span class="cm"> *</span>
<span class="cm"> * kick transmission by a fake scc_txint(scc), start &#39;maxkeyup&#39; watchdog.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t_txdelay</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">scc_start_maxkeyup</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">scc_txint</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>	
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
	

<span class="cm">/* TAILTIME expired</span>
<span class="cm"> *</span>
<span class="cm"> * switch off transmitter. If we were stopped by Maxkeyup restart</span>
<span class="cm"> * transmission after &#39;mintime&#39; seconds</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t_tail</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> 
 	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>	
 	<span class="n">scc_key_trx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">TX_OFF</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TXS_TIMEOUT</span><span class="p">)</span>		<span class="cm">/* we had a timeout? */</span>
 	<span class="p">{</span>
 		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_WAIT</span><span class="p">;</span>
		<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_dwait</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">mintime</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
 		<span class="k">return</span><span class="p">;</span>
 	<span class="p">}</span>
 	
 	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_IDLE</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* BUSY timeout</span>
<span class="cm"> *</span>
<span class="cm"> * throw away send buffers if DCD remains active too long.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t_busy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>	<span class="cm">/* don&#39;t pile on the wabbit! */</span>

	<span class="n">scc_discard_buffers</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">txerrs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_IDLE</span><span class="p">;</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>	
<span class="p">}</span>

<span class="cm">/* MAXKEYUP timeout</span>
<span class="cm"> *</span>
<span class="cm"> * this is our watchdog.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t_maxkeyup</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* </span>
<span class="cm">	 * let things settle down before we start to</span>
<span class="cm">	 * accept new data.</span>
<span class="cm">	 */</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">scc_discard_buffers</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>

	<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R1</span><span class="p">,</span> <span class="n">TxINT_ENAB</span><span class="p">);</span>	<span class="cm">/* force an ABORT, but don&#39;t */</span>
	<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">TxUIE</span><span class="p">);</span>		<span class="cm">/* count it. */</span>
	<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">R0</span><span class="p">,</span> <span class="n">RES_Tx_P</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">txerrs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_TIMEOUT</span><span class="p">;</span>
	<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_tail</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tailtime</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* IDLE timeout</span>
<span class="cm"> *</span>
<span class="cm"> * in fulldup mode 2 it keys down the transmitter after &#39;idle&#39; seconds</span>
<span class="cm"> * of inactivity. We will not restart transmission before &#39;mintime&#39;</span>
<span class="cm"> * expires.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">t_idle</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>
	
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>

	<span class="n">scc_key_trx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">TX_OFF</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">mintime</span><span class="p">)</span>
		<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_dwait</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">mintime</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_WAIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_init_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>	
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_IDLE</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *			Set/get L1 parameters			      * */</span>
<span class="cm">/* ******************************************************************** */</span>


<span class="cm">/*</span>
<span class="cm"> * this will set the &quot;hardware&quot; parameters through KISS commands or ioctl()</span>
<span class="cm"> */</span>

<span class="cp">#define CAST(x) (unsigned long)(x)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">scc_set_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">PARAM_TXDELAY</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">txdelay</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_PERSIST</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">persist</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_SLOTTIME</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">slottime</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_TXTAIL</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tailtime</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_FULLDUP</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_DTR</span>:		<span class="k">break</span><span class="p">;</span> <span class="cm">/* does someone need this? */</span>
		<span class="k">case</span> <span class="n">PARAM_GROUP</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">group</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_IDLE</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">idletime</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_MIN</span>:		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">mintime</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_MAXKEY</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxkeyup</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_WAIT</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">waittime</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_MAXDEFER</span>:	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxdefer</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PARAM_TX</span>:		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tx_inhibit</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PARAM_SOFTDCD</span>:	
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">SYNCIE</span><span class="p">);</span>
				<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">DCDIE</span><span class="p">);</span>
				<span class="n">start_hunt</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">or</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">DCDIE</span><span class="p">);</span>
				<span class="n">cl</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R15</span><span class="p">,</span> <span class="n">SYNCIE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
				
		<span class="k">case</span> <span class="n">PARAM_SPEED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span><span class="o">=</span><span class="n">arg</span><span class="o">*</span><span class="mi">100</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span><span class="o">=</span><span class="n">arg</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* only switch baudrate on rx... ;-) */</span>
				<span class="n">set_speed</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="n">PARAM_RTS</span>:	
			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RTS</span><span class="p">)</span> <span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="n">TX_OFF</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">scc_key_trx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">TX_ON</span><span class="p">);</span>
					<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_txdelay</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">txdelay</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="n">TX_OFF</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_BUSY</span><span class="p">;</span>
					<span class="n">scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_tail</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tailtime</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="n">PARAM_HWEVENT</span>:
			<span class="n">scc_notify</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">dcd</span><span class="o">?</span> <span class="n">HWEV_DCD_ON</span><span class="o">:</span><span class="n">HWEV_DCD_OFF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


 
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">scc_get_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">PARAM_TXDELAY</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">txdelay</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_PERSIST</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">persist</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_SLOTTIME</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">slottime</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_TXTAIL</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tailtime</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_FULLDUP</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_SOFTDCD</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_DTR</span>:		<span class="k">return</span> <span class="n">CAST</span><span class="p">((</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DTR</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_RTS</span>:		<span class="k">return</span> <span class="n">CAST</span><span class="p">((</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">R5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">RTS</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_SPEED</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_GROUP</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">group</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_IDLE</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">idletime</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_MIN</span>:		<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">mintime</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_MAXKEY</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxkeyup</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_WAIT</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">waittime</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_MAXDEFER</span>:	<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxdefer</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">PARAM_TX</span>:		<span class="k">return</span> <span class="n">CAST</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tx_inhibit</span><span class="p">);</span>
		<span class="nl">default:</span>		<span class="k">return</span> <span class="n">NO_SUCH_PARAM</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cp">#undef CAST</span>

<span class="cm">/* ******************************************************************* */</span>
<span class="cm">/* *			Send calibration pattern		     * */</span>
<span class="cm">/* ******************************************************************* */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_stop_calibrate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>
	<span class="n">scc_key_trx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">TX_OFF</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R7</span><span class="p">,</span> <span class="n">FLAG</span><span class="p">);</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EXT_INT</span><span class="p">);</span>	<span class="cm">/* reset ext/status interrupts */</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EXT_INT</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">scc_start_calibrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">duration</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">scc_discard_buffers</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>

	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">scc</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">scc_stop_calibrate</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">*</span><span class="n">duration</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>

	<span class="cm">/* This doesn&#39;t seem to work. Why not? */</span>	
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R7</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>

	<span class="cm">/* </span>
<span class="cm">	 * Don&#39;t know if this works. </span>
<span class="cm">	 * Damn, where is my Z8530 programming manual...? </span>
<span class="cm">	 */</span>

	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EXT_INT</span><span class="p">);</span>	<span class="cm">/* reset ext/status interrupts */</span>
	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">RES_EXT_INT</span><span class="p">);</span>

	<span class="n">scc_key_trx</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">TX_ON</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ******************************************************************* */</span>
<span class="cm">/* *		Init channel structures, special HW, etc...	     * */</span>
<span class="cm">/* ******************************************************************* */</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the Z8530s and setup special hardware</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">z8530_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">flag</span><span class="p">;</span>


	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Init Z8530 driver: %u channels, IRQ&quot;</span><span class="p">,</span> <span class="n">Nchips</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	
	<span class="n">flag</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nr_irqs</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Ivec</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">used</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
			<span class="n">flag</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="cm">/* reset and pre-init all chips in the system */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">Nchips</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">scc</span><span class="o">=&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">chip</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Special SCC cards */</span>

		<span class="k">if</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">brand</span> <span class="o">&amp;</span> <span class="n">EAGLE</span><span class="p">)</span>			<span class="cm">/* this is an EAGLE card */</span>
			<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">,</span><span class="mh">0x08</span><span class="p">);</span>	<span class="cm">/* enable interrupt on the board */</span>
			
		<span class="k">if</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">brand</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PC100</span> <span class="o">|</span> <span class="n">PRIMUS</span><span class="p">))</span>	<span class="cm">/* this is a PC100/PRIMUS card */</span>
			<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">,</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">);</span>	<span class="cm">/* set the MODEM mode (0x22) */</span>

			
		<span class="cm">/* Reset and pre-init Z8530 */</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				
		<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">OutReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R9</span><span class="p">,</span><span class="n">FHWRES</span><span class="p">);</span>		<span class="cm">/* force hardware reset */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>				<span class="cm">/* give it &#39;a bit&#39; more time than required */</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">chip</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>			<span class="cm">/* interrupt vector */</span>
		<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">R9</span><span class="p">,</span> <span class="n">VIS</span><span class="p">);</span>			<span class="cm">/* vector includes status */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>		
        <span class="p">}</span>

 
	<span class="n">Driver_Initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate device structure, err, instance, and register driver</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scc_net_alloc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">scc_net_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">scc</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdevice</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t register network device (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		       <span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *			    Network driver methods		      * */</span>
<span class="cm">/* ******************************************************************** */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">scc_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>            <span class="o">=</span> <span class="n">scc_net_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	     <span class="o">=</span> <span class="n">scc_net_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>	     <span class="o">=</span> <span class="n">scc_net_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> <span class="o">=</span> <span class="n">scc_net_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>       <span class="o">=</span> <span class="n">scc_net_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>        <span class="o">=</span> <span class="n">scc_net_ioctl</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ----&gt; Initialize device &lt;----- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_net_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* should be enough... */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	     <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">ax25_header_ops</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax25_bcast</span><span class="p">,</span>  <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">ax25_defaddr</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
 
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_AX25</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="n">AX25_MAX_HEADER_LEN</span> <span class="o">+</span> <span class="n">AX25_BPQ_HEADER_LEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">AX25_DEF_PACLEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">AX25_ADDR_LEN</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* ----&gt; open network device &lt;---- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scc_net_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

 	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
 
	<span class="n">init_channel</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; close network device &lt;---- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scc_net_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>	
	<span class="n">Outb</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>		<span class="cm">/* Make sure pointer is written */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>			<span class="cm">/* disable interrupts */</span>
	<span class="n">wr</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span><span class="n">R3</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_wdog</span><span class="p">);</span>
	
	<span class="n">scc_discard_buffers</span><span class="p">(</span><span class="n">scc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; receive frame, called from scc_rxint() &lt;---- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_net_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ax25_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; transmit frame &lt;---- */</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">scc_net_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">kisscmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bufsize</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* bogus frame */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">txframes</span><span class="o">++</span><span class="p">;</span>
	
	<span class="n">kisscmd</span> <span class="o">=</span> <span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kisscmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scc_set_param</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">kisscmd</span><span class="p">,</span> <span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_del</span><span class="p">;</span>
		<span class="n">skb_del</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb_del</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	

	<span class="cm">/*</span>
<span class="cm">	 * Start transmission if the trx state is idle or</span>
<span class="cm">	 * t_idle hasn&#39;t expired yet. Use dwait/persistence/slottime</span>
<span class="cm">	 * algorithm for normal halfduplex operation.</span>
<span class="cm">	 */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TXS_IDLE</span> <span class="o">||</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">==</span> <span class="n">TXS_IDLE2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_state</span> <span class="o">=</span> <span class="n">TXS_BUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">==</span> <span class="n">KISS_DUPLEX_HALF</span><span class="p">)</span>
			<span class="n">__scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_dwait</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">waittime</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">__scc_start_tx_timer</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">t_dwait</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; ioctl functions &lt;---- */</span>

<span class="cm">/*</span>
<span class="cm"> * SIOCSCCCFG		- configure driver	arg: (struct scc_hw_config *) arg</span>
<span class="cm"> * SIOCSCCINI		- initialize driver	arg: ---</span>
<span class="cm"> * SIOCSCCCHANINI	- initialize channel	arg: (struct scc_modem *) arg</span>
<span class="cm"> * SIOCSCCSMEM		- set memory		arg: (struct scc_mem_config *) arg</span>
<span class="cm"> * SIOCSCCGKISS		- get level 1 parameter	arg: (struct scc_kiss_cmd *) arg</span>
<span class="cm"> * SIOCSCCSKISS		- set level 1 parameter arg: (struct scc_kiss_cmd *) arg</span>
<span class="cm"> * SIOCSCCGSTAT		- get driver status	arg: (struct scc_stat *) arg</span>
<span class="cm"> * SIOCSCCCAL		- send calib. pattern	arg: (struct scc_calibrate *) arg</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scc_net_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_kiss_cmd</span> <span class="n">kiss_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_mem_config</span> <span class="n">memcfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_hw_config</span> <span class="n">hwcfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_calibrate</span> <span class="n">cal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">device_name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">;</span>
	
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Driver_Initialized</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSCCCFG</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">Nchips</span> <span class="o">&gt;=</span> <span class="n">SCC_MAXCHIPS</span><span class="p">)</span> 
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hwcfg</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="n">nr_irqs</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Ivec</span><span class="p">[</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">].</span><span class="n">used</span> <span class="o">&amp;&amp;</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">scc_isr</span><span class="p">,</span>
						<span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="s">&quot;AX.25 SCC&quot;</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;z8530drv: warning, cannot get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">Ivec</span><span class="p">[</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">].</span><span class="n">used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">vector_latch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Vector_Latch</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">vector_latch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;scc vector latch&quot;</span><span class="p">))</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;z8530drv: warning, cannot reserve vector latch port 0x%lx</span><span class="se">\n</span><span class="s">, disabled.&quot;</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">vector_latch</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">Vector_Latch</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">vector_latch</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">hwcfg</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="n">SCC_DEFAULT_CLOCK</span><span class="p">;</span>

<span class="cp">#ifndef SCC_DONT_CHECK</span>

			<span class="k">if</span><span class="p">(</span><span class="n">request_region</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;scc-probe&quot;</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">disable_irq</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
				<span class="n">Outb</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">OutReg</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">,</span> <span class="n">R9</span><span class="p">,</span> <span class="n">FHWRES</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
				<span class="n">OutReg</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">,</span><span class="n">R13</span><span class="p">,</span><span class="mh">0x55</span><span class="p">);</span>		<span class="cm">/* is this chip really there? */</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">InReg</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">,</span><span class="n">R13</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55</span><span class="p">)</span>
					<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">enable_irq</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span>  <span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span>  <span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">data_a</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span>  <span class="p">].</span><span class="n">irq</span>  <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_b</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">data_b</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">irq</span>  <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>
			
				<span class="n">SCC_ctrl</span><span class="p">[</span><span class="n">Nchips</span><span class="p">].</span><span class="n">chan_A</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">;</span>
				<span class="n">SCC_ctrl</span><span class="p">[</span><span class="n">Nchips</span><span class="p">].</span><span class="n">chan_B</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_b</span><span class="p">;</span>
				<span class="n">SCC_ctrl</span><span class="p">[</span><span class="n">Nchips</span><span class="p">].</span><span class="n">irq</span>    <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">irq</span><span class="p">;</span>
			<span class="p">}</span>


			<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> <span class="s">&quot;%s%i&quot;</span><span class="p">,</span> <span class="n">SCC_DriverName</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">);</span>

				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">special</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">special</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">clock</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">brand</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">brand</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">option</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">option</span><span class="p">;</span>
				<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">enhanced</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">escc</span><span class="p">;</span>

<span class="cp">#ifdef SCC_DONT_CHECK</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: data port = 0x%3.3x  control port = 0x%3.3x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">device_name</span><span class="p">,</span> 
					<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> 
					<span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">ctrl</span><span class="p">);</span>

<span class="cp">#else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: data port = 0x%3.3lx  control port = 0x%3.3lx -- %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">device_name</span><span class="p">,</span>
					<span class="n">chan</span><span class="o">?</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">data_b</span> <span class="o">:</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">data_a</span><span class="p">,</span> 
					<span class="n">chan</span><span class="o">?</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_b</span> <span class="o">:</span> <span class="n">hwcfg</span><span class="p">.</span><span class="n">ctrl_a</span><span class="p">,</span>
					<span class="n">found</span><span class="o">?</span> <span class="s">&quot;found&quot;</span> <span class="o">:</span> <span class="s">&quot;missing&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">request_region</span><span class="p">(</span><span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;scc ctrl&quot;</span><span class="p">);</span>
					<span class="n">request_region</span><span class="p">(</span><span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;scc data&quot;</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					    <span class="n">scc_net_alloc</span><span class="p">(</span><span class="n">device_name</span><span class="p">,</span> 
							  <span class="o">&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">Nchips</span><span class="o">+</span><span class="n">chan</span><span class="p">]))</span>
					    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			
			<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="n">Nchips</span><span class="o">++</span><span class="p">;</span>
			
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSCCINI</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
				
			<span class="k">if</span> <span class="p">(</span><span class="n">Nchips</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">z8530_init</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>	<span class="cm">/* confuse the user */</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SIOCSCCCHANINI</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bufsize</span>   <span class="o">=</span> <span class="n">SCC_BUFSIZE</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scc_modem</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			
			<span class="cm">/* default KISS Params */</span>
		
			<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">4800</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">txdelay</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>		<span class="cm">/* 360 ms */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">persist</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>		<span class="cm">/* 25% persistence */</span>			<span class="cm">/* was 25 */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">slottime</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* 160 ms */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tailtime</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* minimal reasonable value */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* CSMA */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">waittime</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* 500 ms */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxkeyup</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* 10 s */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">mintime</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* 3 s */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">idletime</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>	<span class="cm">/* 30 s */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxdefer</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>	<span class="cm">/* 2 min */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* hardware dcd */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">txdelay</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>		<span class="cm">/* 100 ms */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">persist</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>		<span class="cm">/* 25% persistence */</span>			<span class="cm">/* was 25 */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">slottime</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* 160 ms */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">tailtime</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* minimal reasonable value */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">fulldup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* CSMA */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">waittime</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>	<span class="cm">/* 500 ms */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxkeyup</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>		<span class="cm">/* 7 s */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">mintime</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>		<span class="cm">/* 3 s */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">idletime</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>	<span class="cm">/* 30 s */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">maxdefer</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>	<span class="cm">/* 2 min */</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">.</span><span class="n">softdcd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* hardware dcd */</span>
			<span class="p">}</span>
			
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_buff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SIOCSCCRESERVED</span>:
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SIOCSCCSMEM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memcfg</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memcfg</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">bufsize</span>   <span class="o">=</span> <span class="n">memcfg</span><span class="p">.</span><span class="n">bufsize</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		
		<span class="k">case</span> <span class="n">SIOCSCCGSTAT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		
		<span class="k">case</span> <span class="n">SIOCSCCGKISS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kiss_cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kiss_cmd</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">kiss_cmd</span><span class="p">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">scc_get_param</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">kiss_cmd</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kiss_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kiss_cmd</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		
		<span class="k">case</span> <span class="n">SIOCSCCSKISS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kiss_cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kiss_cmd</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">scc_set_param</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">kiss_cmd</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">kiss_cmd</span><span class="p">.</span><span class="n">param</span><span class="p">);</span>
		
		<span class="k">case</span> <span class="n">SIOCSCCCAL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span> <span class="o">||</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cal</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cal</span><span class="p">))</span> <span class="o">||</span> <span class="n">cal</span><span class="p">.</span><span class="n">time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">scc_start_calibrate</span><span class="p">(</span><span class="n">scc</span><span class="p">,</span> <span class="n">cal</span><span class="p">.</span><span class="n">time</span><span class="p">,</span> <span class="n">cal</span><span class="p">.</span><span class="n">pattern</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		
	<span class="p">}</span>
	
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; set interface callsign &lt;---- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scc_net_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; get statistics &lt;---- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">scc_net_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rxerrs</span> <span class="o">+</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rx_over</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">txerrs</span> <span class="o">+</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_under</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">rx_over</span><span class="p">;</span>
	<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">.</span><span class="n">tx_fifo_errors</span> <span class="o">=</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">.</span><span class="n">tx_under</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev_stat</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* *		dump statistics to /proc/net/z8530drv		      * */</span>
<span class="cm">/* ******************************************************************** */</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="nf">scc_net_seq_idx</span><span class="p">(</span><span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">Nchips</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">init</span><span class="p">)</span> 
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">scc_net_seq_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">pos</span> <span class="o">?</span> <span class="n">scc_net_seq_idx</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">SEQ_START_TOKEN</span><span class="p">;</span>
	
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">scc_net_seq_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="o">++*</span><span class="n">pos</span><span class="p">;</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">scc</span> <span class="o">-</span> <span class="n">SCC_Info</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	     <span class="n">k</span> <span class="o">&lt;</span> <span class="n">Nchips</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">init</span><span class="p">)</span> 
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_net_seq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">scc_net_seq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">SEQ_START_TOKEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;z8530drv-&quot;</span><span class="n">VERSION</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Driver_Initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Nchips</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;chips missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">scc_stat</span> <span class="o">*</span><span class="n">stat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">scc_kiss</span> <span class="o">*</span><span class="n">kiss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">kiss</span><span class="p">;</span>


		<span class="cm">/* dev	data ctrl irq clock brand enh vector special option </span>
<span class="cm">		 *	baud nrz clocksrc softdcd bufsize</span>
<span class="cm">		 *	rxints txints exints spints</span>
<span class="cm">		 *	rcvd rxerrs over / xmit txerrs under / nospace bufsize</span>
<span class="cm">		 *	txd pers slot tail ful wait min maxk idl defr txof grp</span>
<span class="cm">		 *	W ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##</span>
<span class="cm">		 *	R ## ## XX ## ## ## ## ## XX ## ## ## ## ## ## ##</span>
<span class="cm">		 */</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\t</span><span class="s">%3.3lx %3.3lx %d %lu %2.2x %d %3.3lx %3.3lx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">brand</span><span class="p">,</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">enhanced</span><span class="p">,</span> <span class="n">Vector_Latch</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">special</span><span class="p">,</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%lu %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">nrz</span><span class="p">,</span>
				<span class="n">scc</span><span class="o">-&gt;</span><span class="n">modem</span><span class="p">.</span><span class="n">clocksrc</span><span class="p">,</span> <span class="n">kiss</span><span class="o">-&gt;</span><span class="n">softdcd</span><span class="p">,</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%lu %lu %lu %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">rxints</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">txints</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">exints</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">spints</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%lu %lu %d / %lu %lu %d / %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">rxframes</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">rxerrs</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">rx_over</span><span class="p">,</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">txframes</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">txerrs</span><span class="p">,</span> <span class="n">stat</span><span class="o">-&gt;</span><span class="n">tx_under</span><span class="p">,</span>
				<span class="n">stat</span><span class="o">-&gt;</span><span class="n">nospace</span><span class="p">,</span>  <span class="n">stat</span><span class="o">-&gt;</span><span class="n">tx_state</span><span class="p">);</span>

<span class="cp">#define K(x) kiss-&gt;x</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">%d %d %d %d %d %d %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">K</span><span class="p">(</span><span class="n">txdelay</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">persist</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">slottime</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">tailtime</span><span class="p">),</span>
				<span class="n">K</span><span class="p">(</span><span class="n">fulldup</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">waittime</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">mintime</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">maxkeyup</span><span class="p">),</span>
				<span class="n">K</span><span class="p">(</span><span class="n">idletime</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">maxdefer</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">tx_inhibit</span><span class="p">),</span> <span class="n">K</span><span class="p">(</span><span class="n">group</span><span class="p">));</span>
<span class="cp">#undef K</span>
<span class="cp">#ifdef SCC_DEBUG</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">W &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%2.2x &quot;</span><span class="p">,</span> <span class="n">scc</span><span class="o">-&gt;</span><span class="n">wreg</span><span class="p">[</span><span class="n">reg</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">R %2.2x %2.2x XX &quot;</span><span class="p">,</span> <span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R0</span><span class="p">),</span> <span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R1</span><span class="p">));</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%2.2x &quot;</span><span class="p">,</span> <span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;XX &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">reg</span><span class="o">++</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;%2.2x &quot;</span><span class="p">,</span> <span class="n">InReg</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">seq_putc</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
	<span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">seq_operations</span> <span class="n">scc_net_seq_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span>  <span class="o">=</span> <span class="n">scc_net_seq_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">scc_net_seq_next</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>   <span class="o">=</span> <span class="n">scc_net_seq_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">show</span>   <span class="o">=</span> <span class="n">scc_net_seq_show</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">scc_net_seq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">seq_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scc_net_seq_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">scc_net_seq_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	 <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	 <span class="o">=</span> <span class="n">scc_net_seq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	 <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>	 <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">seq_release_private</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

 
<span class="cm">/* ******************************************************************** */</span>
<span class="cm">/* * 			Init SCC driver 			      * */</span>
<span class="cm">/* ******************************************************************** */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">scc_init_driver</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">devname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>
	
	<span class="n">printk</span><span class="p">(</span><span class="n">banner</span><span class="p">);</span>
	
	<span class="n">sprintf</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span><span class="s">&quot;%s0&quot;</span><span class="p">,</span> <span class="n">SCC_DriverName</span><span class="p">);</span>
	
	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scc_net_alloc</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="n">SCC_Info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;z8530drv: cannot initialize module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="n">proc_net_fops_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="s">&quot;z8530drv&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scc_net_seq_fops</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">scc_cleanup_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">io_port</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scc_channel</span> <span class="o">*</span><span class="n">scc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">Nchips</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">SCC_Info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev</span><span class="p">))</span> 
	<span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Guard against chip prattle */</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">Nchips</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">SCC_ctrl</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">chan_A</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="n">Outb</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">OutReg</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span><span class="n">R9</span><span class="p">,</span><span class="n">FHWRES</span><span class="p">);</span>	<span class="cm">/* force hardware reset */</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="p">}</span>
		
	<span class="cm">/* To unload the port must be closed so no real IRQ pending */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nr_irqs</span> <span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Ivec</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">used</span><span class="p">)</span> <span class="n">free_irq</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		
	<span class="n">local_irq_enable</span><span class="p">();</span>
		
	<span class="cm">/* Now clean up */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">Nchips</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">scc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SCC_Info</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">scc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
		
	<span class="k">if</span> <span class="p">(</span><span class="n">Vector_Latch</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">Vector_Latch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">proc_net_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="s">&quot;z8530drv&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Joerg Reuter &lt;jreuter@yaina.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;AX.25 Device Driver for Z8530 based HDLC cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;Z8530 based SCC cards for Amateur Radio&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">scc_init_driver</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">scc_cleanup_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
