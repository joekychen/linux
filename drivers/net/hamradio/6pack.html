<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hamradio › 6pack.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>6pack.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * 6pack.c	This module implements the 6pack protocol for kernel-based</span>
<span class="cm"> *		devices like TTY. It interfaces between a raw TTY and the</span>
<span class="cm"> *		kernel&#39;s AX.25 protocol layers.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:	Andreas Könsgen &lt;ajk@comnets.uni-bremen.de&gt;</span>
<span class="cm"> *              Ralf Baechle DL5RB &lt;ralf@linux-mips.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Quite a lot of stuff &quot;stolen&quot; by Joerg Reuter from slip.c, written by</span>
<span class="cm"> *</span>
<span class="cm"> *		Laurence Culhane, &lt;loz@holmes.demon.co.uk&gt;</span>
<span class="cm"> *		Fred N. van Kempen, &lt;waltje@uwalt.nl.mugnet.org&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/ax25.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ip.h&gt;</span>
<span class="cp">#include &lt;linux/tcp.h&gt;</span>
<span class="cp">#include &lt;linux/semaphore.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#define SIXPACK_VERSION    &quot;Revision: 0.3.0&quot;</span>

<span class="cm">/* sixpack priority commands */</span>
<span class="cp">#define SIXP_SEOF		0x40	</span><span class="cm">/* start and end of a 6pack frame */</span><span class="cp"></span>
<span class="cp">#define SIXP_TX_URUN		0x48	</span><span class="cm">/* transmit overrun */</span><span class="cp"></span>
<span class="cp">#define SIXP_RX_ORUN		0x50	</span><span class="cm">/* receive overrun */</span><span class="cp"></span>
<span class="cp">#define SIXP_RX_BUF_OVL		0x58	</span><span class="cm">/* receive buffer overflow */</span><span class="cp"></span>

<span class="cp">#define SIXP_CHKSUM		0xFF	</span><span class="cm">/* valid checksum of a 6pack frame */</span><span class="cp"></span>

<span class="cm">/* masks to get certain bits out of the status bytes sent by the TNC */</span>

<span class="cp">#define SIXP_CMD_MASK		0xC0</span>
<span class="cp">#define SIXP_CHN_MASK		0x07</span>
<span class="cp">#define SIXP_PRIO_CMD_MASK	0x80</span>
<span class="cp">#define SIXP_STD_CMD_MASK	0x40</span>
<span class="cp">#define SIXP_PRIO_DATA_MASK	0x38</span>
<span class="cp">#define SIXP_TX_MASK		0x20</span>
<span class="cp">#define SIXP_RX_MASK		0x10</span>
<span class="cp">#define SIXP_RX_DCD_MASK	0x18</span>
<span class="cp">#define SIXP_LEDS_ON		0x78</span>
<span class="cp">#define SIXP_LEDS_OFF		0x60</span>
<span class="cp">#define SIXP_CON		0x08</span>
<span class="cp">#define SIXP_STA		0x10</span>

<span class="cp">#define SIXP_FOUND_TNC		0xe9</span>
<span class="cp">#define SIXP_CON_ON		0x68</span>
<span class="cp">#define SIXP_DCD_MASK		0x08</span>
<span class="cp">#define SIXP_DAMA_OFF		0</span>

<span class="cm">/* default level 2 parameters */</span>
<span class="cp">#define SIXP_TXDELAY			(HZ/4)	</span><span class="cm">/* in 1 s */</span><span class="cp"></span>
<span class="cp">#define SIXP_PERSIST			50	</span><span class="cm">/* in 256ths */</span><span class="cp"></span>
<span class="cp">#define SIXP_SLOTTIME			(HZ/10)	</span><span class="cm">/* in 1 s */</span><span class="cp"></span>
<span class="cp">#define SIXP_INIT_RESYNC_TIMEOUT	(3*HZ/2) </span><span class="cm">/* in 1 s */</span><span class="cp"></span>
<span class="cp">#define SIXP_RESYNC_TIMEOUT		5*HZ	</span><span class="cm">/* in 1 s */</span><span class="cp"></span>

<span class="cm">/* 6pack configuration. */</span>
<span class="cp">#define SIXP_NRUNIT			31      </span><span class="cm">/* MAX number of 6pack channels */</span><span class="cp"></span>
<span class="cp">#define SIXP_MTU			256	</span><span class="cm">/* Default MTU */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">sixpack_flags</span> <span class="p">{</span>
	<span class="n">SIXPF_ERROR</span><span class="p">,</span>	<span class="cm">/* Parity, etc. error	*/</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sixpack</span> <span class="p">{</span>
	<span class="cm">/* Various fields. */</span>
	<span class="k">struct</span> <span class="n">tty_struct</span>	<span class="o">*</span><span class="n">tty</span><span class="p">;</span>		<span class="cm">/* ptr to TTY structure	*/</span>
	<span class="k">struct</span> <span class="n">net_device</span>	<span class="o">*</span><span class="n">dev</span><span class="p">;</span>		<span class="cm">/* easy for intr handling  */</span>

	<span class="cm">/* These are pointers to the malloc()ed frame buffers. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">rbuff</span><span class="p">;</span>		<span class="cm">/* receiver buffer	*/</span>
	<span class="kt">int</span>			<span class="n">rcount</span><span class="p">;</span>         <span class="cm">/* received chars counter  */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">xbuff</span><span class="p">;</span>		<span class="cm">/* transmitter buffer	*/</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">xhead</span><span class="p">;</span>         <span class="cm">/* next byte to XMIT */</span>
	<span class="kt">int</span>			<span class="n">xleft</span><span class="p">;</span>          <span class="cm">/* bytes left in XMIT queue  */</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">raw_buf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">cooked_buf</span><span class="p">[</span><span class="mi">400</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rx_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rx_count_cooked</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">mtu</span><span class="p">;</span>		<span class="cm">/* Our mtu (to spot changes!) */</span>
	<span class="kt">int</span>			<span class="n">buffsize</span><span class="p">;</span>       <span class="cm">/* Max buffers sizes */</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>		<span class="cm">/* Flag values/ mode etc */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">mode</span><span class="p">;</span>		<span class="cm">/* 6pack mode */</span>

	<span class="cm">/* 6pack stuff */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">tx_delay</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">persistence</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">slottime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">duplex</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">led_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">status1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">status2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">tx_enable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">tnc_state</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">tx_t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">resync_t</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">refcnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">semaphore</span>	<span class="n">dead_sem</span><span class="p">;</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define AX25_6PACK_HEADER_LEN 0</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">sixpack_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">[],</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">encode_sixpack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Perform the persistence/slottime algorithm for CSMA access. If the</span>
<span class="cm"> * persistence check was successful, write the data to the serial driver.</span>
<span class="cm"> * Note that in case of DAMA operation, the data is not sent here.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_xmit_on_air</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">slottime</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">random</span><span class="p">;</span>

	<span class="n">random</span> <span class="o">=</span> <span class="n">random</span> <span class="o">*</span> <span class="mi">17</span> <span class="o">+</span> <span class="mi">41</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">SIXP_DCD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">random</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">persistence</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">actual</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="n">when</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----&gt; 6pack timer interrupt handler and friends. &lt;---- */</span>

<span class="cm">/* Encapsulate one AX.25 frame and stuff into a TTY queue. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_encaps</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">icp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">icp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* sp-&gt;mtu = AX25_MTU = max. PACLEN = 256 */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;oversized transmit packet!&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* sp-&gt;mtu = AX25_MTU = max. PACLEN = 256 */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;oversized transmit packet!&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;invalid KISS command&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;KISS control packet too long&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;bad AX.25 packet to transmit&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">encode_sixpack</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_delay</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_delay</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">persistence</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:	<span class="cm">/* ignored */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case of fullduplex or DAMA operation, we don&#39;t take care about the</span>
<span class="cm">	 * state of the DCD or of any timers, as the determination of the</span>
<span class="cm">	 * correct time to send is the job of the AX.25 layer. We send</span>
<span class="cm">	 * immediately after data has arrived.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">actual</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">actual</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span> <span class="o">+</span> <span class="n">actual</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">sp_xmit_on_air</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_drop:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s - dropped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Encapsulate an IP datagram and kick it into a TTY queue. */</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">sp_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* We were not busy, so we are now... :-) */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">sp_encaps</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_open_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Close the low-level part of the 6pack channel. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TTY discipline is running. */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the frame type ID */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_INET</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ETH_P_AX25</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ax25_hard_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">daddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_ax25</span> <span class="o">*</span><span class="n">sa</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_addr_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sax25_call</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
	<span class="n">netif_addr_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sp_rebuild_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_INET</span>
	<span class="k">return</span> <span class="n">ax25_rebuild_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">header_ops</span> <span class="n">sp_header_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span>		<span class="o">=</span> <span class="n">sp_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rebuild</span>	<span class="o">=</span> <span class="n">sp_rebuild_header</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sp_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sp_open_dev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sp_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sp_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>    <span class="o">=</span> <span class="n">sp_set_mac_address</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Finish setting up the DEVICE info. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sp_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">destructor</span>		<span class="o">=</span> <span class="n">free_netdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span>		<span class="o">=</span> <span class="n">SIXP_MTU</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span>	<span class="o">=</span> <span class="n">AX25_MAX_HEADER_LEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> 	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sp_header_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>		<span class="o">=</span> <span class="n">AX25_ADDR_LEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">ARPHRD_AX25</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* Only activated in AX.25 mode */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax25_bcast</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ax25_defaddr</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send one completely decapsulated IP datagram to the IP layer. */</span>

<span class="cm">/*</span>
<span class="cm"> * This is the routine that sends the received data to the kernel AX.25.</span>
<span class="cm"> * &#39;cmd&#39; is the KISS command. For AX.25 data, it is zero.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_bump</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">count</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mem</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>	<span class="cm">/* KISS command */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cooked_buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ax25_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">out_mem:</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * We have a potential race on dereferencing tty-&gt;disc_data, because the tty</span>
<span class="cm"> * layer provides no locking at all - thus one cpu could be running</span>
<span class="cm"> * sixpack_receive_buf while another calls sixpack_close, which zeroes</span>
<span class="cm"> * tty-&gt;disc_data and frees the memory that sixpack_receive_buf is using.  The</span>
<span class="cm"> * best way to fix this is to use a rwlock in the tty struct, but for now we</span>
<span class="cm"> * use a single global rwlock for all ttys in ppp line discipline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">disc_data_lock</span><span class="p">);</span>
                                                                                
<span class="k">static</span> <span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="nf">sp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sp_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dead_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by the TTY driver when there&#39;s room for more data.  If we have</span>
<span class="cm"> * more packets to send, we send them here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sixpack_write_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">sp_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
		<span class="cm">/* Now serial buffer is almost free &amp; we can start</span>
<span class="cm">		 * transmission of another packet */</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TTY_DO_WRITE_WAKEUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">actual</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xhead</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">sp_put</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the &#39;receiver data ready&#39; interrupt.</span>
<span class="cm"> * This function is called by the &#39;tty_io&#39; module in the kernel when</span>
<span class="cm"> * a block of 6pack data has been received, which can now be decapsulated</span>
<span class="cm"> * and sent on to some IP layer for further processing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sixpack_receive_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">count1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">sp_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">?</span> <span class="n">count</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="cm">/* Read the characters out of the buffer */</span>

	<span class="n">count1</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fp</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">fp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">SIXPF_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sixpack_decode</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count1</span><span class="p">);</span>

	<span class="n">sp_put</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="n">tty_unthrottle</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to resync the TNC. Called by the resync timer defined in</span>
<span class="cm"> * decode_prio_command</span>
<span class="cm"> */</span>

<span class="cp">#define TNC_UNINITIALIZED	0</span>
<span class="cp">#define TNC_UNSYNC_STARTUP	1</span>
<span class="cp">#define TNC_UNSYNCED		2</span>
<span class="cp">#define TNC_IN_SYNC		3</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__tnc_set_sync_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_tnc_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">new_tnc_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>			<span class="cm">/* gcc oh piece-o-crap ... */</span>
	<span class="k">case</span> <span class="n">TNC_UNSYNC_STARTUP</span>:
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Synchronizing with TNC&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TNC_UNSYNCED</span>:
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Lost synchronization with TNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TNC_IN_SYNC</span>:
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Found TNC&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tnc_state</span> <span class="o">=</span> <span class="n">new_tnc_state</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">tnc_set_sync_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_tnc_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_tnc_state</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tnc_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_tnc_state</span> <span class="o">!=</span> <span class="n">new_tnc_state</span><span class="p">)</span>
		<span class="n">__tnc_set_sync_state</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">new_tnc_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resync_tnc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="p">)</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">resync_cmd</span> <span class="o">=</span> <span class="mh">0xe8</span><span class="p">;</span>

	<span class="cm">/* clear any data that might have been received */</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* reset state machine */</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* resync the TNC */</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resync_cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>


	<span class="cm">/* Start resync timer again -- the TNC might be still absent */</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">function</span>	<span class="o">=</span> <span class="n">resync_tnc</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">expires</span>	<span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SIXP_RESYNC_TIMEOUT</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">tnc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">inbyte</span> <span class="o">=</span> <span class="mh">0xe8</span><span class="p">;</span>

	<span class="n">tnc_set_sync_state</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">TNC_UNSYNC_STARTUP</span><span class="p">);</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inbyte</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">resync_tnc</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SIXP_RESYNC_TIMEOUT</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open the high-level part of the 6pack channel.</span>
<span class="cm"> * This function is called by the TTY module when the</span>
<span class="cm"> * 6pack line discipline is called for.  Because we are</span>
<span class="cm"> * sure the tty line exists, we only have to link it to</span>
<span class="cm"> * a free 6pcack channel...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sixpack_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">xbuff</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span><span class="p">),</span> <span class="s">&quot;sp%d&quot;</span><span class="p">,</span> <span class="n">sp_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dead_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* !!! length of the buffers. MTU is IP MTU, not PACLEN!  */</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">rbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">xbuff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rbuff</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">xbuff</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span> <span class="o">=</span> <span class="n">tty</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rbuff</span>	<span class="o">=</span> <span class="n">rbuff</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span>	<span class="o">=</span> <span class="n">xbuff</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mtu</span>		<span class="o">=</span> <span class="n">AX25_MTU</span> <span class="o">+</span> <span class="mi">73</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">buffsize</span>	<span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rcount</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Clear ESCAPE &amp; ERROR flags */</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">duplex</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_delay</span>    <span class="o">=</span> <span class="n">SIXP_TXDELAY</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">persistence</span> <span class="o">=</span> <span class="n">SIXP_PERSIST</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">slottime</span>    <span class="o">=</span> <span class="n">SIXP_SLOTTIME</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span>   <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status1</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_enable</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">sp_xmit_on_air</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Done.  We have linked the TTY line to a channel. */</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">receive_room</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>

	<span class="cm">/* Now we&#39;re ready to register. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">tnc_init</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xbuff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rbuff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Close down a 6pack channel.</span>
<span class="cm"> * This means flushing out any pending queues, and then restoring the</span>
<span class="cm"> * TTY line discipline to what it was before it got hooked to 6pack</span>
<span class="cm"> * (which usually is TTY again).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sixpack_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>
	<span class="n">sp</span> <span class="o">=</span> <span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="n">tty</span><span class="o">-&gt;</span><span class="n">disc_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">disc_data_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have now ensured that nobody can start using ap from now on, but</span>
<span class="cm">	 * we have to wait for all existing users to finish.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span>
		<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dead_sem</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_t</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>

	<span class="cm">/* Free all 6pack frame buffers. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rbuff</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Perform I/O control on an active 6pack channel. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sixpack_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">sp_get</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGIFNAME</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		                   <span class="n">strlen</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGIFENCAP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSIFENCAP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>        <span class="o">=</span> <span class="n">AX25_ADDR_LEN</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="n">AX25_KISS_HEADER_LEN</span> <span class="o">+</span>
		                       <span class="n">AX25_MAX_HEADER_LEN</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>            <span class="o">=</span> <span class="n">ARPHRD_AX25</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	 <span class="k">case</span> <span class="n">SIOCSIFHWADDR</span>: <span class="p">{</span>
		<span class="kt">char</span> <span class="n">addr</span><span class="p">[</span><span class="n">AX25_ADDR_LEN</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span>
		                   <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">AX25_ADDR_LEN</span><span class="p">);</span>
			<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">tty_mode_ioctl</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sp_put</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">sixpack_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span> <span class="n">tty</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGIFNAME</span>:
	<span class="k">case</span> <span class="n">SIOCGIFENCAP</span>:
	<span class="k">case</span> <span class="n">SIOCSIFENCAP</span>:
	<span class="k">case</span> <span class="n">SIOCSIFHWADDR</span>:
		<span class="k">return</span> <span class="n">sixpack_ioctl</span><span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_ldisc_ops</span> <span class="n">sp_ldisc</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">magic</span>		<span class="o">=</span> <span class="n">TTY_LDISC_MAGIC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;6pack&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sixpack_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">sixpack_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">sixpack_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">sixpack_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">receive_buf</span>	<span class="o">=</span> <span class="n">sixpack_receive_buf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_wakeup</span>	<span class="o">=</span> <span class="n">sixpack_write_wakeup</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Initialize 6pack control device -- register 6pack line discipline */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">msg_banner</span><span class="p">[]</span>  <span class="n">__initdata</span> <span class="o">=</span> <span class="n">KERN_INFO</span> \
	<span class="s">&quot;AX.25: 6pack driver, &quot;</span> <span class="n">SIXPACK_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">msg_regfail</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="n">KERN_ERR</span>  \
	<span class="s">&quot;6pack: can&#39;t register line discipline (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sixpack_init_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">msg_banner</span><span class="p">);</span>

	<span class="cm">/* Register the provided line protocol discipline */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">tty_register_ldisc</span><span class="p">(</span><span class="n">N_6PACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_ldisc</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">msg_regfail</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">msg_unregfail</span><span class="p">[]</span> <span class="n">__exitdata</span> <span class="o">=</span> <span class="n">KERN_ERR</span> \
	<span class="s">&quot;6pack: can&#39;t unregister line discipline (err = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sixpack_exit_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">tty_unregister_ldisc</span><span class="p">(</span><span class="n">N_6PACK</span><span class="p">)))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">msg_unregfail</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* encode an AX.25 packet into 6pack */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">encode_sixpack</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tx_buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tx_buf_raw</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">400</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">raw_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIXP_PRIO_CMD_MASK</span> <span class="o">|</span> <span class="n">SIXP_TX_MASK</span><span class="p">;</span>
	<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIXP_SEOF</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_delay</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">tx_buf</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="n">checksum</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
			<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="p">]</span> <span class="o">=</span>	<span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3c</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="o">++</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">raw_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tx_buf_raw</span><span class="p">[</span><span class="n">raw_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIXP_SEOF</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">raw_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* decode 4 sixpack-encoded bytes into 3 data bytes */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">inbyte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">inbyte</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cooked_buf</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cooked_buf</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">cooked_buf</span><span class="p">[</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inbyte</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* identify and execute a 6pack priority command byte */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_prio_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIXP_CHN_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIXP_PRIO_DATA_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>     <span class="cm">/* idle ? */</span>

	<span class="cm">/* RX and DCD flags can only be set in the same prio command,</span>
<span class="cm">	   if the DCD flag has been set without the RX flag in the previous</span>
<span class="cm">	   prio command. If DCD has not been set before, something in the</span>
<span class="cm">	   transmission has gone wrong. In this case, RX and DCD are</span>
<span class="cm">	   cleared in order to prevent the decode_data routine from</span>
<span class="cm">	   reading further data that might be corrupt. */</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SIXP_DCD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIXP_RX_DCD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SIXP_RX_DCD_MASK</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;6pack: protocol violation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SIXP_RX_DCD_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIXP_PRIO_DATA_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* output watchdog char if idle */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x70</span><span class="p">;</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tx_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">actual</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">xbuff</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span><span class="p">);</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xleft</span> <span class="o">-=</span> <span class="n">actual</span><span class="p">;</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">xhead</span> <span class="o">+=</span> <span class="n">actual</span><span class="p">;</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* needed to trigger the TNC watchdog */</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

        <span class="cm">/* if the state byte has been received, the TNC is present,</span>
<span class="cm">           so the resync timer can be reset. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tnc_state</span> <span class="o">==</span> <span class="n">TNC_IN_SYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sp</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">function</span>	<span class="o">=</span> <span class="n">resync_tnc</span><span class="p">;</span>
		<span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">.</span><span class="n">expires</span>	<span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SIXP_INIT_RESYNC_TIMEOUT</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">status1</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIXP_PRIO_DATA_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* identify and execute a standard 6pack command byte */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_std_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIXP_CHN_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">SIXP_CMD_MASK</span><span class="p">)</span> <span class="p">{</span>     <span class="cm">/* normal command */</span>
	<span class="k">case</span> <span class="n">SIXP_SEOF</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SIXP_RX_DCD_MASK</span><span class="p">)</span> <span class="o">==</span>
				<span class="n">SIXP_RX_DCD_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
			<span class="cm">/* fill trailing bytes with zeroes */</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">led_state</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rest</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				 <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">rest</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">decode_data</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">checksum</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">cooked_buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="n">SIXP_CHKSUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;6pack: bad checksum %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rcount</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
				<span class="n">sp_bump</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">sp</span><span class="o">-&gt;</span><span class="n">rx_count_cooked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIXP_TX_URUN</span>: <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;6pack: TX underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIXP_RX_ORUN</span>: <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;6pack: RX overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SIXP_RX_BUF_OVL</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;6pack: RX buffer overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* decode a 6pack packet */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sixpack_decode</span><span class="p">(</span><span class="k">struct</span> <span class="n">sixpack</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pre_rbuff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">inbyte</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count1</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inbyte</span> <span class="o">=</span> <span class="n">pre_rbuff</span><span class="p">[</span><span class="n">count1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inbyte</span> <span class="o">==</span> <span class="n">SIXP_FOUND_TNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tnc_set_sync_state</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">TNC_IN_SYNC</span><span class="p">);</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">resync_t</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inbyte</span> <span class="o">&amp;</span> <span class="n">SIXP_PRIO_CMD_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">decode_prio_command</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">inbyte</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">inbyte</span> <span class="o">&amp;</span> <span class="n">SIXP_STD_CMD_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">decode_std_command</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">inbyte</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SIXP_RX_DCD_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SIXP_RX_DCD_MASK</span><span class="p">)</span>
			<span class="n">decode_data</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">inbyte</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralf Baechle DO1GRB &lt;ralf@linux-mips.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;6pack driver for AX.25&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS_LDISC</span><span class="p">(</span><span class="n">N_6PACK</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sixpack_init_driver</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sixpack_exit_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
