<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hippi › rrunner.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rrunner.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * rrunner.c: Linux driver for the Essential RoadRunner HIPPI board.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1998-2002 by Jes Sorensen, &lt;jes@wildopensource.com&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Essential Communication for providing us with hardware</span>
<span class="cm"> * and very comprehensive documentation without which I would not have</span>
<span class="cm"> * been able to write this driver. A special thank you to John Gibbon</span>
<span class="cm"> * for sorting out the legal issues, with the NDA, allowing the code to</span>
<span class="cm"> * be released under the GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Jayaram Bhat from ODS/Essential for fixing some of the</span>
<span class="cm"> * stupid bugs in my code.</span>
<span class="cm"> *</span>
<span class="cm"> * Softnet support and various other patches from Val Henson of</span>
<span class="cm"> * ODS/Essential.</span>
<span class="cm"> *</span>
<span class="cm"> * PCI DMA mapping code partly based on work by Francois Romieu.</span>
<span class="cm"> */</span>


<span class="cp">#define DEBUG 1</span>
<span class="cp">#define RX_DMA_SKBUFF 1</span>
<span class="cp">#define PKT_COPY_THRESHOLD 512</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/hippidevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/sock.h&gt;</span>

<span class="cp">#include &lt;asm/cache.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#define rr_if_busy(dev)     netif_queue_stopped(dev)</span>
<span class="cp">#define rr_if_running(dev)  netif_running(dev)</span>

<span class="cp">#include &quot;rrunner.h&quot;</span>

<span class="cp">#define RUN_AT(x) (jiffies + (x))</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jes Sorensen &lt;jes@wildopensource.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Essential RoadRunner HIPPI driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="s">&quot;rrunner.c: v0.50 11/11/2002  Jes Sorensen (jes@wildopensource.com)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rr_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">rr_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">rr_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">rr_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">rr_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">hippi_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">hippi_mac_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Implementation notes:</span>
<span class="cm"> *</span>
<span class="cm"> * The DMA engine only allows for DMA within physical 64KB chunks of</span>
<span class="cm"> * memory. The current approach of the driver (and stack) is to use</span>
<span class="cm"> * linear blocks of memory for the skbuffs. However, as the data block</span>
<span class="cm"> * is always the first part of the skb and skbs are 2^n aligned so we</span>
<span class="cm"> * are guarantted to get the whole block within one 64KB align 64KB</span>
<span class="cm"> * chunk.</span>
<span class="cm"> *</span>
<span class="cm"> * On the long term, relying on being able to allocate 64KB linear</span>
<span class="cm"> * chunks of memory is not feasible and the skb handling code and the</span>
<span class="cm"> * stack will need to know about I/O vectors or something similar.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rr_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">version_disp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pci_latency</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tmpptr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ring_dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_hippi_dev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;rrunner&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rr_netdev_ops</span><span class="p">;</span>

	<span class="cm">/* display version info if adapter is found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">version_disp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set display flag to TRUE so that */</span>
		<span class="cm">/* we only display this string ONCE */</span>
		<span class="n">version_disp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_latency</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_latency</span> <span class="o">&lt;=</span> <span class="mh">0x58</span><span class="p">){</span>
		<span class="n">pci_latency</span> <span class="o">=</span> <span class="mh">0x58</span><span class="p">;</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">pci_latency</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Essential RoadRunner serial HIPPI &quot;</span>
	       <span class="s">&quot;at 0x%llx, irq %i, PCI latency %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	       <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pci_latency</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remap the MMIO regs into kernel space.</span>
<span class="cm">	 */</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s:  Unable to map I/O register, &quot;</span>
			<span class="s">&quot;RoadRunner will be disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmpptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span> <span class="o">=</span> <span class="n">tmpptr</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmpptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmpptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span> <span class="o">=</span> <span class="n">tmpptr</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmpptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmpptr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">EVT_RING_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring_dma</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">evt_ring</span> <span class="o">=</span> <span class="n">tmpptr</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">evt_ring_dma</span> <span class="o">=</span> <span class="n">ring_dma</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmpptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t access any register before this point!</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">|</span> <span class="n">NO_SWAP</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Need to add a case for little-endian 64-bit hosts here.</span>
<span class="cm">	 */</span>

	<span class="n">rr_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
				    <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
				    <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out2:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">out3:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">rr_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rr</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NIC_HALTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: trying to unload running NIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">HALT_NIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rr</span><span class="o">-&gt;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">EVT_RING_SIZE</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">,</span>
			    <span class="n">rr</span><span class="o">-&gt;</span><span class="n">evt_ring_dma</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">,</span>
			    <span class="n">rr</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">,</span>
			    <span class="n">rr</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">rr</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Commands are considered to be slow, thus there is no reason to</span>
<span class="cm"> * inline this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rr_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is temporary - it will go away in the final version.</span>
<span class="cm">	 * We probably also want to make this function inline.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NIC_HALTED</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;issuing command for halted NIC, code 0x%x, &quot;</span>
		       <span class="s">&quot;HostCtrl %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FATAL_ERR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;error codes Fail1 %02x, Fail2 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Fail1</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Fail2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">pi</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdRing</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">CMD_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FATAL_ERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;error code %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Fail1</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Reset the board in a sensible manner. The NIC is already halted</span>
<span class="cm"> * when we get here and a spin-lock is held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rr_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_pc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">rr_load_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x01000000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TX_state</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xff800000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RX_state</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">AssistState</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CLEAR_INTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">BrkPt</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Timer</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TimerRef</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RESET_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaReadState</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RESET_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaWriteState</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaWriteHostHi</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaWriteHostLo</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaReadHostHi</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaReadHostLo</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaReadLen</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaWriteLen</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaWriteLcl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaWriteIPchecksum</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaReadLcl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">DmaReadIPchecksum</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">PciState</span><span class="p">);</span>
<span class="cp">#if (BITS_PER_LONG == 64) &amp;&amp; defined __LITTLE_ENDIAN</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SWAP_DATA</span> <span class="o">|</span> <span class="n">PTR64BIT</span> <span class="o">|</span> <span class="n">PTR_WD_SWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mode</span><span class="p">);</span>
<span class="cp">#elif (BITS_PER_LONG == 64)</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SWAP_DATA</span> <span class="o">|</span> <span class="n">PTR64BIT</span> <span class="o">|</span> <span class="n">PTR_WD_NOSWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mode</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SWAP_DATA</span> <span class="o">|</span> <span class="n">PTR32BIT</span> <span class="o">|</span> <span class="n">PTR_WD_NOSWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mode</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/*</span>
<span class="c">	 * Don&#39;t worry, this is just black magic.</span>
<span class="c">	 */</span>
<span class="c">	writel(0xdf000, &amp;regs-&gt;RxBase);</span>
<span class="c">	writel(0xdf000, &amp;regs-&gt;RxPrd);</span>
<span class="c">	writel(0xdf000, &amp;regs-&gt;RxCon);</span>
<span class="c">	writel(0xce000, &amp;regs-&gt;TxBase);</span>
<span class="c">	writel(0xce000, &amp;regs-&gt;TxPrd);</span>
<span class="c">	writel(0xce000, &amp;regs-&gt;TxCon);</span>
<span class="c">	writel(0, &amp;regs-&gt;RxIndPro);</span>
<span class="c">	writel(0, &amp;regs-&gt;RxIndCon);</span>
<span class="c">	writel(0, &amp;regs-&gt;RxIndRef);</span>
<span class="c">	writel(0, &amp;regs-&gt;TxIndPro);</span>
<span class="c">	writel(0, &amp;regs-&gt;TxIndCon);</span>
<span class="c">	writel(0, &amp;regs-&gt;TxIndRef);</span>
<span class="c">	writel(0xcc000, &amp;regs-&gt;pad10[0]);</span>
<span class="c">	writel(0, &amp;regs-&gt;DrCmndPro);</span>
<span class="c">	writel(0, &amp;regs-&gt;DrCmndCon);</span>
<span class="c">	writel(0, &amp;regs-&gt;DwCmndPro);</span>
<span class="c">	writel(0, &amp;regs-&gt;DwCmndCon);</span>
<span class="c">	writel(0, &amp;regs-&gt;DwCmndRef);</span>
<span class="c">	writel(0, &amp;regs-&gt;DrDataPro);</span>
<span class="c">	writel(0, &amp;regs-&gt;DrDataCon);</span>
<span class="c">	writel(0, &amp;regs-&gt;DrDataRef);</span>
<span class="c">	writel(0, &amp;regs-&gt;DwDataPro);</span>
<span class="c">	writel(0, &amp;regs-&gt;DwDataCon);</span>
<span class="c">	writel(0, &amp;regs-&gt;DwDataRef);</span>
<span class="cp">#endif</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MbEvent</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Event</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxPi</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IpRxPi</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtCon</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtPrd</span><span class="p">);</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CMD_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdRing</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="cm">/*</span>
<span class="cm"> * Why 32 ? is this not cache line size dependent?</span>
<span class="cm"> */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">RBURST_64</span><span class="o">|</span><span class="n">WBURST_64</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">PciState</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">start_pc</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom</span><span class="p">,</span> <span class="n">rncd_info</span><span class="p">.</span><span class="n">FwStart</span><span class="p">));</span>

<span class="cp">#if (DEBUG &gt; 1)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Executing firmware at address 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">start_pc</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">start_pc</span> <span class="o">+</span> <span class="mh">0x800</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Pc</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">start_pc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Pc</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read a string from the EEPROM.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">rr_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">misc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">host</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">host</span> <span class="o">|</span> <span class="n">HALT_NIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">EEPROM_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinBase</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinData</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">misc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Shortcut to read one word (4 bytes) out of the EEPROM and convert</span>
<span class="cm"> * it to our CPU byte-order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">rr_read_eeprom_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">word</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rr_read_eeprom</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">word</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Write a string to the EEPROM.</span>
<span class="cm"> *</span>
<span class="cm"> * This is only called when the firmware is not running.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">write_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">misc</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">io</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">misc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ENABLE_EEPROM_WRITE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">EEPROM_BASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">offset</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinBase</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Only try to write the data if it is not the same</span>
<span class="cm">		 * value already.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinData</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">!=</span> <span class="n">data</span><span class="p">){</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinData</span><span class="p">);</span>
			<span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mb</span><span class="p">();</span>
			<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">ready</span><span class="p">){</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinData</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">)</span> <span class="o">==</span>
				    <span class="n">data</span><span class="p">)</span>
					<span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">mb</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">){</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;data mismatch: %08x, &quot;</span>
					       <span class="s">&quot;WinData %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinData</span><span class="p">));</span>
					<span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">misc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">rr_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sram_size</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">rev</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">FwRev</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">=</span> <span class="n">rev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mh">0x00020024</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  Firmware revision: %i.%i.%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
		       <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mh">0x00020000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  Firmware revision: %i.%i.%i (2.0.37 or &quot;</span>
		       <span class="s">&quot;later is recommended)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span>
		       <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  Firmware revision too old: %i.%i.%i, please &quot;</span>
		       <span class="s">&quot;upgrade to 2.0.37 or later.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span>

<span class="cp">#if (DEBUG &gt; 2)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  Maximum receive rings %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">MaxRxRng</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the hardware address from the eeprom.  The HW address</span>
<span class="cm">	 * is not really necessary for HIPPI but awfully convenient.</span>
<span class="cm">	 * The pointer arithmetic to put it in dev_addr is ugly, but</span>
<span class="cm">	 * Donald Becker does it this way for the GigE version of this</span>
<span class="cm">	 * card and it&#39;s shorter and more portable than any</span>
<span class="cm">	 * other method I&#39;ve seen.  -VAL</span>
<span class="cm">	 */</span>

	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)</span> <span class="o">=</span>
	  <span class="n">htons</span><span class="p">(</span><span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom</span><span class="p">,</span> <span class="n">manf</span><span class="p">.</span><span class="n">BoardULA</span><span class="p">)));</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span>
	  <span class="n">htonl</span><span class="p">(</span><span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom</span><span class="p">,</span> <span class="n">manf</span><span class="p">.</span><span class="n">BoardULA</span><span class="p">[</span><span class="mi">4</span><span class="p">])));</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">sram_size</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  SRAM size 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sram_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rr_init1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">myjif</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hostctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hostctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">hostctrl</span> <span class="o">|</span> <span class="n">HALT_NIC</span> <span class="o">|</span> <span class="n">RR_CLEAR_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostctrl</span> <span class="o">&amp;</span> <span class="n">PARITY_ERR</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Parity error halting NIC - this is serious!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_rxaddr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl_dma</span><span class="p">);</span>
	<span class="n">set_infoaddr</span><span class="p">(</span><span class="n">regs</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info_dma</span><span class="p">);</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">entry_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">event</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">EVT_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">evt_ring_dma</span><span class="p">);</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">entry_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">CMD_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CMD_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdRing</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">entry_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="n">TX_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">rngptr</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring_dma</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set dirty_tx before we start receiving interrupts, otherwise</span>
<span class="cm">	 * the interrupt handler might think it is supposed to process</span>
<span class="cm">	 * tx ints before we are up and running, which may cause a null</span>
<span class="cm">	 * pointer access in the int handler.</span>
<span class="cm">	 */</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">dirty_rx</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rr_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Tuning values */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x5000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ConRetry</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x100</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ConRetryTmr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x500000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ConTmout</span><span class="p">);</span>
 	<span class="n">writel</span><span class="p">(</span><span class="mh">0x60</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IntrTmr</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x500000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxDataMvTimeout</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x200000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxDataMvTimeout</span><span class="p">);</span>
 	<span class="n">writel</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WriteDmaThresh</span><span class="p">);</span>
 	<span class="n">writel</span><span class="p">(</span><span class="mh">0x80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ReadDmaThresh</span><span class="p">);</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">hostctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HALT_NIC</span> <span class="o">|</span> <span class="n">INVALID_INST_B</span> <span class="o">|</span> <span class="n">PARITY_ERR</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">hostctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unable to allocate memory &quot;</span>
			       <span class="s">&quot;for receive ring - halting NIC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	        <span class="n">addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Sanity test to see if we conflict with the DMA</span>
<span class="cm">		 * limitations of the Roadrunner.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">~</span><span class="mi">65320</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;skb alloc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">entry_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="n">RX_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">rngptr</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring_dma</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now start the FirmWare.</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">C_START_FW</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rr_issue_cmd</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give the FirmWare time to chew on the `get running&#39; command.</span>
<span class="cm">	 */</span>
	<span class="n">myjif</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">myjif</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_running</span><span class="p">)</span>
		<span class="n">cpu_relax</span><span class="p">();</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="cm">/*</span>
<span class="cm">	 * We might have gotten here because we are out of memory,</span>
<span class="cm">	 * make sure we release everything we allocated before failing</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
	        	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					 <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">,</span>
					 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * All events are considered to be slow (RX/TX ints do not generate</span>
<span class="cm"> * events) and are handled here, outside the main interrupt handler,</span>
<span class="cm"> * to reduce the size of the handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">rr_handle_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">prodidx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">prodidx</span> <span class="o">!=</span> <span class="n">eidx</span><span class="p">){</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">eidx</span><span class="p">].</span><span class="n">code</span><span class="p">){</span>
		<span class="k">case</span> <span class="n">E_NIC_UP</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">FwRev</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Firmware revision %i.%i.%i &quot;</span>
			       <span class="s">&quot;up and running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">),</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
			<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">RX_RING_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IpRxPi</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_LINK_ON</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Optical link ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_LINK_OFF</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Optical link OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_RX_IDLE</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: RX data not moving</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_WATCHDOG</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: The watchdog is here to see &quot;</span>
			       <span class="s">&quot;us</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_INTERN_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: HIPPI Internal NIC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_HOST_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Host software error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * TX events.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">E_CON_REJ</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Connection rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_CON_TMOUT</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Connection timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_DISC_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: HIPPI disconnect error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_INT_PRTY</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: HIPPI Internal Parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_TX_IDLE</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Transmitter idle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_TX_LINK_DROP</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Link lost during transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_TX_INV_RNG</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid send ring block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_TX_INV_BUF</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid send buffer address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_TX_INV_DSC</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid descriptor address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * RX events.</span>
<span class="cm">		 */</span>
		<span class="k">case</span> <span class="n">E_RX_RNG_OUT</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Receive ring full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">E_RX_PAR_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Receive parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_RX_LLRC_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Receive LLRC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_PKT_LN_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Receive packet length &quot;</span>
			       <span class="s">&quot;error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_DTA_CKSM_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Data checksum error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_SHT_BST</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unexpected short burst &quot;</span>
			       <span class="s">&quot;error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_STATE_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Recv. state transition&quot;</span>
			       <span class="s">&quot; error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_UNEXP_DATA</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unexpected data error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_LST_LNK_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Link lost error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_FRM_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Framming Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_FLG_SYN_ERR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Flag sync. lost during &quot;</span>
			       <span class="s">&quot;packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_RX_INV_BUF</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid receive buffer &quot;</span>
			       <span class="s">&quot;address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_RX_INV_DSC</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid receive descriptor &quot;</span>
			       <span class="s">&quot;address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">E_RNG_BLK</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid ring block</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">wmb</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">drop:</span>
			<span class="cm">/* Label packet to be dropped.</span>
<span class="cm">			 * Actual dropping occurs in rx</span>
<span class="cm">			 * handling.</span>
<span class="cm">			 *</span>
<span class="cm">			 * The index of packet we get to drop is</span>
<span class="cm">			 * the index of the packet following</span>
<span class="cm">			 * the bad packet. -kbf</span>
<span class="cm">			 */</span>
			<span class="p">{</span>
				<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">eidx</span><span class="p">].</span><span class="n">index</span><span class="p">;</span>
				<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="p">(</span><span class="n">RX_RING_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span>
					<span class="n">RX_RING_ENTRIES</span><span class="p">;</span>
				<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">mode</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">PACKET_BAD</span> <span class="o">|</span> <span class="n">PACKET_END</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unhandled event 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">evt_ring</span><span class="p">[</span><span class="n">eidx</span><span class="p">].</span><span class="n">code</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">eidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">eidx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">EVT_RING_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="n">eidx</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">eidx</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rxlimit</span><span class="p">,</span> <span class="n">u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">pkt_len</span><span class="p">;</span>

		<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
<span class="cp">#if (DEBUG &gt; 2)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;index %i, rxlimit %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rxlimit</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;len %x, mode %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">PACKET_BAD</span><span class="p">)</span> <span class="o">==</span> <span class="n">PACKET_BAD</span><span class="p">){</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">defer</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">){</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>

			<span class="n">rx_skb</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="n">PKT_COPY_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">pkt_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Unable to allocate skb (%i bytes), deferring packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">defer</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
								    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span>
								    <span class="n">pkt_len</span><span class="p">,</span>
								    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

					<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">),</span>
					       <span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>

					<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
								       <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span>
								       <span class="n">pkt_len</span><span class="p">,</span>
								       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">newskb</span><span class="p">;</span>

				<span class="n">newskb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">,</span>
					<span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">newskb</span><span class="p">){</span>
					<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>

	        			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
						<span class="n">HIPPI_HLEN</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
					<span class="n">skb</span> <span class="o">=</span> <span class="n">rx_skb</span><span class="p">;</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
					<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">newskb</span><span class="p">;</span>
	        			<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						<span class="n">newskb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">,</span>
						<span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
					<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Out of memory, deferring &quot;</span>
					       <span class="s">&quot;packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">defer</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hippi_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

			<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>		<span class="cm">/* send it up */</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">defer:</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IpRxPi</span><span class="p">);</span>

		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_ENTRIES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="n">rxlimit</span><span class="p">);</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">rr_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prodidx</span><span class="p">,</span> <span class="n">rxindex</span><span class="p">,</span> <span class="n">eidx</span><span class="p">,</span> <span class="n">txcsmr</span><span class="p">,</span> <span class="n">rxlimit</span><span class="p">,</span> <span class="n">txcon</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RR_INT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">prodidx</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtPrd</span><span class="p">);</span>
	<span class="n">txcsmr</span> <span class="o">=</span> <span class="p">(</span><span class="n">prodidx</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">rxlimit</span> <span class="o">=</span> <span class="p">(</span><span class="n">prodidx</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">prodidx</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

<span class="cp">#if (DEBUG &gt; 2)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: interrupt, prodidx = %i, eidx = %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">prodidx</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">pi</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Order here is important.  We must handle events</span>
<span class="cm">	 * before doing anything else in order to catch</span>
<span class="cm">	 * such things as LLRC errors, etc -kbf</span>
<span class="cm">	 */</span>

	<span class="n">eidx</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">pi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prodidx</span> <span class="o">!=</span> <span class="n">eidx</span><span class="p">)</span>
		<span class="n">eidx</span> <span class="o">=</span> <span class="n">rr_handle_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prodidx</span><span class="p">,</span> <span class="n">eidx</span><span class="p">);</span>

	<span class="n">rxindex</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxindex</span> <span class="o">!=</span> <span class="n">rxlimit</span><span class="p">)</span>
		<span class="n">rx_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rxlimit</span><span class="p">,</span> <span class="n">rxindex</span><span class="p">);</span>

	<span class="n">txcon</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txcsmr</span> <span class="o">!=</span> <span class="n">txcon</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="cm">/* Due to occational firmware TX producer/consumer out</span>
<span class="cm">			 * of sync. error need to check entry in ring -kbf</span>
<span class="cm">			 */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">txcon</span><span class="p">]){</span>
				<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

				<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">txcon</span><span class="p">]);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">txcon</span><span class="p">];</span>

				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						 <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

				<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">txcon</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">txcon</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">desc</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">txcon</span> <span class="o">=</span> <span class="p">(</span><span class="n">txcon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_ENTRIES</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">txcsmr</span> <span class="o">!=</span> <span class="n">txcon</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">dirty_tx</span> <span class="o">=</span> <span class="n">txcon</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">&amp;&amp;</span> <span class="n">rr_if_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(((</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_ENTRIES</span><span class="p">)</span>
		     <span class="o">!=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">)){</span>
			<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">eidx</span> <span class="o">|=</span> <span class="p">((</span><span class="n">txcsmr</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rxlimit</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">eidx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtCon</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rr_raz_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">tx_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	        	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rr_raz_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">rx_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	        	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">HIPPI_HLEN</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rr_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NIC_HALTED</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Restarting nic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_ctrl</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_info</span><span class="p">));</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">rr_raz_tx</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">rr_raz_rx</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rr_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rr_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ecode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">&lt;</span> <span class="mh">0x00020000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: trying to configure device with &quot;</span>
		       <span class="s">&quot;obsolete firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
					       <span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_ctrl</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl_dma</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_ctrl</span><span class="p">));</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_info</span><span class="p">),</span>
					    <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info_dma</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_info</span><span class="p">));</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rr_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Requested IRQ %d is busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ecode</span> <span class="o">=</span> <span class="n">rr_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Set the timer to switch to check for link beat and perhaps switch</span>
<span class="cm">	   to an alternate media type. */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>           <span class="cm">/* 5 sec. watchdog */</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">rr_timer</span><span class="p">;</span>               <span class="cm">/* timer handler */</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span><span class="o">|</span><span class="n">HALT_NIC</span><span class="o">|</span><span class="n">RR_CLEAR_INT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_info</span><span class="p">),</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
				    <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info_dma</span><span class="p">);</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_ctrl</span><span class="p">),</span>
				    <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl_dma</span><span class="p">);</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rr_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">cons</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: dumping NIC TX rings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;RxPrd %08x, TxPrd %02x, EvtPrd %08x, TxPi %02x, TxCtrlPi %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxPrd</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxPrd</span><span class="p">),</span>
	       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtPrd</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxPi</span><span class="p">),</span>
	       <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">pi</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error code 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Fail1</span><span class="p">));</span>

	<span class="n">index</span> <span class="o">=</span> <span class="p">(((</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtPrd</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">cons</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;TX ring index %i, TX consumer %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">index</span><span class="p">,</span> <span class="n">cons</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">index</span><span class="p">]){</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;skbuff for index %i is valid - dumping data (0x%x bytes - DMA len 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">cons</span><span class="p">]){</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;skbuff for cons %i is valid - dumping data (0x%x bytes - skbuff len 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cons</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mode 0x%x, size 0x%x,</span><span class="se">\n</span><span class="s"> phys %08Lx, skbuff-addr %08lx, truesize 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">cons</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span>
		       <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">cons</span><span class="p">].</span><span class="n">size</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">cons</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">cons</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dumping TX ring info:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mode 0x%x, size 0x%x, phys-addr %08Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span><span class="p">,</span>
		       <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">.</span><span class="n">addrlo</span><span class="p">);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rr_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Lock to make sure we are not cleaning up while another CPU</span>
<span class="cm">	 * is handling interrupts.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">NIC_HALTED</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: NIC already halted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">rr_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">HALT_NIC</span> <span class="o">|</span> <span class="n">RR_CLEAR_INT</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
		<span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxPi</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">IpRxPi</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtCon</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtPrd</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CMD_RING_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">CmdRing</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">.</span><span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">cmd_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">evt_ctrl</span><span class="p">.</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rr_raz_tx</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">rr_raz_rx</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">256</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring_ctrl</span><span class="p">),</span>
			    <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span><span class="p">,</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl_dma</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rr_info</span><span class="p">),</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
			    <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info_dma</span><span class="p">);</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">rr_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hippi_cb</span> <span class="o">*</span><span class="n">hcb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hippi_cb</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ring_ctrl</span> <span class="o">*</span><span class="n">txctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ifield</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FATAL_ERR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;error codes Fail1 %02x, Fail2 %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Fail1</span><span class="p">),</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">Fail2</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We probably need to deal with tbusy here to prevent overruns.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;incoming skb too small - reallocating</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">new_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">new_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ifield</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">ifield</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ifield</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hcb</span><span class="o">-&gt;</span><span class="n">ifield</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t need the lock before we are actually going to start</span>
<span class="cm">	 * fiddling with the control blocks.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">txctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">tx_ctrl</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">txctrl</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">;</span>

	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">set_rraddr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">pci_map_single</span><span class="p">(</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* include IFIELD */</span>
	<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_ring</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">PACKET_START</span> <span class="o">|</span> <span class="n">PACKET_END</span><span class="p">;</span>
	<span class="n">txctrl</span><span class="o">-&gt;</span><span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">TX_RING_ENTRIES</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">txctrl</span><span class="o">-&gt;</span><span class="n">pi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxPi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txctrl</span><span class="o">-&gt;</span><span class="n">pi</span> <span class="o">==</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">dirty_tx</span><span class="p">){</span>
		<span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">tx_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read the firmware out of the EEPROM and put it into the SRAM</span>
<span class="cm"> * (or from user space - later)</span>
<span class="cm"> *</span>
<span class="cm"> * This operation requires the NIC to be halted and is performed with</span>
<span class="cm"> * interrupts disabled and with the spinlock hold.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rr_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rr_regs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">eptr</span><span class="p">,</span> <span class="n">segptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">localctrl</span><span class="p">,</span> <span class="n">sptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">p2len</span><span class="p">,</span> <span class="n">p2size</span><span class="p">,</span> <span class="n">nr_seg</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">sram_size</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">regs</span> <span class="o">=</span> <span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">HostCtrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NIC_HALTED</span><span class="p">)){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Trying to load firmware to a running NIC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">localctrl</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">EvtPrd</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">RxPrd</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">TxPrd</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * First wipe the entire SRAM, otherwise we might run into all</span>
<span class="cm">	 * kinds of trouble ... sigh, this took almost all afternoon</span>
<span class="cm">	 * to track down ;-(</span>
<span class="cm">	 */</span>
	<span class="n">io</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">sram_size</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sram_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinBase</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinData</span><span class="p">);</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">ExtIo</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">eptr</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span>
		       <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom</span><span class="p">,</span> <span class="n">rncd_info</span><span class="p">.</span><span class="n">AddrRunCodeSegs</span><span class="p">));</span>
	<span class="n">eptr</span> <span class="o">=</span> <span class="p">((</span><span class="n">eptr</span> <span class="o">&amp;</span> <span class="mh">0x1fffff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">p2len</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="mh">0x83</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">p2len</span> <span class="o">=</span> <span class="p">(</span><span class="n">p2len</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">p2size</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="mh">0x84</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">p2size</span> <span class="o">=</span> <span class="p">((</span><span class="n">p2size</span> <span class="o">&amp;</span> <span class="mh">0x1fffff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">eptr</span> <span class="o">&lt;</span> <span class="n">p2size</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">eptr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">p2size</span> <span class="o">+</span> <span class="n">p2len</span><span class="p">))){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: eptr is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">revision</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eeprom</span><span class="p">,</span> <span class="n">manf</span><span class="p">.</span><span class="n">HeaderFmt</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">revision</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: invalid firmware format (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">revision</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nr_seg</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">eptr</span><span class="p">);</span>
	<span class="n">eptr</span> <span class="o">+=</span><span class="mi">4</span><span class="p">;</span>
<span class="cp">#if (DEBUG &gt; 1)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: nr_seg %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nr_seg</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_seg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">sptr</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">eptr</span><span class="p">);</span>
		<span class="n">eptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">eptr</span><span class="p">);</span>
		<span class="n">eptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">segptr</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">eptr</span><span class="p">);</span>
		<span class="n">segptr</span> <span class="o">=</span> <span class="p">((</span><span class="n">segptr</span> <span class="o">&amp;</span> <span class="mh">0x1fffff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">eptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#if (DEBUG &gt; 1)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: segment %i, sram address %06x, length %04x, segptr %06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sptr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">segptr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">rr_read_eeprom_word</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="n">segptr</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">sptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinBase</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">WinData</span><span class="p">);</span>
			<span class="n">mb</span><span class="p">();</span>
			<span class="n">segptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">sptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">localctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">LocalCtrl</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rr_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rr_private</span> <span class="o">*</span><span class="n">rrpriv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">image</span><span class="p">,</span> <span class="o">*</span><span class="n">oldimage</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">rrpriv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">cmd</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">SIOCRRGFW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">image</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">EEPROM_WORDS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">image</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_running</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Firmware already running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">gf_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">rr_read_eeprom</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">EEPROM_BYTES</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">EEPROM_BYTES</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error reading EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">gf_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">EEPROM_BYTES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="nl">gf_out:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCRRPFW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">)){</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">image</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">EEPROM_WORDS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">oldimage</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">EEPROM_WORDS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">image</span> <span class="o">||</span> <span class="o">!</span><span class="n">oldimage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">wf_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">EEPROM_BYTES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">wf_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">fw_running</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Firmware already running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">wf_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Updating EEPROM firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">write_eeprom</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">EEPROM_BYTES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error writing EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">rr_read_eeprom</span><span class="p">(</span><span class="n">rrpriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oldimage</span><span class="p">,</span> <span class="n">EEPROM_BYTES</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rrpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">EEPROM_BYTES</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error reading back EEPROM &quot;</span>
			       <span class="s">&quot;image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">oldimage</span><span class="p">,</span> <span class="n">EEPROM_BYTES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">){</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error verifying EEPROM image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">wf_out:</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">oldimage</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCRRID</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mh">0x52523032</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">rr_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_ESSENTIAL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ESSENTIAL_ROADRUNNER</span><span class="p">,</span>
		<span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">rr_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">rr_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;rrunner&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">rr_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">rr_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">rr_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">rr_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rr_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">rr_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rr_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">rr_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">rr_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
