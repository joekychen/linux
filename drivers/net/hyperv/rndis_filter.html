<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › hyperv › rndis_filter.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rndis_filter.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009, Microsoft Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc., 59 Temple</span>
<span class="cm"> * Place - Suite 330, Boston, MA 02111-1307 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *   Haiyang Zhang &lt;haiyangz@microsoft.com&gt;</span>
<span class="cm"> *   Hank Janssen  &lt;hjanssen@microsoft.com&gt;</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>

<span class="cp">#include &quot;hyperv_net.h&quot;</span>


<span class="k">struct</span> <span class="n">rndis_request</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list_ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span>  <span class="n">wait_event</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: We assumed a fixed size response here. If we do ever need to</span>
<span class="cm">	 * handle a bigger response, we can either define a max response</span>
<span class="cm">	 * message or add a response buffer variable above this field</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">rndis_message</span> <span class="n">response_msg</span><span class="p">;</span>

	<span class="cm">/* Simplify allocation by having a netvsc packet inline */</span>
	<span class="k">struct</span> <span class="n">hv_netvsc_packet</span>	<span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hv_page_buffer</span> <span class="n">buf</span><span class="p">;</span>
	<span class="cm">/* FIXME: We assumed a fixed size request here. */</span>
	<span class="k">struct</span> <span class="n">rndis_message</span> <span class="n">request_msg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rndis_filter_send_completion</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">rndis_filter_send_request_completion</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>



<span class="k">static</span> <span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="nf">get_rndis_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">request_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">);</span>

	<span class="n">device</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_UNINITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">device</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="nf">get_rndis_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">msg_type</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">msg_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_message</span> <span class="o">*</span><span class="n">rndis_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_set_request</span> <span class="o">*</span><span class="n">set</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_request</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">wait_event</span><span class="p">);</span>

	<span class="n">rndis_msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">;</span>
	<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span> <span class="o">=</span> <span class="n">msg_type</span><span class="p">;</span>
	<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">msg_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the request id. This field is always after the rndis header for</span>
<span class="cm">	 * request/response packet types so we just used the SetRequest as a</span>
<span class="cm">	 * template</span>
<span class="cm">	 */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">set_req</span><span class="p">;</span>
	<span class="n">set</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">new_req_id</span><span class="p">);</span>

	<span class="cm">/* Add to the request list */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">list_ent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">put_rndis_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list_ent</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_rndis_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">hv_dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rndis_message</span> <span class="o">*</span><span class="n">rndis_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="o">*</span><span class="n">net_device</span><span class="p">;</span>

	<span class="n">net_device</span> <span class="o">=</span> <span class="n">hv_get_drvdata</span><span class="p">(</span><span class="n">hv_dev</span><span class="p">);</span>
	<span class="n">netdev</span> <span class="o">=</span> <span class="n">net_device</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RNDIS_MSG_PACKET</span>:
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;RNDIS_MSG_PACKET (len %u, &quot;</span>
			   <span class="s">&quot;data offset %u data len %u, # oob %u, &quot;</span>
			   <span class="s">&quot;oob offset %u, oob len %u, pkt offset %u, &quot;</span>
			   <span class="s">&quot;pkt len %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">.</span><span class="n">data_offset</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">.</span><span class="n">data_len</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">.</span><span class="n">num_oob_data_elements</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">.</span><span class="n">oob_data_offset</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">.</span><span class="n">oob_data_len</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">.</span><span class="n">per_pkt_info_offset</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">.</span><span class="n">per_pkt_info_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_MSG_INIT_C</span>:
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;RNDIS_MSG_INIT_C &quot;</span>
			<span class="s">&quot;(len %u, id 0x%x, status 0x%x, major %d, minor %d, &quot;</span>
			<span class="s">&quot;device flags %d, max xfer size 0x%x, max pkts %u, &quot;</span>
			<span class="s">&quot;pkt aligned %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">req_id</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">major_ver</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">minor_ver</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">dev_flags</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">max_xfer_size</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span>
			   <span class="n">max_pkt_per_msg</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span>
			   <span class="n">pkt_alignment_factor</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_MSG_QUERY_C</span>:
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;RNDIS_MSG_QUERY_C &quot;</span>
			<span class="s">&quot;(len %u, id 0x%x, status 0x%x, buf len %u, &quot;</span>
			<span class="s">&quot;buf offset %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">query_complete</span><span class="p">.</span><span class="n">req_id</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">query_complete</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">query_complete</span><span class="p">.</span>
			   <span class="n">info_buflen</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">query_complete</span><span class="p">.</span>
			   <span class="n">info_buf_offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_MSG_SET_C</span>:
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
			<span class="s">&quot;RNDIS_MSG_SET_C (len %u, id 0x%x, status 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">set_complete</span><span class="p">.</span><span class="n">req_id</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">set_complete</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_MSG_INDICATE</span>:
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;RNDIS_MSG_INDICATE &quot;</span>
			<span class="s">&quot;(len %u, status 0x%x, buf len %u, buf offset %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">indicate_status</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">indicate_status</span><span class="p">.</span><span class="n">status_buflen</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">indicate_status</span><span class="p">.</span><span class="n">status_buf_offset</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="s">&quot;0x%x (len %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span><span class="p">,</span>
			<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_filter_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>

	<span class="cm">/* Setup the packet to send it */</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">pkt</span><span class="p">;</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">is_data_pkt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">total_data_buflen</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">.</span><span class="n">msg_len</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">page_buf_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
					<span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">.</span><span class="n">msg_len</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">request_msg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion_ctx</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span><span class="cm">/* packet; */</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion</span> <span class="o">=</span>
		<span class="n">rndis_filter_send_request_completion</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion_tid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netvsc_send</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_filter_receive_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">rndis_message</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">req_list</span><span class="p">,</span> <span class="n">list_ent</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * All request/response message contains RequestId as the 1st</span>
<span class="cm">		 * field</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">init_req</span><span class="p">.</span><span class="n">req_id</span>
		    <span class="o">==</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">req_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_message</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">response_msg</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span>
			       <span class="n">resp</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
				<span class="s">&quot;rndis response buffer overflow &quot;</span>
				<span class="s">&quot;detected (size %u max %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">resp</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_filter_packet</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span> <span class="o">==</span>
			    <span class="n">RNDIS_MSG_RESET_C</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* does not have a request id field */</span>
				<span class="n">request</span><span class="o">-&gt;</span><span class="n">response_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">reset_complete</span><span class="p">.</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">RNDIS_STATUS_BUFFER_OVERFLOW</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">request</span><span class="o">-&gt;</span><span class="n">response_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span>
				<span class="n">init_complete</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">RNDIS_STATUS_BUFFER_OVERFLOW</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">wait_event</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
			<span class="s">&quot;no rndis request found for this response &quot;</span>
			<span class="s">&quot;(id 0x%x res type 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">resp</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">.</span><span class="n">req_id</span><span class="p">,</span>
			<span class="n">resp</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_filter_receive_indicate_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">rndis_message</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_indicate_status</span> <span class="o">*</span><span class="n">indicate</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">indicate_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">indicate</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">RNDIS_STATUS_MEDIA_CONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netvsc_linkstatus_callback</span><span class="p">(</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">indicate</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">RNDIS_STATUS_MEDIA_DISCONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netvsc_linkstatus_callback</span><span class="p">(</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO:</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the Per-Packet-Info with the specified type</span>
<span class="cm"> * return NULL if not found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">rndis_get_ppi</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_packet</span> <span class="o">*</span><span class="n">rpkt</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_per_packet_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">per_pkt_info_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ppi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rndis_per_packet_info</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rpkt</span> <span class="o">+</span>
		<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">per_pkt_info_offset</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">per_pkt_info_len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ppi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span><span class="n">ppi</span> <span class="o">+</span> <span class="n">ppi</span><span class="o">-&gt;</span><span class="n">ppi_offset</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">ppi</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">ppi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rndis_per_packet_info</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span><span class="n">ppi</span> <span class="o">+</span> <span class="n">ppi</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_filter_receive_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rndis_message</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_packet</span> <span class="o">*</span><span class="n">rndis_pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_pkt_8021q_info</span> <span class="o">*</span><span class="n">vlan</span><span class="p">;</span>

	<span class="n">rndis_pkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: Handle multiple rndis pkt msgs that maybe enclosed in this</span>
<span class="cm">	 * netvsc packet (ie TotalDataBufferLength != MessageLength)</span>
<span class="cm">	 */</span>

	<span class="cm">/* Remove the rndis header and pass it back up the stack */</span>
	<span class="n">data_offset</span> <span class="o">=</span> <span class="n">RNDIS_HEADER_SIZE</span> <span class="o">+</span> <span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">data_offset</span><span class="p">;</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">total_data_buflen</span> <span class="o">-=</span> <span class="n">data_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure we got a valid RNDIS message, now total_data_buflen</span>
<span class="cm">	 * should be the data packet size plus the trailer padding size</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">total_data_buflen</span> <span class="o">&lt;</span> <span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;rndis message buffer &quot;</span>
			   <span class="s">&quot;overflow detected (got %u, min %u)&quot;</span>
			   <span class="s">&quot;...dropping this message!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">total_data_buflen</span><span class="p">,</span> <span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remove the rndis trailer padding from rndis packet message</span>
<span class="cm">	 * rndis_pkt-&gt;data_len tell us the real data length, we only copy</span>
<span class="cm">	 * the data packet to the stack, without the rndis trailer padding</span>
<span class="cm">	 */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">total_data_buflen</span> <span class="o">=</span> <span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">data_offset</span><span class="p">);</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">is_data_pkt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">vlan</span> <span class="o">=</span> <span class="n">rndis_get_ppi</span><span class="p">(</span><span class="n">rndis_pkt</span><span class="p">,</span> <span class="n">IEEE_8021Q_INFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="n">VLAN_TAG_PRESENT</span> <span class="o">|</span> <span class="n">vlan</span><span class="o">-&gt;</span><span class="n">vlanid</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">vlan</span><span class="o">-&gt;</span><span class="n">pri</span> <span class="o">&lt;&lt;</span> <span class="n">VLAN_PRIO_SHIFT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netvsc_recv_callback</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rndis_filter_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">hv_netvsc_packet</span>	<span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">hv_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">rndis_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_message</span> <span class="o">*</span><span class="n">rndis_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="cm">/* Make sure the rndis device state is initialized */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;got rndis message but no rndis device - &quot;</span>
			  <span class="s">&quot;dropping this message!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rndis_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="p">)</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rndis_dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">RNDIS_DEV_UNINITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="s">&quot;got rndis message but rndis device &quot;</span>
			   <span class="s">&quot;uninitialized...dropping this message!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rndis_msg</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">dump_rndis_message</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rndis_msg</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RNDIS_MSG_PACKET</span>:
		<span class="cm">/* data msg */</span>
		<span class="n">rndis_filter_receive_data</span><span class="p">(</span><span class="n">rndis_dev</span><span class="p">,</span> <span class="n">rndis_msg</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_MSG_INIT_C</span>:
	<span class="k">case</span> <span class="n">RNDIS_MSG_QUERY_C</span>:
	<span class="k">case</span> <span class="n">RNDIS_MSG_SET_C</span>:
		<span class="cm">/* completion msgs */</span>
		<span class="n">rndis_filter_receive_response</span><span class="p">(</span><span class="n">rndis_dev</span><span class="p">,</span> <span class="n">rndis_msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_MSG_INDICATE</span>:
		<span class="cm">/* notification msgs */</span>
		<span class="n">rndis_filter_receive_indicate_status</span><span class="p">(</span><span class="n">rndis_dev</span><span class="p">,</span> <span class="n">rndis_msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
			<span class="s">&quot;unhandled rndis message (type %u len %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span><span class="p">,</span>
			   <span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_filter_query_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">oid</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">result_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inresult_size</span> <span class="o">=</span> <span class="o">*</span><span class="n">result_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_query_request</span> <span class="o">*</span><span class="n">query</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_query_complete</span> <span class="o">*</span><span class="n">query_complete</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">result_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">get_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RNDIS_MSG_QUERY</span><span class="p">,</span>
			<span class="n">RNDIS_MESSAGE_SIZE</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_query_request</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the rndis query */</span>
	<span class="n">query</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">query_req</span><span class="p">;</span>
	<span class="n">query</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">=</span> <span class="n">oid</span><span class="p">;</span>
	<span class="n">query</span><span class="o">-&gt;</span><span class="n">info_buf_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_query_request</span><span class="p">);</span>
	<span class="n">query</span><span class="o">-&gt;</span><span class="n">info_buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">query</span><span class="o">-&gt;</span><span class="n">dev_vc_handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_send_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">wait_event</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the response back */</span>
	<span class="n">query_complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">response_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">query_complete</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_complete</span><span class="o">-&gt;</span><span class="n">info_buflen</span> <span class="o">&gt;</span> <span class="n">inresult_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">query_complete</span> <span class="o">+</span>
			 <span class="n">query_complete</span><span class="o">-&gt;</span><span class="n">info_buf_offset</span><span class="p">),</span>
	       <span class="n">query_complete</span><span class="o">-&gt;</span><span class="n">info_buflen</span><span class="p">);</span>

	<span class="o">*</span><span class="n">result_size</span> <span class="o">=</span> <span class="n">query_complete</span><span class="o">-&gt;</span><span class="n">info_buflen</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="n">put_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_filter_query_device_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rndis_filter_query_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">RNDIS_OID_802_3_PERMANENT_ADDRESS</span><span class="p">,</span>
				      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_mac_adr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_filter_query_device_link_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">link_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_query_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">RNDIS_OID_GEN_MEDIA_CONNECT_STATUS</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">link_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">link_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rndis_filter_set_packet_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new_filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_set_request</span> <span class="o">*</span><span class="n">set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_set_complete</span> <span class="o">*</span><span class="n">set_complete</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">ndev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">get_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RNDIS_MSG_SET</span><span class="p">,</span>
			<span class="n">RNDIS_MESSAGE_SIZE</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_set_request</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the rndis set */</span>
	<span class="n">set</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">set_req</span><span class="p">;</span>
	<span class="n">set</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">=</span> <span class="n">RNDIS_OID_GEN_CURRENT_PACKET_FILTER</span><span class="p">;</span>
	<span class="n">set</span><span class="o">-&gt;</span><span class="n">info_buflen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">set</span><span class="o">-&gt;</span><span class="n">info_buf_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_set_request</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">set</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_set_request</span><span class="p">),</span>
	       <span class="o">&amp;</span><span class="n">new_filter</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_send_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">wait_event</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span>
			<span class="s">&quot;timeout before we got a set response...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can&#39;t deallocate the request since we may still receive a</span>
<span class="cm">		 * send completion for it.</span>
<span class="cm">		 */</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">response_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">set_complete</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">set_complete</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="n">put_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_filter_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_initialize_request</span> <span class="o">*</span><span class="n">init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_initialize_complete</span> <span class="o">*</span><span class="n">init_complete</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">request</span> <span class="o">=</span> <span class="n">get_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RNDIS_MSG_INIT</span><span class="p">,</span>
			<span class="n">RNDIS_MESSAGE_SIZE</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_initialize_request</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the rndis set */</span>
	<span class="n">init</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">init_req</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">major_ver</span> <span class="o">=</span> <span class="n">RNDIS_MAJOR_VERSION</span><span class="p">;</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">minor_ver</span> <span class="o">=</span> <span class="n">RNDIS_MINOR_VERSION</span><span class="p">;</span>
	<span class="cm">/* FIXME: Use 1536 - rounded ethernet frame size */</span>
	<span class="n">init</span><span class="o">-&gt;</span><span class="n">max_xfer_size</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_INITIALIZING</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_send_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_UNINITIALIZED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">t</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">wait_event</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">response_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">init_complete</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">init_complete</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">RNDIS_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_INITIALIZED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_UNINITIALIZED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="n">put_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_filter_halt_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_halt_request</span> <span class="o">*</span><span class="n">halt</span><span class="p">;</span>

	<span class="cm">/* Attempt to do a rndis device halt */</span>
	<span class="n">request</span> <span class="o">=</span> <span class="n">get_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RNDIS_MSG_HALT</span><span class="p">,</span>
				<span class="n">RNDIS_MESSAGE_SIZE</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_halt_request</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cleanup</span><span class="p">;</span>

	<span class="cm">/* Setup the rndis set */</span>
	<span class="n">halt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">request_msg</span><span class="p">.</span><span class="n">msg</span><span class="p">.</span><span class="n">halt_req</span><span class="p">;</span>
	<span class="n">halt</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">new_req_id</span><span class="p">);</span>

	<span class="cm">/* Ignore return since this msg is optional. */</span>
	<span class="n">rndis_filter_send_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_UNINITIALIZED</span><span class="p">;</span>

<span class="nl">cleanup:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="p">)</span>
		<span class="n">put_rndis_request</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_filter_open_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RNDIS_DEV_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_set_packet_filter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">NDIS_PACKET_TYPE_BROADCAST</span> <span class="o">|</span>
					 <span class="n">NDIS_PACKET_TYPE_ALL_MULTICAST</span> <span class="o">|</span>
					 <span class="n">NDIS_PACKET_TYPE_DIRECTED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_DATAINITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_filter_close_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">RNDIS_DEV_DATAINITIALIZED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_set_packet_filter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">RNDIS_DEV_INITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rndis_filter_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">additional_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="o">*</span><span class="n">net_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">rndis_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netvsc_device_info</span> <span class="o">*</span><span class="n">device_info</span> <span class="o">=</span> <span class="n">additional_info</span><span class="p">;</span>

	<span class="n">rndis_device</span> <span class="o">=</span> <span class="n">get_rndis_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rndis_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let the inner driver handle this first to create the netvsc channel</span>
<span class="cm">	 * NOTE! Once the channel is created, we may get a receive callback</span>
<span class="cm">	 * (RndisFilterOnReceive()) before this call is completed</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">netvsc_device_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">additional_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rndis_device</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Initialize the rndis device */</span>
	<span class="n">net_device</span> <span class="o">=</span> <span class="n">hv_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">net_device</span><span class="o">-&gt;</span><span class="n">extension</span> <span class="o">=</span> <span class="n">rndis_device</span><span class="p">;</span>
	<span class="n">rndis_device</span><span class="o">-&gt;</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">net_device</span><span class="p">;</span>

	<span class="cm">/* Send the rndis initialization message */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_init_device</span><span class="p">(</span><span class="n">rndis_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: If rndis init failed, we will need to shut down the</span>
<span class="cm">		 * channel</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="cm">/* Get the mac address */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_filter_query_device_mac</span><span class="p">(</span><span class="n">rndis_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: shutdown rndis device and the channel</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">mac_adr</span><span class="p">,</span> <span class="n">rndis_device</span><span class="o">-&gt;</span><span class="n">hw_mac_adr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">rndis_filter_query_device_link_status</span><span class="p">(</span><span class="n">rndis_device</span><span class="p">);</span>

	<span class="n">device_info</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">=</span> <span class="n">rndis_device</span><span class="o">-&gt;</span><span class="n">link_state</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="s">&quot;Device MAC %pM link state %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rndis_device</span><span class="o">-&gt;</span><span class="n">hw_mac_adr</span><span class="p">,</span>
		 <span class="n">device_info</span><span class="o">-&gt;</span><span class="n">link_state</span> <span class="o">?</span> <span class="s">&quot;down&quot;</span> <span class="o">:</span> <span class="s">&quot;up&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rndis_filter_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">hv_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_device</span> <span class="o">*</span><span class="n">rndis_dev</span> <span class="o">=</span> <span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">;</span>

	<span class="cm">/* Halt and release the rndis device */</span>
	<span class="n">rndis_filter_halt_device</span><span class="p">(</span><span class="n">rndis_dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rndis_dev</span><span class="p">);</span>
	<span class="n">net_dev</span><span class="o">-&gt;</span><span class="n">extension</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">netvsc_device_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">rndis_filter_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="o">*</span><span class="n">net_device</span> <span class="o">=</span> <span class="n">hv_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rndis_filter_open_device</span><span class="p">(</span><span class="n">net_device</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rndis_filter_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">netvsc_device</span> <span class="o">*</span><span class="n">nvdev</span> <span class="o">=</span> <span class="n">hv_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nvdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rndis_filter_close_device</span><span class="p">(</span><span class="n">nvdev</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rndis_filter_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">hv_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">hv_netvsc_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_filter_packet</span> <span class="o">*</span><span class="n">filter_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_message</span> <span class="o">*</span><span class="n">rndis_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_packet</span> <span class="o">*</span><span class="n">rndis_pkt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rndis_msg_size</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">isvlan</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_TAG_PRESENT</span><span class="p">;</span>

	<span class="cm">/* Add the rndis header */</span>
	<span class="n">filter_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rndis_filter_packet</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">;</span>

	<span class="n">rndis_msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter_pkt</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">rndis_msg_size</span> <span class="o">=</span> <span class="n">RNDIS_MESSAGE_SIZE</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_packet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isvlan</span><span class="p">)</span>
		<span class="n">rndis_msg_size</span> <span class="o">+=</span> <span class="n">NDIS_VLAN_PPI_SIZE</span><span class="p">;</span>

	<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">ndis_msg_type</span> <span class="o">=</span> <span class="n">RNDIS_MSG_PACKET</span><span class="p">;</span>
	<span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">total_data_buflen</span> <span class="o">+</span>
				      <span class="n">rndis_msg_size</span><span class="p">;</span>

	<span class="n">rndis_pkt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rndis_msg</span><span class="o">-&gt;</span><span class="n">msg</span><span class="p">.</span><span class="n">pkt</span><span class="p">;</span>
	<span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_packet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isvlan</span><span class="p">)</span>
		<span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">+=</span> <span class="n">NDIS_VLAN_PPI_SIZE</span><span class="p">;</span>
	<span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">total_data_buflen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isvlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rndis_per_packet_info</span> <span class="o">*</span><span class="n">ppi</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ndis_pkt_8021q_info</span> <span class="o">*</span><span class="n">vlan</span><span class="p">;</span>

		<span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">per_pkt_info_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_packet</span><span class="p">);</span>
		<span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">per_pkt_info_len</span> <span class="o">=</span> <span class="n">NDIS_VLAN_PPI_SIZE</span><span class="p">;</span>

		<span class="n">ppi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rndis_per_packet_info</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span><span class="n">rndis_pkt</span> <span class="o">+</span>
			<span class="n">rndis_pkt</span><span class="o">-&gt;</span><span class="n">per_pkt_info_offset</span><span class="p">);</span>
		<span class="n">ppi</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">NDIS_VLAN_PPI_SIZE</span><span class="p">;</span>
		<span class="n">ppi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">IEEE_8021Q_INFO</span><span class="p">;</span>
		<span class="n">ppi</span><span class="o">-&gt;</span><span class="n">ppi_offset</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_per_packet_info</span><span class="p">);</span>

		<span class="n">vlan</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ndis_pkt_8021q_info</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span><span class="n">ppi</span> <span class="o">+</span>
			<span class="n">ppi</span><span class="o">-&gt;</span><span class="n">ppi_offset</span><span class="p">);</span>
		<span class="n">vlan</span><span class="o">-&gt;</span><span class="n">vlanid</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_VID_MASK</span><span class="p">;</span>
		<span class="n">vlan</span><span class="o">-&gt;</span><span class="n">pri</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">vlan_tci</span> <span class="o">&amp;</span> <span class="n">VLAN_PRIO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">VLAN_PRIO_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">is_data_pkt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">rndis_msg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rndis_msg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">rndis_msg_size</span><span class="p">;</span>

	<span class="cm">/* Add one page_buf if the rndis msg goes beyond page boundary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">rndis_msg_size</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf_cnt</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span>
			<span class="n">rndis_msg</span> <span class="o">+</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">rndis_msg_size</span> <span class="o">-</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">page_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save the packet send completion and context */</span>
	<span class="n">filter_pkt</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion</span><span class="p">;</span>
	<span class="n">filter_pkt</span><span class="o">-&gt;</span><span class="n">completion_ctx</span> <span class="o">=</span>
				<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion_ctx</span><span class="p">;</span>

	<span class="cm">/* Use ours */</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion</span> <span class="o">=</span> <span class="n">rndis_filter_send_completion</span><span class="p">;</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion_ctx</span> <span class="o">=</span> <span class="n">filter_pkt</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netvsc_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Reset the completion to originals to allow retries from</span>
<span class="cm">		 * above</span>
<span class="cm">		 */</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion</span> <span class="o">=</span>
				<span class="n">filter_pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">;</span>
		<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">.</span><span class="n">send</span><span class="p">.</span><span class="n">send_completion_ctx</span> <span class="o">=</span>
				<span class="n">filter_pkt</span><span class="o">-&gt;</span><span class="n">completion_ctx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_filter_send_completion</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_filter_packet</span> <span class="o">*</span><span class="n">filter_pkt</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

	<span class="cm">/* Pass it back to the original handler */</span>
	<span class="n">filter_pkt</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">(</span><span class="n">filter_pkt</span><span class="o">-&gt;</span><span class="n">completion_ctx</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_filter_send_request_completion</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Noop */</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
